
function jquery_domChanged(){}!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";function g(e){return null!=e&&e===e.window}var t=[],E=C.document,r=Object.getPrototypeOf,s=t.slice,v=t.concat,u=t.push,i=t.indexOf,n={},o=n.toString,y=n.hasOwnProperty,a=y.toString,l=a.call(Object),m={},x=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType},c={type:!0,src:!0,nonce:!0,noModule:!0};function b(e,t,n){var r,i,o=(n=n||E).createElement("script");if(o.text=e,t)for(r in c)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function w(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[o.call(e)]||"object":typeof e}var f="3.4.1",k=function(e,t){return new k.fn.init(e,t)},p=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;function d(e){var t=!!e&&"length"in e&&e.length,n=w(e);return!x(e)&&!g(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}k.fn=k.prototype={jquery:f,constructor:k,length:0,toArray:function(){return s.call(this)},get:function(e){return null==e?s.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=k.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return k.each(this,e)},map:function(n){return this.pushStack(k.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},k.extend=k.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||x(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(k.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||k.isPlainObject(n)?n:{},i=!1,a[t]=k.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},k.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==o.call(e))&&(!(t=r(e))||"function"==typeof(n=y.call(t,"constructor")&&t.constructor)&&a.call(n)===l)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t){b(e,{nonce:t&&t.nonce})},each:function(e,t){var n,r=0;if(d(e))for(n=e.length;r<n&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(p,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(d(Object(e))?k.merge(n,"string"==typeof e?[e]:e):u.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:i.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!=a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(d(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return v.apply([],a)},guid:1,support:m}),"function"==typeof Symbol&&(k.fn[Symbol.iterator]=t[Symbol.iterator]),k.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var h=function(n){function f(e,t,n){var r="0x"+t-65536;return r!=r||n?t:r<0?String.fromCharCode(65536+r):String.fromCharCode(r>>10|55296,1023&r|56320)}function i(){T()}var e,d,b,o,a,h,p,g,w,u,l,T,C,s,E,v,c,y,m,k="sizzle"+ +new Date,x=n.document,S=0,r=0,N=ue(),A=ue(),D=ue(),j=ue(),q=function(e,t){return e===t&&(l=!0),0},L={}.hasOwnProperty,t=[],H=t.pop,O=t.push,P=t.push,R=t.slice,M=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},I="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",W="[\\x20\\t\\r\\n\\f]",$="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",F="\\["+W+"*("+$+")(?:"+W+"*([*^$|!~]?=)"+W+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+$+"))|)"+W+"*\\]",B=":("+$+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+F+")*)|.*)\\)|)",_=new RegExp(W+"+","g"),z=new RegExp("^"+W+"+|((?:^|[^\\\\])(?:\\\\.)*)"+W+"+$","g"),U=new RegExp("^"+W+"*,"+W+"*"),X=new RegExp("^"+W+"*([>+~]|"+W+")"+W+"*"),V=new RegExp(W+"|>"),G=new RegExp(B),Y=new RegExp("^"+$+"$"),Q={ID:new RegExp("^#("+$+")"),CLASS:new RegExp("^\\.("+$+")"),TAG:new RegExp("^("+$+"|[*])"),ATTR:new RegExp("^"+F),PSEUDO:new RegExp("^"+B),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+W+"*(even|odd|(([+-]|)(\\d*)n|)"+W+"*(?:([+-]|)"+W+"*(\\d+)|))"+W+"*\\)|)","i"),bool:new RegExp("^(?:"+I+")$","i"),needsContext:new RegExp("^"+W+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+W+"*((?:-\\d)?\\d*)"+W+"*\\)|)(?=[^-]|$)","i")},J=/HTML$/i,K=/^(?:input|select|textarea|button)$/i,Z=/^h\d$/i,ee=/^[^{]+\{\s*\[native \w/,te=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ne=/[+~]/,re=new RegExp("\\\\([\\da-f]{1,6}"+W+"?|("+W+")|.)","ig"),ie=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,oe=function(e,t){return t?"\0"===e?"ï¿½":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},ae=me(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{P.apply(t=R.call(x.childNodes),x.childNodes),t[x.childNodes.length].nodeType}catch(e){P={apply:t.length?function(e,t){O.apply(e,R.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}function se(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&((e?e.ownerDocument||e:x)!==C&&T(e),e=e||C,E)){if(11!==p&&(u=te.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(f&&(a=f.getElementById(i))&&m(e,a)&&a.id===i)return n.push(a),n}else{if(u[2])return P.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&d.getElementsByClassName&&e.getElementsByClassName)return P.apply(n,e.getElementsByClassName(i)),n}if(d.qsa&&!j[t+" "]&&(!v||!v.test(t))&&(1!==p||"object"!==e.nodeName.toLowerCase())){if(c=t,f=e,1===p&&V.test(t)){for((s=e.getAttribute("id"))?s=s.replace(ie,oe):e.setAttribute("id",s=k),o=(l=h(t)).length;o--;)l[o]="#"+s+" "+ye(l[o]);c=l.join(","),f=ne.test(t)&&ge(e.parentNode)||e}try{return P.apply(n,f.querySelectorAll(c)),n}catch(e){j(t,!0)}finally{s===k&&e.removeAttribute("id")}}}return g(t.replace(z,"$1"),e,n,r)}function ue(){var n=[];function r(e,t){return n.push(e+" ")>b.cacheLength&&delete r[n.shift()],r[e+" "]=t}return r}function le(e){return e[k]=!0,e}function ce(e){var t=C.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function fe(e,t){for(var n=e.split("|"),r=n.length;r--;)b.attrHandle[n[r]]=t}function pe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function de(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&ae(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function he(a){return le(function(o){return o=+o,le(function(e,t){for(var n,r=a([],e.length,o),i=r.length;i--;)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function ge(e){return e&&void 0!==e.getElementsByTagName&&e}for(e in d=se.support={},a=se.isXML=function(e){var t=e.namespaceURI,n=(e.ownerDocument||e).documentElement;return!J.test(t||n&&n.nodeName||"HTML")},T=se.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:x;return r!==C&&9===r.nodeType&&r.documentElement&&(s=(C=r).documentElement,E=!a(C),x!==C&&(n=C.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",i,!1):n.attachEvent&&n.attachEvent("onunload",i)),d.attributes=ce(function(e){return e.className="i",!e.getAttribute("className")}),d.getElementsByTagName=ce(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),d.getElementsByClassName=ee.test(C.getElementsByClassName),d.getById=ce(function(e){return s.appendChild(e).id=k,!C.getElementsByName||!C.getElementsByName(k).length}),d.getById?(b.filter.ID=function(e){var t=e.replace(re,f);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if(void 0!==t.getElementById&&E){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(re,f);return function(e){var t=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if(void 0!==t.getElementById&&E){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];for(i=t.getElementsByName(e),r=0;o=i[r++];)if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=d.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):d.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"!==e)return o;for(;n=o[i++];)1===n.nodeType&&r.push(n);return r},b.find.CLASS=d.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&E)return t.getElementsByClassName(e)},c=[],v=[],(d.qsa=ee.test(C.querySelectorAll))&&(ce(function(e){s.appendChild(e).innerHTML="<a id='"+k+"'></a><select id='"+k+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&v.push("[*^$]="+W+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||v.push("\\["+W+"*(?:value|"+I+")"),e.querySelectorAll("[id~="+k+"-]").length||v.push("~="),e.querySelectorAll(":checked").length||v.push(":checked"),e.querySelectorAll("a#"+k+"+*").length||v.push(".#.+[+~]")}),ce(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&v.push("name"+W+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&v.push(":enabled",":disabled"),s.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&v.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),v.push(",.*:")})),(d.matchesSelector=ee.test(y=s.matches||s.webkitMatchesSelector||s.mozMatchesSelector||s.oMatchesSelector||s.msMatchesSelector))&&ce(function(e){d.disconnectedMatch=y.call(e,"*"),y.call(e,"[s!='']:x"),c.push("!=",B)}),v=v.length&&new RegExp(v.join("|")),c=c.length&&new RegExp(c.join("|")),t=ee.test(s.compareDocumentPosition),m=t||ee.test(s.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},q=t?function(e,t){if(e===t)return l=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!d.sortDetached&&t.compareDocumentPosition(e)===n?e===C||e.ownerDocument===x&&m(x,e)?-1:t===C||t.ownerDocument===x&&m(x,t)?1:u?M(u,e)-M(u,t):0:4&n?-1:1)}:function(e,t){if(e===t)return l=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e===C?-1:t===C?1:i?-1:o?1:u?M(u,e)-M(u,t):0;if(i===o)return pe(e,t);for(n=e;n=n.parentNode;)a.unshift(n);for(n=t;n=n.parentNode;)s.unshift(n);for(;a[r]===s[r];)r++;return r?pe(a[r],s[r]):a[r]===x?-1:s[r]===x?1:0}),C},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if((e.ownerDocument||e)!==C&&T(e),d.matchesSelector&&E&&!j[t+" "]&&(!c||!c.test(t))&&(!v||!v.test(t)))try{var n=y.call(e,t);if(n||d.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){j(t,!0)}return 0<se(t,C,null,[e]).length},se.contains=function(e,t){return(e.ownerDocument||e)!==C&&T(e),m(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!==C&&T(e);var n=b.attrHandle[t.toLowerCase()],r=n&&L.call(b.attrHandle,t.toLowerCase())?n(e,t,!E):void 0;return void 0!==r?r:d.attributes||!E?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},se.escape=function(e){return(e+"").replace(ie,oe)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,n=[],r=0,i=0;if(l=!d.detectDuplicates,u=!d.sortStable&&e.slice(0),e.sort(q),l){for(;t=e[i++];)t===e[i]&&(r=n.push(i));for(;r--;)e.splice(n[r],1)}return u=null,e},o=se.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r++];)n+=o(t);return n},(b=se.selectors={cacheLength:50,createPseudo:le,match:Q,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(re,f),e[3]=(e[3]||e[4]||e[5]||"").replace(re,f),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return Q.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&G.test(n)&&(t=h(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(re,f).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=N[e+" "];return t||(t=new RegExp("(^|"+W+")"+e+"("+W+"|$)"))&&N(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=se.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(_," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(h,e,t,g,v){var y="nth"!==h.slice(0,3),m="last"!==h.slice(-4),x="of-type"===e;return 1===g&&0===v?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u,l=y!=m?"nextSibling":"previousSibling",c=e.parentNode,f=x&&e.nodeName.toLowerCase(),p=!n&&!x,d=!1;if(c){if(y){for(;l;){for(a=e;a=a[l];)if(x?a.nodeName.toLowerCase()===f:1===a.nodeType)return!1;u=l="only"===h&&!u&&"nextSibling"}return!0}if(u=[m?c.firstChild:c.lastChild],m&&p){for(d=(s=(r=(i=(o=(a=c)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1])&&r[2],a=s&&c.childNodes[s];a=++s&&a&&a[l]||(d=s=0)||u.pop();)if(1===a.nodeType&&++d&&a===e){i[h]=[S,s,d];break}}else if(p&&(d=s=(r=(i=(o=(a=e)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1]),!1===d)for(;(a=++s&&a&&a[l]||(d=s=0)||u.pop())&&((x?a.nodeName.toLowerCase()!==f:1!==a.nodeType)||!++d||(p&&((i=(o=a[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]=[S,d]),a!==e)););return(d-=v)===g||d%g==0&&0<=d/g}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return a[k]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?le(function(e,t){for(var n,r=a(e,o),i=r.length;i--;)e[n=M(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:le(function(e){var r=[],i=[],s=p(e.replace(z,"$1"));return s[k]?le(function(e,t,n,r){for(var i,o=s(e,null,r,[]),a=e.length;a--;)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:le(function(t){return function(e){return 0<se(t,e).length}}),contains:le(function(t){return t=t.replace(re,f),function(e){return-1<(e.textContent||o(e)).indexOf(t)}}),lang:le(function(n){return Y.test(n||"")||se.error("unsupported lang: "+n),n=n.replace(re,f).toLowerCase(),function(e){var t;do{if(t=E?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===s},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:de(!1),disabled:de(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return Z.test(e.nodeName)},input:function(e){return K.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:he(function(){return[0]}),last:he(function(e,t){return[t-1]}),eq:he(function(e,t,n){return[n<0?n+t:n]}),even:he(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:he(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:he(function(e,t,n){for(var r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:he(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=function(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=function(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}(e);function ve(){}function ye(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function me(s,e,t){var u=e.dir,l=e.next,c=l||u,f=t&&"parentNode"===c,p=r++;return e.first?function(e,t,n){for(;e=e[u];)if(1===e.nodeType||f)return s(e,t,n);return!1}:function(e,t,n){var r,i,o,a=[S,p];if(n){for(;e=e[u];)if((1===e.nodeType||f)&&s(e,t,n))return!0}else for(;e=e[u];)if(1===e.nodeType||f)if(i=(o=e[k]||(e[k]={}))[e.uniqueID]||(o[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[u]||e;else{if((r=i[c])&&r[0]===S&&r[1]===p)return a[2]=r[2];if((i[c]=a)[2]=s(e,t,n))return!0}return!1}}function xe(i){return 1<i.length?function(e,t,n){for(var r=i.length;r--;)if(!i[r](e,t,n))return!1;return!0}:i[0]}function be(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function we(d,h,g,v,y,e){return v&&!v[k]&&(v=we(v)),y&&!y[k]&&(y=we(y,e)),le(function(e,t,n,r){var i,o,a,s=[],u=[],l=t.length,c=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)se(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),f=!d||!e&&h?c:be(c,s,d,n,r),p=g?y||(e?d:l||v)?[]:t:f;if(g&&g(f,p,n,r),v)for(i=be(p,u),v(i,[],n,r),o=i.length;o--;)(a=i[o])&&(p[u[o]]=!(f[u[o]]=a));if(e){if(y||d){if(y){for(i=[],o=p.length;o--;)(a=p[o])&&i.push(f[o]=a);y(null,p=[],i,r)}for(o=p.length;o--;)(a=p[o])&&-1<(i=y?M(e,a):s[o])&&(e[i]=!(t[i]=a))}}else p=be(p===t?p.splice(l,p.length):p),y?y(null,t,p,r):P.apply(t,p)})}function Te(v,y){function e(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=S+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t===C||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){for(a=0,t||o.ownerDocument===C||(T(o),n=!E);s=v[a++];)if(s(o,t||C,n)){r.push(o);break}i&&(S=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){for(a=0;s=y[a++];)s(c,f,t,n);if(e){if(0<u)for(;l--;)c[l]||f[l]||(f[l]=H.call(r));f=be(f)}P.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&se.uniqueSort(r)}return i&&(S=h,w=p),c}var m=0<y.length,x=0<v.length;return m?le(e):e}return ve.prototype=b.filters=b.pseudos,b.setFilters=new ve,h=se.tokenize=function(e,t){var n,r,i,o,a,s,u,l=A[e+" "];if(l)return t?0:l.slice(0);for(a=e,s=[],u=b.preFilter;a;){for(o in n&&!(r=U.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=X.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(z," ")}),a=a.slice(n.length)),b.filter)!(r=Q[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?se.error(e):A(e,s).slice(0)},p=se.compile=function(e,t){var n,r=[],i=[],o=D[e+" "];if(!o){for(n=(t=t||h(e)).length;n--;)(o=function e(t){for(var i,n,r,o=t.length,a=b.relative[t[0].type],s=a||b.relative[" "],u=a?1:0,l=me(function(e){return e===i},s,!0),c=me(function(e){return-1<M(i,e)},s,!0),f=[function(e,t,n){var r=!a&&(n||t!==w)||((i=t).nodeType?l:c)(e,t,n);return i=null,r}];u<o;u++)if(n=b.relative[t[u].type])f=[me(xe(f),n)];else{if((n=b.filter[t[u].type].apply(null,t[u].matches))[k]){for(r=++u;r<o&&!b.relative[t[r].type];r++);return we(1<u&&xe(f),1<u&&ye(t.slice(0,u-1).concat({value:" "===t[u-2].type?"*":""})).replace(z,"$1"),n,u<r&&e(t.slice(u,r)),r<o&&e(t=t.slice(r)),r<o&&ye(t))}f.push(n)}return xe(f)}(t[n]))[k]?r.push(o):i.push(o);(o=D(e,Te(i,r))).selector=e}return o},g=se.select=function(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&h(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&E&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(re,f),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}for(i=Q.needsContext.test(e)?0:o.length;i--&&(a=o[i],!b.relative[s=a.type]);)if((u=b.find[s])&&(r=u(a.matches[0].replace(re,f),ne.test(o[0].type)&&ge(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&ye(o)))return P.apply(n,r),n;break}}return(l||p(e,c))(r,t,!E,n,!t||ne.test(e)&&ge(t.parentNode)||t),n},d.sortStable=k.split("").sort(q).join("")===k,d.detectDuplicates=!!l,T(),d.sortDetached=ce(function(e){return 1&e.compareDocumentPosition(C.createElement("fieldset"))}),ce(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||fe("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),d.attributes&&ce(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||fe("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),ce(function(e){return null==e.getAttribute("disabled")})||fe(I,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),se}(C);k.find=h,k.expr=h.selectors,k.expr[":"]=k.expr.pseudos,k.uniqueSort=k.unique=h.uniqueSort,k.text=h.getText,k.isXMLDoc=h.isXML,k.contains=h.contains,k.escapeSelector=h.escape;function T(e,t,n){for(var r=[],i=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&k(e).is(n))break;r.push(e)}return r}function S(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}var N=k.expr.match.needsContext;function A(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var D=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function j(e,n,r){return x(n)?k.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?k.grep(e,function(e){return e===n!==r}):"string"!=typeof n?k.grep(e,function(e){return-1<i.call(n,e)!==r}):k.filter(n,e,r)}k.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?k.find.matchesSelector(r,e)?[r]:[]:k.find.matches(e,k.grep(t,function(e){return 1===e.nodeType}))},k.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(k(e).filter(function(){for(t=0;t<r;t++)if(k.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)k.find(e,i[t],n);return 1<r?k.uniqueSort(n):n},filter:function(e){return this.pushStack(j(this,e||[],!1))},not:function(e){return this.pushStack(j(this,e||[],!0))},is:function(e){return!!j(this,"string"==typeof e&&N.test(e)?k(e):e||[],!1).length}});var q,L=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(k.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||q,"string"!=typeof e)return e.nodeType?(this[0]=e,this.length=1,this):x(e)?void 0!==n.ready?n.ready(e):e(k):k.makeArray(e,this);if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:L.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof k?t[0]:t,k.merge(this,k.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:E,!0)),D.test(r[1])&&k.isPlainObject(t))for(r in t)x(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=E.getElementById(r[2]))&&(this[0]=i,this.length=1),this}).prototype=k.fn,q=k(E);var H=/^(?:parents|prev(?:Until|All))/,O={children:!0,contents:!0,next:!0,prev:!0};function P(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}k.fn.extend({has:function(e){var t=k(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(k.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&k(e);if(!N.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&k.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?k.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?i.call(k(e),this[0]):i.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(k.uniqueSort(k.merge(this.get(),k(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),k.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return T(e,"parentNode")},parentsUntil:function(e,t,n){return T(e,"parentNode",n)},next:function(e){return P(e,"nextSibling")},prev:function(e){return P(e,"previousSibling")},nextAll:function(e){return T(e,"nextSibling")},prevAll:function(e){return T(e,"previousSibling")},nextUntil:function(e,t,n){return T(e,"nextSibling",n)},prevUntil:function(e,t,n){return T(e,"previousSibling",n)},siblings:function(e){return S((e.parentNode||{}).firstChild,e)},children:function(e){return S(e.firstChild)},contents:function(e){return void 0!==e.contentDocument?e.contentDocument:(A(e,"template")&&(e=e.content||e),k.merge([],e.childNodes))}},function(r,i){k.fn[r]=function(e,t){var n=k.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=k.filter(t,n)),1<this.length&&(O[r]||k.uniqueSort(n),H.test(r)&&n.reverse()),this.pushStack(n)}});var R=/[^\x20\t\r\n\f]+/g;function M(e){return e}function I(e){throw e}function W(e,t,n,r){var i;try{e&&x(i=e.promise)?i.call(e).done(t).fail(n):e&&x(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}k.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},k.each(e.match(R)||[],function(e,t){n[t]=!0}),n):k.extend({},r);function i(){for(s=s||r.once,a=o=!0;l.length;c=-1)for(t=l.shift();++c<u.length;)!1===u[c].apply(t[0],t[1])&&r.stopOnFalse&&(c=u.length,t=!1);r.memory||(t=!1),o=!1,s&&(u=t?[]:"")}var o,t,a,s,u=[],l=[],c=-1,f={add:function(){return u&&(t&&!o&&(c=u.length-1,l.push(t)),function n(e){k.each(e,function(e,t){x(t)?r.unique&&f.has(t)||u.push(t):t&&t.length&&"string"!==w(t)&&n(t)})}(arguments),t&&!o&&i()),this},remove:function(){return k.each(arguments,function(e,t){for(var n;-1<(n=k.inArray(t,u,n));)u.splice(n,1),n<=c&&c--}),this},has:function(e){return e?-1<k.inArray(e,u):0<u.length},empty:function(){return u=u&&[],this},disable:function(){return s=l=[],u=t="",this},disabled:function(){return!u},lock:function(){return s=l=[],t||o||(u=t=""),this},locked:function(){return!!s},fireWith:function(e,t){return s||(t=[e,(t=t||[]).slice?t.slice():t],l.push(t),o||i()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!a}};return f},k.extend({Deferred:function(e){var o=[["notify","progress",k.Callbacks("memory"),k.Callbacks("memory"),2],["resolve","done",k.Callbacks("once memory"),k.Callbacks("once memory"),0,"resolved"],["reject","fail",k.Callbacks("once memory"),k.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},catch:function(e){return a.then(null,e)},pipe:function(){var i=arguments;return k.Deferred(function(r){k.each(o,function(e,t){var n=x(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&x(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){function e(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,x(t)?s?t.call(e,l(u,o,M,s),l(u,o,I,s)):(u++,t.call(e,l(u,o,M,s),l(u,o,I,s),l(u,o,M,o.notifyWith))):(a!==M&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}}var n=this,r=arguments,t=s?e:function(){try{e()}catch(e){k.Deferred.exceptionHook&&k.Deferred.exceptionHook(e,t.stackTrace),u<=i+1&&(a!==I&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(k.Deferred.getStackHook&&(t.stackTrace=k.Deferred.getStackHook()),C.setTimeout(t))}}return k.Deferred(function(e){o[0][3].add(l(0,e,x(r)?r:M,e.notifyWith)),o[1][3].add(l(0,e,x(t)?t:M)),o[2][3].add(l(0,e,x(n)?n:I))}).promise()},promise:function(e){return null!=e?k.extend(e,a):a}},s={};return k.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){function t(t){return function(e){i[t]=this,o[t]=1<arguments.length?s.call(arguments):e,--n||a.resolveWith(i,o)}}var n=arguments.length,r=n,i=Array(r),o=s.call(arguments),a=k.Deferred();if(n<=1&&(W(e,a.done(t(r)).resolve,a.reject,!n),"pending"===a.state()||x(o[r]&&o[r].then)))return a.then();for(;r--;)W(o[r],t(r),a.reject);return a.promise()}});var $=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;k.Deferred.exceptionHook=function(e,t){C.console&&C.console.warn&&e&&$.test(e.name)&&C.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},k.readyException=function(e){C.setTimeout(function(){throw e})};var F=k.Deferred();function B(){E.removeEventListener("DOMContentLoaded",B),C.removeEventListener("load",B),k.ready()}k.fn.ready=function(e){return F.then(e).catch(function(e){k.readyException(e)}),this},k.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--k.readyWait:k.isReady)||(k.isReady=!0)!==e&&0<--k.readyWait||F.resolveWith(E,[k])}}),k.ready.then=F.then,"complete"===E.readyState||"loading"!==E.readyState&&!E.documentElement.doScroll?C.setTimeout(k.ready):(E.addEventListener("DOMContentLoaded",B),C.addEventListener("load",B));var _=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===w(n))for(s in i=!0,n)_(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,x(r)||(a=!0),l&&(t=a?(t.call(e,r),null):(l=t,function(e,t,n){return l.call(k(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},z=/^-ms-/,U=/-([a-z])/g;function X(e,t){return t.toUpperCase()}function V(e){return e.replace(z,"ms-").replace(U,X)}function G(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType}function Y(){this.expando=k.expando+Y.uid++}Y.uid=1,Y.prototype={cache:function(e){var t=e[this.expando];return t||(t={},G(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[V(t)]=n;else for(r in t)i[V(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][V(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(V):(t=V(t))in r?[t]:t.match(R)||[]).length;for(;n--;)delete r[t[n]]}void 0!==t&&!k.isEmptyObject(r)||(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!k.isEmptyObject(t)}};var Q=new Y,J=new Y,K=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Z=/[A-Z]/g;function ee(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(Z,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:K.test(i)?JSON.parse(i):i)}catch(e){}J.set(e,t,n)}else n=void 0;return n}k.extend({hasData:function(e){return J.hasData(e)||Q.hasData(e)},data:function(e,t,n){return J.access(e,t,n)},removeData:function(e,t){J.remove(e,t)},_data:function(e,t,n){return Q.access(e,t,n)},_removeData:function(e,t){Q.remove(e,t)}}),k.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0!==n)return"object"==typeof n?this.each(function(){J.set(this,n)}):_(this,function(e){var t;return o&&void 0===e?void 0!==(t=J.get(o,n))||void 0!==(t=ee(o,n))?t:void 0:void this.each(function(){J.set(this,n,e)})},null,e,1<arguments.length,null,!0);if(this.length&&(i=J.get(o),1===o.nodeType&&!Q.get(o,"hasDataAttrs"))){for(t=a.length;t--;)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=V(r.slice(5)),ee(o,r,i[r]));Q.set(o,"hasDataAttrs",!0)}return i},removeData:function(e){return this.each(function(){J.remove(this,e)})}}),k.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Q.get(e,t),n&&(!r||Array.isArray(n)?r=Q.access(e,t,k.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=k.queue(e,t),r=n.length,i=n.shift(),o=k._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){k.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Q.get(e,n)||Q.access(e,n,{empty:k.Callbacks("once memory").add(function(){Q.remove(e,[t+"queue",n])})})}}),k.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?k.queue(this[0],t):void 0===n?this:this.each(function(){var e=k.queue(this,t,n);k._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&k.dequeue(this,t)})},dequeue:function(e){return this.each(function(){k.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){function n(){--i||o.resolveWith(a,[a])}var r,i=1,o=k.Deferred(),a=this,s=this.length;for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";s--;)(r=Q.get(a[s],e+"queueHooks"))&&r.empty&&(i++,r.empty.add(n));return n(),o.promise(t)}});var te=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ne=new RegExp("^(?:([+-])=|)("+te+")([a-z%]*)$","i"),re=["Top","Right","Bottom","Left"],ie=E.documentElement,oe=function(e){return k.contains(e.ownerDocument,e)},ae={composed:!0};ie.getRootNode&&(oe=function(e){return k.contains(e.ownerDocument,e)||e.getRootNode(ae)===e.ownerDocument});function se(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in i=n.apply(e,r||[]),t)e.style[o]=a[o];return i}var ue=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&oe(e)&&"none"===k.css(e,"display")};function le(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return k.css(e,t,"")},u=s(),l=n&&n[3]||(k.cssNumber[t]?"":"px"),c=e.nodeType&&(k.cssNumber[t]||"px"!==l&&+u)&&ne.exec(k.css(e,t));if(c&&c[3]!==l){for(u/=2,l=l||c[3],c=+u||1;a--;)k.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,k.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ce={};function fe(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=Q.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&ue(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ce[s])||(o=a.body.appendChild(a.createElement(s)),u=k.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ce[s]=u)))):"none"!==n&&(l[c]="none",Q.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}k.fn.extend({show:function(){return fe(this,!0)},hide:function(){return fe(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){ue(this)?k(this).show():k(this).hide()})}});var pe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,he=/^$|^module$|\/(?:java|ecma)script/i,ge={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ve(e,t){var n=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[];return void 0===t||t&&A(e,t)?k.merge([e],n):n}function ye(e,t){for(var n=0,r=e.length;n<r;n++)Q.set(e[n],"globalEval",!t||Q.get(t[n],"globalEval"))}ge.optgroup=ge.option,ge.tbody=ge.tfoot=ge.colgroup=ge.caption=ge.thead,ge.th=ge.td;var me,xe,be=/<|&#?\w+;/;function we(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===w(o))k.merge(p,o.nodeType?[o]:o);else if(be.test(o)){for(a=a||f.appendChild(t.createElement("div")),s=(de.exec(o)||["",""])[1].toLowerCase(),u=ge[s]||ge._default,a.innerHTML=u[1]+k.htmlPrefilter(o)+u[2],c=u[0];c--;)a=a.lastChild;k.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));for(f.textContent="",d=0;o=p[d++];)if(r&&-1<k.inArray(o,r))i&&i.push(o);else if(l=oe(o),a=ve(f.appendChild(o),"script"),l&&ye(a),n)for(c=0;o=a[c++];)he.test(o.type||"")&&n.push(o);return f}me=E.createDocumentFragment().appendChild(E.createElement("div")),(xe=E.createElement("input")).setAttribute("type","radio"),xe.setAttribute("checked","checked"),xe.setAttribute("name","t"),me.appendChild(xe),m.checkClone=me.cloneNode(!0).cloneNode(!0).lastChild.checked,me.innerHTML="<textarea>x</textarea>",m.noCloneChecked=!!me.cloneNode(!0).lastChild.defaultValue;var Te=/^key/,Ce=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Ee=/^([^.]*)(?:\.(.+)|)/;function ke(){return!0}function Se(){return!1}function Ne(e,t){return e===function(){try{return E.activeElement}catch(e){}}()==("focus"===t)}function Ae(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Ae(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=Se;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return k().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=k.guid++)),e.each(function(){k.event.add(this,t,i,r,n)})}function De(e,i,o){o?(Q.set(e,i,!1),k.event.add(e,i,{namespace:!1,handler:function(e){var t,n,r=Q.get(this,i);if(1&e.isTrigger&&this[i]){if(r.length)(k.event.special[i]||{}).delegateType&&e.stopPropagation();else if(r=s.call(arguments),Q.set(this,i,r),t=o(this,i),this[i](),r!==(n=Q.get(this,i))||t?Q.set(this,i,!1):n={},r!==n)return e.stopImmediatePropagation(),e.preventDefault(),n.value}else r.length&&(Q.set(this,i,{value:k.event.trigger(k.extend(r[0],k.Event.prototype),r.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===Q.get(e,i)&&k.event.add(e,i,ke)}k.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.get(t);if(v)for(n.handler&&(n=(o=n).handler,i=o.selector),i&&k.find.matchesSelector(ie,i),n.guid||(n.guid=k.guid++),(u=v.events)||(u=v.events={}),(a=v.handle)||(a=v.handle=function(e){return void 0!==k&&k.event.triggered!==e.type?k.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(R)||[""]).length;l--;)d=g=(s=Ee.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=k.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=k.event.special[d]||{},c=k.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&k.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),k.event.global[d]=!0)},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.hasData(e)&&Q.get(e);if(v&&(u=v.events)){for(l=(t=(t||"").match(R)||[""]).length;l--;)if(d=g=(s=Ee.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){for(f=k.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;o--;)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||k.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)k.event.remove(e,d+t[l],n,r,!0);k.isEmptyObject(u)&&Q.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=k.event.fix(e),u=new Array(arguments.length),l=(Q.get(this,"events")||{})[s.type]||[],c=k.event.special[s.type]||{};for(u[0]=s,t=1;t<arguments.length;t++)u[t]=arguments[t];if(s.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,s)){for(a=k.event.handlers.call(this,s,l),t=0;(i=a[t++])&&!s.isPropagationStopped();)for(s.currentTarget=i.elem,n=0;(o=i.handlers[n++])&&!s.isImmediatePropagationStopped();)s.rnamespace&&!1!==o.namespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(r=((k.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,u))&&!1===(s.result=r)&&(s.preventDefault(),s.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,s),s.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<k(i,this).index(l):k.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(k.Event.prototype,t,{enumerable:!0,configurable:!0,get:x(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[k.expando]?e:new k.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click",ke),!1},trigger:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click"),!0},_default:function(e){var t=e.target;return pe.test(t.type)&&t.click&&A(t,"input")&&Q.get(t,"click")||A(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},k.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},k.Event=function(e,t){if(!(this instanceof k.Event))return new k.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?ke:Se,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&k.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[k.expando]=!0},k.Event.prototype={constructor:k.Event,isDefaultPrevented:Se,isPropagationStopped:Se,isImmediatePropagationStopped:Se,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=ke,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=ke,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=ke,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},k.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&Te.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&Ce.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},k.event.addProp),k.each({focus:"focusin",blur:"focusout"},function(e,t){k.event.special[e]={setup:function(){return De(this,e,Ne),!1},trigger:function(){return De(this,e),!0},delegateType:t}}),k.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){k.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||k.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),k.fn.extend({on:function(e,t,n,r){return Ae(this,e,t,n,r)},one:function(e,t,n,r){return Ae(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,k(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"!=typeof e)return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=Se),this.each(function(){k.event.remove(this,e,n,t)});for(i in e)this.off(i,t,e[i]);return this}});var je=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,qe=/<script|<style|<link/i,Le=/checked\s*(?:[^=]|=\s*.checked.)/i,He=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function Oe(e,t){return A(e,"table")&&A(11!==t.nodeType?t:t.firstChild,"tr")&&k(e).children("tbody")[0]||e}function Pe(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function Re(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Me(e,t){var n,r,i,o,a,s,u,l;if(1===t.nodeType){if(Q.hasData(e)&&(o=Q.access(e),a=Q.set(t,o),l=o.events))for(i in delete a.handle,a.events={},l)for(n=0,r=l[i].length;n<r;n++)k.event.add(t,i,l[i][n]);J.hasData(e)&&(s=J.access(e),u=k.extend({},s),J.set(t,u))}}function Ie(n,r,i,o){r=v.apply([],r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=x(d);if(h||1<f&&"string"==typeof d&&!m.checkClone&&Le.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),Ie(t,r,i,o),jquery_domChanged()});if(f&&(t=(e=we(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=k.map(ve(e,"script"),Pe)).length;c<f;c++)u=e,c!==p&&(u=k.clone(u,!0,!0),s&&k.merge(a,ve(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,k.map(a,Re),c=0;c<s;c++)u=a[c],he.test(u.type||"")&&!Q.access(u,"globalEval")&&k.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?k._evalUrl&&!u.noModule&&k._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")}):b(u.textContent.replace(He,""),u,l))}return jquery_domChanged(),n}function We(e,t,n){for(var r,i=t?k.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||k.cleanData(ve(r)),r.parentNode&&(n&&oe(r)&&ye(ve(r,"script")),r.parentNode.removeChild(r));return e}k.extend({htmlPrefilter:function(e){return e.replace(je,"<$1></$2>")},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=oe(e);if(!(m.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||k.isXMLDoc(e)))for(a=ve(c),r=0,i=(o=ve(e)).length;r<i;r++)s=o[r],u=a[r],"input"===(l=u.nodeName.toLowerCase())&&pe.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||ve(e),a=a||ve(c),r=0,i=o.length;r<i;r++)Me(o[r],a[r]);else Me(e,c);return 0<(a=ve(c,"script")).length&&ye(a,!f&&ve(e,"script")),c},cleanData:function(e){for(var t,n,r,i=k.event.special,o=0;void 0!==(n=e[o]);o++)if(G(n)){if(t=n[Q.expando]){if(t.events)for(r in t.events)i[r]?k.event.remove(n,r):k.removeEvent(n,r,t.handle);n[Q.expando]=void 0}n[J.expando]&&(n[J.expando]=void 0)}}}),k.fn.extend({detach:function(e){return We(this,e,!0)},remove:function(e){return We(this,e)},text:function(e){return _(this,function(e){return void 0===e?k.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return Ie(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Oe(this,e).appendChild(e)})},prepend:function(){return Ie(this,arguments,function(e){var t;1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(t=Oe(this,e)).insertBefore(e,t.firstChild)})},before:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(k.cleanData(ve(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return k.clone(this,e,t)})},html:function(e){return _(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!qe.test(e)&&!ge[(de.exec(e)||["",""])[1].toLowerCase()]){e=k.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(k.cleanData(ve(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return Ie(this,arguments,function(e){var t=this.parentNode;k.inArray(this,n)<0&&(k.cleanData(ve(this)),t&&t.replaceChild(e,this))},n)}}),k.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){k.fn[e]=function(e){for(var t,n=[],r=k(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),k(r[o])[a](t),u.apply(n,t.get());return this.pushStack(n)}});var $e,Fe,Be,_e,ze,Ue,Xe,Ve=new RegExp("^("+te+")(?!px)[a-z%]+$","i"),Ge=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=C),t.getComputedStyle(e)},Ye=new RegExp(re.join("|"),"i");function Qe(){var e;Xe&&(Ue.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",Xe.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",ie.appendChild(Ue).appendChild(Xe),e=C.getComputedStyle(Xe),$e="1%"!==e.top,ze=12===Je(e.marginLeft),Xe.style.right="60%",_e=36===Je(e.right),Fe=36===Je(e.width),Xe.style.position="absolute",Be=12===Je(Xe.offsetWidth/3),ie.removeChild(Ue),Xe=null)}function Je(e){return Math.round(parseFloat(e))}function Ke(e,t,n){var r,i,o,a,s=e.style;return(n=n||Ge(e))&&(""!==(a=n.getPropertyValue(t)||n[t])||oe(e)||(a=k.style(e,t)),!m.pixelBoxStyles()&&Ve.test(a)&&Ye.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function Ze(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}Ue=E.createElement("div"),(Xe=E.createElement("div")).style&&(Xe.style.backgroundClip="content-box",Xe.cloneNode(!0).style.backgroundClip="",m.clearCloneStyle="content-box"===Xe.style.backgroundClip,k.extend(m,{boxSizingReliable:function(){return Qe(),Fe},pixelBoxStyles:function(){return Qe(),_e},pixelPosition:function(){return Qe(),$e},reliableMarginLeft:function(){return Qe(),ze},scrollboxSize:function(){return Qe(),Be}}));var et=["Webkit","Moz","ms"],tt=E.createElement("div").style,nt={};function rt(e){var t=k.cssProps[e]||nt[e];return t||(e in tt?e:nt[e]=function(e){for(var t=e[0].toUpperCase()+e.slice(1),n=et.length;n--;)if((e=et[n]+t)in tt)return e}(e)||e)}var it=/^(none|table(?!-c[ea]).+)/,ot=/^--/,at={position:"absolute",visibility:"hidden",display:"block"},st={letterSpacing:"0",fontWeight:"400"};function ut(e,t,n){var r=ne.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function lt(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(u+=k.css(e,n+re[a],!0,i)),r?("content"===n&&(u-=k.css(e,"padding"+re[a],!0,i)),"margin"!==n&&(u-=k.css(e,"border"+re[a]+"Width",!0,i))):(u+=k.css(e,"padding"+re[a],!0,i),"padding"!==n?u+=k.css(e,"border"+re[a]+"Width",!0,i):s+=k.css(e,"border"+re[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u}function ct(e,t,n){var r=Ge(e),i=(!m.boxSizingReliable()||n)&&"border-box"===k.css(e,"boxSizing",!1,r),o=i,a=Ke(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if(Ve.test(a)){if(!n)return a;a="auto"}return(!m.boxSizingReliable()&&i||"auto"===a||!parseFloat(a)&&"inline"===k.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===k.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+lt(e,t,n||(i?"border":"content"),o,r,a)+"px"}function ft(e,t,n,r,i){return new ft.prototype.init(e,t,n,r,i)}k.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=Ke(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=V(t),u=ot.test(t),l=e.style;if(u||(t=rt(s)),a=k.cssHooks[t]||k.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=ne.exec(n))&&i[1]&&(n=le(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(k.cssNumber[s]?"":"px")),m.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=V(t);return ot.test(t)||(t=rt(s)),(a=k.cssHooks[t]||k.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=Ke(e,t,r)),"normal"===i&&t in st&&(i=st[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),k.each(["height","width"],function(e,u){k.cssHooks[u]={get:function(e,t,n){if(t)return!it.test(k.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?ct(e,u,n):se(e,at,function(){return ct(e,u,n)})},set:function(e,t,n){var r,i=Ge(e),o=!m.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===k.css(e,"boxSizing",!1,i),s=n?lt(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-lt(e,u,"border",!1,i)-.5)),s&&(r=ne.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=k.css(e,u)),ut(0,t,s)}}}),k.cssHooks.marginLeft=Ze(m.reliableMarginLeft,function(e,t){if(t)return(parseFloat(Ke(e,"marginLeft"))||e.getBoundingClientRect().left-se(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),k.each({margin:"",padding:"",border:"Width"},function(i,o){k.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+re[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(k.cssHooks[i+o].set=ut)}),k.fn.extend({css:function(e,t){return _(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Ge(e),i=t.length;a<i;a++)o[t[a]]=k.css(e,t[a],!1,r);return o}return void 0!==n?k.style(e,t,n):k.css(e,t)},e,t,1<arguments.length)}}),(k.Tween=ft).prototype={constructor:ft,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||k.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(k.cssNumber[n]?"":"px")},cur:function(){var e=ft.propHooks[this.prop];return e&&e.get?e.get(this):ft.propHooks._default.get(this)},run:function(e){var t,n=ft.propHooks[this.prop];return this.options.duration?this.pos=t=k.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):ft.propHooks._default.set(this),this}},ft.prototype.init.prototype=ft.prototype,ft.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=k.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){k.fx.step[e.prop]?k.fx.step[e.prop](e):1!==e.elem.nodeType||!k.cssHooks[e.prop]&&null==e.elem.style[rt(e.prop)]?e.elem[e.prop]=e.now:k.style(e.elem,e.prop,e.now+e.unit)}}},ft.propHooks.scrollTop=ft.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},k.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},k.fx=ft.prototype.init,k.fx.step={};var pt,dt,ht,gt,vt=/^(?:toggle|show|hide)$/,yt=/queueHooks$/;function mt(){dt&&(!1===E.hidden&&C.requestAnimationFrame?C.requestAnimationFrame(mt):C.setTimeout(mt,k.fx.interval),k.fx.tick())}function xt(){return C.setTimeout(function(){pt=void 0}),pt=Date.now()}function bt(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=re[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function wt(e,t,n){for(var r,i=(Tt.tweeners[t]||[]).concat(Tt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function Tt(o,e,t){var n,a,r=0,i=Tt.prefilters.length,s=k.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=pt||xt(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:k.extend({},e),opts:k.extend(!0,{specialEasing:{},easing:k.easing._default},t),originalProperties:e,originalOptions:t,startTime:pt||xt(),duration:t.duration,tweens:[],createTween:function(e,t){var n=k.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=V(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=k.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=Tt.prefilters[r].call(l,o,c,l.opts))return x(n.stop)&&(k._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return k.map(c,wt,l),x(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),k.fx.timer(k.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}k.Animation=k.extend(Tt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return le(n.elem,e,ne.exec(t),n),n}]},tweener:function(e,t){for(var n,r=0,i=(e=x(e)?(t=e,["*"]):e.match(R)).length;r<i;r++)n=e[r],Tt.tweeners[n]=Tt.tweeners[n]||[],Tt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&ue(e),v=Q.get(e,"fxshow");for(r in n.queue||(null==(a=k._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,k.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],vt.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||k.style(e,r)}if((u=!k.isEmptyObject(t))||!k.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=Q.get(e,"display")),"none"===(c=k.css(e,"display"))&&(l?c=l:(fe([e],!0),l=e.style.display||l,c=k.css(e,"display"),fe([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===k.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=Q.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&fe([e],!0),p.done(function(){for(r in g||fe([e]),Q.remove(e,"fxshow"),d)k.style(e,r,d[r])})),u=wt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?Tt.prefilters.unshift(e):Tt.prefilters.push(e)}}),k.speed=function(e,t,n){var r=e&&"object"==typeof e?k.extend({},e):{complete:n||!n&&t||x(e)&&e,duration:e,easing:n&&t||t&&!x(t)&&t};return k.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in k.fx.speeds?r.duration=k.fx.speeds[r.duration]:r.duration=k.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){x(r.old)&&r.old.call(this),r.queue&&k.dequeue(this,r.queue)},r},k.fn.extend({fadeTo:function(e,t,n,r){return this.filter(ue).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){function i(){var e=Tt(this,k.extend({},t),a);(o||Q.get(this,"finish"))&&e.stop(!0)}var o=k.isEmptyObject(t),a=k.speed(e,n,r);return i.finish=i,o||!1===a.queue?this.each(i):this.queue(a.queue,i)},stop:function(i,e,o){function a(e){var t=e.stop;delete e.stop,t(o)}return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&!1!==i&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=k.timers,r=Q.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&yt.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||k.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=Q.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=k.timers,o=n?n.length:0;for(t.finish=!0,k.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),k.each(["toggle","show","hide"],function(e,r){var i=k.fn[r];k.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(bt(r,!0),e,t,n)}}),k.each({slideDown:bt("show"),slideUp:bt("hide"),slideToggle:bt("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){k.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),k.timers=[],k.fx.tick=function(){var e,t=0,n=k.timers;for(pt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||k.fx.stop(),pt=void 0},k.fx.timer=function(e){k.timers.push(e),k.fx.start()},k.fx.interval=13,k.fx.start=function(){dt||(dt=!0,mt())},k.fx.stop=function(){dt=null},k.fx.speeds={slow:600,fast:200,_default:400},k.fn.delay=function(r,e){return r=k.fx&&k.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=C.setTimeout(e,r);t.stop=function(){C.clearTimeout(n)}})},ht=E.createElement("input"),gt=E.createElement("select").appendChild(E.createElement("option")),ht.type="checkbox",m.checkOn=""!==ht.value,m.optSelected=gt.selected,(ht=E.createElement("input")).value="t",ht.type="radio",m.radioValue="t"===ht.value;var Ct,Et=k.expr.attrHandle;k.fn.extend({attr:function(e,t){return _(this,k.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){k.removeAttr(this,e)})}}),k.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return void 0===e.getAttribute?k.prop(e,t,n):(1===o&&k.isXMLDoc(e)||(i=k.attrHooks[t.toLowerCase()]||(k.expr.match.bool.test(t)?Ct:void 0)),void 0!==n?null===n?void k.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):!(i&&"get"in i&&null!==(r=i.get(e,t)))&&null==(r=k.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!m.radioValue&&"radio"===t&&A(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(R);if(i&&1===e.nodeType)for(;n=i[r++];)e.removeAttribute(n)}}),Ct={set:function(e,t,n){return!1===t?k.removeAttr(e,n):e.setAttribute(n,n),n}},k.each(k.expr.match.bool.source.match(/\w+/g),function(e,t){var a=Et[t]||k.find.attr;Et[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=Et[o],Et[o]=r,r=null!=a(e,t,n)?o:null,Et[o]=i),r}});var kt=/^(?:input|select|textarea|button)$/i,St=/^(?:a|area)$/i;function Nt(e){return(e.match(R)||[]).join(" ")}function At(e){return e.getAttribute&&e.getAttribute("class")||""}function Dt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(R)||[]}k.fn.extend({prop:function(e,t){return _(this,k.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[k.propFix[e]||e]})}}),k.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&k.isXMLDoc(e)||(t=k.propFix[t]||t,i=k.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=k.find.attr(e,"tabindex");return t?parseInt(t,10):kt.test(e.nodeName)||St.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),m.optSelected||(k.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),k.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){k.propFix[this.toLowerCase()]=this}),k.fn.extend({addClass:function(t){var e,n,r,i,o,a,s,u=0;if(x(t))return this.each(function(e){k(this).addClass(t.call(this,e,At(this)))});if((e=Dt(t)).length)for(;n=this[u++];)if(i=At(n),r=1===n.nodeType&&" "+Nt(i)+" "){for(a=0;o=e[a++];)r.indexOf(" "+o+" ")<0&&(r+=o+" ");i!==(s=Nt(r))&&n.setAttribute("class",s)}return this},removeClass:function(t){var e,n,r,i,o,a,s,u=0;if(x(t))return this.each(function(e){k(this).removeClass(t.call(this,e,At(this)))});if(!arguments.length)return this.attr("class","");if((e=Dt(t)).length)for(;n=this[u++];)if(i=At(n),r=1===n.nodeType&&" "+Nt(i)+" "){for(a=0;o=e[a++];)for(;-1<r.indexOf(" "+o+" ");)r=r.replace(" "+o+" "," ");i!==(s=Nt(r))&&n.setAttribute("class",s)}return this},toggleClass:function(i,t){var o=typeof i,a="string"==o||Array.isArray(i);return"boolean"==typeof t&&a?t?this.addClass(i):this.removeClass(i):x(i)?this.each(function(e){k(this).toggleClass(i.call(this,e,At(this),t),t)}):this.each(function(){var e,t,n,r;if(a)for(t=0,n=k(this),r=Dt(i);e=r[t++];)n.hasClass(e)?n.removeClass(e):n.addClass(e);else void 0!==i&&"boolean"!=o||((e=At(this))&&Q.set(this,"__className__",e),this.setAttribute&&this.setAttribute("class",!e&&!1!==i&&Q.get(this,"__className__")||""))})},hasClass:function(e){for(var t,n=0,r=" "+e+" ";t=this[n++];)if(1===t.nodeType&&-1<(" "+Nt(At(t))+" ").indexOf(r))return!0;return!1}});var jt=/\r/g;k.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=x(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,k(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=k.map(t,function(e){return null==e?"":e+""})),(r=k.valHooks[this.type]||k.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=k.valHooks[t.type]||k.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(jt,""):null==e?"":e:void 0}}),k.extend({valHooks:{option:{get:function(e){var t=k.find.attr(e,"value");return null!=t?t:Nt(k.text(e))}},select:{get:function(e){for(var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type,a=o?null:[],s=o?i+1:r.length,u=i<0?s:o?i:0;u<s;u++)if(((n=r[u]).selected||u===i)&&!n.disabled&&(!n.parentNode.disabled||!A(n.parentNode,"optgroup"))){if(t=k(n).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var n,r,i=e.options,o=k.makeArray(t),a=i.length;a--;)((r=i[a]).selected=-1<k.inArray(k.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),k.each(["radio","checkbox"],function(){k.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<k.inArray(k(e).val(),t)}},m.checkOn||(k.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),m.focusin="onfocusin"in C;function qt(e){e.stopPropagation()}var Lt=/^(?:focusinfocus|focusoutblur)$/;k.extend(k.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f=[n||E],p=y.call(e,"type")?e.type:e,d=y.call(e,"namespace")?e.namespace.split("."):[],h=c=o=n=n||E;if(3!==n.nodeType&&8!==n.nodeType&&!Lt.test(p+k.event.triggered)&&(-1<p.indexOf(".")&&(p=(d=p.split(".")).shift(),d.sort()),s=p.indexOf(":")<0&&"on"+p,(e=e[k.expando]?e:new k.Event(p,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=d.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+d.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:k.makeArray(t,[e]),l=k.event.special[p]||{},r||!l.trigger||!1!==l.trigger.apply(n,t))){if(!r&&!l.noBubble&&!g(n)){for(a=l.delegateType||p,Lt.test(a+p)||(h=h.parentNode);h;h=h.parentNode)f.push(h),o=h;o===(n.ownerDocument||E)&&f.push(o.defaultView||o.parentWindow||C)}for(i=0;(h=f[i++])&&!e.isPropagationStopped();)c=h,e.type=1<i?a:l.bindType||p,(u=(Q.get(h,"events")||{})[e.type]&&Q.get(h,"handle"))&&u.apply(h,t),(u=s&&h[s])&&u.apply&&G(h)&&(e.result=u.apply(h,t),!1===e.result&&e.preventDefault());return e.type=p,r||e.isDefaultPrevented()||l._default&&!1!==l._default.apply(f.pop(),t)||!G(n)||s&&x(n[p])&&!g(n)&&((o=n[s])&&(n[s]=null),k.event.triggered=p,e.isPropagationStopped()&&c.addEventListener(p,qt),n[p](),e.isPropagationStopped()&&c.removeEventListener(p,qt),k.event.triggered=void 0,o&&(n[s]=o)),e.result}},simulate:function(e,t,n){var r=k.extend(new k.Event,n,{type:e,isSimulated:!0});k.event.trigger(r,null,t)}}),k.fn.extend({trigger:function(e,t){return this.each(function(){k.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return k.event.trigger(e,t,n,!0)}}),m.focusin||k.each({focus:"focusin",blur:"focusout"},function(n,r){function i(e){k.event.simulate(r,e.target,k.event.fix(e))}k.event.special[r]={setup:function(){var e=this.ownerDocument||this,t=Q.access(e,r);t||e.addEventListener(n,i,!0),Q.access(e,r,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this,t=Q.access(e,r)-1;t?Q.access(e,r,t):(e.removeEventListener(n,i,!0),Q.remove(e,r))}}});var Ht=C.location,Ot=Date.now(),Pt=/\?/;k.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new C.DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return t&&!t.getElementsByTagName("parsererror").length||k.error("Invalid XML: "+e),t};var Rt=/\[\]$/,Mt=/\r?\n/g,It=/^(?:submit|button|image|reset|file)$/i,Wt=/^(?:input|select|textarea|keygen)/i;k.param=function(e,t){function n(e,t){var n=x(t)?t():t;i[i.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)}var r,i=[];if(null==e)return"";if(Array.isArray(e)||e.jquery&&!k.isPlainObject(e))k.each(e,function(){n(this.name,this.value)});else for(r in e)!function n(r,e,i,o){var t;if(Array.isArray(e))k.each(e,function(e,t){i||Rt.test(r)?o(r,t):n(r+"["+("object"==typeof t&&null!=t?e:"")+"]",t,i,o)});else if(i||"object"!==w(e))o(r,e);else for(t in e)n(r+"["+t+"]",e[t],i,o)}(r,e[r],t,n);return i.join("&")},k.fn.extend({serialize:function(){return k.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=k.prop(this,"elements");return e?k.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!k(this).is(":disabled")&&Wt.test(this.nodeName)&&!It.test(e)&&(this.checked||!pe.test(e))}).map(function(e,t){var n=k(this).val();return null==n?null:Array.isArray(n)?k.map(n,function(e){return{name:t.name,value:e.replace(Mt,"\r\n")}}):{name:t.name,value:n.replace(Mt,"\r\n")}}).get()}});var $t=/%20/g,Ft=/#.*$/,Bt=/([?&])_=[^&]*/,_t=/^(.*?):[ \t]*([^\r\n]*)$/gm,zt=/^(?:GET|HEAD)$/,Ut=/^\/\//,Xt={},Vt={},Gt="*/".concat("*"),Yt=E.createElement("a");function Qt(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(R)||[];if(x(t))for(;n=i[r++];)"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function Jt(t,i,o,a){var s={},u=t===Vt;function l(e){var r;return s[e]=!0,k.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function Kt(e,t){var n,r,i=k.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r=r||{})[n]=t[n]);return r&&k.extend(!0,e,r),e}Yt.href=Ht.href,k.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Ht.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Ht.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Gt,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":k.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?Kt(Kt(e,k.ajaxSettings),t):Kt(k.ajaxSettings,e)},ajaxPrefilter:Qt(Xt),ajaxTransport:Qt(Vt),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=k.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?k(y):k.event,x=k.Deferred(),b=k.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n)for(n={};t=_t.exec(p);)n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2]);t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Ht.href)+"").replace(Ut,Ht.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(R)||[""],null==v.crossDomain){r=E.createElement("a");try{r.href=v.url,r.href,v.crossDomain=Yt.protocol+"//"+Yt.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=k.param(v.data,v.traditional)),Jt(Xt,v,t,T),h)return T;for(i in(g=k.event&&v.global)&&0==k.active++&&k.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!zt.test(v.type),f=v.url.replace(Ft,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace($t,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(Pt.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(Bt,"$1"),o=(Pt.test(f)?"&":"?")+"_="+Ot+++o),v.url=f+o),v.ifModified&&(k.lastModified[f]&&T.setRequestHeader("If-Modified-Since",k.lastModified[f]),k.etag[f]&&T.setRequestHeader("If-None-Match",k.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+Gt+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=Jt(Vt,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=C.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&C.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){for(var r,i,o,a,s=e.contents,u=e.dataTypes;"*"===u[0];)u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a=a||i}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];for(o=c.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(k.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(k.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--k.active||k.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return k.get(e,t,n,"json")},getScript:function(e,t){return k.get(e,void 0,t,"script")}}),k.each(["get","post"],function(e,i){k[i]=function(e,t,n,r){return x(t)&&(r=r||n,n=t,t=void 0),k.ajax(k.extend({url:e,type:i,dataType:r,data:t,success:n},k.isPlainObject(e)&&e))}}),k._evalUrl=function(e,t){return k.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){k.globalEval(e,t)}})},k.fn.extend({wrapAll:function(e){var t;return this[0]&&(x(e)&&(e=e.call(this[0])),t=k(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return x(n)?this.each(function(e){k(this).wrapInner(n.call(this,e))}):this.each(function(){var e=k(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=x(t);return this.each(function(e){k(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){k(this).replaceWith(this.childNodes)}),this}}),k.expr.pseudos.hidden=function(e){return!k.expr.pseudos.visible(e)},k.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},k.ajaxSettings.xhr=function(){try{return new C.XMLHttpRequest}catch(e){}};var Zt={0:200,1223:204},en=k.ajaxSettings.xhr();m.cors=!!en&&"withCredentials"in en,m.ajax=en=!!en,k.ajaxTransport(function(i){var o,a;if(m.cors||en&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Zt[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&C.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),k.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),k.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return k.globalEval(e),e}}}),k.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),k.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=k("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),E.head.appendChild(r[0])},abort:function(){i&&i()}}});var tn,nn=[],rn=/(=)\?(?=&|$)|\?\?/;k.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=nn.pop()||k.expando+"_"+Ot++;return this[e]=!0,e}}),k.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(rn.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&rn.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=x(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(rn,"$1"+r):!1!==e.jsonp&&(e.url+=(Pt.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||k.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=C[r],C[r]=function(){o=arguments},n.always(function(){void 0===i?k(C).removeProp(r):C[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,nn.push(r)),o&&x(i)&&i(o[0]),o=i=void 0}),"script"}),m.createHTMLDocument=((tn=E.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===tn.childNodes.length),k.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(m.createHTMLDocument?((r=(t=E.implementation.createHTMLDocument("")).createElement("base")).href=E.location.href,t.head.appendChild(r)):t=E),o=!n&&[],(i=D.exec(e))?[t.createElement(i[1])]:(i=we([e],t,o),o&&o.length&&k(o).remove(),k.merge([],i.childNodes)));var r,i,o},k.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=Nt(e.slice(s)),e=e.slice(0,s)),x(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&k.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?k("<div>").append(k.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},k.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){k.fn[t]=function(e){return this.on(t,e)}}),k.expr.pseudos.animated=function(t){return k.grep(k.timers,function(e){return t===e.elem}).length},k.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=k.css(e,"position"),c=k(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=k.css(e,"top"),u=k.css(e,"left"),i=("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,r.left):(a=parseFloat(o)||0,parseFloat(u)||0),x(t)&&(t=t.call(e,n,k.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},k.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){k.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===k.css(r,"position"))t=r.getBoundingClientRect();else{for(t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;e&&(e===n.body||e===n.documentElement)&&"static"===k.css(e,"position");)e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=k(e).offset()).top+=k.css(e,"borderTopWidth",!0),i.left+=k.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-k.css(r,"marginTop",!0),left:t.left-i.left-k.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===k.css(e,"position");)e=e.offsetParent;return e||ie})}}),k.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;k.fn[t]=function(e){return _(this,function(e,t,n){var r;return g(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n?r?r[i]:e[t]:void(r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n)},t,e,arguments.length)}}),k.each(["top","left"],function(e,n){k.cssHooks[n]=Ze(m.pixelPosition,function(e,t){if(t)return t=Ke(e,n),Ve.test(t)?k(e).position()[n]+"px":t})}),k.each({Height:"height",Width:"width"},function(a,s){k.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){k.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return _(this,function(e,t,n){var r;return g(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?k.css(e,t,i):k.style(e,t,n,i)},s,n?e:void 0,n)}})}),k.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){k.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}}),k.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),k.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),k.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),x(e))return r=s.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(s.call(arguments)))}).guid=e.guid=e.guid||k.guid++,i},k.holdReady=function(e){e?k.readyWait++:k.ready(!0)},k.isArray=Array.isArray,k.parseJSON=JSON.parse,k.nodeName=A,k.isFunction=x,k.isWindow=g,k.camelCase=V,k.type=w,k.now=Date.now,k.isNumeric=function(e){var t=k.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},"function"==typeof define&&define.amd&&define("jquery",[],function(){return k});var on=C.jQuery,an=C.$;return k.noConflict=function(e){return C.$===k&&(C.$=an),e&&C.jQuery===k&&(C.jQuery=on),k},e||(C.jQuery=C.$=k),k});


(function($){
	$.fn.live=function(event, callback){
		if (!callback){
			return;
		}

		$(document.body).on(event, this, callback);
	};
})(jQuery);

(function($){var a=$.fn.jquery.split("."),b;for(b in a)a[b]=parseInt(a[b]);if(!$.browser&&(1<a[0]||9<=a[1])){a={browser:void 0,version:void 0,mobile:!1};navigator&&navigator.userAgent&&(a.ua=navigator.userAgent,a.webkit=/WebKit/i.test(a.ua),a.browserArray="MSIE Chrome Opera Kindle Silk BlackBerry PlayBook Android Safari Mozilla Nokia".split(" "),/Sony[^ ]*/i.test(a.ua)?a.mobile="Sony":/RIM Tablet/i.test(a.ua)?a.mobile="RIM Tablet":/BlackBerry/i.test(a.ua)?a.mobile="BlackBerry":/iPhone/i.test(a.ua)?
		a.mobile="iPhone":/iPad/i.test(a.ua)?a.mobile="iPad":/iPod/i.test(a.ua)?a.mobile="iPod":/Opera Mini/i.test(a.ua)?a.mobile="Opera Mini":/IEMobile/i.test(a.ua)?a.mobile="IEMobile":/BB[0-9]{1,}; Touch/i.test(a.ua)?a.mobile="BlackBerry":/Nokia/i.test(a.ua)?a.mobile="Nokia":/Android/i.test(a.ua)&&(a.mobile="Android"),/MSIE|Trident/i.test(a.ua)?(a.browser="MSIE",a.version=/MSIE/i.test(navigator.userAgent)&&0<parseFloat(a.ua.split("MSIE")[1].match(/[0-9\.]{1,}/)[0])?parseFloat(a.ua.split("MSIE")[1].match(/[0-9\.]{1,}/)[0]):
		"Edge",/Trident/i.test(a.ua)&&/rv:([0-9]{1,}[\.0-9]{0,})/.test(a.ua)&&(a.version=parseFloat(a.ua.match(/rv:([0-9]{1,}[\.0-9]{0,})/)[1].match(/[0-9\.]{1,}/)[0]))):/Chrome/.test(a.ua)?(a.browser="Chrome",a.version=parseFloat(a.ua.split("Chrome/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Opera/.test(a.ua)?(a.browser="Opera",a.version=parseFloat(a.ua.split("Version/")[1].match(/[0-9\.]{1,}/)[0])):/Kindle|Silk|KFTT|KFOT|KFJWA|KFJWI|KFSOWI|KFTHWA|KFTHWI|KFAPWA|KFAPWI/i.test(a.ua)?(a.mobile="Kindle",
		/Silk/i.test(a.ua)?(a.browser="Silk",a.version=parseFloat(a.ua.split("Silk/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Kindle/i.test(a.ua)&&/Version/i.test(a.ua)&&(a.browser="Kindle",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0]))):/BlackBerry/.test(a.ua)?(a.browser="BlackBerry",a.version=parseFloat(a.ua.split("/")[1].match(/[0-9\.]{1,}/)[0])):/PlayBook/.test(a.ua)?(a.browser="PlayBook",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):
		/BB[0-9]{1,}; Touch/.test(a.ua)?(a.browser="Blackberry",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Android/.test(a.ua)?(a.browser="Android",a.version=parseFloat(a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0])):/Safari/.test(a.ua)?(a.browser="Safari",a.version=parseFloat(a.ua.split("Version/")[1] ? (a.ua.split("Version/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0]) : (a.ua.split("CriOS/")[1] ? a.ua.split("CriOS/")[1].split("Safari")[0].match(/[0-9\.]{1,}/)[0] : a.ua.split("Safari")[0].match(/[0-9\.]{1,}/)[0]))):/Firefox/.test(a.ua)?(a.browser="Mozilla",a.version=parseFloat(a.ua.split("Firefox/")[1].match(/[0-9\.]{1,}/)[0])):
		/Nokia/.test(a.ua)&&(a.browser="Nokia",a.version=parseFloat(a.ua.split("Browser")[1].match(/[0-9\.]{1,}/)[0])));if(a.browser)for(var c in a.browserArray)a[a.browserArray[c].toLowerCase()]=a.browser==a.browserArray[c];$.extend(!0,$.browser={},a)}})(jQuery);
		/* - - - - - - - - - - - - - - - - - - - */






(function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)})(function(t){function e(t){for(var e=t.css("visibility");"inherit"===e;)t=t.parent(),e=t.css("visibility");return"hidden"!==e}function i(t){for(var e,i;t.length&&t[0]!==document;){if (e=t.css("position"),("absolute"===e||"relative"===e||"fixed"===e)&&(i=parseInt(t.css("zIndex"),10),!isNaN(i)&&0!==i))return i;t=t.parent()}return 0}function s(){this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},t.extend(this._defaults,this.regional[""]),this.regional.en=t.extend(!0,{},this.regional[""]),this.regional["en-US"]=t.extend(!0,{},this.regional.en),this.dpDiv=n(t("<div id='"+this._mainDivId+"' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"))}function n(e){var i="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";return e.on("mouseout",i,function(){t(this).removeClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&t(this).removeClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&t(this).removeClass("ui-datepicker-next-hover")}).on("mouseover",i,o)}function o(){t.datepicker._isDisabledDatepicker(u.inline?u.dpDiv.parent()[0]:u.input[0])||(t(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),t(this).addClass("ui-state-hover"),-1!==this.className.indexOf("ui-datepicker-prev")&&t(this).addClass("ui-datepicker-prev-hover"),-1!==this.className.indexOf("ui-datepicker-next")&&t(this).addClass("ui-datepicker-next-hover"))}function a(e,i){t.extend(e,i);for(var s in i)null==i[s]&&(e[s]=i[s]);return e}t.ui=t.ui||{},t.ui.version="1.12.1";var r=0,l=Array.prototype.slice;t.cleanData=function(e){return function(i){var s,n,o;for(o=0;null!=(n=i[o]);o++)try{s=t._data(n,"events"),s&&s.remove&&t(n).triggerHandler("remove")}catch(a){}e(i)}}(t.cleanData),t.widget=function(e,i,s){var n,o,a,r={},l=e.split(".")[0];e=e.split(".")[1];var h=l+"-"+e;return s||(s=i,i=t.Widget),t.isArray(s)&&(s=t.extend.apply(null,[{}].concat(s))),t.expr[":"][h.toLowerCase()]=function(e){return!!t.data(e,h)},t[l]=t[l]||{},n=t[l][e],o=t[l][e]=function(t,e){return this._createWidget?(arguments.length&&this._createWidget(t,e),void 0):new o(t,e)},t.extend(o,n,{version:s.version,_proto:t.extend({},s),_childConstructors:[]}),a=new i,a.options=t.widget.extend({},a.options),t.each(s,function(e,s){return t.isFunction(s)?(r[e]=function(){function t(){return i.prototype[e].apply(this,arguments)}function n(t){return i.prototype[e].apply(this,t)}return function(){var e,i=this._super,o=this._superApply;return this._super=t,this._superApply=n,e=s.apply(this,arguments),this._super=i,this._superApply=o,e}}(),void 0):(r[e]=s,void 0)}),o.prototype=t.widget.extend(a,{widgetEventPrefix:n?a.widgetEventPrefix||e:e},r,{constructor:o,namespace:l,widgetName:e,widgetFullName:h}),n?(t.each(n._childConstructors,function(e,i){var s=i.prototype;t.widget(s.namespace+"."+s.widgetName,o,i._proto)}),delete n._childConstructors):i._childConstructors.push(o),t.widget.bridge(e,o),o},t.widget.extend=function(e){for(var i,s,n=l.call(arguments,1),o=0,a=n.length;a>o;o++)for(i in n[o])s=n[o][i],n[o].hasOwnProperty(i)&&void 0!==s&&(e[i]=t.isPlainObject(s)?t.isPlainObject(e[i])?t.widget.extend({},e[i],s):t.widget.extend({},s):s);return e},t.widget.bridge=function(e,i){var s=i.prototype.widgetFullName||e;t.fn[e]=function(n){var o="string"==typeof n,a=l.call(arguments,1),r=this;return o?this.length||"instance"!==n?this.each(function(){var i,o=t.data(this,s);return"instance"===n?(r=o,!1):o?t.isFunction(o[n])&&"_"!==n.charAt(0)?(i=o[n].apply(o,a),i!==o&&void 0!==i?(r=i&&i.jquery?r.pushStack(i.get()):i,!1):void 0):t.error("no such method '"+n+"' for "+e+" widget instance"):t.error("cannot call methods on "+e+" prior to initialization; "+"attempted to call method '"+n+"'")}):r=void 0:(a.length&&(n=t.widget.extend.apply(null,[n].concat(a))),this.each(function(){var e=t.data(this,s);e?(e.option(n||{}),e._init&&e._init()):t.data(this,s,new i(n,this))})),r}},t.Widget=function(){},t.Widget._childConstructors=[],t.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{classes:{},disabled:!1,create:null},_createWidget:function(e,i){i=t(i||this.defaultElement||this)[0],this.element=t(i),this.uuid=r++,this.eventNamespace="."+this.widgetName+this.uuid,this.bindings=t(),this.hoverable=t(),this.focusable=t(),this.classesElementLookup={},i!==this&&(t.data(i,this.widgetFullName,this),this._on(!0,this.element,{remove:function(t){t.target===i&&this.destroy()}}),this.document=t(i.style?i.ownerDocument:i.document||i),this.window=t(this.document[0].defaultView||this.document[0].parentWindow)),this.options=t.widget.extend({},this.options,this._getCreateOptions(),e),this._create(),this.options.disabled&&this._setOptionDisabled(this.options.disabled),this._trigger("create",null,this._getCreateEventData()),this._init()},_getCreateOptions:function(){return{}},_getCreateEventData:t.noop,_create:t.noop,_init:t.noop,destroy:function(){var e=this;this._destroy(),t.each(this.classesElementLookup,function(t,i){e._removeClass(i,t)}),this.element.off(this.eventNamespace).removeData(this.widgetFullName),this.widget().off(this.eventNamespace).removeAttr("aria-disabled"),this.bindings.off(this.eventNamespace)},_destroy:t.noop,widget:function(){return this.element},option:function(e,i){var s,n,o,a=e;if (0===arguments.length)return t.widget.extend({},this.options);if ("string"==typeof e)if (a={},s=e.split("."),e=s.shift(),s.length){for(n=a[e]=t.widget.extend({},this.options[e]),o=0;s.length-1>o;o++)n[s[o]]=n[s[o]]||{},n=n[s[o]];if (e=s.pop(),1===arguments.length)return void 0===n[e]?null:n[e];n[e]=i}else{if (1===arguments.length)return void 0===this.options[e]?null:this.options[e];a[e]=i}return this._setOptions(a),this},_setOptions:function(t){var e;for(e in t)this._setOption(e,t[e]);return this},_setOption:function(t,e){return"classes"===t&&this._setOptionClasses(e),this.options[t]=e,"disabled"===t&&this._setOptionDisabled(e),this},_setOptionClasses:function(e){var i,s,n;for(i in e)n=this.classesElementLookup[i],e[i]!==this.options.classes[i]&&n&&n.length&&(s=t(n.get()),this._removeClass(n,i),s.addClass(this._classes({element:s,keys:i,classes:e,add:!0})))},_setOptionDisabled:function(t){this._toggleClass(this.widget(),this.widgetFullName+"-disabled",null,!!t),t&&(this._removeClass(this.hoverable,null,"ui-state-hover"),this._removeClass(this.focusable,null,"ui-state-focus"))},enable:function(){return this._setOptions({disabled:!1})},disable:function(){return this._setOptions({disabled:!0})},_classes:function(e){function i(i,o){var a,r;for(r=0;i.length>r;r++)a=n.classesElementLookup[i[r]]||t(),a=e.add?t(t.unique(a.get().concat(e.element.get()))):t(a.not(e.element).get()),n.classesElementLookup[i[r]]=a,s.push(i[r]),o&&e.classes[i[r]]&&s.push(e.classes[i[r]])}var s=[],n=this;return e=t.extend({element:this.element,classes:this.options.classes||{}},e),this._on(e.element,{remove:"_untrackClassesElement"}),e.keys&&i(e.keys.match(/\S+/g)||[],!0),e.extra&&i(e.extra.match(/\S+/g)||[]),s.join(" ")},_untrackClassesElement:function(e){var i=this;t.each(i.classesElementLookup,function(s,n){-1!==t.inArray(e.target,n)&&(i.classesElementLookup[s]=t(n.not(e.target).get()))})},_removeClass:function(t,e,i){return this._toggleClass(t,e,i,!1)},_addClass:function(t,e,i){return this._toggleClass(t,e,i,!0)},_toggleClass:function(t,e,i,s){s="boolean"==typeof s?s:i;var n="string"==typeof t||null===t,o={extra:n?e:i,keys:n?t:e,element:n?this.element:t,add:s};return o.element.toggleClass(this._classes(o),s),this},_on:function(e,i,s){var n,o=this;"boolean"!=typeof e&&(s=i,i=e,e=!1),s?(i=n=t(i),this.bindings=this.bindings.add(i)):(s=i,i=this.element,n=this.widget()),t.each(s,function(s,a){function r(){return e||o.options.disabled!==!0&&!t(this).hasClass("ui-state-disabled")?("string"==typeof a?o[a]:a).apply(o,arguments):void 0}"string"!=typeof a&&(r.guid=a.guid=a.guid||r.guid||t.guid++);var l=s.match(/^([\w:-]*)\s*(.*)$/),h=l[1]+o.eventNamespace,c=l[2];c?n.on(h,c,r):i.on(h,r)})},_off:function(e,i){i=(i||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,e.off(i).off(i),this.bindings=t(this.bindings.not(e).get()),this.focusable=t(this.focusable.not(e).get()),this.hoverable=t(this.hoverable.not(e).get())},_delay:function(t,e){function i(){return("string"==typeof t?s[t]:t).apply(s,arguments)}var s=this;return setTimeout(i,e||0)},_hoverable:function(e){this.hoverable=this.hoverable.add(e),this._on(e,{mouseenter:function(e){this._addClass(t(e.currentTarget),null,"ui-state-hover")},mouseleave:function(e){this._removeClass(t(e.currentTarget),null,"ui-state-hover")}})},_focusable:function(e){this.focusable=this.focusable.add(e),this._on(e,{focusin:function(e){this._addClass(t(e.currentTarget),null,"ui-state-focus")},focusout:function(e){this._removeClass(t(e.currentTarget),null,"ui-state-focus")}})},_trigger:function(e,i,s){var n,o,a=this.options[e];if (s=s||{},i=t.Event(i),i.type=(e===this.widgetEventPrefix?e:this.widgetEventPrefix+e).toLowerCase(),i.target=this.element[0],o=i.originalEvent)for(n in o)n in i||(i[n]=o[n]);return this.element.trigger(i,s),!(t.isFunction(a)&&a.apply(this.element[0],[i].concat(s))===!1||i.isDefaultPrevented())}},t.each({show:"fadeIn",hide:"fadeOut"},function(e,i){t.Widget.prototype["_"+e]=function(s,n,o){"string"==typeof n&&(n={effect:n});var a,r=n?n===!0||"number"==typeof n?i:n.effect||i:e;n=n||{},"number"==typeof n&&(n={duration:n}),a=!t.isEmptyObject(n),n.complete=o,n.delay&&s.delay(n.delay),a&&t.effects&&t.effects.effect[r]?s[e](n):r!==e&&s[r]?s[r](n.duration,n.easing,o):s.queue(function(i){t(this)[e](),o&&o.call(s[0]),i()})}}),t.widget,function(){function e(t,e,i){return[parseFloat(t[0])*(u.test(t[0])?e/100:1),parseFloat(t[1])*(u.test(t[1])?i/100:1)]}function i(e,i){return parseInt(t.css(e,i),10)||0}function s(e){var i=e[0];return 9===i.nodeType?{width:e.width(),height:e.height(),offset:{top:0,left:0}}:t.isWindow(i)?{width:e.width(),height:e.height(),offset:{top:e.scrollTop(),left:e.scrollLeft()}}:i.preventDefault?{width:0,height:0,offset:{top:i.pageY,left:i.pageX}}:{width:e.outerWidth(),height:e.outerHeight(),offset:e.offset()}}var n,o=Math.max,a=Math.abs,r=/left|center|right/,l=/top|center|bottom/,h=/[\+\-]\d+(\.[\d]+)?%?/,c=/^\w+/,u=/%$/,d=t.fn.position;t.position={scrollbarWidth:function(){if (void 0!==n)return n;var e,i,s=t("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),o=s.children()[0];return t("body").append(s),e=o.offsetWidth,s.css("overflow","scroll"),i=o.offsetWidth,e===i&&(i=s[0].clientWidth),s.remove(),n=e-i},getScrollInfo:function(e){var i=e.isWindow||e.isDocument?"":e.element.css("overflow-x"),s=e.isWindow||e.isDocument?"":e.element.css("overflow-y"),n="scroll"===i||"auto"===i&&e.width<e.element[0].scrollWidth,o="scroll"===s||"auto"===s&&e.height<e.element[0].scrollHeight;return{width:o?t.position.scrollbarWidth():0,height:n?t.position.scrollbarWidth():0}},getWithinInfo:function(e){var i=t(e||window),s=t.isWindow(i[0]),n=!!i[0]&&9===i[0].nodeType,o=!s&&!n;return{element:i,isWindow:s,isDocument:n,offset:o?t(e).offset():{left:0,top:0},scrollLeft:i.scrollLeft(),scrollTop:i.scrollTop(),width:i.outerWidth(),height:i.outerHeight()}}},t.fn.position=function(n){if (!n||!n.of)return d.apply(this,arguments);n=t.extend({},n);var u,p,f,g,m,_,v=t(n.of),b=t.position.getWithinInfo(n.within),y=t.position.getScrollInfo(b),w=(n.collision||"flip").split(" "),k={};return _=s(v),v[0].preventDefault&&(n.at="left top"),p=_.width,f=_.height,g=_.offset,m=t.extend({},g),t.each(["my","at"],function(){var t,e,i=(n[this]||"").split(" ");1===i.length&&(i=r.test(i[0])?i.concat(["center"]):l.test(i[0])?["center"].concat(i):["center","center"]),i[0]=r.test(i[0])?i[0]:"center",i[1]=l.test(i[1])?i[1]:"center",t=h.exec(i[0]),e=h.exec(i[1]),k[this]=[t?t[0]:0,e?e[0]:0],n[this]=[c.exec(i[0])[0],c.exec(i[1])[0]]}),1===w.length&&(w[1]=w[0]),"right"===n.at[0]?m.left+=p:"center"===n.at[0]&&(m.left+=p/2),"bottom"===n.at[1]?m.top+=f:"center"===n.at[1]&&(m.top+=f/2),u=e(k.at,p,f),m.left+=u[0],m.top+=u[1],this.each(function(){var s,r,l=t(this),h=l.outerWidth(),c=l.outerHeight(),d=i(this,"marginLeft"),_=i(this,"marginTop"),x=h+d+i(this,"marginRight")+y.width,C=c+_+i(this,"marginBottom")+y.height,D=t.extend({},m),T=e(k.my,l.outerWidth(),l.outerHeight());"right"===n.my[0]?D.left-=h:"center"===n.my[0]&&(D.left-=h/2),"bottom"===n.my[1]?D.top-=c:"center"===n.my[1]&&(D.top-=c/2),D.left+=T[0],D.top+=T[1],s={marginLeft:d,marginTop:_},t.each(["left","top"],function(e,i){t.ui.position[w[e]]&&t.ui.position[w[e]][i](D,{targetWidth:p,targetHeight:f,elemWidth:h,elemHeight:c,collisionPosition:s,collisionWidth:x,collisionHeight:C,offset:[u[0]+T[0],u[1]+T[1]],my:n.my,at:n.at,within:b,elem:l})}),n.using&&(r=function(t){var e=g.left-D.left,i=e+p-h,s=g.top-D.top,r=s+f-c,u={target:{element:v,left:g.left,top:g.top,width:p,height:f},element:{element:l,left:D.left,top:D.top,width:h,height:c},horizontal:0>i?"left":e>0?"right":"center",vertical:0>r?"top":s>0?"bottom":"middle"};h>p&&p>a(e+i)&&(u.horizontal="center"),c>f&&f>a(s+r)&&(u.vertical="middle"),u.important=o(a(e),a(i))>o(a(s),a(r))?"horizontal":"vertical",n.using.call(this,t,u)}),l.offset(t.extend(D,{using:r}))})},t.ui.position={fit:{left:function(t,e){var i,s=e.within,n=s.isWindow?s.scrollLeft:s.offset.left,a=s.width,r=t.left-e.collisionPosition.marginLeft,l=n-r,h=r+e.collisionWidth-a-n;e.collisionWidth>a?l>0&&0>=h?(i=t.left+l+e.collisionWidth-a-n,t.left+=l-i):t.left=h>0&&0>=l?n:l>h?n+a-e.collisionWidth:n:l>0?t.left+=l:h>0?t.left-=h:t.left=o(t.left-r,t.left)},top:function(t,e){var i,s=e.within,n=s.isWindow?s.scrollTop:s.offset.top,a=e.within.height,r=t.top-e.collisionPosition.marginTop,l=n-r,h=r+e.collisionHeight-a-n;e.collisionHeight>a?l>0&&0>=h?(i=t.top+l+e.collisionHeight-a-n,t.top+=l-i):t.top=h>0&&0>=l?n:l>h?n+a-e.collisionHeight:n:l>0?t.top+=l:h>0?t.top-=h:t.top=o(t.top-r,t.top)}},flip:{left:function(t,e){var i,s,n=e.within,o=n.offset.left+n.scrollLeft,r=n.width,l=n.isWindow?n.scrollLeft:n.offset.left,h=t.left-e.collisionPosition.marginLeft,c=h-l,u=h+e.collisionWidth-r-l,d="left"===e.my[0]?-e.elemWidth:"right"===e.my[0]?e.elemWidth:0,p="left"===e.at[0]?e.targetWidth:"right"===e.at[0]?-e.targetWidth:0,f=-2*e.offset[0];0>c?(i=t.left+d+p+f+e.collisionWidth-r-o,(0>i||a(c)>i)&&(t.left+=d+p+f)):u>0&&(s=t.left-e.collisionPosition.marginLeft+d+p+f-l,(s>0||u>a(s))&&(t.left+=d+p+f))},top:function(t,e){var i,s,n=e.within,o=n.offset.top+n.scrollTop,r=n.height,l=n.isWindow?n.scrollTop:n.offset.top,h=t.top-e.collisionPosition.marginTop,c=h-l,u=h+e.collisionHeight-r-l,d="top"===e.my[1],p=d?-e.elemHeight:"bottom"===e.my[1]?e.elemHeight:0,f="top"===e.at[1]?e.targetHeight:"bottom"===e.at[1]?-e.targetHeight:0,g=-2*e.offset[1];0>c?(s=t.top+p+f+g+e.collisionHeight-r-o,(0>s||a(c)>s)&&(t.top+=p+f+g)):u>0&&(i=t.top-e.collisionPosition.marginTop+p+f+g-l,(i>0||u>a(i))&&(t.top+=p+f+g))}},flipfit:{left:function(){t.ui.position.flip.left.apply(this,arguments),t.ui.position.fit.left.apply(this,arguments)},top:function(){t.ui.position.flip.top.apply(this,arguments),t.ui.position.fit.top.apply(this,arguments)}}}}(),t.ui.position,t.extend(t.expr[":"],{data:t.expr.createPseudo?t.expr.createPseudo(function(e){return function(i){return!!t.data(i,e)}}):function(e,i,s){return!!t.data(e,s[3])}}),t.fn.extend({disableSelection:function(){var t="onselectstart"in document.createElement("div")?"selectstart":"mousedown";return function(){return this.on(t+".ui-disableSelection",function(t){t.preventDefault()})}}(),enableSelection:function(){return this.off(".ui-disableSelection")}}),t.ui.focusable=function(i,s){var n,o,a,r,l,h=i.nodeName.toLowerCase();return"area"===h?(n=i.parentNode,o=n.name,i.href&&o&&"map"===n.nodeName.toLowerCase()?(a=t("img[usemap='#"+o+"']"),a.length>0&&a.is(":visible")):!1):(/^(input|select|textarea|button|object)$/.test(h)?(r=!i.disabled,r&&(l=t(i).closest("fieldset")[0],l&&(r=!l.disabled))):r="a"===h?i.href||s:s,r&&t(i).is(":visible")&&e(t(i)))},t.extend(t.expr[":"],{focusable:function(e){return t.ui.focusable(e,null!=t.attr(e,"tabindex"))}}),t.ui.focusable,t.fn.form=function(){return"string"==typeof this[0].form?this.closest("form"):t(this[0].form)},t.ui.formResetMixin={_formResetHandler:function(){var e=t(this);setTimeout(function(){var i=e.data("ui-form-reset-instances");t.each(i,function(){this.refresh()})})},_bindFormResetHandler:function(){if (this.form=this.element.form(),this.form.length){var t=this.form.data("ui-form-reset-instances")||[];t.length||this.form.on("reset.ui-form-reset",this._formResetHandler),t.push(this),this.form.data("ui-form-reset-instances",t)}},_unbindFormResetHandler:function(){if (this.form.length){var e=this.form.data("ui-form-reset-instances");e.splice(t.inArray(this,e),1),e.length?this.form.data("ui-form-reset-instances",e):this.form.removeData("ui-form-reset-instances").off("reset.ui-form-reset")}}},"1.7"===t.fn.jquery.substring(0,3)&&(t.each(["Width","Height"],function(e,i){function s(e,i,s,o){return t.each(n,function(){i-=parseFloat(t.css(e,"padding"+this))||0,s&&(i-=parseFloat(t.css(e,"border"+this+"Width"))||0),o&&(i-=parseFloat(t.css(e,"margin"+this))||0)}),i}var n="Width"===i?["Left","Right"]:["Top","Bottom"],o=i.toLowerCase(),a={innerWidth:t.fn.innerWidth,innerHeight:t.fn.innerHeight,outerWidth:t.fn.outerWidth,outerHeight:t.fn.outerHeight};t.fn["inner"+i]=function(e){return void 0===e?a["inner"+i].call(this):this.each(function(){t(this).css(o,s(this,e)+"px")})},t.fn["outer"+i]=function(e,n){return"number"!=typeof e?a["outer"+i].call(this,e):this.each(function(){t(this).css(o,s(this,e,!0,n)+"px")})}}),t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t.ui.keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},t.ui.escapeSelector=function(){var t=/([!"#$%&'()*+,./:;<=>?@[\]^`{|}~])/g;return function(e){return e.replace(t,"\\$1")}}(),t.fn.labels=function(){var e,i,s,n,o;return this[0].labels&&this[0].labels.length?this.pushStack(this[0].labels):(n=this.eq(0).parents("label"),s=this.attr("id"),s&&(e=this.eq(0).parents().last(),o=e.add(e.length?e.siblings():this.siblings()),i="label[for='"+t.ui.escapeSelector(s)+"']",n=n.add(o.find(i).addBack(i))),this.pushStack(n))},t.fn.scrollParent=function(e){var i=this.css("position"),s="absolute"===i,n=e?/(auto|scroll|hidden)/:/(auto|scroll)/,o=this.parents().filter(function(){var e=t(this);return s&&"static"===e.css("position")?!1:n.test(e.css("overflow")+e.css("overflow-y")+e.css("overflow-x"))}).eq(0);return"fixed"!==i&&o.length?o:t(this[0].ownerDocument||document)},t.extend(t.expr[":"],{tabbable:function(e){var i=t.attr(e,"tabindex"),s=null!=i;return(!s||i>=0)&&t.ui.focusable(e,s)}}),t.fn.extend({uniqueId:function(){var t=0;return function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++t)})}}(),removeUniqueId:function(){return this.each(function(){/^ui-id-\d+$/.test(this.id)&&t(this).removeAttr("id")})}}),t.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());var h=!1;t(document).on("mouseup",function(){h=!1}),t.widget("ui.mouse",{version:"1.12.1",options:{cancel:"input, textarea, button, select, option",distance:1,delay:0},_mouseInit:function(){var e=this;this.element.on("mousedown."+this.widgetName,function(t){return e._mouseDown(t)}).on("click."+this.widgetName,function(i){return!0===t.data(i.target,e.widgetName+".preventClickEvent")?(t.removeData(i.target,e.widgetName+".preventClickEvent"),i.stopImmediatePropagation(),!1):void 0}),this.started=!1},_mouseDestroy:function(){this.element.off("."+this.widgetName),this._mouseMoveDelegate&&this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate)},_mouseDown:function(e){if (!h){this._mouseMoved=!1,this._mouseStarted&&this._mouseUp(e),this._mouseDownEvent=e;var i=this,s=1===e.which,n="string"==typeof this.options.cancel&&e.target.nodeName?t(e.target).closest(this.options.cancel).length:!1;return s&&!n&&this._mouseCapture(e)?(this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){i.mouseDelayMet=!0},this.options.delay)),this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(e)!==!1,!this._mouseStarted)?(e.preventDefault(),!0):(!0===t.data(e.target,this.widgetName+".preventClickEvent")&&t.removeData(e.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(t){return i._mouseMove(t)},this._mouseUpDelegate=function(t){return i._mouseUp(t)},this.document.on("mousemove."+this.widgetName,this._mouseMoveDelegate).on("mouseup."+this.widgetName,this._mouseUpDelegate),e.preventDefault(),h=!0,!0)):!0}},_mouseMove:function(e){if (this._mouseMoved){if (t.ui.ie&&(!document.documentMode||9>document.documentMode)&&!e.button)return this._mouseUp(e);if (!e.which)if (e.originalEvent.altKey||e.originalEvent.ctrlKey||e.originalEvent.metaKey||e.originalEvent.shiftKey)this.ignoreMissingWhich=!0;else if (!this.ignoreMissingWhich)return this._mouseUp(e)}return(e.which||e.button)&&(this._mouseMoved=!0),this._mouseStarted?(this._mouseDrag(e),e.preventDefault()):(this._mouseDistanceMet(e)&&this._mouseDelayMet(e)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,e)!==!1,this._mouseStarted?this._mouseDrag(e):this._mouseUp(e)),!this._mouseStarted)},_mouseUp:function(e){this.document.off("mousemove."+this.widgetName,this._mouseMoveDelegate).off("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,e.target===this._mouseDownEvent.target&&t.data(e.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(e)),this._mouseDelayTimer&&(clearTimeout(this._mouseDelayTimer),delete this._mouseDelayTimer),this.ignoreMissingWhich=!1,h=!1,e.preventDefault()},_mouseDistanceMet:function(t){return Math.max(Math.abs(this._mouseDownEvent.pageX-t.pageX),Math.abs(this._mouseDownEvent.pageY-t.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return!0}}),t.ui.plugin={add:function(e,i,s){var n,o=t.ui[e].prototype;for(n in s)o.plugins[n]=o.plugins[n]||[],o.plugins[n].push([i,s[n]])},call:function(t,e,i,s){var n,o=t.plugins[e];if (o&&(s||t.element[0].parentNode&&11!==t.element[0].parentNode.nodeType))for(n=0;o.length>n;n++)t.options[o[n][0]]&&o[n][1].apply(t.element,i)}},t.ui.safeActiveElement=function(t){var e;try{e=t.activeElement}catch(i){e=t.body}return e||(e=t.body),e.nodeName||(e=t.body),e},t.ui.safeBlur=function(e){e&&"body"!==e.nodeName.toLowerCase()&&t(e).trigger("blur")},t.widget("ui.draggable",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1,drag:null,start:null,stop:null},_create:function(){"original"===this.options.helper&&this._setPositionRelative(),this.options.addClasses&&this._addClass("ui-draggable"),this._setHandleClassName(),this._mouseInit()},_setOption:function(t,e){this._super(t,e),"handle"===t&&(this._removeHandleClassName(),this._setHandleClassName())},_destroy:function(){return(this.helper||this.element).is(".ui-draggable-dragging")?(this.destroyOnClear=!0,void 0):(this._removeHandleClassName(),this._mouseDestroy(),void 0)},_mouseCapture:function(e){var i=this.options;return this.helper||i.disabled||t(e.target).closest(".ui-resizable-handle").length>0?!1:(this.handle=this._getHandle(e),this.handle?(this._blurActiveElement(e),this._blockFrames(i.iframeFix===!0?"iframe":i.iframeFix),!0):!1)},_blockFrames:function(e){this.iframeBlocks=this.document.find(e).map(function(){var e=t(this);return t("<div>").css("position","absolute").appendTo(e.parent()).outerWidth(e.outerWidth()).outerHeight(e.outerHeight()).offset(e.offset())[0]})},_unblockFrames:function(){this.iframeBlocks&&(this.iframeBlocks.remove(),delete this.iframeBlocks)},_blurActiveElement:function(e){var i=t.ui.safeActiveElement(this.document[0]),s=t(e.target);s.closest(i).length||t.ui.safeBlur(i)},_mouseStart:function(e){var i=this.options;return this.helper=this._createHelper(e),this._addClass(this.helper,"ui-draggable-dragging"),this._cacheHelperProportions(),t.ui.ddmanager&&(t.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(!0),this.offsetParent=this.helper.offsetParent(),this.hasFixedAncestor=this.helper.parents().filter(function(){return"fixed"===t(this).css("position")}).length>0,this.positionAbs=this.element.offset(),this._refreshOffsets(e),this.originalPosition=this.position=this._generatePosition(e,!1),this.originalPageX=e.pageX,this.originalPageY=e.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),this._setContainment(),this._trigger("start",e)===!1?(this._clear(),!1):(this._cacheHelperProportions(),t.ui.ddmanager&&!i.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this._mouseDrag(e,!0),t.ui.ddmanager&&t.ui.ddmanager.dragStart(this,e),!0)},_refreshOffsets:function(t){this.offset={top:this.positionAbs.top-this.margins.top,left:this.positionAbs.left-this.margins.left,scroll:!1,parent:this._getParentOffset(),relative:this._getRelativeOffset()},this.offset.click={left:t.pageX-this.offset.left,top:t.pageY-this.offset.top}},_mouseDrag:function(e,i){if (this.hasFixedAncestor&&(this.offset.parent=this._getParentOffset()),this.position=this._generatePosition(e,!0),this.positionAbs=this._convertPositionTo("absolute"),!i){var s=this._uiHash();if (this._trigger("drag",e,s)===!1)return this._mouseUp(new t.Event("mouseup",e)),!1;this.position=s.position}return this.helper[0].style.left=this.position.left+"px",this.helper[0].style.top=this.position.top+"px",t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),!1},_mouseStop:function(e){var i=this,s=!1;return t.ui.ddmanager&&!this.options.dropBehaviour&&(s=t.ui.ddmanager.drop(this,e)),this.dropped&&(s=this.dropped,this.dropped=!1),"invalid"===this.options.revert&&!s||"valid"===this.options.revert&&s||this.options.revert===!0||t.isFunction(this.options.revert)&&this.options.revert.call(this.element,s)?t(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){i._trigger("stop",e)!==!1&&i._clear()}):this._trigger("stop",e)!==!1&&this._clear(),!1},_mouseUp:function(e){return this._unblockFrames(),t.ui.ddmanager&&t.ui.ddmanager.dragStop(this,e),this.handleElement.is(e.target)&&this.element.trigger("focus"),t.ui.mouse.prototype._mouseUp.call(this,e)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp(new t.Event("mouseup",{target:this.element[0]})):this._clear(),this},_getHandle:function(e){return this.options.handle?!!t(e.target).closest(this.element.find(this.options.handle)).length:!0},_setHandleClassName:function(){this.handleElement=this.options.handle?this.element.find(this.options.handle):this.element,this._addClass(this.handleElement,"ui-draggable-handle")},_removeHandleClassName:function(){this._removeClass(this.handleElement,"ui-draggable-handle")},_createHelper:function(e){var i=this.options,s=t.isFunction(i.helper),n=s?t(i.helper.apply(this.element[0],[e])):"clone"===i.helper?this.element.clone().removeAttr("id"):this.element;return n.parents("body").length||n.appendTo("parent"===i.appendTo?this.element[0].parentNode:i.appendTo),s&&n[0]===this.element[0]&&this._setPositionRelative(),n[0]===this.element[0]||/(fixed|absolute)/.test(n.css("position"))||n.css("position","absolute"),n},_setPositionRelative:function(){/^(?:r|a|f)/.test(this.element.css("position"))||(this.element[0].style.position="relative")},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_isRootNode:function(t){return/(html|body)/i.test(t.tagName)||t===this.document[0]},_getParentOffset:function(){var e=this.offsetParent.offset(),i=this.document[0];return"absolute"===this.cssPosition&&this.scrollParent[0]!==i&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),this._isRootNode(this.offsetParent[0])&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if ("relative"!==this.cssPosition)return{top:0,left:0};var t=this.element.position(),e=this._isRootNode(this.scrollParent[0]);return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+(e?0:this.scrollParent.scrollTop()),left:t.left-(parseInt(this.helper.css("left"),10)||0)+(e?0:this.scrollParent.scrollLeft())}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e,i,s,n=this.options,o=this.document[0];return this.relativeContainer=null,n.containment?"window"===n.containment?(this.containment=[t(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,t(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,t(window).scrollLeft()+t(window).width()-this.helperProportions.width-this.margins.left,t(window).scrollTop()+(t(window).height()||o.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):"document"===n.containment?(this.containment=[0,0,t(o).width()-this.helperProportions.width-this.margins.left,(t(o).height()||o.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top],void 0):n.containment.constructor===Array?(this.containment=n.containment,void 0):("parent"===n.containment&&(n.containment=this.helper[0].parentNode),i=t(n.containment),s=i[0],s&&(e=/(scroll|auto)/.test(i.css("overflow")),this.containment=[(parseInt(i.css("borderLeftWidth"),10)||0)+(parseInt(i.css("paddingLeft"),10)||0),(parseInt(i.css("borderTopWidth"),10)||0)+(parseInt(i.css("paddingTop"),10)||0),(e?Math.max(s.scrollWidth,s.offsetWidth):s.offsetWidth)-(parseInt(i.css("borderRightWidth"),10)||0)-(parseInt(i.css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(e?Math.max(s.scrollHeight,s.offsetHeight):s.offsetHeight)-(parseInt(i.css("borderBottomWidth"),10)||0)-(parseInt(i.css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relativeContainer=i),void 0):(this.containment=null,void 0)
},_convertPositionTo:function(t,e){e||(e=this.position);var i="absolute"===t?1:-1,s=this._isRootNode(this.scrollParent[0]);return{top:e.top+this.offset.relative.top*i+this.offset.parent.top*i-("fixed"===this.cssPosition?-this.offset.scroll.top:s?0:this.offset.scroll.top)*i,left:e.left+this.offset.relative.left*i+this.offset.parent.left*i-("fixed"===this.cssPosition?-this.offset.scroll.left:s?0:this.offset.scroll.left)*i}},_generatePosition:function(t,e){var i,s,n,o,a=this.options,r=this._isRootNode(this.scrollParent[0]),l=t.pageX,h=t.pageY;return r&&this.offset.scroll||(this.offset.scroll={top:this.scrollParent.scrollTop(),left:this.scrollParent.scrollLeft()}),e&&(this.containment&&(this.relativeContainer?(s=this.relativeContainer.offset(),i=[this.containment[0]+s.left,this.containment[1]+s.top,this.containment[2]+s.left,this.containment[3]+s.top]):i=this.containment,t.pageX-this.offset.click.left<i[0]&&(l=i[0]+this.offset.click.left),t.pageY-this.offset.click.top<i[1]&&(h=i[1]+this.offset.click.top),t.pageX-this.offset.click.left>i[2]&&(l=i[2]+this.offset.click.left),t.pageY-this.offset.click.top>i[3]&&(h=i[3]+this.offset.click.top)),a.grid&&(n=a.grid[1]?this.originalPageY+Math.round((h-this.originalPageY)/a.grid[1])*a.grid[1]:this.originalPageY,h=i?n-this.offset.click.top>=i[1]||n-this.offset.click.top>i[3]?n:n-this.offset.click.top>=i[1]?n-a.grid[1]:n+a.grid[1]:n,o=a.grid[0]?this.originalPageX+Math.round((l-this.originalPageX)/a.grid[0])*a.grid[0]:this.originalPageX,l=i?o-this.offset.click.left>=i[0]||o-this.offset.click.left>i[2]?o:o-this.offset.click.left>=i[0]?o-a.grid[0]:o+a.grid[0]:o),"y"===a.axis&&(l=this.originalPageX),"x"===a.axis&&(h=this.originalPageY)),{top:h-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.offset.scroll.top:r?0:this.offset.scroll.top),left:l-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.offset.scroll.left:r?0:this.offset.scroll.left)}},_clear:function(){this._removeClass(this.helper,"ui-draggable-dragging"),this.helper[0]===this.element[0]||this.cancelHelperRemoval||this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1,this.destroyOnClear&&this.destroy()},_trigger:function(e,i,s){return s=s||this._uiHash(),t.ui.plugin.call(this,e,[i,s,this],!0),/^(drag|start|stop)/.test(e)&&(this.positionAbs=this._convertPositionTo("absolute"),s.offset=this.positionAbs),t.Widget.prototype._trigger.call(this,e,i,s)},plugins:{},_uiHash:function(){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}}}),t.ui.plugin.add("draggable","connectToSortable",{start:function(e,i,s){var n=t.extend({},i,{item:s.element});s.sortables=[],t(s.options.connectToSortable).each(function(){var i=t(this).sortable("instance");i&&!i.options.disabled&&(s.sortables.push(i),i.refreshPositions(),i._trigger("activate",e,n))})},stop:function(e,i,s){var n=t.extend({},i,{item:s.element});s.cancelHelperRemoval=!1,t.each(s.sortables,function(){var t=this;t.isOver?(t.isOver=0,s.cancelHelperRemoval=!0,t.cancelHelperRemoval=!1,t._storedCSS={position:t.placeholder.css("position"),top:t.placeholder.css("top"),left:t.placeholder.css("left")},t._mouseStop(e),t.options.helper=t.options._helper):(t.cancelHelperRemoval=!0,t._trigger("deactivate",e,n))})},drag:function(e,i,s){t.each(s.sortables,function(){var n=!1,o=this;o.positionAbs=s.positionAbs,o.helperProportions=s.helperProportions,o.offset.click=s.offset.click,o._intersectsWith(o.containerCache)&&(n=!0,t.each(s.sortables,function(){return this.positionAbs=s.positionAbs,this.helperProportions=s.helperProportions,this.offset.click=s.offset.click,this!==o&&this._intersectsWith(this.containerCache)&&t.contains(o.element[0],this.element[0])&&(n=!1),n})),n?(o.isOver||(o.isOver=1,s._parent=i.helper.parent(),o.currentItem=i.helper.appendTo(o.element).data("ui-sortable-item",!0),o.options._helper=o.options.helper,o.options.helper=function(){return i.helper[0]},e.target=o.currentItem[0],o._mouseCapture(e,!0),o._mouseStart(e,!0,!0),o.offset.click.top=s.offset.click.top,o.offset.click.left=s.offset.click.left,o.offset.parent.left-=s.offset.parent.left-o.offset.parent.left,o.offset.parent.top-=s.offset.parent.top-o.offset.parent.top,s._trigger("toSortable",e),s.dropped=o.element,t.each(s.sortables,function(){this.refreshPositions()}),s.currentItem=s.element,o.fromOutside=s),o.currentItem&&(o._mouseDrag(e),i.position=o.position)):o.isOver&&(o.isOver=0,o.cancelHelperRemoval=!0,o.options._revert=o.options.revert,o.options.revert=!1,o._trigger("out",e,o._uiHash(o)),o._mouseStop(e,!0),o.options.revert=o.options._revert,o.options.helper=o.options._helper,o.placeholder&&o.placeholder.remove(),i.helper.appendTo(s._parent),s._refreshOffsets(e),i.position=s._generatePosition(e,!0),s._trigger("fromSortable",e),s.dropped=!1,t.each(s.sortables,function(){this.refreshPositions()}))})}}),t.ui.plugin.add("draggable","cursor",{start:function(e,i,s){var n=t("body"),o=s.options;n.css("cursor")&&(o._cursor=n.css("cursor")),n.css("cursor",o.cursor)},stop:function(e,i,s){var n=s.options;n._cursor&&t("body").css("cursor",n._cursor)}}),t.ui.plugin.add("draggable","opacity",{start:function(e,i,s){var n=t(i.helper),o=s.options;n.css("opacity")&&(o._opacity=n.css("opacity")),n.css("opacity",o.opacity)},stop:function(e,i,s){var n=s.options;n._opacity&&t(i.helper).css("opacity",n._opacity)}}),t.ui.plugin.add("draggable","scroll",{start:function(t,e,i){i.scrollParentNotHidden||(i.scrollParentNotHidden=i.helper.scrollParent(!1)),i.scrollParentNotHidden[0]!==i.document[0]&&"HTML"!==i.scrollParentNotHidden[0].tagName&&(i.overflowOffset=i.scrollParentNotHidden.offset())},drag:function(e,i,s){var n=s.options,o=!1,a=s.scrollParentNotHidden[0],r=s.document[0];a!==r&&"HTML"!==a.tagName?(n.axis&&"x"===n.axis||(s.overflowOffset.top+a.offsetHeight-e.pageY<n.scrollSensitivity?a.scrollTop=o=a.scrollTop+n.scrollSpeed:e.pageY-s.overflowOffset.top<n.scrollSensitivity&&(a.scrollTop=o=a.scrollTop-n.scrollSpeed)),n.axis&&"y"===n.axis||(s.overflowOffset.left+a.offsetWidth-e.pageX<n.scrollSensitivity?a.scrollLeft=o=a.scrollLeft+n.scrollSpeed:e.pageX-s.overflowOffset.left<n.scrollSensitivity&&(a.scrollLeft=o=a.scrollLeft-n.scrollSpeed))):(n.axis&&"x"===n.axis||(e.pageY-t(r).scrollTop()<n.scrollSensitivity?o=t(r).scrollTop(t(r).scrollTop()-n.scrollSpeed):t(window).height()-(e.pageY-t(r).scrollTop())<n.scrollSensitivity&&(o=t(r).scrollTop(t(r).scrollTop()+n.scrollSpeed))),n.axis&&"y"===n.axis||(e.pageX-t(r).scrollLeft()<n.scrollSensitivity?o=t(r).scrollLeft(t(r).scrollLeft()-n.scrollSpeed):t(window).width()-(e.pageX-t(r).scrollLeft())<n.scrollSensitivity&&(o=t(r).scrollLeft(t(r).scrollLeft()+n.scrollSpeed)))),o!==!1&&t.ui.ddmanager&&!n.dropBehaviour&&t.ui.ddmanager.prepareOffsets(s,e)}}),t.ui.plugin.add("draggable","snap",{start:function(e,i,s){var n=s.options;s.snapElements=[],t(n.snap.constructor!==String?n.snap.items||":data(ui-draggable)":n.snap).each(function(){var e=t(this),i=e.offset();this!==s.element[0]&&s.snapElements.push({item:this,width:e.outerWidth(),height:e.outerHeight(),top:i.top,left:i.left})})},drag:function(e,i,s){var n,o,a,r,l,h,c,u,d,p,f=s.options,g=f.snapTolerance,m=i.offset.left,_=m+s.helperProportions.width,v=i.offset.top,b=v+s.helperProportions.height;for(d=s.snapElements.length-1;d>=0;d--)l=s.snapElements[d].left-s.margins.left,h=l+s.snapElements[d].width,c=s.snapElements[d].top-s.margins.top,u=c+s.snapElements[d].height,l-g>_||m>h+g||c-g>b||v>u+g||!t.contains(s.snapElements[d].item.ownerDocument,s.snapElements[d].item)?(s.snapElements[d].snapping&&s.options.snap.release&&s.options.snap.release.call(s.element,e,t.extend(s._uiHash(),{snapItem:s.snapElements[d].item})),s.snapElements[d].snapping=!1):("inner"!==f.snapMode&&(n=g>=Math.abs(c-b),o=g>=Math.abs(u-v),a=g>=Math.abs(l-_),r=g>=Math.abs(h-m),n&&(i.position.top=s._convertPositionTo("relative",{top:c-s.helperProportions.height,left:0}).top),o&&(i.position.top=s._convertPositionTo("relative",{top:u,left:0}).top),a&&(i.position.left=s._convertPositionTo("relative",{top:0,left:l-s.helperProportions.width}).left),r&&(i.position.left=s._convertPositionTo("relative",{top:0,left:h}).left)),p=n||o||a||r,"outer"!==f.snapMode&&(n=g>=Math.abs(c-v),o=g>=Math.abs(u-b),a=g>=Math.abs(l-m),r=g>=Math.abs(h-_),n&&(i.position.top=s._convertPositionTo("relative",{top:c,left:0}).top),o&&(i.position.top=s._convertPositionTo("relative",{top:u-s.helperProportions.height,left:0}).top),a&&(i.position.left=s._convertPositionTo("relative",{top:0,left:l}).left),r&&(i.position.left=s._convertPositionTo("relative",{top:0,left:h-s.helperProportions.width}).left)),!s.snapElements[d].snapping&&(n||o||a||r||p)&&s.options.snap.snap&&s.options.snap.snap.call(s.element,e,t.extend(s._uiHash(),{snapItem:s.snapElements[d].item})),s.snapElements[d].snapping=n||o||a||r||p)}}),t.ui.plugin.add("draggable","stack",{start:function(e,i,s){var n,o=s.options,a=t.makeArray(t(o.stack)).sort(function(e,i){return(parseInt(t(e).css("zIndex"),10)||0)-(parseInt(t(i).css("zIndex"),10)||0)});a.length&&(n=parseInt(t(a[0]).css("zIndex"),10)||0,t(a).each(function(e){t(this).css("zIndex",n+e)}),this.css("zIndex",n+a.length))}}),t.ui.plugin.add("draggable","zIndex",{start:function(e,i,s){var n=t(i.helper),o=s.options;n.css("zIndex")&&(o._zIndex=n.css("zIndex")),n.css("zIndex",o.zIndex)},stop:function(e,i,s){var n=s.options;n._zIndex&&t(i.helper).css("zIndex",n._zIndex)}}),t.ui.draggable,t.widget("ui.droppable",{version:"1.12.1",widgetEventPrefix:"drop",options:{accept:"*",addClasses:!0,greedy:!1,scope:"default",tolerance:"intersect",activate:null,deactivate:null,drop:null,out:null,over:null},_create:function(){var e,i=this.options,s=i.accept;this.isover=!1,this.isout=!0,this.accept=t.isFunction(s)?s:function(t){return t.is(s)},this.proportions=function(){return arguments.length?(e=arguments[0],void 0):e?e:e={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight}},this._addToManager(i.scope),i.addClasses&&this._addClass("ui-droppable")},_addToManager:function(e){t.ui.ddmanager.droppables[e]=t.ui.ddmanager.droppables[e]||[],t.ui.ddmanager.droppables[e].push(this)},_splice:function(t){for(var e=0;t.length>e;e++)t[e]===this&&t.splice(e,1)},_destroy:function(){var e=t.ui.ddmanager.droppables[this.options.scope];this._splice(e)},_setOption:function(e,i){if ("accept"===e)this.accept=t.isFunction(i)?i:function(t){return t.is(i)};else if ("scope"===e){var s=t.ui.ddmanager.droppables[this.options.scope];this._splice(s),this._addToManager(i)}this._super(e,i)},_activate:function(e){var i=t.ui.ddmanager.current;this._addActiveClass(),i&&this._trigger("activate",e,this.ui(i))},_deactivate:function(e){var i=t.ui.ddmanager.current;this._removeActiveClass(),i&&this._trigger("deactivate",e,this.ui(i))},_over:function(e){var i=t.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this._addHoverClass(),this._trigger("over",e,this.ui(i)))},_out:function(e){var i=t.ui.ddmanager.current;i&&(i.currentItem||i.element)[0]!==this.element[0]&&this.accept.call(this.element[0],i.currentItem||i.element)&&(this._removeHoverClass(),this._trigger("out",e,this.ui(i)))},_drop:function(e,i){var s=i||t.ui.ddmanager.current,n=!1;return s&&(s.currentItem||s.element)[0]!==this.element[0]?(this.element.find(":data(ui-droppable)").not(".ui-draggable-dragging").each(function(){var i=t(this).droppable("instance");return i.options.greedy&&!i.options.disabled&&i.options.scope===s.options.scope&&i.accept.call(i.element[0],s.currentItem||s.element)&&c(s,t.extend(i,{offset:i.element.offset()}),i.options.tolerance,e)?(n=!0,!1):void 0}),n?!1:this.accept.call(this.element[0],s.currentItem||s.element)?(this._removeActiveClass(),this._removeHoverClass(),this._trigger("drop",e,this.ui(s)),this.element):!1):!1},ui:function(t){return{draggable:t.currentItem||t.element,helper:t.helper,position:t.position,offset:t.positionAbs}},_addHoverClass:function(){this._addClass("ui-droppable-hover")},_removeHoverClass:function(){this._removeClass("ui-droppable-hover")},_addActiveClass:function(){this._addClass("ui-droppable-active")},_removeActiveClass:function(){this._removeClass("ui-droppable-active")}});var c=t.ui.intersect=function(){function t(t,e,i){return t>=e&&e+i>t}return function(e,i,s,n){if (!i.offset)return!1;var o=(e.positionAbs||e.position.absolute).left+e.margins.left,a=(e.positionAbs||e.position.absolute).top+e.margins.top,r=o+e.helperProportions.width,l=a+e.helperProportions.height,h=i.offset.left,c=i.offset.top,u=h+i.proportions().width,d=c+i.proportions().height;switch(s){case"fit":return o>=h&&u>=r&&a>=c&&d>=l;case"intersect":return o+e.helperProportions.width/2>h&&u>r-e.helperProportions.width/2&&a+e.helperProportions.height/2>c&&d>l-e.helperProportions.height/2;case"pointer":return t(n.pageY,c,i.proportions().height)&&t(n.pageX,h,i.proportions().width);case"touch":return(a>=c&&d>=a||l>=c&&d>=l||c>a&&l>d)&&(o>=h&&u>=o||r>=h&&u>=r||h>o&&r>u);default:return!1}}}();t.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(e,i){var s,n,o=t.ui.ddmanager.droppables[e.options.scope]||[],a=i?i.type:null,r=(e.currentItem||e.element).find(":data(ui-droppable)").addBack();t:for(s=0;o.length>s;s++)if (!(o[s].options.disabled||e&&!o[s].accept.call(o[s].element[0],e.currentItem||e.element))){for(n=0;r.length>n;n++)if (r[n]===o[s].element[0]){o[s].proportions().height=0;continue t}o[s].visible="none"!==o[s].element.css("display"),o[s].visible&&("mousedown"===a&&o[s]._activate.call(o[s],i),o[s].offset=o[s].element.offset(),o[s].proportions({width:o[s].element[0].offsetWidth,height:o[s].element[0].offsetHeight}))}},drop:function(e,i){var s=!1;return t.each((t.ui.ddmanager.droppables[e.options.scope]||[]).slice(),function(){this.options&&(!this.options.disabled&&this.visible&&c(e,this,this.options.tolerance,i)&&(s=this._drop.call(this,i)||s),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],e.currentItem||e.element)&&(this.isout=!0,this.isover=!1,this._deactivate.call(this,i)))}),s},dragStart:function(e,i){e.element.parentsUntil("body").on("scroll.droppable",function(){e.options.refreshPositions||t.ui.ddmanager.prepareOffsets(e,i)})},drag:function(e,i){e.options.refreshPositions&&t.ui.ddmanager.prepareOffsets(e,i),t.each(t.ui.ddmanager.droppables[e.options.scope]||[],function(){if (!this.options.disabled&&!this.greedyChild&&this.visible){var s,n,o,a=c(e,this,this.options.tolerance,i),r=!a&&this.isover?"isout":a&&!this.isover?"isover":null;r&&(this.options.greedy&&(n=this.options.scope,o=this.element.parents(":data(ui-droppable)").filter(function(){return t(this).droppable("instance").options.scope===n}),o.length&&(s=t(o[0]).droppable("instance"),s.greedyChild="isover"===r)),s&&"isover"===r&&(s.isover=!1,s.isout=!0,s._out.call(s,i)),this[r]=!0,this["isout"===r?"isover":"isout"]=!1,this["isover"===r?"_over":"_out"].call(this,i),s&&"isout"===r&&(s.isout=!1,s.isover=!0,s._over.call(s,i)))}})},dragStop:function(e,i){e.element.parentsUntil("body").off("scroll.droppable"),e.options.refreshPositions||t.ui.ddmanager.prepareOffsets(e,i)}},t.uiBackCompat!==!1&&t.widget("ui.droppable",t.ui.droppable,{options:{hoverClass:!1,activeClass:!1},_addActiveClass:function(){this._super(),this.options.activeClass&&this.element.addClass(this.options.activeClass)},_removeActiveClass:function(){this._super(),this.options.activeClass&&this.element.removeClass(this.options.activeClass)},_addHoverClass:function(){this._super(),this.options.hoverClass&&this.element.addClass(this.options.hoverClass)},_removeHoverClass:function(){this._super(),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass)}}),t.ui.droppable,t.widget("ui.resizable",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,classes:{"ui-resizable-se":"ui-icon ui-icon-gripsmall-diagonal-se"},containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:90,resize:null,start:null,stop:null},_num:function(t){return parseFloat(t)||0},_isNumber:function(t){return!isNaN(parseFloat(t))},_hasScroll:function(e,i){if ("hidden"===t(e).css("overflow"))return!1;var s=i&&"left"===i?"scrollLeft":"scrollTop",n=!1;return e[s]>0?!0:(e[s]=1,n=e[s]>0,e[s]=0,n)},_create:function(){var e,i=this.options,s=this;this._addClass("ui-resizable"),t.extend(this,{_aspectRatio:!!i.aspectRatio,aspectRatio:i.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:i.helper||i.ghost||i.animate?i.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/^(canvas|textarea|input|select|button|img)$/i)&&(this.element.wrap(t("<div class='ui-wrapper' style='overflow: hidden;'></div>").css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("ui-resizable",this.element.resizable("instance")),this.elementIsWrapper=!0,e={marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom"),marginLeft:this.originalElement.css("marginLeft")},this.element.css(e),this.originalElement.css("margin",0),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css(e),this._proportionallyResize()),this._setupHandles(),i.autoHide&&t(this.element).on("mouseenter",function(){i.disabled||(s._removeClass("ui-resizable-autohide"),s._handles.show())}).on("mouseleave",function(){i.disabled||s.resizing||(s._addClass("ui-resizable-autohide"),s._handles.hide())}),this._mouseInit()},_destroy:function(){this._mouseDestroy();var e,i=function(e){t(e).removeData("resizable").removeData("ui-resizable").off(".resizable").find(".ui-resizable-handle").remove()};return this.elementIsWrapper&&(i(this.element),e=this.element,this.originalElement.css({position:e.css("position"),width:e.outerWidth(),height:e.outerHeight(),top:e.css("top"),left:e.css("left")}).insertAfter(e),e.remove()),this.originalElement.css("resize",this.originalResizeStyle),i(this.originalElement),this},_setOption:function(t,e){switch(this._super(t,e),t){case"handles":this._removeHandles(),this._setupHandles();break;default:}},_setupHandles:function(){var e,i,s,n,o,a=this.options,r=this;if (this.handles=a.handles||(t(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se"),this._handles=t(),this.handles.constructor===String)for("all"===this.handles&&(this.handles="n,e,s,w,se,sw,ne,nw"),s=this.handles.split(","),this.handles={},i=0;s.length>i;i++)e=t.trim(s[i]),n="ui-resizable-"+e,o=t("<div>"),this._addClass(o,"ui-resizable-handle "+n),o.css({zIndex:a.zIndex}),this.handles[e]=".ui-resizable-"+e,this.element.append(o);this._renderAxis=function(e){var i,s,n,o;e=e||this.element;for(i in this.handles)this.handles[i].constructor===String?this.handles[i]=this.element.children(this.handles[i]).first().show():(this.handles[i].jquery||this.handles[i].nodeType)&&(this.handles[i]=t(this.handles[i]),this._on(this.handles[i],{mousedown:r._mouseDown})),this.elementIsWrapper&&this.originalElement[0].nodeName.match(/^(textarea|input|select|button)$/i)&&(s=t(this.handles[i],this.element),o=/sw|ne|nw|se|n|s/.test(i)?s.outerHeight():s.outerWidth(),n=["padding",/ne|nw|n/.test(i)?"Top":/se|sw|s/.test(i)?"Bottom":/^e$/.test(i)?"Right":"Left"].join(""),e.css(n,o),this._proportionallyResize()),this._handles=this._handles.add(this.handles[i])},this._renderAxis(this.element),this._handles=this._handles.add(this.element.find(".ui-resizable-handle")),this._handles.disableSelection(),this._handles.on("mouseover",function(){r.resizing||(this.className&&(o=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)),r.axis=o&&o[1]?o[1]:"se")}),a.autoHide&&(this._handles.hide(),this._addClass("ui-resizable-autohide"))},_removeHandles:function(){this._handles.remove()},_mouseCapture:function(e){var i,s,n=!1;for(i in this.handles)s=t(this.handles[i])[0],(s===e.target||t.contains(s,e.target))&&(n=!0);return!this.options.disabled&&n},_mouseStart:function(e){var i,s,n,o=this.options,a=this.element;return this.resizing=!0,this._renderProxy(),i=this._num(this.helper.css("left")),s=this._num(this.helper.css("top")),o.containment&&(i+=t(o.containment).scrollLeft()||0,s+=t(o.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:i,top:s},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:a.width(),height:a.height()},this.originalSize=this._helper?{width:a.outerWidth(),height:a.outerHeight()}:{width:a.width(),height:a.height()},this.sizeDiff={width:a.outerWidth()-a.width(),height:a.outerHeight()-a.height()},this.originalPosition={left:i,top:s},this.originalMousePosition={left:e.pageX,top:e.pageY},this.aspectRatio="number"==typeof o.aspectRatio?o.aspectRatio:this.originalSize.width/this.originalSize.height||1,n=t(".ui-resizable-"+this.axis).css("cursor"),t("body").css("cursor","auto"===n?this.axis+"-resize":n),this._addClass("ui-resizable-resizing"),this._propagate("start",e),!0},_mouseDrag:function(e){var i,s,n=this.originalMousePosition,o=this.axis,a=e.pageX-n.left||0,r=e.pageY-n.top||0,l=this._change[o];return this._updatePrevProperties(),l?(i=l.apply(this,[e,a,r]),this._updateVirtualBoundaries(e.shiftKey),(this._aspectRatio||e.shiftKey)&&(i=this._updateRatio(i,e)),i=this._respectSize(i,e),this._updateCache(i),this._propagate("resize",e),s=this._applyChanges(),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),t.isEmptyObject(s)||(this._updatePrevProperties(),this._trigger("resize",e,this.ui()),this._applyChanges()),!1):!1},_mouseStop:function(e){this.resizing=!1;var i,s,n,o,a,r,l,h=this.options,c=this;return this._helper&&(i=this._proportionallyResizeElements,s=i.length&&/textarea/i.test(i[0].nodeName),n=s&&this._hasScroll(i[0],"left")?0:c.sizeDiff.height,o=s?0:c.sizeDiff.width,a={width:c.helper.width()-o,height:c.helper.height()-n},r=parseFloat(c.element.css("left"))+(c.position.left-c.originalPosition.left)||null,l=parseFloat(c.element.css("top"))+(c.position.top-c.originalPosition.top)||null,h.animate||this.element.css(t.extend(a,{top:l,left:r})),c.helper.height(c.size.height),c.helper.width(c.size.width),this._helper&&!h.animate&&this._proportionallyResize()),t("body").css("cursor","auto"),this._removeClass("ui-resizable-resizing"),this._propagate("stop",e),this._helper&&this.helper.remove(),!1},_updatePrevProperties:function(){this.prevPosition={top:this.position.top,left:this.position.left},this.prevSize={width:this.size.width,height:this.size.height}},_applyChanges:function(){var t={};return this.position.top!==this.prevPosition.top&&(t.top=this.position.top+"px"),this.position.left!==this.prevPosition.left&&(t.left=this.position.left+"px"),this.size.width!==this.prevSize.width&&(t.width=this.size.width+"px"),this.size.height!==this.prevSize.height&&(t.height=this.size.height+"px"),this.helper.css(t),t},_updateVirtualBoundaries:function(t){var e,i,s,n,o,a=this.options;o={minWidth:this._isNumber(a.minWidth)?a.minWidth:0,maxWidth:this._isNumber(a.maxWidth)?a.maxWidth:1/0,minHeight:this._isNumber(a.minHeight)?a.minHeight:0,maxHeight:this._isNumber(a.maxHeight)?a.maxHeight:1/0},(this._aspectRatio||t)&&(e=o.minHeight*this.aspectRatio,s=o.minWidth/this.aspectRatio,i=o.maxHeight*this.aspectRatio,n=o.maxWidth/this.aspectRatio,e>o.minWidth&&(o.minWidth=e),s>o.minHeight&&(o.minHeight=s),o.maxWidth>i&&(o.maxWidth=i),o.maxHeight>n&&(o.maxHeight=n)),this._vBoundaries=o},_updateCache:function(t){this.offset=this.helper.offset(),this._isNumber(t.left)&&(this.position.left=t.left),this._isNumber(t.top)&&(this.position.top=t.top),this._isNumber(t.height)&&(this.size.height=t.height),this._isNumber(t.width)&&(this.size.width=t.width)},_updateRatio:function(t){var e=this.position,i=this.size,s=this.axis;return this._isNumber(t.height)?t.width=t.height*this.aspectRatio:this._isNumber(t.width)&&(t.height=t.width/this.aspectRatio),"sw"===s&&(t.left=e.left+(i.width-t.width),t.top=null),"nw"===s&&(t.top=e.top+(i.height-t.height),t.left=e.left+(i.width-t.width)),t},_respectSize:function(t){var e=this._vBoundaries,i=this.axis,s=this._isNumber(t.width)&&e.maxWidth&&e.maxWidth<t.width,n=this._isNumber(t.height)&&e.maxHeight&&e.maxHeight<t.height,o=this._isNumber(t.width)&&e.minWidth&&e.minWidth>t.width,a=this._isNumber(t.height)&&e.minHeight&&e.minHeight>t.height,r=this.originalPosition.left+this.originalSize.width,l=this.originalPosition.top+this.originalSize.height,h=/sw|nw|w/.test(i),c=/nw|ne|n/.test(i);return o&&(t.width=e.minWidth),a&&(t.height=e.minHeight),s&&(t.width=e.maxWidth),n&&(t.height=e.maxHeight),o&&h&&(t.left=r-e.minWidth),s&&h&&(t.left=r-e.maxWidth),a&&c&&(t.top=l-e.minHeight),n&&c&&(t.top=l-e.maxHeight),t.width||t.height||t.left||!t.top?t.width||t.height||t.top||!t.left||(t.left=null):t.top=null,t},_getPaddingPlusBorderDimensions:function(t){for(var e=0,i=[],s=[t.css("borderTopWidth"),t.css("borderRightWidth"),t.css("borderBottomWidth"),t.css("borderLeftWidth")],n=[t.css("paddingTop"),t.css("paddingRight"),t.css("paddingBottom"),t.css("paddingLeft")];4>e;e++)i[e]=parseFloat(s[e])||0,i[e]+=parseFloat(n[e])||0;return{height:i[0]+i[2],width:i[1]+i[3]}},_proportionallyResize:function(){if (this._proportionallyResizeElements.length)for(var t,e=0,i=this.helper||this.element;this._proportionallyResizeElements.length>e;e++)t=this._proportionallyResizeElements[e],this.outerDimensions||(this.outerDimensions=this._getPaddingPlusBorderDimensions(t)),t.css({height:i.height()-this.outerDimensions.height||0,width:i.width()-this.outerDimensions.width||0})},_renderProxy:function(){var e=this.element,i=this.options;this.elementOffset=e.offset(),this._helper?(this.helper=this.helper||t("<div style='overflow:hidden;'></div>"),this._addClass(this.helper,this._helper),this.helper.css({width:this.element.outerWidth(),height:this.element.outerHeight(),position:"absolute",left:this.elementOffset.left+"px",top:this.elementOffset.top+"px",zIndex:++i.zIndex}),this.helper.appendTo("body").disableSelection()):this.helper=this.element},_change:{e:function(t,e){return{width:this.originalSize.width+e}},w:function(t,e){var i=this.originalSize,s=this.originalPosition;return{left:s.left+e,width:i.width-e}},n:function(t,e,i){var s=this.originalSize,n=this.originalPosition;return{top:n.top+i,height:s.height-i}},s:function(t,e,i){return{height:this.originalSize.height+i}},se:function(e,i,s){return t.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[e,i,s]))},sw:function(e,i,s){return t.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[e,i,s]))},ne:function(e,i,s){return t.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[e,i,s]))},nw:function(e,i,s){return t.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[e,i,s]))}},_propagate:function(e,i){t.ui.plugin.call(this,e,[i,this.ui()]),"resize"!==e&&this._trigger(e,i,this.ui())},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}}}),t.ui.plugin.add("resizable","animate",{stop:function(e){var i=t(this).resizable("instance"),s=i.options,n=i._proportionallyResizeElements,o=n.length&&/textarea/i.test(n[0].nodeName),a=o&&i._hasScroll(n[0],"left")?0:i.sizeDiff.height,r=o?0:i.sizeDiff.width,l={width:i.size.width-r,height:i.size.height-a},h=parseFloat(i.element.css("left"))+(i.position.left-i.originalPosition.left)||null,c=parseFloat(i.element.css("top"))+(i.position.top-i.originalPosition.top)||null;i.element.animate(t.extend(l,c&&h?{top:c,left:h}:{}),{duration:s.animateDuration,easing:s.animateEasing,step:function(){var s={width:parseFloat(i.element.css("width")),height:parseFloat(i.element.css("height")),top:parseFloat(i.element.css("top")),left:parseFloat(i.element.css("left"))};n&&n.length&&t(n[0]).css({width:s.width,height:s.height}),i._updateCache(s),i._propagate("resize",e)}})}}),t.ui.plugin.add("resizable","containment",{start:function(){var e,i,s,n,o,a,r,l=t(this).resizable("instance"),h=l.options,c=l.element,u=h.containment,d=u instanceof t?u.get(0):/parent/.test(u)?c.parent().get(0):u;d&&(l.containerElement=t(d),/document/.test(u)||u===document?(l.containerOffset={left:0,top:0},l.containerPosition={left:0,top:0},l.parentData={element:t(document),left:0,top:0,width:t(document).width(),height:t(document).height()||document.body.parentNode.scrollHeight}):(e=t(d),i=[],t(["Top","Right","Left","Bottom"]).each(function(t,s){i[t]=l._num(e.css("padding"+s))}),l.containerOffset=e.offset(),l.containerPosition=e.position(),l.containerSize={height:e.innerHeight()-i[3],width:e.innerWidth()-i[1]},s=l.containerOffset,n=l.containerSize.height,o=l.containerSize.width,a=l._hasScroll(d,"left")?d.scrollWidth:o,r=l._hasScroll(d)?d.scrollHeight:n,l.parentData={element:d,left:s.left,top:s.top,width:a,height:r}))},resize:function(e){var i,s,n,o,a=t(this).resizable("instance"),r=a.options,l=a.containerOffset,h=a.position,c=a._aspectRatio||e.shiftKey,u={top:0,left:0},d=a.containerElement,p=!0;d[0]!==document&&/static/.test(d.css("position"))&&(u=l),h.left<(a._helper?l.left:0)&&(a.size.width=a.size.width+(a._helper?a.position.left-l.left:a.position.left-u.left),c&&(a.size.height=a.size.width/a.aspectRatio,p=!1),a.position.left=r.helper?l.left:0),h.top<(a._helper?l.top:0)&&(a.size.height=a.size.height+(a._helper?a.position.top-l.top:a.position.top),c&&(a.size.width=a.size.height*a.aspectRatio,p=!1),a.position.top=a._helper?l.top:0),n=a.containerElement.get(0)===a.element.parent().get(0),o=/relative|absolute/.test(a.containerElement.css("position")),n&&o?(a.offset.left=a.parentData.left+a.position.left,a.offset.top=a.parentData.top+a.position.top):(a.offset.left=a.element.offset().left,a.offset.top=a.element.offset().top),i=Math.abs(a.sizeDiff.width+(a._helper?a.offset.left-u.left:a.offset.left-l.left)),s=Math.abs(a.sizeDiff.height+(a._helper?a.offset.top-u.top:a.offset.top-l.top)),i+a.size.width>=a.parentData.width&&(a.size.width=a.parentData.width-i,c&&(a.size.height=a.size.width/a.aspectRatio,p=!1)),s+a.size.height>=a.parentData.height&&(a.size.height=a.parentData.height-s,c&&(a.size.width=a.size.height*a.aspectRatio,p=!1)),p||(a.position.left=a.prevPosition.left,a.position.top=a.prevPosition.top,a.size.width=a.prevSize.width,a.size.height=a.prevSize.height)},stop:function(){var e=t(this).resizable("instance"),i=e.options,s=e.containerOffset,n=e.containerPosition,o=e.containerElement,a=t(e.helper),r=a.offset(),l=a.outerWidth()-e.sizeDiff.width,h=a.outerHeight()-e.sizeDiff.height;e._helper&&!i.animate&&/relative/.test(o.css("position"))&&t(this).css({left:r.left-n.left-s.left,width:l,height:h}),e._helper&&!i.animate&&/static/.test(o.css("position"))&&t(this).css({left:r.left-n.left-s.left,width:l,height:h})}}),t.ui.plugin.add("resizable","alsoResize",{start:function(){var e=t(this).resizable("instance"),i=e.options;t(i.alsoResize).each(function(){var e=t(this);e.data("ui-resizable-alsoresize",{width:parseFloat(e.width()),height:parseFloat(e.height()),left:parseFloat(e.css("left")),top:parseFloat(e.css("top"))})})},resize:function(e,i){var s=t(this).resizable("instance"),n=s.options,o=s.originalSize,a=s.originalPosition,r={height:s.size.height-o.height||0,width:s.size.width-o.width||0,top:s.position.top-a.top||0,left:s.position.left-a.left||0};
t(n.alsoResize).each(function(){var e=t(this),s=t(this).data("ui-resizable-alsoresize"),n={},o=e.parents(i.originalElement[0]).length?["width","height"]:["width","height","top","left"];t.each(o,function(t,e){var i=(s[e]||0)+(r[e]||0);i&&i>=0&&(n[e]=i||null)}),e.css(n)})},stop:function(){t(this).removeData("ui-resizable-alsoresize")}}),t.ui.plugin.add("resizable","ghost",{start:function(){var e=t(this).resizable("instance"),i=e.size;e.ghost=e.originalElement.clone(),e.ghost.css({opacity:.25,display:"block",position:"relative",height:i.height,width:i.width,margin:0,left:0,top:0}),e._addClass(e.ghost,"ui-resizable-ghost"),t.uiBackCompat!==!1&&"string"==typeof e.options.ghost&&e.ghost.addClass(this.options.ghost),e.ghost.appendTo(e.helper)},resize:function(){var e=t(this).resizable("instance");e.ghost&&e.ghost.css({position:"relative",height:e.size.height,width:e.size.width})},stop:function(){var e=t(this).resizable("instance");e.ghost&&e.helper&&e.helper.get(0).removeChild(e.ghost.get(0))}}),t.ui.plugin.add("resizable","grid",{resize:function(){var e,i=t(this).resizable("instance"),s=i.options,n=i.size,o=i.originalSize,a=i.originalPosition,r=i.axis,l="number"==typeof s.grid?[s.grid,s.grid]:s.grid,h=l[0]||1,c=l[1]||1,u=Math.round((n.width-o.width)/h)*h,d=Math.round((n.height-o.height)/c)*c,p=o.width+u,f=o.height+d,g=s.maxWidth&&p>s.maxWidth,m=s.maxHeight&&f>s.maxHeight,_=s.minWidth&&s.minWidth>p,v=s.minHeight&&s.minHeight>f;s.grid=l,_&&(p+=h),v&&(f+=c),g&&(p-=h),m&&(f-=c),/^(se|s|e)$/.test(r)?(i.size.width=p,i.size.height=f):/^(ne)$/.test(r)?(i.size.width=p,i.size.height=f,i.position.top=a.top-d):/^(sw)$/.test(r)?(i.size.width=p,i.size.height=f,i.position.left=a.left-u):((0>=f-c||0>=p-h)&&(e=i._getPaddingPlusBorderDimensions(this)),f-c>0?(i.size.height=f,i.position.top=a.top-d):(f=c-e.height,i.size.height=f,i.position.top=a.top+o.height-f),p-h>0?(i.size.width=p,i.position.left=a.left-u):(p=h-e.width,i.size.width=p,i.position.left=a.left+o.width-p))}}),t.ui.resizable,t.widget("ui.selectable",t.ui.mouse,{version:"1.12.1",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch",selected:null,selecting:null,start:null,stop:null,unselected:null,unselecting:null},_create:function(){var e=this;this._addClass("ui-selectable"),this.dragged=!1,this.refresh=function(){e.elementPos=t(e.element[0]).offset(),e.selectees=t(e.options.filter,e.element[0]),e._addClass(e.selectees,"ui-selectee"),e.selectees.each(function(){var i=t(this),s=i.offset(),n={left:s.left-e.elementPos.left,top:s.top-e.elementPos.top};t.data(this,"selectable-item",{element:this,$element:i,left:n.left,top:n.top,right:n.left+i.outerWidth(),bottom:n.top+i.outerHeight(),startselected:!1,selected:i.hasClass("ui-selected"),selecting:i.hasClass("ui-selecting"),unselecting:i.hasClass("ui-unselecting")})})},this.refresh(),this._mouseInit(),this.helper=t("<div>"),this._addClass(this.helper,"ui-selectable-helper")},_destroy:function(){this.selectees.removeData("selectable-item"),this._mouseDestroy()},_mouseStart:function(e){var i=this,s=this.options;this.opos=[e.pageX,e.pageY],this.elementPos=t(this.element[0]).offset(),this.options.disabled||(this.selectees=t(s.filter,this.element[0]),this._trigger("start",e),t(s.appendTo).append(this.helper),this.helper.css({left:e.pageX,top:e.pageY,width:0,height:0}),s.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var s=t.data(this,"selectable-item");s.startselected=!0,e.metaKey||e.ctrlKey||(i._removeClass(s.$element,"ui-selected"),s.selected=!1,i._addClass(s.$element,"ui-unselecting"),s.unselecting=!0,i._trigger("unselecting",e,{unselecting:s.element}))}),t(e.target).parents().addBack().each(function(){var s,n=t.data(this,"selectable-item");return n?(s=!e.metaKey&&!e.ctrlKey||!n.$element.hasClass("ui-selected"),i._removeClass(n.$element,s?"ui-unselecting":"ui-selected")._addClass(n.$element,s?"ui-selecting":"ui-unselecting"),n.unselecting=!s,n.selecting=s,n.selected=s,s?i._trigger("selecting",e,{selecting:n.element}):i._trigger("unselecting",e,{unselecting:n.element}),!1):void 0}))},_mouseDrag:function(e){if (this.dragged=!0,!this.options.disabled){var i,s=this,n=this.options,o=this.opos[0],a=this.opos[1],r=e.pageX,l=e.pageY;return o>r&&(i=r,r=o,o=i),a>l&&(i=l,l=a,a=i),this.helper.css({left:o,top:a,width:r-o,height:l-a}),this.selectees.each(function(){var i=t.data(this,"selectable-item"),h=!1,c={};i&&i.element!==s.element[0]&&(c.left=i.left+s.elementPos.left,c.right=i.right+s.elementPos.left,c.top=i.top+s.elementPos.top,c.bottom=i.bottom+s.elementPos.top,"touch"===n.tolerance?h=!(c.left>r||o>c.right||c.top>l||a>c.bottom):"fit"===n.tolerance&&(h=c.left>o&&r>c.right&&c.top>a&&l>c.bottom),h?(i.selected&&(s._removeClass(i.$element,"ui-selected"),i.selected=!1),i.unselecting&&(s._removeClass(i.$element,"ui-unselecting"),i.unselecting=!1),i.selecting||(s._addClass(i.$element,"ui-selecting"),i.selecting=!0,s._trigger("selecting",e,{selecting:i.element}))):(i.selecting&&((e.metaKey||e.ctrlKey)&&i.startselected?(s._removeClass(i.$element,"ui-selecting"),i.selecting=!1,s._addClass(i.$element,"ui-selected"),i.selected=!0):(s._removeClass(i.$element,"ui-selecting"),i.selecting=!1,i.startselected&&(s._addClass(i.$element,"ui-unselecting"),i.unselecting=!0),s._trigger("unselecting",e,{unselecting:i.element}))),i.selected&&(e.metaKey||e.ctrlKey||i.startselected||(s._removeClass(i.$element,"ui-selected"),i.selected=!1,s._addClass(i.$element,"ui-unselecting"),i.unselecting=!0,s._trigger("unselecting",e,{unselecting:i.element})))))}),!1}},_mouseStop:function(e){var i=this;return this.dragged=!1,t(".ui-unselecting",this.element[0]).each(function(){var s=t.data(this,"selectable-item");i._removeClass(s.$element,"ui-unselecting"),s.unselecting=!1,s.startselected=!1,i._trigger("unselected",e,{unselected:s.element})}),t(".ui-selecting",this.element[0]).each(function(){var s=t.data(this,"selectable-item");i._removeClass(s.$element,"ui-selecting")._addClass(s.$element,"ui-selected"),s.selecting=!1,s.selected=!0,s.startselected=!0,i._trigger("selected",e,{selected:s.element})}),this._trigger("stop",e),this.helper.remove(),!1}}),t.widget("ui.sortable",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_isOverAxis:function(t,e,i){return t>=e&&e+i>t},_isFloating:function(t){return/left|right/.test(t.css("float"))||/inline|table-cell/.test(t.css("display"))},_create:function(){this.containerCache={},this._addClass("ui-sortable"),this.refresh(),this.offset=this.element.offset(),this._mouseInit(),this._setHandleClassName(),this.ready=!0},_setOption:function(t,e){this._super(t,e),"handle"===t&&this._setHandleClassName()},_setHandleClassName:function(){var e=this;this._removeClass(this.element.find(".ui-sortable-handle"),"ui-sortable-handle"),t.each(this.items,function(){e._addClass(this.instance.options.handle?this.item.find(this.instance.options.handle):this.item,"ui-sortable-handle")})},_destroy:function(){this._mouseDestroy();for(var t=this.items.length-1;t>=0;t--)this.items[t].item.removeData(this.widgetName+"-item");return this},_mouseCapture:function(e,i){var s=null,n=!1,o=this;return this.reverting?!1:this.options.disabled||"static"===this.options.type?!1:(this._refreshItems(e),t(e.target).parents().each(function(){return t.data(this,o.widgetName+"-item")===o?(s=t(this),!1):void 0}),t.data(e.target,o.widgetName+"-item")===o&&(s=t(e.target)),s?!this.options.handle||i||(t(this.options.handle,s).find("*").addBack().each(function(){this===e.target&&(n=!0)}),n)?(this.currentItem=s,this._removeCurrentsFromItems(),!0):!1:!1)},_mouseStart:function(e,i,s){var n,o,a=this.options;if (this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(e),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},t.extend(this.offset,{click:{left:e.pageX-this.offset.left,top:e.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(e),this.originalPageX=e.pageX,this.originalPageY=e.pageY,a.cursorAt&&this._adjustOffsetFromHelper(a.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!==this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),a.containment&&this._setContainment(),a.cursor&&"auto"!==a.cursor&&(o=this.document.find("body"),this.storedCursor=o.css("cursor"),o.css("cursor",a.cursor),this.storedStylesheet=t("<style>*{ cursor: "+a.cursor+" !important; }</style>").appendTo(o)),a.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",a.opacity)),a.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",a.zIndex)),this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",e,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions(),!s)for(n=this.containers.length-1;n>=0;n--)this.containers[n]._trigger("activate",e,this._uiHash(this));return t.ui.ddmanager&&(t.ui.ddmanager.current=this),t.ui.ddmanager&&!a.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e),this.dragging=!0,this._addClass(this.helper,"ui-sortable-helper"),this._mouseDrag(e),!0},_mouseDrag:function(e){var i,s,n,o,a=this.options,r=!1;for(this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==this.document[0]&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-e.pageY<a.scrollSensitivity?this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop+a.scrollSpeed:e.pageY-this.overflowOffset.top<a.scrollSensitivity&&(this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop-a.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-e.pageX<a.scrollSensitivity?this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft+a.scrollSpeed:e.pageX-this.overflowOffset.left<a.scrollSensitivity&&(this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft-a.scrollSpeed)):(e.pageY-this.document.scrollTop()<a.scrollSensitivity?r=this.document.scrollTop(this.document.scrollTop()-a.scrollSpeed):this.window.height()-(e.pageY-this.document.scrollTop())<a.scrollSensitivity&&(r=this.document.scrollTop(this.document.scrollTop()+a.scrollSpeed)),e.pageX-this.document.scrollLeft()<a.scrollSensitivity?r=this.document.scrollLeft(this.document.scrollLeft()-a.scrollSpeed):this.window.width()-(e.pageX-this.document.scrollLeft())<a.scrollSensitivity&&(r=this.document.scrollLeft(this.document.scrollLeft()+a.scrollSpeed))),r!==!1&&t.ui.ddmanager&&!a.dropBehaviour&&t.ui.ddmanager.prepareOffsets(this,e)),this.positionAbs=this._convertPositionTo("absolute"),this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),i=this.items.length-1;i>=0;i--)if (s=this.items[i],n=s.item[0],o=this._intersectsWithPointer(s),o&&s.instance===this.currentContainer&&n!==this.currentItem[0]&&this.placeholder[1===o?"next":"prev"]()[0]!==n&&!t.contains(this.placeholder[0],n)&&("semi-dynamic"===this.options.type?!t.contains(this.element[0],n):!0)){if (this.direction=1===o?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(s))break;this._rearrange(e,s),this._trigger("change",e,this._uiHash());break}return this._contactContainers(e),t.ui.ddmanager&&t.ui.ddmanager.drag(this,e),this._trigger("sort",e,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(e,i){if (e){if (t.ui.ddmanager&&!this.options.dropBehaviour&&t.ui.ddmanager.drop(this,e),this.options.revert){var s=this,n=this.placeholder.offset(),o=this.options.axis,a={};o&&"x"!==o||(a.left=n.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollLeft)),o&&"y"!==o||(a.top=n.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===this.document[0].body?0:this.offsetParent[0].scrollTop)),this.reverting=!0,t(this.helper).animate(a,parseInt(this.options.revert,10)||500,function(){s._clear(e)})}else this._clear(e,i);return!1}},cancel:function(){if (this.dragging){this._mouseUp(new t.Event("mouseup",{target:null})),"original"===this.options.helper?(this.currentItem.css(this._storedCSS),this._removeClass(this.currentItem,"ui-sortable-helper")):this.currentItem.show();for(var e=this.containers.length-1;e>=0;e--)this.containers[e]._trigger("deactivate",null,this._uiHash(this)),this.containers[e].containerCache.over&&(this.containers[e]._trigger("out",null,this._uiHash(this)),this.containers[e].containerCache.over=0)}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),"original"!==this.options.helper&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),t.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?t(this.domPosition.prev).after(this.currentItem):t(this.domPosition.parent).prepend(this.currentItem)),this},serialize:function(e){var i=this._getItemsAsjQuery(e&&e.connected),s=[];return e=e||{},t(i).each(function(){var i=(t(e.item||this).attr(e.attribute||"id")||"").match(e.expression||/(.+)[\-=_](.+)/);i&&s.push((e.key||i[1]+"[]")+"="+(e.key&&e.expression?i[1]:i[2]))}),!s.length&&e.key&&s.push(e.key+"="),s.join("&")},toArray:function(e){var i=this._getItemsAsjQuery(e&&e.connected),s=[];return e=e||{},i.each(function(){s.push(t(e.item||this).attr(e.attribute||"id")||"")}),s},_intersectsWith:function(t){var e=this.positionAbs.left,i=e+this.helperProportions.width,s=this.positionAbs.top,n=s+this.helperProportions.height,o=t.left,a=o+t.width,r=t.top,l=r+t.height,h=this.offset.click.top,c=this.offset.click.left,u="x"===this.options.axis||s+h>r&&l>s+h,d="y"===this.options.axis||e+c>o&&a>e+c,p=u&&d;return"pointer"===this.options.tolerance||this.options.forcePointerForContainers||"pointer"!==this.options.tolerance&&this.helperProportions[this.floating?"width":"height"]>t[this.floating?"width":"height"]?p:e+this.helperProportions.width/2>o&&a>i-this.helperProportions.width/2&&s+this.helperProportions.height/2>r&&l>n-this.helperProportions.height/2},_intersectsWithPointer:function(t){var e,i,s="x"===this.options.axis||this._isOverAxis(this.positionAbs.top+this.offset.click.top,t.top,t.height),n="y"===this.options.axis||this._isOverAxis(this.positionAbs.left+this.offset.click.left,t.left,t.width),o=s&&n;return o?(e=this._getDragVerticalDirection(),i=this._getDragHorizontalDirection(),this.floating?"right"===i||"down"===e?2:1:e&&("down"===e?2:1)):!1},_intersectsWithSides:function(t){var e=this._isOverAxis(this.positionAbs.top+this.offset.click.top,t.top+t.height/2,t.height),i=this._isOverAxis(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),s=this._getDragVerticalDirection(),n=this._getDragHorizontalDirection();return this.floating&&n?"right"===n&&i||"left"===n&&!i:s&&("down"===s&&e||"up"===s&&!e)},_getDragVerticalDirection:function(){var t=this.positionAbs.top-this.lastPositionAbs.top;return 0!==t&&(t>0?"down":"up")},_getDragHorizontalDirection:function(){var t=this.positionAbs.left-this.lastPositionAbs.left;return 0!==t&&(t>0?"right":"left")},refresh:function(t){return this._refreshItems(t),this._setHandleClassName(),this.refreshPositions(),this},_connectWith:function(){var t=this.options;return t.connectWith.constructor===String?[t.connectWith]:t.connectWith},_getItemsAsjQuery:function(e){function i(){r.push(this)}var s,n,o,a,r=[],l=[],h=this._connectWith();if (h&&e)for(s=h.length-1;s>=0;s--)for(o=t(h[s],this.document[0]),n=o.length-1;n>=0;n--)a=t.data(o[n],this.widgetFullName),a&&a!==this&&!a.options.disabled&&l.push([t.isFunction(a.options.items)?a.options.items.call(a.element):t(a.options.items,a.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),a]);for(l.push([t.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):t(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]),s=l.length-1;s>=0;s--)l[s][0].each(i);return t(r)},_removeCurrentsFromItems:function(){var e=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=t.grep(this.items,function(t){for(var i=0;e.length>i;i++)if (e[i]===t.item[0])return!1;return!0})},_refreshItems:function(e){this.items=[],this.containers=[this];var i,s,n,o,a,r,l,h,c=this.items,u=[[t.isFunction(this.options.items)?this.options.items.call(this.element[0],e,{item:this.currentItem}):t(this.options.items,this.element),this]],d=this._connectWith();if (d&&this.ready)for(i=d.length-1;i>=0;i--)for(n=t(d[i],this.document[0]),s=n.length-1;s>=0;s--)o=t.data(n[s],this.widgetFullName),o&&o!==this&&!o.options.disabled&&(u.push([t.isFunction(o.options.items)?o.options.items.call(o.element[0],e,{item:this.currentItem}):t(o.options.items,o.element),o]),this.containers.push(o));for(i=u.length-1;i>=0;i--)for(a=u[i][1],r=u[i][0],s=0,h=r.length;h>s;s++)l=t(r[s]),l.data(this.widgetName+"-item",a),c.push({item:l,instance:a,width:0,height:0,left:0,top:0})},refreshPositions:function(e){this.floating=this.items.length?"x"===this.options.axis||this._isFloating(this.items[0].item):!1,this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());var i,s,n,o;for(i=this.items.length-1;i>=0;i--)s=this.items[i],s.instance!==this.currentContainer&&this.currentContainer&&s.item[0]!==this.currentItem[0]||(n=this.options.toleranceElement?t(this.options.toleranceElement,s.item):s.item,e||(s.width=n.outerWidth(),s.height=n.outerHeight()),o=n.offset(),s.left=o.left,s.top=o.top);if (this.options.custom&&this.options.custom.refreshContainers)this.options.custom.refreshContainers.call(this);else for(i=this.containers.length-1;i>=0;i--)o=this.containers[i].element.offset(),this.containers[i].containerCache.left=o.left,this.containers[i].containerCache.top=o.top,this.containers[i].containerCache.width=this.containers[i].element.outerWidth(),this.containers[i].containerCache.height=this.containers[i].element.outerHeight();return this},_createPlaceholder:function(e){e=e||this;var i,s=e.options;s.placeholder&&s.placeholder.constructor!==String||(i=s.placeholder,s.placeholder={element:function(){var s=e.currentItem[0].nodeName.toLowerCase(),n=t("<"+s+">",e.document[0]);return e._addClass(n,"ui-sortable-placeholder",i||e.currentItem[0].className)._removeClass(n,"ui-sortable-helper"),"tbody"===s?e._createTrPlaceholder(e.currentItem.find("tr").eq(0),t("<tr>",e.document[0]).appendTo(n)):"tr"===s?e._createTrPlaceholder(e.currentItem,n):"img"===s&&n.attr("src",e.currentItem.attr("src")),i||n.css("visibility","hidden"),n},update:function(t,n){(!i||s.forcePlaceholderSize)&&(n.height()||n.height(e.currentItem.innerHeight()-parseInt(e.currentItem.css("paddingTop")||0,10)-parseInt(e.currentItem.css("paddingBottom")||0,10)),n.width()||n.width(e.currentItem.innerWidth()-parseInt(e.currentItem.css("paddingLeft")||0,10)-parseInt(e.currentItem.css("paddingRight")||0,10)))}}),e.placeholder=t(s.placeholder.element.call(e.element,e.currentItem)),e.currentItem.after(e.placeholder),s.placeholder.update(e,e.placeholder)},_createTrPlaceholder:function(e,i){var s=this;e.children().each(function(){t("<td>&#160;</td>",s.document[0]).attr("colspan",t(this).attr("colspan")||1).appendTo(i)})},_contactContainers:function(e){var i,s,n,o,a,r,l,h,c,u,d=null,p=null;for(i=this.containers.length-1;i>=0;i--)if (!t.contains(this.currentItem[0],this.containers[i].element[0]))if (this._intersectsWith(this.containers[i].containerCache)){if (d&&t.contains(this.containers[i].element[0],d.element[0]))continue;d=this.containers[i],p=i}else this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",e,this._uiHash(this)),this.containers[i].containerCache.over=0);if (d)if (1===this.containers.length)this.containers[p].containerCache.over||(this.containers[p]._trigger("over",e,this._uiHash(this)),this.containers[p].containerCache.over=1);else{for(n=1e4,o=null,c=d.floating||this._isFloating(this.currentItem),a=c?"left":"top",r=c?"width":"height",u=c?"pageX":"pageY",s=this.items.length-1;s>=0;s--)t.contains(this.containers[p].element[0],this.items[s].item[0])&&this.items[s].item[0]!==this.currentItem[0]&&(l=this.items[s].item.offset()[a],h=!1,e[u]-l>this.items[s][r]/2&&(h=!0),n>Math.abs(e[u]-l)&&(n=Math.abs(e[u]-l),o=this.items[s],this.direction=h?"up":"down"));if (!o&&!this.options.dropOnEmpty)return;if (this.currentContainer===this.containers[p])return this.currentContainer.containerCache.over||(this.containers[p]._trigger("over",e,this._uiHash()),this.currentContainer.containerCache.over=1),void 0;o?this._rearrange(e,o,null,!0):this._rearrange(e,null,this.containers[p].element,!0),this._trigger("change",e,this._uiHash()),this.containers[p]._trigger("change",e,this._uiHash(this)),this.currentContainer=this.containers[p],this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[p]._trigger("over",e,this._uiHash(this)),this.containers[p].containerCache.over=1}},_createHelper:function(e){var i=this.options,s=t.isFunction(i.helper)?t(i.helper.apply(this.element[0],[e,this.currentItem])):"clone"===i.helper?this.currentItem.clone():this.currentItem;return s.parents("body").length||t("parent"!==i.appendTo?i.appendTo:this.currentItem[0].parentNode)[0].appendChild(s[0]),s[0]===this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(!s[0].style.width||i.forceHelperSize)&&s.width(this.currentItem.width()),(!s[0].style.height||i.forceHelperSize)&&s.height(this.currentItem.height()),s},_adjustOffsetFromHelper:function(e){"string"==typeof e&&(e=e.split(" ")),t.isArray(e)&&(e={left:+e[0],top:+e[1]||0}),"left"in e&&(this.offset.click.left=e.left+this.margins.left),"right"in e&&(this.offset.click.left=this.helperProportions.width-e.right+this.margins.left),"top"in e&&(this.offset.click.top=e.top+this.margins.top),"bottom"in e&&(this.offset.click.top=this.helperProportions.height-e.bottom+this.margins.top)},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var e=this.offsetParent.offset();return"absolute"===this.cssPosition&&this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])&&(e.left+=this.scrollParent.scrollLeft(),e.top+=this.scrollParent.scrollTop()),(this.offsetParent[0]===this.document[0].body||this.offsetParent[0].tagName&&"html"===this.offsetParent[0].tagName.toLowerCase()&&t.ui.ie)&&(e={top:0,left:0}),{top:e.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:e.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if ("relative"===this.cssPosition){var t=this.currentItem.position();return{top:t.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:t.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var e,i,s,n=this.options;"parent"===n.containment&&(n.containment=this.helper[0].parentNode),("document"===n.containment||"window"===n.containment)&&(this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,"document"===n.containment?this.document.width():this.window.width()-this.helperProportions.width-this.margins.left,("document"===n.containment?this.document.height()||document.body.parentNode.scrollHeight:this.window.height()||this.document[0].body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]),/^(document|window|parent)$/.test(n.containment)||(e=t(n.containment)[0],i=t(n.containment).offset(),s="hidden"!==t(e).css("overflow"),this.containment=[i.left+(parseInt(t(e).css("borderLeftWidth"),10)||0)+(parseInt(t(e).css("paddingLeft"),10)||0)-this.margins.left,i.top+(parseInt(t(e).css("borderTopWidth"),10)||0)+(parseInt(t(e).css("paddingTop"),10)||0)-this.margins.top,i.left+(s?Math.max(e.scrollWidth,e.offsetWidth):e.offsetWidth)-(parseInt(t(e).css("borderLeftWidth"),10)||0)-(parseInt(t(e).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,i.top+(s?Math.max(e.scrollHeight,e.offsetHeight):e.offsetHeight)-(parseInt(t(e).css("borderTopWidth"),10)||0)-(parseInt(t(e).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top])},_convertPositionTo:function(e,i){i||(i=this.position);var s="absolute"===e?1:-1,n="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,o=/(html|body)/i.test(n[0].tagName);return{top:i.top+this.offset.relative.top*s+this.offset.parent.top*s-("fixed"===this.cssPosition?-this.scrollParent.scrollTop():o?0:n.scrollTop())*s,left:i.left+this.offset.relative.left*s+this.offset.parent.left*s-("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():o?0:n.scrollLeft())*s}},_generatePosition:function(e){var i,s,n=this.options,o=e.pageX,a=e.pageY,r="absolute"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&t.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,l=/(html|body)/i.test(r[0].tagName);return"relative"!==this.cssPosition||this.scrollParent[0]!==this.document[0]&&this.scrollParent[0]!==this.offsetParent[0]||(this.offset.relative=this._getRelativeOffset()),this.originalPosition&&(this.containment&&(e.pageX-this.offset.click.left<this.containment[0]&&(o=this.containment[0]+this.offset.click.left),e.pageY-this.offset.click.top<this.containment[1]&&(a=this.containment[1]+this.offset.click.top),e.pageX-this.offset.click.left>this.containment[2]&&(o=this.containment[2]+this.offset.click.left),e.pageY-this.offset.click.top>this.containment[3]&&(a=this.containment[3]+this.offset.click.top)),n.grid&&(i=this.originalPageY+Math.round((a-this.originalPageY)/n.grid[1])*n.grid[1],a=this.containment?i-this.offset.click.top>=this.containment[1]&&i-this.offset.click.top<=this.containment[3]?i:i-this.offset.click.top>=this.containment[1]?i-n.grid[1]:i+n.grid[1]:i,s=this.originalPageX+Math.round((o-this.originalPageX)/n.grid[0])*n.grid[0],o=this.containment?s-this.offset.click.left>=this.containment[0]&&s-this.offset.click.left<=this.containment[2]?s:s-this.offset.click.left>=this.containment[0]?s-n.grid[0]:s+n.grid[0]:s)),{top:a-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+("fixed"===this.cssPosition?-this.scrollParent.scrollTop():l?0:r.scrollTop()),left:o-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+("fixed"===this.cssPosition?-this.scrollParent.scrollLeft():l?0:r.scrollLeft())}},_rearrange:function(t,e,i,s){i?i[0].appendChild(this.placeholder[0]):e.item[0].parentNode.insertBefore(this.placeholder[0],"down"===this.direction?e.item[0]:e.item[0].nextSibling),this.counter=this.counter?++this.counter:1;var n=this.counter;this._delay(function(){n===this.counter&&this.refreshPositions(!s)})},_clear:function(t,e){function i(t,e,i){return function(s){i._trigger(t,s,e._uiHash(e))}}this.reverting=!1;var s,n=[];if (!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null,this.helper[0]===this.currentItem[0]){for(s in this._storedCSS)("auto"===this._storedCSS[s]||"static"===this._storedCSS[s])&&(this._storedCSS[s]="");this.currentItem.css(this._storedCSS),this._removeClass(this.currentItem,"ui-sortable-helper")}else this.currentItem.show();for(this.fromOutside&&!e&&n.push(function(t){this._trigger("receive",t,this._uiHash(this.fromOutside))}),!this.fromOutside&&this.domPosition.prev===this.currentItem.prev().not(".ui-sortable-helper")[0]&&this.domPosition.parent===this.currentItem.parent()[0]||e||n.push(function(t){this._trigger("update",t,this._uiHash())}),this!==this.currentContainer&&(e||(n.push(function(t){this._trigger("remove",t,this._uiHash())}),n.push(function(t){return function(e){t._trigger("receive",e,this._uiHash(this))}}.call(this,this.currentContainer)),n.push(function(t){return function(e){t._trigger("update",e,this._uiHash(this))}}.call(this,this.currentContainer)))),s=this.containers.length-1;s>=0;s--)e||n.push(i("deactivate",this,this.containers[s])),this.containers[s].containerCache.over&&(n.push(i("out",this,this.containers[s])),this.containers[s].containerCache.over=0);if (this.storedCursor&&(this.document.find("body").css("cursor",this.storedCursor),this.storedStylesheet.remove()),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex","auto"===this._storedZIndex?"":this._storedZIndex),this.dragging=!1,e||this._trigger("beforeStop",t,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.cancelHelperRemoval||(this.helper[0]!==this.currentItem[0]&&this.helper.remove(),this.helper=null),!e){for(s=0;n.length>s;s++)n[s].call(this,t);this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!this.cancelHelperRemoval},_trigger:function(){t.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(e){var i=e||this;return{helper:i.helper,placeholder:i.placeholder||t([]),position:i.position,originalPosition:i.originalPosition,offset:i.positionAbs,item:i.currentItem,sender:e?e.element:null}}}),t.widget("ui.menu",{version:"1.12.1",defaultElement:"<ul>",delay:300,options:{icons:{submenu:"ui-icon-caret-1-e"},items:"> *",menus:"ul",position:{my:"left top",at:"right top"},role:"menu",blur:null,focus:null,select:null},_create:function(){this.activeMenu=this.element,this.mouseHandled=!1,this.element.uniqueId().attr({role:this.options.role,tabIndex:0}),this._addClass("ui-menu","ui-widget ui-widget-content"),this._on({"mousedown .ui-menu-item":function(t){t.preventDefault()},"click .ui-menu-item":function(e){var i=t(e.target),s=t(t.ui.safeActiveElement(this.document[0]));!this.mouseHandled&&i.not(".ui-state-disabled").length&&(this.select(e),e.isPropagationStopped()||(this.mouseHandled=!0),i.has(".ui-menu").length?this.expand(e):!this.element.is(":focus")&&s.closest(".ui-menu").length&&(this.element.trigger("focus",[!0]),this.active&&1===this.active.parents(".ui-menu").length&&clearTimeout(this.timer)))},"mouseenter .ui-menu-item":function(e){if (!this.previousFilter){var i=t(e.target).closest(".ui-menu-item"),s=t(e.currentTarget);i[0]===s[0]&&(this._removeClass(s.siblings().children(".ui-state-active"),null,"ui-state-active"),this.focus(e,s))}},mouseleave:"collapseAll","mouseleave .ui-menu":"collapseAll",focus:function(t,e){var i=this.active||this.element.find(this.options.items).eq(0);
e||this.focus(t,i)},blur:function(e){this._delay(function(){var i=!t.contains(this.element[0],t.ui.safeActiveElement(this.document[0]));i&&this.collapseAll(e)})},keydown:"_keydown"}),this.refresh(),this._on(this.document,{click:function(t){this._closeOnDocumentClick(t)&&this.collapseAll(t),this.mouseHandled=!1}})},_destroy:function(){var e=this.element.find(".ui-menu-item").removeAttr("role aria-disabled"),i=e.children(".ui-menu-item-wrapper").removeUniqueId().removeAttr("tabIndex role aria-haspopup");this.element.removeAttr("aria-activedescendant").find(".ui-menu").addBack().removeAttr("role aria-labelledby aria-expanded aria-hidden aria-disabled tabIndex").removeUniqueId().show(),i.children().each(function(){var e=t(this);e.data("ui-menu-submenu-caret")&&e.remove()})},_keydown:function(e){var i,s,n,o,a=!0;switch(e.keyCode){case t.ui.keyCode.PAGE_UP:this.previousPage(e);break;case t.ui.keyCode.PAGE_DOWN:this.nextPage(e);break;case t.ui.keyCode.HOME:this._move("first","first",e);break;case t.ui.keyCode.END:this._move("last","last",e);break;case t.ui.keyCode.UP:this.previous(e);break;case t.ui.keyCode.DOWN:this.next(e);break;case t.ui.keyCode.LEFT:this.collapse(e);break;case t.ui.keyCode.RIGHT:this.active&&!this.active.is(".ui-state-disabled")&&this.expand(e);break;case t.ui.keyCode.ENTER:case t.ui.keyCode.SPACE:this._activate(e);break;case t.ui.keyCode.ESCAPE:this.collapse(e);break;default:a=!1,s=this.previousFilter||"",o=!1,n=e.keyCode>=96&&105>=e.keyCode?""+(e.keyCode-96):String.fromCharCode(e.keyCode),clearTimeout(this.filterTimer),n===s?o=!0:n=s+n,i=this._filterMenuItems(n),i=o&&-1!==i.index(this.active.next())?this.active.nextAll(".ui-menu-item"):i,i.length||(n=String.fromCharCode(e.keyCode),i=this._filterMenuItems(n)),i.length?(this.focus(e,i),this.previousFilter=n,this.filterTimer=this._delay(function(){delete this.previousFilter},1e3)):delete this.previousFilter}a&&e.preventDefault()},_activate:function(t){this.active&&!this.active.is(".ui-state-disabled")&&(this.active.children("[aria-haspopup='true']").length?this.expand(t):this.select(t))},refresh:function(){var e,i,s,n,o,a=this,r=this.options.icons.submenu,l=this.element.find(this.options.menus);this._toggleClass("ui-menu-icons",null,!!this.element.find(".ui-icon").length),s=l.filter(":not(.ui-menu)").hide().attr({role:this.options.role,"aria-hidden":"true","aria-expanded":"false"}).each(function(){var e=t(this),i=e.prev(),s=t("<span>").data("ui-menu-submenu-caret",!0);a._addClass(s,"ui-menu-icon","ui-icon "+r),i.attr("aria-haspopup","true").prepend(s),e.attr("aria-labelledby",i.attr("id"))}),this._addClass(s,"ui-menu","ui-widget ui-widget-content ui-front"),e=l.add(this.element),i=e.find(this.options.items),i.not(".ui-menu-item").each(function(){var e=t(this);a._isDivider(e)&&a._addClass(e,"ui-menu-divider","ui-widget-content")}),n=i.not(".ui-menu-item, .ui-menu-divider"),o=n.children().not(".ui-menu").uniqueId().attr({tabIndex:-1,role:this._itemRole()}),this._addClass(n,"ui-menu-item")._addClass(o,"ui-menu-item-wrapper"),i.filter(".ui-state-disabled").attr("aria-disabled","true"),this.active&&!t.contains(this.element[0],this.active[0])&&this.blur()},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},_setOption:function(t,e){if ("icons"===t){var i=this.element.find(".ui-menu-icon");this._removeClass(i,null,this.options.icons.submenu)._addClass(i,null,e.submenu)}this._super(t,e)},_setOptionDisabled:function(t){this._super(t),this.element.attr("aria-disabled",t+""),this._toggleClass(null,"ui-state-disabled",!!t)},focus:function(t,e){var i,s,n;this.blur(t,t&&"focus"===t.type),this._scrollIntoView(e),this.active=e.first(),s=this.active.children(".ui-menu-item-wrapper"),this._addClass(s,null,"ui-state-active"),this.options.role&&this.element.attr("aria-activedescendant",s.attr("id")),n=this.active.parent().closest(".ui-menu-item").children(".ui-menu-item-wrapper"),this._addClass(n,null,"ui-state-active"),t&&"keydown"===t.type?this._close():this.timer=this._delay(function(){this._close()},this.delay),i=e.children(".ui-menu"),i.length&&t&&/^mouse/.test(t.type)&&this._startOpening(i),this.activeMenu=e.parent(),this._trigger("focus",t,{item:e})},_scrollIntoView:function(e){var i,s,n,o,a,r;this._hasScroll()&&(i=parseFloat(t.css(this.activeMenu[0],"borderTopWidth"))||0,s=parseFloat(t.css(this.activeMenu[0],"paddingTop"))||0,n=e.offset().top-this.activeMenu.offset().top-i-s,o=this.activeMenu.scrollTop(),a=this.activeMenu.height(),r=e.outerHeight(),0>n?this.activeMenu.scrollTop(o+n):n+r>a&&this.activeMenu.scrollTop(o+n-a+r))},blur:function(t,e){e||clearTimeout(this.timer),this.active&&(this._removeClass(this.active.children(".ui-menu-item-wrapper"),null,"ui-state-active"),this._trigger("blur",t,{item:this.active}),this.active=null)},_startOpening:function(t){clearTimeout(this.timer),"true"===t.attr("aria-hidden")&&(this.timer=this._delay(function(){this._close(),this._open(t)},this.delay))},_open:function(e){var i=t.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find(".ui-menu").not(e.parents(".ui-menu")).hide().attr("aria-hidden","true"),e.show().removeAttr("aria-hidden").attr("aria-expanded","true").position(i)},collapseAll:function(e,i){clearTimeout(this.timer),this.timer=this._delay(function(){var s=i?this.element:t(e&&e.target).closest(this.element.find(".ui-menu"));s.length||(s=this.element),this._close(s),this.blur(e),this._removeClass(s.find(".ui-state-active"),null,"ui-state-active"),this.activeMenu=s},this.delay)},_close:function(t){t||(t=this.active?this.active.parent():this.element),t.find(".ui-menu").hide().attr("aria-hidden","true").attr("aria-expanded","false")},_closeOnDocumentClick:function(e){return!t(e.target).closest(".ui-menu").length},_isDivider:function(t){return!/[^\-\u2014\u2013\s]/.test(t.text())},collapse:function(t){var e=this.active&&this.active.parent().closest(".ui-menu-item",this.element);e&&e.length&&(this._close(),this.focus(t,e))},expand:function(t){var e=this.active&&this.active.children(".ui-menu ").find(this.options.items).first();e&&e.length&&(this._open(e.parent()),this._delay(function(){this.focus(t,e)}))},next:function(t){this._move("next","first",t)},previous:function(t){this._move("prev","last",t)},isFirstItem:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length},isLastItem:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},_move:function(t,e,i){var s;this.active&&(s="first"===t||"last"===t?this.active["first"===t?"prevAll":"nextAll"](".ui-menu-item").eq(-1):this.active[t+"All"](".ui-menu-item").eq(0)),s&&s.length&&this.active||(s=this.activeMenu.find(this.options.items)[e]()),this.focus(i,s)},nextPage:function(e){var i,s,n;return this.active?(this.isLastItem()||(this._hasScroll()?(s=this.active.offset().top,n=this.element.height(),this.active.nextAll(".ui-menu-item").each(function(){return i=t(this),0>i.offset().top-s-n}),this.focus(e,i)):this.focus(e,this.activeMenu.find(this.options.items)[this.active?"last":"first"]())),void 0):(this.next(e),void 0)},previousPage:function(e){var i,s,n;return this.active?(this.isFirstItem()||(this._hasScroll()?(s=this.active.offset().top,n=this.element.height(),this.active.prevAll(".ui-menu-item").each(function(){return i=t(this),i.offset().top-s+n>0}),this.focus(e,i)):this.focus(e,this.activeMenu.find(this.options.items).first())),void 0):(this.next(e),void 0)},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")},select:function(e){this.active=this.active||t(e.target).closest(".ui-menu-item");var i={item:this.active};this.active.has(".ui-menu").length||this.collapseAll(e,!0),this._trigger("select",e,i)},_filterMenuItems:function(e){var i=e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),s=RegExp("^"+i,"i");return this.activeMenu.find(this.options.items).filter(".ui-menu-item").filter(function(){return s.test(t.trim(t(this).children(".ui-menu-item-wrapper").text()))})}}),t.widget("ui.autocomplete",{version:"1.12.1",defaultElement:"<input>",options:{appendTo:null,autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null,change:null,close:null,focus:null,open:null,response:null,search:null,select:null},requestIndex:0,pending:0,_create:function(){var e,i,s,n=this.element[0].nodeName.toLowerCase(),o="textarea"===n,a="input"===n;this.isMultiLine=o||!a&&this._isContentEditable(this.element),this.valueMethod=this.element[o||a?"val":"text"],this.isNewMenu=!0,this._addClass("ui-autocomplete-input"),this.element.attr("autocomplete","off"),this._on(this.element,{keydown:function(n){if (this.element.prop("readOnly"))return e=!0,s=!0,i=!0,void 0;e=!1,s=!1,i=!1;var o=t.ui.keyCode;switch(n.keyCode){case o.PAGE_UP:e=!0,this._move("previousPage",n);break;case o.PAGE_DOWN:e=!0,this._move("nextPage",n);break;case o.UP:e=!0,this._keyEvent("previous",n);break;case o.DOWN:e=!0,this._keyEvent("next",n);break;case o.ENTER:this.menu.active&&(e=!0,n.preventDefault(),this.menu.select(n));break;case o.TAB:this.menu.active&&this.menu.select(n);break;case o.ESCAPE:this.menu.element.is(":visible")&&(this.isMultiLine||this._value(this.term),this.close(n),n.preventDefault());break;default:i=!0,this._searchTimeout(n)}},keypress:function(s){if (e)return e=!1,(!this.isMultiLine||this.menu.element.is(":visible"))&&s.preventDefault(),void 0;if (!i){var n=t.ui.keyCode;switch(s.keyCode){case n.PAGE_UP:this._move("previousPage",s);break;case n.PAGE_DOWN:this._move("nextPage",s);break;case n.UP:this._keyEvent("previous",s);break;case n.DOWN:this._keyEvent("next",s)}}},input:function(t){return s?(s=!1,t.preventDefault(),void 0):(this._searchTimeout(t),void 0)},focus:function(){this.selectedItem=null,this.previous=this._value()},blur:function(t){return this.cancelBlur?(delete this.cancelBlur,void 0):(clearTimeout(this.searching),this.close(t),this._change(t),void 0)}}),this._initSource(),this.menu=t("<ul>").appendTo(this._appendTo()).menu({role:null}).hide().menu("instance"),this._addClass(this.menu.element,"ui-autocomplete","ui-front"),this._on(this.menu.element,{mousedown:function(e){e.preventDefault(),this.cancelBlur=!0,this._delay(function(){delete this.cancelBlur,this.element[0]!==t.ui.safeActiveElement(this.document[0])&&this.element.trigger("focus")})},menufocus:function(e,i){var s,n;return this.isNewMenu&&(this.isNewMenu=!1,e.originalEvent&&/^mouse/.test(e.originalEvent.type))?(this.menu.blur(),this.document.one("mousemove",function(){t(e.target).trigger(e.originalEvent)}),void 0):(n=i.item.data("ui-autocomplete-item"),!1!==this._trigger("focus",e,{item:n})&&e.originalEvent&&/^key/.test(e.originalEvent.type)&&this._value(n.value),s=i.item.attr("aria-label")||n.value,s&&t.trim(s).length&&(this.liveRegion.children().hide(),t("<div>").text(s).appendTo(this.liveRegion)),void 0)},menuselect:function(e,i){var s=i.item.data("ui-autocomplete-item"),n=this.previous;this.element[0]!==t.ui.safeActiveElement(this.document[0])&&(this.element.trigger("focus"),this.previous=n,this._delay(function(){this.previous=n,this.selectedItem=s})),!1!==this._trigger("select",e,{item:s})&&this._value(s.value),this.term=this._value(),this.close(e),this.selectedItem=s}}),this.liveRegion=t("<div>",{role:"status","aria-live":"assertive","aria-relevant":"additions"}).appendTo(this.document[0].body),this._addClass(this.liveRegion,null,"ui-helper-hidden-accessible"),this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_destroy:function(){clearTimeout(this.searching),this.element.removeAttr("autocomplete"),this.menu.element.remove(),this.liveRegion.remove()},_setOption:function(t,e){this._super(t,e),"source"===t&&this._initSource(),"appendTo"===t&&this.menu.element.appendTo(this._appendTo()),"disabled"===t&&e&&this.xhr&&this.xhr.abort()},_isEventTargetInWidget:function(e){var i=this.menu.element[0];return e.target===this.element[0]||e.target===i||t.contains(i,e.target)},_closeOnClickOutside:function(t){this._isEventTargetInWidget(t)||this.close()},_appendTo:function(){var e=this.options.appendTo;return e&&(e=e.jquery||e.nodeType?t(e):this.document.find(e).eq(0)),e&&e[0]||(e=this.element.closest(".ui-front, dialog")),e.length||(e=this.document[0].body),e},_initSource:function(){var e,i,s=this;t.isArray(this.options.source)?(e=this.options.source,this.source=function(i,s){s(t.ui.autocomplete.filter(e,i.term))}):"string"==typeof this.options.source?(i=this.options.source,this.source=function(e,n){s.xhr&&s.xhr.abort(),s.xhr=t.ajax({url:i,data:e,dataType:"json",success:function(t){n(t)},error:function(){n([])}})}):this.source=this.options.source},_searchTimeout:function(t){clearTimeout(this.searching),this.searching=this._delay(function(){var e=this.term===this._value(),i=this.menu.element.is(":visible"),s=t.altKey||t.ctrlKey||t.metaKey||t.shiftKey;(!e||e&&!i&&!s)&&(this.selectedItem=null,this.search(null,t))},this.options.delay)},search:function(t,e){return t=null!=t?t:this._value(),this.term=this._value(),t.length<this.options.minLength?this.close(e):this._trigger("search",e)!==!1?this._search(t):void 0},_search:function(t){this.pending++,this._addClass("ui-autocomplete-loading"),this.cancelSearch=!1,this.source({term:t},this._response())},_response:function(){var e=++this.requestIndex;return t.proxy(function(t){e===this.requestIndex&&this.__response(t),this.pending--,this.pending||this._removeClass("ui-autocomplete-loading")},this)},__response:function(t){t&&(t=this._normalize(t)),this._trigger("response",null,{content:t}),!this.options.disabled&&t&&t.length&&!this.cancelSearch?(this._suggest(t),this._trigger("open")):this._close()},close:function(t){this.cancelSearch=!0,this._close(t)},_close:function(t){this._off(this.document,"mousedown"),this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.blur(),this.isNewMenu=!0,this._trigger("close",t))},_change:function(t){this.previous!==this._value()&&this._trigger("change",t,{item:this.selectedItem})},_normalize:function(e){return e.length&&e[0].label&&e[0].value?e:t.map(e,function(e){return"string"==typeof e?{label:e,value:e}:t.extend({},e,{label:e.label||e.value,value:e.value||e.label})})},_suggest:function(e){var i=this.menu.element.empty();this._renderMenu(i,e),this.isNewMenu=!0,this.menu.refresh(),i.show(),this._resizeMenu(),i.position(t.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next(),this._on(this.document,{mousedown:"_closeOnClickOutside"})},_resizeMenu:function(){var t=this.menu.element;t.outerWidth(Math.max(t.width("").outerWidth()+1,this.element.outerWidth()))},_renderMenu:function(e,i){var s=this;t.each(i,function(t,i){s._renderItemData(e,i)})},_renderItemData:function(t,e){return this._renderItem(t,e).data("ui-autocomplete-item",e)},_renderItem:function(e,i){return t("<li>").append(t("<div>").text(i.label)).appendTo(e)},_move:function(t,e){return this.menu.element.is(":visible")?this.menu.isFirstItem()&&/^previous/.test(t)||this.menu.isLastItem()&&/^next/.test(t)?(this.isMultiLine||this._value(this.term),this.menu.blur(),void 0):(this.menu[t](e),void 0):(this.search(null,e),void 0)},widget:function(){return this.menu.element},_value:function(){return this.valueMethod.apply(this.element,arguments)},_keyEvent:function(t,e){(!this.isMultiLine||this.menu.element.is(":visible"))&&(this._move(t,e),e.preventDefault())},_isContentEditable:function(t){if (!t.length)return!1;var e=t.prop("contentEditable");return"inherit"===e?this._isContentEditable(t.parent()):"true"===e}}),t.extend(t.ui.autocomplete,{escapeRegex:function(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")},filter:function(e,i){var s=RegExp(t.ui.autocomplete.escapeRegex(i),"i");return t.grep(e,function(t){return s.test(t.label||t.value||t)})}}),t.widget("ui.autocomplete",t.ui.autocomplete,{options:{messages:{noResults:"No search results.",results:function(t){return t+(t>1?" results are":" result is")+" available, use up and down arrow keys to navigate."}}},__response:function(e){var i;this._superApply(arguments),this.options.disabled||this.cancelSearch||(i=e&&e.length?this.options.messages.results(e.length):this.options.messages.noResults,this.liveRegion.children().hide(),t("<div>").text(i).appendTo(this.liveRegion))}}),t.ui.autocomplete,t.extend(t.ui,{datepicker:{version:"1.12.1"}});var u;t.extend(s.prototype,{markerClassName:"hasDatepicker",maxRows:4,_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(t){return a(this._defaults,t||{}),this},_attachDatepicker:function(e,i){var s,n,o;s=e.nodeName.toLowerCase(),n="div"===s||"span"===s,e.id||(this.uuid+=1,e.id="dp"+this.uuid),o=this._newInst(t(e),n),o.settings=t.extend({},i||{}),"input"===s?this._connectDatepicker(e,o):n&&this._inlineDatepicker(e,o)},_newInst:function(e,i){var s=e[0].id.replace(/([^A-Za-z0-9_\-])/g,"\\\\$1");return{id:s,input:e,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:i,dpDiv:i?n(t("<div class='"+this._inlineClass+" ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>")):this.dpDiv}},_connectDatepicker:function(e,i){var s=t(e);i.append=t([]),i.trigger=t([]),s.hasClass(this.markerClassName)||(this._attachments(s,i),s.addClass(this.markerClassName).on("keydown",this._doKeyDown).on("keypress",this._doKeyPress).on("keyup",this._doKeyUp),this._autoSize(i),t.data(e,"datepicker",i),i.settings.disabled&&this._disableDatepicker(e))},_attachments:function(e,i){var s,n,o,a=this._get(i,"appendText"),r=this._get(i,"isRTL");i.append&&i.append.remove(),a&&(i.append=t("<span class='"+this._appendClass+"'>"+a+"</span>"),e[r?"before":"after"](i.append)),e.off("focus",this._showDatepicker),i.trigger&&i.trigger.remove(),s=this._get(i,"showOn"),("focus"===s||"both"===s)&&e.on("focus",this._showDatepicker),("button"===s||"both"===s)&&(n=this._get(i,"buttonText"),o=this._get(i,"buttonImage"),i.trigger=t(this._get(i,"buttonImageOnly")?t("<img/>").addClass(this._triggerClass).attr({src:o,alt:n,title:n}):t("<button type='button'></button>").addClass(this._triggerClass).html(o?t("<img/>").attr({src:o,alt:n,title:n}):n)),e[r?"before":"after"](i.trigger),i.trigger.on("click",function(){return t.datepicker._datepickerShowing&&t.datepicker._lastInput===e[0]?t.datepicker._hideDatepicker():t.datepicker._datepickerShowing&&t.datepicker._lastInput!==e[0]?(t.datepicker._hideDatepicker(),t.datepicker._showDatepicker(e[0])):t.datepicker._showDatepicker(e[0]),!1}))},_autoSize:function(t){if (this._get(t,"autoSize")&&!t.inline){var e,i,s,n,o=new Date(2009,11,20),a=this._get(t,"dateFormat");a.match(/[DM]/)&&(e=function(t){for(i=0,s=0,n=0;t.length>n;n++)t[n].length>i&&(i=t[n].length,s=n);return s},o.setMonth(e(this._get(t,a.match(/MM/)?"monthNames":"monthNamesShort"))),o.setDate(e(this._get(t,a.match(/DD/)?"dayNames":"dayNamesShort"))+20-o.getDay())),t.input.attr("size",this._formatDate(t,o).length)}},_inlineDatepicker:function(e,i){var s=t(e);s.hasClass(this.markerClassName)||(s.addClass(this.markerClassName).append(i.dpDiv),t.data(e,"datepicker",i),this._setDate(i,this._getDefaultDate(i),!0),this._updateDatepicker(i),this._updateAlternate(i),i.settings.disabled&&this._disableDatepicker(e),i.dpDiv.css("display","block"))},_dialogDatepicker:function(e,i,s,n,o){var r,l,h,c,u,d=this._dialogInst;return d||(this.uuid+=1,r="dp"+this.uuid,this._dialogInput=t("<input type='text' id='"+r+"' style='position: absolute; top: -100px; width: 0px;'/>"),this._dialogInput.on("keydown",this._doKeyDown),t("body").append(this._dialogInput),d=this._dialogInst=this._newInst(this._dialogInput,!1),d.settings={},t.data(this._dialogInput[0],"datepicker",d)),a(d.settings,n||{}),i=i&&i.constructor===Date?this._formatDate(d,i):i,this._dialogInput.val(i),this._pos=o?o.length?o:[o.pageX,o.pageY]:null,this._pos||(l=document.documentElement.clientWidth,h=document.documentElement.clientHeight,c=document.documentElement.scrollLeft||document.body.scrollLeft,u=document.documentElement.scrollTop||document.body.scrollTop,this._pos=[l/2-100+c,h/2-150+u]),this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),d.settings.onSelect=s,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),t.blockUI&&t.blockUI(this.dpDiv),t.data(this._dialogInput[0],"datepicker",d),this},_destroyDatepicker:function(e){var i,s=t(e),n=t.data(e,"datepicker");s.hasClass(this.markerClassName)&&(i=e.nodeName.toLowerCase(),t.removeData(e,"datepicker"),"input"===i?(n.append.remove(),n.trigger.remove(),s.removeClass(this.markerClassName).off("focus",this._showDatepicker).off("keydown",this._doKeyDown).off("keypress",this._doKeyPress).off("keyup",this._doKeyUp)):("div"===i||"span"===i)&&s.removeClass(this.markerClassName).empty(),u===n&&(u=null))},_enableDatepicker:function(e){var i,s,n=t(e),o=t.data(e,"datepicker");n.hasClass(this.markerClassName)&&(i=e.nodeName.toLowerCase(),"input"===i?(e.disabled=!1,o.trigger.filter("button").each(function(){this.disabled=!1}).end().filter("img").css({opacity:"1.0",cursor:""})):("div"===i||"span"===i)&&(s=n.children("."+this._inlineClass),s.children().removeClass("ui-state-disabled"),s.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!1)),this._disabledInputs=t.map(this._disabledInputs,function(t){return t===e?null:t}))},_disableDatepicker:function(e){var i,s,n=t(e),o=t.data(e,"datepicker");n.hasClass(this.markerClassName)&&(i=e.nodeName.toLowerCase(),"input"===i?(e.disabled=!0,o.trigger.filter("button").each(function(){this.disabled=!0}).end().filter("img").css({opacity:"0.5",cursor:"default"})):("div"===i||"span"===i)&&(s=n.children("."+this._inlineClass),s.children().addClass("ui-state-disabled"),s.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!0)),this._disabledInputs=t.map(this._disabledInputs,function(t){return t===e?null:t}),this._disabledInputs[this._disabledInputs.length]=e)},_isDisabledDatepicker:function(t){if (!t)return!1;for(var e=0;this._disabledInputs.length>e;e++)if (this._disabledInputs[e]===t)return!0;return!1},_getInst:function(e){try{return t.data(e,"datepicker")}catch(i){throw"Missing instance data for this datepicker"}},_optionDatepicker:function(e,i,s){var n,o,r,l,h=this._getInst(e);return 2===arguments.length&&"string"==typeof i?"defaults"===i?t.extend({},t.datepicker._defaults):h?"all"===i?t.extend({},h.settings):this._get(h,i):null:(n=i||{},"string"==typeof i&&(n={},n[i]=s),h&&(this._curInst===h&&this._hideDatepicker(),o=this._getDateDatepicker(e,!0),r=this._getMinMaxDate(h,"min"),l=this._getMinMaxDate(h,"max"),a(h.settings,n),null!==r&&void 0!==n.dateFormat&&void 0===n.minDate&&(h.settings.minDate=this._formatDate(h,r)),null!==l&&void 0!==n.dateFormat&&void 0===n.maxDate&&(h.settings.maxDate=this._formatDate(h,l)),"disabled"in n&&(n.disabled?this._disableDatepicker(e):this._enableDatepicker(e)),this._attachments(t(e),h),this._autoSize(h),this._setDate(h,o),this._updateAlternate(h),this._updateDatepicker(h)),void 0)},_changeDatepicker:function(t,e,i){this._optionDatepicker(t,e,i)},_refreshDatepicker:function(t){var e=this._getInst(t);e&&this._updateDatepicker(e)},_setDateDatepicker:function(t,e){var i=this._getInst(t);i&&(this._setDate(i,e),this._updateDatepicker(i),this._updateAlternate(i))},_getDateDatepicker:function(t,e){var i=this._getInst(t);return i&&!i.inline&&this._setDateFromField(i,e),i?this._getDate(i):null},_doKeyDown:function(e){var i,s,n,o=t.datepicker._getInst(e.target),a=!0,r=o.dpDiv.is(".ui-datepicker-rtl");if (o._keyEvent=!0,t.datepicker._datepickerShowing)switch(e.keyCode){case 9:t.datepicker._hideDatepicker(),a=!1;break;case 13:return n=t("td."+t.datepicker._dayOverClass+":not(."+t.datepicker._currentClass+")",o.dpDiv),n[0]&&t.datepicker._selectDay(e.target,o.selectedMonth,o.selectedYear,n[0]),i=t.datepicker._get(o,"onSelect"),i?(s=t.datepicker._formatDate(o),i.apply(o.input?o.input[0]:null,[s,o])):t.datepicker._hideDatepicker(),!1;case 27:t.datepicker._hideDatepicker();break;case 33:t.datepicker._adjustDate(e.target,e.ctrlKey?-t.datepicker._get(o,"stepBigMonths"):-t.datepicker._get(o,"stepMonths"),"M");break;case 34:t.datepicker._adjustDate(e.target,e.ctrlKey?+t.datepicker._get(o,"stepBigMonths"):+t.datepicker._get(o,"stepMonths"),"M");break;case 35:(e.ctrlKey||e.metaKey)&&t.datepicker._clearDate(e.target),a=e.ctrlKey||e.metaKey;break;case 36:(e.ctrlKey||e.metaKey)&&t.datepicker._gotoToday(e.target),a=e.ctrlKey||e.metaKey;break;case 37:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,r?1:-1,"D"),a=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&t.datepicker._adjustDate(e.target,e.ctrlKey?-t.datepicker._get(o,"stepBigMonths"):-t.datepicker._get(o,"stepMonths"),"M");break;case 38:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,-7,"D"),a=e.ctrlKey||e.metaKey;break;case 39:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,r?-1:1,"D"),a=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&t.datepicker._adjustDate(e.target,e.ctrlKey?+t.datepicker._get(o,"stepBigMonths"):+t.datepicker._get(o,"stepMonths"),"M");break;case 40:(e.ctrlKey||e.metaKey)&&t.datepicker._adjustDate(e.target,7,"D"),a=e.ctrlKey||e.metaKey;break;default:a=!1}else 36===e.keyCode&&e.ctrlKey?t.datepicker._showDatepicker(this):a=!1;a&&(e.preventDefault(),e.stopPropagation())},_doKeyPress:function(e){var i,s,n=t.datepicker._getInst(e.target);return t.datepicker._get(n,"constrainInput")?(i=t.datepicker._possibleChars(t.datepicker._get(n,"dateFormat")),s=String.fromCharCode(null==e.charCode?e.keyCode:e.charCode),e.ctrlKey||e.metaKey||" ">s||!i||i.indexOf(s)>-1):void 0},_doKeyUp:function(e){var i,s=t.datepicker._getInst(e.target);if (s.input.val()!==s.lastVal)try{i=t.datepicker.parseDate(t.datepicker._get(s,"dateFormat"),s.input?s.input.val():null,t.datepicker._getFormatConfig(s)),i&&(t.datepicker._setDateFromField(s),t.datepicker._updateAlternate(s),t.datepicker._updateDatepicker(s))}catch(n){}return!0},_showDatepicker:function(e){if (e=e.target||e,"input"!==e.nodeName.toLowerCase()&&(e=t("input",e.parentNode)[0]),!t.datepicker._isDisabledDatepicker(e)&&t.datepicker._lastInput!==e){var s,n,o,r,l,h,c;s=t.datepicker._getInst(e),t.datepicker._curInst&&t.datepicker._curInst!==s&&(t.datepicker._curInst.dpDiv.stop(!0,!0),s&&t.datepicker._datepickerShowing&&t.datepicker._hideDatepicker(t.datepicker._curInst.input[0])),n=t.datepicker._get(s,"beforeShow"),o=n?n.apply(e,[e,s]):{},o!==!1&&(a(s.settings,o),s.lastVal=null,t.datepicker._lastInput=e,t.datepicker._setDateFromField(s),t.datepicker._inDialog&&(e.value=""),t.datepicker._pos||(t.datepicker._pos=t.datepicker._findPos(e),t.datepicker._pos[1]+=e.offsetHeight),r=!1,t(e).parents().each(function(){return r|="fixed"===t(this).css("position"),!r}),l={left:t.datepicker._pos[0],top:t.datepicker._pos[1]},t.datepicker._pos=null,s.dpDiv.empty(),s.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),t.datepicker._updateDatepicker(s),l=t.datepicker._checkOffset(s,l,r),s.dpDiv.css({position:t.datepicker._inDialog&&t.blockUI?"static":r?"fixed":"absolute",display:"none",left:l.left+"px",top:l.top+"px"}),s.inline||(h=t.datepicker._get(s,"showAnim"),c=t.datepicker._get(s,"duration"),s.dpDiv.css("z-index",i(t(e))+1),t.datepicker._datepickerShowing=!0,t.effects&&t.effects.effect[h]?s.dpDiv.show(h,t.datepicker._get(s,"showOptions"),c):s.dpDiv[h||"show"](h?c:null),t.datepicker._shouldFocusInput(s)&&s.input.trigger("focus"),t.datepicker._curInst=s))}},_updateDatepicker:function(e){this.maxRows=4,u=e,e.dpDiv.empty().append(this._generateHTML(e)),this._attachHandlers(e);var i,s=this._getNumberOfMonths(e),n=s[1],a=17,r=e.dpDiv.find("."+this._dayOverClass+" a");r.length>0&&o.apply(r.get(0)),e.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),n>1&&e.dpDiv.addClass("ui-datepicker-multi-"+n).css("width",a*n+"em"),e.dpDiv[(1!==s[0]||1!==s[1]?"add":"remove")+"Class"]("ui-datepicker-multi"),e.dpDiv[(this._get(e,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),e===t.datepicker._curInst&&t.datepicker._datepickerShowing&&t.datepicker._shouldFocusInput(e)&&e.input.trigger("focus"),e.yearshtml&&(i=e.yearshtml,setTimeout(function(){i===e.yearshtml&&e.yearshtml&&e.dpDiv.find("select.ui-datepicker-year:first").replaceWith(e.yearshtml),i=e.yearshtml=null},0))},_shouldFocusInput:function(t){return t.input&&t.input.is(":visible")&&!t.input.is(":disabled")&&!t.input.is(":focus")},_checkOffset:function(e,i,s){var n=e.dpDiv.outerWidth(),o=e.dpDiv.outerHeight(),a=e.input?e.input.outerWidth():0,r=e.input?e.input.outerHeight():0,l=document.documentElement.clientWidth+(s?0:t(document).scrollLeft()),h=document.documentElement.clientHeight+(s?0:t(document).scrollTop());return i.left-=this._get(e,"isRTL")?n-a:0,i.left-=s&&i.left===e.input.offset().left?t(document).scrollLeft():0,i.top-=s&&i.top===e.input.offset().top+r?t(document).scrollTop():0,i.left-=Math.min(i.left,i.left+n>l&&l>n?Math.abs(i.left+n-l):0),i.top-=Math.min(i.top,i.top+o>h&&h>o?Math.abs(o+r):0),i},_findPos:function(e){for(var i,s=this._getInst(e),n=this._get(s,"isRTL");e&&("hidden"===e.type||1!==e.nodeType||t.expr.filters.hidden(e));)e=e[n?"previousSibling":"nextSibling"];return i=t(e).offset(),[i.left,i.top]},_hideDatepicker:function(e){var i,s,n,o,a=this._curInst;!a||e&&a!==t.data(e,"datepicker")||this._datepickerShowing&&(i=this._get(a,"showAnim"),s=this._get(a,"duration"),n=function(){t.datepicker._tidyDialog(a)},t.effects&&(t.effects.effect[i]||t.effects[i])?a.dpDiv.hide(i,t.datepicker._get(a,"showOptions"),s,n):a.dpDiv["slideDown"===i?"slideUp":"fadeIn"===i?"fadeOut":"hide"](i?s:null,n),i||n(),this._datepickerShowing=!1,o=this._get(a,"onClose"),o&&o.apply(a.input?a.input[0]:null,[a.input?a.input.val():"",a]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),t.blockUI&&(t.unblockUI(),t("body").append(this.dpDiv))),this._inDialog=!1)},_tidyDialog:function(t){t.dpDiv.removeClass(this._dialogClass).off(".ui-datepicker-calendar")},_checkExternalClick:function(e){if (t.datepicker._curInst){var i=t(e.target),s=t.datepicker._getInst(i[0]);(i[0].id!==t.datepicker._mainDivId&&0===i.parents("#"+t.datepicker._mainDivId).length&&!i.hasClass(t.datepicker.markerClassName)&&!i.closest("."+t.datepicker._triggerClass).length&&t.datepicker._datepickerShowing&&(!t.datepicker._inDialog||!t.blockUI)||i.hasClass(t.datepicker.markerClassName)&&t.datepicker._curInst!==s)&&t.datepicker._hideDatepicker()}},_adjustDate:function(e,i,s){var n=t(e),o=this._getInst(n[0]);this._isDisabledDatepicker(n[0])||(this._adjustInstDate(o,i+("M"===s?this._get(o,"showCurrentAtPos"):0),s),this._updateDatepicker(o))},_gotoToday:function(e){var i,s=t(e),n=this._getInst(s[0]);this._get(n,"gotoCurrent")&&n.currentDay?(n.selectedDay=n.currentDay,n.drawMonth=n.selectedMonth=n.currentMonth,n.drawYear=n.selectedYear=n.currentYear):(i=new Date,n.selectedDay=i.getDate(),n.drawMonth=n.selectedMonth=i.getMonth(),n.drawYear=n.selectedYear=i.getFullYear()),this._notifyChange(n),this._adjustDate(s)},_selectMonthYear:function(e,i,s){var n=t(e),o=this._getInst(n[0]);o["selected"+("M"===s?"Month":"Year")]=o["draw"+("M"===s?"Month":"Year")]=parseInt(i.options[i.selectedIndex].value,10),this._notifyChange(o),this._adjustDate(n)},_selectDay:function(e,i,s,n){var o,a=t(e);t(n).hasClass(this._unselectableClass)||this._isDisabledDatepicker(a[0])||(o=this._getInst(a[0]),o.selectedDay=o.currentDay=t("a",n).html(),o.selectedMonth=o.currentMonth=i,o.selectedYear=o.currentYear=s,this._selectDate(e,this._formatDate(o,o.currentDay,o.currentMonth,o.currentYear)))},_clearDate:function(e){var i=t(e);this._selectDate(i,"")},_selectDate:function(e,i){var s,n=t(e),o=this._getInst(n[0]);i=null!=i?i:this._formatDate(o),o.input&&o.input.val(i),this._updateAlternate(o),s=this._get(o,"onSelect"),s?s.apply(o.input?o.input[0]:null,[i,o]):o.input&&o.input.trigger("change"),o.inline?this._updateDatepicker(o):(this._hideDatepicker(),this._lastInput=o.input[0],"object"!=typeof o.input[0]&&o.input.trigger("focus"),this._lastInput=null)
},_updateAlternate:function(e){var i,s,n,o=this._get(e,"altField");o&&(i=this._get(e,"altFormat")||this._get(e,"dateFormat"),s=this._getDate(e),n=this.formatDate(i,s,this._getFormatConfig(e)),t(o).val(n))},noWeekends:function(t){var e=t.getDay();return[e>0&&6>e,""]},iso8601Week:function(t){var e,i=new Date(t.getTime());return i.setDate(i.getDate()+4-(i.getDay()||7)),e=i.getTime(),i.setMonth(0),i.setDate(1),Math.floor(Math.round((e-i)/864e5)/7)+1},parseDate:function(e,i,s){if (null==e||null==i)throw"Invalid arguments";if (i="object"==typeof i?""+i:i+"",""===i)return null;var n,o,a,r,l=0,h=(s?s.shortYearCutoff:null)||this._defaults.shortYearCutoff,c="string"!=typeof h?h:(new Date).getFullYear()%100+parseInt(h,10),u=(s?s.dayNamesShort:null)||this._defaults.dayNamesShort,d=(s?s.dayNames:null)||this._defaults.dayNames,p=(s?s.monthNamesShort:null)||this._defaults.monthNamesShort,f=(s?s.monthNames:null)||this._defaults.monthNames,g=-1,m=-1,_=-1,v=-1,b=!1,y=function(t){var i=e.length>n+1&&e.charAt(n+1)===t;return i&&n++,i},w=function(t){var e=y(t),s="@"===t?14:"!"===t?20:"y"===t&&e?4:"o"===t?3:2,n="y"===t?s:1,o=RegExp("^\\d{"+n+","+s+"}"),a=i.substring(l).match(o);if (!a)throw"Missing number at position "+l;return l+=a[0].length,parseInt(a[0],10)},k=function(e,s,n){var o=-1,a=t.map(y(e)?n:s,function(t,e){return[[e,t]]}).sort(function(t,e){return-(t[1].length-e[1].length)});if (t.each(a,function(t,e){var s=e[1];return i.substr(l,s.length).toLowerCase()===s.toLowerCase()?(o=e[0],l+=s.length,!1):void 0}),-1!==o)return o+1;throw"Unknown name at position "+l},x=function(){if (i.charAt(l)!==e.charAt(n))throw"Unexpected literal at position "+l;l++};for(n=0;e.length>n;n++)if (b)"'"!==e.charAt(n)||y("'")?x():b=!1;else switch(e.charAt(n)){case"d":_=w("d");break;case"D":k("D",u,d);break;case"o":v=w("o");break;case"m":m=w("m");break;case"M":m=k("M",p,f);break;case"y":g=w("y");break;case"@":r=new Date(w("@")),g=r.getFullYear(),m=r.getMonth()+1,_=r.getDate();break;case"!":r=new Date((w("!")-this._ticksTo1970)/1e4),g=r.getFullYear(),m=r.getMonth()+1,_=r.getDate();break;case"'":y("'")?x():b=!0;break;default:x()}if (i.length>l&&(a=i.substr(l),!/^\s+/.test(a)))throw"Extra/unparsed characters found in date: "+a;if (-1===g?g=(new Date).getFullYear():100>g&&(g+=(new Date).getFullYear()-(new Date).getFullYear()%100+(c>=g?0:-100)),v>-1)for(m=1,_=v;;){if (o=this._getDaysInMonth(g,m-1),o>=_)break;m++,_-=o}if (r=this._daylightSavingAdjust(new Date(g,m-1,_)),r.getFullYear()!==g||r.getMonth()+1!==m||r.getDate()!==_)throw"Invalid date";return r},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:1e7*60*60*24*(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925)),formatDate:function(t,e,i){if (!e)return"";var s,n=(i?i.dayNamesShort:null)||this._defaults.dayNamesShort,o=(i?i.dayNames:null)||this._defaults.dayNames,a=(i?i.monthNamesShort:null)||this._defaults.monthNamesShort,r=(i?i.monthNames:null)||this._defaults.monthNames,l=function(e){var i=t.length>s+1&&t.charAt(s+1)===e;return i&&s++,i},h=function(t,e,i){var s=""+e;if (l(t))for(;i>s.length;)s="0"+s;return s},c=function(t,e,i,s){return l(t)?s[e]:i[e]},u="",d=!1;if (e)for(s=0;t.length>s;s++)if (d)"'"!==t.charAt(s)||l("'")?u+=t.charAt(s):d=!1;else switch(t.charAt(s)){case"d":u+=h("d",e.getDate(),2);break;case"D":u+=c("D",e.getDay(),n,o);break;case"o":u+=h("o",Math.round((new Date(e.getFullYear(),e.getMonth(),e.getDate()).getTime()-new Date(e.getFullYear(),0,0).getTime())/864e5),3);break;case"m":u+=h("m",e.getMonth()+1,2);break;case"M":u+=c("M",e.getMonth(),a,r);break;case"y":u+=l("y")?e.getFullYear():(10>e.getFullYear()%100?"0":"")+e.getFullYear()%100;break;case"@":u+=e.getTime();break;case"!":u+=1e4*e.getTime()+this._ticksTo1970;break;case"'":l("'")?u+="'":d=!0;break;default:u+=t.charAt(s)}return u},_possibleChars:function(t){var e,i="",s=!1,n=function(i){var s=t.length>e+1&&t.charAt(e+1)===i;return s&&e++,s};for(e=0;t.length>e;e++)if (s)"'"!==t.charAt(e)||n("'")?i+=t.charAt(e):s=!1;else switch(t.charAt(e)){case"d":case"m":case"y":case"@":i+="0123456789";break;case"D":case"M":return null;case"'":n("'")?i+="'":s=!0;break;default:i+=t.charAt(e)}return i},_get:function(t,e){return void 0!==t.settings[e]?t.settings[e]:this._defaults[e]},_setDateFromField:function(t,e){if (t.input.val()!==t.lastVal){var i=this._get(t,"dateFormat"),s=t.lastVal=t.input?t.input.val():null,n=this._getDefaultDate(t),o=n,a=this._getFormatConfig(t);try{o=this.parseDate(i,s,a)||n}catch(r){s=e?"":s}t.selectedDay=o.getDate(),t.drawMonth=t.selectedMonth=o.getMonth(),t.drawYear=t.selectedYear=o.getFullYear(),t.currentDay=s?o.getDate():0,t.currentMonth=s?o.getMonth():0,t.currentYear=s?o.getFullYear():0,this._adjustInstDate(t)}},_getDefaultDate:function(t){return this._restrictMinMax(t,this._determineDate(t,this._get(t,"defaultDate"),new Date))},_determineDate:function(e,i,s){var n=function(t){var e=new Date;return e.setDate(e.getDate()+t),e},o=function(i){try{return t.datepicker.parseDate(t.datepicker._get(e,"dateFormat"),i,t.datepicker._getFormatConfig(e))}catch(s){}for(var n=(i.toLowerCase().match(/^c/)?t.datepicker._getDate(e):null)||new Date,o=n.getFullYear(),a=n.getMonth(),r=n.getDate(),l=/([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,h=l.exec(i);h;){switch(h[2]||"d"){case"d":case"D":r+=parseInt(h[1],10);break;case"w":case"W":r+=7*parseInt(h[1],10);break;case"m":case"M":a+=parseInt(h[1],10),r=Math.min(r,t.datepicker._getDaysInMonth(o,a));break;case"y":case"Y":o+=parseInt(h[1],10),r=Math.min(r,t.datepicker._getDaysInMonth(o,a))}h=l.exec(i)}return new Date(o,a,r)},a=null==i||""===i?s:"string"==typeof i?o(i):"number"==typeof i?isNaN(i)?s:n(i):new Date(i.getTime());return a=a&&"Invalid Date"==""+a?s:a,a&&(a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0)),this._daylightSavingAdjust(a)},_daylightSavingAdjust:function(t){return t?(t.setHours(t.getHours()>12?t.getHours()+2:0),t):null},_setDate:function(t,e,i){var s=!e,n=t.selectedMonth,o=t.selectedYear,a=this._restrictMinMax(t,this._determineDate(t,e,new Date));t.selectedDay=t.currentDay=a.getDate(),t.drawMonth=t.selectedMonth=t.currentMonth=a.getMonth(),t.drawYear=t.selectedYear=t.currentYear=a.getFullYear(),n===t.selectedMonth&&o===t.selectedYear||i||this._notifyChange(t),this._adjustInstDate(t),t.input&&t.input.val(s?"":this._formatDate(t))},_getDate:function(t){var e=!t.currentYear||t.input&&""===t.input.val()?null:this._daylightSavingAdjust(new Date(t.currentYear,t.currentMonth,t.currentDay));return e},_attachHandlers:function(e){var i=this._get(e,"stepMonths"),s="#"+e.id.replace(/\\\\/g,"\\");e.dpDiv.find("[data-handler]").map(function(){var e={prev:function(){t.datepicker._adjustDate(s,-i,"M")},next:function(){t.datepicker._adjustDate(s,+i,"M")},hide:function(){t.datepicker._hideDatepicker()},today:function(){t.datepicker._gotoToday(s)},selectDay:function(){return t.datepicker._selectDay(s,+this.getAttribute("data-month"),+this.getAttribute("data-year"),this),!1},selectMonth:function(){return t.datepicker._selectMonthYear(s,this,"M"),!1},selectYear:function(){return t.datepicker._selectMonthYear(s,this,"Y"),!1}};t(this).on(this.getAttribute("data-event"),e[this.getAttribute("data-handler")])})},_generateHTML:function(t){var e,i,s,n,o,a,r,l,h,c,u,d,p,f,g,m,_,v,b,y,w,k,x,C,D,T,I,M,P,S,N,H,A,z,O,E,W,F,L,R=new Date,Y=this._daylightSavingAdjust(new Date(R.getFullYear(),R.getMonth(),R.getDate())),B=this._get(t,"isRTL"),j=this._get(t,"showButtonPanel"),q=this._get(t,"hideIfNoPrevNext"),K=this._get(t,"navigationAsDateFormat"),U=this._getNumberOfMonths(t),V=this._get(t,"showCurrentAtPos"),X=this._get(t,"stepMonths"),$=1!==U[0]||1!==U[1],G=this._daylightSavingAdjust(t.currentDay?new Date(t.currentYear,t.currentMonth,t.currentDay):new Date(9999,9,9)),J=this._getMinMaxDate(t,"min"),Q=this._getMinMaxDate(t,"max"),Z=t.drawMonth-V,te=t.drawYear;if (0>Z&&(Z+=12,te--),Q)for(e=this._daylightSavingAdjust(new Date(Q.getFullYear(),Q.getMonth()-U[0]*U[1]+1,Q.getDate())),e=J&&J>e?J:e;this._daylightSavingAdjust(new Date(te,Z,1))>e;)Z--,0>Z&&(Z=11,te--);for(t.drawMonth=Z,t.drawYear=te,i=this._get(t,"prevText"),i=K?this.formatDate(i,this._daylightSavingAdjust(new Date(te,Z-X,1)),this._getFormatConfig(t)):i,s=this._canAdjustMonth(t,-1,te,Z)?"<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click' title='"+i+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"e":"w")+"'>"+i+"</span></a>":q?"":"<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='"+i+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"e":"w")+"'>"+i+"</span></a>",n=this._get(t,"nextText"),n=K?this.formatDate(n,this._daylightSavingAdjust(new Date(te,Z+X,1)),this._getFormatConfig(t)):n,o=this._canAdjustMonth(t,1,te,Z)?"<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click' title='"+n+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"w":"e")+"'>"+n+"</span></a>":q?"":"<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='"+n+"'><span class='ui-icon ui-icon-circle-triangle-"+(B?"w":"e")+"'>"+n+"</span></a>",a=this._get(t,"currentText"),r=this._get(t,"gotoCurrent")&&t.currentDay?G:Y,a=K?this.formatDate(a,r,this._getFormatConfig(t)):a,l=t.inline?"":"<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>"+this._get(t,"closeText")+"</button>",h=j?"<div class='ui-datepicker-buttonpane ui-widget-content'>"+(B?l:"")+(this._isInRange(t,r)?"<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'>"+a+"</button>":"")+(B?"":l)+"</div>":"",c=parseInt(this._get(t,"firstDay"),10),c=isNaN(c)?0:c,u=this._get(t,"showWeek"),d=this._get(t,"dayNames"),p=this._get(t,"dayNamesMin"),f=this._get(t,"monthNames"),g=this._get(t,"monthNamesShort"),m=this._get(t,"beforeShowDay"),_=this._get(t,"showOtherMonths"),v=this._get(t,"selectOtherMonths"),b=this._getDefaultDate(t),y="",k=0;U[0]>k;k++){for(x="",this.maxRows=4,C=0;U[1]>C;C++){if (D=this._daylightSavingAdjust(new Date(te,Z,t.selectedDay)),T=" ui-corner-all",I="",$){if (I+="<div class='ui-datepicker-group",U[1]>1)switch(C){case 0:I+=" ui-datepicker-group-first",T=" ui-corner-"+(B?"right":"left");break;case U[1]-1:I+=" ui-datepicker-group-last",T=" ui-corner-"+(B?"left":"right");break;default:I+=" ui-datepicker-group-middle",T=""}I+="'>"}for(I+="<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix"+T+"'>"+(/all|left/.test(T)&&0===k?B?o:s:"")+(/all|right/.test(T)&&0===k?B?s:o:"")+this._generateMonthYearHeader(t,Z,te,J,Q,k>0||C>0,f,g)+"</div><table class='ui-datepicker-calendar'><thead>"+"<tr>",M=u?"<th class='ui-datepicker-week-col'>"+this._get(t,"weekHeader")+"</th>":"",w=0;7>w;w++)P=(w+c)%7,M+="<th scope='col'"+((w+c+6)%7>=5?" class='ui-datepicker-week-end'":"")+">"+"<span title='"+d[P]+"'>"+p[P]+"</span></th>";for(I+=M+"</tr></thead><tbody>",S=this._getDaysInMonth(te,Z),te===t.selectedYear&&Z===t.selectedMonth&&(t.selectedDay=Math.min(t.selectedDay,S)),N=(this._getFirstDayOfMonth(te,Z)-c+7)%7,H=Math.ceil((N+S)/7),A=$?this.maxRows>H?this.maxRows:H:H,this.maxRows=A,z=this._daylightSavingAdjust(new Date(te,Z,1-N)),O=0;A>O;O++){for(I+="<tr>",E=u?"<td class='ui-datepicker-week-col'>"+this._get(t,"calculateWeek")(z)+"</td>":"",w=0;7>w;w++)W=m?m.apply(t.input?t.input[0]:null,[z]):[!0,""],F=z.getMonth()!==Z,L=F&&!v||!W[0]||J&&J>z||Q&&z>Q,E+="<td class='"+((w+c+6)%7>=5?" ui-datepicker-week-end":"")+(F?" ui-datepicker-other-month":"")+(z.getTime()===D.getTime()&&Z===t.selectedMonth&&t._keyEvent||b.getTime()===z.getTime()&&b.getTime()===D.getTime()?" "+this._dayOverClass:"")+(L?" "+this._unselectableClass+" ui-state-disabled":"")+(F&&!_?"":" "+W[1]+(z.getTime()===G.getTime()?" "+this._currentClass:"")+(z.getTime()===Y.getTime()?" ui-datepicker-today":""))+"'"+(F&&!_||!W[2]?"":" title='"+W[2].replace(/'/g,"&#39;")+"'")+(L?"":" data-handler='selectDay' data-event='click' data-month='"+z.getMonth()+"' data-year='"+z.getFullYear()+"'")+">"+(F&&!_?"&#xa0;":L?"<span class='ui-state-default'>"+z.getDate()+"</span>":"<a class='ui-state-default"+(z.getTime()===Y.getTime()?" ui-state-highlight":"")+(z.getTime()===G.getTime()?" ui-state-active":"")+(F?" ui-priority-secondary":"")+"' href='#'>"+z.getDate()+"</a>")+"</td>",z.setDate(z.getDate()+1),z=this._daylightSavingAdjust(z);I+=E+"</tr>"}Z++,Z>11&&(Z=0,te++),I+="</tbody></table>"+($?"</div>"+(U[0]>0&&C===U[1]-1?"<div class='ui-datepicker-row-break'></div>":""):""),x+=I}y+=x}return y+=h,t._keyEvent=!1,y},_generateMonthYearHeader:function(t,e,i,s,n,o,a,r){var l,h,c,u,d,p,f,g,m=this._get(t,"changeMonth"),_=this._get(t,"changeYear"),v=this._get(t,"showMonthAfterYear"),b="<div class='ui-datepicker-title'>",y="";if (o||!m)y+="<span class='ui-datepicker-month'>"+a[e]+"</span>";else{for(l=s&&s.getFullYear()===i,h=n&&n.getFullYear()===i,y+="<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>",c=0;12>c;c++)(!l||c>=s.getMonth())&&(!h||n.getMonth()>=c)&&(y+="<option value='"+c+"'"+(c===e?" selected='selected'":"")+">"+r[c]+"</option>");y+="</select>"}if (v||(b+=y+(!o&&m&&_?"":"&#xa0;")),!t.yearshtml)if (t.yearshtml="",o||!_)b+="<span class='ui-datepicker-year'>"+i+"</span>";else{for(u=this._get(t,"yearRange").split(":"),d=(new Date).getFullYear(),p=function(t){var e=t.match(/c[+\-].*/)?i+parseInt(t.substring(1),10):t.match(/[+\-].*/)?d+parseInt(t,10):parseInt(t,10);return isNaN(e)?d:e},f=p(u[0]),g=Math.max(f,p(u[1]||"")),f=s?Math.max(f,s.getFullYear()):f,g=n?Math.min(g,n.getFullYear()):g,t.yearshtml+="<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";g>=f;f++)t.yearshtml+="<option value='"+f+"'"+(f===i?" selected='selected'":"")+">"+f+"</option>";t.yearshtml+="</select>",b+=t.yearshtml,t.yearshtml=null}return b+=this._get(t,"yearSuffix"),v&&(b+=(!o&&m&&_?"":"&#xa0;")+y),b+="</div>"},_adjustInstDate:function(t,e,i){var s=t.selectedYear+("Y"===i?e:0),n=t.selectedMonth+("M"===i?e:0),o=Math.min(t.selectedDay,this._getDaysInMonth(s,n))+("D"===i?e:0),a=this._restrictMinMax(t,this._daylightSavingAdjust(new Date(s,n,o)));t.selectedDay=a.getDate(),t.drawMonth=t.selectedMonth=a.getMonth(),t.drawYear=t.selectedYear=a.getFullYear(),("M"===i||"Y"===i)&&this._notifyChange(t)},_restrictMinMax:function(t,e){var i=this._getMinMaxDate(t,"min"),s=this._getMinMaxDate(t,"max"),n=i&&i>e?i:e;return s&&n>s?s:n},_notifyChange:function(t){var e=this._get(t,"onChangeMonthYear");e&&e.apply(t.input?t.input[0]:null,[t.selectedYear,t.selectedMonth+1,t])},_getNumberOfMonths:function(t){var e=this._get(t,"numberOfMonths");return null==e?[1,1]:"number"==typeof e?[1,e]:e},_getMinMaxDate:function(t,e){return this._determineDate(t,this._get(t,e+"Date"),null)},_getDaysInMonth:function(t,e){return 32-this._daylightSavingAdjust(new Date(t,e,32)).getDate()},_getFirstDayOfMonth:function(t,e){return new Date(t,e,1).getDay()},_canAdjustMonth:function(t,e,i,s){var n=this._getNumberOfMonths(t),o=this._daylightSavingAdjust(new Date(i,s+(0>e?e:n[0]*n[1]),1));return 0>e&&o.setDate(this._getDaysInMonth(o.getFullYear(),o.getMonth())),this._isInRange(t,o)},_isInRange:function(t,e){var i,s,n=this._getMinMaxDate(t,"min"),o=this._getMinMaxDate(t,"max"),a=null,r=null,l=this._get(t,"yearRange");return l&&(i=l.split(":"),s=(new Date).getFullYear(),a=parseInt(i[0],10),r=parseInt(i[1],10),i[0].match(/[+\-].*/)&&(a+=s),i[1].match(/[+\-].*/)&&(r+=s)),(!n||e.getTime()>=n.getTime())&&(!o||e.getTime()<=o.getTime())&&(!a||e.getFullYear()>=a)&&(!r||r>=e.getFullYear())},_getFormatConfig:function(t){var e=this._get(t,"shortYearCutoff");return e="string"!=typeof e?e:(new Date).getFullYear()%100+parseInt(e,10),{shortYearCutoff:e,dayNamesShort:this._get(t,"dayNamesShort"),dayNames:this._get(t,"dayNames"),monthNamesShort:this._get(t,"monthNamesShort"),monthNames:this._get(t,"monthNames")}},_formatDate:function(t,e,i,s){e||(t.currentDay=t.selectedDay,t.currentMonth=t.selectedMonth,t.currentYear=t.selectedYear);var n=e?"object"==typeof e?e:this._daylightSavingAdjust(new Date(s,i,e)):this._daylightSavingAdjust(new Date(t.currentYear,t.currentMonth,t.currentDay));return this.formatDate(this._get(t,"dateFormat"),n,this._getFormatConfig(t))}}),t.fn.datepicker=function(e){if (!this.length)return this;t.datepicker.initialized||(t(document).on("mousedown",t.datepicker._checkExternalClick),t.datepicker.initialized=!0),0===t("#"+t.datepicker._mainDivId).length&&t("body").append(t.datepicker.dpDiv);var i=Array.prototype.slice.call(arguments,1);return"string"!=typeof e||"isDisabled"!==e&&"getDate"!==e&&"widget"!==e?"option"===e&&2===arguments.length&&"string"==typeof arguments[1]?t.datepicker["_"+e+"Datepicker"].apply(t.datepicker,[this[0]].concat(i)):this.each(function(){"string"==typeof e?t.datepicker["_"+e+"Datepicker"].apply(t.datepicker,[this].concat(i)):t.datepicker._attachDatepicker(this,e)}):t.datepicker["_"+e+"Datepicker"].apply(t.datepicker,[this[0]].concat(i))},t.datepicker=new s,t.datepicker.initialized=!1,t.datepicker.uuid=(new Date).getTime(),t.datepicker.version="1.12.1",t.datepicker,t.widget("ui.progressbar",{version:"1.12.1",options:{classes:{"ui-progressbar":"ui-corner-all","ui-progressbar-value":"ui-corner-left","ui-progressbar-complete":"ui-corner-right"},max:100,value:0,change:null,complete:null},min:0,_create:function(){this.oldValue=this.options.value=this._constrainedValue(),this.element.attr({role:"progressbar","aria-valuemin":this.min}),this._addClass("ui-progressbar","ui-widget ui-widget-content"),this.valueDiv=t("<div>").appendTo(this.element),this._addClass(this.valueDiv,"ui-progressbar-value","ui-widget-header"),this._refreshValue()},_destroy:function(){this.element.removeAttr("role aria-valuemin aria-valuemax aria-valuenow"),this.valueDiv.remove()},value:function(t){return void 0===t?this.options.value:(this.options.value=this._constrainedValue(t),this._refreshValue(),void 0)},_constrainedValue:function(t){return void 0===t&&(t=this.options.value),this.indeterminate=t===!1,"number"!=typeof t&&(t=0),this.indeterminate?!1:Math.min(this.options.max,Math.max(this.min,t))},_setOptions:function(t){var e=t.value;delete t.value,this._super(t),this.options.value=this._constrainedValue(e),this._refreshValue()},_setOption:function(t,e){"max"===t&&(e=Math.max(this.min,e)),this._super(t,e)},_setOptionDisabled:function(t){this._super(t),this.element.attr("aria-disabled",t),this._toggleClass(null,"ui-state-disabled",!!t)},_percentage:function(){return this.indeterminate?100:100*(this.options.value-this.min)/(this.options.max-this.min)},_refreshValue:function(){var e=this.options.value,i=this._percentage();this.valueDiv.toggle(this.indeterminate||e>this.min).width(i.toFixed(0)+"%"),this._toggleClass(this.valueDiv,"ui-progressbar-complete",null,e===this.options.max)._toggleClass("ui-progressbar-indeterminate",null,this.indeterminate),this.indeterminate?(this.element.removeAttr("aria-valuenow"),this.overlayDiv||(this.overlayDiv=t("<div>").appendTo(this.valueDiv),this._addClass(this.overlayDiv,"ui-progressbar-overlay"))):(this.element.attr({"aria-valuemax":this.options.max,"aria-valuenow":e}),this.overlayDiv&&(this.overlayDiv.remove(),this.overlayDiv=null)),this.oldValue!==e&&(this.oldValue=e,this._trigger("change")),e===this.options.max&&this._trigger("complete")}}),t.widget("ui.slider",t.ui.mouse,{version:"1.12.1",widgetEventPrefix:"slide",options:{animate:!1,classes:{"ui-slider":"ui-corner-all","ui-slider-handle":"ui-corner-all","ui-slider-range":"ui-corner-all ui-widget-header"},distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null,change:null,slide:null,start:null,stop:null},numPages:5,_create:function(){this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this._calculateNewMax(),this._addClass("ui-slider ui-slider-"+this.orientation,"ui-widget ui-widget-content"),this._refresh(),this._animateOff=!1},_refresh:function(){this._createRange(),this._createHandles(),this._setupEvents(),this._refreshValue()},_createHandles:function(){var e,i,s=this.options,n=this.element.find(".ui-slider-handle"),o="<span tabindex='0'></span>",a=[];for(i=s.values&&s.values.length||1,n.length>i&&(n.slice(i).remove(),n=n.slice(0,i)),e=n.length;i>e;e++)a.push(o);this.handles=n.add(t(a.join("")).appendTo(this.element)),this._addClass(this.handles,"ui-slider-handle","ui-state-default"),this.handle=this.handles.eq(0),this.handles.each(function(e){t(this).data("ui-slider-handle-index",e).attr("tabIndex",0)})},_createRange:function(){var e=this.options;e.range?(e.range===!0&&(e.values?e.values.length&&2!==e.values.length?e.values=[e.values[0],e.values[0]]:t.isArray(e.values)&&(e.values=e.values.slice(0)):e.values=[this._valueMin(),this._valueMin()]),this.range&&this.range.length?(this._removeClass(this.range,"ui-slider-range-min ui-slider-range-max"),this.range.css({left:"",bottom:""})):(this.range=t("<div>").appendTo(this.element),this._addClass(this.range,"ui-slider-range")),("min"===e.range||"max"===e.range)&&this._addClass(this.range,"ui-slider-range-"+e.range)):(this.range&&this.range.remove(),this.range=null)},_setupEvents:function(){this._off(this.handles),this._on(this.handles,this._handleEvents),this._hoverable(this.handles),this._focusable(this.handles)},_destroy:function(){this.handles.remove(),this.range&&this.range.remove(),this._mouseDestroy()},_mouseCapture:function(e){var i,s,n,o,a,r,l,h,c=this,u=this.options;return u.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),i={x:e.pageX,y:e.pageY},s=this._normValueFromMouse(i),n=this._valueMax()-this._valueMin()+1,this.handles.each(function(e){var i=Math.abs(s-c.values(e));(n>i||n===i&&(e===c._lastChangedValue||c.values(e)===u.min))&&(n=i,o=t(this),a=e)}),r=this._start(e,a),r===!1?!1:(this._mouseSliding=!0,this._handleIndex=a,this._addClass(o,null,"ui-state-active"),o.trigger("focus"),l=o.offset(),h=!t(e.target).parents().addBack().is(".ui-slider-handle"),this._clickOffset=h?{left:0,top:0}:{left:e.pageX-l.left-o.width()/2,top:e.pageY-l.top-o.height()/2-(parseInt(o.css("borderTopWidth"),10)||0)-(parseInt(o.css("borderBottomWidth"),10)||0)+(parseInt(o.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(e,a,s),this._animateOff=!0,!0))},_mouseStart:function(){return!0},_mouseDrag:function(t){var e={x:t.pageX,y:t.pageY},i=this._normValueFromMouse(e);return this._slide(t,this._handleIndex,i),!1},_mouseStop:function(t){return this._removeClass(this.handles,null,"ui-state-active"),this._mouseSliding=!1,this._stop(t,this._handleIndex),this._change(t,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1},_detectOrientation:function(){this.orientation="vertical"===this.options.orientation?"vertical":"horizontal"},_normValueFromMouse:function(t){var e,i,s,n,o;return"horizontal"===this.orientation?(e=this.elementSize.width,i=t.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(e=this.elementSize.height,i=t.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),s=i/e,s>1&&(s=1),0>s&&(s=0),"vertical"===this.orientation&&(s=1-s),n=this._valueMax()-this._valueMin(),o=this._valueMin()+s*n,this._trimAlignValue(o)},_uiHash:function(t,e,i){var s={handle:this.handles[t],handleIndex:t,value:void 0!==e?e:this.value()};return this._hasMultipleValues()&&(s.value=void 0!==e?e:this.values(t),s.values=i||this.values()),s},_hasMultipleValues:function(){return this.options.values&&this.options.values.length},_start:function(t,e){return this._trigger("start",t,this._uiHash(e))},_slide:function(t,e,i){var s,n,o=this.value(),a=this.values();this._hasMultipleValues()&&(n=this.values(e?0:1),o=this.values(e),2===this.options.values.length&&this.options.range===!0&&(i=0===e?Math.min(n,i):Math.max(n,i)),a[e]=i),i!==o&&(s=this._trigger("slide",t,this._uiHash(e,i,a)),s!==!1&&(this._hasMultipleValues()?this.values(e,i):this.value(i)))},_stop:function(t,e){this._trigger("stop",t,this._uiHash(e))},_change:function(t,e){this._keySliding||this._mouseSliding||(this._lastChangedValue=e,this._trigger("change",t,this._uiHash(e)))},value:function(t){return arguments.length?(this.options.value=this._trimAlignValue(t),this._refreshValue(),this._change(null,0),void 0):this._value()},values:function(e,i){var s,n,o;if (arguments.length>1)return this.options.values[e]=this._trimAlignValue(i),this._refreshValue(),this._change(null,e),void 0;if (!arguments.length)return this._values();if (!t.isArray(arguments[0]))return this._hasMultipleValues()?this._values(e):this.value();for(s=this.options.values,n=arguments[0],o=0;s.length>o;o+=1)s[o]=this._trimAlignValue(n[o]),this._change(null,o);this._refreshValue()},_setOption:function(e,i){var s,n=0;switch("range"===e&&this.options.range===!0&&("min"===i?(this.options.value=this._values(0),this.options.values=null):"max"===i&&(this.options.value=this._values(this.options.values.length-1),this.options.values=null)),t.isArray(this.options.values)&&(n=this.options.values.length),this._super(e,i),e){case"orientation":this._detectOrientation(),this._removeClass("ui-slider-horizontal ui-slider-vertical")._addClass("ui-slider-"+this.orientation),this._refreshValue(),this.options.range&&this._refreshRange(i),this.handles.css("horizontal"===i?"bottom":"left","");break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;case"values":for(this._animateOff=!0,this._refreshValue(),s=n-1;s>=0;s--)this._change(null,s);this._animateOff=!1;break;case"step":case"min":case"max":this._animateOff=!0,this._calculateNewMax(),this._refreshValue(),this._animateOff=!1;break;case"range":this._animateOff=!0,this._refresh(),this._animateOff=!1}},_setOptionDisabled:function(t){this._super(t),this._toggleClass(null,"ui-state-disabled",!!t)},_value:function(){var t=this.options.value;return t=this._trimAlignValue(t)},_values:function(t){var e,i,s;if (arguments.length)return e=this.options.values[t],e=this._trimAlignValue(e);if (this._hasMultipleValues()){for(i=this.options.values.slice(),s=0;i.length>s;s+=1)i[s]=this._trimAlignValue(i[s]);return i}return[]},_trimAlignValue:function(t){if (this._valueMin()>=t)return this._valueMin();if (t>=this._valueMax())return this._valueMax();var e=this.options.step>0?this.options.step:1,i=(t-this._valueMin())%e,s=t-i;return 2*Math.abs(i)>=e&&(s+=i>0?e:-e),parseFloat(s.toFixed(5))},_calculateNewMax:function(){var t=this.options.max,e=this._valueMin(),i=this.options.step,s=Math.round((t-e)/i)*i;t=s+e,t>this.options.max&&(t-=i),this.max=parseFloat(t.toFixed(this._precision()))},_precision:function(){var t=this._precisionOf(this.options.step);return null!==this.options.min&&(t=Math.max(t,this._precisionOf(this.options.min))),t},_precisionOf:function(t){var e=""+t,i=e.indexOf(".");return-1===i?0:e.length-i-1},_valueMin:function(){return this.options.min},_valueMax:function(){return this.max},_refreshRange:function(t){"vertical"===t&&this.range.css({width:"",left:""}),"horizontal"===t&&this.range.css({height:"",bottom:""})},_refreshValue:function(){var e,i,s,n,o,a=this.options.range,r=this.options,l=this,h=this._animateOff?!1:r.animate,c={};this._hasMultipleValues()?this.handles.each(function(s){i=100*((l.values(s)-l._valueMin())/(l._valueMax()-l._valueMin())),c["horizontal"===l.orientation?"left":"bottom"]=i+"%",t(this).stop(1,1)[h?"animate":"css"](c,r.animate),l.options.range===!0&&("horizontal"===l.orientation?(0===s&&l.range.stop(1,1)[h?"animate":"css"]({left:i+"%"},r.animate),1===s&&l.range[h?"animate":"css"]({width:i-e+"%"},{queue:!1,duration:r.animate})):(0===s&&l.range.stop(1,1)[h?"animate":"css"]({bottom:i+"%"},r.animate),1===s&&l.range[h?"animate":"css"]({height:i-e+"%"},{queue:!1,duration:r.animate}))),e=i}):(s=this.value(),n=this._valueMin(),o=this._valueMax(),i=o!==n?100*((s-n)/(o-n)):0,c["horizontal"===this.orientation?"left":"bottom"]=i+"%",this.handle.stop(1,1)[h?"animate":"css"](c,r.animate),"min"===a&&"horizontal"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({width:i+"%"},r.animate),"max"===a&&"horizontal"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({width:100-i+"%"},r.animate),"min"===a&&"vertical"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({height:i+"%"},r.animate),"max"===a&&"vertical"===this.orientation&&this.range.stop(1,1)[h?"animate":"css"]({height:100-i+"%"},r.animate))},_handleEvents:{keydown:function(e){var i,s,n,o,a=t(e.target).data("ui-slider-handle-index");switch(e.keyCode){case t.ui.keyCode.HOME:case t.ui.keyCode.END:case t.ui.keyCode.PAGE_UP:case t.ui.keyCode.PAGE_DOWN:case t.ui.keyCode.UP:case t.ui.keyCode.RIGHT:case t.ui.keyCode.DOWN:case t.ui.keyCode.LEFT:if (e.preventDefault(),!this._keySliding&&(this._keySliding=!0,this._addClass(t(e.target),null,"ui-state-active"),i=this._start(e,a),i===!1))return}switch(o=this.options.step,s=n=this._hasMultipleValues()?this.values(a):this.value(),e.keyCode){case t.ui.keyCode.HOME:n=this._valueMin();break;case t.ui.keyCode.END:n=this._valueMax();break;case t.ui.keyCode.PAGE_UP:n=this._trimAlignValue(s+(this._valueMax()-this._valueMin())/this.numPages);break;case t.ui.keyCode.PAGE_DOWN:n=this._trimAlignValue(s-(this._valueMax()-this._valueMin())/this.numPages);break;case t.ui.keyCode.UP:case t.ui.keyCode.RIGHT:if (s===this._valueMax())return;n=this._trimAlignValue(s+o);break;case t.ui.keyCode.DOWN:case t.ui.keyCode.LEFT:if (s===this._valueMin())return;n=this._trimAlignValue(s-o)}this._slide(e,a,n)},keyup:function(e){var i=t(e.target).data("ui-slider-handle-index");this._keySliding&&(this._keySliding=!1,this._stop(e,i),this._change(e,i),this._removeClass(t(e.target),null,"ui-state-active"))}}});var d="ui-effects-",p="ui-effects-style",f="ui-effects-animated",g=t;t.effects={effect:{}},function(t,e){function i(t,e,i){var s=u[e.type]||{};return null==t?i||!e.def?null:e.def:(t=s.floor?~~t:parseFloat(t),isNaN(t)?e.def:s.mod?(t+s.mod)%s.mod:0>t?0:t>s.max?s.max:t)}function s(i){var s=h(),n=s._rgba=[];return i=i.toLowerCase(),f(l,function(t,o){var a,r=o.re.exec(i),l=r&&o.parse(r),h=o.space||"rgba";return l?(a=s[h](l),s[c[h].cache]=a[c[h].cache],n=s._rgba=a._rgba,!1):e}),n.length?("0,0,0,0"===n.join()&&t.extend(n,o.transparent),s):o[i]}function n(t,e,i){return i=(i+1)%1,1>6*i?t+6*(e-t)*i:1>2*i?e:2>3*i?t+6*(e-t)*(2/3-i):t}var o,a="backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor",r=/^([\-+])=\s*(\d+\.?\d*)/,l=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(t){return[t[1],t[2],t[3],t[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,parse:function(t){return[2.55*t[1],2.55*t[2],2.55*t[3],t[4]]}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(t){return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(t){return[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16)]}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d?(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(t){return[t[1],t[2]/100,t[3]/100,t[4]]}}],h=t.Color=function(e,i,s,n){return new t.Color.fn.parse(e,i,s,n)},c={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},u={"byte":{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},d=h.support={},p=t("<p>")[0],f=t.each;p.style.cssText="background-color:rgba(1,1,1,.5)",d.rgba=p.style.backgroundColor.indexOf("rgba")>-1,f(c,function(t,e){e.cache="_"+t,e.props.alpha={idx:3,type:"percent",def:1}
}),h.fn=t.extend(h.prototype,{parse:function(n,a,r,l){if (n===e)return this._rgba=[null,null,null,null],this;(n.jquery||n.nodeType)&&(n=t(n).css(a),a=e);var u=this,d=t.type(n),p=this._rgba=[];return a!==e&&(n=[n,a,r,l],d="array"),"string"===d?this.parse(s(n)||o._default):"array"===d?(f(c.rgba.props,function(t,e){p[e.idx]=i(n[e.idx],e)}),this):"object"===d?(n instanceof h?f(c,function(t,e){n[e.cache]&&(u[e.cache]=n[e.cache].slice())}):f(c,function(e,s){var o=s.cache;f(s.props,function(t,e){if (!u[o]&&s.to){if ("alpha"===t||null==n[t])return;u[o]=s.to(u._rgba)}u[o][e.idx]=i(n[t],e,!0)}),u[o]&&0>t.inArray(null,u[o].slice(0,3))&&(u[o][3]=1,s.from&&(u._rgba=s.from(u[o])))}),this):e},is:function(t){var i=h(t),s=!0,n=this;return f(c,function(t,o){var a,r=i[o.cache];return r&&(a=n[o.cache]||o.to&&o.to(n._rgba)||[],f(o.props,function(t,i){return null!=r[i.idx]?s=r[i.idx]===a[i.idx]:e})),s}),s},_space:function(){var t=[],e=this;return f(c,function(i,s){e[s.cache]&&t.push(i)}),t.pop()},transition:function(t,e){var s=h(t),n=s._space(),o=c[n],a=0===this.alpha()?h("transparent"):this,r=a[o.cache]||o.to(a._rgba),l=r.slice();return s=s[o.cache],f(o.props,function(t,n){var o=n.idx,a=r[o],h=s[o],c=u[n.type]||{};null!==h&&(null===a?l[o]=h:(c.mod&&(h-a>c.mod/2?a+=c.mod:a-h>c.mod/2&&(a-=c.mod)),l[o]=i((h-a)*e+a,n)))}),this[n](l)},blend:function(e){if (1===this._rgba[3])return this;var i=this._rgba.slice(),s=i.pop(),n=h(e)._rgba;return h(t.map(i,function(t,e){return(1-s)*n[e]+s*t}))},toRgbaString:function(){var e="rgba(",i=t.map(this._rgba,function(t,e){return null==t?e>2?1:0:t});return 1===i[3]&&(i.pop(),e="rgb("),e+i.join()+")"},toHslaString:function(){var e="hsla(",i=t.map(this.hsla(),function(t,e){return null==t&&(t=e>2?1:0),e&&3>e&&(t=Math.round(100*t)+"%"),t});return 1===i[3]&&(i.pop(),e="hsl("),e+i.join()+")"},toHexString:function(e){var i=this._rgba.slice(),s=i.pop();return e&&i.push(~~(255*s)),"#"+t.map(i,function(t){return t=(t||0).toString(16),1===t.length?"0"+t:t}).join("")},toString:function(){return 0===this._rgba[3]?"transparent":this.toRgbaString()}}),h.fn.parse.prototype=h.fn,c.hsla.to=function(t){if (null==t[0]||null==t[1]||null==t[2])return[null,null,null,t[3]];var e,i,s=t[0]/255,n=t[1]/255,o=t[2]/255,a=t[3],r=Math.max(s,n,o),l=Math.min(s,n,o),h=r-l,c=r+l,u=.5*c;return e=l===r?0:s===r?60*(n-o)/h+360:n===r?60*(o-s)/h+120:60*(s-n)/h+240,i=0===h?0:.5>=u?h/c:h/(2-c),[Math.round(e)%360,i,u,null==a?1:a]},c.hsla.from=function(t){if (null==t[0]||null==t[1]||null==t[2])return[null,null,null,t[3]];var e=t[0]/360,i=t[1],s=t[2],o=t[3],a=.5>=s?s*(1+i):s+i-s*i,r=2*s-a;return[Math.round(255*n(r,a,e+1/3)),Math.round(255*n(r,a,e)),Math.round(255*n(r,a,e-1/3)),o]},f(c,function(s,n){var o=n.props,a=n.cache,l=n.to,c=n.from;h.fn[s]=function(s){if (l&&!this[a]&&(this[a]=l(this._rgba)),s===e)return this[a].slice();var n,r=t.type(s),u="array"===r||"object"===r?s:arguments,d=this[a].slice();return f(o,function(t,e){var s=u["object"===r?t:e.idx];null==s&&(s=d[e.idx]),d[e.idx]=i(s,e)}),c?(n=h(c(d)),n[a]=d,n):h(d)},f(o,function(e,i){h.fn[e]||(h.fn[e]=function(n){var o,a=t.type(n),l="alpha"===e?this._hsla?"hsla":"rgba":s,h=this[l](),c=h[i.idx];return"undefined"===a?c:("function"===a&&(n=n.call(this,c),a=t.type(n)),null==n&&i.empty?this:("string"===a&&(o=r.exec(n),o&&(n=c+parseFloat(o[2])*("+"===o[1]?1:-1))),h[i.idx]=n,this[l](h)))})})}),h.hook=function(e){var i=e.split(" ");f(i,function(e,i){t.cssHooks[i]={set:function(e,n){var o,a,r="";if ("transparent"!==n&&("string"!==t.type(n)||(o=s(n)))){if (n=h(o||n),!d.rgba&&1!==n._rgba[3]){for(a="backgroundColor"===i?e.parentNode:e;(""===r||"transparent"===r)&&a&&a.style;)try{r=t.css(a,"backgroundColor"),a=a.parentNode}catch(l){}n=n.blend(r&&"transparent"!==r?r:"_default")}n=n.toRgbaString()}try{e.style[i]=n}catch(l){}}},t.fx.step[i]=function(e){e.colorInit||(e.start=h(e.elem,i),e.end=h(e.end),e.colorInit=!0),t.cssHooks[i].set(e.elem,e.start.transition(e.end,e.pos))}})},h.hook(a),t.cssHooks.borderColor={expand:function(t){var e={};return f(["Top","Right","Bottom","Left"],function(i,s){e["border"+s+"Color"]=t}),e}},o=t.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}}(g),function(){function e(e){var i,s,n=e.ownerDocument.defaultView?e.ownerDocument.defaultView.getComputedStyle(e,null):e.currentStyle,o={};if (n&&n.length&&n[0]&&n[n[0]])for(s=n.length;s--;)i=n[s],"string"==typeof n[i]&&(o[t.camelCase(i)]=n[i]);else for(i in n)"string"==typeof n[i]&&(o[i]=n[i]);return o}function i(e,i){var s,o,a={};for(s in i)o=i[s],e[s]!==o&&(n[s]||(t.fx.step[s]||!isNaN(parseFloat(o)))&&(a[s]=o));return a}var s=["add","remove","toggle"],n={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};t.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(e,i){t.fx.step[i]=function(t){("none"!==t.end&&!t.setAttr||1===t.pos&&!t.setAttr)&&(g.style(t.elem,i,t.end),t.setAttr=!0)}}),t.fn.addBack||(t.fn.addBack=function(t){return this.add(null==t?this.prevObject:this.prevObject.filter(t))}),t.effects.animateClass=function(n,o,a,r){var l=t.speed(o,a,r);return this.queue(function(){var o,a=t(this),r=a.attr("class")||"",h=l.children?a.find("*").addBack():a;h=h.map(function(){var i=t(this);return{el:i,start:e(this)}}),o=function(){t.each(s,function(t,e){n[e]&&a[e+"Class"](n[e])})},o(),h=h.map(function(){return this.end=e(this.el[0]),this.diff=i(this.start,this.end),this}),a.attr("class",r),h=h.map(function(){var e=this,i=t.Deferred(),s=t.extend({},l,{queue:!1,complete:function(){i.resolve(e)}});return this.el.animate(this.diff,s),i.promise()}),t.when.apply(t,h.get()).done(function(){o(),t.each(arguments,function(){var e=this.el;t.each(this.diff,function(t){e.css(t,"")})}),l.complete.call(a[0])})})},t.fn.extend({addClass:function(e){return function(i,s,n,o){return s?t.effects.animateClass.call(this,{add:i},s,n,o):e.apply(this,arguments)}}(t.fn.addClass),removeClass:function(e){return function(i,s,n,o){return arguments.length>1?t.effects.animateClass.call(this,{remove:i},s,n,o):e.apply(this,arguments)}}(t.fn.removeClass),toggleClass:function(e){return function(i,s,n,o,a){return"boolean"==typeof s||void 0===s?n?t.effects.animateClass.call(this,s?{add:i}:{remove:i},n,o,a):e.apply(this,arguments):t.effects.animateClass.call(this,{toggle:i},s,n,o)}}(t.fn.toggleClass),switchClass:function(e,i,s,n,o){return t.effects.animateClass.call(this,{add:i,remove:e},s,n,o)}})}(),function(){function e(e,i,s,n){return t.isPlainObject(e)&&(i=e,e=e.effect),e={effect:e},null==i&&(i={}),t.isFunction(i)&&(n=i,s=null,i={}),("number"==typeof i||t.fx.speeds[i])&&(n=s,s=i,i={}),t.isFunction(s)&&(n=s,s=null),i&&t.extend(e,i),s=s||i.duration,e.duration=t.fx.off?0:"number"==typeof s?s:s in t.fx.speeds?t.fx.speeds[s]:t.fx.speeds._default,e.complete=n||i.complete,e}function i(e){return!e||"number"==typeof e||t.fx.speeds[e]?!0:"string"!=typeof e||t.effects.effect[e]?t.isFunction(e)?!0:"object"!=typeof e||e.effect?!1:!0:!0}function s(t,e){var i=e.outerWidth(),s=e.outerHeight(),n=/^rect\((-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto),?\s*(-?\d*\.?\d*px|-?\d+%|auto)\)$/,o=n.exec(t)||["",0,i,s,0];return{top:parseFloat(o[1])||0,right:"auto"===o[2]?i:parseFloat(o[2]),bottom:"auto"===o[3]?s:parseFloat(o[3]),left:parseFloat(o[4])||0}}t.expr&&t.expr.filters&&t.expr.filters.animated&&(t.expr.filters.animated=function(e){return function(i){return!!t(i).data(f)||e(i)}}(t.expr.filters.animated)),t.uiBackCompat!==!1&&t.extend(t.effects,{save:function(t,e){for(var i=0,s=e.length;s>i;i++)null!==e[i]&&t.data(d+e[i],t[0].style[e[i]])},restore:function(t,e){for(var i,s=0,n=e.length;n>s;s++)null!==e[s]&&(i=t.data(d+e[s]),t.css(e[s],i))},setMode:function(t,e){return"toggle"===e&&(e=t.is(":hidden")?"show":"hide"),e},createWrapper:function(e){if (e.parent().is(".ui-effects-wrapper"))return e.parent();var i={width:e.outerWidth(!0),height:e.outerHeight(!0),"float":e.css("float")},s=t("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),n={width:e.width(),height:e.height()},o=document.activeElement;try{o.id}catch(a){o=document.body}return e.wrap(s),(e[0]===o||t.contains(e[0],o))&&t(o).trigger("focus"),s=e.parent(),"static"===e.css("position")?(s.css({position:"relative"}),e.css({position:"relative"})):(t.extend(i,{position:e.css("position"),zIndex:e.css("z-index")}),t.each(["top","left","bottom","right"],function(t,s){i[s]=e.css(s),isNaN(parseInt(i[s],10))&&(i[s]="auto")}),e.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),e.css(n),s.css(i).show()},removeWrapper:function(e){var i=document.activeElement;return e.parent().is(".ui-effects-wrapper")&&(e.parent().replaceWith(e),(e[0]===i||t.contains(e[0],i))&&t(i).trigger("focus")),e}}),t.extend(t.effects,{version:"1.12.1",define:function(e,i,s){return s||(s=i,i="effect"),t.effects.effect[e]=s,t.effects.effect[e].mode=i,s},scaledDimensions:function(t,e,i){if (0===e)return{height:0,width:0,outerHeight:0,outerWidth:0};var s="horizontal"!==i?(e||100)/100:1,n="vertical"!==i?(e||100)/100:1;return{height:t.height()*n,width:t.width()*s,outerHeight:t.outerHeight()*n,outerWidth:t.outerWidth()*s}},clipToBox:function(t){return{width:t.clip.right-t.clip.left,height:t.clip.bottom-t.clip.top,left:t.clip.left,top:t.clip.top}},unshift:function(t,e,i){var s=t.queue();e>1&&s.splice.apply(s,[1,0].concat(s.splice(e,i))),t.dequeue()},saveStyle:function(t){t.data(p,t[0].style.cssText)},restoreStyle:function(t){t[0].style.cssText=t.data(p)||"",t.removeData(p)},mode:function(t,e){var i=t.is(":hidden");return"toggle"===e&&(e=i?"show":"hide"),(i?"hide"===e:"show"===e)&&(e="none"),e},getBaseline:function(t,e){var i,s;switch(t[0]){case"top":i=0;break;case"middle":i=.5;break;case"bottom":i=1;break;default:i=t[0]/e.height}switch(t[1]){case"left":s=0;break;case"center":s=.5;break;case"right":s=1;break;default:s=t[1]/e.width}return{x:s,y:i}},createPlaceholder:function(e){var i,s=e.css("position"),n=e.position();return e.css({marginTop:e.css("marginTop"),marginBottom:e.css("marginBottom"),marginLeft:e.css("marginLeft"),marginRight:e.css("marginRight")}).outerWidth(e.outerWidth()).outerHeight(e.outerHeight()),/^(static|relative)/.test(s)&&(s="absolute",i=t("<"+e[0].nodeName+">").insertAfter(e).css({display:/^(inline|ruby)/.test(e.css("display"))?"inline-block":"block",visibility:"hidden",marginTop:e.css("marginTop"),marginBottom:e.css("marginBottom"),marginLeft:e.css("marginLeft"),marginRight:e.css("marginRight"),"float":e.css("float")}).outerWidth(e.outerWidth()).outerHeight(e.outerHeight()).addClass("ui-effects-placeholder"),e.data(d+"placeholder",i)),e.css({position:s,left:n.left,top:n.top}),i},removePlaceholder:function(t){var e=d+"placeholder",i=t.data(e);i&&(i.remove(),t.removeData(e))},cleanUp:function(e){t.effects.restoreStyle(e),t.effects.removePlaceholder(e)},setTransition:function(e,i,s,n){return n=n||{},t.each(i,function(t,i){var o=e.cssUnit(i);o[0]>0&&(n[i]=o[0]*s+o[1])}),n}}),t.fn.extend({effect:function(){function i(e){function i(){r.removeData(f),t.effects.cleanUp(r),"hide"===s.mode&&r.hide(),a()}function a(){t.isFunction(l)&&l.call(r[0]),t.isFunction(e)&&e()}var r=t(this);s.mode=c.shift(),t.uiBackCompat===!1||o?"none"===s.mode?(r[h](),a()):n.call(r[0],s,i):(r.is(":hidden")?"hide"===h:"show"===h)?(r[h](),a()):n.call(r[0],s,a)}var s=e.apply(this,arguments),n=t.effects.effect[s.effect],o=n.mode,a=s.queue,r=a||"fx",l=s.complete,h=s.mode,c=[],u=function(e){var i=t(this),s=t.effects.mode(i,h)||o;i.data(f,!0),c.push(s),o&&("show"===s||s===o&&"hide"===s)&&i.show(),o&&"none"===s||t.effects.saveStyle(i),t.isFunction(e)&&e()};return t.fx.off||!n?h?this[h](s.duration,l):this.each(function(){l&&l.call(this)}):a===!1?this.each(u).each(i):this.queue(r,u).queue(r,i)},show:function(t){return function(s){if (i(s))return t.apply(this,arguments);var n=e.apply(this,arguments);return n.mode="show",this.effect.call(this,n)}}(t.fn.show),hide:function(t){return function(s){if (i(s))return t.apply(this,arguments);var n=e.apply(this,arguments);return n.mode="hide",this.effect.call(this,n)}}(t.fn.hide),toggle:function(t){return function(s){if (i(s)||"boolean"==typeof s)return t.apply(this,arguments);var n=e.apply(this,arguments);return n.mode="toggle",this.effect.call(this,n)}}(t.fn.toggle),cssUnit:function(e){var i=this.css(e),s=[];return t.each(["em","px","%","pt"],function(t,e){i.indexOf(e)>0&&(s=[parseFloat(i),e])}),s},cssClip:function(t){return t?this.css("clip","rect("+t.top+"px "+t.right+"px "+t.bottom+"px "+t.left+"px)"):s(this.css("clip"),this)},transfer:function(e,i){var s=t(this),n=t(e.to),o="fixed"===n.css("position"),a=t("body"),r=o?a.scrollTop():0,l=o?a.scrollLeft():0,h=n.offset(),c={top:h.top-r,left:h.left-l,height:n.innerHeight(),width:n.innerWidth()},u=s.offset(),d=t("<div class='ui-effects-transfer'></div>").appendTo("body").addClass(e.className).css({top:u.top-r,left:u.left-l,height:s.innerHeight(),width:s.innerWidth(),position:o?"fixed":"absolute"}).animate(c,e.duration,e.easing,function(){d.remove(),t.isFunction(i)&&i()})}}),t.fx.step.clip=function(e){e.clipInit||(e.start=t(e.elem).cssClip(),"string"==typeof e.end&&(e.end=s(e.end,e.elem)),e.clipInit=!0),t(e.elem).cssClip({top:e.pos*(e.end.top-e.start.top)+e.start.top,right:e.pos*(e.end.right-e.start.right)+e.start.right,bottom:e.pos*(e.end.bottom-e.start.bottom)+e.start.bottom,left:e.pos*(e.end.left-e.start.left)+e.start.left})}}(),function(){var e={};t.each(["Quad","Cubic","Quart","Quint","Expo"],function(t,i){e[i]=function(e){return Math.pow(e,t+2)}}),t.extend(e,{Sine:function(t){return 1-Math.cos(t*Math.PI/2)},Circ:function(t){return 1-Math.sqrt(1-t*t)},Elastic:function(t){return 0===t||1===t?t:-Math.pow(2,8*(t-1))*Math.sin((80*(t-1)-7.5)*Math.PI/15)},Back:function(t){return t*t*(3*t-2)},Bounce:function(t){for(var e,i=4;((e=Math.pow(2,--i))-1)/11>t;);return 1/Math.pow(4,3-i)-7.5625*Math.pow((3*e-2)/22-t,2)}}),t.each(e,function(e,i){t.easing["easeIn"+e]=i,t.easing["easeOut"+e]=function(t){return 1-i(1-t)},t.easing["easeInOut"+e]=function(t){return.5>t?i(2*t)/2:1-i(-2*t+2)/2}})}();var m=t.effects;t.effects.define("blind","hide",function(e,i){var s={up:["bottom","top"],vertical:["bottom","top"],down:["top","bottom"],left:["right","left"],horizontal:["right","left"],right:["left","right"]},n=t(this),o=e.direction||"up",a=n.cssClip(),r={clip:t.extend({},a)},l=t.effects.createPlaceholder(n);r.clip[s[o][0]]=r.clip[s[o][1]],"show"===e.mode&&(n.cssClip(r.clip),l&&l.css(t.effects.clipToBox(r)),r.clip=a),l&&l.animate(t.effects.clipToBox(r),e.duration,e.easing),n.animate(r,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("bounce",function(e,i){var s,n,o,a=t(this),r=e.mode,l="hide"===r,h="show"===r,c=e.direction||"up",u=e.distance,d=e.times||5,p=2*d+(h||l?1:0),f=e.duration/p,g=e.easing,m="up"===c||"down"===c?"top":"left",_="up"===c||"left"===c,v=0,b=a.queue().length;for(t.effects.createPlaceholder(a),o=a.css(m),u||(u=a["top"===m?"outerHeight":"outerWidth"]()/3),h&&(n={opacity:1},n[m]=o,a.css("opacity",0).css(m,_?2*-u:2*u).animate(n,f,g)),l&&(u/=Math.pow(2,d-1)),n={},n[m]=o;d>v;v++)s={},s[m]=(_?"-=":"+=")+u,a.animate(s,f,g).animate(n,f,g),u=l?2*u:u/2;l&&(s={opacity:0},s[m]=(_?"-=":"+=")+u,a.animate(s,f,g)),a.queue(i),t.effects.unshift(a,b,p+1)}),t.effects.define("clip","hide",function(e,i){var s,n={},o=t(this),a=e.direction||"vertical",r="both"===a,l=r||"horizontal"===a,h=r||"vertical"===a;s=o.cssClip(),n.clip={top:h?(s.bottom-s.top)/2:s.top,right:l?(s.right-s.left)/2:s.right,bottom:h?(s.bottom-s.top)/2:s.bottom,left:l?(s.right-s.left)/2:s.left},t.effects.createPlaceholder(o),"show"===e.mode&&(o.cssClip(n.clip),n.clip=s),o.animate(n,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("drop","hide",function(e,i){var s,n=t(this),o=e.mode,a="show"===o,r=e.direction||"left",l="up"===r||"down"===r?"top":"left",h="up"===r||"left"===r?"-=":"+=",c="+="===h?"-=":"+=",u={opacity:0};t.effects.createPlaceholder(n),s=e.distance||n["top"===l?"outerHeight":"outerWidth"](!0)/2,u[l]=h+s,a&&(n.css(u),u[l]=c+s,u.opacity=1),n.animate(u,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("explode","hide",function(e,i){function s(){b.push(this),b.length===u*d&&n()}function n(){p.css({visibility:"visible"}),t(b).remove(),i()}var o,a,r,l,h,c,u=e.pieces?Math.round(Math.sqrt(e.pieces)):3,d=u,p=t(this),f=e.mode,g="show"===f,m=p.show().css("visibility","hidden").offset(),_=Math.ceil(p.outerWidth()/d),v=Math.ceil(p.outerHeight()/u),b=[];for(o=0;u>o;o++)for(l=m.top+o*v,c=o-(u-1)/2,a=0;d>a;a++)r=m.left+a*_,h=a-(d-1)/2,p.clone().appendTo("body").wrap("<div></div>").css({position:"absolute",visibility:"visible",left:-a*_,top:-o*v}).parent().addClass("ui-effects-explode").css({position:"absolute",overflow:"hidden",width:_,height:v,left:r+(g?h*_:0),top:l+(g?c*v:0),opacity:g?0:1}).animate({left:r+(g?0:h*_),top:l+(g?0:c*v),opacity:g?1:0},e.duration||500,e.easing,s)}),t.effects.define("fade","toggle",function(e,i){var s="show"===e.mode;t(this).css("opacity",s?0:1).animate({opacity:s?1:0},{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("fold","hide",function(e,i){var s=t(this),n=e.mode,o="show"===n,a="hide"===n,r=e.size||15,l=/([0-9]+)%/.exec(r),h=!!e.horizFirst,c=h?["right","bottom"]:["bottom","right"],u=e.duration/2,d=t.effects.createPlaceholder(s),p=s.cssClip(),f={clip:t.extend({},p)},g={clip:t.extend({},p)},m=[p[c[0]],p[c[1]]],_=s.queue().length;l&&(r=parseInt(l[1],10)/100*m[a?0:1]),f.clip[c[0]]=r,g.clip[c[0]]=r,g.clip[c[1]]=0,o&&(s.cssClip(g.clip),d&&d.css(t.effects.clipToBox(g)),g.clip=p),s.queue(function(i){d&&d.animate(t.effects.clipToBox(f),u,e.easing).animate(t.effects.clipToBox(g),u,e.easing),i()}).animate(f,u,e.easing).animate(g,u,e.easing).queue(i),t.effects.unshift(s,_,4)}),t.effects.define("highlight","show",function(e,i){var s=t(this),n={backgroundColor:s.css("backgroundColor")};"hide"===e.mode&&(n.opacity=0),t.effects.saveStyle(s),s.css({backgroundImage:"none",backgroundColor:e.color||"#ffff99"}).animate(n,{queue:!1,duration:e.duration,easing:e.easing,complete:i})}),t.effects.define("size",function(e,i){var s,n,o,a=t(this),r=["fontSize"],l=["borderTopWidth","borderBottomWidth","paddingTop","paddingBottom"],h=["borderLeftWidth","borderRightWidth","paddingLeft","paddingRight"],c=e.mode,u="effect"!==c,d=e.scale||"both",p=e.origin||["middle","center"],f=a.css("position"),g=a.position(),m=t.effects.scaledDimensions(a),_=e.from||m,v=e.to||t.effects.scaledDimensions(a,0);t.effects.createPlaceholder(a),"show"===c&&(o=_,_=v,v=o),n={from:{y:_.height/m.height,x:_.width/m.width},to:{y:v.height/m.height,x:v.width/m.width}},("box"===d||"both"===d)&&(n.from.y!==n.to.y&&(_=t.effects.setTransition(a,l,n.from.y,_),v=t.effects.setTransition(a,l,n.to.y,v)),n.from.x!==n.to.x&&(_=t.effects.setTransition(a,h,n.from.x,_),v=t.effects.setTransition(a,h,n.to.x,v))),("content"===d||"both"===d)&&n.from.y!==n.to.y&&(_=t.effects.setTransition(a,r,n.from.y,_),v=t.effects.setTransition(a,r,n.to.y,v)),p&&(s=t.effects.getBaseline(p,m),_.top=(m.outerHeight-_.outerHeight)*s.y+g.top,_.left=(m.outerWidth-_.outerWidth)*s.x+g.left,v.top=(m.outerHeight-v.outerHeight)*s.y+g.top,v.left=(m.outerWidth-v.outerWidth)*s.x+g.left),a.css(_),("content"===d||"both"===d)&&(l=l.concat(["marginTop","marginBottom"]).concat(r),h=h.concat(["marginLeft","marginRight"]),a.find("*[width]").each(function(){var i=t(this),s=t.effects.scaledDimensions(i),o={height:s.height*n.from.y,width:s.width*n.from.x,outerHeight:s.outerHeight*n.from.y,outerWidth:s.outerWidth*n.from.x},a={height:s.height*n.to.y,width:s.width*n.to.x,outerHeight:s.height*n.to.y,outerWidth:s.width*n.to.x};n.from.y!==n.to.y&&(o=t.effects.setTransition(i,l,n.from.y,o),a=t.effects.setTransition(i,l,n.to.y,a)),n.from.x!==n.to.x&&(o=t.effects.setTransition(i,h,n.from.x,o),a=t.effects.setTransition(i,h,n.to.x,a)),u&&t.effects.saveStyle(i),i.css(o),i.animate(a,e.duration,e.easing,function(){u&&t.effects.restoreStyle(i)})})),a.animate(v,{queue:!1,duration:e.duration,easing:e.easing,complete:function(){var e=a.offset();0===v.opacity&&a.css("opacity",_.opacity),u||(a.css("position","static"===f?"relative":f).offset(e),t.effects.saveStyle(a)),i()}})}),t.effects.define("scale",function(e,i){var s=t(this),n=e.mode,o=parseInt(e.percent,10)||(0===parseInt(e.percent,10)?0:"effect"!==n?0:100),a=t.extend(!0,{from:t.effects.scaledDimensions(s),to:t.effects.scaledDimensions(s,o,e.direction||"both"),origin:e.origin||["middle","center"]},e);e.fade&&(a.from.opacity=1,a.to.opacity=0),t.effects.effect.size.call(this,a,i)}),t.effects.define("puff","hide",function(e,i){var s=t.extend(!0,{},e,{fade:!0,percent:parseInt(e.percent,10)||150});t.effects.effect.scale.call(this,s,i)}),t.effects.define("pulsate","show",function(e,i){var s=t(this),n=e.mode,o="show"===n,a="hide"===n,r=o||a,l=2*(e.times||5)+(r?1:0),h=e.duration/l,c=0,u=1,d=s.queue().length;for((o||!s.is(":visible"))&&(s.css("opacity",0).show(),c=1);l>u;u++)s.animate({opacity:c},h,e.easing),c=1-c;s.animate({opacity:c},h,e.easing),s.queue(i),t.effects.unshift(s,d,l+1)}),t.effects.define("shake",function(e,i){var s=1,n=t(this),o=e.direction||"left",a=e.distance||20,r=e.times||3,l=2*r+1,h=Math.round(e.duration/l),c="up"===o||"down"===o?"top":"left",u="up"===o||"left"===o,d={},p={},f={},g=n.queue().length;for(t.effects.createPlaceholder(n),d[c]=(u?"-=":"+=")+a,p[c]=(u?"+=":"-=")+2*a,f[c]=(u?"-=":"+=")+2*a,n.animate(d,h,e.easing);r>s;s++)n.animate(p,h,e.easing).animate(f,h,e.easing);n.animate(p,h,e.easing).animate(d,h/2,e.easing).queue(i),t.effects.unshift(n,g,l+1)}),t.effects.define("slide","show",function(e,i){var s,n,o=t(this),a={up:["bottom","top"],down:["top","bottom"],left:["right","left"],right:["left","right"]},r=e.mode,l=e.direction||"left",h="up"===l||"down"===l?"top":"left",c="up"===l||"left"===l,u=e.distance||o["top"===h?"outerHeight":"outerWidth"](!0),d={};t.effects.createPlaceholder(o),s=o.cssClip(),n=o.position()[h],d[h]=(c?-1:1)*u+n,d.clip=o.cssClip(),d.clip[a[l][1]]=d.clip[a[l][0]],"show"===r&&(o.cssClip(d.clip),o.css(h,d[h]),d.clip=s,d[h]=n),o.animate(d,{queue:!1,duration:e.duration,easing:e.easing,complete:i})});var m;t.uiBackCompat!==!1&&(m=t.effects.define("transfer",function(e,i){t(this).transfer(e,i)}))});




function inherits(descendant, parent) {
	var keys = [];

	// Only iterate the keys if we were given an object, and
	// a special check for null, as typeof null == "object"
	if (typeof parent === "object" && parent !== null) {	
		// Use a standard for in loop
		for (var x in parent) {
			// A for in will iterate over members on the prototype
			// chain as well, but Object.getOwnPropertyNames returns
			// only those directly on the object, so use hasOwnProperty.
			if (parent.hasOwnProperty(x)) {
				keys.push(x);
			}
		}
	}
	
	for (var i=0; i<keys.length; i++){
		descendant[keys[i]]=parent[keys[i]];
	}
	
	descendant["parent"]=parent;
};



function idEquals(id1, id2){
	if (AP.data.isInt(id1) && AP.data.isInt(id2)){
		return parseInt(id1) === parseInt(id2);
	}
	
	return id1 === id2;
}


function isset(value){
	if (value === null || typeof(value) == "undefined"){
		return false;
	}
	
	return true;
};


function inverse(val){
	if (val && parseInt(val)){
		return 0;
	}
	
	return 1;
};

if (!String.prototype.padStart){
	String.prototype.padStart = function padStart(targetLength,padString) {
		targetLength = targetLength>>0; //truncate if number or convert non-number to 0;
		padString = String((typeof padString !== 'undefined' ? padString : ' '));
		if (this.length > targetLength) {
			return String(this);
		}
		else {
			targetLength = targetLength-this.length;
			if (targetLength > padString.length) {
				padString += padString.repeat(targetLength/padString.length); //append to original to ensure we are longer than needed
			}
			return padString.slice(0,targetLength) + String(this);
		}
	};
}
 



!function(a){function b(a){var b=a.length,d=c.type(a);return"function"===d||c.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===d||0===b||"number"==typeof b&&b>0&&b-1 in a}if (!a.jQuery){var c=function(a,b){return new c.fn.init(a,b)};c.isWindow=function(a){return null!=a&&a==a.window},c.type=function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?e[g.call(a)]||"object":typeof a},c.isArray=Array.isArray||function(a){return"array"===c.type(a)},c.isPlainObject=function(a){var b;if (!a||"object"!==c.type(a)||a.nodeType||c.isWindow(a))return!1;try{if (a.constructor&&!f.call(a,"constructor")&&!f.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(d){return!1}for(b in a);return void 0===b||f.call(a,b)},c.each=function(a,c,d){var e,f=0,g=a.length,h=b(a);if (d){if (h)for(;g>f&&(e=c.apply(a[f],d),e!==!1);f++);else for(f in a)if (e=c.apply(a[f],d),e===!1)break}else if (h)for(;g>f&&(e=c.call(a[f],f,a[f]),e!==!1);f++);else for(f in a)if (e=c.call(a[f],f,a[f]),e===!1)break;return a},c.data=function(a,b,e){if (void 0===e){var f=a[c.expando],g=f&&d[f];if (void 0===b)return g;if (g&&b in g)return g[b]}else if (void 0!==b){var f=a[c.expando]||(a[c.expando]=++c.uuid);return d[f]=d[f]||{},d[f][b]=e,e}},c.removeData=function(a,b){var e=a[c.expando],f=e&&d[e];f&&c.each(b,function(a,b){delete f[b]})},c.extend=function(){var a,b,d,e,f,g,h=arguments[0]||{},i=1,j=arguments.length,k=!1;for("boolean"==typeof h&&(k=h,h=arguments[i]||{},i++),"object"!=typeof h&&"function"!==c.type(h)&&(h={}),i===j&&(h=this,i--);j>i;i++)if (null!=(f=arguments[i]))for(e in f)a=h[e],d=f[e],h!==d&&(k&&d&&(c.isPlainObject(d)||(b=c.isArray(d)))?(b?(b=!1,g=a&&c.isArray(a)?a:[]):g=a&&c.isPlainObject(a)?a:{},h[e]=c.extend(k,g,d)):void 0!==d&&(h[e]=d));return h},c.queue=function(a,d,e){function f(a,c){var d=c||[];return null!=a&&(b(Object(a))?!function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;)a[e++]=b[d++];if (c!==c)for(;void 0!==b[d];)a[e++]=b[d++];return a.length=e,a}(d,"string"==typeof a?[a]:a):[].push.call(d,a)),d}if (a){d=(d||"fx")+"queue";var g=c.data(a,d);return e?(!g||c.isArray(e)?g=c.data(a,d,f(e)):g.push(e),g):g||[]}},c.dequeue=function(a,b){c.each(a.nodeType?[a]:a,function(a,d){b=b||"fx";var e=c.queue(d,b),f=e.shift();"inprogress"===f&&(f=e.shift()),f&&("fx"===b&&e.unshift("inprogress"),f.call(d,function(){c.dequeue(d,b)}))})},c.fn=c.prototype={init:function(a){if (a.nodeType)return this[0]=a,this;throw new Error("Not a DOM node.")},offset:function(){var b=this[0].getBoundingClientRect?this[0].getBoundingClientRect():{top:0,left:0};return{top:b.top+(a.pageYOffset||document.scrollTop||0)-(document.clientTop||0),left:b.left+(a.pageXOffset||document.scrollLeft||0)-(document.clientLeft||0)}},position:function(){function a(){for(var a=this.offsetParent||document;a&&"html"===!a.nodeType.toLowerCase&&"static"===a.style.position;)a=a.offsetParent;return a||document}var b=this[0],a=a.apply(b),d=this.offset(),e=/^(?:body|html)$/i.test(a.nodeName)?{top:0,left:0}:c(a).offset();return d.top-=parseFloat(b.style.marginTop)||0,d.left-=parseFloat(b.style.marginLeft)||0,a.style&&(e.top+=parseFloat(a.style.borderTopWidth)||0,e.left+=parseFloat(a.style.borderLeftWidth)||0),{top:d.top-e.top,left:d.left-e.left}}};var d={};c.expando="velocity"+(new Date).getTime(),c.uuid=0;for(var e={},f=e.hasOwnProperty,g=e.toString,h="Boolean Number String Function Array Date RegExp Object Error".split(" "),i=0;i<h.length;i++)e["[object "+h[i]+"]"]=h[i].toLowerCase();c.fn.init.prototype=c.fn,a.Velocity={Utilities:c}}}(window),function(a){"object"==typeof module&&"object"==typeof module.exports?module.exports=a():"function"==typeof define&&define.amd?define(a):a()}(function(){return function(a,b,c,d){function e(a){for(var b=-1,c=a?a.length:0,d=[];++b<c;){var e=a[b];e&&d.push(e)}return d}function f(a){return p.isWrapped(a)?a=[].slice.call(a):p.isNode(a)&&(a=[a]),a}function g(a){var b=m.data(a,"velocity");return null===b?d:b}function h(a){return function(b){return Math.round(b*a)*(1/a)}}function i(a,c,d,e){function f(a,b){return 1-3*b+3*a}function g(a,b){return 3*b-6*a}function h(a){return 3*a}function i(a,b,c){return((f(b,c)*a+g(b,c))*a+h(b))*a}function j(a,b,c){return 3*f(b,c)*a*a+2*g(b,c)*a+h(b)}function k(b,c){for(var e=0;p>e;++e){var f=j(c,a,d);if (0===f)return c;var g=i(c,a,d)-b;c-=g/f}return c}function l(){for(var b=0;t>b;++b)x[b]=i(b*u,a,d)}function m(b,c,e){var f,g,h=0;do g=c+(e-c)/2,f=i(g,a,d)-b,f>0?e=g:c=g;while(Math.abs(f)>r&&++h<s);return g}function n(b){for(var c=0,e=1,f=t-1;e!=f&&x[e]<=b;++e)c+=u;--e;var g=(b-x[e])/(x[e+1]-x[e]),h=c+g*u,i=j(h,a,d);return i>=q?k(b,h):0==i?h:m(b,c,c+u)}function o(){y=!0,(a!=c||d!=e)&&l()}var p=4,q=.001,r=1e-7,s=10,t=11,u=1/(t-1),v="Float32Array"in b;if (4!==arguments.length)return!1;for(var w=0;4>w;++w)if ("number"!=typeof arguments[w]||isNaN(arguments[w])||!isFinite(arguments[w]))return!1;a=Math.min(a,1),d=Math.min(d,1),a=Math.max(a,0),d=Math.max(d,0);var x=v?new Float32Array(t):new Array(t),y=!1,z=function(b){return y||o(),a===c&&d===e?b:0===b?0:1===b?1:i(n(b),c,e)};z.getControlPoints=function(){return[{x:a,y:c},{x:d,y:e}]};var A="generateBezier("+[a,c,d,e]+")";return z.toString=function(){return A},z}function j(a,b){var c=a;return p.isString(a)?t.Easings[a]||(c=!1):c=p.isArray(a)&&1===a.length?h.apply(null,a):p.isArray(a)&&2===a.length?u.apply(null,a.concat([b])):p.isArray(a)&&4===a.length?i.apply(null,a):!1,c===!1&&(c=t.Easings[t.defaults.easing]?t.defaults.easing:s),c}function k(a){if (a){var b=(new Date).getTime(),c=t.State.calls.length;c>1e4&&(t.State.calls=e(t.State.calls));for(var f=0;c>f;f++)if (t.State.calls[f]){var h=t.State.calls[f],i=h[0],j=h[2],n=h[3],o=!!n,q=null;n||(n=t.State.calls[f][3]=b-16);for(var r=Math.min((b-n)/j.duration,1),s=0,u=i.length;u>s;s++){var w=i[s],y=w.element;if (g(y)){var z=!1;if (j.display!==d&&null!==j.display&&"none"!==j.display){if ("flex"===j.display){var A=["-webkit-box","-moz-box","-ms-flexbox","-webkit-flex"];m.each(A,function(a,b){v.setPropertyValue(y,"display",b)})}v.setPropertyValue(y,"display",j.display)}j.visibility!==d&&"hidden"!==j.visibility&&v.setPropertyValue(y,"visibility",j.visibility);for(var B in w)if ("element"!==B){var C,D=w[B],E=p.isString(D.easing)?t.Easings[D.easing]:D.easing;if (1===r)C=D.endValue;else{var F=D.endValue-D.startValue;if (C=D.startValue+F*E(r,j,F),!o&&C===D.currentValue)continue}if (D.currentValue=C,"tween"===B)q=C;else{if (v.Hooks.registered[B]){var G=v.Hooks.getRoot(B),H=g(y).rootPropertyValueCache[G];H&&(D.rootPropertyValue=H)}var I=v.setPropertyValue(y,B,D.currentValue+(0===parseFloat(C)?"":D.unitType),D.rootPropertyValue,D.scrollData);v.Hooks.registered[B]&&(g(y).rootPropertyValueCache[G]=v.Normalizations.registered[G]?v.Normalizations.registered[G]("extract",null,I[1]):I[1]),"transform"===I[0]&&(z=!0)}}j.mobileHA&&g(y).transformCache.translate3d===d&&(g(y).transformCache.translate3d="(0px, 0px, 0px)",z=!0),z&&v.flushTransformCache(y)}}j.display!==d&&"none"!==j.display&&(t.State.calls[f][2].display=!1),j.visibility!==d&&"hidden"!==j.visibility&&(t.State.calls[f][2].visibility=!1),j.progress&&j.progress.call(h[1],h[1],r,Math.max(0,n+j.duration-b),n,q),1===r&&l(f)}}t.State.isTicking&&x(k)}function l(a,b){if (!t.State.calls[a])return!1;for(var c=t.State.calls[a][0],e=t.State.calls[a][1],f=t.State.calls[a][2],h=t.State.calls[a][4],i=!1,j=0,k=c.length;k>j;j++){var l=c[j].element;if (b||f.loop||("none"===f.display&&v.setPropertyValue(l,"display",f.display),"hidden"===f.visibility&&v.setPropertyValue(l,"visibility",f.visibility)),f.loop!==!0&&(m.queue(l)[1]===d||!/\.velocityQueueEntryFlag/i.test(m.queue(l)[1]))&&g(l)){g(l).isAnimating=!1,g(l).rootPropertyValueCache={};var n=!1;m.each(v.Lists.transforms3D,function(a,b){var c=/^scale/.test(b)?1:0,e=g(l).transformCache[b];g(l).transformCache[b]!==d&&new RegExp("^\\("+c+"[^.]").test(e)&&(n=!0,delete g(l).transformCache[b])}),f.mobileHA&&(n=!0,delete g(l).transformCache.translate3d),n&&v.flushTransformCache(l),v.Values.removeClass(l,"velocity-animating")}if (!b&&f.complete&&!f.loop&&j===k-1)try{f.complete.call(e,e)}catch(o){setTimeout(function(){throw o},1)}h&&f.loop!==!0&&h(e),g(l)&&f.loop===!0&&!b&&(m.each(g(l).tweensContainer,function(a,b){/^rotate/.test(a)&&360===parseFloat(b.endValue)&&(b.endValue=0,b.startValue=360),/^backgroundPosition/.test(a)&&100===parseFloat(b.endValue)&&"%"===b.unitType&&(b.endValue=0,b.startValue=100)}),t(l,"reverse",{loop:!0,delay:f.delay})),f.queue!==!1&&m.dequeue(l,f.queue)}t.State.calls[a]=!1;for(var p=0,q=t.State.calls.length;q>p;p++)if (t.State.calls[p]!==!1){i=!0;break}i===!1&&(t.State.isTicking=!1,delete t.State.calls,t.State.calls=[])}var m,n=function(){if (c.documentMode)return c.documentMode;for(var a=7;a>4;a--){var b=c.createElement("div");if (b.innerHTML="<!--[if IE "+a+"]><span></span><![endif]-->",b.getElementsByTagName("span").length)return b=null,a}return d}(),o=function(){var a=0;return b.webkitRequestAnimationFrame||b.mozRequestAnimationFrame||function(b){var c,d=(new Date).getTime();return c=Math.max(0,16-(d-a)),a=d+c,setTimeout(function(){b(d+c)},c)}}(),p={isString:function(a){return"string"==typeof a},isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},isFunction:function(a){return"[object Function]"===Object.prototype.toString.call(a)},isNode:function(a){return a&&a.nodeType},isNodeList:function(a){return"object"==typeof a&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(Object.prototype.toString.call(a))&&a.length!==d&&(0===a.length||"object"==typeof a[0]&&a[0].nodeType>0)},isWrapped:function(a){return a&&(a.jquery||b.Zepto&&b.Zepto.zepto.isZ(a))},isSVG:function(a){return b.SVGElement&&a instanceof b.SVGElement},isEmptyObject:function(a){for(var b in a)return!1;return!0}},q=!1;if (a.fn&&a.fn.jquery?(m=a,q=!0):m=b.Velocity.Utilities,8>=n&&!q)throw new Error("Velocity: IE8 and below require jQuery to be loaded before Velocity.");if (7>=n)return void(jQuery.fn.velocity=jQuery.fn.animate);var r=400,s="swing",t={State:{isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isAndroid:/Android/i.test(navigator.userAgent),isGingerbread:/Android 2\.3\.[3-7]/i.test(navigator.userAgent),isChrome:b.chrome,isFirefox:/Firefox/i.test(navigator.userAgent),prefixElement:c.createElement("div"),prefixMatches:{},scrollAnchor:null,scrollPropertyLeft:null,scrollPropertyTop:null,isTicking:!1,calls:[]},CSS:{},Utilities:m,Redirects:{},Easings:{},Promise:b.Promise,defaults:{queue:"",duration:r,easing:s,begin:d,complete:d,progress:d,display:d,visibility:d,loop:!1,delay:!1,mobileHA:!0,_cacheValues:!0},init:function(a){m.data(a,"velocity",{isSVG:p.isSVG(a),isAnimating:!1,computedStyle:null,tweensContainer:null,rootPropertyValueCache:{},transformCache:{}})},hook:null,mock:!1,version:{major:1,minor:2,patch:2},debug:!1};b.pageYOffset!==d?(t.State.scrollAnchor=b,t.State.scrollPropertyLeft="pageXOffset",t.State.scrollPropertyTop="pageYOffset"):(t.State.scrollAnchor=c.documentElement||c.body.parentNode||c.body,t.State.scrollPropertyLeft="scrollLeft",t.State.scrollPropertyTop="scrollTop");var u=function(){function a(a){return-a.tension*a.x-a.friction*a.v}function b(b,c,d){var e={x:b.x+d.dx*c,v:b.v+d.dv*c,tension:b.tension,friction:b.friction};return{dx:e.v,dv:a(e)}}function c(c,d){var e={dx:c.v,dv:a(c)},f=b(c,.5*d,e),g=b(c,.5*d,f),h=b(c,d,g),i=1/6*(e.dx+2*(f.dx+g.dx)+h.dx),j=1/6*(e.dv+2*(f.dv+g.dv)+h.dv);return c.x=c.x+i*d,c.v=c.v+j*d,c}return function d(a,b,e){var f,g,h,i={x:-1,v:0,tension:null,friction:null},j=[0],k=0,l=1e-4,m=.016;for(a=parseFloat(a)||500,b=parseFloat(b)||20,e=e||null,i.tension=a,i.friction=b,f=null!==e,f?(k=d(a,b),g=k/e*m):g=m;;)if (h=c(h||i,g),j.push(1+h.x),k+=16,!(Math.abs(h.x)>l&&Math.abs(h.v)>l))break;return f?function(a){return j[a*(j.length-1)|0]}:k}}();t.Easings={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},spring:function(a){return 1-Math.cos(4.5*a*Math.PI)*Math.exp(6*-a)}},m.each([["ease",[.25,.1,.25,1]],["ease-in",[.42,0,1,1]],["ease-out",[0,0,.58,1]],["ease-in-out",[.42,0,.58,1]],["easeInSine",[.47,0,.745,.715]],["easeOutSine",[.39,.575,.565,1]],["easeInOutSine",[.445,.05,.55,.95]],["easeInQuad",[.55,.085,.68,.53]],["easeOutQuad",[.25,.46,.45,.94]],["easeInOutQuad",[.455,.03,.515,.955]],["easeInCubic",[.55,.055,.675,.19]],["easeOutCubic",[.215,.61,.355,1]],["easeInOutCubic",[.645,.045,.355,1]],["easeInQuart",[.895,.03,.685,.22]],["easeOutQuart",[.165,.84,.44,1]],["easeInOutQuart",[.77,0,.175,1]],["easeInQuint",[.755,.05,.855,.06]],["easeOutQuint",[.23,1,.32,1]],["easeInOutQuint",[.86,0,.07,1]],["easeInExpo",[.95,.05,.795,.035]],["easeOutExpo",[.19,1,.22,1]],["easeInOutExpo",[1,0,0,1]],["easeInCirc",[.6,.04,.98,.335]],["easeOutCirc",[.075,.82,.165,1]],["easeInOutCirc",[.785,.135,.15,.86]]],function(a,b){t.Easings[b[0]]=i.apply(null,b[1])});var v=t.CSS={RegEx:{isHex:/^#([A-f\d]{3}){1,2}$/i,valueUnwrap:/^[A-z]+\((.*)\)$/i,wrappedValueAlreadyExtracted:/[0-9.]+ [0-9.]+ [0-9.]+( [0-9.]+)?/,valueSplit:/([A-z]+\(.+\))|(([A-z0-9#-.]+?)(?=\s|$))/gi},Lists:{colors:["fill","stroke","stopColor","color","backgroundColor","borderColor","borderTopColor","borderRightColor","borderBottomColor","borderLeftColor","outlineColor"],transformsBase:["translateX","translateY","scale","scaleX","scaleY","skewX","skewY","rotateZ"],transforms3D:["transformPerspective","translateZ","scaleZ","rotateX","rotateY"]},Hooks:{templates:{textShadow:["Color X Y Blur","black 0px 0px 0px"],boxShadow:["Color X Y Blur Spread","black 0px 0px 0px 0px"],clip:["Top Right Bottom Left","0px 0px 0px 0px"],backgroundPosition:["X Y","0% 0%"],transformOrigin:["X Y Z","50% 50% 0px"],perspectiveOrigin:["X Y","50% 50%"]},registered:{},register:function(){for(var a=0;a<v.Lists.colors.length;a++){var b="color"===v.Lists.colors[a]?"0 0 0 1":"255 255 255 1";v.Hooks.templates[v.Lists.colors[a]]=["Red Green Blue Alpha",b]}var c,d,e;if (n)for(c in v.Hooks.templates){d=v.Hooks.templates[c],e=d[0].split(" ");var f=d[1].match(v.RegEx.valueSplit);"Color"===e[0]&&(e.push(e.shift()),f.push(f.shift()),v.Hooks.templates[c]=[e.join(" "),f.join(" ")])}for(c in v.Hooks.templates){d=v.Hooks.templates[c],e=d[0].split(" ");for(var a in e){var g=c+e[a],h=a;v.Hooks.registered[g]=[c,h]}}},getRoot:function(a){var b=v.Hooks.registered[a];return b?b[0]:a},cleanRootPropertyValue:function(a,b){return v.RegEx.valueUnwrap.test(b)&&(b=b.match(v.RegEx.valueUnwrap)[1]),v.Values.isCSSNullValue(b)&&(b=v.Hooks.templates[a][1]),b},extractValue:function(a,b){var c=v.Hooks.registered[a];if (c){var d=c[0],e=c[1];return b=v.Hooks.cleanRootPropertyValue(d,b),b.toString().match(v.RegEx.valueSplit)[e]}return b},injectValue:function(a,b,c){var d=v.Hooks.registered[a];if (d){var e,f,g=d[0],h=d[1];return c=v.Hooks.cleanRootPropertyValue(g,c),e=c.toString().match(v.RegEx.valueSplit),e[h]=b,f=e.join(" ")}return c}},Normalizations:{registered:{clip:function(a,b,c){switch(a){case"name":return"clip";case"extract":var d;return v.RegEx.wrappedValueAlreadyExtracted.test(c)?d=c:(d=c.toString().match(v.RegEx.valueUnwrap),d=d?d[1].replace(/,(\s+)?/g," "):c),d;case"inject":return"rect("+c+")"}},blur:function(a,b,c){switch(a){case"name":return t.State.isFirefox?"filter":"-webkit-filter";case"extract":var d=parseFloat(c);if (!d&&0!==d){var e=c.toString().match(/blur\(([0-9]+[A-z]+)\)/i);d=e?e[1]:0}return d;case"inject":return parseFloat(c)?"blur("+c+")":"none"}},opacity:function(a,b,c){if (8>=n)switch(a){case"name":return"filter";case"extract":var d=c.toString().match(/alpha\(opacity=(.*)\)/i);return c=d?d[1]/100:1;case"inject":return b.style.zoom=1,parseFloat(c)>=1?"":"alpha(opacity="+parseInt(100*parseFloat(c),10)+")"}else switch(a){case"name":return"opacity";case"extract":return c;case"inject":return c}}},register:function(){9>=n||t.State.isGingerbread||(v.Lists.transformsBase=v.Lists.transformsBase.concat(v.Lists.transforms3D));for(var a=0;a<v.Lists.transformsBase.length;a++)!function(){var b=v.Lists.transformsBase[a];v.Normalizations.registered[b]=function(a,c,e){switch(a){case"name":return"transform";case"extract":return g(c)===d||g(c).transformCache[b]===d?/^scale/i.test(b)?1:0:g(c).transformCache[b].replace(/[()]/g,"");case"inject":var f=!1;switch(b.substr(0,b.length-1)){case"translate":f=!/(%|px|em|rem|vw|vh|\d)$/i.test(e);break;case"scal":case"scale":t.State.isAndroid&&g(c).transformCache[b]===d&&1>e&&(e=1),f=!/(\d)$/i.test(e);break;case"skew":f=!/(deg|\d)$/i.test(e);break;case"rotate":f=!/(deg|\d)$/i.test(e)}return f||(g(c).transformCache[b]="("+e+")"),g(c).transformCache[b]}}}();for(var a=0;a<v.Lists.colors.length;a++)!function(){var b=v.Lists.colors[a];v.Normalizations.registered[b]=function(a,c,e){switch(a){case"name":return b;case"extract":var f;if (v.RegEx.wrappedValueAlreadyExtracted.test(e))f=e;else{var g,h={black:"rgb(0, 0, 0)",blue:"rgb(0, 0, 255)",gray:"rgb(128, 128, 128)",green:"rgb(0, 128, 0)",red:"rgb(255, 0, 0)",white:"rgb(255, 255, 255)"};/^[A-z]+$/i.test(e)?g=h[e]!==d?h[e]:h.black:v.RegEx.isHex.test(e)?g="rgb("+v.Values.hexToRgb(e).join(" ")+")":/^rgba?\(/i.test(e)||(g=h.black),f=(g||e).toString().match(v.RegEx.valueUnwrap)[1].replace(/,(\s+)?/g," ")}return 8>=n||3!==f.split(" ").length||(f+=" 1"),f;case"inject":return 8>=n?4===e.split(" ").length&&(e=e.split(/\s+/).slice(0,3).join(" ")):3===e.split(" ").length&&(e+=" 1"),(8>=n?"rgb":"rgba")+"("+e.replace(/\s+/g,",").replace(/\.(\d)+(?=,)/g,"")+")"}}}()}},Names:{camelCase:function(a){return a.replace(/-(\w)/g,function(a,b){return b.toUpperCase()})},SVGAttribute:function(a){var b="width|height|x|y|cx|cy|r|rx|ry|x1|x2|y1|y2";return(n||t.State.isAndroid&&!t.State.isChrome)&&(b+="|transform"),new RegExp("^("+b+")$","i").test(a)},prefixCheck:function(a){if (t.State.prefixMatches[a])return[t.State.prefixMatches[a],!0];for(var b=["","Webkit","Moz","ms","O"],c=0,d=b.length;d>c;c++){var e;if (e=0===c?a:b[c]+a.replace(/^\w/,function(a){return a.toUpperCase()}),p.isString(t.State.prefixElement.style[e]))return t.State.prefixMatches[a]=e,[e,!0]}return[a,!1]}},Values:{hexToRgb:function(a){var b,c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,d=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i;return a=a.replace(c,function(a,b,c,d){return b+b+c+c+d+d}),b=d.exec(a),b?[parseInt(b[1],16),parseInt(b[2],16),parseInt(b[3],16)]:[0,0,0]},isCSSNullValue:function(a){return 0==a||/^(none|auto|transparent|(rgba\(0, ?0, ?0, ?0\)))$/i.test(a)},getUnitType:function(a){return/^(rotate|skew)/i.test(a)?"deg":/(^(scale|scaleX|scaleY|scaleZ|alpha|flexGrow|flexHeight|zIndex|fontWeight)$)|((opacity|red|green|blue|alpha)$)/i.test(a)?"":"px"},getDisplayType:function(a){var b=a&&a.tagName.toString().toLowerCase();return/^(b|big|i|small|tt|abbr|acronym|cite|code|dfn|em|kbd|strong|samp|var|a|bdo|br|img|map|object|q|script|span|sub|sup|button|input|label|select|textarea)$/i.test(b)?"inline":/^(li)$/i.test(b)?"list-item":/^(tr)$/i.test(b)?"table-row":/^(table)$/i.test(b)?"table":/^(tbody)$/i.test(b)?"table-row-group":"block"},addClass:function(a,b){a.classList?a.classList.add(b):a.className+=(a.className.length?" ":"")+b},removeClass:function(a,b){a.classList?a.classList.remove(b):a.className=a.className.toString().replace(new RegExp("(^|\\s)"+b.split(" ").join("|")+"(\\s|$)","gi")," ")}},getPropertyValue:function(a,c,e,f){function h(a,c){function e(){j&&v.setPropertyValue(a,"display","none")}var i=0;if (8>=n)i=m.css(a,c);else{var j=!1;if (/^(width|height)$/.test(c)&&0===v.getPropertyValue(a,"display")&&(j=!0,v.setPropertyValue(a,"display",v.Values.getDisplayType(a))),!f){if ("height"===c&&"border-box"!==v.getPropertyValue(a,"boxSizing").toString().toLowerCase()){var k=a.offsetHeight-(parseFloat(v.getPropertyValue(a,"borderTopWidth"))||0)-(parseFloat(v.getPropertyValue(a,"borderBottomWidth"))||0)-(parseFloat(v.getPropertyValue(a,"paddingTop"))||0)-(parseFloat(v.getPropertyValue(a,"paddingBottom"))||0);return e(),k}if ("width"===c&&"border-box"!==v.getPropertyValue(a,"boxSizing").toString().toLowerCase()){var l=a.offsetWidth-(parseFloat(v.getPropertyValue(a,"borderLeftWidth"))||0)-(parseFloat(v.getPropertyValue(a,"borderRightWidth"))||0)-(parseFloat(v.getPropertyValue(a,"paddingLeft"))||0)-(parseFloat(v.getPropertyValue(a,"paddingRight"))||0);return e(),l}}var o;o=g(a)===d?b.getComputedStyle(a,null):g(a).computedStyle?g(a).computedStyle:g(a).computedStyle=b.getComputedStyle(a,null),"borderColor"===c&&(c="borderTopColor"),i=9===n&&"filter"===c?o.getPropertyValue(c):o[c],(""===i||null===i)&&(i=a.style[c]),e()}if ("auto"===i&&/^(top|right|bottom|left)$/i.test(c)){var p=h(a,"position");("fixed"===p||"absolute"===p&&/top|left/i.test(c))&&(i=m(a).position()[c]+"px")}return i}var i;if (v.Hooks.registered[c]){var j=c,k=v.Hooks.getRoot(j);e===d&&(e=v.getPropertyValue(a,v.Names.prefixCheck(k)[0])),v.Normalizations.registered[k]&&(e=v.Normalizations.registered[k]("extract",a,e)),i=v.Hooks.extractValue(j,e)}else if (v.Normalizations.registered[c]){var l,o;l=v.Normalizations.registered[c]("name",a),"transform"!==l&&(o=h(a,v.Names.prefixCheck(l)[0]),v.Values.isCSSNullValue(o)&&v.Hooks.templates[c]&&(o=v.Hooks.templates[c][1])),i=v.Normalizations.registered[c]("extract",a,o)}if (!/^[\d-]/.test(i))if (g(a)&&g(a).isSVG&&v.Names.SVGAttribute(c))if (/^(height|width)$/i.test(c))try{i=a.getBBox()[c]}catch(p){i=0}else i=a.getAttribute(c);else i=h(a,v.Names.prefixCheck(c)[0]);return v.Values.isCSSNullValue(i)&&(i=0),t.debug>=2&&console.log("Get "+c+": "+i),i},setPropertyValue:function(a,c,d,e,f){var h=c;if ("scroll"===c)f.container?f.container["scroll"+f.direction]=d:"Left"===f.direction?b.scrollTo(d,f.alternateValue):b.scrollTo(f.alternateValue,d);else if (v.Normalizations.registered[c]&&"transform"===v.Normalizations.registered[c]("name",a))v.Normalizations.registered[c]("inject",a,d),h="transform",d=g(a).transformCache[c];else{if (v.Hooks.registered[c]){var i=c,j=v.Hooks.getRoot(c);e=e||v.getPropertyValue(a,j),d=v.Hooks.injectValue(i,d,e),c=j}if (v.Normalizations.registered[c]&&(d=v.Normalizations.registered[c]("inject",a,d),c=v.Normalizations.registered[c]("name",a)),h=v.Names.prefixCheck(c)[0],8>=n)try{a.style[h]=d}catch(k){t.debug&&console.log("Browser does not support ["+d+"] for ["+h+"]")}else g(a)&&g(a).isSVG&&v.Names.SVGAttribute(c)?a.setAttribute(c,d):a.style[h]=d;t.debug>=2&&console.log("Set "+c+" ("+h+"): "+d)}return[h,d]},flushTransformCache:function(a){function b(b){return parseFloat(v.getPropertyValue(a,b))}var c="";if ((n||t.State.isAndroid&&!t.State.isChrome)&&g(a).isSVG){var d={translate:[b("translateX"),b("translateY")],skewX:[b("skewX")],skewY:[b("skewY")],scale:1!==b("scale")?[b("scale"),b("scale")]:[b("scaleX"),b("scaleY")],rotate:[b("rotateZ"),0,0]};m.each(g(a).transformCache,function(a){/^translate/i.test(a)?a="translate":/^scale/i.test(a)?a="scale":/^rotate/i.test(a)&&(a="rotate"),d[a]&&(c+=a+"("+d[a].join(" ")+") ",delete d[a])})}else{var e,f;m.each(g(a).transformCache,function(b){return e=g(a).transformCache[b],"transformPerspective"===b?(f=e,!0):(9===n&&"rotateZ"===b&&(b="rotate"),void(c+=b+e+" "))}),f&&(c="perspective"+f+" "+c)}v.setPropertyValue(a,"transform",c)}};v.Hooks.register(),v.Normalizations.register(),t.hook=function(a,b,c){var e=d;return a=f(a),m.each(a,function(a,f){if (g(f)===d&&t.init(f),c===d)e===d&&(e=t.CSS.getPropertyValue(f,b));else{var h=t.CSS.setPropertyValue(f,b,c);"transform"===h[0]&&t.CSS.flushTransformCache(f),e=h}}),e};var w=function(){function a(){return h?B.promise||null:i}function e(){function a(){function a(a,b){var c=d,e=d,g=d;return p.isArray(a)?(c=a[0],!p.isArray(a[1])&&/^[\d-]/.test(a[1])||p.isFunction(a[1])||v.RegEx.isHex.test(a[1])?g=a[1]:(p.isString(a[1])&&!v.RegEx.isHex.test(a[1])||p.isArray(a[1]))&&(e=b?a[1]:j(a[1],h.duration),a[2]!==d&&(g=a[2]))):c=a,b||(e=e||h.easing),p.isFunction(c)&&(c=c.call(f,y,x)),p.isFunction(g)&&(g=g.call(f,y,x)),[c||0,e,g]}function l(a,b){var c,d;return d=(b||"0").toString().toLowerCase().replace(/[%A-z]+$/,function(a){return c=a,""}),c||(c=v.Values.getUnitType(a)),[d,c]}function n(){var a={myParent:f.parentNode||c.body,position:v.getPropertyValue(f,"position"),fontSize:v.getPropertyValue(f,"fontSize")},d=a.position===I.lastPosition&&a.myParent===I.lastParent,e=a.fontSize===I.lastFontSize;I.lastParent=a.myParent,I.lastPosition=a.position,I.lastFontSize=a.fontSize;var h=100,i={};if (e&&d)i.emToPx=I.lastEmToPx,i.percentToPxWidth=I.lastPercentToPxWidth,i.percentToPxHeight=I.lastPercentToPxHeight;else{var j=g(f).isSVG?c.createElementNS("http://www.w3.org/2000/svg","rect"):c.createElement("div");t.init(j),a.myParent.appendChild(j),m.each(["overflow","overflowX","overflowY"],function(a,b){t.CSS.setPropertyValue(j,b,"hidden")}),t.CSS.setPropertyValue(j,"position",a.position),t.CSS.setPropertyValue(j,"fontSize",a.fontSize),t.CSS.setPropertyValue(j,"boxSizing","content-box"),m.each(["minWidth","maxWidth","width","minHeight","maxHeight","height"],function(a,b){t.CSS.setPropertyValue(j,b,h+"%")}),t.CSS.setPropertyValue(j,"paddingLeft",h+"em"),i.percentToPxWidth=I.lastPercentToPxWidth=(parseFloat(v.getPropertyValue(j,"width",null,!0))||1)/h,i.percentToPxHeight=I.lastPercentToPxHeight=(parseFloat(v.getPropertyValue(j,"height",null,!0))||1)/h,i.emToPx=I.lastEmToPx=(parseFloat(v.getPropertyValue(j,"paddingLeft"))||1)/h,a.myParent.removeChild(j)}return null===I.remToPx&&(I.remToPx=parseFloat(v.getPropertyValue(c.body,"fontSize"))||16),null===I.vwToPx&&(I.vwToPx=parseFloat(b.innerWidth)/100,I.vhToPx=parseFloat(b.innerHeight)/100),i.remToPx=I.remToPx,i.vwToPx=I.vwToPx,i.vhToPx=I.vhToPx,t.debug>=1&&console.log("Unit ratios: "+JSON.stringify(i),f),i}if (h.begin&&0===y)try{h.begin.call(o,o)}catch(r){setTimeout(function(){throw r},1)}if ("scroll"===C){var u,w,z,A=/^x$/i.test(h.axis)?"Left":"Top",D=parseFloat(h.offset)||0;h.container?p.isWrapped(h.container)||p.isNode(h.container)?(h.container=h.container[0]||h.container,u=h.container["scroll"+A],z=u+m(f).position()[A.toLowerCase()]+D):h.container=null:(u=t.State.scrollAnchor[t.State["scrollProperty"+A]],w=t.State.scrollAnchor[t.State["scrollProperty"+("Left"===A?"Top":"Left")]],z=m(f).offset()[A.toLowerCase()]+D),i={scroll:{rootPropertyValue:!1,startValue:u,currentValue:u,endValue:z,unitType:"",easing:h.easing,scrollData:{container:h.container,direction:A,alternateValue:w}},element:f},t.debug&&console.log("tweensContainer (scroll): ",i.scroll,f)}else if ("reverse"===C){if (!g(f).tweensContainer)return void m.dequeue(f,h.queue);"none"===g(f).opts.display&&(g(f).opts.display="auto"),"hidden"===g(f).opts.visibility&&(g(f).opts.visibility="visible"),g(f).opts.loop=!1,g(f).opts.begin=null,g(f).opts.complete=null,s.easing||delete h.easing,s.duration||delete h.duration,h=m.extend({},g(f).opts,h);var E=m.extend(!0,{},g(f).tweensContainer);for(var F in E)if ("element"!==F){var G=E[F].startValue;E[F].startValue=E[F].currentValue=E[F].endValue,E[F].endValue=G,p.isEmptyObject(s)||(E[F].easing=h.easing),t.debug&&console.log("reverse tweensContainer ("+F+"): "+JSON.stringify(E[F]),f)}i=E}else if ("start"===C){var E;g(f).tweensContainer&&g(f).isAnimating===!0&&(E=g(f).tweensContainer),m.each(q,function(b,c){if (RegExp("^"+v.Lists.colors.join("$|^")+"$").test(b)){var e=a(c,!0),f=e[0],g=e[1],h=e[2];if (v.RegEx.isHex.test(f)){for(var i=["Red","Green","Blue"],j=v.Values.hexToRgb(f),k=h?v.Values.hexToRgb(h):d,l=0;l<i.length;l++){var m=[j[l]];g&&m.push(g),k!==d&&m.push(k[l]),q[b+i[l]]=m}delete q[b]}}});for(var H in q){var K=a(q[H]),L=K[0],M=K[1],N=K[2];H=v.Names.camelCase(H);var O=v.Hooks.getRoot(H),P=!1;if (g(f).isSVG||"tween"===O||v.Names.prefixCheck(O)[1]!==!1||v.Normalizations.registered[O]!==d){(h.display!==d&&null!==h.display&&"none"!==h.display||h.visibility!==d&&"hidden"!==h.visibility)&&/opacity|filter/.test(H)&&!N&&0!==L&&(N=0),h._cacheValues&&E&&E[H]?(N===d&&(N=E[H].endValue+E[H].unitType),P=g(f).rootPropertyValueCache[O]):v.Hooks.registered[H]?N===d?(P=v.getPropertyValue(f,O),N=v.getPropertyValue(f,H,P)):P=v.Hooks.templates[O][1]:N===d&&(N=v.getPropertyValue(f,H));var Q,R,S,T=!1;if (Q=l(H,N),N=Q[0],S=Q[1],Q=l(H,L),L=Q[0].replace(/^([+-\/*])=/,function(a,b){return T=b,""}),R=Q[1],N=parseFloat(N)||0,L=parseFloat(L)||0,"%"===R&&(/^(fontSize|lineHeight)$/.test(H)?(L/=100,R="em"):/^scale/.test(H)?(L/=100,R=""):/(Red|Green|Blue)$/i.test(H)&&(L=L/100*255,R="")),/[\/*]/.test(T))R=S;else if (S!==R&&0!==N)if (0===L)R=S;else{e=e||n();var U=/margin|padding|left|right|width|text|word|letter/i.test(H)||/X$/.test(H)||"x"===H?"x":"y";switch(S){case"%":N*="x"===U?e.percentToPxWidth:e.percentToPxHeight;break;case"px":break;default:N*=e[S+"ToPx"]}switch(R){case"%":N*=1/("x"===U?e.percentToPxWidth:e.percentToPxHeight);break;case"px":break;default:N*=1/e[R+"ToPx"]}}switch(T){case"+":L=N+L;break;case"-":L=N-L;break;case"*":L=N*L;break;case"/":L=N/L}i[H]={rootPropertyValue:P,startValue:N,currentValue:N,endValue:L,unitType:R,easing:M},t.debug&&console.log("tweensContainer ("+H+"): "+JSON.stringify(i[H]),f)}else t.debug&&console.log("Skipping ["+O+"] due to a lack of browser support.")}i.element=f}i.element&&(v.Values.addClass(f,"velocity-animating"),J.push(i),""===h.queue&&(g(f).tweensContainer=i,g(f).opts=h),g(f).isAnimating=!0,y===x-1?(t.State.calls.push([J,o,h,null,B.resolver]),t.State.isTicking===!1&&(t.State.isTicking=!0,k())):y++)}var e,f=this,h=m.extend({},t.defaults,s),i={};switch(g(f)===d&&t.init(f),parseFloat(h.delay)&&h.queue!==!1&&m.queue(f,h.queue,function(a){t.velocityQueueEntryFlag=!0,g(f).delayTimer={setTimeout:setTimeout(a,parseFloat(h.delay)),next:a}}),h.duration.toString().toLowerCase()){case"fast":h.duration=200;break;case"normal":h.duration=r;break;case"slow":h.duration=600;break;default:h.duration=parseFloat(h.duration)||1}t.mock!==!1&&(t.mock===!0?h.duration=h.delay=1:(h.duration*=parseFloat(t.mock)||1,h.delay*=parseFloat(t.mock)||1)),h.easing=j(h.easing,h.duration),h.begin&&!p.isFunction(h.begin)&&(h.begin=null),h.progress&&!p.isFunction(h.progress)&&(h.progress=null),h.complete&&!p.isFunction(h.complete)&&(h.complete=null),h.display!==d&&null!==h.display&&(h.display=h.display.toString().toLowerCase(),"auto"===h.display&&(h.display=t.CSS.Values.getDisplayType(f))),h.visibility!==d&&null!==h.visibility&&(h.visibility=h.visibility.toString().toLowerCase()),h.mobileHA=h.mobileHA&&t.State.isMobile&&!t.State.isGingerbread,h.queue===!1?h.delay?setTimeout(a,h.delay):a():m.queue(f,h.queue,function(b,c){return c===!0?(B.promise&&B.resolver(o),!0):(t.velocityQueueEntryFlag=!0,void a(b))}),""!==h.queue&&"fx"!==h.queue||"inprogress"===m.queue(f)[0]||m.dequeue(f)}var h,i,n,o,q,s,u=arguments[0]&&(arguments[0].p||m.isPlainObject(arguments[0].properties)&&!arguments[0].properties.names||p.isString(arguments[0].properties));if (p.isWrapped(this)?(h=!1,n=0,o=this,i=this):(h=!0,n=1,o=u?arguments[0].elements||arguments[0].e:arguments[0]),o=f(o)){u?(q=arguments[0].properties||arguments[0].p,s=arguments[0].options||arguments[0].o):(q=arguments[n],s=arguments[n+1]);var x=o.length,y=0;if (!/^(stop|finish|finishAll)$/i.test(q)&&!m.isPlainObject(s)){var z=n+1;s={};for(var A=z;A<arguments.length;A++)p.isArray(arguments[A])||!/^(fast|normal|slow)$/i.test(arguments[A])&&!/^\d/.test(arguments[A])?p.isString(arguments[A])||p.isArray(arguments[A])?s.easing=arguments[A]:p.isFunction(arguments[A])&&(s.complete=arguments[A]):s.duration=arguments[A]}var B={promise:null,resolver:null,rejecter:null};h&&t.Promise&&(B.promise=new t.Promise(function(a,b){B.resolver=a,B.rejecter=b}));var C;switch(q){case"scroll":C="scroll";break;case"reverse":C="reverse";break;case"finish":case"finishAll":case"stop":m.each(o,function(a,b){g(b)&&g(b).delayTimer&&(clearTimeout(g(b).delayTimer.setTimeout),g(b).delayTimer.next&&g(b).delayTimer.next(),delete g(b).delayTimer),"finishAll"!==q||s!==!0&&!p.isString(s)||(m.each(m.queue(b,p.isString(s)?s:""),function(a,b){p.isFunction(b)&&b()}),m.queue(b,p.isString(s)?s:"",[]))});var D=[];return m.each(t.State.calls,function(a,b){b&&m.each(b[1],function(c,e){var f=s===d?"":s;return f===!0||b[2].queue===f||s===d&&b[2].queue===!1?void m.each(o,function(c,d){d===e&&((s===!0||p.isString(s))&&(m.each(m.queue(d,p.isString(s)?s:""),function(a,b){p.isFunction(b)&&b(null,!0)
}),m.queue(d,p.isString(s)?s:"",[])),"stop"===q?(g(d)&&g(d).tweensContainer&&f!==!1&&m.each(g(d).tweensContainer,function(a,b){b.endValue=b.currentValue}),D.push(a)):("finish"===q||"finishAll"===q)&&(b[2].duration=1))}):!0})}),"stop"===q&&(m.each(D,function(a,b){l(b,!0)}),B.promise&&B.resolver(o)),a();default:if (!m.isPlainObject(q)||p.isEmptyObject(q)){if (p.isString(q)&&t.Redirects[q]){var E=m.extend({},s),F=E.duration,G=E.delay||0;return E.backwards===!0&&(o=m.extend(!0,[],o).reverse()),m.each(o,function(a,b){parseFloat(E.stagger)?E.delay=G+parseFloat(E.stagger)*a:p.isFunction(E.stagger)&&(E.delay=G+E.stagger.call(b,a,x)),E.drag&&(E.duration=parseFloat(F)||(/^(callout|transition)/.test(q)?1e3:r),E.duration=Math.max(E.duration*(E.backwards?1-a/x:(a+1)/x),.75*E.duration,200)),t.Redirects[q].call(b,b,E||{},a,x,o,B.promise?B:d)}),a()}var H="Velocity: First argument ("+q+") was not a property map, a known action, or a registered redirect. Aborting.";return B.promise?B.rejecter(new Error(H)):console.log(H),a()}C="start"}var I={lastParent:null,lastPosition:null,lastFontSize:null,lastPercentToPxWidth:null,lastPercentToPxHeight:null,lastEmToPx:null,remToPx:null,vwToPx:null,vhToPx:null},J=[];m.each(o,function(a,b){p.isNode(b)&&e.call(b)});var K,E=m.extend({},t.defaults,s);if (E.loop=parseInt(E.loop),K=2*E.loop-1,E.loop)for(var L=0;K>L;L++){var M={delay:E.delay,progress:E.progress};L===K-1&&(M.display=E.display,M.visibility=E.visibility,M.complete=E.complete),w(o,"reverse",M)}return a()}};t=m.extend(w,t),t.animate=w;var x=b.requestAnimationFrame||o;return t.State.isMobile||c.hidden===d||c.addEventListener("visibilitychange",function(){c.hidden?(x=function(a){return setTimeout(function(){a(!0)},16)},k()):x=b.requestAnimationFrame||o}),a.Velocity=t,a!==b&&(a.fn.velocity=w,a.fn.velocity.defaults=t.defaults),m.each(["Down","Up"],function(a,b){t.Redirects["slide"+b]=function(a,c,e,f,g,h){var i=m.extend({},c),j=i.begin,k=i.complete,l={height:"",marginTop:"",marginBottom:"",paddingTop:"",paddingBottom:""},n={};i.display===d&&(i.display="Down"===b?"inline"===t.CSS.Values.getDisplayType(a)?"inline-block":"block":"none"),i.begin=function(){j&&j.call(g,g);for(var c in l){n[c]=a.style[c];var d=t.CSS.getPropertyValue(a,c);l[c]="Down"===b?[d,0]:[0,d]}n.overflow=a.style.overflow,a.style.overflow="hidden"},i.complete=function(){for(var b in n)a.style[b]=n[b];k&&k.call(g,g),h&&h.resolver(g)},t(a,l,i)}}),m.each(["In","Out"],function(a,b){t.Redirects["fade"+b]=function(a,c,e,f,g,h){var i=m.extend({},c),j={opacity:"In"===b?1:0},k=i.complete;i.complete=e!==f-1?i.begin=null:function(){k&&k.call(g,g),h&&h.resolver(g)},i.display===d&&(i.display="In"===b?"auto":"none"),t(this,j,i)}}),t}(window.jQuery||window.Zepto||window,window,document)});



var AP=new function _AP(){
	this.config={};
	this.__printing=0;
	this.blockRedirection=null;
	this.transition="";
	
	this.histories = [window.location.href];
	
	this.key={enter: 13, tab: 9, backspace: 8, escape: 27, prev: 37, next: 39, left: 37, right: 39, up: 38, down: 40};
	this.keycode=function(e, str){
		return (e.keycode==this.key[str]);
	};

	window.onbeforeunload = null;
	
	this.EVENTS={PAGE_UNLOAD: 'page.unload',
		PAGE:{
			INIT: 'page.init',
			UNLOAD: 'page.unload',
			RELOAD: 'page.reload',
			AFTERLOAD: 'page.afterload'
	}};


	this.display=function(data, options){
		options=$.extend({},{emotion: false, tag: true, script: true}, options);
		return data;
	};




	/**
	 * @desc Call user function with parameter
	 */
	this.fn=function(fn, data){
		var __fn=eval(fn);
		__fn(data);
	};


	/**
	 * @desc Call user object function with parameter
	 */
	this.call=function(fn){
		fn();
	};


	this.__ts=[];
	this.__rts=[];

	/**
	 * @desc Temporary timeout (all timeouts are clear in the next page)
	 */
	this.timeout=function(fn, total_time){
		var tx=setTimeout(function(){
			fn();
		}, total_time);
		
		AP.__ts.push(tx);
		
		return tx;
	};


	/**
	 * @desc Temporary timeout (all timeouts are clear in the next page)
	 */
	this.rtimeout=function(fn, total_time){
		var intv=setInterval(function(){
			fn.apply(intv);
		}, total_time);
		
		AP.__rts.push(intv);
		return intv;
	};


	/**
	 * @desc Call a function once. The function is marked by its name, where fn is the actually
	 * function.
	 * @example
	 * 	AP.once("alertme", function(){alert(1)}); // This is called
	 *  AP.once("alertme", function(){alert(1)}); // This is not called as alertme has been called earlier.
	 */
	this.once_list=[];
	this.once=function(name, fn){
		if (this.array.within(name, this.once_list)){
			return;
		}
		this.once_list.push(name);
		fn();
	};



	this.alert=function(content, buttons, icon, opts){
		opts=$.extend({}, opts);

		if (!icon){
			icon='s48-ap-error';
		}

		var icon_html="<div class='icon' style='width:42px;'>"+icon+"</div>";
		if (AP.word.match(icon, /^([a-zA-Z0-9\s\-\_]+)$/)){
			icon_html="<span class='"+icon+"' style='font-size:42px;'></span>";
		}

		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Success").temp(false)
			.buttons(buttons)
			.content("<table><tr><td class='icon'> "+icon_html+"</td> <td class='text'>"+content+"</td></tr></table>")
			.cond(Client.native, function(){
				this.width(450)
			})
			.closable(opts.closable)
			.show()
		;
	};



	this.alertSuccess=function(content, callback){
		var cb=function(){
			AP.dialog("#alert").hide();
		};
		if (callback){
			cb=function(){
				AP.dialog("#alert").hide();
				callback();
			};
		}
		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Success").temp(false)
			.button("OK", cb,'ss')
			.content("<table><tr><td class='icon'> <span class='ficon ficon-check-circle' style='font-size:42px; color:#36b918'></span></td> <td class='text'>"+content+"</td></tr></table>")
			.show()
			;
	};



	this.alertWarning=function(content, callback){
		var cb=function(){
			AP.dialog("#alert").hide();
		};
		if (callback){
			cb=function(){
				AP.dialog("#alert").hide();
				callback();
			};
		}
		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Success").temp(false)
			.button("OK", cb,'er')
			.content("<table><tr><td class='icon'> <span class='ficon ficon-exclamation-circle' style='font-size:42px; color:#c65144'></span></td> <td class='text'>"+content+"</td></tr></table>")
			.show();
	};


	this.alertError=function(content, extra_messages, callback){
		if (AP.word.empty(content)){
			content="The system is temporarily unable to process your request. We are working on it and we'll get it fixed as we can.";
		}

		var text=content;
		var cb=function(){
			AP.dialog("#alert").hide();
		};

		if (extra_messages && AP.isObject(extra_messages)){
			if (extra_messages[content]){
				text=extra_messages[content];
			}

			if (callback){
				cb=function(){
					AP.dialog("#alert").hide();
					callback();
				};
			}
		}else{
			if (extra_messages && !callback){
				cb=function(){
					AP.dialog("#alert").hide();
					extra_messages();
				};
			}
		}

		text=AP.error.translate(text);

		AP.dialog("#alert")
			.temp(false)
			.engine(AP.config.alertDialogEngine)
			.style("__apalert")
			.title("Error").temp(false)
			.button("OK", cb,'er alert-button')
			.content("<table><tr><td class='icon'> <span class='-ap icon-help-with-circle' style='font-size:40px; color:#666'></span></td> <td class='text'>"+text+"</td></tr></table>")
			.show()
		;
	};


	this.alertWaiting=function(content, fn){
		AP.dialog("#alert")
		.temp(false)
		.engine(AP.config.alertDialogEngine)
		.style("__apalert")
		.title("Waiting").temp(false)
		.button("Refresh", function(){
			AP.xRefresh();
		})
		.content("<table><tr><td class='icon'> <span class='s48-ap-question'></span></td> <td class='text'>"+content+"</td></tr></table>")
		.show()
		;

		if (fn){
			fn();
		}
	};



	this.confirm=function(content, fn){
		AP.dialog("#alert")
		.temp(false)
		.engine(AP.config.alertDialogEngine)
		.style("__apalert")
		.title("Confirm").temp(false)
		.button("Close", function(){
			AP.dialog("#alert").hide();
		},'er confirm-button')
		.button("OK", function(){
			AP.dialog("#alert").hide();
			fn();
		},'ss confirm-button')
		.content("<table><tr><td class='icon'> <span class='ficon ficon-exclamation-circle' style='font-size:42px; color:#c65144'></span></td> <td class='text'>"+content+"</td></tr></table>")
		.show()
		;
	};



	this.hideAlert=function(){
		AP.dialog("#alert").hide();
	};



	this.ajaxAlert=function(notShowTitle){
		if (!$('#ajaxalert').length){
			AP.add('ajaxalert');
			AP.dialog("#ajaxalert")
			.temp(false)
			.engine(AP.config.ajaxAlertDialogEngine)
			.show();
		}else{
			if (notShowTitle) {
				AP.dialog("#ajaxalert").title("").show();
			} else {
				AP.dialog("#ajaxalert").show();
			}
		}
	};

	this.ajaxShow=function(txt){
		if (!txt){
			txt="Processing";
		}
		this.ajaxAlert(true);
		// $.log(txt);
		$("#ajaxalert").prev().html(txt);
	};

	this.ajaxHide=function(){
		AP.dialog("#ajaxalert").hide();
	};



	/**
	 * @desc The default handler for ajax code returned from the server.
	 * @todo Add Dialog Here.
	 */
	this.handler=function(code){
		AP.alertError(code.message);
	};


	/**
	 * @desc The default success handler for ajax code returned from the server.
	 * @todo Add Dialog Here.
	 */
	this.successHandler=function(code){
		AP.alertSuccess(code.message);
	};


	/**
	 * @desc The default error handler for ajax code returned from the server.
	 * @todo Add Dialog Here.
	 */
	this.errorHandler=function(code){
		AP.alertError(code.message);
	};



	/**
	 * @desc Class's binary lock
	 */
	this.__lock=false;

	/**
	 * @desc Lock the ajax mechanisum.
	 */
	this.lock=function(){
		this.__lock=true;
	};

	this.undone_url="";
	this.undone_data="";


	this.ajax_data={};
	this.ajaxSetup=function(data){
		this.ajax_data=data;
	};

	
	/**
	 * @desc Making a post to the server.
	 * @param handler: The callback after retrieving the data from the server. if
	 * omitted, the default handler is called.
	 */
	this.post=function(url, data, handler, use_lock){
		if (!this.word.isURL(url)){
			if (Client.native){
				url=M.api()+'/'+url;

				if (data && AP.data.isObject(data)){
					var params=M.params();
					for (var key in params){
						M.formData(data, key, params[key]);
					}
				}

				M.formData(data, '__code', Client.code);
			}else{
				url=Client.ajax_url+'/'+url;
			}

		}

		var $this=null;

		if (use_lock && use_lock==true){
			if (this.__lock){
				if (Client.env==0 || Client.env=='0'){
					AP.alertError("Be patient! Your request is processed right now.");
				}
				return;
			}
			this.lock();
		}

		if (!handler){
			handler=this.hander;
		}

		if (AP.isAssocArray(data) && !Client.native){
			data.__code=Client.code;
			if (Client.base_network && Client.base_network.id){
				if (!data.__base_network){
					data.__base_network=Client.base_network.id;
				}
			}
			if (Client.network && Client.network.id){
				if (!data.__network){
					data.__network=Client.network.id;
				}
			}
			if (Client.user && Client.user.id){
				if (!data.__user){
					data.__user=Client.user.id;
				}
			}

			for (var key in this.ajax_data){
				data[key]=this.ajax_data[key];
			}
		}

		AP.sys.fire("ajax.pre.update",data);

		if (url==this.undone_url && AP.data.equal(data, this.undone_data)){
			// $.log(url);
			// AP.alertError("We are processing your request ....");
			$.log("[Abusive URL: "+url+"], with Data:");
			$.log(data);
			return false;
		}

		this.undone_url=url;
		this.undone_data=data;

		
		if (Client.native){
			var ajax_data={
				'url': url,
				'data': data,
				type: 'POST',
				success: function(text){
					AP.__lock=false;
					AP.undone_url="";
					AP.undone_data="";
					var c=parseCode(text);


					if (c.message=="FLAG.SYSTEM.REQUIRED.REFRESH" || c.command=="LOGIN"){
						return AP.alertError("Please refresh to continue.", function(){
							AP.refresh();
						});
					}
					handler(c);
				},
				error: function(text){
					AP.__lock=false;
					AP.undone_url="";
					AP.undone_data="";
					var c=parseCode(text);
					handler(c);
				}
			};

			if (isFormData(data)) {
				// hack to fix safari bug where ajax fails if file input is empty
				if ((navigator.userAgent.match(/iPhone|iPad|iPod/i)) || (navigator.userAgent.search("Safari") >= 0 && navigator.userAgent.search("Chrome") < 0)) {
					// Safari < 10.13.4 does not support FormData.entries()
					try {
						var formDataEntries = data.entries(), formDataIter = formDataEntries.next(), pair;
						while (!formDataIter.done) {
							pair = formDataIter.value;
							if (Object.prototype.toString.call(pair[1]) === '[object File]' && pair[1].name == '' && pair[1].size == 0) {
								data.delete(pair[0]);
								formDataEntries = data.entries();
								formDataIter = formDataEntries.next();
							} else {
								formDataIter = formDataEntries.next();
							}

						}
					} catch(e) {}
				}

				ajax_data.processData = false;
				ajax_data.contentType = false;

			}

			$.ajax(ajax_data);
		}else{
			$.post(url, data, function(text){
				AP.__lock=false;
				AP.undone_url="";
				AP.undone_data="";
				var c=parseCode(text);

				if (c.message=="FLAG.SYSTEM.REQUIRED.REFRESH" || c.command=="LOGIN"){
					return AP.alertError("Please refresh to continue.", function(){
						AP.refresh();
					});
				}
				
				handler(c);
			}).fail(function(text){
				AP.__lock=false;
				AP.undone_url="";
				AP.undone_data="";
				var c=parseCode(text);
				handler(c);
			});
		}
	};


	/**
	 * @desc Similar to post, but create a get method.
	 */
	this.get=function(url, handler, checker){
		return this.post(url, {}, handler, checker);
	};
	
	
	this.es6Post=function(url, data, handler){
		if (AP.isAssocArray(data) && !Client.native){
			data.__code=Client.code;
		}
		
		var formData = new FormData();
		for (var k in data) {
		    formData.append(k, data[k]);
		}
		
		if (!this.word.isURL(url)){
			url=Client.ajax_url+'/'+url;
		}
		
		fetch(url, {
			method: 'POST',
			headers: {"Content-Type": "application/x-www-form-urlencoded; charset=utf-8"},
			body:  new URLSearchParams(data)
		})
		.then(res => res.text()) // parse response as JSON (can be res.text() for plain response)
		.then(function(data){
			// $.log(data);
			// UI.ajaxHide();
			var c=parseCode(data);
			handler(c);
		})
		.catch(err => {
			console.log(err);
		});
	};



	this.crossPost=function(url, data, success_callback, error_handler){
		data.ext=url;
		data.ts=AP.T.timeStamp();
		data.__code=Client.code;
		$.ajax({
			  type: 'post',
			  url: Client.ajax_url+"/share/cross",
			  data: data,
			  success: function(obj){
				  success_callback(obj);
			  },
			  error: function(){
				  if (error_handler){
					  error_handler();
				  }
			  },
			  dataType: 'JSON'
		});
	};

	/**
	 * @desc Submit frame in the regular way.
	 */
	this.__submit=function(selector){
		ap_editSubmission(selector);
		$(selector).submit();
	};


	/**
	 * @desc Submit a form to the server using Ajax. Based on the elements of the form,
	 * the system will decide the corresponding method (DIRECT AJAX or FRAME).
	 * @param selector The form Selector.
	 * @returns Null
	 */
	this.submit=function(selector, callback, extra_data){
		var elem="";

		if (!AP.data.isString(selector)){
			var id;
			if (!$(selector).attr('id')){
				id=AP.uuid();
				$(selector).attr('id', id);
			}else{
				id=$(selector).attr('id');
			}

			elem="#"+id;
		}else{
			elem=selector;
		}


		if (!extra_data){
			extra_data={};
		}

		if (Client.native){
			var params=M.params();
			for (var key in params){
				extra_data[key]=params[key];
			}
		}

		for (var key in this.ajax_data){
			extra_data[key]=this.ajax_data[key];
		}
		
		if (AP.isset("Form")){
			Form.protection.onSubmit(selector);
		}

		if ($(elem).find('input[type=file]').length && !Client.native){
			return this.submitFrame(elem, callback, extra_data);
		}else{
			return this.submitAjax(elem, callback, extra_data);
		}
	};


	/**
	 * @desc Submit a form via ajax.
	 */
	this.submitAjax=function(selector, callback, extra_data){
		if (!extra_data){
			extra_data={};
		}

		var text="";
		if (!$(selector).flag("__init_code")){
			var text="<input type='hidden' name='__code' value='"+Client.code+"' /> ";
			$(selector).append(text);
			AP.sys.fire('form.pre.submit', selector);
		}

		if (!callback){
			callback=this.handler;
		}

		ap_editSubmission(selector);

		var data=$(selector).serialize();
		
		var target=$(selector).attr('action');



		if (Client.native){
			var formData = new FormData($(selector)[0]);
			if (extra_data){
				for (var k in extra_data){
					formData.append(k, extra_data[k]);
				}
			}

			this.post(target, formData, function(code){
				code.__form=assoc($(selector).serializeArray());
				for (var k in extra_data){
					code.__form[k]=extra_data[k];
				}
				callback(code);
				
				if (code.good()){
					ap_reeditSubmission(selector);
				}
			}, true);

		}else{
			if (extra_data){
				for (var k in extra_data){
					data+="&"+k+"="+extra_data[k];
				}
			}

			this.post(target, data, function(code){
				if (AP.isset("Form")){
					Form.protection.onSubmit(selector);
				}
				
				code.__form=assoc($(selector).serializeArray());
				callback(code);
				
				if (code.good()){
					ap_reeditSubmission(selector);
				}
			}, true);
		}
	};



	/**
	 * @desc Submit as iframe.
	 */
	this.submitFrame=function(selector, success, extra_data){
		if (!success){
			success=this.handler;
		}

		ap_setupFrameUpload(selector, function(code){
			$(selector).unlock();
			code.__form=assoc($(selector).serializeArray());
			success(code);
			ap_reeditSubmission(selector);
		}, extra_data);


		if ($(selector).lock()){
			this.__submit(selector);
		}else{
			AP.alertError("Be patient! Your request is processed right now.");
		}

	};



	this.getJSONP=function(url, success, error){
		var callback='APJSONCALLBACK';
		var uuid=AP.uuid();
		APJSONREG(uuid, success, error);
		var furl=url+"?callback="+callback+"&fx="+uuid;
		if (url.indexOf('?')>0){
			furl=url+"&callback="+callback+"&fx="+uuid;
		}

		$.apScript(furl,null,uuid);
	};



	/**
	 * @desc This is a very simple version of post, when we do not worry
	 * so much about callback function. The functions is very useful for case
	 * such as using AJAX to count pageview, or make a Like action.
	 */
	this.touch=function(url, success){
		if (!success){
			success=this.successHandler;
		}
		this.post(url,{}, function(code){
			if (code.good()){
				success(code);
			}else{
				AP.handler(code);
			}
		});
	};


	/**
	 * @desc This is a simpler version of touch with one exception: on error,
	 * the system doesn't notify the user.
	 */
	this.silent=function(url, success){
		if (!success){
			success=this.handler;
		}
		this.post(url,{}, function(code){
			if (code.good()){
				success(code);
			}
		});
	};




	/**
	 * @desc Redirect to a specific link. If link is not started with http, we
	 * makes it a valid link within the current host.
	 */
	this.redirect=function(link){
		if (!link){
			window.location.href=window.location.href;
		}

		if (Client.native){
			window.location.href=link;
			return;
		}

		if (this.word.prefix(link,'http')){
			window.location.href=link;
		}else{
			window.location.href=Client.url+"/"+link;
		}
	};


	/**
	 * @desc Refresh the whole page.
	 */
	this.refresh=function(){
		if (Client.native){
			location.reload();
		}

		return this.redirect(window.location.href);
	};


	/**
	 * @desc Refresh the whole page.
	 */
	this.xRefresh=function(callback){
		if (Client.native){
			return M.xRefresh();
		}

		var url=window.location.href;
		if (AP.word.prefix(url, Client.url)){
			AP.loadURL(url, {direct_load: true});
		}else{
			AP.loadURL(AP.current_url, {direct_load: true});
		}


		if (callback){
			AP.sys.once(AP.EVENTS.PAGE_UNLOAD, callback);
		}
	};



	this.__urlref=null;

	/**
	 * @desc To an internal URL. URL must be relative.
	 */
	this.toURL=function(url, callback, ref){
		if (ref){
			this.__urlref=ref;
		}

		if (Client.native){
			return AP.nativeRedirect(url);
		}

		if (AP.word.isURL(url)){
			
			if (!AP.word.prefix(url, Client.url)){
				window.open(url);
				return;
			}
		}

		// Remove the HTTP
		if (AP.word.prefix(url, Client.url)){
			url=url.substr(Client.url.length+1);
		}


		// Quick redirect

		if (!AP.word.isURL(url) && this.rewriteRedirect(url)){
			return;
		}

		if (AP.transition && AP.transition.length){
			AP.confirm(AP.transition, function(){
				AP.transition="";
				AP.toURL(url, callback, ref)
			});
			
			return;
		}
		
		if (AP.isset('Form')){
			if (!Form.protection.transition()){
				return;
			}
		}
		
		if (url.indexOf('__nhash=1')!=-1){
		}else{
			if (AP.__history){
				history.pushState({url: Client.url+"/"+url},"",Client.url+"/"+url);
			}else{
				AP.setHash(url);
			}
		}

		if (!AP.word.isURL(url)){
			url=Client.url+"/"+url;
		}

		if (this.__must_reset){
			if (AP.__reset_callback){
				AP.__reset_callback();
			}

			AP.redirect(url);
			return;
		}

		this.histories.push(url);
		AP.loadURL(url,{direct_load: true});

		if (callback){
			AP.sys.once(AP.EVENTS.PAGE_UNLOAD, callback);
		}
	};


	this.setHash=function(url){
		AP.current_url=Client.url+'/'+url;
		AP._last_hash=url;
		window.location.hash='!/'+url;
	};


	this.nativeRedirect=function(url, skip_hash_change){
		var parts=url.split("?");

		if (parts.length<2){
			Query.reset();
			M.redirect(url, skip_hash_change);
		}else{
			var d=queryStringToArray(parts[1]);
			Query.reset();
			for (var k in d){
				Query.set(k, d[k]);
			}
			M.redirect(parts[0], skip_hash_change);
		}
	};



	this._callback={};
	/**
	 * @desc Register a callback for a group. The group (name) will be
	 * the key of callback. When AP.triggerCallback is called, the set of
	 * callbacks will be cleared on the group.
	 */
	this.callback=function(group, fn){
		if (!this._callback[group]){
			this._callback[group]=[];
		}
		this._callback[group].push(fn);
	};


	/**
	 * @desc Trigger the callback on the group action.
	 */
	this.triggerCallback=function(group){
		if (!this._callback[group]){
			return;
		}
		for (var i=0; i<this._callback[group].length; i++){
			var fn=this._callback[group][i];
			fn();
		}
		this._callback[group]=[];
	};




	/**
	 * @desc Check if a variable name exists.
	 */
	this.isset=function(varname){
		return(typeof(window[varname])!='undefined');
	};


	/**
	 * @desc Apply a transform function on the array. It is very much
	 * similar to array_walk in PHP world.
	 */
	this.transform=function(arr, transform_fn){
		var b=[];
		for (var i=0; i<arr.length; i++){
			var temp=transform_fn(arr[i],i);
			if (temp!==null){
				b.push(temp);
			}
		}
		return b;
	};


	this.select=function(arr, transform_fn){
		if (!arr){
			return [];
		}
		return this.transform(arr, transform_fn);
	};


	/**
	 * @desc Apply a transform function on the array, append results at bottom
	 * to make a longer string.
	 */
	this.render=function(arr, transform_fn, limit){
		if (!limit){
			limit=0;
		}
		if (!this.isArray(arr) || !arr.length){
			return "";
		}
		var m=arr.length;
		if (limit >0 && limit <m){
			m=limit;
		}
		var text="";
		for (var i=0; i<m; i++){
			text+=transform_fn(arr[i],i, m);
		}
		return text;
	};


	/**
	 * @desc Apply a transform function on the object, append results at bottom
	 * to make a longer string.
	 */
	this.renderObject=function(obj, render_fn, limit){
		var text="";
		for (var key in obj){
			text+=render_fn(key, obj[key]);
		}
		return text;
	};



	/**
	 * @desc Apply function to each part of the array.
	 */
	this.each=function(data, callback){
		for (var i=0; i<data.length; i++){
			callback(data[i]);
		}
	};


	/**
	 * @desc Create an associate array, where key are variables.
	 * Keys and values are placed in sequence as arguments of the function.
	 */
	this.assoc=function(){
		var r={};
		for (var i=0; i<arguments.length/2; i++){
			r[arguments[2*i]]=arguments[2*i+1];
		}
		return r;
	};


	/**
	 * @desc Encode the data so that it's Okay to pass via AJAX and URL.
	 */
	this.encodeURI=function(str){
		try { return encodeURIComponent(str); } catch(e){}
		try { return encodeURI(str); } catch(e){}
		return espace(str);
	};

	
	this.urlEncode=this.encodeURI;
	

	/**
	 * @desc Move history forward.
	 */
	this.next=function(){
		return history.go(1);
	};

	/**
	 * @desc Move history forward - safely and smartly detect the right domain
	 */
	this.back=function(){
		var last = this.histories.pop();
		last = this.histories.pop();
		
		while (true){
			if (!last || !this.histories.length){
				break;
			}
			
			if (this.histories[this.histories.length-1] == last){
				last = this.histories.pop();
			}else{
				break;	
			}
		}
		
		if (last){
			return AP.toURL(last);
		}
		
		return AP.toURL("home");
	};

	
	this.pageError=function(){
		if (window.performance && window.performance.navigation.type == 2){
			// location.reload(true);
		}
	};
	

	/**
	 * @desc Create an event listener
	 */
	this.on=function(event, fx, $this){
		this.event.bind(event, fx, $this);
		return this;
	};


	this.rebind=function(event, fx, $this){
		this.event.rebind(event, fx, $this);
		return this;
	};



	/**
	 * @desc Create an event listener
	 */
	this.onAll=function(event, fx, $this){
		this.event.bindAll(event, fx, $this);
		return this;
	};


	/**
	 * @desc Trigger an event
	 */
	this.trigger=function(event){
		this.event.trigger(event);
		return this;
	};


	/**
	 * @desc Trigger an event
	 */
	this.fire=function(event, data){
		this.event.trigger(event, data);
		return this;
	};

	this.fireLate=function(event,time){
		if (!time){
			time=200;
		}
		var Event=this.event;
		setTimeout(function(){
			Event.trigger(event);
		},time);
		return this;
	};

	this.live=function(event, fx){
		this.on(event,fx);
		$.log(this.event.__fired);
		if (this.event.fired(event)){
			this.release(event);
		}
	};


	/**
	 * @desc Trigger an event (and dequeue)
	 */
	this.release=function(event){
		this.event.release(event);
		return this;
	};


	this.autoRelease=function(event, cond){
		if (cond){
			return this.release(event);
		};
	};


	this.removeListener=function(event){
		this.event.removeListener(event);
	};


	/**
	 * @desc Getting the url of the thumbnail.
	 */
	this.thumb=function(source, prefix){
		if (!prefix){
			prefix="1.";
		}else{
			prefix=prefix+".";
		}

		if (typeof source == 'undefined' || !source) {
			return "";
		}
		
		// modify directly if path already has file name
		if (source.indexOf("name=") > 0) {
			var re = new RegExp("([?&])name=([^\/&]+)(&|$)", "i");
			if (source.match(re)) {
				return source.replace(re, '$1' + "name=" + prefix + '$2');
			} else {
				return source;
			}
		}

		var path=source.split("/");
		if (path.length<=0){
			return source;
		}
		path[path.length-1]=prefix+path[path.length-1];
		return path.join("/");
	};

	this.xthumb=function(source){
		return this.thumb(source, "0");
	};

	this.zthumb=function(source){
		return this.thumb(source, "2");
	};


	/**
	 * @desc Check data type.
	 */
	this.isArray=function(data){
		return $.isArray(data);
	};
	this.isAssocArray=function(data){
		return typeof(data)=='object' && isNaN(data);
	};
	this.isObject=function(data){
		return typeof(data)=='object' && isNaN(data);
	};
	this.isFunction=function(data){
		return $.isFunction(data);
	};
	this.isInt=function(data){
		return !isNaN(data)&&parseInt(data)==data;
	};
	this.isString=function(data){
		return typeof(data)=='string' && isNaN(data);
	};
	this.isEmpty=function(data){
		if (!data || data.length <=0){
			return true;
		}
		return false;
	};


	this.js_list=Client.js;
	this.css_list=Client.css;


	/**
	 * @desc Loading external css.
	 */
	this.css=function(source){
		if (AP.array.within(source, this.css_list)){
			return;
		}
		this.css_list.push(source);

		if (!this.word.isURL(source)){
			source=Client.url+'/css/'+source;
		}

		$.log("[CSS: "+source+"]");

		var css = jQuery("<link>");
		css.attr({
			rel:  "stylesheet",
			type: "text/css",
			href: source
		});
		$("head").append(css);

	};


	this.cssx=function(css){
		if (Client.pageData.__lazycss && Client.pageData.__lazycss=="none"){
			return;
		}
		this.css(css);
	};

	/**
	 * @desc Loading external js file.
	 * @return Boolean
	 */
	this.js=function(source,callback,id){
		if (this.array.within(source, this.js_list)){
			return false;
		}


		this.js_list.push(source);

		if (!this.word.isURL(source)){
			source=Client.url+'/js/'+source;
		}
		$.log("[JS: "+source+"]");

		$.apScript(source,callback,id);
		return true;
	};


	this.jsx=function(source, callback, id){
		if (Client.pageData.__lazyjs && Client.pageData.__lazyjs=="none"){
			return;
		}
		if (this.array.within(source, this.js_list)){
			if (callback){
				callback();
			}
			return false;
		}


		this.js_list.push(source);

		if (!this.word.isURL(source)){
			source=Client.url+'/js/'+source;
		}
		$.log("[JS: "+source+"]");

		$.apScript(source,callback,id);
		return true;
	};



	/**
	 * @desc Setting continuous Request
	 */
	this._continuous=false;
	this._in_continuous_request=false;

	this._last_hash='';
	this.current_url=window.location.href;

	this.__history=false;
	if (history && history.pushState){
		this.__history=true;
	};

	this.adaptive=function(url1, url2){
		return true;
	};

	this.setURL=function(url){
		if (this.__history){
			history.pushState({url: Client.url+"/"+url},"",Client.url+"/"+url);
		}
	};

	this.updateURLParams=function(params){
		var ps=params;
		if (AP.data.isString(ps)){
			ps=queryStringToArray(params);
		}

		for (var key in ps){
			if (ps[key]==="null"){
				ps[key]=null;
			}
		}

		var checked={};

		var url=Client.path.current;
		url=url.replace(/(\&*)([\w\-]+)\=([\w\-]+)/g, function(match, p0, p1, p2){
			checked[p1]=1;

			if (p1 in ps && ps[p1]===null ){
				return "";
			}

			if (ps[p1]){
				return p0+p1+"="+ps[p1];
			}
			return p0+p1+"="+p2;
		});

		var extra="";
		for (var key in ps){
			if (!checked[key] && ps[key]!=null){
				extra+=key+"="+ps[key]+"&";
			}
		};

		if (extra.length){
			extra=extra.substr(0, extra.length-1);

			if (url.indexOf("?")==-1){
				url=url+"?"+extra;
			}else{
				url=url+"&"+extra;
			}
		}



		if (url.charAt(url.length-1)=="?"){
			url=url.substr(0, url.length-1);
		}


		return AP.toURL(url);
	}


	this.setURLParams=function(params, redirect){
		var ps=params;
		if (AP.data.isString(ps)){
			ps=queryStringToArray(params);
		}

		var orgs=shallowClone(ps);

		var checked={};

		var url=window.location.href;
		url=url.substr(Client.url.length+1);

		url=url.replace(/(\&*)([\w\-]+)\=([\w\-\%\(\)\.\@\/]+)/g, function(match, p0, p1, p2){
			checked[p1]=1;
			if (p1 in ps && ps[p1]===null){
				return "";
			}
			if (ps[p1]){
				return p0+p1+"="+ps[p1];
			}
			return p0+p1+"="+p2;
		});

		var extra="";

		for (var key in ps){
			if (!checked[key]){
				if (key in orgs && orgs[key]==null){
					Query.unset(key);
				}else{
					Query.set(key, ps[key]);
					extra+=key+"="+ps[key]+"&";
				}
			}else{
				Query.set(key, ps[key]);
			}
		};

		if (extra.length){
			extra=extra.substr(0, extra.length-1);

			if (url.indexOf("?")==-1){
				url=url+"?"+extra;
			}else{
				url=url+"&"+extra;
			}
		}


		if (url.charAt(url.length-1)=="?"){
			url=url.substr(0, url.length-1);
		}
		
		if (url && url.length && url[0]=="?"){
			url = "home"+url;
		}

		
		if (Client.url+"/"+url == document.location.href){
			if (redirect){
				return AP.xRefresh();
			}
			
			return;
		}
		
		if (redirect){
			return AP.toURL(url);
		}else{
			return AP.setURL(url);
		}

	}



	this.initContinuousRequest=function(){
		if (this._continuous==false){
			var hash=window.location.hash;
			if (hash && hash.substr(0,2)=='#!' && !AP._in_continuous_request ){
				hash=hash.substring(3);
				AP.redirect(Client.url+'/'+hash);
			}
		}

		this._continuous=true;
		if (!this.__history){
			setInterval(function(){
				if (AP._in_continuous_request){
					return;
				}
				var hash=window.location.hash;
				if (!hash){
					if (AP._last_hash && AP._last_hash.length>=2){
						var nhash=getHash(window.location.href);
						if (nhash){
							window.location.hash='!/'+nhash.join('/');
							return;
						}
					}
					return;
				}

				hash=hash.substring(3);
				if (hash && hash!=AP._last_hash){
					AP._in_continuous_request=true;
					AP.current_url=Client.url+'/'+hash;
					AP.loadURL(AP.current_url);
					AP._last_hash=hash;
				}
			},500);
		}
	};

	this.__popstate_set=false;


	this.setContinuousRequest=function(container){
		if (Client.continuous && Client.continuous==-1){
			return;
		}

		if (this.__history  && !this.__popstate_set){
			history.replaceState({url: window.location.href},'');

			window.onpopstate=function(e){
				if (e.state){
					// Check hostname
					var url=AP.current_url;
					var hostname=document.location.hostname;
					if (Client.https){
						hostname="https://"+hostname;
					}else{
						hostname="http://"+hostname;
					}

					if (!AP.word.prefix(url, hostname)){
						return;
					}else if (!AP.adaptive(url, e.state.url)){
						AP.redirect(e.state.url);
						return;
					}else{
						$.log("[State: "+url+" -> "+document.location.href+"]");
						AP.loadURL(e.state.url,{direct_load: true});
					}
				}
			};
			this.__popstate_set=true;
		}


		if (!container){
			container='';
		}

		$("a", container).each(function(){
			if ($(this).hasClass('blank') || ($(this).attr('target')=='_blank')|| $(this).hasClass('__ap_processed')){
				// No follow or well-done
				return true;
			}
			
			var href=$(this).attr("href");
			if (!href){
				return;
			}

			// Check hostname
			var hostname=$(this).prop('hostname');
			if (hostname!=document.location.hostname){
				return;
			}

			if (!AP.adaptive(href, AP.current_url)){
				return;
			}

			var curl=window.location.href;

			var url;
			var idx=href.indexOf('#');
			if (idx>=0){
				var hash=href.substr(idx+1);
				if (hash.substr(0,2)=='!/'){
					url=hash.substr(2);
				}
			}else{
				url=ap_getHash(href);
				if (!url){
					return;
				}
				url=url.join('/');
			}
			
			if (!url){
				return;
			}


			$(this).addClass('__ap_processed');
			$(this).click(function(event){
				if ($(this).data("href") && $(this).data("url")){
					// event.preventDefault();
					// return false;
				}
				
				event.preventDefault();
				if (url.indexOf('__nhash=1')!=-1){
				}else{
					if (AP.__history){
						history.pushState({url: Client.url+"/"+url},"",Client.url+"/"+url);
					}else{
						window.location.hash="!/"+url;
						AP._last_hash=url;
					}
				}

				AP.loadURL(Client.url+'/'+url,{direct_load: true});

				return false;
			});

		});
	};



	/**
	 * @desc Similar to continuous AJAX request, but this function load
	 * data to the overlay and don't reset the hash.
	 */
	this.load=function(url){
		return AP.loadURL(url, {model: 'overlay'});
	};


	this.__must_reset=false;
	this.__reset_callback=false;

	this.requireReset=function(reset_callback){
		this.__reset_callback=reset_callback;
		this.__must_reset=true;
	};


	this.loadURL=function(url, options){
		if (AP.isset('Form')){
			if (!Form.protection.transition()){
				return;
			}
		}
		
		
		AP._in_continuous_request=true;

		$("#ajax-load").show();
		$(document.body).addClass("__onload");
		AP.sys.fire("page.pre.transition");
		AP.sys.fire("base.pre.transition");

		var data;

		if (Client.__s){
			data={'from': AP._last_hash, '__s': Client.__s};
		}else{
			data={'from': AP._last_hash, '__s': '0'};
		}

		data._rt=Client.rt;

//		if (Client.pageData.accepted_caches && Client.pageData.accepted_caches.length){
//			$.extend(data, {'__lc':Client.pageData.accepted_caches.join()});
//		}

		// Get all current caches
		var cc=Client.getCurrentCachesKey();
		if (cc && cc.length){
			$.extend(data, {'__lc':cc.join()});
		}


		if (options){
			$.extend(data, options);
		}else{
			options={};
		}


		AP.post(url,data, function(code){
			if (code.direct_request_prevented && (code.direct_request_prevented==1 || code.direct_request_prevented=='1')){
				AP.redirect(url);
				return;
			}

			AP.current_url=url;

			if (!code.good() && (code.message=='FORCE_REFRESH' || code.message=='BAD_XCODE')){
				AP.redirect(url);
				return;
			}



			$(document.body).removeClass("__onload");

			if (code.good()){
				$.log('[Load URL: '+url+"]");

				// track the page view
				// track the page view
				if (typeof ga !== 'undefined'){
					ga('send','pageview', {
						page: url,
						title: code._title
					});
				}else if (typeof _gaq !== 'undefined'){
					_gaq.push(['_trackPageview', url]);
				}


				// First, loading calling the reset function
				var rs=code._init;
				var _rs=eval(rs);
				_rs(function(){
					if (!AP._in_continuous_request && !options.direct_load){
						return;
					}

					// Remove page data

					if (!options.keep_page_data){
						AP.pageData={};
						Client.pageData={};
					}
					
					window.onbeforeunload = null;
					
					AP.pageConfig.reset();
					SE.reset();
					
					if (code._log){
						console.log("[Log: "+url+"]");
						console.log(code._log);
					}

					AP.hotkey.clear();
					AP._in_continuous_request=false;
					AP.gb.clear();

					// Next, setting other components
					AP.html.title(code._title);

					// Next, loading css and javascript
					for (var i=0; i<code._css.length; i++){
						AP.css(code._css[i]);
					}

					// Accept only one javascript
					var called=false;


					if (code._js && code._js.length >0){
						called=AP.js(code._js[code._js.length-1], function(){
							if (code._page_data){
								eval(code._page_data);
							}

							AP.updatePageData();

							AP.fn(code._update, code._html);

							if (code._inpage_js){
								eval(code._inpage_js);
							}
						});
					}

					if (!called){
						if (code._page_data){
							eval(code._page_data);
						}

						AP.updatePageData();

						AP.fn(code._update, code._html);
						if (code._inpage_js){
							eval(code._inpage_js);
						}
					}


					if (Client.pageData.accepted_caches){
						Client.deleteCachesExcept(Client.pageData.accepted_caches);
					}else{
						Client.deleteCachesExcept();
					}

					$("#ajax-load").hide();
					
					AP.sys.fire(AP.EVENTS.PAGE.AFTERLOAD);
				});
			}else{
				$("#ajax-load").hide();

				if (code.data && code.data.force_redirect){
					AP.redirect(code.data.force_redirect);
					return;
				}

				AP._in_continuous_request=false;
			}
		}, true);
	};


	this.loadInlineURL=function(url, data, canvas, options){
		UI.ajaxShow();
		AP.post(url, data, function(code){
			UI.ajaxHide();

			if (!code.good()){
				if (options.error){
					options.error(code);
				}

				return AP.alertError(code.message);
			}

			if (options.start) options.start();
			AP.blockRediretion=null;
			
			AP.setTempData(code);
			$(canvas).html(code.html);

			if (code._page_data){
				for (var key in code._page_data){
					Client.pageData[key]=code._page_data[key];
				}
			}

			// AP.hotkey.clear();
			if (code.__js && code.__js.length){
				eval(code.__js);
			}

			if (options.end) options.end();
		});
	};


	this.initPageData=function(){
		return this.updatePageData();
	};


	this.updatePageData=function(){
		if (Client.pageData.network){
			Client.network=Client.pageData.network;
		}else{
			Client.network=null;
		}

		if (Client.pageData.user){
			Client.user=Client.pageData.user;
		}else{
			Client.user=null;
		}

		// Clear all events (notice: static event should be called via AP.sys
		AP.event.clear();
	};

	
	/**
	 * @desc Register garbage collector
	 */
	this._gcs = [];
	this.gc = function(fn){
		this._gcs.push(fn);
	};
	

	this.resetPageData=function(){
		// Clear MapData
		if (AP.mapData){
			AP.mapData={};
		}

		if (Client){
			Client.tempData={};
		}

		for (var i=0; i<this._gcs.length; i++){
			var _gc = this._gcs[i];
			_gc();
		}
		
		
		for (var i=0; i<AP.__ts.length; i++){
			if (AP.__ts[i]){
				clearTimeout(AP.__ts[i]);
			}
		}

		for (var i=0; i<AP.__rts.length; i++){
			if (AP.__rts[i]){
				clearTimeout(AP.__rts[i]);
			}
		}

		AP.__ts=[];
		AP.__rts=[];

		$("#ap-temp iframe.__temp").each(function(){
			$(this).remove();
		});

		$("#ap-temp").children('.__temp').remove();
		$(".__temp").remove();
		$(".__tempx").empty();

		$("#apdialogs").hide();

		$(document).unbind('keydown');

		$(document).unbind('.__temp');
		$(window).unbind('.__temp');
		
		AP.blockRediretion=null;
	};


	this.purify=function(txt){
		var temp=txt+"";
		
		if (!temp || !temp.length){
			return "";
		}

		temp=temp.replace(/<[^>]*>?/gm, '');
		temp=temp.replace(/<>/gm,'');
		temp=temp.replace(/^\s+|\s+$/gm,'');
		
		return temp;
	};


	/**
	 * Get HTML, and handle via a specific callback
	 */
	this.getHTML=function(url, callback, options){
		if (!options){
			options={};
		}

		options=$.extend({showAjaxLoader: true}, options);

		if (options.showAjaxLoader){
			$("#ajax-load").show();
		}
		if (!AP.word.prefix(url,'http')){
			url=Client.url+'/'+url;
		}

		AP.post(url,{}, function(code){
			if (code.direct_request_prevented && (code.direct_request_prevented==1 || code.direct_request_prevented=='1')){
				AP.redirect(url);
				return;
			}

			if (code.good()){
				$.log('[Loading] URL '+url);

				// Next, setting other components
				if (code._title){
					AP.html.title(code._title);
				}

				// Next, loading css and javascript
				for (var i=0; i<code._css.length; i++){
					AP.css(code._css[i]);
				}

				// Accept only one javascript
				var called=false;

				if (code._js && code._js.length >0){
					called=AP.js(code._js[code._js.length-1], function(){
						if (code._page_data){
							eval(code._page_data);
						}
						callback(code._html);
						if (code._inpage_js){
							eval(code._inpage_js);
						}
					});
				}
				if (!called){
					if (code._page_data){
						eval(code._page_data);
					}
					callback(code._html);
					if (code._inpage_js){
						eval(code._inpage_js);
					}
				}

				if (options.showAjaxLoader){
					$("#ajax-load").hide();
				}
			}else{
				if (options.showAjaxLoader){
					$("#ajax-load").hide();
				}
			}
		});
	};


	
	this.putTemplate=function(val, placeholder){
		$(placeholder).replaceWith(val);
	};
	
	this.putBaseBlock = function(val, placeholder){
		$(placeholder).replaceWith(val);
	};


	/**
	 * @desc Extend client with data
	 */
	this.appData = function(data){
		for (var key in data){
			// Client=$.extend({}, Client, data);
			if (key != 'user' && key != 'network'){
				Client[key]=data[key];
			}else{
				if (Client[key] && !Client['previous_'+key]){
					Client['previous_'+key]=Client[key];
				}
				Client[key]=data[key];
			}


			// Cleanup application data of previous request if needed
		}
	};



	/**
	 * @desc Add wrapper to the document.body. Wrapper is hidden.
	 * @example
	 * 		AP.add("#alert, #dialog");
	 * 		AP.add("alert, dialog");
	 *	  Both generate the same ids.
	 */
	this.add= function(){
		for (var i=0; i<arguments.length; i++){
			var id=arguments[i];
			if (AP.word.prefix(id,'#')){
				id=id.substr(1);
			}
			$(document.body).append("<div id='"+id+"' style='display:none'></div>");
		}
	};


	/**
	 * @desc Generate an unique ID. This is useful when we want to create random IDs
	 * without conflict.
	 */
	var uuidLists=[];
	this.uuid=function(){
		return '_uuid'+(Math.floor(Math.random()*100000))+"_"+(Math.floor(Math.random()*100000))+"_"+AP.time.timeStamp();
	};



	/**
	 * @desc Just a placeholder function.
	 */
	this.nothing=function(){
		return;
	};


	this.test=function(){
		if (Client.native ||parseInt(Client.env) || arguments.length<2){
			return;
		}

		var code=arguments[0];
		var fn=arguments[1];

		$(document).on('keypress', function(e){
			var tag = e.target.tagName.toLowerCase();
			if (tag != 'input' && tag != 'textarea'){
				if (e.keyCode==code+48){
					fn();
					e.preventDefault();
				}
			}
		});
	}



	/**
	 * @desc Apply an action consecutively on all action
	 */
	this.chain=function(data, fn){
		__chainUp(data, 0, fn);
	};


	function __chainUp(data, index, fn){
		if (index>=data.length){
			return;
		}

		fn(data[index], function(){
			chainUp(data, index+1, fn);
		});
	};



	/**
	 * @desc THE PRIVATE METHODS
	 */

	var ap_getHash=function(href){
		return getHash(href);
	};



	var ap_editSubmission=function(elem){
		// Refreshing editor
		$(elem).find('.__apeditor').each(function(){
			nicEditors.findEditor($(this).attr('id')).saveContent();
		});

		$(elem).find("input, textarea").each(function(){
			if ($(this)[0].title && $(this)[0].title==$(this).val()){
				$(this).val("");
			};
		});

		
		$(elem).find("input[name='__code']").val(Client.code);

		if (!$(elem).hasClass('__apform_fixed')){
			$(elem).addClass('__apform_fixed');
			var text="";
			if (Client.base_network && Client.base_network.id>=1 && !$("input[name='__base_network']", $(elem)).length){
				text+="<input type='hidden' name='__base_network' value='"+Client.base_network.id+"'/>";
			}
			if (Client.network && Client.network.id>=1 && !$("input[name='__network']", $(elem)).length){
				text+="<input type='hidden' name='__network' value='"+Client.network.id+"'/>";
			}
			$(elem).append(text);
		}
	};


	var ap_reeditSubmission=function(elem){

		$(elem).find("input, textarea, select").each(function(){
			if (!$(this).hasClass('__injected')){
				$(this).restore();
			}
		});
	};


	this.iframe_counter=0;


	var ap_setupFrameUpload=function(selector, callback, extra_data){
		if ($(selector).flag("iframe_setup")){
			// Still need to fix extra_data

			if (extra_data){
				for (var key in extra_data){
					if ($(selector).find("input[name="+key+"]").length){
						$(selector).find("input[name="+key+"]").val(extra_data[key]);
					}else{
						$("<input type='hidden' name='"+key+"' class='__injected' value='"+extra_data[key]+"'/>").appendTo(selector);
					}
				}
			}
			return;
		}

		var counter=$('iframe._upload').length;
		var action=$(selector).attr('action');

		var temp=true;
		if ($(selector).hasClass('__xtemp')){
			temp=false;
		}

		var name="__iframeupload_"+AP.iframe_counter;
		AP.iframe_counter++;

		var pm_token=null;
		if (!AP.word.prefix(action, "http://") && !AP.word.prefix(action, "https://")){
			$(selector).attr('action',Client.ajax_url+"/"+action);
		}else{
			if (!AP.word.prefix(action, Client.ajax_url)){
				pm_token=AP.uuid();
				extra_data["pm_token"]=pm_token;
				$(selector).data("pm_token", pm_token);
			}
		}


		var ec="";
		if (temp){
			ec=" __temp";
		}
		var elem="<iframe class='_upload "+ec+"' id='"+name+"' name='"+name+"' src='about:blank' onload='return false;'/>";

		if (pm_token){
			$(elem).appendTo($("#ap-temp")).bind("load", function(){
			});

			AP.cors.register(action, pm_token, callback);
		}else{
			$(elem).appendTo($("#ap-temp")).bind("load", function(){
			  	ap_handleFrame(name, callback);
			});
		}




		$(selector).attr('enctype', "multipart/form-data");
		$(selector).attr('target',name);
		$(selector).attr('method','POST');

		$(selector)[0].target=name;
		$(selector)[0].enctype="multipart/form-data";
		if (!AP.word.prefix(action, "http://") && !AP.word.prefix(action, "https://")){
			$(selector)[0].action=Client.ajax_url+"/"+action;
		}
		$(selector)[0].method='POST';

		var text="<input type='hidden' name='__code' class='__injected' value='"+Client.code+"' />";
		if (Client.user && Client.user.id>=1){
			text+="<input type='hidden' name='__user' class='__injected' value='"+Client.user.id+"' />";
		}
		if (Client.base_network && Client.base_network.id>=1){
			text+="<input type='hidden' name='__base_network' class='__injected' value='"+Client.base_network.id+"'/>";
		}
		if (Client.network && Client.network.id>=1){
			text+="<input type='hidden' name='__network' class='__injected' value='"+Client.network.id+"'/>";
		}

		if (extra_data){
			for (var key in extra_data){
				text+="<input type='hidden' name='"+key+"' class='__injected' value='"+extra_data[key]+"'/>";
			}
		}

		if (AP.sys.ie()){
			text+="<input type='hidden' class='__injected' name='__apupload' value='1'/>";
			text+="<input type='hidden' class='__injected' name='__apiefix' value='1'/>";
		}else{
			text+="<input type='hidden' class='__injected' name='__via' value='__frame'/>";
		}

		$(selector).append(text);

		AP.sys.fire("form.pre.submit", selector);
	};


	var ap_handleFrame=function(name, callback){
		var txt=ap_getFrameText(name);

		if (txt && txt.length && txt.length>=2){
			var obj=parseCode(txt);
			if (callback){
				callback(obj);
			}
		}else{
			callback(new Code({code:0, message:"Unknown error (*)", data:null}));
		}
	};


	var ap_getFrameText=function(name){
		return $("#"+name).contents().find('html').text();
		// return window.frames[name].document.getElementsByTagName("body")[0].innerHTML;
	};

};


var Query=new function __Query(){
	this.__data={};
	this.init=function(data){
		this.__data=data;
	};

	this.get=function(key){
		if (key in this.__data){
			return this.__data[key];
		}
		return null;
	};

	this.getFlat=function(key){
		var val=this.get(key);
		if (val==null){
			return "";
		}

		return val;
	};

	this.getInt=function(key){
		var val=this.get(key);
		if (!val){
			return 0;
		}
		return parseInt(val);
	};
	
	this.page=function(){
		var val=this.getInt("page");
		if (!val || val<=0){
			val=1;
		}
		
		return val;
	};

	this.set=function(key, val){
		this.__data[key]=val;
	};

	this.unset=function(key){
		delete this.__data[key];
	};

	this.setDefault=function(key, val){
		if (key in this.__data){
		}else{
			this.__data[key]=val;
		}
	};

	this.reset=function(){
		this.__data={};
	};

	this.all=function(){
		return this.__data;
	};

	
	/**
	 * @desc Safe release, to external variable, no side-effect
	 */
	this.release=function(){
		var obj= shallowClone(this.__data);
		delete obj.env;
		return obj;
	};
	
	this.text=function(){
		var txt="";

		for (var key in this.__data){
			if (key=="env"){
				continue;
			}

			txt+="&"+key+"="+this.__data[key];
		}

		return txt;
	};
};



AP.rules=[];

AP.rewrite=function(pattern, replace, callback, query_string_append){
	AP.rules.push({'pattern': pattern, 'replace': replace, 'callback': callback, 'qsa': query_string_append});
};


AP.rewriteModule = function(module, actions){
	var parts  = module.constructor.name.replace(/_/g,'').match(/[A-Z][a-z]+/g);
	var path = parts.join("/").toLowerCase();
	
	AP.rewrite(":"+(path)+"/-/([a-zA-Z0-9\.]+)", 'action?action=$1', function(qs){
		if (actions.indexOf(qs.action)==-1){
			return;
		}
		
		var f=module.form;
		
		if (qs.action=="create"){
			module.form.create();
		}
		
		if (qs.action=="import"){
			module.form.importer();
		}
	});
	
	
	AP.rewrite(":"+(path)+"/([0-9]+)/([a-zA-Z0-9\.]+)", 'action?id=$1&action=$2', function(qs){
		if (actions.indexOf(qs.action)==-1){
			return;
		}
		
		var obj = module.fromContext(qs.id);
		if (!obj){
			return;
		}
		
		var f=module.form;
		
		if (qs.action=="remove"){
			module.form.remove(obj);
		}
		
		if (qs.action=="edit"){
			module.form.edit(obj);
		}
		
	});
	
};



AP.rewriteCheck=function(url){
	for (var i=0; i<AP.rules.length; i++){
		var temp=AP.rules[i];

		if (url.match(RegExp(temp.pattern))){
			var next=url.replace(new RegExp(temp.pattern), temp.replace);
			var fn=temp.callback;
			var paths=next.split("?");
			if (paths.length<2){
				return true;
			}else{
				var qs=queryStringToArray(paths[1]);
				return true;
			}
		}

	}

	return null;
};



AP.rewriteRedirect=function(url){
	for (var i=0; i<AP.rules.length; i++){
		var temp=AP.rules[i];

		if (url.match(RegExp(temp.pattern))){
			var qs={};
			var original_qs=url.split("?");
			if (original_qs.length==2 && temp.qsa){
				qs=queryStringToArray(original_qs[1]);
			}

			var next=url.replace(new RegExp(temp.pattern), temp.replace);
			var fn=temp.callback;
			var paths=next.split("?");

			if (paths.length<2){
				fn.call(AP.__urlref, qs);
				return true;
			}else{
				var new_qs=queryStringToArray(paths[1]);
				for (var key in new_qs){
					qs[key]=new_qs[key];
				}
				fn.call(AP.__urlref, qs);
				return true;
			}
		}

	}

	return null;
};




AP.config={};


AP.event=new function __APEvent(){
	this.events={};
	this.__fired={};

	this.clear=function(){
		this.events={};
		this.__fired={};
	};

	this.removeListener=function(ev){
		if (this.events[ev] && this.events[ev].length){
			this.events[ev]=[];
			delete this.events[ev];
		}
	};

	this.trigger=function(ev, data){
		if (this.events[ev] && this.events[ev].length){
			for (var i=0; i<this.events[ev].length; i++){
				var fn=this.events[ev][i];
				if (!fn){
					break;
				}

				if (fn._caller){
					fn.apply(fn._caller, data);
				}else{
					if (AP.data.isArray(data)){
						fn.apply(undefined, data);
					}else{
						fn(data);
					}

				}
			}
		}

		this.__fired[ev]=1;
		return this;
	};


	this.release=function(ev){
		if (this.events[ev] && this.events[ev].length){
			while (true){
				var fn=this.events[ev].shift();
				if (!fn){
					break;
				}

				if (fn._caller){
					fn.apply(fn._caller);
				}else{
					fn();
				}
			}
		}

		this.__fired[ev]=1;
		return this;
	};


	this.bind=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}

		if (_caller){
			fx._caller=_caller;
		}

		this.events[ev].push(fx);

		return this;
	};


	/**
	 * @desc Reset all current binds and rebind
	 */
	this.rebind=function(ev, fx, _caller){
		this.events[ev]=[];

		if (_caller){
			fx._caller=_caller;
		}

		this.events[ev].push(fx);

		return this;
	};



	this.bindAll=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}

		if (_caller){
			fx._caller=_caller;
		}

		this.events[ev]=[fx]; // Replace

		return this;
	};


	this.fired=function(ev){
		if (this.__fired[ev]){
			return true;
		}
		return false;
	};
};






function range(from, to, space){
	if (!space || typeof space=="undefined"){
		space=1;
	}

	var r=[];
	if (from<to){
		for (var i=from; i<=to; i=i+space){
			r.push(""+i);
		}
		return r;
	}else{
		for (var i=from; i>=to; i=i-space){
			r.push(""+i);
		}
		return r;
	}

};


function undone(msg){
	if (msg){
		AP.alertError(msg);
	}else{
		AP.alertError("This feature is either disabled or not ready for public yet. Please try again later.");
	}
};



//GetPageScroll() by quirksmode.com
function getViewport() {
	var xScroll, yScroll;
	if (self.pageYOffset) {
	  yScroll = self.pageYOffset;
	  xScroll = self.pageXOffset;
	} else if (document.documentElement && document.documentElement.scrollTop) {
	  yScroll = document.documentElement.scrollTop;
	  xScroll = document.documentElement.scrollLeft;
	} else if (document.body) {
	  yScroll = document.body.scrollTop;
	  xScroll = document.body.scrollLeft;
	}
	return new Array(xScroll,yScroll);
}



function getUploadFN(str){
	str=str.replace(/\\/g,'/');
	var parts=str.split("/");
	if (!parts || parts.length<1){
		return false;
	}
	return parts[parts.length-1];
}




function getHash(href){
	if (!href){
		return null;
	}
	if (href.indexOf('#')!=-1){
		return null;
	}

	var path=href.split("//", 2);
	if (!path || path.length!=2){
		return;
	}
	var sub_path=path[1];
	var url=sub_path.split("/");
	if (!url || url.length<2){
		return;
	}
	url=AP.array.sub(url, 1);
	return url;
};


function safe(txt){
	return AP.purify(txt);
};

function inline(content, max_length, append_dots){
	if (!max_length){
		max_length=255;
	}
	
	if (content === null || typeof content == "undefined"){
		return '';
	}
	
	var _content = content.replace(/<\/p>\s*<p>/g, '</p> &#8628; </p>').replace(/<\/div>\s*<div>/g, '</div> &#8628; </div>').replace(/<br\/*>/g, ' &#8628; ');
	var extra = " ";
	if (append_dots){
		extra = " ...";
	}
	
	return AP.word.shorten(AP.purify(_content),max_length, extra);
};

function purify(txt){
	var str=safe(txt);
	var defaultDiacriticsRemovalMap = [
			{'base':'A', 'letters':/[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]/g},
			{'base':'AA','letters':/[\uA732]/g},
			{'base':'AE','letters':/[\u00C6\u01FC\u01E2]/g},
			{'base':'AO','letters':/[\uA734]/g},
			{'base':'AU','letters':/[\uA736]/g},
			{'base':'AV','letters':/[\uA738\uA73A]/g},
			{'base':'AY','letters':/[\uA73C]/g},
			{'base':'B', 'letters':/[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]/g},
			{'base':'C', 'letters':/[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]/g},
			{'base':'D', 'letters':/[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]/g},
			{'base':'DZ','letters':/[\u01F1\u01C4]/g},
			{'base':'Dz','letters':/[\u01F2\u01C5]/g},
			{'base':'E', 'letters':/[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]/g},
			{'base':'F', 'letters':/[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]/g},
			{'base':'G', 'letters':/[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]/g},
			{'base':'H', 'letters':/[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]/g},
			{'base':'I', 'letters':/[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]/g},
			{'base':'J', 'letters':/[\u004A\u24BF\uFF2A\u0134\u0248]/g},
			{'base':'K', 'letters':/[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]/g},
			{'base':'L', 'letters':/[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]/g},
			{'base':'LJ','letters':/[\u01C7]/g},
			{'base':'Lj','letters':/[\u01C8]/g},
			{'base':'M', 'letters':/[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]/g},
			{'base':'N', 'letters':/[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]/g},
			{'base':'NJ','letters':/[\u01CA]/g},
			{'base':'Nj','letters':/[\u01CB]/g},
			{'base':'O', 'letters':/[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]/g},
			{'base':'OI','letters':/[\u01A2]/g},
			{'base':'OO','letters':/[\uA74E]/g},
			{'base':'OU','letters':/[\u0222]/g},
			{'base':'P', 'letters':/[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]/g},
			{'base':'Q', 'letters':/[\u0051\u24C6\uFF31\uA756\uA758\u024A]/g},
			{'base':'R', 'letters':/[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]/g},
			{'base':'S', 'letters':/[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]/g},
			{'base':'T', 'letters':/[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]/g},
			{'base':'TZ','letters':/[\uA728]/g},
			{'base':'U', 'letters':/[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]/g},
			{'base':'V', 'letters':/[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]/g},
			{'base':'VY','letters':/[\uA760]/g},
			{'base':'W', 'letters':/[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]/g},
			{'base':'X', 'letters':/[\u0058\u24CD\uFF38\u1E8A\u1E8C]/g},
			{'base':'Y', 'letters':/[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]/g},
			{'base':'Z', 'letters':/[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]/g},
			{'base':'a', 'letters':/[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]/g},
			{'base':'aa','letters':/[\uA733]/g},
			{'base':'ae','letters':/[\u00E6\u01FD\u01E3]/g},
			{'base':'ao','letters':/[\uA735]/g},
			{'base':'au','letters':/[\uA737]/g},
			{'base':'av','letters':/[\uA739\uA73B]/g},
			{'base':'ay','letters':/[\uA73D]/g},
			{'base':'b', 'letters':/[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]/g},
			{'base':'c', 'letters':/[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]/g},
			{'base':'d', 'letters':/[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]/g},
			{'base':'dz','letters':/[\u01F3\u01C6]/g},
			{'base':'e', 'letters':/[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]/g},
			{'base':'f', 'letters':/[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]/g},
			{'base':'g', 'letters':/[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]/g},
			{'base':'h', 'letters':/[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]/g},
			{'base':'hv','letters':/[\u0195]/g},
			{'base':'i', 'letters':/[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]/g},
			{'base':'j', 'letters':/[\u006A\u24D9\uFF4A\u0135\u01F0\u0249]/g},
			{'base':'k', 'letters':/[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]/g},
			{'base':'l', 'letters':/[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]/g},
			{'base':'lj','letters':/[\u01C9]/g},
			{'base':'m', 'letters':/[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]/g},
			{'base':'n', 'letters':/[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]/g},
			{'base':'nj','letters':/[\u01CC]/g},
			{'base':'o', 'letters':/[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]/g},
			{'base':'oi','letters':/[\u01A3]/g},
			{'base':'ou','letters':/[\u0223]/g},
			{'base':'oo','letters':/[\uA74F]/g},
			{'base':'p','letters':/[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]/g},
			{'base':'q','letters':/[\u0071\u24E0\uFF51\u024B\uA757\uA759]/g},
			{'base':'r','letters':/[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]/g},
			{'base':'s','letters':/[\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]/g},
			{'base':'t','letters':/[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]/g},
			{'base':'tz','letters':/[\uA729]/g},
			{'base':'u','letters':/[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]/g},
			{'base':'v','letters':/[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]/g},
			{'base':'vy','letters':/[\uA761]/g},
			{'base':'w','letters':/[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]/g},
			{'base':'x','letters':/[\u0078\u24E7\uFF58\u1E8B\u1E8D]/g},
			{'base':'y','letters':/[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]/g},
			{'base':'z','letters':/[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]/g}
		  ];

	for (var i=0; i<defaultDiacriticsRemovalMap.length; i++) {
		str = str.replace(defaultDiacriticsRemovalMap[i].letters, defaultDiacriticsRemovalMap[i].base);
	}

	str=str.replace(/[\W_]+/g," ");
	str=$.trim(str);
	return str.toLowerCase();
};

function purifyStrict(str, sep){
	if (!sep){
		sep = "";
	}
	var s=purify(str);
	s=s.replace(/[\W_\s]+/g, sep);
	return s.toLowerCase();
};

function shallowClone(obj){
	if (!AP.data.isObject(obj)){
		return obj;
	}
	
	var temp={};
	for (var key in obj){
		temp[key]=obj[key];
	}

	return temp;
};





function getScrollbarWidth(){
	var jTest = $('<div style="display:none;height:50px;overflow: scroll"><div style="height:100px;"></div></div>');
    $('body').append(jTest);
    var w = jTest.innerWidth();
    jTest.css({
        overflow: 'auto',
        height: '200px'
    });
    var w2 = jTest.innerWidth();
    var c= w-w2;

	return (c > 0) ? c : 15; // fix invisible scrollbar on MacOSX
	
	var scrollbarWidth = 0;
	if (!scrollbarWidth) {
		if ( $.browser.msie ) {
			var $textarea1 = $('<textarea cols="10" rows="2"></textarea>')
					.css({ position: 'absolute', top: -1000, left: -1000 }).appendTo('body'),
				$textarea2 = $('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>')
					.css({ position: 'absolute', top: -1000, left: -1000 }).appendTo('body');
			scrollbarWidth = $textarea1.width() - $textarea2.width();
			$textarea1.add($textarea2).remove();
		} else {
			var $div = $('<div />')
				.css({ width: 100, height: 100, overflow: 'auto', position: 'absolute', top: -1000, left: -1000 })
				.prependTo('body').append('<div />').find('div')
					.css({ width: '100%', height: 200 });
			scrollbarWidth = 100 - $div.width();
			$div.parent().remove();
		}
	}
	return scrollbarWidth;
};







function parseCode(txt){
	if (AP.isObject(txt)){
		return new Code(txt);
	}

	try{
		var tmp = txt.substring(txt.indexOf('{"code"'));
		return new Code(eval("("+tmp+")"));
	}catch(e){
		return new Code({"code":0, "message":'Unknown Error',"data":null, "error":"parse error"});
	}
}




var ExitCode = new function _ExitCode(){
	this.fns={};

	/**
	 * @desc Register a callback on code
	 */
	this.reg=function(code, fn){
		this.fns[code]=fn;
	};


	/**
	 * @desc Execute the callback marked by code (and data is the param)
	 */
	this.execute=function(code, data){
		var fn=this.fns[code];
		if (fn){
			fn(data);
		}else{
			$.log("Unknown exitcode "+code);
		}
	}
};


function assoc(data){
	if (AP.data.isArray(data)){
		var obj={};
		for (var i=0; i<data.length; i++){
			obj[data[i].name]=data[i].value;
		}
		return obj;	
	}
	
	var obj={};
	obj[arguments[0]]=arguments[1];
	return obj;
};



function assoc2(data){
	if (AP.data.isArray(data)){
		var obj={};
		for (var i=0; i<data.length; i++){
			if (AP.word.suffix(data[i].name, '[]')){
				var n = data[i].name.substr(0, data[i].name.length-2);
				if (obj[n]){
					obj[n].push(data[i].value);
				}else{
					obj[n] = [data[i].value];
				}
			}else{
				obj[data[i].name]=data[i].value;	
			}
			
		}
		return obj;	
	}
	
	var obj={};
	obj[arguments[0]]=arguments[1];
	return obj;
};


function mobile(){
	return (Client.mobile && Client.mobile==1);
};


function __(str, cond){
	if (cond) return str;
	return "";
};


function ___(str, other){
	if (!str || !str.length){
		return other;
	}
	return str;
};





function Code(obj){
	this.code=0;
	this.message='';
	this.data=null;

	if (obj){
		$.extend(this, obj);
		this.code=parseInt(this.code);
	}


	/**
	 * @desc Check if a code is good.
	 */
	this.good=function(){
		if (this.hasCode(1)) return true;
		return false;
	};

	this.notEmpty=function(){
		return !this.empty;
	};

	this.hasCode=function(code){
		if (this.code==code){
			return true;
		}
		return false;
	};


	this.hasMessage=function(message){
		if (this.message==message){
			return true;
		}
		if (AP.isInt(message) && this.message && message==parseInt(this.message)){
			return true;
		}
		return false;
	};
};



Code.init=function(txt){
	try{
		return new Code(eval("("+txt+")"));
	}
	catch(e){
		return new Code({"code":0, "message":'Unknown error',"data":null, "error":"parse_error"});
	}
};


Code.error = function(msg){
	var c=new Code();
	c.message=msg;
	return c;
};





var fxs={};
var fxe={};

function APJSONCALLBACK(data){
	if (data.fx){
		var fn=fxs[data.fx];
		var code=new Code(data);
		if (code){
			fn(code);
		}else{
			var err=fxe[data.fx];
			if (err){
				err(code);
			}
		}
		$("#"+data.fx).remove();
	}
};


function APJSONREG(fx, fn, fn_error){
	fxs[fx]=fn;
	fxe[fx]=fn_error;
};


function queryStringToArray(qs){
	var parts=qs.split("&");
	var r={};
	for (var i=0; i<parts.length; i++){
		var data=parts[i].split("=");
		if (data && data.length==2){
			r[data[0]]=data[1];
		}
	}

	return r;
};


function isFormData(data){
	return (data && Client.native && data instanceof FormData);
};







function __selfcall(ref){
	var fn=$(ref).data("action");
	if (fn){
		fn();	
	}
};



function $$(fn){
	if (Client.env && !parseInt(Client.env)){
		fn();
	}
};




AP._locales={};

AP.locale=new function __APLocale(){
	this.get=function(key, df){
		if (AP._locales[key]){
			return AP._locales[key];
		}
		if (df){
			return df;
		}

		return null;
	}

	this.set=function(key, val){
		AP._locales[key]=val;
	};

};


AP.json = new function __APJSON(){
	this.parse = function(str){
		try {
			var a = JSON.parse(str);
			return a;
		} catch(e) {
			return null;
		}
	};
};


AP.cors=new function __APCORS(){
	this.url=null;
	this.pm_token=null;
	this.callback=null;
	this.__init=false;

	this.register=function(url, token, callback){
		this.init();
		this.url=url;
		this.pm_token=token;
		this.callback=callback;
	};


	this.init=function(){
		// INIT ONCE
		if (this.__init){
			return;
		}

		this.__init=true;

		var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
		var apeventer = window[eventMethod];
		var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

		// Listen to message from child window
		apeventer(messageEvent, function(e) {
			if (typeof e.data.pm_token == 'undefined') return;
			if (e.data.pm_token!=AP.cors.pm_token){
				AP.alertError("Security error (invalid pm token)");
			}

			if (!AP.word.prefix(AP.cors.url, e.origin)){
				AP.alertError("Security error (invalid origin)");
			}

			var obj=parseCode(e.data);
			if (AP.cors.callback){
				AP.cors.callback(obj);
			}
		}, false);
	}
};



AP.postmessage=new function __APPostMessage(){
	this.__inited=false;
	this.__token = 0;
	this.events={};
	
	this.init=function(){
		if (this.__inited){
			return;
		}
		
		this.__inited=true;
		this.__token=AP.uuid();
		
		this.listen(function(data, domain){
			var event=data.event;
			var token=data.token;
			
			if (data && data.__exchange){
				token=data.base_token;
			}
			
			if (token!=AP.postmessage.token()){
				$.log("POST_MESSAGE_TOKEN_ERROR");
				return;
			}
			
			var fn=AP.postmessage.events[event];
			if (fn){
				if (data.__exchange){
					if (data.data && data.data.silent){
					}else{
						Base.api.closeDialog();	
					}
					
					fn(data.data);
				}else{
					fn(data);	
				}
				
			}
		});
	};
	
	this.register=function(event, callback){
		this.events[event]=callback;
	};
	
	this.token=function(){
		this.init();
		return this.__token;
	};
	
	
	this.toParent=function(data, parent_domain){
		data.token= Query.get("base_token");
		data.event= Query.get("event");
		
		parent.postMessage(data, parent_domain);
	};

	this.toAll=function(ifr_selector, data){
		$(document.body).find(ifr_selector).each(function(){
			$(this).on("load", function(){
				$(this).data("loaded", 1);
				var src=$(this).attr("src");
				var fr=$(this)[0].contentWindow;
				var domain=getDomain($(this).attr("src"));
				fr.postMessage(data, domain);
			});

			if (!$(this).is(":visible")){
				return;
			}

			var src=$(this).attr("src");
			var fr=$(this)[0].contentWindow;
			var domain=getDomain($(this).attr("src"));
			fr.postMessage(data, domain);

		});
	};

	this.toChild=function(ifr, data){
		$(ifr).each(function(){
			$(this).on("load", function(){
				$(this).data("loaded", 1);
				var src=$(this).attr("src");
				var fr=$(this)[0].contentWindow;
				var domain=getDomain($(this).attr("src"));
				fr.postMessage(data, domain);
			});

			if (!$(this).is(":visible")){
				return;
			}

			var src=$(this).attr("src");
			var fr=$(this)[0].contentWindow;
			var domain=getDomain($(this).attr("src"));
			fr.postMessage(data, domain);

		});
	};

	this.listen=function(handler){
		var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
		var eventer = window[eventMethod];
		var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

		eventer(messageEvent,function(e){
			handler(e.data, e.origin);
		},false);
	};


	function getDomain(url){
		var part=AP.word.split("/", url);
		if (part.length<2){
			return "*";
		}

		return part[0]+"//"+part[1];
	};
};


AP.cmp=new function __APCmp(){
	this.int=function(a, b){
		return parseInt(a)==parseInt(b);
	};

	this.str=function(a,b){
		return a.toLowercase()==b.toLowercase();
	}
};



function explain(txt, opts){
	if (opts && opts===true){
		opts={icon: false};
	}

	opts=$.extend({direction: 'up', width: 200, icon: true}, opts);
	
	
	var align = '';
	if ('align' in opts){
		align = "-align-"+(opts.align)+"";
	}
	
	if (!opts.icon){
		return "<span class='-infobox -"+opts.direction+" "+align+" -w"+opts.width+"'><span class='-box block normal'>"+txt+"</span></span>";
	}

	return "&nbsp; <span class='inline relative -infow'><span class='-ap icon-help-with-circle'></span> <span class='-infobox -"+opts.direction+" "+align+" -w"+opts.width+"'><span class='-box block normal'>"+txt+"</span></span></span>";
};


function floatDiff(v1, v2){
	return (parseFloat(v1)*1000 - parseFloat(v2) * 1000)>=1;
};


(function() {
	var beforePrint = function() {
		AP.__printing=1;
	};
	var afterPrint = function() {
		AP.__printing=0;
	};

	if (window.matchMedia) {
		var mediaQueryList = window.matchMedia('print');
		mediaQueryList.addListener(function(mql) {
			if (mql.matches) {
				beforePrint();
			} else {
				afterPrint();
			}
		});
	}

	window.onbeforeprint = beforePrint;
	window.onafterprint = afterPrint;
}());


var CP = Client.pageData;




AP.time={
	
	/**
	 * @desc Please reset this if you want to use locale words
	 */	
	months:["January","February","March","April","May","June","July","August","September","October","November","December"],
	sMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
	days:["Thá»© 2","Thá»© 3", "Thá»© 4", "Thá»© 5","Thá»© 6","Thá»© 7", "Chá»§ nháº­t"],	
	sDays:["Mon","Tue", "Wed", "Thu","Fri","Sat","Sun"],  
	tDays:["T2", "T3", "T4", "T5", "T6", "T7", "CN"],
	tvDays:["Thá»© 2", "Thá»© 3", "Thá»© 4", "Thá»© 5", "Thá»© 6", "Thá»© 7", "Chá»§ Nháº­t"],
	
	mktime: function(ts){
		if (!ts){
			t = new Date();
		}else{
			t = new Date(parseInt(ts)*1000);
		}
		
		return t;
	},
	
	
	/**
	 * @desc Handler time function.
	 */
	time:function(pattern, time_stamp){
		var t = this.mktime(time_stamp);
		
		var _year = t.getFullYear();
		var _month= t.getMonth()+1;
				
		var month=_month;
		if (_month<10){
			month="0"+_month;
		}
		
		var _day=(t.getDay()||7)-1;
		
		var _date=t.getDate();
		
		var date=_date;
		if (_date<10){
			date="0"+_date;
		}
		
		var _hour=t.getHours();
		var _hour12=(_hour%12);
		var hour=_hour;
		if (_hour<10){
			hour="0"+_hour;
		}
		
		var _minute=t.getMinutes();	
		var _second=t.getSeconds();
		
		
		var r=pattern;
		var tday=AP.time.tDays[_day];
		var vday=AP.time.tvDays[_day];
		
		// Day & Date
		r=r.replace("%d", date);
		r=r.replace("%D", AP.time.sDays[_day]);
		r=r.replace("%j", _date);
		r=r.replace("%l", AP.time.days[_day]);
		r=r.replace("%N", _day+1);
		r=r.replace("%w", _day);
		r=r.replace("%T", tday);
		r=r.replace("%v", tday);
		r=r.replace("%V", vday);
		
		// Month
		r=r.replace("%F", AP.time.months[_month-1]);
		r=r.replace("%m", month);
		r=r.replace("%M", AP.time.sMonths[_month-1]);
		r=r.replace("%n", _month);
		r=r.replace("%t", new Date(_year, _month, 0).getDate());
		
		// Year
		r=r.replace("%L", (new Date(_year, 1,29).getMonth()==1));
		r=r.replace("%o", _year);
		r=r.replace("%Y", _year);
		r=r.replace("%y", _year.toString().substr(2));
		
		// Hour & Minute & Second
		r=r.replace("%a", (_hour<12)?"am":"pm");
		r=r.replace("%A", (_hour<12)?"AM":"PM");
		r=r.replace("%g", _hour12);
		r=r.replace("%G", _hour);
		r=r.replace("%h", (_hour12<10)?("0"+_hour12):_hour12);
		r=r.replace("%H", (_hour<10)?("0"+_hour):_hour);
		r=r.replace("%i", (_minute<10)?("0"+_minute):_minute);
		r=r.replace("%s", (_second<10)?("0"+_second):_second);
		r=r.replace("%u", t.getMilliseconds()*1000);
		
		// Timezone
		r=r.replace("%Z", -t.getTimezoneOffset()*60);
	
		return r;
	},
	
	hm: function(time){
		var h=AP.data.zeroPrefix(Math.floor(time/3600));
		var m=AP.data.zeroPrefix(Math.floor((time-h*3600)/60));
		return h+":"+m;
	},
	
	beginOfDay: function(time_stamp){
		var t = this.mktime(time_stamp);
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth(), t.getDate()));
	},
	
	beginOfMonth: function(time_stamp){
		var t = this.mktime(time_stamp);
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth(), 1));
	},
	
	endOfMonth: function(time_stamp){
		var t = this.mktime(time_stamp);
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth()+1, 0));
	},
	
	
	midnight: function(time_stamp){
		var t = this.mktime(time_stamp);
		return AP.time.timeStamp(new Date(t.getFullYear(), t.getMonth(), t.getDate(), 23, 59, 59));
	},
	
	beginOfWeek: function(time_stamp){
		return AP.time.firstDayOfWeek(time_stamp);
	},

	endOfWeek: function(time_stamp){
		return AP.time.firstDayOfWeek(time_stamp)+6*24*3600;
	},
	
	sameDay: function(ts1, ts2){
		return AP.time.beginOfDay(parseInt(ts1))==AP.time.beginOfDay(parseInt(ts2));
	},
	
	sameYear: function(ts1, ts2){
		return AP.time.time("%Y",ts1)==AP.time.time("%Y",ts2);
	},
	sameMonth: function(ts1, ts2){
		return AP.time.time("%m%Y",ts1)==AP.time.time("%m%Y",ts2);
	},
	sameWeek: function(ts1, ts2){
		return AP.time.firstDayOfWeek(parseInt(ts1))==AP.time.firstDayOfWeek(parseInt(ts2));
	},
	
	test: function(ts){
		return AP.time.time("%Y %m %d, %H:%i:%s", ts);
	},
	
	/**
	 * @desc Get the previous Monday
	 * @param time_stamp
	 * @returns
	 */
	firstDayOfWeek: function(time_stamp){
		var t = this.mktime(time_stamp);
		
		// Get the first day of week [Return timestamp]
		var day=(t.getDay() || 7)-1;

		t.setHours(-24 * day);
		t.setSeconds(0);
		t.setMinutes(0);
		t.setHours(0);
		
		return AP.time.timeStamp(t);
	},
	
	
	/**
	 * @desc Get the first day of the current month
	 * @param time_stamp
	 * @returns
	 */
	firstDayOfMonth: function(time_stamp){
		var t = this.mktime(time_stamp);
		
		t.setDate(1);
		t.setSeconds(0);
		t.setMinutes(0);
		t.setHours(0);
		
		return AP.time.timeStamp(t);
	},
	
	
	
	timeStamp:function(d){
		if (!d){
			d=new Date();
		}
		return Math.floor(d.getTime()/1000);
	},
	
	now: function(){
		return Math.floor((new Date()).getTime()/1000);
	},
	
	date: function(time_stamp){
		return this.mktime(time_stamp);
	},
	
	ago: function(time_stamp){
		time_stamp=parseInt(time_stamp);
		var t = this.timeStamp();
		var diff=t-time_stamp;
		
		if (diff<5){
			return "vĂ i giĂ¢y trÆ°á»›c";
		}
		if (diff<60){
			return diff+" "+'giĂ¢y trÆ°á»›c';
		}
		if (diff<3600){
			return Math.floor(diff/60)+" "+'phĂºt trÆ°á»›c';
		}
		if (diff<3600*24){
			return Math.floor(diff/3600)+" "+'hours ago';
		}
		return Math.floor(diff/86400)+" "+'ngĂ y trÆ°á»›c';
	},
	
	
	late: function(actual_time, deadline){
		if (!deadline){
			deadline=0;
		}
		
		var diff=parseInt(actual_time)-parseInt(deadline);
		if (diff<0){
			return "---";
		}
		
		if (diff<5){
			return lang("few seconds");
		}
		if (diff<60){
			return diff+" "+lang('seconds');
		}
		
		if (diff<3600){
			return Math.floor(diff/60)+"m";
		}
		
		if (diff<3600*24){
			var h=Math.floor(diff/3600);
			var min=Math.floor((diff-h*3600)/60);
			return h+"h"+min+"m";
		}
		
		var h=Math.floor(diff/86400);
		
		if (h==1){
			return h+" "+lang('day');	
		}
		
		return h+" "+lang('days');
	},
	
	remain: function(deadline){
		return AP.time.late(-AP.time.now(), -deadline);
	},
	
	
	countdown: function(obj, __render){
		AP.rtimeout(function(){
			var ts="";
			
			var data=$(obj).data('timeremain');
			data=parseInt(data);
			
			if (data && data>=0){
				var d=Math.floor(data/(3600*24));
				var h=Math.floor((data -d*24*3600) /3600);
				var m=Math.floor((data-h*3600-d*24*3600)/60);
				var s=data-d*24*3600-h*3600-m*60;
				var ts=h+"h "+m+"m "+s+"s";
				if (d>0){
					ts=d+"d "+h+"h "+m+"m "+s+"s";
				}
				
				if (__render){
					ts=__render(d,h,m,s);
				}
			}
			
			
			
			$(obj).html(ts);
			
			if (data>=0){
				data=data-1;
				$(obj).data('timeremain', data);
			}
		}, 1000);
	},
	
	

	count: function(initial, callback, finish){
		var t=this.now();
		AP.rtimeout(function(){
			var c=AP.time.now();
			var rem=initial+t-c;
			if (rem<0){
				finish();
			}else{
				callback(rem);
			}
		},1000);
	},
	
	dow: function(index){
		return this.tvDays[index];
	},
	
	diff: function(from, to){
		from = parseInt(from);
		to = parseInt(to);

		if (to<=from){
			return {year: 0, day: 0, day_counts: 0};
		}
		
		
		from = this.beginOfDay(from);
		to = this.beginOfDay(to);
		
		var df = new Date(from * 1000);
		var dt = new Date(to * 1000);
		
		var r = {year: dt.getFullYear() - df.getFullYear(), day: 0, day_counts: Math.floor((to-from)/(24*3600))};
		
		var same_year = new Date(from*1000);
		same_year.setFullYear(dt.getFullYear());
		var sy_ts = this.timeStamp(same_year);
		
		if (sy_ts <= to){
			r.day = Math.floor((to - sy_ts)/(24*3600));
		}else{
			r.year = r.year-1;
			same_year.setFullYear(dt.getFullYear()-1);
			sy_ts = this.timeStamp(same_year);
			r.day = Math.floor((to - sy_ts)/(24*3600));
		}
		
		return r;
	}
};


AP.i18n=new function __APi18n(){
	this.confs={date_format: "dmy", time_format:"hm"};
	
	this.get=function(key){
		var confs=$.extend(this.confs, Client.i18n);
		return confs[key];
	};
	
	this.dateFormat=function(){
		var format=this.get("date_format");
		if (format=="dmy"){
			return "%d/%m/%Y";
		}else if (format=="full"){
			return "%l, %F %d, %Y";
		}else{
			return "%m/%d/%Y";
		}
	};
	
	this.date=function(ts){
		return AP.time.time(this.dateFormat(), ts);
	};
	
	this.safeDate=function(ts){
		if (!ts || !parseInt(ts)){
			return '<span>---</span>';
		}
		
		return this.date(ts);
	};
	
	this.datetime=function(ts){
		return AP.time.time("%H:%i "+this.dateFormat(), ts);
	};
	
	this.time=function(ts){
		return AP.time.time("%H:%i", ts);
	};
	
	this.readDate=function(str){
		var data=str.split("/");
		if (data.length!=3){
			return 0;
		}
		
		var day=parseInt(data[0]);
		var month=parseInt(data[1])-1;
		var year=parseInt(data[2]);
		
		var ts=new Date(year, month, day, 0, 0, 0, 0);
		return Math.floor(ts.getTime()/1000);
	};
	
	this.dateRange=function(stime, etime){
		stime=parseInt(stime);
		etime=parseInt(etime);
		
		if (etime){
			if (AP.time.sameYear(stime, etime)){
				return AP.time.time("%d/%m", stime)+" - " + AP.time.time("%d/%m/%y", etime);
			}else{
				return AP.time.time("%d/%m/%y", stime)+" - " + AP.time.time("%d/%m/%y", etime);
			}
		}else{
			if (parseInt(stime)){
				return AP.time.time("%d/%m/%y", stime)+" &#8702; ... ";
			}else{
				return "... "+" &#8702; ... ";	
			}
		}
	};
	
	
	this.timeRange=function(stime, etime){
		stime=parseInt(stime);
		etime=parseInt(etime);
		
		if (etime){
			if (AP.time.sameYear(stime, etime)){
				return AP.time.time("%H:%i %d/%m", stime)+" - " + AP.time.time("%H:%i %d/%m", etime);
			}else{
				return AP.time.time("%H:%i %d/%m", stime)+" - " + AP.time.time("%H:%i %d/%m", etime);
			}
		}else{
			return AP.time.time("%H:%i %d/%m/%y", stime)+" &#8702; ... ";
		}
	};
	
	this.range=this.dateRange;
	

	this.range2=function(stime, etime){
		stime=parseInt(stime);
		etime=parseInt(etime);
		
		if (etime){
			if (AP.time.sameYear(stime, etime)){
				return AP.time.time("%d/%m", stime)+" - " + AP.time.time("%d/%m/%Y", etime);
			}else{
				return AP.time.time("%d/%m/%Y", stime)+" - " + AP.time.time("%d/%m/%Y", etime);
			}
		}else{
			if (parseInt(stime)){
				return AP.time.time("%d/%m/%Y", stime)+" &#8702; ... ";
			}else{
				return "... "+" &#8702; ... ";	
			}
		}
	};
	
	
	
	this.duration=function(total_seconds, compact){
		if (compact){
			return this.durationCompact(total_seconds);
			
		}
		
		var s=parseInt(total_seconds);
		if (s<3600){
			var m=Math.floor(s/60);
			return "<em>"+(m)+"</em>m";
		}
		
		if (s<48*3600){
			var h=Math.floor(s/3600);
			var m=Math.floor((s-h*3600)/60);
			return "<em>"+(h)+"</em>h<em>"+(m)+"</em>m";
		}
		
		var d=Math.floor(s/(24*3600));
		var h=Math.floor((s-d*24*3600)/3600);
		var m=Math.floor((s-d*24*3600-h*3600)/60);
		return "<em>"+(d)+"</em>d<em>"+(h)+"</em>h<em>"+(m)+"</em>m";
	};
	
	
	this.durationCompact=function(total_seconds){
		var s=parseInt(total_seconds);
		if (s<3600){
			var m=parseFloat(s/60).toFixed(1);
			return "<em>"+(m)+"</em>m";
		}
		
		if (s<48*3600){
			var h=parseFloat(s/3600).toFixed(1);
			return "<em>"+(h)+"</em>h";
		}
		
		var d=parseFloat(s/(24*3600)).toFixed(1);
		return "<em>"+(d)+"</em>d";
	};
	
	
	
	function getTimezones(){
		var opts = range(-12, 12);
		var r = [];
		
		for (var i=0; i<opts.length; i++){
			var sign ='+';
			if (opts[i]<0){
				sign = '';
			}
			
			r.push({value: opts[i], label: "GMT"+(sign)+""+(opts[i])+""})
		}
		
		return r;
	};
	
	
	function getMonths(){
		var opts = range(1, 12);
		var r = [];
		for (var i=0; i< opts.length; i++){
			r.push({value: opts[i], label: AP.time.months[opts[i]-1]})
		}
		
		return r;
	};
	
	
	this.options = {
		timezones: getTimezones(),
		monthes: getMonths(),
	}
	
};


AP.hotkey=new function __APHotKey(){
	this.__init=false;
	this.__dialog=false;
	this.events={};
	
	
	this.init=function(dialog){
		if (this.__init){
			return this;
		}
		
		if (!dialog){
			dialog=false;
		}
		
		this.__dialog=dialog;
		this.__init=true;
		this.bind();
		return this;
	};
	
	this.on=function(key, fn){
		this.events[key]=fn;
		return this;
	};
	
	this.clear=function(){
		this.__init=false;
		this.events={};
		
		return this;
	};
	
	
	this.moveable=function(elems, options){
		if (!options){
			options={};
		}
		
		options=$.extend({first: -1, activeClass: 'active'}, options);
		this.on("up", function(e){
			refocus(elems, -1, options);
		}).on("down", function(e){
			refocus(elems, 1, options);
		}).on("enter", function(e){
			$(elems).filter(".active").first().find(".url").click();
		});
		
		$(elems).first().addClass("active");

	};
	
	
	
	this.bind=function(){
		$(document).on('keydown.__temp', function(e){
			if (!AP.hotkey.__dialog && $("#apdialogs").is(":visible")){
				return;
			}
			
			var tag = e.target.tagName.toLowerCase();
			if (tag != 'input' && tag != 'textarea' && !$(e.target).hasClass("trumbowyg-editor")){

				var ev=findCb(AP.hotkey.events, e.which);
				if (ev){
					if (ev.delay){
						setTimeout(function(){
							ev(e);
						}, 250);	
					}else{
						ev(e);
					}
				}
			}
		});
		
		return this;
	};
	
	function findCb(evs, keycode){
		if (keycode==AP.key.right && evs["right"]){
			return evs["right"];
		}
		
		if (keycode==AP.key.left && evs["left"]){
			return evs["left"];
		}
		
		if (keycode==AP.key.down && evs["down"]){
			return evs["down"];
		}
		
		if (keycode==AP.key.up && evs["up"]){
			return evs["up"];
		}
		
		if (keycode==AP.key.enter && evs["enter"]){
			return evs["enter"];
		}
		
		var c=String.fromCharCode(keycode);
		if (c.match(/^[a-z0-9]+$/i)){
			if (evs[c.toLowerCase()]){
				evs[c.toLowerCase()].delay=1;
				return evs[c.toLowerCase()];
			}
		}
		
		return null;
	};
	
	
	function refocus(elems, pace, options){
		var $elems=$(elems);
		var $elem=$elems.filter(".active");
		var $c=null;
		
		if (!$elem.length){
			$elems.first().addClass("active");
			$c=$elems.first();
		}else{
			if (pace>0 && $elem.next().length){
				$elems.removeClass("active");
				$elem.next().addClass("active");
				$c=$elem.next();
			}else if (pace<0 && $elem.prev().length){
				$elems.removeClass("active");
				$elem.prev().addClass("active");
				$c=$elem.prev();
			}
		}
		
		if ($c && $c.length){
			var $box=$c.closest(".__apscrollbar_target");
			if (!$box.length){
				return;
			}
			var offset=$c.offset().top-$box.offset().top;
			// $.log([$c.offset().top, $box.offset().top, $box.scrollTop()]);
			// Layout.scrollTo($c, 150, 150);
		}
	};
};


function APCaret(ref){
	this.init=function(){
		
	};
};




function CaretHandler(selector){
	this.selector=selector;
	
	this.get=function(){
		if (!$(this.selector).length){
			return;
		}
		
		return plugin_get_caret_position(this.selector);
	};
	
	this.getChar = function(){
		var pos = this.get();
		var val=""+$(this.selector).val();
		if (pos<=0 || pos > val.length){
			return "";
		}
		
		return val.charAt(pos-1);
	};
	
	this.move=function(position){
		$(this.selector).setCursorPosition(position);
	};
	
	this.insert=function(str){
		if (!$(this.selector).length){
			return;
		}
		
		return plugin_textarea_insert(this.selector, str);
	};
	
	this.start=this.get();
};


AP.url=function(url){
	return new APURL(url);
};


function APURL(url){
	this.url=url;
	this.data={};
	
	this.q=function(key, val){
		if (val && val.length){
			this.data[key]=val;	
		}
		return this;
	};
	
	this.text=function(){
		var qs="";
		var total=0;
		for (var key in this.data){
			total++;
		}
		
		var cur=0;
		for (var key in this.data){
			cur++;
			if (cur<total){
				qs+=key+"="+this.data[key]+"&";	
			}else{
				qs+=key+"="+this.data[key];
			}
			
		}
		
		return this.url+"?"+qs;
	};
	
	
	this.current=function(){
		return window.location.href;
	};
	
	this.self=function(){
		return this.current;
	};
};


AP.currency=new function __APCurrency(){
	this.cur="vnd";
	
	/**
	 * @desc Init & set currency
	 */
	this.init=function(cur){
		this.cur=cur;
	};
	
	
	/**
	 * @desc Format a number by currency
	 */
	this.format=function(number, cur){
		if (!cur){
			cur=this.cur;
		}
		
		if (cur=="vnd"){
			return this.formatVND(number);
		}
	};
	
	
	this.full=function(number, cur){
		if (!cur){
			cur=this.cur;
		}
		
		if (cur=="vnd"){
			if (!number || number<0.001){
				return '&#8363;<em>0.00</em>';
			}
			
			return '&#8363;<em>'+AP.data.numberFormat(parseInt(number))+"</em>";
		}
	};
	
	
	/**
	 * @desc Alias of format()
	 */
	this.get=function(number, cur){
		return this.format(number, cur);
	};
	
	
	
	this.formatVND=function(number){
		if (AP.data.isNumber(number) && !AP.data.isInt(number)){
			number = parseInt(number);
		}
		
		if (!AP.data.isInt(number)){
			return "&#8363;0";
		}
		
		var n=parseInt(number);
		var txt=AP.data.numberFormat(n);
		
		if (n>=1000000*1000){
			txt="<b>"+(n/1000000000).toFixed(2)+"</b>B";
		}else if (n>=1000000){
			txt="<b>"+(n/1000000).toFixed(2)+"</b>M";
		}else if (n>=100000){
			txt="<b>"+(n/1000).toFixed(2)+"</b>K";
		}
		
		return "&#8363;"+txt;
	};
	
};


// Internal search and index engine to give O(n) operations on search
var SE=new function __SE(){
	this.data={};
	this.pdata={};
	
	this.reset=function(){
		this.data={};
	};
	
	
	this.get=function(key, id){
		if (this.pdata["__"+key] && this.pdata["__"+key]["k"+id]){
			return this.pdata["__"+key]["k"+id];
		}
		
		if (this.data["__"+key] && this.data["__"+key]["k"+id]){
			return this.data["__"+key]["k"+id];
		}
		
		return null;
	};
	
	
	/**
	 * @desc Init cache for O(1) finders
	 */
	this.cache=function(key, arr, index){
		if (!index){
			index='id';
		}
		
		this.data["__"+key]={};
		for (var i=0; i<arr.length; i++){
			this.data["__"+key]["k"+arr[i][index]]=arr[i];
		}
	};
	
	
	/**
	 * @desc Init persistent cache, not clean up after page transition
	 */
	this.pcache=function(key, arr, index){
		if (!index){
			index='id';
		}
		
		this.pdata["__"+key]={};
		for (var i=0; i<arr.length; i++){
			this.pdata["__"+key]["k"+arr[i][index]]=arr[i];
		}
	};
	
	
	this.cached=function(key){
		if (this.data["__"+key] || this.pdata["__"+key]){
			return true;
		}
		
		return false;
	};
	
	
	/**
	 * @desc API V2
	 */
	this.index=function(opts){
		opts=$.extend({
			key: "id",
			forced_rebuild: false,
			dataset: []
		}, opts);
		
		if (!opts.forced_rebuild && this.data["__"+opts.name]){
			return;
		}
		
		this.cache(opts.name, opts.dataset, opts.key);
	};
	
	
	this.find = function(name, value){
		return this.get(name, value);
	};
};


AP.gb = new function __APGB(){
	var __callbacks=[];
	
	this.clear = function(){
		while (true){
			if (!__callbacks || !__callbacks.length){
				break;
			}
			
			var fn = __callbacks.shift();
			if (fn && AP.data.isFunction(fn)){
				fn();
			}
		}
	};
	
	
	this.register = function(fn){
		__callbacks.push(fn);
	};
	
	
};


var Rewrite = new function __Rewrite(){
	
	this.general = function(pattern, callback){
		var actions=[];
		
		var str=pattern.replace(/\{([a-z]+)\}/g, function(ms, m){
			actions.push(m);
			
			if (m=="id" || m=="int"){
				return '([0-9]+)'
			}
			
			return '([a-zA-Z0-9\\.\\-]+)';
		});
		
		var actions_url = AP.render(actions, function(e, index){
			if (index==0){
				return ""+(e)+"=$"+(index+1)+"";
			}
			
			return "&"+(e)+"=$"+(index+1)+"";
		});
		
		actions_url="action?"+actions_url;
		
		AP.rewrite(str, actions_url, function(qs){
			callback.apply(this, [qs]);
		}, true);
	};
	
	
	this.v2 = this.general;
	this.add = this.general;
	this.on = this.general;
	
	
	this.module = function(module, handlers){
		var hx=getTrueHandlers(handlers, module);
		var path = getPath(module);
		
		AP.rewrite(":"+(path)+"/-/([a-zA-Z0-9\.]+)", 'action?action=$1', function(qs){
			if (AP.data.isFunction(hx)){
				hx.apply(this, [qs.action]);	
			}
			
			if (hx[qs.action]){
				hx[qs.action].apply(this);
			}
			
		});
		
	};
	
	
	this.obj=function(module, handlers){
		var path = getPath(module);
		var hx=getTrueHandlers(handlers, module);
		var pattern = ":"+(path)+"/([0-9]+)/([a-zA-Z0-9\.]+)";
		
		AP.rewrite(pattern, 'action?id=$1&action=$2', function(qs){
			var obj = module.fromContext(qs.id);
			
			if (AP.data.isFunction(hx)){
				hx.apply(this, [obj, qs.action, qs]);
				return;
			}
			
			if (hx[qs.action]){
				hx[qs.action].apply(this, [obj, qs]);
				return;
			}
			
			var nx = normalizedName(qs.action);
			
			if (hx[nx]){
				hx[nx].apply(this, [obj, qs]);
				return;
			}
		}, true);
	};
	
	this.unset = function(pattern){
		var rules = [];
		var r = new RegExp(pattern);
		for (var i=0; i<AP.rules.length; i++){
			var p=AP.rules[i].pattern;
			if (r.test(p) || p.indexOf(pattern)!=-1){
			}else{
				rules.push(AP.rules[i]);
			}
		};
		
		AP.rules = rules;
	};
	
	function getTrueHandlers(handlers, module){
		if (!AP.data.isArray(handlers)){
			return handlers;
		}
		
		var hx={};
		for (var i=0; i<handlers.length; i++){
			var name = normalizedName(handlers[i]);
			if (name == "show"){
				hx[name]= module[name];
			}else{
				hx[name]= module.form[name];	
			}
			
		}
		
		return hx;
	};
	
	
	function getPath(module){
		var parts  = module.constructor.name.replace(/_/g,'').match(/[A-Z][a-z]+/g);
		var path = parts.join("/").toLowerCase();
		return path;
	};
	
	
	function normalizedName(action){
		return action.replace(/\.(\w)/, function(txt, match){
			return match.toUpperCase();
		});
	};
	
};



!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Redux={})}(this,function(e){"use strict";var t=function(e){var t,r=e.Symbol;return"function"==typeof r?r.observable?t=r.observable:(t=r("observable"),r.observable=t):t="@@observable",t}("undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof module?module:Function("return this")()),r=function(){return Math.random().toString(36).substring(7).split("").join(".")},n={INIT:"@@redux/INIT"+r(),REPLACE:"@@redux/REPLACE"+r(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+r()}};function o(e,t){var r=t&&t.type;return"Given "+(r&&'action "'+r+'"'||"an action")+', reducer "'+e+'" returned undefined. To ignore an action, you must explicitly return the previous state. If you want this reducer to hold no value, you can return null instead of undefined.'}function i(e,t){return function(){return t(e.apply(this,arguments))}}function u(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce(function(e,t){return function(){return e(t.apply(void 0,arguments))}})}e.createStore=function e(r,o,i){var u;if("function"==typeof o&&"function"==typeof i||"function"==typeof i&&"function"==typeof arguments[3])throw Error("It looks like you are passing several store enhancers to createStore(). This is not supported. Instead, compose them together to a single function");if("function"==typeof o&&void 0===i&&(i=o,o=void 0),void 0!==i){if("function"!=typeof i)throw Error("Expected the enhancer to be a function.");return i(e)(r,o)}if("function"!=typeof r)throw Error("Expected the reducer to be a function.");var a=r,c=o,f=[],s=f,d=!1;function l(){s===f&&(s=f.slice())}function p(){if(d)throw Error("You may not call store.getState() while the reducer is executing. The reducer has already received the state as an argument. Pass it down from the top reducer instead of reading it from the store.");return c}function h(e){if("function"!=typeof e)throw Error("Expected the listener to be a function.");if(d)throw Error("You may not call store.subscribe() while the reducer is executing. If you would like to be notified after the store has been updated, subscribe from a component and invoke store.getState() in the callback to access the latest state. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");var t=!0;return l(),s.push(e),function(){if(t){if(d)throw Error("You may not unsubscribe from a store listener while the reducer is executing. See https://redux.js.org/api-reference/store#subscribe(listener) for more details.");t=!1,l();var r=s.indexOf(e);s.splice(r,1)}}}function y(e){if(!function(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}(e))throw Error("Actions must be plain objects. Use custom middleware for async actions.");if(void 0===e.type)throw Error('Actions may not have an undefined "type" property. Have you misspelled a constant?');if(d)throw Error("Reducers may not dispatch actions.");try{d=!0,c=a(c,e)}finally{d=!1}for(var t=f=s,r=0;t.length>r;r++)(0,t[r])();return e}return y({type:n.INIT}),(u={dispatch:y,subscribe:h,getState:p,replaceReducer:function(e){if("function"!=typeof e)throw Error("Expected the nextReducer to be a function.");a=e,y({type:n.REPLACE})}})[t]=function(){var e,r=h;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new TypeError("Expected the observer to be an object.");function t(){e.next&&e.next(p())}return t(),{unsubscribe:r(t)}}})[t]=function(){return this},e},u},e.combineReducers=function(e){for(var t=Object.keys(e),r={},i=0;t.length>i;i++){var u=t[i];"function"==typeof e[u]&&(r[u]=e[u])}var a,c=Object.keys(r);try{!function(e){Object.keys(e).forEach(function(t){var r=e[t];if(void 0===r(void 0,{type:n.INIT}))throw Error('Reducer "'+t+"\" returned undefined during initialization. If the state passed to the reducer is undefined, you must explicitly return the initial state. The initial state may not be undefined. If you don't want to set a value for this reducer, you can use null instead of undefined.");if(void 0===r(void 0,{type:n.PROBE_UNKNOWN_ACTION()}))throw Error('Reducer "'+t+"\" returned undefined when probed with a random type. Don't try to handle "+n.INIT+' or other actions in "redux/*" namespace. They are considered private. Instead, you must return the current state for any unknown actions, unless it is undefined, in which case you must return the initial state, regardless of the action type. The initial state may not be undefined, but can be null.')})}(r)}catch(e){a=e}return function(e,t){if(void 0===e&&(e={}),a)throw a;for(var n=!1,i={},u=0;c.length>u;u++){var f=c[u],s=e[f],d=(0,r[f])(s,t);if(void 0===d){var l=o(f,t);throw Error(l)}i[f]=d,n=n||d!==s}return n?i:e}},e.bindActionCreators=function(e,t){if("function"==typeof e)return i(e,t);if("object"!=typeof e||null===e)throw Error("bindActionCreators expected an object or a function, instead received "+(null===e?"null":typeof e)+'. Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?');for(var r=Object.keys(e),n={},o=0;r.length>o;o++){var u=r[o],a=e[u];"function"==typeof a&&(n[u]=i(a,t))}return n},e.applyMiddleware=function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return function(e){return function(){var r=e.apply(void 0,arguments),n=function(){throw Error("Dispatching while constructing your middleware is not allowed. Other middleware would not be applied to this dispatch.")},o={getState:r.getState,dispatch:function(){return n.apply(void 0,arguments)}},i=t.map(function(e){return e(o)});return function(e){for(var t=1;arguments.length>t;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){u(e,t,r[t])})}return e}({},r,{dispatch:n=a.apply(void 0,i)(r.dispatch)})}}},e.compose=a,e.__DO_NOT_USE__ActionTypes=n,Object.defineProperty(e,"__esModule",{value:!0})});


(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory(global):typeof define==="function"&&define.amd?define(factory):factory(global)})(typeof self!=="undefined"?self:typeof window!=="undefined"?window:typeof global!=="undefined"?global:this,function(global){"use strict";var _Base64=global.Base64;var version="2.5.0";var buffer;if(typeof module!=="undefined"&&module.exports){try{buffer=eval("require('buffer').Buffer")}catch(err){buffer=undefined}}var b64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64tab=function(bin){var t={};for(var i=0,l=bin.length;i<l;i++)t[bin.charAt(i)]=i;return t}(b64chars);var fromCharCode=String.fromCharCode;var cb_utob=function(c){if(c.length<2){var cc=c.charCodeAt(0);return cc<128?c:cc<2048?fromCharCode(192|cc>>>6)+fromCharCode(128|cc&63):fromCharCode(224|cc>>>12&15)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}else{var cc=65536+(c.charCodeAt(0)-55296)*1024+(c.charCodeAt(1)-56320);return fromCharCode(240|cc>>>18&7)+fromCharCode(128|cc>>>12&63)+fromCharCode(128|cc>>>6&63)+fromCharCode(128|cc&63)}};var re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;var utob=function(u){return u.replace(re_utob,cb_utob)};var cb_encode=function(ccc){var padlen=[0,2,1][ccc.length%3],ord=ccc.charCodeAt(0)<<16|(ccc.length>1?ccc.charCodeAt(1):0)<<8|(ccc.length>2?ccc.charCodeAt(2):0),chars=[b64chars.charAt(ord>>>18),b64chars.charAt(ord>>>12&63),padlen>=2?"=":b64chars.charAt(ord>>>6&63),padlen>=1?"=":b64chars.charAt(ord&63)];return chars.join("")};var btoa=global.btoa?function(b){return global.btoa(b)}:function(b){return b.replace(/[\s\S]{1,3}/g,cb_encode)};var _encode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(u){return(u.constructor===buffer.constructor?u:buffer.from(u)).toString("base64")}:function(u){return(u.constructor===buffer.constructor?u:new buffer(u)).toString("base64")}:function(u){return btoa(utob(u))};var encode=function(u,urisafe){return!urisafe?_encode(String(u)):_encode(String(u)).replace(/[+\/]/g,function(m0){return m0=="+"?"-":"_"}).replace(/=/g,"")};var encodeURI=function(u){return encode(u,true)};var re_btou=new RegExp(["[Ă€-ĂŸ][Â€-Â¿]","[Ă -Ă¯][Â€-Â¿]{2}","[Ă°-Ă·][Â€-Â¿]{3}"].join("|"),"g");var cb_btou=function(cccc){switch(cccc.length){case 4:var cp=(7&cccc.charCodeAt(0))<<18|(63&cccc.charCodeAt(1))<<12|(63&cccc.charCodeAt(2))<<6|63&cccc.charCodeAt(3),offset=cp-65536;return fromCharCode((offset>>>10)+55296)+fromCharCode((offset&1023)+56320);case 3:return fromCharCode((15&cccc.charCodeAt(0))<<12|(63&cccc.charCodeAt(1))<<6|63&cccc.charCodeAt(2));default:return fromCharCode((31&cccc.charCodeAt(0))<<6|63&cccc.charCodeAt(1))}};var btou=function(b){return b.replace(re_btou,cb_btou)};var cb_decode=function(cccc){var len=cccc.length,padlen=len%4,n=(len>0?b64tab[cccc.charAt(0)]<<18:0)|(len>1?b64tab[cccc.charAt(1)]<<12:0)|(len>2?b64tab[cccc.charAt(2)]<<6:0)|(len>3?b64tab[cccc.charAt(3)]:0),chars=[fromCharCode(n>>>16),fromCharCode(n>>>8&255),fromCharCode(n&255)];chars.length-=[0,0,2,1][padlen];return chars.join("")};var _atob=global.atob?function(a){return global.atob(a)}:function(a){return a.replace(/\S{1,4}/g,cb_decode)};var atob=function(a){return _atob(String(a).replace(/[^A-Za-z0-9\+\/]/g,""))};var _decode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(a){return(a.constructor===buffer.constructor?a:buffer.from(a,"base64")).toString()}:function(a){return(a.constructor===buffer.constructor?a:new buffer(a,"base64")).toString()}:function(a){return btou(_atob(a))};var decode=function(a){return _decode(String(a).replace(/[-_]/g,function(m0){return m0=="-"?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))};var noConflict=function(){var Base64=global.Base64;global.Base64=_Base64;return Base64};global.Base64={VERSION:version,atob:atob,btoa:btoa,fromBase64:decode,toBase64:encode,utob:utob,encode:encode,encodeURI:encodeURI,btou:btou,decode:decode,noConflict:noConflict,__buffer__:buffer};if(typeof Object.defineProperty==="function"){var noEnum=function(v){return{value:v,enumerable:false,writable:true,configurable:true}};global.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",noEnum(function(){return decode(this)}));Object.defineProperty(String.prototype,"toBase64",noEnum(function(urisafe){return encode(this,urisafe)}));Object.defineProperty(String.prototype,"toBase64URI",noEnum(function(){return encode(this,true)}))}}if(global["Meteor"]){Base64=global.Base64}if(typeof module!=="undefined"&&module.exports){module.exports.Base64=global.Base64}else if(typeof define==="function"&&define.amd){define([],function(){return global.Base64})}return{Base64:global.Base64}});

Base64.safeDecode = function(str){
	var r="";
	try{
		r = Base64.decode(str);
	}catch (e){
		return "[Base64 Invalid]";
	}
	
	return r;
};


function md5cycle(x, k) {
var a = x[0], b = x[1], c = x[2], d = x[3];

a = ff(a, b, c, d, k[0], 7, -680876936);
d = ff(d, a, b, c, k[1], 12, -389564586);
c = ff(c, d, a, b, k[2], 17,  606105819);
b = ff(b, c, d, a, k[3], 22, -1044525330);
a = ff(a, b, c, d, k[4], 7, -176418897);
d = ff(d, a, b, c, k[5], 12,  1200080426);
c = ff(c, d, a, b, k[6], 17, -1473231341);
b = ff(b, c, d, a, k[7], 22, -45705983);
a = ff(a, b, c, d, k[8], 7,  1770035416);
d = ff(d, a, b, c, k[9], 12, -1958414417);
c = ff(c, d, a, b, k[10], 17, -42063);
b = ff(b, c, d, a, k[11], 22, -1990404162);
a = ff(a, b, c, d, k[12], 7,  1804603682);
d = ff(d, a, b, c, k[13], 12, -40341101);
c = ff(c, d, a, b, k[14], 17, -1502002290);
b = ff(b, c, d, a, k[15], 22,  1236535329);

a = gg(a, b, c, d, k[1], 5, -165796510);
d = gg(d, a, b, c, k[6], 9, -1069501632);
c = gg(c, d, a, b, k[11], 14,  643717713);
b = gg(b, c, d, a, k[0], 20, -373897302);
a = gg(a, b, c, d, k[5], 5, -701558691);
d = gg(d, a, b, c, k[10], 9,  38016083);
c = gg(c, d, a, b, k[15], 14, -660478335);
b = gg(b, c, d, a, k[4], 20, -405537848);
a = gg(a, b, c, d, k[9], 5,  568446438);
d = gg(d, a, b, c, k[14], 9, -1019803690);
c = gg(c, d, a, b, k[3], 14, -187363961);
b = gg(b, c, d, a, k[8], 20,  1163531501);
a = gg(a, b, c, d, k[13], 5, -1444681467);
d = gg(d, a, b, c, k[2], 9, -51403784);
c = gg(c, d, a, b, k[7], 14,  1735328473);
b = gg(b, c, d, a, k[12], 20, -1926607734);

a = hh(a, b, c, d, k[5], 4, -378558);
d = hh(d, a, b, c, k[8], 11, -2022574463);
c = hh(c, d, a, b, k[11], 16,  1839030562);
b = hh(b, c, d, a, k[14], 23, -35309556);
a = hh(a, b, c, d, k[1], 4, -1530992060);
d = hh(d, a, b, c, k[4], 11,  1272893353);
c = hh(c, d, a, b, k[7], 16, -155497632);
b = hh(b, c, d, a, k[10], 23, -1094730640);
a = hh(a, b, c, d, k[13], 4,  681279174);
d = hh(d, a, b, c, k[0], 11, -358537222);
c = hh(c, d, a, b, k[3], 16, -722521979);
b = hh(b, c, d, a, k[6], 23,  76029189);
a = hh(a, b, c, d, k[9], 4, -640364487);
d = hh(d, a, b, c, k[12], 11, -421815835);
c = hh(c, d, a, b, k[15], 16,  530742520);
b = hh(b, c, d, a, k[2], 23, -995338651);

a = ii(a, b, c, d, k[0], 6, -198630844);
d = ii(d, a, b, c, k[7], 10,  1126891415);
c = ii(c, d, a, b, k[14], 15, -1416354905);
b = ii(b, c, d, a, k[5], 21, -57434055);
a = ii(a, b, c, d, k[12], 6,  1700485571);
d = ii(d, a, b, c, k[3], 10, -1894986606);
c = ii(c, d, a, b, k[10], 15, -1051523);
b = ii(b, c, d, a, k[1], 21, -2054922799);
a = ii(a, b, c, d, k[8], 6,  1873313359);
d = ii(d, a, b, c, k[15], 10, -30611744);
c = ii(c, d, a, b, k[6], 15, -1560198380);
b = ii(b, c, d, a, k[13], 21,  1309151649);
a = ii(a, b, c, d, k[4], 6, -145523070);
d = ii(d, a, b, c, k[11], 10, -1120210379);
c = ii(c, d, a, b, k[2], 15,  718787259);
b = ii(b, c, d, a, k[9], 21, -343485551);

x[0] = add32(a, x[0]);
x[1] = add32(b, x[1]);
x[2] = add32(c, x[2]);
x[3] = add32(d, x[3]);

}

function cmn(q, a, b, x, s, t) {
a = add32(add32(a, q), add32(x, t));
return add32((a << s) | (a >>> (32 - s)), b);
}

function ff(a, b, c, d, x, s, t) {
return cmn((b & c) | ((~b) & d), a, b, x, s, t);
}

function gg(a, b, c, d, x, s, t) {
return cmn((b & d) | (c & (~d)), a, b, x, s, t);
}

function hh(a, b, c, d, x, s, t) {
return cmn(b ^ c ^ d, a, b, x, s, t);
}

function ii(a, b, c, d, x, s, t) {
return cmn(c ^ (b | (~d)), a, b, x, s, t);
}

function md51(s) {
txt = '';
var n = s.length,
state = [1732584193, -271733879, -1732584194, 271733878], i;
for (i=64; i<=s.length; i+=64) {
md5cycle(state, md5blk(s.substring(i-64, i)));
}
s = s.substring(i-64);
var tail = [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,0,0];
for (i=0; i<s.length; i++)
tail[i>>2] |= s.charCodeAt(i) << ((i%4) << 3);
tail[i>>2] |= 0x80 << ((i%4) << 3);
if (i > 55) {
md5cycle(state, tail);
for (i=0; i<16; i++) tail[i] = 0;
}
tail[14] = n*8;
md5cycle(state, tail);
return state;
}


function md5blk(s) { /* I figured global was faster.   */
var md5blks = [], i; /* Andy King said do it this way. */
for (i=0; i<64; i+=4) {
md5blks[i>>2] = s.charCodeAt(i)
+ (s.charCodeAt(i+1) << 8)
+ (s.charCodeAt(i+2) << 16)
+ (s.charCodeAt(i+3) << 24);
}
return md5blks;
}

var hex_chr = '0123456789abcdef'.split('');

function rhex(n)
{
var s='', j=0;
for(; j<4; j++)
s += hex_chr[(n >> (j * 8 + 4)) & 0x0F]
+ hex_chr[(n >> (j * 8)) & 0x0F];
return s;
}

function hex(x) {
for (var i=0; i<x.length; i++)
x[i] = rhex(x[i]);
return x.join('');
}

function md5(s) {
return hex(md51(s));
}



function add32(a, b) {
return (a + b) & 0xFFFFFFFF;
}

if (md5('hello') != '5d41402abc4b2a76b9719d911017c592') {
function add32(x, y) {
var lsw = (x & 0xFFFF) + (y & 0xFFFF),
msw = (x >> 16) + (y >> 16) + (lsw >> 16);
return (msw << 16) | (lsw & 0xFFFF);
}
}

 

AP.data=new function _APData(){
	this.isArray=function(data){
		return $.isArray(data);
	};
	this.isAssocArray=function(data){
		return typeof(data)=='object' && isNaN(data);	
	};
	this.isObject=function(data){
		return typeof(data)=='object' && isNaN(data);
	};
	this.isFunction=function(data){
		return $.isFunction(data);
	};
	this.isInt=function(data){
		return !isNaN(data)&&parseInt(data)==data;	
	};
	this.isNumber=function(data){
		return !isNaN(data)&& !isNaN(parseFloat(data));	
	};
	this.isString=function(data){
		return typeof(data)=='string' && isNaN(data);
	};
	this.isEmpty=function(data){
		if (!data || data.length <=0){
			return true;
		}
		return false;
	};
	
	this.int=function(val){
		return parseInt(val);
	};
	
	/**
	 * Get a random integer from min to max-1
	 * @param min
	 * @param max
	 * @returns int
	 */
	this.randomInteger=function(min, max){
		return Math.floor(Math.random() * (max - min)) + min;
	};
	
	this.randomNumber=this.randomInteger;
	
	
	this.numberFormat=function(ival, decimal){
		var parts=ival.toString().split(".");
		return parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + (parts[1] ? "." + parts[1].substr(0,decimal||2) : "");
	};
	
	
	this.currencyFormat=function(v){
		var c=Client.pageData.currency;
		if (!c || !c.length){
			c="VND";
		}
		if (c=="VND"){
			return AP.data.numberFormat(v)+" <sup>Ä‘</sup>";	
		}else if (c=="GBP PENNY"){
			return "<b>&pound;"+this.globalMoneyFormat(v/100,2,".",",")+"</b>";	
		}else if (c=="USD CENT"){
			return "<b>$"+this.globalMoneyFormat(v/100,2,".",",")+"</b>";	
		}else{
			alert("Unsupported currency");
		}
		
	};
	
	
	
	this.globalMoneyFormat=function(n, c, d, t){
		var  c = isNaN(c = Math.abs(c)) ? 2 : c, 
		d = d == undefined ? "." : d, 
		t = t == undefined ? "," : t, 
		s = n < 0 ? "-" : "", 
		i = parseInt(n = Math.abs(+n || 0).toFixed(c)) + "", 
		j = (j = i.length) > 3 ? j % 3 : 0;
	   return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
	 };
	
	
	
	this.realFormat=function(val){
		return Math.round(parseFloat(val)*10000)/10000;
	};
	
	
	this.zeroIndex=function(ival){
		ival=parseInt(ival);
		if (ival === 0){
			return "0";
		}
		
		if (ival<10){
			ival="0"+ival;
		}
		return ival;
	}
	
	this.zeroPrefix=function(ival){
		return this.zeroIndex(ival);
	}
	
	/**
	 * @desc Compare two string/number x,y.
	 * @return True/false
	 */
	this.equal=function(x, y){
		if (AP.data.isInt(x)){
			x=x.toString();
		}
		if (AP.data.isInt(y)){
			y=y.toString();
		}
		
		if (AP.data.isAssocArray(x) && AP.data.isAssocArray(y)){
			return (JSON.stringify(x)==JSON.stringify(y));
		}
		
		if (AP.data.isArray(x) && AP.data.isArray(y)){
			if (x.length!=y.length){
				return false;
			}
			for (var i=0; i<x.length; i++){
				if (!AP.data.equal(x[i], y[i])){
					return false;
				}
			}
			return true;
		}
		
		return (x==y);
	};
	
	
	
	this.assoc=function(){
		return new APAssoc();
	};
};



function APAssoc(){
	this.data={};
	this.add=function(key, value){
		this.data[key]=value;
		return this;
	};
	
	this.assoc=function(){
		return this.data;
	};
};

function safeEquals(x, y){
	return AP.data.equal(x, y);
};


var se = safeEquals;


	/**
	 * @desc Array manipulation and verification
	 */

	AP.array={
			
		fromObject: function(obj){
			var r=[];
			for (var key in obj){
				r[key]=obj[key];
			}
			
			return r;
		},
	
		/**
		 * @desc Check if element is an element of arr.
		 */
		within: function(element, arr, compare_fn){
			if (!arr || arr.length==0) return false;
			for (var i=0; i<arr.length; i++){
				if (compare_fn && typeof compare_fn!="undefined"){
					if (compare_fn(arr[i], element)){
						return true;
					}
				}else{
					if (arr[i]==element) return true;
					if (AP.data.isInt(arr[i]) && AP.data.isInt(element)){
						if (parseInt(arr[i]) === parseInt(element)){
							return true;
						}
					}
				}
				
			}
			return false;
		},
		
		/**
		 * @desc Check if the array contains the element
		 */
		contain: function(arr, element, compare_fn){
			return AP.array.within(element, arr, compare_fn);
		},
		
		/**
		 * @desc exclude an array from the original array
		 * @param {arr} arr describe The original array 
		 * @param {excluded} array describe the list of array to be excluded 
		 * @return array
		 */
		exclude: function(arr, excluded, compare_fn){
			var r = [];
			for (var i = 0; i < arr.length; i++){
				if (AP.array.contain(excluded, arr[i], compare_fn)){
				} else{
					r.push(arr[i]);
				}
			}

			return r;
		},
		
		count: function(arr, fn){
			var t=0;
			for (var i=0; i<arr.length; i++){
				var r=arr[i];
				if (fn){
					r=fn(arr[i]);	
				}else{
					if (AP.data.isInt(r)){
						r=parseInt(r);
					}else if (AP.data.isNumber(r)){
						r=parseFloat(r);
					}
				}
				
				if (r===true){
					r=1;
				}else if (r===false){
					r=0;
				}
				
				t+=r;
			}
			
			return t;
		},
		
		sum: function(arr, fn){
			var t=0;
			if (!arr || !arr.length){
				return 0;
			}
			for (var i=0; i<arr.length; i++){
				if (!fn){
					if (AP.data.isInt(arr[i])){
						t+=parseInt(arr[i]);	
					}else{
						t+=parseFloat(arr[i]);
					}
				}else{
					t+=fn(arr[i]);	
				}
			}
			
			return t;
		},
		
		avg: function(arr, fn){			
			var count = arr.length;
			if (!count){
				return 0;
			}
			
			var total = this.count(arr, fn);
			return total/count;
		},
		
		/**
		 * @desc Making a subarray, from start. If length is too big, or null, it
		 * return the subarray of maximum length.
		 */
		sub: function(arr, start, length){
			if (!length || start+length>arr.length){
				length=arr.length-start;
			}
			var b=[];
			for (var i=start; i<start+length; i++){
				b.push(arr[i]);
			}
			return b;
		},
		
		unique: function(arr, compare_fn){
			if (!compare_fn){
				compare_fn=function(e, f){
					return (parseInt(e)==parseInt(f));
				};
			}
			var r=[];
			for (var i=0; i<arr.length; i++){
				if (AP.array.contain(r, arr[i], function(e1, e2){
					return compare_fn(e1, e2);
				})){}else{
					r.push(arr[i]);
				}
			}
			
			return r;
		},
		
		uniqueObjects: function(arr, compare_fn){
			return AP.array.unique(arr, function(e1, e2){
				return e1.id==e2.id || (AP.data.isInt(e1.id) && AP.data.isInt(e2.id) && parseInt(e1.id) == parseInt(e2.id));
			});
		},
		
		extract: function(arr, key){
			return ARR.select(arr, function(e){
				if (key in e){
					return e[key];
				}
				
				return null;
			});
		},
		
		find: function(arr, id){
			if (!arr || !arr.length){
				return false;
			}
			
			if (typeof id =="function"){
				for (var i=0; i<arr.length; i++){
					if (id(arr[i])){
						return arr[i];
					}
				}
				
				return null;
			}
			
			
			for (var i=0; i<arr.length; i++){
				if (arr[i]==id){
					return arr[i];
				}
			}
			return null;
		},
		
		single: function(arr, filter){
			return this.find(arr, filter); 
		},
		
		exist: function(arr, elem){
			if ($.isFunction(elem)){
				var obj=this.find(arr, elem);
				if (obj){
					return true;
				}
				return false;
			}else{
				var obj= AP.array.find(arr, function(e){
					return e==elem;
				});
				
				if (!obj){
					return false;
				}
				
				return true;
			}
		},
		
		indexOf: function(arr, elem, cmp){
			for (var i=0; i<arr.length; i++){
				if (cmp(arr[i], elem)){
					return i;
				}
			}
			
			return -1;
		},
		
		
		findObj: function(arr, id){
			if (!arr){
				return null;
			}
			
			for (var i=0; i<arr.length; i++){
				if (parseInt(arr[i].id)==parseInt(id)){
					return arr[i];
				}
				
				if (arr[i].id===id){
					return arr[i];
				}
			}
			return null;
		},
		
		
		findObjWithStringID: function(arr, id){
			if (!arr){
				return null;
			}
			
			for (var i=0; i<arr.length; i++){
				if (String(arr[i].id) === String(id)){
					return arr[i];
				}
			}
			return null;
		},
		
		updateObjects:function(arr, obj){
			for (var i=0; i<arr.length; i++){
				if (!AP.data.isInt(arr[i]) && !AP.data.isInt(obj.id)){
					if (arr[i].id == obj.id){
						arr[i]=obj;
						return arr;
					}
				}else{
					if (parseInt(arr[i].id)==parseInt(obj.id)){
						arr[i]=obj;
						return arr;
					}	
				}
				
			}
			
			arr.push(obj);
			
			return arr;
		},
		
		updateByID: function(arr, obj){
			return this.updateObjects(arr, obj);
		},
		
		updateFieldsByID: function(arr, obj, transform){
			for (var i=0; i<arr.length; i++){
				if (idEquals(arr[i].id, obj.id)){
					transform(arr[i], obj);
				}
			}
		},
		
		insertByID: function(arr, obj){
			return this.updateObjects(arr, obj);
		},
		
		replaceObject: function(arr, obj){
			for (var i=0; i<arr.length; i++){
				if (parseInt(arr[i].id)==parseInt(obj.id)){
					arr[i]=obj;
					return true;
				}
			}
			
			arr.push(obj);
			
			return false;
		},
		
		
		
		/**
		 * @desc Check if prefix is a subarray of arr, starting from beginning
		 */
		prefix: function(arr, prefix){
			if (prefix.length>arr.length){
				return false;
			}
			for (var i=0; i<prefix.length; i++){
				if (!AP.data.equal(prefix[i], arr[i])){
					return false;
				}
			}
			return true;
		},
		
		
		/**
		 * @desc Check if prefix is a subarray of arr, starting from beginning
		 */
		equal: function(arr1, arr2){
			if (arr1.length!=arr2.length){
				return false;
			}
			for (var i=0; i<arr1.length; i++){
				if (!AP.data.equal(arr1[i], arr2[i])){
					return false;
				}
			}
			return true;
		},
		
		ids: function(arr){
			return this.select(arr, function(e){
				return e.id;
			});
		},
		
		cut: function(arr, max){
			if (arr.length<max){
				return arr;
			}
			
			return arr.slice(0, max);
		},
		
		each: function(arr, cb){
			for (var i=0; i<arr.length; i++){
				cb(arr[i], i, arr.length);
			}
		},
		
		
		usort: function(arr, sorter){
			for (var i=0; i<arr.length-1; i++){
				for (var j=i+1; j<arr.length; j++){
					if (sorter(arr[i], arr[j])>0){
						var x=arr[i];
						arr[i]=arr[j];
						arr[j]=x;
					}
				}
			}
			return arr;
		},
		
		sortObj: function(arr, field, multiplier){
			if (!multiplier){
				multiplier=1;
			}
			
			return this.usort(arr, function(e1, e2){
				return multiplier*(parseInt(e1[field]) - parseInt(e2[field]));
			}) 
		},
		
		/**
		 * @desc Sort array by the value of sorter(fn) 
		 */
		sort: function(arr, sorter){
			for (var i=0; i<arr.length; i++){
				arr[i].__fs=sorter(arr[i], i);
			}
			
			return this.usort(arr, function(e, f){
				return e.__fs - f.__fs;
			})
		},
		
		sortOnRefIDs: function(arr, ref_ids, append_missing_refs){
			var r=[];
			
			var refs={};
			for (var i=0; i<arr.length; i++){
				var a = arr[i];
				refs["e"+a.id]=a;
			}
			
			var missing=[];
			
			for (var i=0; i<ref_ids.length; i++){
				if ("e"+ref_ids[i] in refs){
					r.push(refs["e"+ref_ids[i]]);
				}else{
					missing.push(refs["e"+ref_ids[i]]);
				}
			}
			
			if (append_missing_refs){
				for (var i=0; i< missing.length; i++){
					var m = missing[i];
					r.push(m);
				}
			}
			
			return r;
		},
		
		reorder: function(arr, order){
			if (!order){
				order=1;
			}
			arr.sort(function(e1, e2){
				return (parseInt(e2.order)-parseInt(e1.order))*order;
			})
		},
		
		realOrder: function(arr, order){
			if (!order){
				order=1;
			}
			arr.sort(function(e1, e2){
				return (parseInt(e2.real_order)-parseInt(e1.real_order))*order;
			});
			
			return arr;
		},
		
		
		move: function(arr, elem, dir){
			for (var i=0; i<arr.length; i++){
				if (arr[i].id==elem.id){
					if (dir=="up" && i>0){
						var temp=arr[i-1];
						arr[i-1]=arr[i];
						arr[i]=temp;
					}else if (dir=="down" && i< arr.length-1){
						var temp=arr[i+1];
						arr[i+1]=arr[i];
						arr[i]=temp;
					}
						
					return;
				}
			}
		},
		
		
		
		/**
		 * @desc Unserialized a serialized string to an array.
		 */
		unserialize: function(str){
			var r={};
			var parts=str.split('&');
			for (var i=0; i<parts.length; i++){
				var x=parts[i].split("=");
				if (x.length==2){
					r[x[0]]=x[1];
				}
			}
			return r;
		},
		
		
		/**
		 * @desc Insert a value to the end of the array if the value DOES NOT existed
		 */
		insert: function(arr, value, cmp_fn){
			if (ARR.contain(arr, value, cmp_fn)){
				return arr;
			}
			
			var na = arr.slice();
			na.push(value);
			
			return na;
		},
		
		
		/**
		 * @desc Remove an element from an array
		 */
		remove: function(arr, elem, cmp_fn){
			var na=[];
			for (var i=0; i<arr.length; i++){
				if (AP.isFunction(elem)){
					if (elem(arr[i])){
					}else{
						na.push(arr[i]);
					}
				}else{
					if (cmp_fn){
						if (!cmp_fn(arr[i],elem)){
							na.push(arr[i]);
						}
					}else{
						if (!AP.data.equal(arr[i],elem)){
							na.push(arr[i]);
						}	
					}	
				}
			}
			return na;
		},
		
		removeByID: function(arr, id){
			return this.filter(arr, function(e){
				if (!AP.data.isInt(e.id) && !AP.data.isInt(id)){
					if (e.id === id){
						return false;
					}
					
					return true;
				}
				
				
				if (parseInt(e.id)==parseInt(id)){
					return false;
				}
				
				return true;
			});
		},
		
		filter: function(arr, filter){
			var na=[];
			for (var i=0; i<arr.length; i++){
				if (filter(arr[i], i, arr.length)){
					na.push(arr[i]);
				}
			}
			return na;
		},
		
		select: function(arr, fn){
			var na=[];
			if (!arr || !arr.length){
				return na;
			}
			
			for (var i=0; i<arr.length; i++){
				var e=fn(arr[i], i, arr.length);
				if (e!==null){
					na.push(e);
				}
			}
			return na;
		},
		
		selectObj: function(obj, fn){
			var na=[];
			var i=0;
			for (var key in obj){
				var e=fn(obj[key], i, key);
				if (e!==null){
					i++;
					na.push(e);
				}
			}
			return na;
		},
		
		loop: function(arr, fn){
			for (var i=0; i<arr.length; i++){
				fn(arr[i], i, arr.length);
			}
		},
		
		max: function(arr, fn){
			var _m=null;
			var _c=-1;
			
			for (var i=0; i<arr.length; i++){
				var val = fn(arr[i]);
				if (_m == null || val>_m){
					_m=val;
					_c=i;
				}
			}
			
			if (_c==-1){
				return null;
			}
			
			return arr[_c];
		},
		
		selectMax: function(arr, num_elems, fn){
			var temp=[];
			for (var i=0; i<arr.length; i++){
				temp.push({value: fn(arr[i]), index: i});
			}
			
			temp.sort(function(e, f){
				if (f.value==null){
					return -1;
				}
				
				if (e.value==null){
					return 1;
				}
				
				return f.value-e.value;
			});
			
			temp=this.cut(temp, num_elems);
			
			var r=[];
			for (var i=0; i<temp.length; i++){
				if (temp[i].value!==null){
					r.push(arr[temp[i].index]);	
				}
			}
			
			return r;
		},
		
		
		update: function(arr, fn){
			for (var i=0; i<arr.length; i++){
				fn(arr[i])
			}
		},
		
		join: function(array, joiner, fn){
			return AP.render(array, function(e){
				if (fn){
					return fn(e)+joiner;	
				}
				return fn(e)+joiner;
			});
		},
		
		clone: function(arr){
			return arr.slice(0);
		},
		
		deepClone: function(arr){
			return ARR.select(arr, function(e){
				return shallowClone(e);
			})
		},
		
		filterQuery: function(array, keys){
			var a=array.slice(0);

			for (var i=0; i<keys.length; i++){
				var k=keys[i];
				if (Query.get(k)){
					var val=Query.get(k);
					a=AP.array.filter(a, function(e){
						return e[k]==val || e[k+"_id"]==val;
					});
				}
			}
			
			return a;
		},
		
		
		group: function(array, group_maker, group_sorter){
			var gs={};
			for (var i=0; i<array.length; i++){
				var g;
				if (AP.data.isString(group_maker)){
					g={id: array[i][group_maker]};
				}else{
					g=group_maker(array[i]);	
				}
				
				
				if (!g){
					continue;
				}
				
				if (!gs["g"+g.id]){
					gs["g"+g.id]=shallowClone(g);
					gs["g"+g.id].items=[array[i]];
				}else{
					gs["g"+g.id].items.push(array[i]);
				}
			}
			
			var r=[];
			for (var key in gs){
				r.push(gs[key]);
			}
			
			if (group_sorter){
				for (var i=0; i<r.length; i++){
					r[i].__sorter=group_sorter(r[i]);
				}
				
				return AP.array.sortObj(r, "__sorter", -1);
			}
			
			
			return r;
		},
		
		buckets: function(arr, buckets, key){
			if (!arr){
				return [];
			}
			
			for (var i=0; i<buckets.length; i++){
				buckets[i].items = ARR.filter(arr, function(e){
					if (AP.data.isFunction(key)){
						return key(e, buckets[i]);
					}else{
						return parseInt(e[key])==parseInt(buckets[i].id);	
					}
				});
			}
		},
		
		ranking: function(arr, fn){
			for (var i=0; i<arr.length; i++){
				var count = 0;
				
				for (var j=0; j<arr.length; j++){
					if (j!=i && fn(arr[j]) > fn(arr[i])){
						count++;
					}
				}
				
				arr[i]._ranking = count+1;
			}
		},
		
		merge: function(){
			var r=[];
			for (var i=0; i<arguments.length; i++){
				if (AP.data.isObject(arguments[i]) && !AP.data.isArray(arguments[i])){
					r.push(arguments[i]);
				}else{
					for (var j=0; j<arguments[i].length; j++){
						r.push(arguments[i][j]);	
					}
				}
			}
			
			return r;
		},
		
		
		randomElems: function(arr, limit){
			var r=[];
			
			for (var i=0; i<limit; i++){
				var val= AP.data.randomNumber(0, arr.length-1);
				if (this.contain(r, val)){
					continue;
				}else{
					r.push(val);
				}
			}
			
			return ARR.select(r, function(e){
				return arr[e];
			});
		},
		
		pcmp: function(){
			for (var i=0; i<arguments.length; i++){
				var x = parseInt(parseFloat(arguments[i][0])*1000);
				var y = parseInt(parseFloat(arguments[i][1])*1000);
				
				if (x>y){
					return 1;
				}
				
				if (x<y){
					return -1;
				}
			}
			
			return 0;
		}
	};

	
	var ARR = AP.array;
 


AP.sys={
	initAjax: function(){
		jQuery.ajaxSetup({async:false});
	},
			
	back: function(){
		return history.back();
	},	
	ie: function(){
		return $.browser.msie;
	},
	
	isTablet: function(){
		var ua = navigator.userAgent.toLowerCase();
		var isAndroid = ua.indexOf("android") > -1;
		var isiPad = ua.indexOf("ipad")>-1;
		return (isAndroid || isiPad);
	},
	
	isMobile:function(){
		if ('ontouchstart' in document.documentElement && navigator.userAgent.match(/Mobi/)){
			return true;
		}

		return (/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()));
	},
	
	isTouch: function(){
		return !!('ontouchstart' in window) ? 1 : 0;
	},
	
	
	/**
	 * @desc Detect flash. AP.B.flash() return true if flash is enabled, false otherwise.
	 */
	flash: function(){
		var hasFlash = false;
		try {
		  var fo = new ActiveXObject('ShockwaveFlash.ShockwaveFlash');
		  if (fo) hasFlash = true;
		}catch(e){
		  if (navigator.mimeTypes ["application/x-shockwave-flash"] != undefined) hasFlash = true;
		}
	}, 
	
	
	/**
	 * @desc Check if the browser support file API.
	 */
	file: function(){
		if (document.querySelector && window.File && window.FileReader && window.FileList){
			return true;
		}
		return false;
	},
	
	captchaReload: function(obj){
		$(obj).attr("src", Client.url+"/captcha?ts="+new Date().getTime());
	},
	
	
	/**
	 * @desc Set and get cookie,
	 * @copyright 2006 Klaus Hartl (stilbuero.de)
	 */
	cookie:function(name, value, options){
		if (typeof value == 'undefined'){
			var cookieValue = null;
			if (document.cookie && document.cookie != '') {
				var cookies = document.cookie.split(';');
				for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					if (cookie.substring(0, name.length + 1) == (name + '=')) {
						cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
						break;
					}
				}
			}
			return cookieValue;
		}else{
			options = options || {};
			if (value === null) {
				value = '';
				options.expires = -1000;
			}
			var expires = '';
			if (options.expires && (typeof options.expires == 'number' || options.expires.toUTCString)) {
				var date;
				if (typeof options.expires == 'number') {
					date = new Date();
					date.setTime(date.getTime() + (options.expires * 1000));
				} else {
					date = options.expires;
				}
				expires = '; expires=' + date.toUTCString();
			}
			
			
			var path = options.path ? '; path=' + (options.path) : '';
			var domain = options.domain ? '; domain=' + (options.domain) : '';
			var secure = options.secure ? '; secure' : '';

			document.cookie = [name, '=', AP.encodeURI(value), expires, path, domain, secure].join('');
		}
	},
	
	
	/**
	 * @desc Create an event listener
	 */
	on :function(event, fx, $this){
		AP.sysEvent.bind(event, fx, $this);
		return this;
	},
	
	off: function(event){
		AP.sysEvent.off(event);
		return this;
	},
	
	
	/**
	 * @desc Create an event listener
	 */
	once :function(event, fx, $this){
		AP.sysEvent.bindOnce(event, fx, $this);
		return this;
	},
	
	
	/**
	 * @desc Trigger an event 
	 */
	fire: function(event, data){
		AP.sysEvent.trigger(event, data);
		return this;
	},
	
	
	/**
	 * @desc Trigger an event 
	 */
	trigger: function(event, data){
		return AP.sys.fire(event, data);
	},
	
	
	/**
	 * @desc Trigger an event (and dequeue)
	 */
	release: function(event){
		AP.sysEvent.release(event);
		return this;
	}
};	











AP.sysEvent=new function __APSysEvent(){
	this.events={};
	this.__fired={};
	
	this.clear=function(){
		this.events={}
	};
	
	
	this.trigger=function(ev, data){
		if (this.events[ev] && this.events[ev].length){
			for (var i=0; i<this.events[ev].length; i++){
				var fn=this.events[ev][i];
				if (!fn){
					break;
				}

				
				if (fn._once){
					// Remove fn from event queues
					this.events[ev].splice(i, 1);
				}
				
				if (fn._caller){
					fn.apply(fn._caller, data);
				}else{
					if (AP.data.isArray(data)){
						fn.apply(undefined, data);
					}else{
						fn(data);	
					}
				}
			}
		}
		
		return this;
	};
	
	
	this.bind=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev].push(fx);
		
		return this;
	};
	
	
	this.off=function(ev){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		this.events[ev]=[];
		return this;
	};
	
	this.bindOnce=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		fx._once=1;
		
		this.events[ev].push(fx);
		
		return this;
	};
	
	this.release=function(ev){
		if (this.events[ev] && this.events[ev].length){
			while (true){
				var fn=this.events[ev].shift();
				if (!fn){
					break;
				}
				
				if (fn._caller){
					fn.apply(fn._caller);
				}else{
					fn();
				}
			}
		}
		
		this.__fired[ev]=1;
		return this;
	};
	
};
 


AP.word={
	/**
	 * @desc Check if the data is an empty string or not.
	 * @param data
	 * @return True/False
	 */
	empty: function(data){ 
		if (typeof data=='undefined'){
			return true;
		}
		if (data===false) return true;
		if (data==="") return true;
		if (data===null) return true;
		if (data.length==0) return true;
		return false;
	},
	
	/**
	 * @desc Check if data is a valid data of type string.
	 * @param data
	 * @return True/False
	 */
	good: function(data){
		return typeof(data)=='string' && isNaN(data);
	},
	
	/**
	 * @desc Check if s1 is a part of s2 somewhere.
	 * @param s1 child string
	 * @param s2 parent string
	 */
	within:function(element,origin){
		if (!element) return false;
		if (origin.indexOf(element)>=0){
			return true;
		}
		return false;
	},
	
	extractLast: function(word){
		if (!word){
			return false;
		}
		var ws=word.split("-");
		return ws[ws.length-1];
	},
	
	/**
	 * @desc Check if $pre is the prefix of $origin
	 */
	prefix:function(origin, pre){
		if (!pre || !origin){
			return false;
		}
		if (origin.substring(0, pre.length)==pre){
			return true;
		}
		return false;
	},
	
	
	/**
	 * @desc Check if $suf is the suffix of $origin
	 */
	suffix:function(origin, suf){
		if (!suf || !origin || origin.length<suf.length){
			return false;
		}
		
		if (origin.substr(origin.length-suf.length, suf.length)==suf){
			return true;
		}
		return false;
	},
	
	
	
	/**
	 * @desc Check if a string is a valid url. The test is very simple, it check
	 * if the prefix is actually http
	 */
	isURL:function(url){
		if (this.prefix(url, 'http:') || this.prefix(url, 'https:')){
			return true;
		}
		return false;
	},
	
	
	shorten: function(word, max_length, tail){
		word=safe(word);
		
		if (!tail){
			tail='...';
		}
		if (word.length <max_length){
			return word;
		}
		return word.substr(0, max_length-1)+tail;
	},
	
	
	ucw: function(data){
		return data.replace( /(^|\s)([a-z])/g , function(m,p1,p2){ return p1+p2.toUpperCase(); } );
	},
	
	ucf: function(data){
		return data.charAt(0).toUpperCase() + data.slice(1);
	}, 
	upper: function(data){
		return data.toUpperCase();
	},
	
	
	/**
	 * @desc Replace all function
	 */
	replace: function(str, search, replace){
		return str.replace(new RegExp(search, 'g'),replace);
	},
	
	replaceAll:function(search, replace, str){
		return str.split(search).join(replace);
	},

	join: function(arr, joiner, fn){
		var html="";
		for (var i=0; i<arr.length; i++){
			if (i<arr.length-1){
				html+=fn?fn(arr[i]):arr[i];
				html+=joiner;
			}else{
				html+=fn?fn(arr[i]):arr[i];
			}
		}
		return html;
	},
	
	
	/**
	 * @desc Check if filename has extension belongging to fileX.
	 */
	fileX: function(filename, allowExt){
		var parts=filename.split(".");
		if (!parts || parts.length<1){
			return false;
		}
		var ext=parts[parts.length-1];
		ext=ext.toLowerCase();
		allowExt=allowExt.toLowerCase();
		
		if (allowExt.indexOf(ext)==-1){
			return false;
		}
		return true;
	},
	
	/**
	 * @desc Split a string into array.
	 * @param splitter The string splitter
	 * @param str The original string
	 * @param boolean no_spaces Allow spacings (and ends) in result or not? Default false
	 */
	split: function(splitter, str, no_spaces){
		if (!no_spaces){
			no_spaces=false;
		}
		var parts=str.split(splitter);
		var results=[];
		for (var i=0; i<parts.length; i++){
			 var s=parts[i];
			 if (no_spaces){
				 s=$.trim(parts[i]);
			 }
			 if (s && s.length>=1){
				 results.push(s);
			 }
		}
		return results;
	},
	
	safeSplit: function(splitter, str){
		return this.split(splitter, str, true);
	},
	
	ssplit: function(str){
		return str.split( /[\s,]/ );
	},
	
	plural:function(word, count){
		if (!AP.data.isInt(count)){
			index=parseInt(count);
		}
		
		if (count<2){
			return word;
		}
		
		if (Client.applang && Client.applang == "vi"){
			return word;
		}
		
		switch (word){
			case "person": 
				return "people";
			case "activity":
				return "activities";
			case "reply":
				return "replies";
			default:
				return word+"s";
		};
	},
	
	safeChar: function(word){
		var regex=/^[a-z0-9]+$/i;
		return word.match(regex);
	},
	
	match: function(word, pattern){
		return word.match(pattern);
	},
	
	quickMatch: function(w, q){
		return w.toLowerCase().indexOf(q.toLowerCase())!=-1;
	},
	
	fulltextMatch: function(w, q){
		var haystack=purify(w.toLowerCase()).replace(/\s/g,'');
		var neddle=purify(q.toLowerCase()).replace(/\s/g,'');
		
		return haystack.indexOf(neddle)!=-1;
	},
	
	capitalize: function(str){
		return str.charAt(0).toUpperCase() + str.slice(1);
	},
	
	leadingChars: function(str){
		var r="";
		var parts = this.split(" ", str);
		for (var i=0; i<parts.length; i++){
			r+=purify(parts[i][0]).toUpperCase();
		}
		
		return r;
	},
	
	random: function(len){
		return AP.random.word(len);
	},
	
	compare: function(w1, w2){
		if (!w1){
			return 0;
		}
		
		return w1.localeCompare(w2)	
	}
};

 


AP.html={	
	data:{},
	
	/**
	 * @desc Check if the document has some specific selector.
	 */
	contain:function(selector){
		if ($(selector).length>=1){
			return true;
		}
		return false;
	},
	
	/**
	 * @desc Alias of contain
	 */
	exist:function(selector){
		return this.contain(selector);
	},
	
	
	/**
	 * @desc Save html by caching it to data
	 * @param key
	 * @param selector
	 */
	save: function(key, selector){
		this.data[key]=$(selector).html();
	},
	
	update: function(key, selector){
		$(selector).html(this.data[key]);
	},
	
	
	/**
	 * @desc Setting the document title
	 */
	title:function(str){
		document.title = str;
	},	
	input:function(element, name){
		var $input;
		if (!name){
			$input=$(element);
		}else{
			$input=$("*[name="+name+"]", element);
		}
		
		if ($input[0] && $input[0].title==$input.val()){
			return  "";
		}else{
			return $input.val();
		}
	},
	select: function(selector, value){
		$(selector+" option[value='"+value+"']").attr('selected', 'selected');	
	},
	
	/**
	 * @desc Return the value of an input (encoded before return).
	 */
	inputAjax:function(elem,name){
		return AP.encodeURI(this.D.input(elem,name));
	},
	
	/**
	 * @desc Making input hints for all input/textarea within a given
	 * selector.
	 */
	inputHint: function(selector){
		if (!selector){
			selector='';
		}
		$(' input, textarea', selector).each(function(){
			if ($(this)[0].title || $(this).data('hint') && !$(this).hasClass('autocomplete') && !$(this).hasClass('__apcomplete_marked')){
				ap_inputHint(this);
			}
		});
	},
	
	
	hidden: function(name, value){
		return "<input type='hidden' name='"+name+"' value='"+value+"'/>";
	},
	
	focus: function(selector){
		$(selector).focus();
		this.scrollTo(selector);
	},
	
	scrollTo: function(selector, base, data){
		if (!data){
			data={};
		}
		var xoffset=0;
		data=$.extend({},{offset:0, time: 400},data);
		if (!base){
			base=ap_getScrollElement(document.body, 'html','body');
		}else{
			// xoffset=$(base).scrollTop();
		}
		
		
		var targetOffset=$(selector).position().top+xoffset+data.offset;
		if (targetOffset<=0){
			targetOffset=0;
		}
		
		// $.log(targetOffset);
		
		$(base).animate({scrollTop: targetOffset}, data.time, function() {});
	},
	
	/**
	 * @desc Binding a keypress event on a specific element.
	 */
	bind:function(selector,_key, action){
		$(selector).keydown(function (e){			
			key=0;
			if (e && e.which) key=e.which;
			else if (e && e.keyCode) key=e.keyCode;
			if (key == _key){
				action();
			}
		});
	},
	
	
	/**
	 * @desc Binding a keypress on window element.
	 */
	dbind: function(_key, action){
		$(document).keydown(function (e){
			if (AP.html.inActiveState()){
				return;
			}
			key=0;
			if (e && e.which) key=e.which;
			else if (e && e.keyCode) key=e.keyCode;
			if (key == _key){
				action();
			}
		});
	},
	
	/**
	 * @desc Bind a resize action on document.body 
	 * @param action Callback function
	 * @param persistent Boolean/ Persistent or not (over page transistion). Default is false.
	 */
	resize: function(action, persistent){		
		action();
		
		if (persistent){
			$(window).resize(function(){
				action();
			});
		}else{
			$(window).bind('resize.__temp',function(){
				action();
			});
		}
	},
	
	resizeEnd: function(action, timer, persistent){
		var doit;
		action();
		
		if (persistent){
			window.onresize = function(){
				clearTimeout(doit);
				doit = setTimeout(action, timer);
			};
		}else{
			window.on("resize.__temp", function(){
				clearTimeout(doit);
				doit = setTimeout(action, timer);
			});
		}
	},
	
	
	/**
	 * @desc Reset stuffs when they are added to the DOM tree.
	 */
	reset: function(container){
		$("button").click(function(event){
			event.preventDefault();
		});
	},
	
	
	/**
	 * @desc Flagging some input/select being in focus.
	 */
	activeState: false,
	
	/**
	 * @desc Check if the element is in active state or not.
	 */
	inActiveState:function(){
		return this.activeState;
	},
	
	/**
	 * @desc Initializing the active state of the document.
	 */
	initState:function(selector){
		if (!selector){
			selector="";
		}
		$(selector+" textarea,"+selector+" input").bind("focus", function(){
			AP.html.activeState=true;
		});
		$(selector+" textarea,"+selector+" input").bind("blur", function(){
			AP.html.activeState=false;
		});
	},
	
	/**
	 * @desc Embedding data (passed from sever) to HTML element.
	 */
	initData: function(selector){
		if (!selector){
			selector="";
		}
		$(" > .__data", selector).each(function(){
			var text=$(this).html();
			try{
				var obj=eval("("+text+")");
				if (obj!==null){
					for (var key in obj){
						$(this).parent().data(key, obj[key]);
					}
				}
			}catch(e){
				
			}
		});
	},
	
	
	initContextMenu: function(){
		$("<div id='__ctm'><div id='__ctmi' class='__contextmenu'></div></div>").appendTo('#master');
		$("#__ctm").clickOut(function(){
			$('#__ctm').hide();
		});
	},
	
	initTransition: function(wrapper){
		if (wrapper){
			AP.setContinuousRequest(wrapper);
		}else{
			AP.setContinuousRequest();
		}
	},
	
	initDialog: function(){
		$(document.body).append("<div id='apdialogs'></div>");
		AP.html.resize(function(){
			$("#apdialogs").css("width",$(window).width()+$.sbWidth());
		}, true);
	},
	
	
	initTooltip: function(selector){
		setTimeout(function(){
			$(".tt_auto", selector).parent().tooltip('.tt');
		},1000);
	},
	
	/**
	 * @desc Create some simple transformation on the dom tree specifically
	 * for AP JS Framework.
	 */
	init: function(selector){
		if (!selector){
			selector='';
		}
		this.initState(selector);
		setTimeout(function(){
			AP.html.inputHint(selector);
		},500);
		this.initData(selector);
		this.initTooltip(selector);
		
		this.reset(selector);
		if (!selector){
			this.initContextMenu();
			this.initDialog();
		}
	},
	
	/**
	 * @desc Init selector after insert
	 */
	initInsert: function(selector){
		this.inputHint(selector);
		this.initData(selector);
		this.initTransition(selector);
		this.initTooltip(selector);
	},
	
	options: function(selector, options){
		$(selector).html(AP.render(options, function(e){
			return "<option value='"+e.value+"'>"+e.label+"</option>";
		}));
		
		if ($(selector).data("value")){
			$(selector).val($(selector).data("value"));
		}
	},
};




var ap_getScrollElement=function(){
	for (var i = 0, argLength = arguments.length; i <argLength; i++) {
		var el = arguments[i], $scrollElement = $(el);
		
		if ($scrollElement.scrollTop()> 0) {
				return el;
		}else {
				$scrollElement.scrollTop(1);
				var isScrollable = $scrollElement.scrollTop()> 0;
				$scrollElement.scrollTop(0);
				if (isScrollable) {
					return el;
				}
		}
	}
	return [];
};


var ap_inputHint=function(element, target){
	if (!target){
		target=element;
	}
	
	if ($(element).hasClass('__hinited') || $(element).hasClass('__apcomplete_marked')){
		return;
	}
	
	$(element).addClass('__hinited');
	var $parent=$(element).parent();
	
	var pos=$parent.css("position");
	if (pos !="relative" && pos!="absolute"){
		$parent.addClass("relative");
	}
	

	var fz=$(element).css("font-size");
	var pos=$(element).position();
	var pl=$parent.css("padding-left");
	var pt=$parent.css("padding-top");
	
	var txt=$(element)[0].title;
	if ($(element).data("hint")){
		txt=$(element).data("hint");
	}
	
	$(element).before("<span class='__hinited_data __blur' style='top:"+pt+"; left:"+pl+"; font-size:"+fz+"'>"+txt+"</span>");
	
	
	setTimeout(function(){
		if ($(element).data('auto')){
			$(element).prev('.__hinited_data').css("left","auto").css("right", pl).show();
		}else{
			$(element).prev().css({top: pt, left: pl});	
		}
	},200);
	
	$(element).on('focus keyup change', function(){
		if ($(this).hasClass('apcomplete')){
			return;
		}
		if (!AP.word.empty($(this).val())){
			$(this).addClass('__activated');
			
			if ($(this).data('auto')){
				$(this).prev('.__hinited_data').css("left","auto").css("right", pl);	
			}else{
				$(this).prev('.__hinited_data').hide();
			}
			
		}else{
			$(this).removeClass('__activated');
			$(this).prev('.__hinited_data').css("left",pl).show();
		}
	}).blur(function(){
		if ($(this).hasClass('apcomplete')){
			return;
		}
		
		if (AP.word.empty($(this).val())){
			$(this).prev('.__hinited_data').show();
		}
	});

	$(element).blur();
	
};

 

AP.error={
	code:{
	CONFLICT_DATA:997, INVALID_DATA: 998, INCOMPLETE_DATA:999, 
	INVALID_USER:1001, INVALID_AUTHENTICATION:1002, LOGIN_REQUIRED:10033, DB_ERROR:1005, SV_ERROR:1006,
	INVALID_PASSWORD: 1021,
	INVALID_USERNAME:1022,
	INVALID_CHARACTER:1023,
	INVALID_CAPTCHA: 1024,
	INVALID_EMAIL:1020,
	UNKNOWN_ERROR: 990},
	
	messages:{},
	
	translate:function(msg){
		if (AP.error.messages[msg]){
			return AP.error.messages[msg];
		}
		return msg;
	}	
};


AP.random=new function __APRandom(){
	this.word=function(length){
		var text = "";
		var possible = "abcdefghjklmnpqrstuvwxyz";

		for (var i = 0; i < length; i++){
			text += possible.charAt(Math.floor(Math.random() * possible.length));
		}

		return text;
	};
	
	this.avatar=function(){
		return "<img src='http://localhost/lamp/avatars/"+this.int(1,10)+".svg'/>";
	};
	
	this.int=function(f, t_inclusive){
		return f+Math.floor(Math.random() * (t_inclusive+1-f));
	};
	
	this.number=function(from_number, to_number_inclusive){
		if (!from_number){
			from_number=0;
		}
		
		if (!to_number_inclusive){
			to_number_inclusive=100;
		}
		return this.int(from_number, to_number_inclusive);
	};
};




(function($){
	
	/**
	 * @desc jQuery 1.8 fix
	 */
	if (!$.curCSS){
		$.curCSS=$.css;
	};
	
	
	
	/**
	 * @desc log to the console.
	 */
	$.log=function(msg){
		if (Client.env==1 || Client.env=='1'){
			return;
		}
		if (!window.console || !window.console.log){
			
		}else{
			try{
				window.console.log(msg);
			}catch(e){
			}
		}
	};
	
	
	$.logMe=function(element){
		var str = $("<div />").append($(element).clone()).html();
		$.log(str);
	};
	
	$.cookie=function(name, value, options){
		return AP.sys.cookie(name, value, options);
	};

	
	/**
	 * @desc Adding an element to the document root when the element
	 * is not exists.
	 */
	$.adding=function(selector, options, callback){
		if (!$(selector).length){			
			options=$.extend({global: false, element: "div", 'class':'', action:'', title:''},options);
			
			var s=selector.substring(1);
			$(document.body).append("<"+options.element+" id='"+s+"'></"+options.element+">");
			if (options.css){
				$(selector).css(options.css);
			}
			
			if (options.title){
				$(selector).attr('title', options.title);
			}
			if (options.action){
				$(selector).attr('action', options.action);
			}
			if (options['class']){
				$(selector).addClass(options['class']);
			}
			if (!options.global){
				$(selector).addClass('__temp');
			}
			
			if (callback){
				callback();
			}
		}
	};
	
	
	/**
	 * @desc Creating a simple scalar object from a complicated object. 
	 */
	$.scalar=function(obj){
		var s={"id": obj.id, "dbk": obj.dbk};
		
		return s;
	};
	
	
	
	$.fn.max=function(field, multiple){
		var tm=null;
		var m=null;
		
		$(this).each(function(){
			var v=$(this).data(field);
			
			
			if (v){
				v=parseInt(v);
				var tv=v;
				
				if (multiple){
					if (AP.data.isInt(multiple)){
						tv=tv*multiple;
					}else{
						tv=multiple(tv);
					}
				}
				
				if (tm===null || tm<tv){
					tm=tv;
					m=v;
				}
			}
		});
		
		return m;
	};
	
	
	/**
	 * @desc Return the maximum width
	 */
	$.maxWidth=function(){
		return Math.max($(window).width(), $(document.body).width());
	};
	
	
	/**
	 * @desc Return the maximum width
	 */
	$.maxHeight=function(){
		var m= Math.max($(window).height(), $(document.body).height()+30);
		if ($("#overlay").length>=1){
			return Math.max(m, $("#overlay").height());
		}
		return $m;
	};
	
	
	$.scrollEnd=function(callback){
		
	};
	
	
	var _scrollbarWidth=0;
	$.sbWidth=function(){
		if (!_scrollbarWidth){
			_scrollbarWidth=getScrollbarWidth();
		}
		return _scrollbarWidth;
	};
	
	
	
	$.fn.reverse = [].reverse;
	
	
	/**
	 * Example:
	 * 
	 * $(window).onFinish('scroll', 250, function(event){
	 * 	
	 * });
	 */
	
	var __off_timer;
	$.fn.onFinish=function(event, delay, callback){
		return $(this).on(event, $.debounce(delay, function(event){
			callback(event);
		}));
	};
	
	
	$.fn.autofocus=function(){
		if (!mobile()){
			if ($(this).is(":visible")){
				$(this).focus();	
			}
		}
		
		return this;
	};
	
	
	$.fn.scrollOver=function(fn){
		$(this).on('scroll.__temp', function(){
			var stop=$(this).scrollTop();
			var h=$(this)[0].scrollHeight;
			var diff=h-stop-$(this).height();
			if (Math.abs(diff)<=1){
				fn();
			}
		});
	};
	
	
	$.fn.scrollDown=function(offset){
		AP.html.scrollTo(this, null, {'offset': offset});
	};
	
	$.fn.scrollToBottom=function(){
		var h=$(this)[0].scrollHeight;
		$(this).scrollTop(h);
	};
	
	$.fn.scrollToTop=function(){
		$(this).scrollTop(0);
	};
	
	
	$.fn.contentWidth=function(){
		var w=0;
		$(this).children().each(function(){
			w+=$(this).outerWidth();
		});
		
		return w;
	};
	

	$.fn.apAppend=function(html){
		$(this).append(html);
		AP.html.initInsert(this);
		return this;
	};
	
	
	$.fn.apPrepend=function(html){
		$(this).prepend(html);
		AP.html.initInsert(this);
		return this;
	};
	
	
	$.fn.linkify=function(){
		 $(this).each(function(){
			 var el=$(this);
			 if (el.jquery) {
				 el = el[0];
			 }
			 el.normalize();
			 __linkifyNode(el);
			 return el;
		});
	};
	
	
	
	$.fn.move=function(dir, anim){
		dir=dir.toLowerCase();
		if (dir=="up" || dir=="prev"){
			var $prev=$(this).prev();
			if ($prev && $prev.length){
				if (anim){
					$(this).slideUp(200, function(){
						$(this).insertBefore($prev).slideDown(200);
					});
				}else{
					$(this).insertBefore($prev);
				}
			}
		}
		
		if (dir=="down" || dir=="next"){
			var $next=$(this).next();
			if ($next && $next.length){
				if (anim){
					$(this).slideUp(200, function(){
						$(this).insertAfter($next).slideDown(200);
					});
				}else{
					$(this).insertAfter($next);	
				}
			}
		}
	};
	
	
	/**
	 * @desc Clone css from another selector
	 */
	$.fn.cloneCSS=function(selector, properties){
		var ps=AP.word.split(",", properties);
		for (var i=0; i<ps.length; i++){
			ps[i]=$.trim(ps[i]);
			$(this).css(ps[i], $(selector).css(ps[i]));
		}
	};
	
	
	$.fn.autoExpand=function(options){
		autosize($(this));
		return this;
		
		$(this).each(function(){
			var $this=$(this);
			
			var lh=$this.data("lh");
			if (!lh) lh=22;
			var ih=$(this).height();
			
			$this.css("line-height",lh+"px").css("overflow-y", "hidden");
			$this.data("minh", $(this)[0].scrollHeight).on("keydown", function(e){
				var elem=this;
				setTimeout(function(){
					var minh=$(elem).data("minh");
					// @todo Carefully check this
					if (ih>40){
						$(elem)[0].style.height="auto";
					}
					
					$(elem)[0].style.height=Math.max($(elem)[0].scrollHeight,lh)+"px";
				},0);
			}).keydown();
		});
		
		return this;
	};
	
	
	$.fn.angular=function(options){
		var df={color:"#aaa", bg:"#fff", arc: false, stroke: 10};
		if ($(this).data("color")){
			df.color=$(this).data("color");
		}
		
		if ($(this).data("angle")){
			df.angle=$(this).data("angle");
		}
		
		if ($(this).data("bg")){
			df.bg=$(this).data("bg");
		}
		
		if ($(this).data("text")){
			df.text=$(this).data("text");
		}
		
		if ($(this).data("stroke")){
			df.stroke=$(this).data("stroke");
		}
		
		if ($(this).data("cut") || $(this).data("arc")){
			df.arc=true;
		}
		
		if ($(this).data("percent")){
			df.angle=360*parseFloat($(this).data("percent"))/100;
		}
		
		options=$.extend({}, df, options);
		
		var sektor = new Sektor(this, {
			angle: options.angle,
			sectorColor: options.color,
			circleColor: options.bg,
			arc: options.arc,
			stroke: options.stroke,
			fillCircle: !options.arc
		});
		
		if (options.text){
			$(this).append("<div class='inner-text'>"+options.text+"</div>");
		}
	};
	
	$.fn.screencopy=function(url, success, __data){
		if (!__data){
			__data={};
		}
		
		$(this).bind("paste", function(ev){
			var $this = $(this);
			var original =  ev.originalEvent;
			if (!original.clipboardData || !original.clipboardData.items || !original.clipboardData.items.length){
				return;
			}
			var raw=original.clipboardData.items[0];
			if (typeof raw !='object'){
				return;
			}
			
			var file =  raw.getAsFile();
			if (!file || !file.size || !file.type){
				return;
			}
			
			var reader = new FileReader();
			
			reader.onload = function (evt) {
				var result = evt.target.result; 
				var arr = result.split(",");
				var data = arr[1]; // raw base64
				var contentType = arr[0].split(";")[0].split(":")[1];
				
				// this needs to post to a server route that can accept raw base64 content and save to a file
				var temp=__data;
				temp.contentType=contentType;
				temp.data=data;
				temp.__ss=1;
				
				$this.parent().ajaxShow();
				AP.post(url, temp, function(code){
					$this.parent().ajaxHide();
					
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					success(code, $this);
				});
			};
			
			reader.readAsDataURL(file);
		});
		
		return this;
	};
	
	
	$.fn.textPasted=function(callback){
		$(this).bind("paste", function(ev){
			var $this = $(this);
			var original =  ev.originalEvent;
			if (!original.clipboardData || !original.clipboardData.items || !original.clipboardData.items.length){
				return;
			}
			var raw=original.clipboardData.items[0];
			if (raw && raw.type=="text/plain"){
				raw.getAsString(function(str){
					callback(str);
				});
			}
		});
		return this;
	};
	
	
	
	$.fn.selectChoices=function(){
		AP.formRender().choiceList(this);
		return this;
	};
	
	
	
	$.fn.selectRadios=function(){
		AP.formRender().radioList(this);
		return this;
	};
	
	

	$.fn.selectDate=function($format){
		var val=$(this).val();
		if (!val || val=="0"){
			$(this).val("");
		}
		
		if ($(this).data("ts")){
			var ts=$(this).data("ts");
			if (ts && ts!="0"){
				$(this).val(AP.time.time(AP.i18n.dateFormat(),ts));	
			}
		}
		
		AP.UI.dateSelect(this, $format);
		return this;
	};
	
	
	$.fn.selectTime=function(options){
		AP.UI.timeSelect(this, options);
		return this;
	};
	
	
	$.fn.selectYear=function(){
		$(this).autocomplete({source: range(2010, 1900)});
	};
	
	
	$.fn.getDialog=function(){
		var $elem=$(this).closest('.__apdialog');
		return AP.dialog('#'+$elem.attr('id'));
	};
	
	
	/**
	 * @desc Modified version of autocomplete
	 * @param sources Array
	 * @param multi_value True/False. Default is false.
	 */
	$.fn.apcomplete=function(source, multi_value, callback, filter_fn){
		if (source==":clean"){
			$(this).val("");
			$(this).siblings('input').val("");
			
			$(this).siblings('.apc-selected').remove();
			return new APComplete(this, source, multi_value, callback);
		}
		
		if (!$(this).hasClass("__apcomplete_marked")){
			$(this).addClass("__apcomplete_marked");
		}else{
			return new APComplete(this, source, multi_value, callback);
		}
		
		if (AP.isString(source)){
			if (multi_value){
				$(this).addClass("__apcomplete_multi");
				var ref=AP.UI.autocompleteComplex($(this), source, callback,filter_fn);
				return new APComplete(this, source, multi_value, callback, ref);
			}
			var ref=AP.UI.autocomplete($(this), source, callback, filter_fn);
			return new APComplete(this, source, multi_value, callback, ref);
		}else{			
			if (multi_value){
				var ref=AP.UI.acx($(this), source, callback,filter_fn);
				return new APComplete(this, source, multi_value, callback, ref);
			}
			var ref= AP.UI.ac($(this), source, callback, filter_fn);
			return new APComplete(this, source, multi_value, callback, ref);
		}
	};
	
	
	/**
	 * @desc String complete, great to use for things like tag autocompletion
	 */
	$.fn.scomplete=function(strings, callback){	
		$(this).on("keydown", function( event ) {
			if (event.keyCode === $.ui.keyCode.TAB && $(this).data("ui-autocomplete").menu.active){
				event.preventDefault();
			}
		})
		.autocomplete({
			minLength: 0,
			classes: {
				 "ui-autocomplete": "base-string-complete"
			},
			source: function(request, response){
				var last=request.term.split(/,\s*/).pop();
				response($.ui.autocomplete.filter(strings,last));
			},
			focus: function(){
				return false;
			},
			select: function(event, ui){
				var terms = this.value.split(/,\s*/);
				terms.pop();
				terms.push(ui.item.value);
				terms.push("");
				this.value = terms.join(", ");
				if (callback){
					callback(ui.item.value);
				}
				return false;
			}
		});
	};
	
	
	$.fn.livesearch=function(url, options){
		if (!options.filter){
			options.filter=null;
		}

		if (options.render){
			
		}
		
		var acc=$(this).apcomplete(url, false, options.select, options.filter);
		
		if (options.render){
			acc.aco.data("ui-autocomplete")._renderItem = function(ul,item) {
				return $("<li>").data("item.autocomplete", item).append(options.render(item)).appendTo(ul);
			};
		}
	};
	
	
	$.fn.stringcomplete=function(url){
		return AP.UI.stringcomplete(this, url);
	};
	
	
	
	$.fn.hasEmbedData=function(key){
		var obj=$(this).data(key);
		if (obj && obj!="" && typeof obj !="undefined"){
			return true;
		}
		
		return false;
	};
	
	var delay_timer=null;
	$.fn.quickFilter=function(selectors, filter_fn){
		$(this).on("input change", function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var val=$this.val();
				if (!val || !val.length){
					return $(selectors).show();
				}
				
				val=val.toLowerCase();
				
				$(selectors).each(function(){
					if (filter_fn($(this), val)){
						$(this).show();
					}else{
						$(this).hide();
					}
				});
			}, 300);
		});
		
		var q =$(this).data("query");
		if (q && q.length && Query.get(q)){
			$(this).val(Query.get(q)).trigger("change");
		}
	};
	
	
	$.fn.search=function(cb){
		$(this).attr('autocomplete','off');
		
		$(this).on("input change", function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var val=$this.val();
				val=val.toLowerCase();
				cb(val);
				
			}, 500);
		});
	};
	
	
	$.fn.rposition=function(target){
		if (!$(this).closest(target).length){
			return {top:0, left: 0};
		}
		
		var $e=$(this);
		var top=0;
		var left=0;
		
		while (true){
			if (!$e.length){
				break;
			}
			
			if ($e.is(target)){
				break;
			}
			
			var p=$e.position();
			
			if ($e.css("position")=="static" || !$e.css("position")){
			}else{
				top+=p.top;
				left+=p.left;	
			}
			
			$e=$e.parent();
		}
		
		return {top:top, left: left};
	};
	
	$.fn.quickSort=function(selectors, cmp_fn){
		var $elems=$(this).find(selectors).remove();
		$elems.sort(function(a,b){
			return cmp_fn($(a), $(b));
		}).prependTo(this);
	};
	
	
	
	$.fn.suggest=function(data, options){
		options=$.extend({placeholder: $(this).attr('placeholder'), restricted: true}, {}, options);
		
		for (var i=0; i<data.length; i++){
			var e=data[i];
			if (!AP.data.isObject(e) && AP.data.isString(e)){
				data[i]={id: purify(e), label: e};
			}
		}
		
		var $p=$(this).parent();
		var name=$(this).attr("name");
		
		if ($p.hasClass("__suggest_canvas")){
			
		}else{
			$p.addClass("__suggest_canvas").data("options", options);
			
			$(this).addClass("__input-suggestion-target").hide().before("<input class='__input-suggestion-fake' autocomplete='off' placeholder='"+options.placeholder+"' name='"+name+"-ipfk'/>");
			
			var html=AP.render(data, function(e){
				var val;
				if ("id" in e){
					val=e.id;	
				}else{
					val=e.value;
				}
				
				var icon="";
				if (options.multi){
					icon= "<span class='__icon'></span>";
				}
				
				return "<div class='__input-suggestion-row' onclick='__fn_input_suggest(this);' data-id='"+val+"'>"+icon+e.label+"</div>";
			});

			if (options.maxHeight){
				// html="<div class='__iwh' style='max-height:"+options.maxHeight+"px; overflow-y:scroll; overflow-x:hidden'>"+html+"</div>";
			}
			
			if (options.all){
				html="<div class='__input-suggestion-row -is-all' onclick='__fn_input_suggest(this);' data-all='1' data-id='"+options.all.value+"'>"+options.all.label+"</div>"+html;
			}
			
			if (data && data.length >=10){
				html="<div style='max-height:300px; overflow-y:scroll'><div class='__iw'>"+html+"</div></div>";
			}else{
				html="<div class='__iw'>"+html+"</div>";	
			}

			
			if (!options.restricted){
				html+="<div class='__input-extra'><input type='text' class='__input-extra-fx' placeholder='Or type another option here and press Enter'/> <div class='__input-enter'>Enter</div></div>";
			}
			
			
			
			var w=$(this).width()-2;
			html="<div class='__input-suggestion-canvas unselectable'>"+html+"</div>";
			
			$(this).after(html);
			
			$("<div class='__input-suggestion-ph'><div class='__labels'></div><span class='arrow -ap icon-triangle-down'></span></div>").insertAfter(this).click(function(){
				$(this).parent().addClass("__iss");
				$(this).closest(".row").addClass("__ft");
			}).parent().find(".__input-suggestion-fake").focus(function(){
				$(this).parent().addClass("__iss");
				$(this).closest(".row").addClass("__ft");
			});
			
			
			
			$p.clickOut(function(){
				$(this).removeClass("__iss");
				$(this).closest(".row").removeClass("__ft");
			});
	
		
			var v=$(this).val();
			
			if (options.multi){
				var vs=options.df;
				var ls="";
				if (vs && vs.length){
					for (var i=0; i<vs.length; i++){
						$p.parent().find(".__input-suggestion-row").each(function(){
							if ($(this).data("id")==vs[i]){
								$(this).addClass("active");
								ls+=$(this).text()+", ";
							}
						});
					}
					
					$(this).val(vs.join(","));
					$p.find(".__input-suggestion-fake").val(ls);
				}
			}else{
				if (v){
					$p.find(".__input-suggestion-row").each(function(){
						if ($(this).text()==v){
							$(this).addClass("active");
						}else{
							$(this).removeClass("active");
						}
					});
					$(this).val(v);
				}	
			}
			
			$(this).parent().find(".__input-extra-fx").enter(function(){
				var v=$(this).val();
				if (v){
					$p.find(".__input-successtion-row").each(function(){
						if ($(this).text()==v){
							$(this).addClass("active");
						}else{
							$(this).removeClass("active");
						}
					});
					
					$p.find(".__input-suggestion-target").val(v);
					$p.removeClass("__iss");
					$p.closest(".row").removeClass("__ft");
					$p.children().removeClass("active");
				}
			});
			
	
			$(this).parent().find(".__input-enter").click(function(){
				var v=$(this).parent().find("input").val();
				if (v){
					$p.find(".__input-successtion-row").each(function(){
						if ($(this).text()==v){
							$(this).addClass("active");
						}else{
							$(this).removeClass("active");
						}
					});
					
					$p.find(".__input-suggestion-target").val(v);
					$p.removeClass("__iss");
					$p.closest(".row").removeClass("__ft");
					$p.children().removeClass("active");
				}
			});
		}
		
		if (options.value && options.value.length){
			for (var i=0; i<options.value.length; i++){
				$p.find(".__input-suggestion-row").each(function(){
					if ($(this).data("id")==options.value[i]){
						$(this).click();
					}
				});
			}
		}
	};
	
	
	
	$.fn.textSuggest=function(data, options){
		options=$.extend({placeholder: $(this).attr('placeholder'), restricted: true}, {}, options);
		
		for (var i=0; i<data.length; i++){
			var e=data[i];
			if (!AP.data.isObject(e) && AP.data.isString(e)){
				data[i]={id: purify(e), label: e};
			}
		}
		
		var $p=$(this).parent();
		var name=$(this).attr("name");
		
		if ($p.hasClass("__suggest_canvas")){
			
		}else{
			$p.addClass("__suggest_canvas").data("options", options);
			
			var html=AP.render(data, function(e){
				var val;
				if ("id" in e){
					val=e.id;	
				}else{
					val=e.value;
				}
				
				var icon="";
				if (options.multi){
					icon= "<span class='__icon'></span>";
				}
				
				return "<div class='__input-suggestion-row' onclick='__fn_input_text_suggest(this);' data-id='"+val+"'>"+icon+e.label+"</div>";
			});

			if (options.maxHeight){
				// html="<div class='__iwh' style='max-height:"+options.maxHeight+"px; overflow-y:scroll; overflow-x:hidden'>"+html+"</div>";
			}
			
			if (data && data.length >=10){
				html="<div style='max-height:300px; overflow-y:scroll'><div class='__iw'>"+html+"</div></div>";
			}else{
				html="<div class='__iw'>"+html+"</div>";	
			}
		
			var w=$(this).width()-2;
			$(this).after("<div class='__input-suggestion-canvas unselectable'>"+html+"</div>");
			
			
			$(this).on("input focus", function(){
				$(this).next().show();
				var v=$(this).val();
				if (v && v.length){
					
				}
			}).on("blur", function(){
				var $that=$(this);
				setTimeout(function(){
					$that.next().hide();
				}, 300);
			}).enter(function(){
				var $that=$(this);
				setTimeout(function(){
					$that.next().hide();
				}, 100);
			});
		}
	};
	
	
	
	$.fn.tagName=function(){
		return $(this)[0].nodeName.toLowerCase();
	};
	
	
	$.fn.tag=function(url, render_fn, filter_fn, reorder_fn, select_fn){
		if (url=="reset"){
			// RESET TAGGING
			var id=$(this).attr('id');
			var new_id=id+"__temptextarea";
			if ($("#"+new_id).length){
				$("#"+new_id).remove();
			}
			
			var tid="__tag_"+id;
			
			if ($("#"+tid).length){
				$("#"+tid).remove();
			}
			
			return;
		}
		
		
		if ($(this).hasClass("__autoc")){
			return;
		}
		
		$(this).addClass("__autoc");
		
		$(this).data("reorder_fn", reorder_fn);
		
		var id=$(this).attr('id');
		if (!id){
			id=AP.uuid();
			$(this).attr('id', id);
		}

		var pos=$(this).position();
		var tagdir=$(this).data('tagdir');
		var tid="__tag_"+id;
		
		if ($("#"+tid).length){
			$("#"+tid).remove();
		}
		
		
		var item="";
		var tagname=$(this)[0].nodeName.toLowerCase();
		$(this).data("tagname", tagname);
		
		plugin_textarea_init("#"+id);
		
		if (tagdir=="bottom"){
			$("<div class='tags absolute __temp' id='"+tid+"'> "+item+"</div>").appendTo("#context-tag-bottom");
		}else{
			$("<div class='tags absolute __temp' id='"+tid+"'> "+item+"</div>").appendTo("#context-tag");
		}
		
		var $tagbox=$("#"+tid);
		if (tagdir){
			$tagbox.data("tagdir", tagdir);
		}
		
		$tagbox.data("onselect", select_fn);
		
		if ($(this).data("theme")){
			$tagbox.addClass("theme-"+$(this).data("theme"));
		}
		
		$(this).on('keydown', function(e){
			var key=e.keycode? e.keycode:e.which;
			if (key==AP.key.up || key==AP.key.down || key==AP.key.enter){
				if ($tagbox.is(':visible')){
					e.preventDefault();
					e.stopPropagation();
					return false;
				}
			}
		}).data("tagbox", $tagbox);
		
		var compact=false;
		if ($(this).data("compacttagging")){
			compact=true;
		}
		

		$(this).on('keyup', function(e){
			var $tagbox=$(this).data("tagbox");
			
			var key=e.keycode? e.keycode:e.which;
			
			if ($tagbox.is(':visible')){
				if (key==AP.key.down){
					plugin_select_updown_down($tagbox);
					return;
				}else if (key==AP.key.up){
					plugin_select_updown_up($tagbox);
					return;
				}else if (key==AP.key.enter){
					plugin_select_updown_enter($tagbox);
					return;
				}
			}else{
				if (key==AP.key.down || key==AP.key.up){
					return;
				}
			}
			
			var v=$(this).val();
			if (!compact && (!v.length || v.charAt(v.length-1)==' ')){
				fn_cancel_tag(id);
				return;
			}
			
			
			var single=$(this).data("single-tag");
			
			var term=$(this).val();
			if (!single){
				term=$.trim($(this).data("current_word"));	
			}
			
			if (term && term.length>=1){
				if (term.charAt(0)=='@' || compact){
					var q=term;
					if (term.charAt(0)=='@'){
						q=term.substr(1);
					} 				
					
					if (!q.length){
						return;
					}
					
					var data={q: q, rand: AP.uuid()};
					
					data.__code=Client.code;
					if (Client.network){
						data.__network=Client.network.id;	
					}
					
					var tdata=$(this).data("aptag");
					
					if (tdata && tdata.lock && tdata.since && tdata.q){
						if (tdata.lock){
							return;
						}
						if ((tdata.q==q && AP.time.now() - tdata.since<2)){
							return;
						}
					}
					
					$(this).data("aptag",{q: q, since: AP.time.now(), lock: 1});
				
					if (AP.data.isArray(url)){
						var tdata=$("#"+id).data("aptag");
						if (!tdata){
							tdata={};
						}
						
						tdata.lock=0;
						$("#"+id).data("aptag", tdata);
						var code=AP.array.filter(url, function(item){
							return filter_fn(item, q);
						});
						
						var reorder=$(this).data("reorder_fn");
						
						if (reorder){				
							if (code && code.length){
								code.sort(function(a,b){
									return -reorder(a, q)+reorder_fn(b, q);
								});
							}
						}
						
						if (code && code.length && code.length>=1){
							var items=AP.render(code, function(item){
								if (!render_fn){
									return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"');\">"+item.name+"</span>";
								}
								return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"'); \">"+render_fn(item)+"</span>";
							});
							

							var pos=$("#"+id).offset();
							var tagname=$("#"+id).data('tagname');
							
							var tw=$("#"+id).width()+8;
							if (tw<240){
								tw=240;
							}
							
							if (tagname=='textarea' && !Client.native){
								var cpos=plugin_tag_textareacursor("#"+id);
								if (tagdir=="bottom"){
									var bt=$(window).height()-pos.top-$("#"+id).height();
									if (bt<0){
										bt=0;
									}
									
									$tagbox.html(items).show().css({"left": pos.left, "width": tw, bottom: bt+20});
								}else{
									$tagbox.html(items).show().css({"left": pos.left+cpos.left, top: pos.top + cpos.top});
								}
							}else{
								if (tagdir=="bottom"){
									$tagbox.html(items).show().css({"left": pos.left, "width": tw, bottom: $("#"+id).height()+20});
								}else{
									$tagbox.html(items).show().css({"left": pos.left, "width": tw, top: pos.top +10});
								}
							}
							
							plugin_select_updown_first($tagbox);
						}else{
							fn_cancel_tag(id);
						}
					}else{
						$.post(Client.url+'/ajax/'+url, data, function(code){
							var tdata=$("#"+id).data("aptag");
							if (!tdata){
								tdata={};
							}
							tdata.lock=0;
							$("#"+id).data("aptag", tdata);
							
							
							var reorder=$(this).data("reorder_fn");
							
							if (reorder){
								if (code && code.length){
									code.sort(function(a,b){
										return -reorder(a, q)+reorder_fn(b, q);
									});
								}
							}
							
							if (code && code.length && code.length>=1){
								var items=AP.render(code, function(item){
									if (!render_fn){
										return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"');\">"+item.name+"</span>";
									}
									return "<span class='item' data-value='"+item.value+"' onclick=\"plugin_tag_select('#"+id+"','"+item.value+" '); fn_cancel_tag('"+id+"'); \">"+render_fn(item)+"</span>";
								});
								

								var pos=$("#"+id).offset();
								var tagname=$("#"+id).data('tagname');
								
								if (tagname=='textarea' && !Client.native){
									var cpos=plugin_tag_textareacursor("#"+id);
									$tagbox.html(items).show().css({"left": pos.left+cpos.left, top: pos.top + cpos.top});	
								}else{
									if (tagdir=="bottom"){
										$tagbox.html(items).show().css({"left": pos.left, "width": $("#"+id).width()+8, bottom: $("#"+id).height()+20});
									}else{
										$tagbox.html(items).show().css({"left": pos.left, "width": $("#"+id).width()+8, top: pos.top +10});
									}
								}
								
								plugin_select_updown_first($tagbox);
							}else{
								fn_cancel_tag(id);
							}
						},"json");
					}
				}else{
					fn_cancel_tag(id);
				}
			}else{
				fn_cancel_tag(id);
			}
		});
		
	
		return $(this);
	};
	

	
	$.fn.renderEngine=function(fn){
		$(this).data("ui-autocomplete")._renderItem=function(ul, item){
			return $("<li></li>")
			.data("item.autocomplete", item)
			.append("<a class='rerender ap-acitem'>"+ fn(item)+"</a>")
			.appendTo(ul);
		};
		
		return $(this);
	};
	
	
	
	/**
	 * @desc Bind multiple-events
	 */
	$.fn.xbind=function(events, event_data, fn){
		if (!fn){
			fn=event_data;
			event_data={};
		}
		var lists=events.split(" ");
		for (var i=0; i<lists.length; i++){
			$(this).bind(lists[i], event_data, fn);
		}
	};
	
	
	/**
	 * @desc Set a flag on variable. If flag is not set, set it to 1.
	 * @return True if the flag is already set, false otherwhise.
	 */
	$.fn.flag=function(flag_name){
		if (!flag_name){
			flag_name='__flag';
		}
		
		var data=$(this).data(flag_name);
		if (!data){
			$(this).data(flag_name, 1);
			return false;
		}
		if (data==1){
			return true;
		}
		return false;
	};
	
	
	/**
	 * @desc Put a lock on a particular element. Return true if the lock
	 * is put on an unlocked element. False otherwise.
	 */
	$.fn.lock=function(){
		var data=$(this).data("__b_lock");
		if (!data || data===0){
			$(this).data("__b_lock", 1);
			return true;
		}
		return false;
	};
	
	

	/**
	 * @desc Put a lock on a particular element. Return true if the lock
	 * is put on an unlocked element. False otherwise.
	 */
	$.fn.unlock=function(){
		 // release binary lock
		$(this).data("__b_lock", 0);
	};
	
	
	
	/**
	 * @desc Cleanup a particular element.
	 */
	$.fn.cleanUp=function(){
		$(this).children().remove();
		$(this).empty();
		return $(this);
	};

	
	$.fn.preventAutoSubmit=function(){
		$(this).find(":input").on("keypress", function(e){
			if (event.keyCode == 13) {
				event.preventDefault();
				return false;
			}
		});
	};
	
	$.fn.mclick=function(click, dbclick){
		var timer;
		var clicks=0;
		
		$(this).on("click", function(e){
			var $this=$(this);
			clicks++;
			
			if (clicks==1){
				$(this).data("clicked", 1);
				timer=setTimeout(function(){
					click.apply($this[0]);
					clicks=0;
				}, 500);
			}else{
				clearTimeout(timer);
				dbclick.apply(this);
				clicks=0;
			}
		}).on("dbclick", function(e){
			e.preventDefault();
		});
	};
	
	
	$.fn.enter=function(action){
		var $this=$(this);
		$this.data("enter", action);
		$this.addClass("__ap_enter_binded");
		
		$(this).keydown(function(e){
			// Enter was pressed without shift key
			var key=e.keyCode? e.keyCode:e.which;
			if (key == AP.key.enter && !e.shiftKey){
				var id=$this.attr('id');
				if (id){
					var $tid=$("#__tag_"+id);
					if ($tid.length && $tid.is(":visible")){
						return;
					}
				}
				
				// prevent default behavior
				e.preventDefault();
				action.apply(this);
			}
		});
		
		return $this;
	};
	
	
	$.fn.updown=function(selections, select){
		var $this=$(this);
		$(selections).eq(0).addClass("active");
		$this.data("__updown", 0);
		
		$this.keydown(function(e){
			// Enter was pressed without shift key
			var key=e.keyCode? e.keyCode:e.which;
			var move=0;
			if (key==AP.key.up){
				move=-1;
			}
			if (key==AP.key.down){
				move=1;
			}
			
			if (move){
				e.preventDefault();
				var cur=$this.data("__updown");
				if (!cur){
					cur=0;
				}
				
				cur=parseInt(cur)+move;
				if (cur>=$(selections).filter(":visible").length){
					cur=$(selections).filter(":visible").length-1;
				}
				
				if (cur<0){
					cur=0;
				}
				
				if (cur<0 || !$(selections).length){
				}else{
					$this.data("__updown", cur);
					$(selections).removeClass("active");
					$(selections).filter(":visible").eq(cur).addClass("active");
					var $cx = $(selections).filter(":visible").eq(cur);
					
					if ($cx.parent().hasClass("scroll-y")){
						var current_s = $cx.parent().scrollTop();
						var current_o = $cx.position().top;
						var ch = $cx.parent().height();
						
						if (current_s + current_o + $cx.height() > ch){
							$cx.parent().scrollTop(current_o+current_s+$cx.height());
						}else if (current_o <0){
							$cx.parent().scrollTop(0);
						}
						
					}
				}
			}
			
			if (key==AP.key.enter){
				var x=$this.data("__updown");
				var elem=$(selections).eq(x);
				select.apply($this, [elem, x]);
			}
		});
		
		
		$(selections).each(function(){
			$(this).click(function(){
				select.apply($this, [this, $(this).index()]);
			})
		});
		
		return $this;
	};
	
	
	$.fn.triggerEnter=function(){
		var action=$(this).data("enter");
		action.apply(this);
	};
	
	
	$.fn.disableTab=function(){
		$(this).keydown(function(e) {
			if (e.keyCode === 9) {
				// get caret position/selection
				var start = this.selectionStart;
					end = this.selectionEnd;

				var $this = $(this);

				// set textarea value to: text before caret + tab + text after caret
				$this.val($this.val().substring(0, start)
							+ "	"
							+ $this.val().substring(end));

				// put caret at right position again
				this.selectionStart = this.selectionEnd = start + 4;

				// prevent the focus lose
				return false;
			}
		});
	};
	
	
	$.fn.caret2=function(){
		return new APCaret(this);
	};
	
	
	$.fn.ajaxShow=function(){
		$(this).addClass("__disabled").append("<div class='__ajaxshow "+(Client.darkmode?'-dark':'')+"'><span class='__icon -ap icon-spinner7 ficon-spinner'></div></div>");
	};
	
	$.fn.ajaxHide=function(){
		$(this).removeClass("__disabled").find(".__ajaxshow").remove()
	};
	
	$.fn.ajaxOn=function(){
		return $(this).hasClass("__disabled");
	};
	
	$.fn.ajaxFake = function(callback, duration){
		if (!duration){
			duration = 200;
		}
		
		var $this = $(this);
		
		$this.ajaxShow();
		setTimeout(function(){
			$this.ajaxHide();
			if (callback){
				callback();
			}
		}, duration);
	};
	
	
	$.fn.shortlist=function(opts){
		if (AP.data.isInt(opts)){
			opts = {max: opts};
		}
		
		$.extend({max: 10}, opts);
		
		if ($(this).children().length <= opts.max){
			return;
		}
		
		var rem=$(this).children().length-opts.max;
		
		$(this).data("max", opts.max).after("<div class='js-show-more show-more is-more'><span>Xem thĂªm ("+(rem)+")</span></div>");
		$(this).children().each(function(index){
			if (index<opts.max){
			}else{
				$(this).addClass("hidden");
			}
		});
		
		$(this).next().click(function(){
			var $prev=$(this).prev();
			$prev.children().each(function(index){
				if (index<$prev.data("max")){
				}else{
					$(this).toggleClass("hidden");
				}
			});
			
			if ($(this).hasClass("is-more")){
				$(this).removeClass("is-more");
				$(this).find("span").html("Xem Ă­t hÆ¡n");
			}else{
				var rem=$prev.children().length-$prev.data("max");
				$(this).addClass("is-more");
				$(this).find("span").html("Xem thĂªm ("+rem+")"); 
			}
		});
	};
	
	
	/**
	 * @desc Animate and back to the original state
	 */
	$.fn.animateX=function(styles, seconds, xstyles){
		if (!xstyles){
			xstyles={};
		}
		var cstyles={};
		for (var s in styles){
			cstyles[s]=$(this).css(s);
		}
		
		xstyles=$.extend({}, cstyles, xstyles);
		
		$(this).animate(styles, seconds*1000, function(){
			$(this).animate({opacity: "1.0"}, seconds*3000, function(){
				$(this).animate(xstyles, seconds*1000);
			});
		});
	};
	
	
	
	/**
	 * @desc Simplified version of AP.loadURL. Only load html with inline CSS. No change on
	 * the state of the document. Put the html directly to the given element.
	 */
	$.fn.loadHTML=function(url, callback, data){
		$("#ajax-load").show();
		
		var $this=$(this);
		if (!AP.word.prefix(url,'http')){
			url=Client.url+'/'+url;
		}
		
		AP.post(url,{},function(code){
			if (code.good()){
				$.log('Loading HTML '+url);
				
				// Loading css
				for (var i=0; i<code._css.length; i++){
					AP.css(code._css[i]);
				}
				
				$this.html(code._html);
				if (code._inpage_js){
					eval(code._inpage_js);
				}
				if (callback){
					callback(data);
				}
				$("#ajax-load").hide();
			}else{
				if (code.data && code.data.force_redirect){
					AP.redirect(code.data.force_redirect);
					return;
				}
				$("#ajax-load").hide();
			}
		}, true);
		
		return $this;
	};
	
	
	
	/**
	 * @desc Set a flag on variable. If flag is not set, set it to 1.
	 */
	$.fn.apv=function(){
		return AP.html.input(this);
	};
	
	
	/**
	 * @desc Set a flag on variable. If flag is not set, set it to 1.
	 */
	$.fn.xval=function(name, value){
		if (typeof value =='undefined'){
			return AP.html.input(this, name);
		}
		
		return $("*[name="+name+"]", this).val(value);
	};
	
	
	$.fn.restore=function(){
		$(this).each(function(){
			$(this).blur();
			if ($(this).hasClass('__autoresized') && $(this).attr('id')){
				var id=$(this).attr('id');
				var newid='#'+id+"__temptextarea";
				$(newid).html("");
				plugin_textarea_update('#'+id, newid);
				
				var orgh=$('#'+id).data("orgheight");
				if (orgh && parseInt(orgh) && $(this).tagName()!="input"){
					$('#'+id).css("height", orgh);
				}
			}
		});
		
		return this;
	};
	

	/**
	 * @desc Event when a child element is dragged outside its container.
	 */
	$.fn.dragOut=function(container, callback){
		$(this).draggable({
			start: function(event, ui) {
				ui.helper.removeMe = true;
			},
			stop: function(event, ui) {
				if (ui.helper.removeMe) {
					callback(this);
				}
			},  
			revert: true,
			stack:'body',
			zIndex:9999
		});
		
		
		$(container).droppable({
			drop: function(event, ui) {
				// unset removeMe flag as child is still inside parent
			   ui.helper.removeMe = false;
			}
		});
	};
	
	
	
	/**
	 * @desc Trigger an action when click outside.
	 */
	$.fn.clickOut=function(callback, canvas){
		var $elem=$(this);
		if (canvas){
			$(canvas).on('click',function(event){
				if (!$(event.target).closest($elem).length){
					callback.apply($elem, event);
				}
			});
			
			return;
		}
		
		$(document.body).on('click.__temp',function(event){
			if (!$(event.target).closest($elem).length){
				callback.apply($elem, [event]);
			}
		});
	};
	
	
	$.fn.loadedAll=function(callback, params){
		var total_images=$(this).length;
		var num_loaded=0;
		
		$(this).each(function(){
			if ($(this).height()>0){
				num_loaded++;
				if (num_loaded==total_images){
					callback(params);
				}
			}else{
				$(this).bind('load.__temp, error.__temp', {all_callback: callback, all_params:params}, function(event){
					num_loaded++;
					if (num_loaded==total_images){
						var cb=event.data.all_callback;
						cb(event.data.all_params);
					}
				});
			}
		});
	};
	
	
	/**
	 * @desc Get the smallest matched data-{name}
	 */
	$.fn.lastID=function(name){
		if (!name){
			name="id";
		};
		
		var last=0;
		
		$(this).each(function(){
			var val=parseInt($(this).data(name));
			if (!val){
				return;
			}
			
			if (val < last || last==0){
				last=val;
			}
		});
		
		return last;
	};
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.setActive=function(chosen){
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				$(this).removeClass('active');
				if (index==chosen){
					$(this).addClass('active');
				}
			});
		}else{
			if (chosen == ":first"){
				$(this).first().addClass("active");
				return;
			}
			
			if (chosen == ":last"){
				$(this).last().addClass("active");
				return;
			}
			
			$(this).each(function(){
				$(this).removeClass('active');
				if ($(this).is(chosen)){
					$(this).addClass('active');
				}
			});
		}
	};
	
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.getActive=function(){
		var found=null;
		$(this).each(function(){
			if ($(this).hasClass('active')){
				found=$(this);
				return;
			}
		});
			
		return found;
	};
	
	
	$.fn.setActiveURL=function(url){
		if (AP.data.isFunction(url)){
			var fn=url;
			$(this).each(function(){
				var curl=$(this).data("url");
				if (!curl || !curl.length){
					curl=$(this).data("xurl");
				}
				if (!curl){
					curl="";
				}
				
				var data={};
				var parts=curl.split("?");
				if (parts.length==2){
					data=queryStringToArray(parts[1]);
				}
				
				if (fn.apply(this, [curl, data])){
					$(this).addClass("active");
				}else{
					$(this).removeClass("active");
				}
			});
			return;
		}
		
		var base="";
		var fallback=null;
		if (AP.data.isObject(url) && url.base){
			base=url.base+"/";
		}
		
		if (AP.data.isObject(url) && url.fallback){
			fallback=url.fallback;
		}
		
		var maxscore=-1;
		var set=0;
		if (url && url.length && !AP.data.isObject(url)){
			
			$(this).each(function(){
				var curl=$(this).data("url");
				if (!curl || !curl.length){
					curl=$(this).data("xurl");
					curl=base+curl;
				}
				
				if (curl==url){
					// set = 1;
					$(this).addClass("active");
				}else{
					$(this).removeClass("active");
				}
			});
		
			return;
		}
		
		$(this).each(function(){
			var turl=$(this).data("url");
			if (!turl){
				turl=base+$(this).data("xurl");
			}
			var score=computeURLSimilarity(turl);
			
			$(this).data("active-score", score);
			if (score>maxscore){
				maxscore=score;
			}
		});
		
		
		$(this).each(function(){
			if (set){
				// return;
			}
			
			if ($(this).data("active-score")== maxscore && maxscore>0){
				set=1;
				$(this).addClass('active');
			}else{
				$(this).removeClass('active');
			}
		});
		
		if (!set && fallback){
			
			if (fallback==":first"){
				$(this).first().addClass("active");
				return;
			}
			
			$(this).each(function(){
				var turl=$(this).data("url");
				if (!turl){
					turl=$(this).data("xurl");
				}
				
				if (turl==fallback){
					$(this).addClass('active');
				}else{
					$(this).removeClass('active');
				}
			});	
		}
	};
	
	
	$.fn.setActiveURLParam=function(param, df){
		var _df=df;
		
		if (AP.data.isObject(df)){
			if ("fallback" in df){
				_df=df.fallback;
			}
			
			if ("df" in df){
				_df=df.df;
			}
		}
		
		var found=0;
		$(this).each(function(){
			var curl=$(this).data('url');
			if (!curl || !curl.length){
				curl=$(this).data("xurl");
			}
			
			if (!curl || !curl.length){
				curl=$(this).data("updateurl");
			}
			
			if (!curl && $(this).data("urlparam")==param){
				curl=param+"="+$(this).data("value");
			}
			
			
			if (!curl){
				$(this).removeClass('active');
				return;
			}
			
			var cq=Query.get(param);
			if (typeof(cq) == 'undefined' || cq===null){
				if (AP.data.isObject(df)){
					cq= df.value;
				}
			}
			
			
			var reg=new RegExp(param+"="+cq+"$"); 
			var reg2=new RegExp(param+"="+cq+"[\&\?]");
			
			var df_reg1=null;
			var df_reg2=null;
			
			if (df && AP.data.isString(df)){
				df_reg1=new RegExp(param+"="+_df+"$"); 
				df_reg2=new RegExp(param+"="+_df+"[\&\?]");	
			}
			
			if (curl.match(reg) || curl.match(reg2)){
				found=1;
				$(this).addClass('active');
			}else if (df_reg1 && df_reg2 && curl.match(df_reg1) || curl.match(df_reg2)){
				found=1;
				$(this).addClass('active');
			}else{
				$(this).removeClass('active');
			}
		});
		
		if (!found){
			if (_df==""){
				$(this).each(function(){
					if ($(this).data("value")=="" || typeof $(this).data("value") == "undefined"){
						$(this).addClass("active");
					}
				});
			}else{
				$(this).setActive(_df);	
			}
			
			
		}

		
		return this;
	};
	
	
	
	$.fn.setActiveURLQuery=function(param, defaults){
		var maxscore=-1;
		var set=0;
		
		if (param && defaults){
			$(this).each(function(){
				var curl=$(this).data("url");
				if (!curl || !curl.length){
					curl=$(this).data("xurl");
				}
				if (!curl || !curl.length){
					curl=$(this).data("updateurl");
				}
				
				var qs=Query.get(param);
				if (!qs){
					qs=defaults;
				}
				
				qs=param+"="+qs;
				
				if (curl.indexOf(qs)!=-1){
					$(this).addClass('active');
				}else{
					$(this).removeClass('active');
				}
			});
			return;
		}
	};
	
	
	/**
	 * @desc Set active based on data-{key}={value}
	 */
	$.fn.setActiveData=function(key, value){
		$(this).each(function(){
			var v=$(this).data(key);
			if ((!v && !value) || AP.data.equal(v, value)){
				$(this).addClass("active")
			}else{
				$(this).removeClass("active")
			}
		});
	};
	
	
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.setChecked=function(chosen){
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				$(this).removeClass('checked');
				if (index==chosen){
					$(this).addClass('checked');
				}
			});
		}else{
			$(this).each(function(){
				$(this).removeClass('checked');
				if ($(this).is(chosen)){
					$(this).addClass('checked');
				}
			});
		}
	};
	
	
	/**
	 * Show only element with index or classname. Hide all others.
	 */
	$.fn.showOnly=function(chosen){
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				if (index==chosen){
					$(this).show('active');
				}else{
					$(this).hide();
				}
			});
		}else{
			$(this).each(function(){
				if ($(this).is(chosen)){
					$(this).show();
				}else{
					$(this).hide();
				}
			});
		}
	};
	
	
	
	/**
	 * Toggle Active. Matching either index or classname.
	 */
	$.fn.toggleActive=function(chosen){ 
		if (AP.isInt(chosen)){
			$(this).each(function(index){
				if (index==chosen){
					$(this).toggleClass('active');
				}else{
					$(this).removeClass('active');
				}
			});
		}else{
			$(this).each(function(){
				if ($(this).is(chosen)){
					$(this).toggleClass('active');
				}else{
					$(this).removeClass('active');
				}
			});
		}
	};
	   
	
	
	/**
	 * Set Active. Matching either index or classname.
	 */
	$.fn.setPage=function(chosen){
		if (AP.isInt(chosen)){
			$(this).children().each(function(index){
				$(this).hide();
				if (index==chosen){
					$(this).show();
				}
			});
		}else{
			$(this).children().each(function(index){
				$(this).hide();
				if ($(this).hasClass(chosen)){
					$(this).show();
				}
			});
		}
	};
	
	
	/**
	 * @desc Set the tooltip value of an element, provided that the tooltip is
	 * already enabled for that element
	 */
	$.fn.setTooltip=function(val){
		$(this).each(function(){
			$(this).find('.__tooltip_inner').html(val);
		});
	};
	
	$.fn.tooltip=function(child, _options){
		if (!_options){
			_options={};
		}
		

		// $(this).addClass('__hblock');
		
		$(this).each(function(){
			var $p=$(this);
			$p.find(child).each(function(){
				var options=$.extend({},{dir: 'down', color: 'black', align: 'center', padding: 8},_options);
				if ($(this).hasClass('__tooltip')){
					return;
				}
				
				var v_color=$(this).data("color");
				if (v_color){
					options.color=v_color;
				}
				
				var v_align=$(this).data("align");
				if (v_align){
					options.align=v_align;
				}
				
				var v_dir=$(this).data("dir");
				if (v_dir){
					options.dir=v_dir;
				}
				
				var v_pad=$(this).data("padding");
				if (v_pad){
					options.padding=v_pad;
				}
				
				var padding=options.padding;
				
				if ($(this).hasClass('padding_less')){
					padding=4;
				}
				$(this).addClass('__tooltip').addClass('__tooltip'+options.color);
				$(this).wrapInner("<div class='__tooltip_inner' style='padding: "+padding+"px'/>");
				
				
				
				var align;
				if (options.align=='right' || $(this).hasClass('align_right')){
					align='right';
					$(this).css('right', -20);
				}else if (options.align=='left' || $(this).hasClass('align_left')){
					align='left';
					$(this).css('left', -20);
				}else if (options.align=='center' || $(this).hasClass('align_center')){
					align='center';
					var tl=$(this).outerWidth(true)- $p.outerWidth(true);
					$(this).css('left', -tl/2.0);
				}
				
				$(this).addClass('__tooltip'+align);
				
				if (options.dir=='down'){
					$("<div class='__ttarr_down2'></div>").appendTo($(this)).css('bottom', 7);
					$("<div class='__ttarr_down'></div>").appendTo($(this)).css('bottom', 9);
				}
			});
			$(this).addClass('__tooltipw');
		});
		
		// $(this).removeClass('__hblock');
	};
	
	
	
	$.fn.contextMenu=function(selector){
		if (!selector){
			selector=".__ctm";
		}
		$(this).each(function(){
				$(this).bind("contextmenu",function(e){
				e.stopPropagation();
				e.preventDefault();
				$("#__ctm").cleanUp().css({top: e.pageY, left: e.pageX}).show();
				
				var elem=$(this).find(selector).first();
				elem.addClass('__contextmenu');
				$(elem).clone().appendTo('#__ctm').show();
			});
			$(this).find(selector).hide();
		});
		return $(this);
	};
	
	

	$.fn.nodeName=function(){
		return $(this)[0].nodeName.toLowerCase();
	};
	
	
	$.fn.xMenu=function(selector){
		$(this).addClass('ap-pointer').addClass('ap-relative');
		$(this).find(selector).first().addClass('__contextmenu').hide();
		$(this).each(function(){
				$(this).bind("click",function(e){
				e.stopPropagation();
				e.preventDefault();
				$(this).find(selector).first().toggle();
			});
		});
	};
	
	
	$.fn.place=function(data){
		$(this).find(".__ph").each(function(){
			var name=$(this).data("name");
			if (data[name]){
				$(this).html(data[name]);
			}
		});
		
		return this;
	};
	
	
	
	$.fn.showCode=function(lang){
		$(this).each(function(){
			var $this=$(this);
			var id=$this.attr('id');
			if (!id){
				id=AP.uuid();
				$this.attr('id', id);
			}
			
			var text=$this.text();
			
			text=AP.word.replaceAll("&#8216;","'", text);
			text=AP.word.replaceAll("&#8217;","'", text);
			text=AP.word.replaceAll("â€˜","'", text);
			text=AP.word.replaceAll("â€™","'", text);
			text=AP.word.replaceAll("\t","	", text);
			
			
			$this.html("<pre><code></code></pre></div>");
			var $code=$this.find('code');
			$code.text(text);
			
			
			// $this.html(text);
			
			
			if (!lang){
				lang="php";
			}
			$code.addClass(lang);
			$code.parent().addClass('__codehl compact');
			
			SyntaxHighlighter.highlightDocument($code[0],false);
			
//			text=$this.html();
//			
//			if (text){
//				text=AP.word.replaceAll("\t","&nbsp;&nbsp;&nbsp;", text);
//				text=AP.word.replaceAll("\n","<br>", text);
//				$this.html(text);
//			}
			
			$("li:first-child",$this).addClass('first');
			$("li:last-child",$this).addClass('last');
			
			var $p=$code.parent();
			$p.parent().prepend("<div class='codeheader'>" +
				"<div class='code-title'>Embedded code</div>" +
				"<div class='code-button' onclick=\"$('#"+id+"').toggleClass('__codehlx');\">Highlighted code</div> " +
				"<div class='code-button' onclick=\"$('#"+id+"').toggleClass('__codehlx');\">View sources</div> " +
			"</div>");
			
			var h=$this.height();
			var lx="";
			for (var i=0; i< h/25+1; i++){
				var ln=i;
				if (ln<10){
					ln='00'+ln;
				}else if (ln<100){
					ln='0'+ln;
				}
				if (ln==0){
					lx+="<div class='number-sep'></div>";	
				}else{
					lx+="<div class='number'><div>"+ln+"</div></div>";	
				}
			}
			$code.append("<div class='linenumbers'>"+lx+"</div>");
		});
	};
	
	
	$.fn.setCursorPosition = function(pos) {
		if ($(this).get(0).setSelectionRange) {
			$(this).get(0).setSelectionRange(pos, pos);
		}else if ($(this).get(0).createTextRange) {
			var range = $(this).get(0).createTextRange();
			range.collapse(true);
			range.moveEnd('character', pos);
			range.moveStart('character', pos);
			range.select();
		}
	 };
	
	 
	 $.fn.chartjs=function(data, options){
		if (!options){
			options={};
		}
		 
		if ($(this).data('cheight')){
			options.height=$(this).data('cheight');
		}
		
		options=$.extend({},{width:$(this).width(), type: "line"}, options);
		var optx="";
		for (var key in options){
			optx+=key+"="+options[key]+" ";
		}
		
		
		$(this).children().remove();
		var id=AP.uuid();
		$("<canvas id='"+id+"' "+optx+"></canvas>").appendTo(this);
		
		var ctx = $('#'+id).get(0).getContext("2d");
		
		var myChart = new Chart(ctx, {
			type: options.type,
			data: data,
			options: options
		});
		var myChart = new Chart(ctx);
		return myChart;
	};
	
	

	$.fn.chartjsv2 = function(options, data, extOptions){
		if (!options){
			options={};
		}
		 
		if ($(this).data('cheight')){
			options.height=$(this).data('cheight');
		}
		
		options=$.extend({},{width:$(this).width()},options);
		var optx="";
		for (var key in options){
			optx+=key+"="+options[key]+" ";
		}
		
		
		$(this).children().remove();
		var id=AP.uuid();
		$("<canvas id='"+id+"' "+optx+"></canvas>").appendTo(this);
		
		var ctxP = $('#'+id).get(0);
		
		if (typeof ctxP == 'undefined' || !ctxP) {
			return null;
		}
		var ctx = ctxP.getContext("2d");
		var myNewChart = new Chart(ctx, {
			type: 'line',
			data: data,
			options: extOptions
		});
		return myNewChart;
	};
	
	
	$.fn.caret=function(){
		return new CaretHandler(this);
	};
	
})(jQuery);



function __linkifyNode(node) {
	var _len = node.childNodes.length;
	for (var i=0; i<_len; i++) {
	  if (node.childNodes[i].nodeType == document.ELEMENT_NODE) {
		__linkifyNode(node.childNodes[i]);
	  }
	}
	
	var texts = [];
	for (i=0; i<_len; i++) {
	  if (node.childNodes[i].nodeType == document.TEXT_NODE) {
		if (node.nodeName.toLowerCase()!="a"){
			texts.push(node.childNodes[i]);	
		}else{
			node.setAttribute("target","_blank");
			node.className += " _linkify";
		}
	  }
	}
	
	texts.forEach(function (item) {
	  if (item.nodeType == document.ELEMENT_NODE) {
		  __linkifyNode(item);
	  } else if (item.nodeType == document.TEXT_NODE) {
		while (true) {
		  var text = item.nodeValue;
		  var regex = /\bhttps?:\/\/[a-z0-9\.\-_](:\d+)?[^ \n\t<>()\[\]]*/i;
		  var match = regex.exec(text);
		  if (! match) {
			break;
		  }
		  var leadingNode = document.createTextNode(text.substr(0, match.index));
		  node.replaceChild(leadingNode, item);
		  var anchor = document.createElement("a");
		  anchor.setAttribute("target", "_blank");
		  anchor.className += " _linkify";
		  anchor.href = match[0];
		  anchor.appendChild(document.createTextNode(match[0]));
		  node.insertBefore(anchor, leadingNode.nextSibling);
		  var trailing = document.createTextNode(text.substr(match.index + match[0].length));
		  node.insertBefore(trailing, anchor.nextSibling);
		  item = trailing;
		}
	  }
	});
}









jQuery.extend({
	apScript: function(url, callback, id) {
	   var head = document.getElementsByTagName("head")[0];
	   var script = document.createElement("script");
	   script.src = url;
	   if (id){
		   script.id=id;
	   }
	
	   // Handle Script loading
	   {
		  var done = false;
	
		  // Attach handlers for all browsers
		  if (script.addEventListener){
			  script.addEventListener("load",function(){
				  if (done){
					  return;
				  }
				  done = true;
				  if (callback) callback();
			  },false);
		  }else if (script.readyState){
			  script.onreadystatechange = function(){
				 if (!done && (this.readyState == "loaded" || this.readyState == "complete" || this.readyState==4)) {
					done = true;
					if (callback)
					   callback();
		
					// Handle memory leak in IE
					script.onload = script.onreadystatechange = null;
				 }
			  };
		  }
	   }
	
	   head.appendChild(script);
	
	   // We handle everything using the script element injection
	   return undefined;
	}

});




function __fn_input_text_suggest(ref){
	var text=$(ref).text();
	
	$box=$(ref).closest(".__input-suggestion-canvas").parent();
	$box.find("input").val(text);
	// $box.find(".__input-suggestion-canvas").hide();
};



function __fn_input_suggest(ref){
	var $box=$(ref).closest(".__input-suggestion-canvas").parent();
	var options=$box.data("options");
	
	
	if (!options.multi || $(ref).data("all")){
		$box.removeClass("__iss");
		$box.closest(".row").removeClass("__ft");
		$box.find(".__input-suggestion-row").removeClass("active");
		
		$(ref).addClass("active");
		var val=$(ref).data("id");
		var text=$(ref).text();
		$box.find("input.__input-suggestion-target").val(val);
		$box.find("input.__input-suggestion-fake").val($(ref).text());
		$box.find("input.__input-extra-fx").val("");
		
		return;
	}
	
	
	var vals=$box.find("input.__input-suggestion-target").val().split(",");
	var id=$(ref).data("id");
	
	

	var found=false;
	for (var i=0; i<vals.length; i++){
		if ($.trim(vals[i])==id){
			found=1;
			break;
		}
	}
	
	if (found){
		$(ref).removeClass("active");
	}else{
		$(ref).addClass("active");
	}
	
	
	var ids=[];
	var ts=[];
	$box.find(".__input-suggestion-row").each(function(){
		if ($(this).data("all")){
			$(this).removeClass("active");
			return;
		}
		
		if ($(this).hasClass("active")){
			ts.push($(this).text());
			ids.push($(this).data("id"));
		}
	});
	
	
	$box.find("input.__input-suggestion-target").val(ids.join(", "));
	$box.find("input.__input-suggestion-fake").val(ts.join(", "));
	$box.find("input.__input-extra-fx").val("");
};


function computeURLSimilarity(url){
	if (!url){
		return 0;
	}
	
	if (!AP.data.isString(url)){
		url=""+url;
	}
	
	var data={};
	var parts=url.split("?");
	if (parts.length==2){
		data=queryStringToArray(parts[1]);
	}
	
	var current=Client.path.current;
	
	if (!current){
		current="home";
	}
	
	var base=0;
	
	if (parts.length==1){
		if (parts[0]==current){
			return 2;
		}
		
		var cindex = current.indexOf(parts[0]);
		
		if (cindex!=-1){
			if (parts[0].length){
				return 1+(1.0*parts[0].length/(parts[0].length+1))*(1/(cindex+1));
			}
			return 1;
		}
	}else{
		if (url==current){
			return 3;
		}
	}
	
	var score=0;
	if (parts[0]==Client.path.full.join("/")){
		score=1;
	}
	
	var same=true;
	for (var key in data){
		if (data[key]!=Query.get(key)){
			same=false;
			break;
		}
	}
	
	if (!same){
		return 0;
	}
	

	for (var key in Query.all()){
		if (data[key] && data[key]===Query.get(key)){
			score++;
		}
	}
	
	return score;
};



function fn_cancel_tag(id){
	var tid="__tag_"+id;
	$("#"+tid).hide();
};



function plugin_textarea_init(id, xtemp){
	var temp='__temp ';
	if (xtemp){
		temp='';
	}
	
	var newid=id.substr(1)+"__temptextarea";
	var tagflag=$(id).data("tag");
	if (!AP.html.exist("#"+newid)){
		$(id).css("overflow","hidden").addClass('__autoresized');
		$(id).data("orgheight", $(id).height());
		
		if (tagflag=="none"){
			$("<div class='"+temp+" ap-block' id='"+newid+"'></div>").appendTo("#ap-invs");
		}else{
			$("<pre class='"+temp+" ap-block' id='"+newid+"'></pre>").appendTo("#ap-invs");	
		}
		$("#"+newid).cloneCSS(id, "lineHeight, fontSize, fontFamily, fontWeight, boxModel");
		
		$("#"+newid).css("width", $(id).width());
		$("#"+newid).css("min-height", $(id).height());
		

		$(id).on('keypress keyup keydown', function(){
			if ($(id).data('tagname')=='textarea'){
				$("#"+newid).css("width", $(id).width());
				$("#"+newid).css("fontSize", $(id).css('fontSize'));	
			}
			plugin_textarea_update(id, "#"+newid);
		});	
	}else{
		console.error("EXIST #"+newid);
	}
};



function plugin_textarea_update(id, newid){
	if (!newid){
		newid="#"+id.substr(1)+"__temptextarea";
	}
	
	var $this=$(id);
	
	var taggable=$this.data("tag");
	var v=$this.val();
	var tagname=$this[0].nodeName.toLowerCase();
	
	if ($(id).data("autoexpand") && $(id).data("maxheight")){
		var orgh=$(newid).height();
		var maxh=$(id).data("maxheight");
		var pd=parseInt($(id).css('padding-top').replace(/[^-\d\.]/g, ''));
		
		if (orgh<maxh){
			$(id).css("height", orgh+2*pd);
		}else{
			$(id).css("height", maxh);
		}
	}
	
	if (taggable=='none' && tagname!='input'){
		v=AP.word.replaceAll("\n","<br>", v);
		v=AP.word.replaceAll("<","&lt;", v);
		v=AP.word.replaceAll(">","&gt;", v);
		
		$(newid).html(v+"&nbsp;");
		
		var mh=$this.data("max-height");
		var ch=$this.height();
		
		var h=$(newid).height();

		if (ch!=h){
			$this.trigger("expand",[ch, h]);
		}
		
		if (!mh || h<mh){
			$this.css("height",h).css("overflow","hidden");
		}else{
			$this.css("height",mh).css("overflow","auto");
		}
	}else{
		var pos=plugin_get_caret_position(id);
		
		if (pos>=0 && pos<=v.length){
			var ch="";
			// Set current word to data("current.word");
			var head="";
			for (var j=pos-1; j>=0; j--){
				var ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
					head=ch+head;
					if (ch=='@'){
						break;
					}
				}else{
					break;
				}
			}
			
			var tail="";
			for (var j=pos; j<v.length; j++){
				var ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
					tail=tail+ch;
					if (ch=='@'){
						break;
					}
				}else{
					break;
				}
			}
			
			
			$this.data("current_word",head+tail);
		}
		
		if (pos<v.length){
			v=v.substr(0,pos+1)+"<span></span>"+v.substr(pos+1, v.length-pos-1);
		}else{
			if (v.charAt(v.length-1)!='\n'){
				v=v+"<span></span>";
			}else{
				v=v+"<span></span>&nbsp;";
			}
		}
		
		if (tagname!='input'){
			v=AP.word.replaceAll("<","&lt;", v);
			v=AP.word.replaceAll(">","&gt;", v);
			v=AP.word.replaceAll("\n","<br>", v);
			v=AP.word.replaceAll("&lt;span&gt","<span>", v);
			v=AP.word.replaceAll("&lt;/span&gt","</span>", v);
			
			$(newid).html(v);
			var mh=$this.data("max-height");
			
			var h=$(newid).height();
			if (!mh || h<mh){
				if (Client.native){
					$(id).css("overflow","hidden");
				}else{
					$(id).css("overflow","hidden");	
				}
			}else{
				$(id).css("overflow","auto");
			}	
		}
	}
};



function plugin_textarea_update_simple(id, newid){	
	if (!newid){
		newid="#"+id.substr(1)+"__temptextarea";
	}
	
	var v=$(id).val();
	v=AP.word.replaceAll("\n","<br>", v);
	$(newid).html(v);
	
	var mh=$(id).data("max-height");
	var h=$(newid).height()+32;
	
	
	if (!mh || h<mh){
		$(id).css("height",h).css("overflow","hidden");
	}else{
		$(id).css("height",mh).css("overflow","auto");
	}
};




function plugin_tag_textareacursor(id){
	var newid=id.substr(1)+"__temptextarea";
	var pos=$("#"+newid+" span").position();
	
	return {top: pos.top, left: pos.left, width: $("#"+newid).width(), height: $("#"+newid).height()};
};



function plugin_select_updown_first($obj){
	if (!$obj.is(":visible")){
		return;
	}
	
	$obj.children().each(function(index){
		if (index==0){
			$(this).addClass('__tagactive');
		}
	});
	
	$obj.data('aptag_cindex', 0);
};


function plugin_select_updown_down($obj){
	if (!$obj.is(":visible")){
		return;
	}
	
	var cindex=$obj.data('aptag_cindex');
	var maxlen=$obj.children().length;
	
	if (maxlen==0){
		return;
	}
	
	if (cindex<maxlen-1){
		cindex++;
	}else{
		cindex=0;
	}
	
	var val='';
	$obj.children().each(function(index){
		if (AP.data.equal(index,cindex)){
			val=$(this).data('value');
			$(this).addClass('__tagactive');
		}else{
			$(this).removeClass('__tagactive');
		}
	});
	
	$obj.data('aptag_cindex', cindex);
	
	var id="#"+$obj.attr('id').substr(6);
	plugin_tag_select(id, val);
};



function plugin_select_updown_up($obj){
	if (!$obj.is(":visible")){
		return;
	}
	var cindex=$obj.data('aptag_cindex');
	var maxlen=$obj.children().length;
	
	if (maxlen==0){
		return;
	}
	
	if (cindex>0){
		cindex--;
	}else{
		cindex=maxlen-1;
	}
	
	var val='';
	
	$obj.children().each(function(index){
		if (index==cindex){
			val=$(this).data('value');
			$(this).addClass('__tagactive');
		}else{
			$(this).removeClass('__tagactive');
		}
	});
	
	$obj.data('aptag_cindex', cindex);
	
	var id="#"+$obj.attr('id').substr(6);
	plugin_tag_select(id, val);
};



function plugin_select_updown_enter($obj){
	if (!$obj.is(":visible")){
		return;
	}
	
	var cindex=$obj.data('aptag_cindex');
	var maxlen=$obj.children().length;
	
	if (maxlen==0 || cindex>=maxlen){
		return;
	}
	
	$obj.children().eq(cindex).click();
	$obj.hide();
	
	var select_fn=$obj.data("onselect");
	
	if (select_fn){
		select_fn($obj.children().eq(cindex).data("value"));
	}
};



function plugin_tag_select(id, replaced){
	if ($(id).data("single-tag")){
		$(id).val($.trim(replaced));
		return;
	}
	
	// $(id).next('.__ap_xauto').hide();
	if (!$(id).length){
		return;
	}
	
	var v=$(id).apv();
	var pos=plugin_get_caret_position(id);
	
	var compact=($(id).data("compacttagging")==1 || $(id).data("compacttagging")=='1');
	
	var start=-1;
	var end=v.length;
	if (!v){
		return;
	}
	
	if (compact){
		if (v.indexOf(' ')==-1){
			start=0;
		}else{
			if (pos>=0 && pos<=v.length){
				var ch="";
				// Set current word to data("current.word");
				var head="";
				for (var j=pos-1; j>=0; j--){
					ch=v.charAt(j);
					if (ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
						if (ch==' '){
							start=j;
							break;
						}
					}else{
						break;
					}
				}
				
				for (var j=pos; j<v.length; j++){
					var ch=v.charAt(j);
					if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.' && ch!='@'){
					}else{
						end=j;
						break;
					}
				}
			}	
		}
	}else{
		if (pos>=0 && pos<=v.length){
			var ch="";
			// Set current word to data("current.word");
			var head="";
			for (var j=pos-1; j>=0; j--){
				ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
					if (ch=='@'){
						start=j;
						break;
					}
				}else{
					break;
				}
			}
			
			for (var j=pos; j<v.length; j++){
				var ch=v.charAt(j);
				if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.' && ch!='@'){
				}else{
					end=j;
					break;
				}
			}
		}

	}
		
	
	
	if (start!=-1){
		v=v.substr(0,start)+((compact&&start>0)?" ":"")+replaced+v.substr(end, v.length-end);
		$(id).val(v);
		$(id).setCursorPosition(start+replaced.length+((compact&&start>0)?1:0));
		$(id).trigger("base-focus");
	}
};



function plugin_actual_tag_select(id, replaced){
	$(id).next('.__ap_xauto').hide();
	var v=$(id).apv();
	var pos=plugin_get_caret_position(id);
	
	var start=-1;
	var end=v.length;
	if (!v){
		return;
	}
	
	if (pos>=0 && pos<=v.length){
		var ch="";
		// Set current word to data("current.word");
		var head="";
		for (var j=pos-1; j>=0; j--){
			ch=v.charAt(j);
			if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
				if (ch=='@'){
					start=j;
					break;
				}
			}else{
				break;
			}
		}
		
		for (var j=pos; j<v.length; j++){
			var ch=v.charAt(j);
			if (ch!=' ' && ch!="\n" && ch!='>'  && ch!='<' && ch!=',' && ch!='.'){
			}else{
				end=j;
				break;
			}
		}
	}
	
	if (start!=-1){
		v=v.substr(0,start)+replaced+v.substr(end, v.length-end-1);
		$(id).val(v);
		$(id).setCursorPosition(start+replaced.length);
	}
};



function plugin_get_caret_position(id){	
	var el = $(id)[0];
	var pos = 0;
	if ('selectionStart' in el){
		el.focus();
		pos = el.selectionStart;
	} else if ('selection' in document) {
		el.focus();
		var Sel = document.selection.createRange();
		var SelLength = document.selection.createRange().text.length;
		Sel.moveStart('character', -el.value.length);
		pos = Sel.text.length - SelLength;
	}
	return pos;
};


function plugin_textarea_insert(id, str){
	var pos=plugin_get_caret_position(id);
	var val=$(id).val();
	$(id).val(val.substr(0, pos)+str+val.substr(pos+1));
	$(id).setCursorPosition(pos+str.length);
};





(function($){
	  $.event.special.destroyed = {
		remove: function(o) {
		  if (o.handler) {
			o.handler();
		  }
		}
	  };
})(jQuery);





function choose(a, if_null){
	if (AP.data.isEmpty(a)){
		return if_null;
	}
	return a;
};





(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if (typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if (i&&!h){l()}h&&clearTimeout(h);if (i===c&&m>e){l()}else{if (f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if ($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);













!function(e,t){if ("function"==typeof define&&define.amd)define(["exports","module"],t);else if ("undefined"!=typeof exports&&"undefined"!=typeof module)t(exports,module);else{var n={exports:{}};t(n.exports,n),e.autosize=n.exports}}(this,function(e,t){"use strict";function n(e){function t(){var t=window.getComputedStyle(e,null);"vertical"===t.resize?e.style.resize="none":"both"===t.resize&&(e.style.resize="horizontal"),s="content-box"===t.boxSizing?-(parseFloat(t.paddingTop)+parseFloat(t.paddingBottom)):parseFloat(t.borderTopWidth)+parseFloat(t.borderBottomWidth),isNaN(s)&&(s=0),l()}function n(t){var n=e.style.width;e.style.width="0px",e.offsetWidth,e.style.width=n,e.style.overflowY=t}function o(e){for(var t=[];e&&e.parentNode&&e.parentNode instanceof Element;)e.parentNode.scrollTop&&t.push({node:e.parentNode,scrollTop:e.parentNode.scrollTop}),e=e.parentNode;return t}function r(){var t=e.style.height,n=o(e),r=document.documentElement&&document.documentElement.scrollTop;e.style.height="";var i=e.scrollHeight+s;return 0===e.scrollHeight?void(e.style.height=t):(e.style.height=i+"px",u=e.clientWidth,n.forEach(function(e){e.node.scrollTop=e.scrollTop}),void(r&&(document.documentElement.scrollTop=r)))}function l(){r();var t=Math.round(parseFloat(e.style.height)),o=window.getComputedStyle(e,null),i="content-box"===o.boxSizing?Math.round(parseFloat(o.height)):e.offsetHeight;if (i!==t?"hidden"===o.overflowY&&(n("scroll"),r(),i="content-box"===o.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight):"hidden"!==o.overflowY&&(n("hidden"),r(),i="content-box"===o.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight),a!==i){a=i;var l=d("autosize:resized");try{e.dispatchEvent(l)}catch(e){}}}if (e&&e.nodeName&&"TEXTAREA"===e.nodeName&&!i.has(e)){var s=null,u=e.clientWidth,a=null,c=function(){e.clientWidth!==u&&l()},p=function(t){window.removeEventListener("resize",c,!1),e.removeEventListener("input",l,!1),e.removeEventListener("keyup",l,!1),e.removeEventListener("autosize:destroy",p,!1),e.removeEventListener("autosize:update",l,!1),Object.keys(t).forEach(function(n){e.style[n]=t[n]}),i.delete(e)}.bind(e,{height:e.style.height,resize:e.style.resize,overflowY:e.style.overflowY,overflowX:e.style.overflowX,wordWrap:e.style.wordWrap});e.addEventListener("autosize:destroy",p,!1),"onpropertychange"in e&&"oninput"in e&&e.addEventListener("keyup",l,!1),window.addEventListener("resize",c,!1),e.addEventListener("input",l,!1),e.addEventListener("autosize:update",l,!1),e.style.overflowX="hidden",e.style.wordWrap="break-word",i.set(e,{destroy:p,update:l}),t()}}function o(e){var t=i.get(e);t&&t.destroy()}function r(e){var t=i.get(e);t&&t.update()}var i="function"==typeof Map?new Map:function(){var e=[],t=[];return{has:function(t){return e.indexOf(t)>-1},get:function(n){return t[e.indexOf(n)]},set:function(n,o){e.indexOf(n)===-1&&(e.push(n),t.push(o))},delete:function(n){var o=e.indexOf(n);o>-1&&(e.splice(o,1),t.splice(o,1))}}}(),d=function(e){return new Event(e,{bubbles:!0})};try{new Event("test")}catch(e){d=function(e){var t=document.createEvent("Event");return t.initEvent(e,!0,!1),t}}var l=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?(l=function(e){return e},l.destroy=function(e){return e},l.update=function(e){return e}):(l=function(e,t){return e&&Array.prototype.forEach.call(e.length?e:[e],function(e){return n(e,t)}),e},l.destroy=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],o),e},l.update=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],r),e}),t.exports=l});










(function($) {  
	
	$.fn.selectFiles=function(options){
		if (!options){
			options={};
		}
		options=$.extend({},{label:"Select Files","icon":null},options);
		if ($(this).data("label")){
			options.label=$(this).data("label");
		}
		if ($(this).data("alt-label")){
			options.alt_label=$(this).data("alt-label");
		}
		
		
		if ($(this).data("icon")){
			options.icon=$(this).data("icon");
		}

		if (!options.alt_label){
			options.alt_label=options.label;
		}
		
		
		$(this).each(function(){
			if (options.multi){
				$(this).addClass("__multi");
			}
			$(this).addClass('__file_org');
			
			var name=$(this).attr('name');
			var p=$(this).parent();
			p.addClass('__file');
			p.parent().addClass('rowfile');
			if (!p.attr('id')){
				p.attr('id',AP.uuid());
			}
			var pid=$(p).attr('id');
			
			$(this).hide();
			var temp=AP.uuid();
		
			var icon="";
			if (options.icon){
				icon="<span class='ap-f14 "+options.icon+"'></span>&nbsp; "
			}
			
			if ($(this).hasClass("__multi") || options.multi){
				$("<div class='__files hidden'></div> <div class='fl hidden'></div><div class='browse'><em data-alt_label='"+options.alt_label+"' data-prim_label='"+options.label+"'>"+icon+options.label+"</em> <input type='file' name='__tmp"+name+"' class='__browse' onchange=\"__apupload_AddFiles(this, '"+pid+"','"+name+"');\"></div>").appendTo(p);
			}else{
				$("<div class='__files hidden'></div> <div class='fl hidden'></div><div class='browse'><em data-alt_label='"+options.alt_label+"' data-prim_label='"+options.label+"'>"+icon+options.label+"</e> <input type='file' name='__tmp"+name+"' class='__browse' onchange=\"__apupload_AddOneFile(this, '"+pid+"','"+name+"');\"></div>").appendTo(p);
			}
		});
	};
	
	
	
	
	
	/**
	 * @desc Multiupload/select file
	 */
	$.fn.multiUpload=function(options, callback){
		if (options && AP.isString(options) && typeof options!='undefined'){
			return upload_apply(this, options);
		}
		
		options=$.extend({}, {show: true, close_button: false, title: "Upload Files", browse_label: "Browse", submit_label:"Finish Browsing", reset_label:"Reset Selections", hint:"Hint: You can drag your mouses or use CTRL key to select multiple files at once.", clean: false, upload_on_close: false, filename_max_length: 40, max_items: 10, name: 'file', allow:'jpg, jpeg, png, gif, pdf, doc, docx'}, options);
		if (typeof callback!='undefined'){
			options.callback=callback;
		}else{
			options.callback=null;
		}
		
		if (!$(this).flag()){
			// Setup Multi Upload
			options.queue=[];
			upload_setup(this, options);
		}
		
		if (options.clean){
			$(this).multiUpload('clean');
		};
		
		if (options.upload_on_close){
			$(this).addClass('hidden');
		}
		
		if (options.close_button){
			AP.dialog("#"+upload_container($(this).attr('id'))).canvas().find(".__dialogclose").show();
		}
		
		AP.dialog("#"+upload_container($(this).attr('id'))).show();
		
		if (options.show==false){
			AP.dialog("#"+upload_container($(this).attr('id'))).hide();
		};
		
	};
	
	
	/**
	 * @desc Add new file from input[type=file] <param fi or file input>
	 */
	$.fn.multiUpload_addFile=function(fi){
		var options=$(this).data('__ap_upload_data');
		if (!options){
			return false;
		}
		var val=$(fi).val();
		if (val && val.length>1){
			// Get filename
			var name=upload_filename(val);
			if (name){
				upload_displayFile(this, {'name': name, size:''});
			}
		}

	};
	
	
	/**
	 * @desc Add new file from input[type=file] <param fi or file input>
	 */
	$.fn.multiUpload_addMFiles=function(fi, lists){
		// Marking that we are using fileAPI.
		if ($(".__fileapi", this).length==0){
			$(this).append("<input type='hidden' name='fileapi' class='__fileapi' value='1'/>");
		}
		
		$(this).multiUpload('clean');
		
		var options=$(this).data('__ap_upload_data');
		if (!options){
			return false;
		}
		var selector=$(this).attr('id');
		
		for (var i=0; i<lists.length; i++){
			var file=lists[i];
			var name=file.name;
			if (name){
				if (name.length>=options.filename_max_length){
					name=name.substr(0, options.filename_max_length-1)+"...";
				}
				var size='';
				if (file.size){
					size=Math.floor(parseInt(file.size)/1000)+"KB";
				}
				
				// Validation
				if (options.allow && !AP.word.fileX(name, options.allow)){
					return AP.alertError("Invalid file extensions.");
				}
				
				if (options.queue.length >= options.max_items){
					$(this).multiUpload('clean');
					return AP.alertError("You've selected too many files.");
				}
				
				$("#"+upload_container(selector)+" .upload-place").append("<div class='upload-item ap-clear-fix'><div class='index'><div class='i32 i32-circle'><span>"+(options.queue.length+1)+"</span></div></div><div class='name'>"+name+"</div><div class='size'>"+size+"&nbsp;</div><div class='upload-buttons hidden'><span class='s16 s16-apb-close pointer' title='Remove this file?'></span></div><div class='ap-1fix left'></div></div>");
				options.queue.push(file.name);
			}
		}
		
		
		$("#"+upload_container(selector)+" div.browser-button input[name=ap-browser]").attr('name',''+options.name+'[]').unbind('change').appendTo(upload_area(selector));		
		$("#"+upload_container(selector)+" div.browser-button").append("<input type='file' name='ap-browser' multiple=''>");		
		
		$("#"+upload_get_counter_wrapper_id(selector)).html(options.queue.length);
		upload_setChangeHandler(selector);
		
		AP.dialog("#"+upload_container(selector)).balance();
	};
	
	
	
	var upload_apply=function(obj, fn){
		if (fn=='show'){
			AP.dialog("#"+upload_container($(obj).attr('id'))).show();
			return;
		}else if (fn=='get'){
			var options=$(obj).data('__ap_upload_data');
			if (options && options.queue){
				return options.queue;
			}
			return [];
		}else if (fn=='hide'){
			AP.dialog("#"+upload_container($(obj).attr('id'))).hide();
			upload_callback($(obj).attr('id'));
			return;
		}else if (fn=='close'){
			var options=$(obj).data('__ap_upload_data');
			if (!options){
				$.log('multi-upload fails to add file');
				return false;
			}
			if (options.upload_on_close){
				var _fn=AP.nothing;
				if (options.close_callback){
					_fn=options.close_callback;
				}
				AP.submitFrame('#'+$(obj).attr('id'), function(code){
					_fn(code);
				});
			}else{
				AP.dialog("#"+upload_container($(obj).attr('id'))).hide();
			}
			upload_callback($(obj).attr('id'));
		}else if (fn=='clean'){
			var selector=$(obj).attr('id');
			var options=$(obj).data('__ap_upload_data');
			if (!options){
				$.log('multi-upload fails to add file');
				return false;
			}
			
			// When FileAPI is not supported
			if (!AP.sys.file()){
				$("#"+upload_container(selector)+" .upload-place").empty();
				$(upload_area(selector)).empty().html("<input type='hidden' name='max-"+options.name+"' value='"+options.max_items+"'/>");
				$("#"+upload_container(selector)+" div.browser-button").empty().html('Browser').append("<input type='file' name='ap-browser' multiple=''>");
				
				upload_setChangeHandler(selector);
				
				options.queue=[];
				$(obj).data('__ap_upload_data', options);
				$("#"+upload_get_counter_wrapper_id(selector)).html(0);
			}else{
				// We won't remove the input file.
				
				$("#"+upload_container(selector)+" .upload-place").empty();
				$(upload_area(selector)).empty().html("<input type='hidden' name='max-"+options.name+"' value='"+options.max_items+"'/>");
				
				options.queue=[];
				$(obj).data('__ap_upload_data', options);
				$("#"+upload_get_counter_wrapper_id(selector)).html(0);
			}
			
			
		}else{
			$.log('unknown flag '+fn);
		}
	};

	
	
	var upload_callback=function(id){
		var id="#"+id;
		var options=$(id).data('__ap_upload_data');
		if (options.callback){
			options.callback(options.queue);
		}
	};
		
	
	/**
	 * @desc Setup the multi-upload Platform
	 */
	var upload_setup=function(element, options){
		
		$(element).data("__ap_upload_data", options);
		
		var selector=$(element).attr('id');
		var container=upload_container(selector);
		var submit=options.submit_label;

		var buttons="<div class='upload-bt' onclick=\"$('#"+selector+"').multiUpload('close');\">"+submit+"</div>";
		
		var extra_class='';
		if (options.upload_on_close){
			buttons="<div class='upload-bt upload-btd' onclick=\"$('#"+selector+"').multiUpload('hide');\">Cancel</div>"
				+"<div class='upload-bt upload-btd' onclick=\"$('#"+selector+"').multiUpload('close');\">"+submit+"</div>" +
				"<div class='upload-bts'></div>";
		}else{
			extra_class='has_close_button';
		}
		
		
		$("#ap-temp").append("<div id='"+container+"' class='multi-upload ap-mh200'>" +
				"<div class='upload-title ap-clearfix'><span id='"+upload_get_counter_wrapper_id(selector)+"'>0</span> "+"files have been selected"+" <span class='reset' onclick=\"$('#"+selector+"').multiUpload('clean');\">"+options.reset_label+"</span> <div class='button browser-button'>"+options.browse_label+"</div></div>" +
				"<div class='upload-place'></div>" +
				"<div class='upload-extra'></div>" +
				"<div class='upload-buttons relative'>" +
				buttons+
				"</div>"+
			"</div>");
		
		AP.dialog("#"+container)
			.data('form', $(element).attr('id'))
			.engine(AP.config.uploadDialogEngine)
			.title(options.title).width(600)
			.style(extra_class)
			.show();
			
		$("#"+selector).append("<div class='__ap-upload-area hidden'><input type='hidden' name='max-"+options.name+"' value='"+options.max_items+"'/></div>");
		
		$("#"+container+" div.browser-button").append("<input type='file' name='ap-browser' multiple=''>");
		
		
		if (AP.sys.file()){
			$("#"+container+" .upload-extra").append("<div class='desc'>"+options.hint+"</div>");
		}
		
		upload_setChangeHandler(selector);
		
	};
	
	
	/**
	 * @desc Setting up the onChange handler for the input button.
	 */
	var upload_setChangeHandler=function(selector){
		var container=upload_container(selector);
		$("#"+container+" div.browser-button input").bind("change", function(){
			if (AP.sys.file()){
				var s=document.querySelector("#"+container+" div.browser-button input");
				return $('#'+selector).multiUpload_addMFiles(this, s.files);
			}else{
				$('#'+selector).multiUpload_addFile(this);
			}
		});
	};
	
	
	/**
	 * @desc After adding a file, displaying it to dialog
	 */
	var upload_displayFile=function(element, file){
		var options=$(element).data('__ap_upload_data');
		if (!options){
			$.log('multi-upload fails to add file');
			return false;
		}
			
		
		var name=file.name;
		if (name.length>=options.filename_max_length){
			name=name.substr(0, options.filename_max_length-1)+"...";
		}
		var size='';
		if (file.size){
			size=file.size;
		}
		
		// Validation
		if (options.allow && !AP.word.fileX(name, options.allow)){
			return AP.alertError('Invalid file extension.');
		}
		
		if (options.queue.length >= options.max_items){
			return AP.alertError("You've selected too many files.");
		}
		
		var selector=$(element).attr('id');
		$("#"+upload_container(selector)+" .upload-place").append("<div class='upload-item ap-clear-fix'><div class='index'><div class='i32 i32-circle'><span>"+(options.queue.length+1)+"</span></div></div><div class='name'>"+name+"</div><div class='size'>"+size+"&nbsp;</div><div class='upload-buttons'><span class='i12 i12-close pointer' title='Remove this file?'></span></div><div class='ap-1fix left'></div></div>");
		
		$("#"+upload_container(selector)+" div.browser-button input[name=ap-browser]").attr('name',''+options.name+'-'+options.queue.length).unbind('change').appendTo(upload_area(selector));		
		$("#"+upload_container(selector)+" div.browser-button").append("<input type='file' name='ap-browser' multiple=''>");		
		upload_setChangeHandler(selector);
		
		
		options.queue.push(file.name);
		
		$("#"+upload_get_counter_wrapper_id(selector)).html(options.queue.length);
	};
	
	
	
	/**
	 * @desc Return the container ID 
	 */
	var upload_container=function(id){
		return "__upload_"+id;
	};
	
	
	
	/**
	 * @desc Getting the upload wrapper ID to count the items
	 */
	var upload_get_counter_wrapper_id=function(selector){
		return selector+'__upload_counter';
	};
	
	
	/**
	 * @desc Getting the upload area ID
	 */
	var upload_area=function(selector){
		return "#"+selector+" div.__ap-upload-area";
	};
	
	
	/**
	 * @desc Getting the upload filename from some posted sources
	 */
})(jQuery);



var upload_filename=function(str){
	return getUploadFN(str);
};


var __apupload_AddFiles=function(obj, pid, name){
	var $p=$('#'+pid);
	var $files=$('.__files', $p);
	var f=$(obj).val();
	if (f && f.length>1){
		// Get filename
		var tmpname=getUploadFN(f);
		var tempid=AP.uuid();
			
		if (tmpname){
			$('.fl', $p).append("<div class='fi' id='__tmp"+tempid+"'> <div class='remove' onclick=\"__apupload_RemoveFile('"+tempid+"');\"> <div class='tt hidden padding_less' style='width:140px; bottom:20px; font-weight:normal'>Remove file "+tmpname+"?</div> <span class='ticon-cancel entypo'></span></div> <span class='ticon-doc entypo'></span> "+tmpname+"</div>").show();
		}
		$('.__browse',$p).unbind('change').attr('name',name+'[]').attr('id',tempid).appendTo($files);
		$('.browse', $p).append("<input title='Click to select files' type='file' class='__browse' name='__tmp"+name+"' onchange=\"__apupload_AddFiles(this, '"+pid+"','"+name+"');\"/>");
		
		$('.remove',$p).tooltip('.tt');
		
		var alt=$('.browse em', $p).data("alt_label");
		var prim=$('.browse em', $p).data("prim_label");
		
		if ($('.fl .fi', $p).length && $('.fl .fi', $p).length>=1){
			$('.browse > em', $p).html(alt);
		}else{
			$('.browse > em', $p).html(prim);
		}
	}
};


var __apupload_AddOneFile=function(obj, pid, name){
	var $p=$('#'+pid);
	var $files=$('.__files', $p);
	var f=$(obj).val();
	if (f && f.length>1){
		// Get filename
		var tmpname=getUploadFN(f);
		var tempid=AP.uuid();
			
		if (tmpname){
			$('.fl', $p).html("<div class='fi' id='__tmp"+tempid+"'> <div class='remove' onclick=\"__apupload_RemoveFile('"+tempid+"');\"> <div class='tt hidden padding_less' style='width:140px; bottom:20px; font-weight:normal'>Remove file "+tmpname+"?</div> <span class='ticon-cancel entypo ap-f16'></span></div> <span class='ticon-upload ap-f16 entypo'></span> "+tmpname+"</div>").show();
		}
		$files.cleanUp();
		$('.__browse',$p).unbind('change').attr('name',name+'').attr('id',tempid).appendTo($files);
		$('.browse', $p).append("<input title='Click to select a file' type='file' class='__browse' name='__tmp"+name+"' onchange=\"__apupload_AddOneFile(this, '"+pid+"','"+name+"');\"/>");
		
		$('.remove',$p).tooltip('.tt');
		var alt=$('.browse em', $p).data("alt_label");
		var prim=$('.browse em', $p).data("prim_label");
		
		if ($('.fl .fi', $p).length && $('.fl .fi', $p).length>=1){
			$('.browse > em', $p).html(alt);
		}else{
			$('.browse > em', $p).html(prim);
		}
	}
};


var __apupload_RemoveFile=function(id){
	var $p=$('#__tmp'+id).parent();
	
	$('#'+id).remove();
	$('#__tmp'+id).remove();
	
	if (!$p.has('div').length){
		$p.hide();
	}
	
	var $px=$p.closest('.__file');
	
	var alt=$('.browse em', $px).data("alt_label");
	var prim=$('.browse em', $px).data("prim_label");
	var icon="";
	if ($('.__file_org',$px).data("icon")){
		icon="<span class='ap-f14 "+options.icon+"'></span>&nbsp; "
	}
	
	if ($('.fl .fi', $px).length && $('.fl .fi', $px).length>=1){
		$('.browse > em', $px).html(icon+alt);
	}else{
		$('.browse > em', $px).html(icon+prim);
	}
};



var BasicFormEngine=new function __BasicFormEngine(){	
	this.show=function(canvas, form){
		var id=AP.uuid();
		var extra=form.getStyles().join(" ");
		var css=form.getCss().join(";");
		var text="<div class='__form "+extra+"' id='"+id+"' style='"+css+"'> <form method='post' action='"+form.getURL()+"' id='"+form.getID(true)+"'>" +
		this.getRows(form)+
		"<div class='row buttons __buttons'></div>"+
		"</form></div>";
		$(canvas).append(text);
		
		for (var button in form.getButtons()){
			$("<div class='button'>"+button+"</div>").bind('click',{fn: form.getButton(button)},function(event){
				event.data.fn();
			}).appendTo($("#"+id).find('.__buttons').first());
		};
	};
	
	
	this.html=function(form){
		var id=AP.uuid();
		var extra=form.getStyles().join(" ");
		var css=form.getCss().join(";");
		var handler=form.getHandlerInline();
		
		var text="<div class='__form "+extra+"' id='"+id+"' style='"+css+"' "+handler+"> <form method='post' action='"+form.getURL()+"' id='"+form.getID(true)+"'>" +
		this.getRows(form)+
		"</form></div>";
		return text;
	};
	
	
	
	
	/**
	 * @desc Rendering rows
	 */
	this.getRows=function(form){
		var text="";
		for (var i=0; i<form.getData().length; i++){
			var elem=form.getData(i);
			if (!elem.meta.value){
				elem.meta.value="";
			}
			
			var hint="";
			if (elem.meta.hint){
				hint="<div class='hint'>"+elem.meta.hint+"</div>";
			}
			
			
			if (elem.type=='hidden'){
				text+="<input type='hidden' name='"+elem.meta.name+"' value='"+elem.meta.value+"'/>";
			}
			if (elem.type=='text'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='input'><input type='text' name='"+elem.meta.name+"' value='"+elem.meta.value+"'/></div>"+hint+"</div>";
			}
			if (elem.type=='file'){
				var _class='';
				if (elem.meta.multi){
					_class=" class='__multi' ";
				}
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='file'><input type='file' "+_class+"name='"+elem.meta.name+"'/></div>"+hint+"</div>";
			}
			if (elem.type=='select'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='select'><select class='__multi' name='"+elem.meta.name+"'>"+this.getSelectOptions(elem.meta.options, elem.meta.value)+"</select></div>"+hint+"</div>";
			}
			if (elem.type=='choice'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='select'><select class='__choice' name='"+elem.meta.name+"'>"+this.getSelectOptions(elem.meta.options)+"</select></div></div>";
			}
			if (elem.type=='textarea'){
				if (!elem.meta.value){
					elem.meta.value="";
				}
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='input'><textarea name='"+elem.meta.name+"'>"+elem.meta.value+"</textarea></div>"+hint+"</div>";
			}
			if (elem.type=='info'){
				text+="<div class='row'> <label>"+elem.meta.label+"</label> <div class='info'><div>"+elem.meta.value+"</div></div></div>";
			}
			if (elem.type=='hint'){
				text+="<div class='row'><div class='hint'><div>"+elem.meta.value+"</div></div></div>";
			}
		}
		return text;
	};
	
	
	/**
	 * @desc Get options for a select input
	 */
	this.getSelectOptions=function(opts, value){
		var text="";
		for (var opt in opts){
			if (AP.data.equal(opt,value)){
				text+="<option value='"+opt+"' selected>"+opts[opt]+"</option>";
			}else{
				text+="<option value='"+opt+"'>"+opts[opt]+"</option>";
			}
		}
		return text;
	};
};

 

AP.config.form={engine: BasicFormEngine, dialogEngine: BasicDialogEngine};

AP.form=function(id, url, engine, dialogEngine){
	if (!url){
		url='';
	}
	if (!engine){
		engine=AP.config.form.engine;
	}
	if (!dialogEngine){
		dialogEngine=AP.config.form.dialogEngine;
	}
	return new APForm(id, url, engine, dialogEngine);
};



function APForm(id, url, engine, dialogEngine){
	this._id=id;
	if (AP.word.prefix(id, "#")){
		this._id=id.substr(1);
	};
	
	this._url=url;
	this._data=[];
	this._classes=[];
	this._buttons={};
	this._title="";
	this._engine=engine;
	this._dialogEngine=dialogEngine;
	this._dialog=false;
	this._callbacks=[];
	this._css=[];
	this._handlers={};
	
	this.handler=function(event, handler){
		this._handlers[event]=handler;
		return this;
	};
	
	
	this.getHandlerInline=function(){
		var handler="";
		for (var event in this._handlers){
			handler+=" "+event+"=\""+this._handlers[event]+"\"";
		}
		return handler;
	};
	
	
	/**
	 * @desc Get data (input) of the form.
	 */
	this.getData=function(index){
		if (index==undefined){
			return this._data;
		}
		return this._data[index];
	};
	
	
	/**
	 * @desc Get all buttons
	 */
	this.getButtons=function(){
		return this._buttons;
	};
	
	
	/**
	 * @desc Get single button
	 */
	this.getButton=function(label){
		return this._buttons[label];
	};
	
	
	/**
	 * @desc Get all styles
	 */
	this.getStyles=function(){
		return this._classes;
	};
	
	
	/**
	 * @desc Get css
	 */
	this.getCss=function(){
		return this._css;
	};
	
	
	/**
	 * @desc Get form ID. Set no_hash to true (call getID(true)) if you want the ID
	 * without the hash at the begining.
	 */
	this.getID=function(no_hash){
		if (!no_hash){
			return "#"+this._id;
		}
		return this._id;
	};
	
	
	/**
	 * @desc Get form title
	 */
	this.getTitle=function(){
		return this._title;
	};
	
	
	/**
	 * @desc Get form action URL
	 */
	this.getURL=function(){
		return this._url;
	};
	


	
	/**
	 * @desc Set the engine for rendering.
	 */
	this.engine=function(engine){
		this._engine=engine;
		return this;
	};
	
	
	/**
	 * @desc Set the engine for rendering.
	 */
	this.dialogEngine=function(dialogEngine){
		this._dialogEngine=dialogEngine;
		return this;
	};
	
	/**
	 * @desc Directly inject css to .__form
	 */
	this.css=function(css){
		this._css.push(css);
		return this;
	};
	
	/**
	 * @desc Alias of adding row.
	 */
	this.row=function(type, meta){
		this._data.push({type: type, meta: meta});
		return this;
	};
	
	
	/**
	 * @desc Set form title
	 */
	this.title=function(title){
		this._title=title;
		return this;
	};
	
	
	/**
	 * @desc Add a new button form button
	 */
	this.button=function(label, fn){
		this._buttons[label]=fn;
		return this;
	};
	
	
	/**
	 * @desc Add a new class
	 */
	this.style=function(style){
		this._classes.push(style);
		return this;
	};
	
	
	
	this.val=function(name){
		return $("#"+this._id+" *[name="+name+"]").apv();
	};
	
	
	/**
	 * @desc Get the HTML representing the form [NO BUTTONS]
	 */
	this.html=function(){
		return this._engine.html(this);
	};
	
	
	
	/**
	 * @desc Show form (inline) 
	 */
	this.release=function(canvas){
		if (!this._dialog){
			this._engine.show(canvas, this);
		}else{
			this.dialog();	
		}
		
		for (var i=0; i<this._callbacks.length; i++){
			this._callbacks[i]();
		}
		return this;
	};
	
	
	/**
	 * @desc Show form in dialog
	 * @param dengine Optional. If set, it will be the dialogEngine.
	 */
	this.dialog=function(dengine){
		if (engine){
			this.dialogEngine(dengine);
		}
		var id=this.getID()+"__dialog";
		AP.dialog(id).title(this.getTitle()).show();
		this._engine.show(AP.dialog(id, this._dialogEngine).find("content"), this);
		AP.dialog(id, this._dialogEngine).balance();
		
		for (var i=0; i<this._callbacks.length; i++){
			this._callbacks[i]();
		}
		
		return this;
	};
	
	
	/**
	 * @desc Hide (close form) for dialog.
	 */
	this.hide=function(){
		AP.dialog(this.getID()+"__dialog").hide();
		return;
	};
	
	
	
	/**
	 * @desc Add callback function (after release)
	 */
	this.callback=function(fn){
		this._callbacks.push(fn);
		return this;
	};
};




var Textarea=new function __TextArea(){
	this.simple=function(str){
		if (!str){
			return "";
		}
		
		return AP.word.replaceAll("<br>","\n", str);
	};
	
	this.clean=function(_str){
		if (!_str){
			return "";
		}
		
		if (!AP.data.isString(_str)){
			return _str;
		}
		
		var str = (' '+_str).slice(1);
		
		var regex = /<br\s*[\/]?>/gi;
		str = str.replace(regex, "\n").replace(/&#8220;/g, "\"").replace(/&#8221;/g, "\"").replace(/&#8216;/g, "'").replace(/&#8217;/g, "'");
		str = str.replace(/{{@[a-zA-Z][a-zA-Z]+}}/g, function(m){
			return m.substr(2, m.length-4);
		});
		
		return str;
	};
	
	
	this.raw=function(str){
		if (!AP.data.isString(str)){
			return str;
		}
		
		var temp=this.clean(str);
		return temp.replace(/\&#126;/g, '~').replace(/\&gt;/g, '>').replace(/\&lt;/g, '<');
	};
	
	
	this.editor = function(val){
		var str = (' '+val).slice(1);
		
		str = str.replace(/{{@[a-zA-Z][a-zA-Z]+}}/g, function(m){
			return m.substr(2, m.length-4);
		});
		
		return str;
	};
};


var BasicDialogEngine=new function __BasicDialogRender(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){
		dialog.canvas().append("" +
			"<div class='xdialog __dialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='main'>" +
							"<div class='__dialogtitle'>"+"&nbsp;</div>"+
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><div class='entypo ticon-cancel'></div> </div>"+
							"<div class='__dialogcontent'></div>" +
							"<div class='__dialogbuttons xo'></div>"+
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		
		$(wid+' .__dialogwrapper').css({'top': t,'left': l});
		$(wid+' .dialogwrapper .__buttons .button:last').focus();
		
		if (window.Render){
			Render.finish();
		}
	};

};


AP.BSUCCESS='ss';
AP.BSTD='std';
AP.BERROR='er';


function initEscape(){
	$(document).keyup(function(e) {
		 if (e.keyCode == 27) { // escape key maps to keycode "27"
			 $("#apdialogs > .__dialog.__canvas_closable").each(function(){
				if ($(this).hasClass("__dialog_ontop") && !$(this).hasClass("__xesc")){
	 				AP.closeDialog($(this).find('.__dialogwrapper'));
				} 
			 });
		}
	});
};

initEscape();


AP.closeAllDialog=function(){
	$("#apdialogs > .__dialog .__dialogwrapper").each(function(){
		AP.closeDialog(this);
	});
};

AP.closeAllDialogs=AP.closeAllDialog;


AP.dialog=function(id, engine){
	if (!engine){
		var _engine = $(id).data("_engine");
		
		if (_engine){
			return new APDialog(id, _engine);	
		}
		
		engine=AP.config.dialog.engine;
	}
	
	return new APDialog(id, engine);
};

AP.dialog.get=function(ref){
	if ($(ref).closest(".__apdialog")){
		var id = $(ref).closest(".__apdialog").attr("id");
		return AP.dialog("#"+id);
	}
	
	return AP.dialog(ref);
};


AP.dialog.close=function(ref){
	return AP.closeDialog(ref);
};


AP.closeDialog=function(ref){
	if ($(ref).closest(".__dialog").hasClass("__fdialog")){
		if (AP.isset('Form')){
			var rt = Form.protection.runtime();
			if (!rt){
				return false;
			}
		}
	}
	
	var dx=$(ref).closest('.__dialog').find(".__apdialog").attr("id");
	$("#"+dx).html("").empty();
	AP.dialog("#"+dx).hide();
	
	AP.fire("dialog-close-"+dx);
	
	var $w=$(ref).closest('.__dialog');
	var events=$w.data("apevents");
	if (events && events.close){
		events.close.apply($w);
	}
};



AP.destroyDialog=function(id){
	var $dx=$("#__apdialog_"+id.substr(1));
	if (!$dx.length){
		return;
	}
	
	var events=$dx.data("apevents");
	if (events && events.close){
		events.close.apply($w);
	}
	
	if ($(id).length){
		AP.dialog(id.substr(1)).hide();
	}
	
	$dx.html("").empty();
	
	$dx.remove();
};





function APDialog(id, engine){
	this._rendered=false;
	this._temp=true;
	this._buttons={};
	this._bs={};
	this._title="Untitled";
	this._content="";
	this._classes=[];
	this._css={};
	this._data={};
	this._config={};
	this._icon=null;
	this._closable=false;
	this._close_button=true;
	
	this._engine=engine;
	if (AP.word.prefix(id,"#")){
		id=id.substr(1);
	}
	
	if (!AP.html.exist("#"+id)){
		$(document.body).append("<div id='"+id+"'></div>");
	}else{
		var title=$("#"+id).attr('title');
		if (title){
			this._title=title;
		}
	}
	
	if (engine){
		$("#"+id).data("__engine", engine);	
	}else{
		engine=$("#"+id).data("__engine");
		this._engine=engine;
	}
	
	if ($("#"+id).data("icon")){
		this._icon=$("#"+id).data("icon");
	}
	
	this._id=id;
	
	
	this.data=function(key, value){
		if (typeof value=="undefined"){
			if (key in this._data){
				return this._data[key];
			}
			return null;
		}else{
			this._data[key]=value;
			return this;
		}
	};
	
	
	this.setData=function(data){
		this._data=data;
	};
	
	this.closable=function(flag){
		this._closable=flag;
		return this;
	};
	
	this.closeButton=function(flag){
		this._close_button=flag;
		return this;
	};
	
	/**
	 * @desc Set _temp flag (flag to indicate the existance of the dialog between page transition)
	 */
	this.temp=function(flag){
		this._temp=flag;
		return this;
	};
	
	
	/**
	 * @desc Adding CSS class
	 */
	this.style=function(css_style){
		if (css_style){
			this._classes.push(css_style);
		}
		return this;
	};
	

	
	this.addClass=function(css_style){
		return this.style(css_style);
	};
	
	
	/**
	 * @desc Adding CSS class
	 */
	this.css=function(key, value){
		this._css[key]=value;
		return this;
	};
	
	this.icon=function(icon_class){
		this._icon=icon_class;
	}
	
	/**
	 * @desc Setting engine for rendering
	 */
	this.engine=function(engine){
		this._engine=engine;
		return this;
	};
	
	
	this.config=function(config){
		this._config=$.extend({}, this._config, config);
		return this;
	};
	
	
	
	/**
	 * @desc Add button
	 * @param label The text to be appeared in button
	 * @param fn Callback function 
	 * @param style [Optional] The specific style. If not defined, style will be '__default'
	 */
	this.button=function(label, fn, style){
		var counter=0;
		for (button in this._buttons){
			counter++;
		}
		if (counter==0){
			this.find("buttons").cleanUp();
		}
		var ec='__default';
		if (style){
			ec=style;
		}
		
		
		this._buttons[label]=fn;
		this._bs[label]={'style':ec,'fn':fn};
		
		
		
		if (this.initialized()){
			$("<div class='button "+ec+"'>"+label+"</div>").bind('click',{fn: fn},function(event){
				event.data.fn();
			}).appendTo(this.find("buttons"));
		}
		return this;
	};
	
	
	
	/**
	 * @desc Set title of the dialog
	 */
	this.title=function(title){
		if (title==undefined){
			title=this._title;
		}
		this._title=title;
		if (this.initialized()){
			if (this._icon){
				title="<span class='dialog-icon ap-f14 "+this._icon+"'></span>&nbsp; "+title;
			}
			this.fix('title', title);
		}
		return this;
	};
	
	
	/**
	 * @desc Set content of the dialog
	 */
	this.content=function(content){
		if (content != undefined){
			this._content=content;
		}
		
		if (this.initialized() && !AP.isEmpty(this._content)){
			$(this.id()).children().empty();
			$(this.id()).html(this._content);
		}
		
		return this;
	};
	
	
	this.append=function(id){
		$(id).appendTo($(this.id()));
		return this;
	};
	
	
	
	/**
	 * @desc Set width
	 */
	this.width=function(width){
		if (Client.native || Client.mobile){ 
			this.balance();
			return this;
		}
		
		if (AP.data.isInt(width)){
			if (Client.native || Client.mobile){ 
				$.log(width);
			}else{
				$(this.id()).css("width", width+"px");	
			}
		}else{
			$(this.id()).css("width", width);
		}
		this.balance();
		return this;
	};
	
	
	/**
	 * @desc Get the id (with # at the begining).
	 */
	this.id=function(){
		return "#"+this._id;
	};
	
	
	/**
	 * @desc Get the wrapper id.
	 * @param short Flag to mark whether we should omit the # at the begining.
	 */
	this.w=function(omit){
		if (omit){
			return "__apdialog_"+this._id;
		}
		return "#__apdialog_"+this._id;
	};
	
	
	/**
	 * @desc Return the canvas to contain all dialogs.
	 */
	this.canvas=function(){
		return this._engine.canvas();
	};
	
	
	/**
	 * @desc Check to see if the dialog is fully rendered. If yes, then future
	 * rendering will be progressive.
	 */
	this.initialized=function(){
		if (!AP.html.exist(this.id()) || !$(this.id()).hasClass('__apdialog')){
			return false;
		}
		return true;
	};
	
	
	/**
	 * @desc Render the dialog
	 */
	this.render=function(){
		if (!this.initialized()){
			this._engine.render(this);
			$(this.id()).data("config", this._config);
			$(this.id()).data("_engine", this._engine);
			$(this.id()).show().addClass('__apdialog').appendTo($(this.find('content'))).attr("title","");
			
			var classes=this._classes.join(" ");
			if (classes){
				$(this.w()).addClass(classes);
			}
			
			for (var k in this._css){
				$(this.id()).css(k, this._css[k]);
			}
			
			if (this._temp){
				$(this.w()).addClass("__temp");
			}
			$(this.w()).addClass("__dialog");
		}
		
		this._rendered=true;
		this.title();
		this.content();
		this.buttons();
		this.balance();
		
		if (this._temp){
		}else{
			var $this=this;
			AP.html.resize(function(){
				$this.balance();
			}, true);
		}
		
		
		return this;
	};
	
	
	/**
	 * @desc Setting buttons
	 */
	this.buttons=function(buttons){
		if (buttons && typeof buttons!=undefined){
			if (AP.data.isArray(buttons)){	
				for (var i=0; i<buttons.length; i++){
					if (!buttons[i].style){
						buttons[i].style='__ap_default_button';
					}
					
					this.button(buttons[i].label, buttons[i].action, buttons[i].style);
				}
			}else{
				for (var button in buttons){
					this.button(button, buttons[button],'__ap_default_button');
				}
			}
		}
		
		if (!this._rendered){
			this.find("buttons").cleanUp();
		}
		
		for (var button in this._buttons){	
			this.button(button, this._bs[button].fn, this._bs[button].style);
		}
		return this;
	};
	
	
	/**
	 * @desc Balance the dialog.
	 */
	this.balance=function(timeout){
		if (!timeout){
			this._engine.balance(this);
			// $.log(this._id); 
			// $.log(this._engine);
		}else{
			var $this=this;
			setTimeout(function(){
				$this._engine.balance($this);
			},timeout);
		}
		return this;
	};
	
	
	/**
	 * @desc Find elements of the dialog
	 */
	this.find=function(comp){
		var c=this.w()+" .__dialog"+comp;
		return $(c).first();
	};
	
	
	this.cond=function(cond, fn){
		if (cond){
			fn.apply(this);
		}
		
		return this;
	};
	
	
	/**
	 * @desc Show the dialog.
	 */
	this.show=function(){
		if (!this.initialized()){
			this.render();
		}
		
		
		$(this.canvas()).show();
		$(this.canvas()).children().each(function(){
			$(this).removeClass('__dialog_ontop');
		});
		
		$(".__ontop").removeClass("__ontop");
		$(this.w()).show().addClass('__dialog_ontop').appendTo($(this.canvas()));
		
		
		this.balance();
		
		if (AP.config.disableParentScrolling && AP.sys.isTablet()){
			$("html, body").addClass("xo");
		}else if (this._config.disableParentScrolling){
			$("html, body").addClass("xo");
		}
		
		
		if (this._closable && !$(this.w()).hasClass("__canvas_closable")){
			$(this.w()).addClass("__canvas_closable");
			$("<div class='__closable'></div>").prependTo($(this.w())).click(function(){
				var id=$(this).closest(".__dialog").find(".__apdialog");
				AP.dialog("#"+id.attr("id")).hide();
			});
		}
		return this;
	};
	
	
	this.on=function(events){
		$(this.w()).data("apevents", events);
	};
	
	
	/**
	 * @desc Hide the dialog.
	 */
	this.hide=function(){
		$(this.w()).hide();
		var config=$(this.id()).data("config");
		var counter=0;
		$(this.canvas()).children().each(function(){
			if ($(this).is(":visible")){
				counter++;
				return;
			}
		});
		if (counter==0){
			$(this.canvas()).hide();
		}
		
		if (AP.config.disableParentScrolling && AP.sys.isTablet()){
			$("html, body").removeClass("xo");
		}else if (config && config.disableParentScrolling){
			$("html, body").removeClass("xo");
		}
		
		if (AP.isset('Form')){
			Form.protection.disable();
		}
		return this;
	};
	
	
	/**
	 * @desc Hide and destroy the full dialog
	 */
	this.close = function(){
		if (AP.isset('Form')){
			var rt = Form.protection.runtime(this.w());
			if (!rt){
				return false;
			}
		}
		
		this.hide();
		AP.destroyDialog(this.id());
	};
	
	
	
	this.formatForm=function(){
		$(this.id()+' input[type=file]').selectFiles({label:"Select File"});
		$(this.id()+' textarea').disableTab();
		return this;
	};
	
	
	
	/**
	 * @desc Set flag to request re-rendering. This is not
	 * to show the dialog. 
	 */
	this.rerender=function(){
		this._rendered=false;
	};
	
	
	
	/**
	 * @desc Fix component. Key could be title or content.
	 */
	this.fix=function(key, val){
		this.find(key).html(val);
	};
};


AP.pageData={};
AP.localData={};
Client.tempData={};

AP.lc=new function __APLC(){
	
	this._check=false;
	this._enable=false;
	this.enable=function(){
		if (Client.native){
			return true;
		}
		
		if (!this._check){
			this.check=true;
			if (typeof localStorage !== "undefined" && AP.isset('localStorage')){
				localStorage.setItem('__apc', '__apc');
				if (localStorage.getItem('__apc') == '__apc'){
					this._enable=true;
					return true;
				}else{
					return false;
				}
			}
			
			return false;
		}
		
		return this._enable;
	};
	
	
	this.set=function(key, data){
		if (!this.enable()){
			return false;
		}
		
		localStorage.setItem(key, data);
	};
	
	
	this.get=function(key){
		if (!this.enable()){
			return null;
		}
		
		return localStorage.getItem(key);
	};
	
	
	this.clear=function(key){
		if (!this.enable()){
			return false;
		}
		
		return localStorage.removeItem(key);
	};
};


AP.setTempData=function(code){
	if (!Client.tempData){
		Client.tempData={};
	}
	
	for (var key in code){
		if (key == "message" || key=="code" || key=="html" || key=="__js" || key=="good" || key=="notEmpty" || key=="hasCode" || key=="hasMessage" || key=="___stats" || key=="data"){
			continue;
		}
		
		Client.tempData[key]=code[key];
	}
};




 


Client.addCache=function(data){
	for (var key in data){
		Client.cache[key]=data[key];
	}
};

Client.getCurrentCachesKey=function(){
	var ks=[];
	for (var key in Client.cache){
		ks.push(key); 
	}
	return ks;
};



Client.deleteCachesExcept=function(exs){
	var ks=Client.getCurrentCachesKey();
	for (var i=0; i<ks.length; i++){
		if (!exs){
			delete Client.cache[ks[i]];
		}else{
			if (exs.indexOf(ks[i])<0){
				delete Client.cache[ks[i]];
			}
		}
	};
};


AP.UI= new function _UI(){
	this.icon=function(icon){		
		var color="#000";
		if (icon=="doc" || icon=="docx"){
			color="#0689d5";
		}
		
		if (icon=="png" || icon=="jpg" || icon=="jpeg" || icon=="gif"){
			color="#e48a0f";
		}
		
		if (icon=="xls" || icon=="xlsx"){
			color="#5caa0f";
		}
		
		if (icon=="txt" || icon=="note"){
			color="#00c1cd";
		}
		
		if (icon=="pdf"){
			color="#dc0c12";
		}
		
		
		
		return "<span class='s32-mime-blank __mimeblank'><span class='__mimename' style='background-color: "+color+"'>"+icon+"</span></span>";
	};
	
	
	this.form=function(id, url, engine, dialogEngine){
		if (!engine){
			engine=AP.config.form.engine;
		}
		if (!dialogEngine){
			dialogEngine=AP.config.form.dialogEngine;
		}
		return new APForm(id, url, engine, dialogEngine);
	};

	
	/**
	 * @desc Generate options for year selection
	 */
	this.selectYears=function(start_year, end_year, selected_year){
		if (!selected_year){
			selected_year=0;
		}
		var text="";
		for (var i=end_year; i>start_year; i--){
			if (i==selected_year){
				text+="<option value='"+i+"' selected>"+i+"</option>";
			}else{
				text+="<option value='"+i+"'>"+i+"</option>";
			}
		}
		
		return text;
	};
	
	
	
	/**
	 * @desc Create a hashed link
	 */
	this.hash=function(){
	
		if (arguments.length==1){
			var url=arguments[0];
			if (url.indexOf('http')!=-1){
				var hash=getHash(url);
				if (hash){
					// window.location.hash="!/"+hash.join('/');
					window.location.hash="!/"+hash.join('/');
					AP._last_hash=hash.join('/');
					AP.loadURL(Client.url+'/'+hash.join('/'),{direct_load: true});
					return;
				}
			}
		}
		var path=""; 
		for (var i=0; i<arguments.length; i++){
			if (i>0){
				path=path+"/"+arguments[i];
			}else{
				path=arguments[0];
			}
		}
		// window.location.hash="!"+path;
		window.location.hash="!/"+path;
		AP._last_hash=path;
		AP.loadURL(Client.url+'/'+path,{direct_load: true});
	};
			

	/**
	 * @desc Create a regular link
	 */
	this.link=function(){
		var path="";
		for (var i=0; i<arguments.length; i++){
			path=path+"/"+arguments[i];
		}
		return "#!"+path;
	};
				
			
	/**
	 * @desc Create a time selector
	 */
	this.timeSelect = function(selector, options){
		if (!options){
			options={};
		}
		
		
		$(selector).each(function(){
			$(this).data("ts", options).addClass("__timeselect");
			if (!$(this).data('__timeselect')){
				$(this).data('__timeselect',1);
				var p=$(this).position();
				
				
//				var html='';
//				for (var i=0; i<source.length/4; i++){
//					html+="<div class='items relative'><div class='item' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i]+"</span></div><div class='item' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i+1]+"</span></div> <div class='item' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i+2]+"</span></div>  <div class='item last' onclick='AP.UI.timeSelectNow(this)'><span>"+source[4*i+3]+"</span></div></div>";	
//				}
				
				
				var val=$(this).val();
				var hh=0;
				var mm=0;
				if (val && val.length){
					var hm=getCurrentHM(this);
					hh=hm[0];
					mm=hm[1];
				}else{
					var now=options.value;
					if (!now){
						now=$(this).data("value");
					}
					
					if (!now){
						now=AP.time.now();
					}
					
					if (now){
						$(this).val(AP.time.time("%H:%i", now));
					}
					
					hh=AP.time.time("%H", now);
					mm=AP.time.time("%i", now);
				}

				
				var hhtml="<div class='-tsbox -first' data-name='hour'> <div class='-tsn -up'><span class='-ap icon-chevron-thin-up'></span></div> <div class='-tsn -down'><span class='-ap icon-chevron-thin-down'></span></div> <div class='-tslabel'><div class='-tsinput -hour'>"+(hh)+"</div></div> </div>";
				
				var msrc=range(0,59,5);
				
				var mhtml="";
				mhtml="<div class='-tsbox -second' data-name='min'>" +
						"<div class='-tsn -up'><span class='-ap icon-chevron-thin-up'></span></div>" +
						"<div class='-tsn -down'><span class='-ap icon-chevron-thin-down'></span></div>" +
						"<div class='-tslabel'><div class='-tsinput -min'>"+mm+"</div></div> " +
					"</div>";
				
				
				
				var html="<div class='-tstitle'>Select time <span class='-tsclose'><span class='-ap icon-close'></span></span></div>"+hhtml + mhtml + "<div class='-tsr'>:</div> <div class='clear'></div>";
				
				
				var pos="top: "+p.top+"px; left: "+p.left+"px'";
				if (options && options.align=='bottom'){
					pos="bottom:38px; left: "+p.left+"px'";
				}
				
				$(this).parent().addClass('__timeselectw').append("<div class='__hiddenselect' style='position:absolute; "+pos+">"+html+"</div>");
				
				
				var $canvas=$(this).parent().find('.__hiddenselect');
				$canvas.find("input").on("input focus", function(){
					$canvas.find(".-tsbox").removeClass("active");
					$(this).closest(".-tsbox").addClass("active");
				});
				
				$(this).parent().clickOut(function(){
					$(this).find('.__hiddenselect').hide();
				});
				
				$canvas.find(".-tsclose").click(function(){
					$(this).closest('.__hiddenselect').hide();
				});
				
				$canvas.find(".-tsbox").each(function(){
					$(this).on("mousewheel", function(e){
						e.stopPropagation();
						if (e.originalEvent.wheelDelta / 120 > 0){
							moveTSUp(this);
						}else{
							moveTSDown(this);
						}
					});
					
					$(this).find(".-tsn.-up").click(function(){
						moveTSUp(this);
					});
					
					$(this).find(".-tsn.-down").click(function(){
						moveTSDown(this);
					});
				});
			}
			
			// AP.UI.timeSelectFocus(this);
			
			$(this).on("input focus", function(){
				var options=$(this).data("ts");
				if (!options){
					options={};
				}
				
				if (options.align && options.align=='bottom'){
					$(this).parent().find('.__hiddenselect').css('bottom', 38).show();
				}else{
					var p=$(this).position();
					$(this).parent().find('.__hiddenselect').css('top', p.top).css('left', p.left).show();	
				}
				
				$(this).parent().find('.__hiddenselect .-first .-tslabel input').focus();
				
				// AP.UI.timeSelectFocus(this);
				
				var hm=getCurrentHM(this);
				var $box=$canvas=$(this).parent().find('.__hiddenselect');
				$box.find(".-tsinput.-hour").html(hm[0]);
				$box.find(".-tsinput.-min").html(hm[1]);
				
			}).blur(function(){
				$(this).find('.__hiddenselect').hide();

				var hm=getCurrentHM(this);
				$(this).val(hm[0] + ":" + hm[1]);
			});
			
			
		});
		
		
		
		function moveTSUp(ref){
			var type=$(ref).closest(".-tsbox").data("name");
			if (type=="hour"){
				var hour=getCurrentTS(ref, 'hour');
				hour++;
				if (hour>=24){
					hour=23;
				}
				
				setCurrentTS(ref, 'hour', hour);
			}else{
				var min=getCurrentTS(ref, 'min');
				min=min+5;
				if (min>=60){
					min=min-5;
				}
				
				setCurrentTS(ref, 'min', min);
			}
		};
		
		function moveTSDown(ref){
			var type=$(ref).closest(".-tsbox").data("name");
			if (type=="hour"){
				var hour=getCurrentTS(ref, 'hour');
				hour--;
				if (hour<0){
					hour=0;
				}
				
				setCurrentTS(ref, 'hour', hour);
			}else{
				var min=getCurrentTS(ref, 'min');
				min=min-5;
				if (min<0){
					min=min=5;
				}
				
				setCurrentTS(ref, 'min', min);
			}
		};
		
		
		function getCurrentTS(ref, type){
			var $input=$(ref).closest(".__hiddenselect").prev("input");
			if (!$input.length){
				return 0;
			}
			
			var val=$input.val();
			if (!val){
				val="00:00";
			}
			
			
			var hm=val.split(":");
			if (hm.length!=2){
				return 0;
			}
			
			if (type=='hour'){
				return parseInt(hm[0]);
			}else{
				return parseInt(hm[1]);
			}
		};
		
		
		function setCurrentTS(ref, type, val){
			var $box=$(ref).closest(".__hiddenselect");
			$box.find(".-tsinput.-"+type).html(AP.data.zeroPrefix(val));
			
			
			var hh=0;
			var mm=0;
			
			var $input=$(ref).closest(".__hiddenselect").prev("input");
			var ip="00:00";
			if (!$input.length){
			}else{
				ip=$input.val();
				if (!ip){
					ip="00:00";
				}
			}
			
			var hm=ip.split(":");
			if (hm.length!=2){
			}else{
				hh=hm[0];
				mm=hm[1];
				
				if (type=='hour'){
					hh=val;
				}else{
					mm=val;
				}
			}
			
			hh=parseInt(hh);
			mm=parseInt(mm);

			$input.val(safeNum(hh) + ":" + safeNum(mm));
		};
		
		
		function getCurrentHM(ref){
			var hh=0;
			var mm=0;
			
			var ip=$(ref).val();
			
			if (!ip || !ip.length){
				ip="00:00";
			}
			
			var hm=ip.split(":");
			if (hm.length!=2){
				
			}else{
				hh=parseInt(hm[0]);
				mm=parseInt(hm[1]);	
			}
			
			return [safeNum(hh), safeNum(mm)];
		};
		
		function  safeNum(num){
			if (AP.data.isInt(num)){
				if (parseInt(num) === 0) {
					return "00";
				}
				return AP.data.zeroPrefix(num);
			}
			
			return "00";
		};
	};

	
	
	this.timeSelectNow=function(ref){
		$(ref).addClass('chosen');
		var val=$("span", ref).html();
		var $p=$(ref).closest('.__timeselectw');
		var $input=$p.find('input.__timeselect');
		$input.val(val);
		$p.find('.__hiddenselect').fadeOut();
	};
	
	
	this.timeSelectFocus=function(selector){
		return;
		
		var val=$(selector).val();
		if (!val || !val.length){
			return;
		}
		
		var t=0;
		
		$(selector).parent().find('.__hiddenselect:first').find('.item').each(function(){
			if ($('span',this).html()==val){
				$(this).addClass('chosen');
				t=$(this).parent().position().top+$(this).closest('.__hiddenselect').scrollTop();
			}else{
				$(this).removeClass('chosen');
			}
		});
		
		if (t){
			t=t-32;
			if (t<0){
				t=0;
			}
			$(selector).parent().find('.__hiddenselect:first').animate({scrollTop: t}, 300);
		}
	};
	
			
	/**
	 * @desc Create a date selector. Require datepicker Jquery Plugin
	 */
	this.dateSelect = function(selector, format){
		if (!format){
			format=AP.locale.get("date-format-jquery","DD, MM d, yy");
		}
		
		$(selector).each(function(){
			$(this).datepicker({"dateFormat": format, firstDay: 1});
		});
	};
			
		
	
	this.stringcomplete=function(ref, url, extra_post_params){
		var $this=$(ref);
		
		$this.autocomplete({
			source: function(request, response) {
				request.__code=Client.code;
				if (extra_post_params){
					for (var key in extra_post_params){
						request[key]=extra_post_params[key];
					}
				}
				
				request.q=ap_extractCurrentString(ref),
				// console.log(request.q);
				
				$.ajax({
				  url: Client.ajax_url+"/"+url,
				  data: request,
				  dataType: "json",
				  type: "POST",
				  success: function(data){
					  response(data);
				  }
				});
			},

			search: function(){
				// custom minLength
				var term = ap_extractCurrentString(ref);
				if (term===null || (typeof term=='undefined') || term.length < 2 ) {
					return false;
				}
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				// Check for value
				var v=ap_extractInsertString(ref, ui.item.value);
				if (v && v.length>1){
					$(this).val(v);
				}
				return false;
			}
		});
	};
			
			
	/**
	 * @desc Create a jQuery autocomplete box
	 */
	this.autocomplete = function(selector, url, callback){	
		var id=ap_createAutoComplete(selector);
		var $this=$("#"+id);
		
		if (!$this.length){
			return;
		}
		
		$this.change(function(){
			if ($(this).val().length==0){
				$(selector).val('');
			}
		});
		
		var acc=$("#"+id).autocomplete({
			source: function(request, response) {
				var onAjaxStart=$this.data('onajaxstart_callback');
				var onAjaxEnd=$this.data('onajaxend_callback');
				
				request.__code=Client.code;
				request.q=ap_extractLast(request.term);
				request.time=AP.time.now();
				
				// Set more data
				if (Client.native){
					var params=M.params();
					for (var key in params){
						M.formData(request, key, params[key]);
					}
				}
				
				if (!request.q || request.q.length <2){
					return null;
				}
				
				for (var key in AP.ajax_data){
					request[key]=AP.ajax_data[key];
				}
				
				var ajax_url=Client.ajax_url+"/"+url+"/"+Client.code;
				if (AP.word.isURL(url)){
					ajax_url=url+"/"+Client.code;
				}
				
				if (onAjaxStart) onAjaxStart();
				
				$("#"+id).parent().addClass("-on-searching");
				
				$.ajax({
				  url: ajax_url,
				  data: request,
				  dataType: "json",
				  type: "POST",
				  success: function(data){
					  $("#"+id).parent().removeClass("-on-searching");
					  
					  if (!data || !AP.data.isArray(data)){
						  return;
					  }
					  
					  if (onAjaxEnd) onAjaxEnd();
					  response(data);
				  }
				});
			},

			select: function( event, ui ){		
				$(selector).val(ui.item.id);
				if (!callback && $('#'+id).data('select_callback')){
					callback=$('#'+id).data('select_callback');
				}
				if (callback){
					callback(ui.item);
				}
				
				$("#"+id).val(ui.item.name);
			}
		});
		 
		acc.data("ui-autocomplete")._renderItem = function( ul, item ){
			var label=item.value;
			if (item.label && item.label.length){
				label=item.label;
			}
			return $("<li>").data("item.autocomplete", item).append("<a>" + label + "</a>").appendTo(ul);
			
		};
		
		return acc;
	};
			
	this.autocompleteComplex = function(selector, url, callback, extra_post_params){
		var id=ap_createAutoComplete(selector, true);
		var $this=$("#"+id);
		
		$this.autocomplete({
			source: function(request, response) {
				var onAjaxStart=$this.data('onajaxstart_callback');
				var onAjaxEnd=$this.data('onajaxend_callback');
			
				request.__code=Client.code;
				if (extra_post_params){
					for (var key in extra_post_params){
						request[key]=extra_post_params[key];
					}
				}
				request.q=ap_extractLast(request.term);
				request.time=AP.time.now();
				
				if (onAjaxStart) onAjaxStart();
				
				$.ajax({
				  url: Client.ajax_url+"/"+url,
				  data: request,
				  dataType: "json",
				  type: "POST",
				  success: function(data){
					  response(data);
					  if (onAjaxEnd) onAjaxEnd();
				  }
				});
			},

			search: function() {
				// custom minLength
				var term = ap_extractLast( this.value );
				if ( term.length < 2 ) {
					return false;
				}
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ){
				// Check for value
				var results=AP.word.split(",",$(selector).val());
				if (AP.array.within(ui.item.id, results)){
					// Do nothing
					$(this).val("");
					return false;
				}
				
				results.push(ui.item.id);
				$(selector).val(results.join(","));
				$("<div class='apc-selected'> <span class='apc-text'>"+ui.item.value+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+ui.item.id+"');\">x</span></div>").insertBefore(this);
				
				$(this).val("");
				return false;
			},
			
			classes: {
				"ui-autocomplete": $(selector).data("ul-class")
			},
					
		});
		

		return $this;
	};
			
			
	/**
	 * @desc Autocomplete regularly.
	 */
	this.ac= function(selector, resource, callback, filter_fn){
		var acc=$(selector).autocomplete({source: resource, select: function(a, b){
			callback(b.item);
		}});
		
		acc.data("ui-autocomplete")._renderItem = function( ul, item ) {
			var label=item.value;
			if (item.label && item.label.length){
				label=item.label;
			}
			
			return $("<li>").data("item.autocomplete", item).append("<a>" + label + "</a>").appendTo(ul);
			
		};
		
		return acc;
	};
			
			
	/**
	 * @desc Autocomplate with multivalue
	 */
	this.acx= function(selector, sources, filter_fn){
		var id=ap_createAutoComplete(selector, true); 

		var $this=$("#"+id);
		$this.bind("keydown", function( event ) {
			if ( event.keyCode === $.ui.keyCode.TAB &&
					$( this ).data( "autocomplete" ).menu.active ) {
				event.preventDefault();
			}
		})
		.autocomplete({
			minLength: 0,
			source: function(request, response){
				// delegate back to autocomplete, but extract the last term
				response($.ui.autocomplete.filter(
					sources, ap_extractLast( request.term)));
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				// Check for value
				var results=AP.word.split(",",$(selector).val());
				if (AP.array.within(ui.item.id, results)){
					// Do nothing
					$(this).val("");
					return false;
				}
				
				results.push(ui.item.id);
				$(selector).val(results.join(","));
				
				$("<div class='apc-selected xfill'> <span class='apc-text'>"+ui.item.value+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+ui.item.id+"');\">x</span></div>").insertBefore(this);
				
				$(this).val("");
				
				return false;
			}
		});
		
		return $this;
	};
			
	
	
	
	/**
	 * @desc Autocomplate with tagcloud, multiple color
	 */
	this.tagcloud= function(selector, sources, selected){
		var id=ap_createAutoComplete(selector, true); 

		var $this=$("#"+id);
		var acc=$this.bind("keydown", function( event ) {
			if ( event.keyCode === $.ui.keyCode.TAB &&
					$( this ).data( "autocomplete" ).menu.active ) {
				event.preventDefault();
			}
		})
		.autocomplete({
			minLength: 0,
			source: function(request,response){
				// delegate back to autocomplete, but extract the last term
				response($.ui.autocomplete.filter(
					sources, ap_extractLast( request.term)));
			},
			focus: function() {
				// prevent value inserted on focus
				return false;
			},
			select: function( event, ui ) {
				// Check for value
				var results=AP.word.split(",",$(selector).val());
				if (AP.array.within(ui.item.name, results)){
					// Do nothing
					$(this).val("");
					return false;
				}
				
				results.push(ui.item.name);
				$(selector).val(results.join(","));
				
				$("<div class='apc-selected fill -bg-alt"+ui.item.color+"-less text-alt"+ui.item.color+"-less'> <span class='apc-text'>"+ui.item.name+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+ui.item.name+"');\">x</span></div>").insertBefore(this);
				
				$(this).val("");
				
				return false;
			}
		}).focus(function () {
			$(this).autocomplete('search', $(this).val())
		}).enter(function(){
			var v=$(this).val();
			if (!v.length){
				return;
			}
			
			// Check for value
			var results=AP.word.split(",",$(selector).val());
			if (AP.array.within(v, results)){
				// Do nothing
				$(this).val("");
				return false;
			}
			
			results.push(v);
			$(selector).val(results.join(","));
			
			$("<div class='apc-selected fill -bg-alt0'> <span class='apc-text'>"+v+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+v+"');\">x</span></div>").insertAfter(this);
			
			$(this).val("");
			
			return false;
		});
		
		acc.data("ui-autocomplete")._renderItem = function(ul,item) {
			return $( "<li></li>" ).data("item.autocomplete", item)
				.append( "<span class='ap-acx'><span class='ap-acx-square -bg-alt"+item.color+"'></span> "+item.name+"</span>") 
				.appendTo(ul);
		};
		
		
		if (selected && selected.length){
			$(selector).val(selected.join(","));
			
			for (var i=0; i<selected.length; i++){
				var v=selected[i];
				$("<div class='apc-selected fill -bg-alt0'> <span class='apc-text'>"+v+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+v+"');\">x</span></div>").insertBefore(selector);
			}
		}
		
		return $this;
	};
	
	
	this.acxRemoveItem= function(selector, item){
		// Check for input
		var input=$(selector).closest('.apcomplete').children("input.marked");
		$(selector).parent().remove();
		var values=AP.word.split(",",$(input).val());
		var newvals=[];
		for (var i=0; i<values.length; i++){
			if (values[i]!=item){
				newvals.push(values[i]);
			}
		}
		$(input).val(newvals.join(","));
	};
			
			
			
			
			
	/**
	 * @desc Get the meta value.
	 */
	this.displayInt= function(v){
		if (v){
			return v;
		}
		return 0;
	};
	
	
	this.copyTextToClipboard = function(text) {
		var textArea = document.createElement("textarea");

		// Place in top-left corner of screen regardless of scroll position.
		textArea.style.position = 'fixed';
		textArea.style.top = 0;
		textArea.style.left = 0;

		// Ensure it has a small width and height. Setting to 1px / 1em
		// doesn't work as this gives a negative w/h on some browsers.
		textArea.style.width = '2em';
		textArea.style.height = '2em';

		// We don't need padding, reducing the size if it does flash render.
		textArea.style.padding = 0;

		// Clean up any borders.
		textArea.style.border = 'none';
		textArea.style.outline = 'none';
		textArea.style.boxShadow = 'none';

		// Avoid flash of white box if rendered for any reason.
		textArea.style.background = 'transparent';


		textArea.value = text;

		document.body.appendChild(textArea);

		textArea.select();

		try {
			var successful = document.execCommand('copy');
			
			UI.flash("Copied to clipboard");
		} catch (err) {
			return AP.alertSuccess(text);
		}

		document.body.removeChild(textArea);
	};
};



function APComplete(obj, url, multi, callback, ref, filter_fn){
	this.$obj=$(obj);
	this.url=url;
	this.multi=multi;
	this.callback=callback;
	this.__error=false;
	
	var ul_class = '';
	ul_class = this.$obj.data("ul-class") || '';
	
	if (ref && this.$obj){
		this.$target=this.$obj.siblings('.__apc_marked_class');
		
		if (ref.data("ui-autocomplete")){
			this.ref=ref.data("ui-autocomplete").menu.element;
		}else{
			this.ref=null;
		}
	}else{
		this.__error=true;
	}
	
	
	
	this.aco=ref;
	
	this.addClass=function(classname){
		this.$target.data("ui-autocomplete").addClass(classname);
	};
	
	this.render=function(fn){
		if (this.__error){
			return this;
		}
		
		this.$target.data("ui-autocomplete")._renderItem=function(ul, item){
			if (ul_class){
				ul.addClass(ul_class);
			}
			
			return $("<li></li>")
			.data("item.autocomplete", item)
			.append("<a class='rerender ap-acitem'>"+ fn(item)+"</a>")
			.appendTo(ul);
		};
		
		return this;
	};
	
	this.renderEngine=function(fn){
		return this.render(fn);
	};
	
	this.addClass=function(classes){
		if (this.__error){
			return this;
		}
		
		this.ref.addClass(classes);
		return this;
	};
	
	this.css=function(key,val){
		this.ref.css(key,val);
		return this;
	};
	
	this.val=function(value, label){
		if (this.__error){
			return;
		}
		
		if (!this.multi){
			this.$obj.val(value);
			this.$target.val(label);
			return this;
		}else{
			var results=AP.word.split(",",this.$obj.val());
			if (AP.array.within(value, results)){
				this.$target.val("");
				return false;
			}
			results.push(value);
			this.$obj.val(results.join(","));
			$("<div class='apc-selected'> <span class='apc-text'>"+label+"</span> <span class='apc-close' onclick=\"AP.UI.acxRemoveItem(this,'"+value+"');\">x</span></div>").insertBefore(this.$target);
			this.$target.val("");
		}
	};
	
	this.select=function(callback){
		this.$target.data('select_callback', callback);
		return this;
	};
	
	this.onAjaxStart=function(callback){
		this.$target.data('onajaxstart_callback', callback);
		return this;
	};
	
	this.onAjaxEnd=function(callback){
		this.$target.data('onajaxend_callback', callback);
		return this;
	};
};



function ap_createAutoComplete(selector, multivalues){	
	var p=$(selector).parent();
	var id=AP.uuid();
	
	if (!$(p).hasClass('apcomplete')){
		$(selector).data("apcomplete_ref",id);
		
		if ($(selector).hasClass('__hinited')){
			$(selector).prev().hide();
		}
		
		$(p).css("min-height", $(selector).height());
		
		var all_classes="temp disabled __apc_marked_class";
		if (multivalues){
			all_classes="temp disabled _multivalues __apc_marked_class";
		}
		
		$(p).addClass('apcomplete');
		$(p).append("<input type='text' name='"+AP.uuid()+"' id='"+id+"' class=' "+all_classes+"' value='"+$(selector).val()+"'/>");
		
		if ($(selector).attr("title")){
			$('.temp',p).data("htext",$(selector).attr("title"));
			if (!$('.temp',p).val()){
				$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
			}
			
			$('.temp',p).blur(function(){
				if (!$('.temp',p).val() || $('.temp',p).val()=="" || $('.temp',p).val()==$('.temp',p).data("htext")){
					$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
				}
			}).focus(function(){
				if ($('.temp',p).val()==$('.temp',p).data("htext")){
					$('.temp',p).val("");
				}
				$('.temp',p).removeClass("__blur");
			});
			
			var val=$(selector).val();
			if (val=="" || val==$(selector).attr("title")){
				$(selector).val("");
			}
			
			$('.temp',p).blur();
		}else if ($(selector).data("htext")){
			$('.temp',p).data("htext",$(selector).data("htext"));
			if (!$('.temp',p).val()){
				$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
			}
			
			$('.temp',p).blur(function(){
				if (!$('.temp',p).val() || $('.temp',p).val()==""){
					$('.temp',p).val($('.temp',p).data("htext")).addClass("__blur");
				}
			}).focus(function(){
				if ($('.temp',p).val()==$('.temp',p).data("htext")){
					$('.temp',p).val("");
				}
				$('.temp',p).removeClass("__blur");
			});
			$('.temp',p).blur();
		}
		
		$(selector).hide().addClass('marked');
		
		if ($(selector).data('label') && $(selector).data('label').length){
			$('.temp',p).val($(selector).data('label'));
		}
		
		// Add focus when click on parent.
		$(p).click(function(){
			if (!$("#"+id).is(":focus")){
				$("#"+id).focus();
			}
		});
		
		var ph=$(selector).attr('placeholder');
		if (ph && ph.length){
			$("#"+id).attr('placeholder', ph);
		}
		
		return id;
	}else{
		return $("input.temp", p).attr("id");
	}
};





function ap_split( val ) {
	return val.split( /,\s*/ );
};

function ap_extractLast(term){
	return ap_split(term).pop();
};


function ap_extractCurrentString(obj){
	var term=$(obj).val();
	
	if (!term || term.length<2){
		return null;
	}
	var pos=plugin_get_caret_position(obj)-1;
	if (pos <0 || pos>term.length){
		return null;
	}
	var start=pos, end=pos;
	if (term.charAt(start)==','){
		start--;
		if (start<0){
			return null;
		}
	}
	
	while (start>=0){
		if (term.charAt(start)==','){
			start++;
			break;
		}
		start--;
		if (start==0){
			break;
		}
	}
	
	while (end<term.length){
		if (term.charAt(end)==','){
			break;
		}
		end++;
		if (end>=term.length){
			break;
		}
	}

	if (end-start<1){
		return;
	}
	
	var r=$.trim(term.substring(start, end));
	if (!r.length || r.length<1){
		return null;
	}
	return r;
};



function ap_extractInsertString(obj, insert){
	var term=$(obj).val();
	
	if (!term || term.length<1){
		return null;
	}
	var pos=plugin_get_caret_position(obj)-1;
	if (pos <0 || pos>term.length){
		return null;
	}
	var start=pos, end=pos;
	if (term.charAt(start)==','){
		start--;
		if (start<0){
			return null;
		}
	}
	
	while (start>=0){
		if (term.charAt(start)==','){
			start++;
			break;
		}
		start--;
		if (start==0){
			break;
		}
	}
	
	while (end<term.length){
		if (term.charAt(end)==','){
			break;
		}
		end++;
		if (end>=term.length){
			break;
		}
	}

	if (end-start<1){
		return;
	}
	
	var s_end="";
	if (end+1<term.length){
		term.substring(end+1)
	}
	
	var r=$.trim(term.substring(0, start)+' '+insert+', '+s_end);
	return r;
};



function ap_getTimeOptions(){ 
	var hours=["00","01","02","03","04","05","06","07","08","09","10","11","12","13","14","15","16","17","18","19","20","21","22","23"];
	var mins=["00","15","30","45"];
	var a=[];
	for (var i=0; i<hours.length; i++){
		for (var j=0; j<mins.length; j++){
			a.push(hours[i]+":"+mins[j]);
		}
	}
	return a;
};


















'use strict';

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

function Sektor(selector, options) {
  this.element = $(selector)[0];

  var defaultOptions = {
	size: 100,
	stroke: 10,
	arc: false,
	angle: 225,
	sectorColor: '#789',
	circleColor: '#DDD',
	fillCircle: true
  };

  // Merge options with default ones
  options = _extends(defaultOptions, options);

  // Reset stroke to 0 if drawing full sector
  options.stroke = options.arc ? options.stroke : 0;

  // Circle dimenstions
  options.center = options.size / 2;
  options.radius = options.stroke ? options.center - options.stroke / 2 : options.center;

  this.options = options;

  this.checkAngle();

  var svg = '<svg class=\'Sektor\' viewBox=\'0 0 ' + options.size + ' ' + options.size + '\'>\n	  ' + this.getCircle() + '\n	  ' + this.getSector() + '\n	</svg>';

  this.element.innerHTML = svg;
  this.sector = this.element.querySelector('.Sektor-sector');
}

Sektor.prototype.checkAngle = function () {
  if (this.options.angle > 360) {
	this.options.angle = this.options.angle % 360;
  }
};

Sektor.prototype.changeAngle = function (angle) {
  this.options.angle = angle;
  this.checkAngle();
  this.sector.setAttribute('d', this.getSector(true));
};

Sektor.prototype.step = function (angleOffset, endAngle, time, endTime) {
  var _this = this;

  var now = new Date().valueOf();
  var timeOffset = endTime - now;

  if (timeOffset <= 0) {
	this.changeAngle(endAngle);
  } else {
	var angle = endAngle - angleOffset * timeOffset / time;

	this.changeAngle(angle);
	requestAnimationFrame(function () {
	  return _this.step(angleOffset, endAngle, time, endTime);
	});
  }
};

Sektor.prototype.animateTo = function (angle) {
  var _this2 = this;

  var time = arguments.length <= 1 || arguments[1] === undefined ? 300 : arguments[1];

  if (angle > 360) {
	angle = angle % 360;
  }

  var startTime = new Date().valueOf();
  var endTime = startTime + time;
  var angleOffset = angle - this.options.angle;

  requestAnimationFrame(function () {
	return _this2.step(angleOffset, angle, time, endTime);
  });
};

Sektor.prototype.getSector = function () {
  var returnD = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];

  var options = this.options;

  // Colors
  var sectorFill = options.arc ? 'none' : options.sectorColor;
  var sectorStroke = options.arc ? options.sectorColor : 'none';

  // Arc angles
  var firstAngle = options.angle > 180 ? 90 : options.angle - 90;
  var secondAngle = -270 + options.angle - 180;

  // Arcs
  var firstArc = this.getArc(firstAngle, options);
  var secondArc = options.angle > 180 ? this.getArc(secondAngle, options) : '';

  // start -> starting line
  // end -> will path be closed or not
  var end = '';
  var start = null;

  if (options.arc) {
	start = 'M' + options.center + ',' + options.stroke / 2;
  } else {
	start = 'M' + options.center + ',' + options.center + ' L' + options.center + ',' + options.stroke / 2;
	end = 'z';
  }

  var d = start + ' ' + firstArc + ' ' + secondArc + ' ' + end;

  if (returnD) {
	return d;
  }

  return '<path\n	class=\'Sektor-sector\'\n	stroke-width=\'' + options.stroke + '\'\n	fill=' + sectorFill + '\n	stroke=' + sectorStroke + '\n	d=\'' + d + '\' />';
};

Sektor.prototype.getCircle = function () {
  var options = this.options;
  var circleFill = options.fillCircle || !options.arc ? options.circleColor : 'none';

  return '<circle\n	  class=\'Sektor-circle\'\n	  stroke-width=\'' + options.stroke + '\'\n	  fill=' + circleFill + '\n	  stroke=' + options.circleColor + '\n	  cx=\'' + options.center + '\'\n	  cy=\'' + options.center + '\'\n	  r=\'' + options.radius + '\' />';
};

// Generates SVG arc string
Sektor.prototype.getArc = function (angle) {
  var options = this.options;

  var x = options.center + options.radius * Math.cos(this.radians(angle));
  var y = options.center + options.radius * Math.sin(this.radians(angle));

  return 'A' + options.radius + ',' + options.radius + ' 1 0 1 ' + x + ',' + y;
};

// Converts from degrees to radians.
Sektor.prototype.radians = function (degrees) {
  return degrees / 180 * Math.PI;
};


AP.scrollBar=function __APScrollBar(selector){
	return new APScrollBar($(selector));
};


function APScrollBar($obj){
	this.$obj=$obj;
	
	this.init=function(temp){
		temp=false;
		if (temp){
			temp=true;
		}
		
		
		if (AP.sys.isTablet() || AP.sys.isMobile() || AP.__printing || Client.mobile){
			$obj.addClass("__mscroll");
			return this;
		}
		
		
		if (this.$obj.hasClass('__apscrollbar_target')){
			plugin_scrollbar_onscroll(this.$obj);
			return this;
		}
		
		var id=this.$obj.attr('id');
		if (!id){
			id=AP.uuid();
			this.$obj.attr('id', id);
		}
		
		this.$obj.addClass('__apscrollbar_target');
		if (this.$obj.parent().data('autoscroll')){
			this.$obj.addClass('__scrolled');
		}
		
		
		if (this.$obj.parent().hasClass('__apscrollbar_parent')){
			return this;
		}
		
		this.$obj.parent().addClass('__apscrollbar_parent');
		
		
		if (this.$obj.parent().data("autohide")){
			this.$obj.parent().addClass("__autohide");
			this.$obj.wrapInner("<div class='__apscrollbar_wrap __autohide' style='padding-right:0px'></div>");
		}else{
			this.$obj.addClass("__regular").wrapInner("<div class='__apscrollbar_wrap'></div>");	
		}
		
		$("<div id='"+id+"__apscrollbar' class='__apscrollbar'> <div class='scroller'>" +
					"<div class='sinner'></div> "+
				"</div> </div>").appendTo(this.$obj.parent());

		
		$("#"+id+"__apscrollbar .scroller").draggable({
			axis:"y",
			start: function(){
				$("#"+id).addClass('__scrollprevented');
			},
			drag: function(){
				plugin_scrollbar_update($(this));
			},
			stop: function(){
				plugin_scrollbar_update($(this));
				$("#"+id).removeClass('__scrollprevented');
			},
			containment: "parent"
		});
		
		
		this.$obj.on("scroll", function(){
			if ($(this).hasClass('__scrollprevented')){
				// $(this).removeClass('__scrollprevented')
				return;
			}

			return plugin_scrollbar_onscroll($(this));			
		});
		
		plugin_scrollbar_update($('#'+id+'__apscrollbar .scroller'));
		
		setTimeout(function(){
			plugin_scrollbar_update($('#'+id+'__apscrollbar .scroller'));
		},1000);
		
		setTimeout(function(){
			plugin_scrollbar_update($('#'+id+'__apscrollbar .scroller'));
		},5000);
		
		return this;
	};
	
	
	/**
	 * @desc ScrollTo a specific pixel height
	 */
	this.scrollTo=function(num){
		// var h=this.$obj.height();
		// var maxh=this.$target[0].scrollHeight;
		
		this.$obj.scrollTop(num);
	};
	
	
	this.update=function(){
		if (AP.sys.isTablet() || AP.sys.isMobile() || AP.__printing || Client.mobile){
			return this;
		}
		
		plugin_scrollbar_update($("#"+this.$obj.attr('id')+"__apscrollbar .scroller"));
		return this;
	};
};



function plugin_scrollbar_update($obj){
	var offset=$obj.position();
	
	var $scroller=$obj.parent();	
	var $scroller_rec=$obj;
	
	var $target=$scroller.prevAll('.__apscrollbar_target');
	if (!$target || !$target.length){
		return;
	}
	
	var h=$target.height();
	var maxh=$target[0].scrollHeight;
	
	var auto=$obj.closest('.__apscrollbar_parent').data('autoscroll');
	
	
	if (maxh<=h){
		if (!auto){
			$scroller.hide();
			$target.scrollTop(0);
			$target.scrollLeft(0);
			$target.removeClass('__scrolled');
			$scroller.hide();
			return;	
		}else{
			$scroller_rec.hide();
			$target.addClass('__scrolled');
			return;
		}
	}
	
	$scroller.show();
	$scroller_rec.show();
	
	if (maxh<10 || h<10){
		/**
		 * @todo Finish this weird case 
		 */
		return;
	}
	
	var sh=$scroller.height();
	
	if (sh<=$obj.height()){
		$target.scrollTop(maxh-h);
		return;
	}
	
	var scale=$scroller.parent().data("scale");
	if (!scale){
		scale=1.0;
	}else{
		scale=parseFloat(scale);
	}
	
	scale=1.0;
	
	var ttop=(maxh-h)*offset.top*1.0/(sh-$obj.height());
	ttop=Math.floor(ttop);
	
	$target.scrollTop(ttop);
	$target.scrollLeft(0);
};



function plugin_scrollbar_onscroll($obj){
	var alwayshown=$obj.parent().data('autoscroll');
	var autohide=$obj.parent().data('autohide');
	
	if (!$obj.is(':visible')){
		return;
	}
	
	// $obj.scrollLeft(0);
	// return;
	
	var t=$obj.scrollTop();
	var h=$obj.height();
	
	if (!('scrollHeight' in $obj[0])){
		return;
	}
	
	
	
	var maxh=$obj[0].scrollHeight;
	var $scroller=$("#"+$obj.attr('id')+"__apscrollbar");
	
	if (maxh<h || maxh<10){
		if (!alwayshown){
			$obj.removeClass('__scrolled');
			$scroller.hide();	
		}
		return;
	}
	
	
	if (maxh==h){
		if (!alwayshown){
			$obj.removeClass('__scrolled');
			$scroller.hide();	
		}
		return;
	}
	
	
	if (!$obj.hasClass('__scrolled')){
		$obj.addClass('__scrolled');
	}
	
	
	$scroller.show();
	
	if (h<0){
		return;
	}
	
	
	
	var sh=$scroller.height();
	var scale=$scroller.parent().data("scale");
	
	if (!scale || typeof scale=="undefined"){
		scale=1.0;
	}else{
		scale=parseFloat(scale);
	}
	
	var scroller={}; 
	scroller.height=Math.floor((h*1.0/maxh)*(h*1.0/maxh) *sh)*scale;
	if (autohide){
		scroller.height=Math.floor((h*1.0/maxh)*sh)*scale;
	}
	
	if (scroller.height<50){
		scroller.height=50;
	}
	
	scroller.top=Math.floor(Math.min(t*1.0/(maxh-h), 1) * (sh-scroller.height));

	
	$scroller.children('.scroller').css({'top': scroller.top, 'height': scroller.height}).addClass('active').show();
	$scroller.find('.sinner').css('height',scroller.height-1);
};


AP.pageConfig=new function __APPageConfig(){
	this.data={};
	this.__data={};
	
	this.init=function(data){
		this.__data=shallowClone(data);
		this.data=data;
	};
	
	this.reset=function(){
		this.data=shallowClone(this.__data);
		if (!this.data){
			this.data={};
		}
	};
	
	this.set=function(key, val){
		if (typeof val=="undefined"){
			val=1;
		}
		
		this.data[key]=val;
	};
	
	this.get=function(key){
		if (key in this.data){
			return this.data[key];
		}
		
		return null;
	};
	
	
	this.test=function(){
		$.log(this.data);
		$.log(this.__data);
	}
};



var APViewer = new function _APViewer(){
	this.auth=function(){
		if (Client.viewer && Client.viewer.id && Client.viewer.id>0){
			return true;
		}
		return false;
	};
};
var MarkDown=new function __MarkDown(){
	this.render=function(element, options){
		options=$.extend({}, {math: false, code: true, toc: false, footnote: true}, options);
		$canvas=$(element);
		$canvas.addClass("md-display");
		
		if (options.math){
			$canvas.find(".md-imath").each(function(){
				katex.render($(this).text(), $(this)[0]);
			});
			
			$canvas.find(".md-math").each(function(){
				katex.render($(this).text(), $(this)[0], {displayMode: true});
			});
		}
		
		if (options.code){
			$canvas.find(".md-code").each(function(){
				$(this).showCode();
			});
			
			$canvas.find(".md-rawcode").each(function(){
				$(this).wrapInner("<pre class='md-raw'></pre>");
			});
			
			if (options.code && AP.data.isString(options.code)){
				$canvas.find(options.code).each(function(){
					$(this).addClass("md-code __codehl").showCode();
				});
			}
		}
		
		
		$canvas.find(".md-note-icon").each(function(){
			var h=parseInt($(this).height());
			var w=parseInt($(this).width());
			$(this).css("margin-top", -h/2);
			$(this).prev().css("margin-left", w+h/2);
		});
		
		$canvas.children().each(function(){
			$(this).addClass("md-line");
		})
		
		// Internal and footnote link
		$canvas.find(".md-doc-link, .md-fn-link").each(function(){
			var label=$(this).data("ref");
			
			if ($(this).hasClass("md-doc-link")){
				$(this).prepend("<span class='-ap icon-forward2'></span> ");
			}
			
			$(this).click(function(){
				var $box=$("#label-"+label);
				if (!$box.length){
					return;
				}
				
				var $p=$box.closest('.scrollin');
				var h=$box.closest(".md-line").position().top;
				var offset=$p.scrollTop();
				
				$p.animate({scrollTop: offset+h-20}, 300, function(){
					$box.animate({backgroundColor: "#FFFEDB"}, 1000).animate({backgroundColor: 'transparent'}, 1000);
				});
			});
		});
		
		
		
		// Table of content
		if (options.toc){
			
		}
	};
	
	
	this.textarea=function(){
		
	};
	
	
};


(function($){
	$.fn.markdownEditor=function(lh){
		if (!lh){
			 lh=22;
		}
		
		$(this).disableTab();
		$(this).css("line-height",lh+"px").css("overflow-y", "hidden");
		
		
		$(this).data("minh", $(this)[0].scrollHeight).on("keyup, keypress", function(e){
			var $this=$(this);
			var minh=$this.data("minh");
			
			$this.height(Math.max($this[0].scrollHeight, minh));
			
//			var minh=$this.data("minh");
//			var outerHeight = parseInt(window.getComputedStyle($this[0]).height, 10);
//			var diff = outerHeight - $this[0].clientHeight;
//			$this.height(0).height(Math.max(minh, $this[0].scrollHeight+diff));
			
//			var $this=$(this);
//			$this.height(0).height($this[0].scrollHeight);
		}).keypress();
		
		// Remove tab characters
		 var content=$(this).val();
		 if (content){
			 content=content.replace(/\t/g, '	');
			 $(this).val(content);
		}
	};
	
	
	$.fn.materialForm=function(){
		$(this).find("input, textarea").each(function(){
			$(this).on("focus",function(){
				$(this).parent().parent().addClass("active");
			}).on("blur", function(){
				var val=$.trim($(this).val());
				if (val){
					$(this).parent().parent().addClass("active");
				}else{
					$(this).parent().parent().removeClass("active");
				}
			}).blur();
		});
	};
	
	
})(jQuery);
 
 /* IE doesn't understand indexOf() on arrays, so add it */
if (!Array.prototype.indexOf) {
		Array.prototype.indexOf = function(val) {
				var len = this.length;
				for (var i = 0; i < len; i++) {
						if (this[i] == val) return i;
				}
				return -1;
		};
};

var SyntaxHighlighter = {};

SyntaxHighlighter.language = {};

SyntaxHighlighter.xmlEntities = {
		"&" : "&amp;",
		"<" : "&lt;",
		">" : "&gt;",
		"\"" : "&quot;",
		"'" : "&#39;"
	};

SyntaxHighlighter.strToXHTML = function(str)
{
	var addLen = 0;
	
	for (var key in SyntaxHighlighter.xmlEntities)
	{
		str = str.replace(new RegExp(key, "g"),
			function(match, offset, s)
			{
				addLen += (SyntaxHighlighter.xmlEntities[key].length - 1);
				return SyntaxHighlighter.xmlEntities[key];
			}
		);
	}
	return {
		"str" : str,
		"addLen" : addLen
	};
};

SyntaxHighlighter.copyObject = function(ob){
	var newOb = {};
	for (var prop in ob) {
		newOb[prop] = ob[prop];
	}
	return newOb;
};

SyntaxHighlighter.highlightDocument = function(selector, showLineNumbers){
	var codeList = $(selector).get();
	for (var i = 0, len = codeList.length; i < len; i++){
		if (codeList[i].className && SyntaxHighlighter.language[codeList[i].className]){
			SyntaxHighlighter.highlight(codeList[i], showLineNumbers);
		}
	}
};

SyntaxHighlighter.highlight = function(codeEl, showLineNumbers){
	if (!codeEl){
		return;
	}
	var lang = SyntaxHighlighter.language[codeEl.className];
	if (!lang){
		return;
	}

	var span_comment_len = "<span class='comment'></span>".length;
	var span_quote_len = "<span class='quote'></span>".length;
	var span_operator_len = "<span class='operator'></span>".length;
	var span_keyword_len = "<span class='keyword'></span>".length;
	
	// Met \n of \r\n als regelbreak
	// data rewrites HTML entities to real characters
	codeEl.normalize();
	
	var lines = [];
	
	// Als er na de normalize nog meerder childNodes zijn, dan ga ik ervan uit dat men als linebreak <br> heeft
	// en NIET \n of \r.
	if (codeEl.childNodes.length > 1){
		// Met BR als regelbreak
		// Je mag alleen een lege lijn toevoegen bij de 2e keer achter elkaar geen data (dus <br><br> in de code).
		var hasBr = false;
		for (var i = 0; i < codeEl.childNodes.length; i++)
		{		
			if (!codeEl.childNodes[i].data)
			{
				if (hasBr)
				{
					lines.push("");
					hasBr = false;
				}
				else
				{
					hasBr = true;
				}
			}
			else
			{
				lines.push(codeEl.childNodes[i].data);
				hasBr = false;
			}
		}
	}
	else{
		// Er worden blijkbaar \n en \r als linebreak gebruikt.
		if (codeEl.firstChild){
			var str = codeEl.firstChild.data;
			lines = (str.indexOf("\n") != -1) ? str.split("\n") : str.split("\r");	
		}
	}
	
	var beginMultiCommentIndex = -1;
	
	forLineLoop:
	for (var lineIndex = 0, lineCount = lines.length; lineIndex < lineCount; lineIndex++)
	{
		var line = lines[lineIndex];
		var prop = {};
		
		forCharLoop:
		for (var charIndex = 0, lineLen = line.length; charIndex < lineLen; charIndex++)
		{
			var c = line.charAt(charIndex);
			
			// End multiline comment
			if (beginMultiCommentIndex != -1)
			{
				var endMultiCommentIndex = -1;
				for (; charIndex < lineLen; charIndex++)
				{
					c = line.charAt(charIndex);
					if (c == "\\")
					{
						charIndex++;
						continue;
					}
					if (c == lang.comment.multi.end.charAt(0))
					{
						endMultiCommentIndex = charIndex;
						for (var i = 0; i < lang.comment.multi.end.length; i++)
						{
							if (line.charAt(charIndex + i) != lang.comment.multi.end.charAt(i))
							{
								endMultiCommentIndex = -1;
								break;
							}
						}
						if (endMultiCommentIndex != -1)
						{
							charIndex += (lang.comment.multi.end.length - 1);
							endMultiCommentIndex = charIndex;
							break;
						}
					}
				}
				var realEndIndex = (endMultiCommentIndex != -1) ? endMultiCommentIndex : lineLen - 1;
				//var addLen = "<span class='comment'></span>".length;
				var substrOb = SyntaxHighlighter.strToXHTML(line.substr(beginMultiCommentIndex, realEndIndex - beginMultiCommentIndex + 1));
				line = line.substr(0, beginMultiCommentIndex) + "<span class='comment'>" + substrOb.str + "</span>" + line.substr(realEndIndex + 1);
				charIndex += (span_comment_len + substrOb.addLen);
				lineLen += (span_comment_len + substrOb.addLen);
				prop[beginMultiCommentIndex] = span_comment_len + substrOb.str.length;
				beginMultiCommentIndex = (endMultiCommentIndex != -1) ? -1 : 0;
				continue forCharLoop;
			}
			
			// Begin multiline comment
			if (lang.comment.multi && c == lang.comment.multi.start.charAt(0))
			{
				beginMultiCommentIndex = charIndex;
				for (var i = 0; i < lang.comment.multi.start.length; i++)
				{
					if (line.charAt(charIndex + i) != lang.comment.multi.start.charAt(i))
					{
						beginMultiCommentIndex = -1;
						break;
					}
				}
				if (beginMultiCommentIndex != -1)
				{
					charIndex += lang.comment.multi.start.length - 1;
					if (charIndex == lineLen - 1)
					{
						charIndex--;
					}
					continue forCharLoop;
				}
			}
			
			// Single comment
			if (lang.comment.single && c == lang.comment.single.start.charAt(0))
			{
				var beginSingleCommentIndex = charIndex;
				// Eventueel het begin van een single comment
				for (var i = 0; i < lang.comment.single.start.length; i++)
				{
					if (line.charAt(charIndex + i) != lang.comment.single.start.charAt(i))
					{
						beginSingleCommentIndex = -1;
						break;
					}
				}
				if (beginSingleCommentIndex != -1)
				{
					// Alles totaan einde van de regel is comment
					var substrOb = SyntaxHighlighter.strToXHTML(line.substr(beginSingleCommentIndex));
					//var addLen = "<span class='comment'></span>".length;
					line = line.substr(0, beginSingleCommentIndex) + "<span class='comment'>" + substrOb.str + "</span>";
					charIndex = line.length - 1;
					prop[beginSingleCommentIndex] = span_comment_len + substrOb.str.length;
					continue forCharLoop;
				}
			}
			
			// Quotes
			if (c == "\"" || c == "'")
			{
				var quote = c;
				var beginQuoteIndex = charIndex;
				// Hier doorgaan naar einde quote
				for (charIndex += 1; charIndex < lineLen; charIndex++)
				{
					c = line.charAt(charIndex);
					if (c == "\\")
					{
						charIndex++;
						continue;
					}
					if (c == quote)
					{
						// Einde
						var substrOb = SyntaxHighlighter.strToXHTML(line.substr(beginQuoteIndex, charIndex - beginQuoteIndex + 1));
						//var addLen = "<span class='quote'></span>".length;
						line = line.substr(0, beginQuoteIndex) + "<span class='quote'>" + substrOb.str + "</span>" + line.substr(charIndex + 1);
						prop[beginQuoteIndex] = span_quote_len + substrOb.str.length;
						charIndex += (span_quote_len + substrOb.addLen);
						lineLen += (span_quote_len + substrOb.addLen);
						continue forCharLoop;
					}
				}
			}
			
			// Operators
			if (lang.operator.indexOf(c) != -1)
			{
				c = (SyntaxHighlighter.xmlEntities[c]) ? SyntaxHighlighter.xmlEntities[c] : c;
				//var addLen = "<span class='operator'></span>".length + (c.length - 1);
				var addLen = span_operator_len + (c.length - 1);
				line = line.substr(0, charIndex) + "<span class='operator'>" + c + "</span>" + line.substr(charIndex + 1);
				prop[charIndex] = addLen + c.length;
				charIndex += addLen;
				lineLen += addLen;
				continue forCharLoop;
			}
		}
		
		// Keywords - not for each char, but each line
		for (var i = 0; i < lang.keyword.length; i++)
		{
			var keyword = lang.keyword[i];
			var keywordIndex = line.indexOf(keyword);
			while (keywordIndex != -1)
			{
				if (/\w/.test(line.charAt(keywordIndex - 1)) || /\w/.test(line.charAt(keywordIndex + keyword.length))) {
					keywordIndex = line.indexOf(keyword, keywordIndex + 1);
					continue;
				}
				
				var isKeyword = true;
				for (var key in prop) {
					if (keywordIndex >= parseInt(key) && keywordIndex < (parseInt(key) + parseInt(prop[key]))) {
						isKeyword = false;
						break;
					}
				}
				if (isKeyword) {
					//var addString = "<span class='keyword'></span>";
					//var addLen = addString.length; // dit is erbij gekomen
					//var addLen = span_keyword_len;
					line = line.substr(0, keywordIndex) + "<span class='keyword'>" + keyword + "</span>" + line.substr(keywordIndex + keyword.length);
					prop[keywordIndex] = keyword.length + span_keyword_len;
					var tmpOb = new Object();
					for (var key in prop) {
						if (parseInt(key) > keywordIndex) {
							var newIndex = parseInt(key) + span_keyword_len;
							tmpOb[newIndex] = prop[key];
						} else {
							tmpOb[key] = prop[key];
						}
					}
					prop = SyntaxHighlighter.copyObject(tmpOb);
					keywordIndex = line.indexOf(keyword, keywordIndex + span_keyword_len + keyword.length);
				} else {
					keywordIndex = line.indexOf(keyword, keywordIndex + 1);
				}
				
			}
		}
		
		//line.prop = prop;
		lines[lineIndex] = line;
	}
	
	// Print the lines
	var joinString = "";
	var showLineNumbersThisTime = showLineNumbers;
	var newLines = null;
	
	if (codeEl.parentNode.nodeName.toLowerCase() != "pre")
	{
		showLineNumbersThisTime = false;
	}
	
	if (showLineNumbersThisTime)
	{
		newLines = ["<ol>"];
		for (var i = 0; i < lineCount; i++) {
			newLines.push("<li><span>" + lines[i] + "</span></li>");
		}
		newLines.push("</ol>");
	}
	else
	{
		newLines = lines;
		if (codeEl.parentNode.nodeName.toLowerCase() == "pre")
		{
			joinString = "<br />";
		}
	}
	
	// appname check is necessary, because chrome knows also outerHTML!
	
	if (codeEl.parentNode.nodeName.toLowerCase() == "pre" && navigator.appName == "Microsoft Internet Explorer") {
		codeEl.parentNode.outerHTML = "<pre><code class='" + codeEl.className + "'>" + newLines.join(joinString) + "</code></pre>";
	} else {
		codeEl.innerHTML = newLines.join(joinString);
	}
	
	codeEl.className = codeEl.className + " highlighted";
};


SyntaxHighlighter.language.c = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"auto", "break", "case", "char", "const", "continue", "default", "do", "double", "else", "enum", "extern", "float", "for", "goto", "if", "int", "long", "register", "return", "short", "signed", "sizeof", "static", "struct", "switch", "typedef", "union", "unsigned", "void", "volatile", "wchar_t", "while"
	],
	"operator" : [
		"=", "(", ")", "{", "}", "*", "+", "-", "<", ">", "&", "|", "!", "?", "^", "/", ":", "~", "%", "[", "]"
	]
};


SyntaxHighlighter.language.csharp = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"#if", "#else", "#endif", "abstract", "as", "base", "bool", "break", "byte", "case", "catch", "char", "checked", "class", "const", "continue", "decimal", "default", "delegate", "do", "double", "else", "enum", "event", "explicit", "extern", "false", "finally", "fixed", "float", "for", "foreach", "goto", "get", "if", "implicit", "in", "int", "interface", "internal", "is", "locak", "long", "namespace", "new", "null", "object", "operator", "out", "override", "params", "partial", "private", "protected", "public", "readonly", "ref", "return", "sbyte", "sealed", "set", "short", "sizeof", "stackalloc", "static", "string", "struct", "switch", "this", "throw", "true", "try", "typeof", "uint", "ulong", "unchecked", "unsafe", "ushort", "using", "value", "virtual", "volatile", "void", "where", "while", "yield"
	],
	"operator" : [
		".", ",", "=", "(", ")", "{", "}", ";", "+", "-", "<", ">", "&", "|", "!", "?", "[", "]", "/", "%", "^", ":", "~"
	]
};


SyntaxHighlighter.language.js = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"arguments", "Array", "Boolean", "break", "case", "catch", "continue", "Date", "do", "each", "else", "Error", "false", "for", "Function", "function", "if", "Infinity", "Math", "NaN", "new", "null", "Number", "Object", "RegExp", "return", "String", "switch", "this", "throw", "true", "try", "undefined", "var", "while"
	],
	"operator" : [
		"=", "(", ")", "{", "}", "+", "-", "!", "?", "<", ">", ";", ".", "[", "]", "&"
	]
};


SyntaxHighlighter.language.sql = {
	"comment" : {
		"multi" : {
			"start" : "<!--",
			"end" : "-->"
		}
	},
	"keyword" : [
		"add", "alter", "and", "as", "column", "create", "database", "delete", "describe", "distinct", "do", "drop", "explain", "from", "group by", "handler", "index", "insert", "into", "left join", "limit", "on", "optimize", "order by", "rename", "replace", "select", "set", "show", "table", "update", "use", "where"
	],
	"operator" : [
		"<", ">", "=", "(", ")", "*", ";", "!", ","
	]
};

SyntaxHighlighter.language.php = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"abstract", "array", "as", "bool", "boolean", "break", "case", "catch", "class", "clone", "const", "continue", "declare", "default", "define", "do", "echo", "else", "elseif", "empty", "exit", "extends", "final", "for", "foreach", "function", "if", "implements", "include", "include_once", "int", "interface", "isset", "list", "new", "null", "object", "print", "private", "protected", "public", "php","require", "require_once", "return", "static", "string", "switch", "throw", "try", "unset", "while"
	],
	"operator" : [
		"=", "(", ")", "{", "}", "+", "-", "!", "?", "<", ">", "&", ";", ".", "[", "]", "%"
	]
};


SyntaxHighlighter.language.python = {
	"comment" : {
		"single" : {
			"start" : "#"
		},
		"multi" : {
			"start" : "\"\"\"",
			"end" : "\"\"\""
		}
	},
	"keyword" : [
		"and", "as", "assert", "break", "class", "continue", "def", "del", "elif", "else", "except", "exec", "False", "finally", "for", "from", "global", "if", "import", "in", "is", "lambda", "None", "not", "or", "pass", "print", "raise", "return", "True", "try", "while", "with", "yield"
	],
	"operator" : [
		"=", "(", ")", "{", "}", ":", "+", "-", "!", "<", ">", ";", ".", "%", "/", "[", "]", "|", "^", "~", "&", "@", "*"
	]
};


SyntaxHighlighter.language.vb = {
	"comment" : {
		"single" : {
			"start" : "'"
		}
	},
	"keyword" : [
		"AddHandler", "AddressOf", "Alias", "And", "AndAlso", "As", "Boolean", "ByRef", "Byte", "ByVal", "Call", "Case", "Catch", "CBool", "CByte", "CChar", "CDate", "CDec", "CDbl", "Char", "CInt", "Class", "CLng", "CObj", "Const", "Continue", "CSByte", "CShort", "CSng", "CStr", "CType", "CUInt", "CULong", "CUShort", "Date", "Decimal", "Declare", "Default", "Delegate", "Dim", "DirectCast", "Do", "Double", "Each", "Else", "ElseIf", "End", "Enum", "Erase", "Error", "Event", "Exit", "False", "Finally", "For", "Friend", "Function", "Get", "GetType", "Global", "GoTo", "Handles", "If", "Implements", "Imports", "In", "Inherits", "Integer", "Interface", "Is", "IsNot", "Lib", "Like", "Long", "Loop", "Me", "Mod", "Module", "MustInherit", "MustOverride", "MyBase", "MyClass", "Namespace", "Narrowing", "New", "Next", "Not", "Nothing", "NotInheritable", "NotOverridable", "Object", "Of", "On", "Operator", "Option", "Optional", "Or", "OrElse", "Overloads", "Overridable", "Overrides", "ParamArray", "Partial", "Private", "Property", "Protected", "Public", "RaiseEvent", "ReadOnly", "ReDim", "REM", "RemoveHandler", "Resume", "Return", "SByte", "Select", "Set", "Shadows", "Shared", "Short", "Single", "Static", "Step", "Stop", "String", "Structure", "Sub", "SyncLock", "Then", "Throw", "To", "True", "Try", "TryCast", "TypeOf", "UInteger", "ULong", "Until", "UShort", "Using", "When", "While", "Widening", "With", "WithEvents", "WriteOnly", "Xor"
	],
	"operator" : [
		"=", "(", ")", "+", "-", "<", ">", "&", "/", "^"
	]
};


SyntaxHighlighter.language.win32 = {
	"comment" : {
		"single" : {
			"start" : "//"
		},
		"multi" : {
			"start" : "/*",
			"end" : "*/"
		}
	},
	"keyword" : [
		"ATOM", "auto", "BOOL", "BOOLEAN", "break", "BYTE", "CALLBACK", "case", "char", "CHAR", "COLORREF", "const", "CONST", "continue", "default", "do", "double", "DWORD", "else", "enum", "extern", "float", "FLOAT", "for", "goto", "HANDLE", "HBITMAP", "HBRUSH", "HCOLORSPACE", "HCURSOR", "HDC", "HFILE", "HFONT", "HICON", "HINSTANCE", "HMENU", "HMODULE", "HPEN", "HRESULT", "HWND", "if", "int", "INT", "INT_PTR", "INT32", "INT64", "long", "LONG", "LONGLONG", "LONG_PTR", "LONG32", "LONG64", "LPARAM", "LPBOOL", "LPBYTE", "LPCSTR", "LPCTSTR", "LPCVOID", "LPCWSTR", "LPDWORD", "LPHANDLE", "LPINT", "LPLONG", "LPSTR", "LPTSTR", "LPVOID", "LPWORD", "LPWSTR", "LRESULT", "PBOOL", "PBOOLEAN", "PBYTE", "PCHAR", "PCSTR", "PCTSTR", "PCWSTR", "PDWORD", "PFLOAT", "PHANDLE", "PINT", "register", "return", "short", "SHORT", "signed", "sizeof", "static", "struct", "switch", "TCHAR", "typedef", "UCHAR", "UINT", "UINT32", "ULONG", "UNICODE_STRING", "union", "unsigned", "USHORT", "void", "VOID", "volatile", "WCHAR", "while", "WINAPI", "WORD", "WPARAM"
	],
	"operator" : [
		"=", "(", ")", "{", "}", ";", ".", ",", "*", "+", "-", "<", ">", "&", "|", "!", "?", "^", "/", ":", "~", "%"
	]
};/*!
 * Quill Editor v1.3.6
 * https://quilljs.com/
 * Copyright (c) 2014, Jason Chen
 * Copyright (c) 2013, salesforce.com
 */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Quill=e():t.Quill=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=45)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(17),o=n(18),i=n(19),l=n(48),a=n(49),s=n(50),u=n(51),c=n(52),f=n(11),h=n(29),p=n(30),d=n(28),y=n(1),v={Scope:y.Scope,create:y.create,find:y.find,query:y.query,register:y.register,Container:r.default,Format:o.default,Leaf:i.default,Embed:u.default,Scroll:l.default,Block:s.default,Inline:a.default,Text:c.default,Attributor:{Attribute:f.default,Class:h.default,Style:p.default,Store:d.default}};e.default=v},function(t,e,n){"use strict";function r(t,e){var n=i(t);if(null==n)throw new s("Unable to create "+t+" blot");var r=n;return new r(t instanceof Node||t.nodeType===Node.TEXT_NODE?t:r.create(e),e)}function o(t,n){return void 0===n&&(n=!1),null==t?null:null!=t[e.DATA_KEY]?t[e.DATA_KEY].blot:n?o(t.parentNode,n):null}function i(t,e){void 0===e&&(e=p.ANY);var n;if("string"==typeof t)n=h[t]||u[t];else if(t instanceof Text||t.nodeType===Node.TEXT_NODE)n=h.text;else if("number"==typeof t)t&p.LEVEL&p.BLOCK?n=h.block:t&p.LEVEL&p.INLINE&&(n=h.inline);else if(t instanceof HTMLElement){var r=(t.getAttribute("class")||"").split(/\s+/);for(var o in r)if(n=c[r[o]])break;n=n||f[t.tagName]}return null==n?null:e&p.LEVEL&n.scope&&e&p.TYPE&n.scope?n:null}function l(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t.length>1)return t.map(function(t){return l(t)});var n=t[0];if("string"!=typeof n.blotName&&"string"!=typeof n.attrName)throw new s("Invalid definition");if("abstract"===n.blotName)throw new s("Cannot register abstract class");if(h[n.blotName||n.attrName]=n,"string"==typeof n.keyName)u[n.keyName]=n;else if(null!=n.className&&(c[n.className]=n),null!=n.tagName){Array.isArray(n.tagName)?n.tagName=n.tagName.map(function(t){return t.toUpperCase()}):n.tagName=n.tagName.toUpperCase();var r=Array.isArray(n.tagName)?n.tagName:[n.tagName];r.forEach(function(t){null!=f[t]&&null!=n.className||(f[t]=n)})}return n}var a=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(e){var n=this;return e="[Parchment] "+e,n=t.call(this,e)||this,n.message=e,n.name=n.constructor.name,n}return a(e,t),e}(Error);e.ParchmentError=s;var u={},c={},f={},h={};e.DATA_KEY="__blot";var p;!function(t){t[t.TYPE=3]="TYPE",t[t.LEVEL=12]="LEVEL",t[t.ATTRIBUTE=13]="ATTRIBUTE",t[t.BLOT=14]="BLOT",t[t.INLINE=7]="INLINE",t[t.BLOCK=11]="BLOCK",t[t.BLOCK_BLOT=10]="BLOCK_BLOT",t[t.INLINE_BLOT=6]="INLINE_BLOT",t[t.BLOCK_ATTRIBUTE=9]="BLOCK_ATTRIBUTE",t[t.INLINE_ATTRIBUTE=5]="INLINE_ATTRIBUTE",t[t.ANY=15]="ANY"}(p=e.Scope||(e.Scope={})),e.create=r,e.find=o,e.query=i,e.register=l},function(t,e){"use strict";var n=Object.prototype.hasOwnProperty,r=Object.prototype.toString,o=function(t){return"function"==typeof Array.isArray?Array.isArray(t):"[object Array]"===r.call(t)},i=function(t){if(!t||"[object Object]"!==r.call(t))return!1;var e=n.call(t,"constructor"),o=t.constructor&&t.constructor.prototype&&n.call(t.constructor.prototype,"isPrototypeOf");if(t.constructor&&!e&&!o)return!1;var i;for(i in t);return void 0===i||n.call(t,i)};t.exports=function t(){var e,n,r,l,a,s,u=arguments[0],c=1,f=arguments.length,h=!1;for("boolean"==typeof u&&(h=u,u=arguments[1]||{},c=2),(null==u||"object"!=typeof u&&"function"!=typeof u)&&(u={});c<f;++c)if(null!=(e=arguments[c]))for(n in e)r=u[n],l=e[n],u!==l&&(h&&l&&(i(l)||(a=o(l)))?(a?(a=!1,s=r&&o(r)?r:[]):s=r&&i(r)?r:{},u[n]=t(h,s,l)):void 0!==l&&(u[n]=l));return u}},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return null==t?e:("function"==typeof t.formats&&(e=(0,f.default)(e,t.formats())),null==t.parent||"scroll"==t.parent.blotName||t.parent.statics.scope!==t.statics.scope?e:a(t.parent,e))}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.BlockEmbed=e.bubbleFormats=void 0;var s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},c=n(2),f=r(c),h=n(4),p=r(h),d=n(0),y=r(d),v=n(14),b=r(v),g=n(5),m=r(g),_=n(8),O=r(_),w=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),s(e,[{key:"attach",value:function(){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"attach",this).call(this),this.attributes=new y.default.Attributor.Store(this.domNode)}},{key:"delta",value:function(){return(new p.default).insert(this.value(),(0,f.default)(this.formats(),this.attributes.values()))}},{key:"format",value:function(t,e){var n=y.default.query(t,y.default.Scope.BLOCK_ATTRIBUTE);null!=n&&this.attributes.attribute(n,e)}},{key:"formatAt",value:function(t,e,n,r){this.format(n,r)}},{key:"insertAt",value:function(t,n,r){if("string"==typeof n&&n.endsWith("\n")){var o=y.default.create(x.blotName);this.parent.insertBefore(o,0===t?this:this.next),o.insertAt(0,n.slice(0,-1))}else u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,t,n,r)}}]),e}(y.default.Embed);w.scope=y.default.Scope.BLOCK_BLOT;var x=function(t){function e(t){o(this,e);var n=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.cache={},n}return l(e,t),s(e,[{key:"delta",value:function(){return null==this.cache.delta&&(this.cache.delta=this.descendants(y.default.Leaf).reduce(function(t,e){return 0===e.length()?t:t.insert(e.value(),a(e))},new p.default).insert("\n",a(this))),this.cache.delta}},{key:"deleteAt",value:function(t,n){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deleteAt",this).call(this,t,n),this.cache={}}},{key:"formatAt",value:function(t,n,r,o){n<=0||(y.default.query(r,y.default.Scope.BLOCK)?t+n===this.length()&&this.format(r,o):u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"formatAt",this).call(this,t,Math.min(n,this.length()-t-1),r,o),this.cache={})}},{key:"insertAt",value:function(t,n,r){if(null!=r)return u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,t,n,r);if(0!==n.length){var o=n.split("\n"),i=o.shift();i.length>0&&(t<this.length()-1||null==this.children.tail?u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,Math.min(t,this.length()-1),i):this.children.tail.insertAt(this.children.tail.length(),i),this.cache={});var l=this;o.reduce(function(t,e){return l=l.split(t,!0),l.insertAt(0,e),e.length},t+i.length)}}},{key:"insertBefore",value:function(t,n){var r=this.children.head;u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertBefore",this).call(this,t,n),r instanceof b.default&&r.remove(),this.cache={}}},{key:"length",value:function(){return null==this.cache.length&&(this.cache.length=u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"length",this).call(this)+1),this.cache.length}},{key:"moveChildren",value:function(t,n){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"moveChildren",this).call(this,t,n),this.cache={}}},{key:"optimize",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t),this.cache={}}},{key:"path",value:function(t){return u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"path",this).call(this,t,!0)}},{key:"removeChild",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"removeChild",this).call(this,t),this.cache={}}},{key:"split",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(n&&(0===t||t>=this.length()-1)){var r=this.clone();return 0===t?(this.parent.insertBefore(r,this),this):(this.parent.insertBefore(r,this.next),r)}var o=u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"split",this).call(this,t,n);return this.cache={},o}}]),e}(y.default.Block);x.blotName="block",x.tagName="P",x.defaultChild="break",x.allowedChildren=[m.default,y.default.Embed,O.default],e.bubbleFormats=a,e.BlockEmbed=w,e.default=x},function(t,e,n){var r=n(54),o=n(12),i=n(2),l=n(20),a=String.fromCharCode(0),s=function(t){Array.isArray(t)?this.ops=t:null!=t&&Array.isArray(t.ops)?this.ops=t.ops:this.ops=[]};s.prototype.insert=function(t,e){var n={};return 0===t.length?this:(n.insert=t,null!=e&&"object"==typeof e&&Object.keys(e).length>0&&(n.attributes=e),this.push(n))},s.prototype.delete=function(t){return t<=0?this:this.push({delete:t})},s.prototype.retain=function(t,e){if(t<=0)return this;var n={retain:t};return null!=e&&"object"==typeof e&&Object.keys(e).length>0&&(n.attributes=e),this.push(n)},s.prototype.push=function(t){var e=this.ops.length,n=this.ops[e-1];if(t=i(!0,{},t),"object"==typeof n){if("number"==typeof t.delete&&"number"==typeof n.delete)return this.ops[e-1]={delete:n.delete+t.delete},this;if("number"==typeof n.delete&&null!=t.insert&&(e-=1,"object"!=typeof(n=this.ops[e-1])))return this.ops.unshift(t),this;if(o(t.attributes,n.attributes)){if("string"==typeof t.insert&&"string"==typeof n.insert)return this.ops[e-1]={insert:n.insert+t.insert},"object"==typeof t.attributes&&(this.ops[e-1].attributes=t.attributes),this;if("number"==typeof t.retain&&"number"==typeof n.retain)return this.ops[e-1]={retain:n.retain+t.retain},"object"==typeof t.attributes&&(this.ops[e-1].attributes=t.attributes),this}}return e===this.ops.length?this.ops.push(t):this.ops.splice(e,0,t),this},s.prototype.chop=function(){var t=this.ops[this.ops.length-1];return t&&t.retain&&!t.attributes&&this.ops.pop(),this},s.prototype.filter=function(t){return this.ops.filter(t)},s.prototype.forEach=function(t){this.ops.forEach(t)},s.prototype.map=function(t){return this.ops.map(t)},s.prototype.partition=function(t){var e=[],n=[];return this.forEach(function(r){(t(r)?e:n).push(r)}),[e,n]},s.prototype.reduce=function(t,e){return this.ops.reduce(t,e)},s.prototype.changeLength=function(){return this.reduce(function(t,e){return e.insert?t+l.length(e):e.delete?t-e.delete:t},0)},s.prototype.length=function(){return this.reduce(function(t,e){return t+l.length(e)},0)},s.prototype.slice=function(t,e){t=t||0,"number"!=typeof e&&(e=1/0);for(var n=[],r=l.iterator(this.ops),o=0;o<e&&r.hasNext();){var i;o<t?i=r.next(t-o):(i=r.next(e-o),n.push(i)),o+=l.length(i)}return new s(n)},s.prototype.compose=function(t){for(var e=l.iterator(this.ops),n=l.iterator(t.ops),r=new s;e.hasNext()||n.hasNext();)if("insert"===n.peekType())r.push(n.next());else if("delete"===e.peekType())r.push(e.next());else{var o=Math.min(e.peekLength(),n.peekLength()),i=e.next(o),a=n.next(o);if("number"==typeof a.retain){var u={};"number"==typeof i.retain?u.retain=o:u.insert=i.insert;var c=l.attributes.compose(i.attributes,a.attributes,"number"==typeof i.retain);c&&(u.attributes=c),r.push(u)}else"number"==typeof a.delete&&"number"==typeof i.retain&&r.push(a)}return r.chop()},s.prototype.concat=function(t){var e=new s(this.ops.slice());return t.ops.length>0&&(e.push(t.ops[0]),e.ops=e.ops.concat(t.ops.slice(1))),e},s.prototype.diff=function(t,e){if(this.ops===t.ops)return new s;var n=[this,t].map(function(e){return e.map(function(n){if(null!=n.insert)return"string"==typeof n.insert?n.insert:a;var r=e===t?"on":"with";throw new Error("diff() called "+r+" non-document")}).join("")}),i=new s,u=r(n[0],n[1],e),c=l.iterator(this.ops),f=l.iterator(t.ops);return u.forEach(function(t){for(var e=t[1].length;e>0;){var n=0;switch(t[0]){case r.INSERT:n=Math.min(f.peekLength(),e),i.push(f.next(n));break;case r.DELETE:n=Math.min(e,c.peekLength()),c.next(n),i.delete(n);break;case r.EQUAL:n=Math.min(c.peekLength(),f.peekLength(),e);var a=c.next(n),s=f.next(n);o(a.insert,s.insert)?i.retain(n,l.attributes.diff(a.attributes,s.attributes)):i.push(s).delete(n)}e-=n}}),i.chop()},s.prototype.eachLine=function(t,e){e=e||"\n";for(var n=l.iterator(this.ops),r=new s,o=0;n.hasNext();){if("insert"!==n.peekType())return;var i=n.peek(),a=l.length(i)-n.peekLength(),u="string"==typeof i.insert?i.insert.indexOf(e,a)-a:-1;if(u<0)r.push(n.next());else if(u>0)r.push(n.next(u));else{if(!1===t(r,n.next(1).attributes||{},o))return;o+=1,r=new s}}r.length()>0&&t(r,{},o)},s.prototype.transform=function(t,e){if(e=!!e,"number"==typeof t)return this.transformPosition(t,e);for(var n=l.iterator(this.ops),r=l.iterator(t.ops),o=new s;n.hasNext()||r.hasNext();)if("insert"!==n.peekType()||!e&&"insert"===r.peekType())if("insert"===r.peekType())o.push(r.next());else{var i=Math.min(n.peekLength(),r.peekLength()),a=n.next(i),u=r.next(i);if(a.delete)continue;u.delete?o.push(u):o.retain(i,l.attributes.transform(a.attributes,u.attributes,e))}else o.retain(l.length(n.next()));return o.chop()},s.prototype.transformPosition=function(t,e){e=!!e;for(var n=l.iterator(this.ops),r=0;n.hasNext()&&r<=t;){var o=n.peekLength(),i=n.peekType();n.next(),"delete"!==i?("insert"===i&&(r<t||!e)&&(t+=o),r+=o):t-=Math.min(o,t-r)}return t},t.exports=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(8),c=r(u),f=n(0),h=r(f),p=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),a(e,[{key:"formatAt",value:function(t,n,r,o){if(e.compare(this.statics.blotName,r)<0&&h.default.query(r,h.default.Scope.BLOT)){var i=this.isolate(t,n);o&&i.wrap(r,o)}else s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"formatAt",this).call(this,t,n,r,o)}},{key:"optimize",value:function(t){if(s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t),this.parent instanceof e&&e.compare(this.statics.blotName,this.parent.statics.blotName)>0){var n=this.parent.isolate(this.offset(),this.length());this.moveChildren(n),n.wrap(this)}}}],[{key:"compare",value:function(t,n){var r=e.order.indexOf(t),o=e.order.indexOf(n);return r>=0||o>=0?r-o:t===n?0:t<n?-1:1}}]),e}(h.default.Inline);p.allowedChildren=[p,h.default.Embed,c.default],p.order=["cursor","inline","underline","strike","italic","bold","script","link","code"],e.default=p},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(e=(0,N.default)(!0,{container:t,modules:{clipboard:!0,keyboard:!0,history:!0}},e),e.theme&&e.theme!==S.DEFAULTS.theme){if(e.theme=S.import("themes/"+e.theme),null==e.theme)throw new Error("Invalid theme "+e.theme+". Did you register it?")}else e.theme=T.default;var n=(0,N.default)(!0,{},e.theme.DEFAULTS);[n,e].forEach(function(t){t.modules=t.modules||{},Object.keys(t.modules).forEach(function(e){!0===t.modules[e]&&(t.modules[e]={})})});var r=Object.keys(n.modules).concat(Object.keys(e.modules)),o=r.reduce(function(t,e){var n=S.import("modules/"+e);return null==n?P.error("Cannot load "+e+" module. Are you sure you registered it?"):t[e]=n.DEFAULTS||{},t},{});return null!=e.modules&&e.modules.toolbar&&e.modules.toolbar.constructor!==Object&&(e.modules.toolbar={container:e.modules.toolbar}),e=(0,N.default)(!0,{},S.DEFAULTS,{modules:o},n,e),["bounds","container","scrollingContainer"].forEach(function(t){"string"==typeof e[t]&&(e[t]=document.querySelector(e[t]))}),e.modules=Object.keys(e.modules).reduce(function(t,n){return e.modules[n]&&(t[n]=e.modules[n]),t},{}),e}function a(t,e,n,r){if(this.options.strict&&!this.isEnabled()&&e===g.default.sources.USER)return new d.default;var o=null==n?null:this.getSelection(),i=this.editor.delta,l=t();if(null!=o&&(!0===n&&(n=o.index),null==r?o=u(o,l,e):0!==r&&(o=u(o,n,r,e)),this.setSelection(o,g.default.sources.SILENT)),l.length()>0){var a,s=[g.default.events.TEXT_CHANGE,l,i,e];if((a=this.emitter).emit.apply(a,[g.default.events.EDITOR_CHANGE].concat(s)),e!==g.default.sources.SILENT){var c;(c=this.emitter).emit.apply(c,s)}}return l}function s(t,e,n,r,o){var i={};return"number"==typeof t.index&&"number"==typeof t.length?"number"!=typeof e?(o=r,r=n,n=e,e=t.length,t=t.index):(e=t.length,t=t.index):"number"!=typeof e&&(o=r,r=n,n=e,e=0),"object"===(void 0===n?"undefined":c(n))?(i=n,o=r):"string"==typeof n&&(null!=r?i[n]=r:o=n),o=o||g.default.sources.API,[t,e,i,o]}function u(t,e,n,r){if(null==t)return null;var o=void 0,i=void 0;if(e instanceof d.default){var l=[t.index,t.index+t.length].map(function(t){return e.transformPosition(t,r!==g.default.sources.USER)}),a=f(l,2);o=a[0],i=a[1]}else{var s=[t.index,t.index+t.length].map(function(t){return t<e||t===e&&r===g.default.sources.USER?t:n>=0?t+n:Math.max(e,t+n)}),u=f(s,2);o=u[0],i=u[1]}return new x.Range(o,i-o)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.overload=e.expandConfig=void 0;var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},f=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();n(53);var p=n(4),d=r(p),y=n(57),v=r(y),b=n(9),g=r(b),m=n(7),_=r(m),O=n(0),w=r(O),x=n(22),k=r(x),E=n(2),N=r(E),j=n(10),A=r(j),q=n(32),T=r(q),P=(0,A.default)("quill"),S=function(){function t(e){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(i(this,t),this.options=l(e,r),this.container=this.options.container,null==this.container)return P.error("Invalid Quill container",e);this.options.debug&&t.debug(this.options.debug);var o=this.container.innerHTML.trim();this.container.classList.add("ql-container"),this.container.innerHTML="",this.container.__quill=this,this.root=this.addContainer("ql-editor"),this.root.classList.add("ql-blank"),this.root.setAttribute("data-gramm",!1),this.scrollingContainer=this.options.scrollingContainer||this.root,this.emitter=new g.default,this.scroll=w.default.create(this.root,{emitter:this.emitter,whitelist:this.options.formats}),this.editor=new v.default(this.scroll),this.selection=new k.default(this.scroll,this.emitter),this.theme=new this.options.theme(this,this.options),this.keyboard=this.theme.addModule("keyboard"),this.clipboard=this.theme.addModule("clipboard"),this.history=this.theme.addModule("history"),this.theme.init(),this.emitter.on(g.default.events.EDITOR_CHANGE,function(t){t===g.default.events.TEXT_CHANGE&&n.root.classList.toggle("ql-blank",n.editor.isBlank())}),this.emitter.on(g.default.events.SCROLL_UPDATE,function(t,e){var r=n.selection.lastRange,o=r&&0===r.length?r.index:void 0;a.call(n,function(){return n.editor.update(null,e,o)},t)});var s=this.clipboard.convert("<div class='ql-editor' style=\"white-space: normal;\">"+o+"<p><br></p></div>");this.setContents(s),this.history.clear(),this.options.placeholder&&this.root.setAttribute("data-placeholder",this.options.placeholder),this.options.readOnly&&this.disable()}return h(t,null,[{key:"debug",value:function(t){!0===t&&(t="log"),A.default.level(t)}},{key:"find",value:function(t){return t.__quill||w.default.find(t)}},{key:"import",value:function(t){return null==this.imports[t]&&P.error("Cannot import "+t+". Are you sure it was registered?"),this.imports[t]}},{key:"register",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if("string"!=typeof t){var o=t.attrName||t.blotName;"string"==typeof o?this.register("formats/"+o,t,e):Object.keys(t).forEach(function(r){n.register(r,t[r],e)})}else null==this.imports[t]||r||P.warn("Overwriting "+t+" with",e),this.imports[t]=e,(t.startsWith("blots/")||t.startsWith("formats/"))&&"abstract"!==e.blotName?w.default.register(e):t.startsWith("modules")&&"function"==typeof e.register&&e.register()}}]),h(t,[{key:"addContainer",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if("string"==typeof t){var n=t;t=document.createElement("div"),t.classList.add(n)}return this.container.insertBefore(t,e),t}},{key:"blur",value:function(){this.selection.setRange(null)}},{key:"deleteText",value:function(t,e,n){var r=this,o=s(t,e,n),i=f(o,4);return t=i[0],e=i[1],n=i[3],a.call(this,function(){return r.editor.deleteText(t,e)},n,t,-1*e)}},{key:"disable",value:function(){this.enable(!1)}},{key:"enable",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.scroll.enable(t),this.container.classList.toggle("ql-disabled",!t)}},{key:"focus",value:function(){var t=this.scrollingContainer.scrollTop;this.selection.focus(),this.scrollingContainer.scrollTop=t,this.scrollIntoView()}},{key:"format",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g.default.sources.API;return a.call(this,function(){var r=n.getSelection(!0),i=new d.default;if(null==r)return i;if(w.default.query(t,w.default.Scope.BLOCK))i=n.editor.formatLine(r.index,r.length,o({},t,e));else{if(0===r.length)return n.selection.format(t,e),i;i=n.editor.formatText(r.index,r.length,o({},t,e))}return n.setSelection(r,g.default.sources.SILENT),i},r)}},{key:"formatLine",value:function(t,e,n,r,o){var i=this,l=void 0,u=s(t,e,n,r,o),c=f(u,4);return t=c[0],e=c[1],l=c[2],o=c[3],a.call(this,function(){return i.editor.formatLine(t,e,l)},o,t,0)}},{key:"formatText",value:function(t,e,n,r,o){var i=this,l=void 0,u=s(t,e,n,r,o),c=f(u,4);return t=c[0],e=c[1],l=c[2],o=c[3],a.call(this,function(){return i.editor.formatText(t,e,l)},o,t,0)}},{key:"getBounds",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=void 0;n="number"==typeof t?this.selection.getBounds(t,e):this.selection.getBounds(t.index,t.length);var r=this.container.getBoundingClientRect();return{bottom:n.bottom-r.top,height:n.height,left:n.left-r.left,right:n.right-r.left,top:n.top-r.top,width:n.width}}},{key:"getContents",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getLength()-t,n=s(t,e),r=f(n,2);return t=r[0],e=r[1],this.editor.getContents(t,e)}},{key:"getFormat",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.getSelection(!0),e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return"number"==typeof t?this.editor.getFormat(t,e):this.editor.getFormat(t.index,t.length)}},{key:"getIndex",value:function(t){return t.offset(this.scroll)}},{key:"getLength",value:function(){return this.scroll.length()}},{key:"getLeaf",value:function(t){return this.scroll.leaf(t)}},{key:"getLine",value:function(t){return this.scroll.line(t)}},{key:"getLines",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return"number"!=typeof t?this.scroll.lines(t.index,t.length):this.scroll.lines(t,e)}},{key:"getModule",value:function(t){return this.theme.modules[t]}},{key:"getSelection",value:function(){return arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&this.focus(),this.update(),this.selection.getRange()[0]}},{key:"getText",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getLength()-t,n=s(t,e),r=f(n,2);return t=r[0],e=r[1],this.editor.getText(t,e)}},{key:"hasFocus",value:function(){return this.selection.hasFocus()}},{key:"insertEmbed",value:function(e,n,r){var o=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:t.sources.API;return a.call(this,function(){return o.editor.insertEmbed(e,n,r)},i,e)}},{key:"insertText",value:function(t,e,n,r,o){var i=this,l=void 0,u=s(t,0,n,r,o),c=f(u,4);return t=c[0],l=c[2],o=c[3],a.call(this,function(){return i.editor.insertText(t,e,l)},o,t,e.length)}},{key:"isEnabled",value:function(){return!this.container.classList.contains("ql-disabled")}},{key:"off",value:function(){return this.emitter.off.apply(this.emitter,arguments)}},{key:"on",value:function(){return this.emitter.on.apply(this.emitter,arguments)}},{key:"once",value:function(){return this.emitter.once.apply(this.emitter,arguments)}},{key:"pasteHTML",value:function(t,e,n){this.clipboard.dangerouslyPasteHTML(t,e,n)}},{key:"removeFormat",value:function(t,e,n){var r=this,o=s(t,e,n),i=f(o,4);return t=i[0],e=i[1],n=i[3],a.call(this,function(){return r.editor.removeFormat(t,e)},n,t)}},{key:"scrollIntoView",value:function(){this.selection.scrollIntoView(this.scrollingContainer)}},{key:"setContents",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g.default.sources.API;return a.call(this,function(){t=new d.default(t);var n=e.getLength(),r=e.editor.deleteText(0,n),o=e.editor.applyDelta(t),i=o.ops[o.ops.length-1];return null!=i&&"string"==typeof i.insert&&"\n"===i.insert[i.insert.length-1]&&(e.editor.deleteText(e.getLength()-1,1),o.delete(1)),r.compose(o)},n)}},{key:"setSelection",value:function(e,n,r){if(null==e)this.selection.setRange(null,n||t.sources.API);else{var o=s(e,n,r),i=f(o,4);e=i[0],n=i[1],r=i[3],this.selection.setRange(new x.Range(e,n),r),r!==g.default.sources.SILENT&&this.selection.scrollIntoView(this.scrollingContainer)}}},{key:"setText",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g.default.sources.API,n=(new d.default).insert(t);return this.setContents(n,e)}},{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:g.default.sources.USER,e=this.scroll.update(t);return this.selection.update(t),e}},{key:"updateContents",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:g.default.sources.API;return a.call(this,function(){return t=new d.default(t),e.editor.applyDelta(t,n)},n,!0)}}]),t}();S.DEFAULTS={bounds:null,formats:null,modules:{},placeholder:"",readOnly:!1,scrollingContainer:null,strict:!0,theme:"default"},S.events=g.default.events,S.sources=g.default.sources,S.version="1.3.6",S.imports={delta:d.default,parchment:w.default,"core/module":_.default,"core/theme":T.default},e.expandConfig=l,e.overload=s,e.default=S},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r(this,t),this.quill=e,this.options=n};o.DEFAULTS={},e.default=o},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(0),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default.Text);e.default=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(58),c=r(u),f=n(10),h=r(f),p=(0,h.default)("quill:events");["selectionchange","mousedown","mouseup","click"].forEach(function(t){document.addEventListener(t,function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];[].slice.call(document.querySelectorAll(".ql-container")).forEach(function(t){if(t.__quill&&t.__quill.emitter){var n;(n=t.__quill.emitter).handleDOM.apply(n,e)}})})});var d=function(t){function e(){o(this,e);var t=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.listeners={},t.on("error",p.error),t}return l(e,t),a(e,[{key:"emit",value:function(){p.log.apply(p,arguments),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"emit",this).apply(this,arguments)}},{key:"handleDOM",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];(this.listeners[t.type]||[]).forEach(function(e){var r=e.node,o=e.handler;(t.target===r||r.contains(t.target))&&o.apply(void 0,[t].concat(n))})}},{key:"listenDOM",value:function(t,e,n){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push({node:e,handler:n})}}]),e}(c.default);d.events={EDITOR_CHANGE:"editor-change",SCROLL_BEFORE_UPDATE:"scroll-before-update",SCROLL_OPTIMIZE:"scroll-optimize",SCROLL_UPDATE:"scroll-update",SELECTION_CHANGE:"selection-change",TEXT_CHANGE:"text-change"},d.sources={API:"api",SILENT:"silent",USER:"user"},e.default=d},function(t,e,n){"use strict";function r(t){if(i.indexOf(t)<=i.indexOf(l)){for(var e,n=arguments.length,r=Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];(e=console)[t].apply(e,r)}}function o(t){return i.reduce(function(e,n){return e[n]=r.bind(console,n,t),e},{})}Object.defineProperty(e,"__esModule",{value:!0});var i=["error","warn","log","info"],l="warn";r.level=o.level=function(t){l=t},e.default=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),o=function(){function t(t,e,n){void 0===n&&(n={}),this.attrName=t,this.keyName=e;var o=r.Scope.TYPE&r.Scope.ATTRIBUTE;null!=n.scope?this.scope=n.scope&r.Scope.LEVEL|o:this.scope=r.Scope.ATTRIBUTE,null!=n.whitelist&&(this.whitelist=n.whitelist)}return t.keys=function(t){return[].map.call(t.attributes,function(t){return t.name})},t.prototype.add=function(t,e){return!!this.canAdd(t,e)&&(t.setAttribute(this.keyName,e),!0)},t.prototype.canAdd=function(t,e){return null!=r.query(t,r.Scope.BLOT&(this.scope|r.Scope.TYPE))&&(null==this.whitelist||("string"==typeof e?this.whitelist.indexOf(e.replace(/["']/g,""))>-1:this.whitelist.indexOf(e)>-1))},t.prototype.remove=function(t){t.removeAttribute(this.keyName)},t.prototype.value=function(t){var e=t.getAttribute(this.keyName);return this.canAdd(t,e)&&e?e:""},t}();e.default=o},function(t,e,n){function r(t){return null===t||void 0===t}function o(t){return!(!t||"object"!=typeof t||"number"!=typeof t.length)&&("function"==typeof t.copy&&"function"==typeof t.slice&&!(t.length>0&&"number"!=typeof t[0]))}function i(t,e,n){var i,c;if(r(t)||r(e))return!1;if(t.prototype!==e.prototype)return!1;if(s(t))return!!s(e)&&(t=l.call(t),e=l.call(e),u(t,e,n));if(o(t)){if(!o(e))return!1;if(t.length!==e.length)return!1;for(i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}try{var f=a(t),h=a(e)}catch(t){return!1}if(f.length!=h.length)return!1;for(f.sort(),h.sort(),i=f.length-1;i>=0;i--)if(f[i]!=h[i])return!1;for(i=f.length-1;i>=0;i--)if(c=f[i],!u(t[c],e[c],n))return!1;return typeof t==typeof e}var l=Array.prototype.slice,a=n(55),s=n(56),u=t.exports=function(t,e,n){return n||(n={}),t===e||(t instanceof Date&&e instanceof Date?t.getTime()===e.getTime():!t||!e||"object"!=typeof t&&"object"!=typeof e?n.strict?t===e:t==e:i(t,e,n))}},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Code=void 0;var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},c=n(4),f=r(c),h=n(0),p=r(h),d=n(3),y=r(d),v=n(5),b=r(v),g=n(8),m=r(g),_=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),e}(b.default);_.blotName="code",_.tagName="CODE";var O=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),s(e,[{key:"delta",value:function(){var t=this,e=this.domNode.textContent;return e.endsWith("\n")&&(e=e.slice(0,-1)),e.split("\n").reduce(function(e,n){return e.insert(n).insert("\n",t.formats())},new f.default)}},{key:"format",value:function(t,n){if(t!==this.statics.blotName||!n){var r=this.descendant(m.default,this.length()-1),o=a(r,1),i=o[0];null!=i&&i.deleteAt(i.length()-1,1),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n)}}},{key:"formatAt",value:function(t,n,r,o){if(0!==n&&null!=p.default.query(r,p.default.Scope.BLOCK)&&(r!==this.statics.blotName||o!==this.statics.formats(this.domNode))){var i=this.newlineIndex(t);if(!(i<0||i>=t+n)){var l=this.newlineIndex(t,!0)+1,a=i-l+1,s=this.isolate(l,a),u=s.next;s.format(r,o),u instanceof e&&u.formatAt(0,t-l+n-a,r,o)}}}},{key:"insertAt",value:function(t,e,n){if(null==n){var r=this.descendant(m.default,t),o=a(r,2),i=o[0],l=o[1];i.insertAt(l,e)}}},{key:"length",value:function(){var t=this.domNode.textContent.length;return this.domNode.textContent.endsWith("\n")?t:t+1}},{key:"newlineIndex",value:function(t){if(arguments.length>1&&void 0!==arguments[1]&&arguments[1])return this.domNode.textContent.slice(0,t).lastIndexOf("\n");var e=this.domNode.textContent.slice(t).indexOf("\n");return e>-1?t+e:-1}},{key:"optimize",value:function(t){this.domNode.textContent.endsWith("\n")||this.appendChild(p.default.create("text","\n")),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t);var n=this.next;null!=n&&n.prev===this&&n.statics.blotName===this.statics.blotName&&this.statics.formats(this.domNode)===n.statics.formats(n.domNode)&&(n.optimize(t),n.moveChildren(this),n.remove())}},{key:"replace",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replace",this).call(this,t),[].slice.call(this.domNode.querySelectorAll("*")).forEach(function(t){var e=p.default.find(t);null==e?t.parentNode.removeChild(t):e instanceof p.default.Embed?e.remove():e.unwrap()})}}],[{key:"create",value:function(t){var n=u(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return n.setAttribute("spellcheck",!1),n}},{key:"formats",value:function(){return!0}}]),e}(y.default);O.blotName="code-block",O.tagName="PRE",O.TAB="  ",e.Code=_,e.default=O},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"insertInto",value:function(t,n){0===t.children.length?a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertInto",this).call(this,t,n):this.remove()}},{key:"length",value:function(){return 0}},{key:"value",value:function(){return""}}],[{key:"value",value:function(){}}]),e}(u.default.Embed);c.blotName="break",c.tagName="BR",e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function l(t,e){var n=document.createElement("a");n.href=t;var r=n.href.slice(0,n.href.indexOf(":"));return e.indexOf(r)>-1}Object.defineProperty(e,"__esModule",{value:!0}),e.sanitize=e.default=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(5),c=function(t){return t&&t.__esModule?t:{default:t}}(u),f=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),a(e,[{key:"format",value:function(t,n){if(t!==this.statics.blotName||!n)return s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n);n=this.constructor.sanitize(n),this.domNode.setAttribute("href",n)}}],[{key:"create",value:function(t){var n=s(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return t=this.sanitize(t),n.setAttribute("href",t),n.setAttribute("target","_blank"),n}},{key:"formats",value:function(t){return t.getAttribute("href")}},{key:"sanitize",value:function(t){return l(t,this.PROTOCOL_WHITELIST)?t:this.SANITIZED_URL}}]),e}(c.default);f.blotName="link",f.tagName="A",f.SANITIZED_URL="about:blank",f.PROTOCOL_WHITELIST=["http","https","mailto","tel"],e.default=f,e.sanitize=l},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){t.setAttribute(e,!("true"===t.getAttribute(e)))}Object.defineProperty(e,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=n(25),u=r(s),c=n(106),f=r(c),h=0,p=function(){function t(e){var n=this;o(this,t),this.select=e,this.container=document.createElement("span"),this.buildPicker(),this.select.style.display="none",this.select.parentNode.insertBefore(this.container,this.select),this.label.addEventListener("mousedown",function(){n.togglePicker()}),this.label.addEventListener("keydown",function(t){switch(t.keyCode){case u.default.keys.ENTER:n.togglePicker();break;case u.default.keys.ESCAPE:n.escape(),t.preventDefault()}}),this.select.addEventListener("change",this.update.bind(this))}return a(t,[{key:"togglePicker",value:function(){this.container.classList.toggle("ql-expanded"),i(this.label,"aria-expanded"),i(this.options,"aria-hidden")}},{key:"buildItem",value:function(t){var e=this,n=document.createElement("span");return n.tabIndex="0",n.setAttribute("role","button"),n.classList.add("ql-picker-item"),t.hasAttribute("value")&&n.setAttribute("data-value",t.getAttribute("value")),t.textContent&&n.setAttribute("data-label",t.textContent),n.addEventListener("click",function(){e.selectItem(n,!0)}),n.addEventListener("keydown",function(t){switch(t.keyCode){case u.default.keys.ENTER:e.selectItem(n,!0),t.preventDefault();break;case u.default.keys.ESCAPE:e.escape(),t.preventDefault()}}),n}},{key:"buildLabel",value:function(){var t=document.createElement("span");return t.classList.add("ql-picker-label"),t.innerHTML=f.default,t.tabIndex="0",t.setAttribute("role","button"),t.setAttribute("aria-expanded","false"),this.container.appendChild(t),t}},{key:"buildOptions",value:function(){var t=this,e=document.createElement("span");e.classList.add("ql-picker-options"),e.setAttribute("aria-hidden","true"),e.tabIndex="-1",e.id="ql-picker-options-"+h,h+=1,this.label.setAttribute("aria-controls",e.id),this.options=e,[].slice.call(this.select.options).forEach(function(n){var r=t.buildItem(n);e.appendChild(r),!0===n.selected&&t.selectItem(r)}),this.container.appendChild(e)}},{key:"buildPicker",value:function(){var t=this;[].slice.call(this.select.attributes).forEach(function(e){t.container.setAttribute(e.name,e.value)}),this.container.classList.add("ql-picker"),this.label=this.buildLabel(),this.buildOptions()}},{key:"escape",value:function(){var t=this;this.close(),setTimeout(function(){return t.label.focus()},1)}},{key:"close",value:function(){this.container.classList.remove("ql-expanded"),this.label.setAttribute("aria-expanded","false"),this.options.setAttribute("aria-hidden","true")}},{key:"selectItem",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.container.querySelector(".ql-selected");if(t!==n&&(null!=n&&n.classList.remove("ql-selected"),null!=t&&(t.classList.add("ql-selected"),this.select.selectedIndex=[].indexOf.call(t.parentNode.children,t),t.hasAttribute("data-value")?this.label.setAttribute("data-value",t.getAttribute("data-value")):this.label.removeAttribute("data-value"),t.hasAttribute("data-label")?this.label.setAttribute("data-label",t.getAttribute("data-label")):this.label.removeAttribute("data-label"),e))){if("function"==typeof Event)this.select.dispatchEvent(new Event("change"));else if("object"===("undefined"==typeof Event?"undefined":l(Event))){var r=document.createEvent("Event");r.initEvent("change",!0,!0),this.select.dispatchEvent(r)}this.close()}}},{key:"update",value:function(){var t=void 0;if(this.select.selectedIndex>-1){var e=this.container.querySelector(".ql-picker-options").children[this.select.selectedIndex];t=this.select.options[this.select.selectedIndex],this.selectItem(e)}else this.selectItem(null);var n=null!=t&&t!==this.select.querySelector("option[selected]");this.label.classList.toggle("ql-active",n)}}]),t}();e.default=p},function(t,e,n){"use strict";function r(t){var e=a.find(t);if(null==e)try{e=a.create(t)}catch(n){e=a.create(a.Scope.INLINE),[].slice.call(t.childNodes).forEach(function(t){e.domNode.appendChild(t)}),t.parentNode&&t.parentNode.replaceChild(e.domNode,t),e.attach()}return e}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(47),l=n(27),a=n(1),s=function(t){function e(e){var n=t.call(this,e)||this;return n.build(),n}return o(e,t),e.prototype.appendChild=function(t){this.insertBefore(t)},e.prototype.attach=function(){t.prototype.attach.call(this),this.children.forEach(function(t){t.attach()})},e.prototype.build=function(){var t=this;this.children=new i.default,[].slice.call(this.domNode.childNodes).reverse().forEach(function(e){try{var n=r(e);t.insertBefore(n,t.children.head||void 0)}catch(t){if(t instanceof a.ParchmentError)return;throw t}})},e.prototype.deleteAt=function(t,e){if(0===t&&e===this.length())return this.remove();this.children.forEachAt(t,e,function(t,e,n){t.deleteAt(e,n)})},e.prototype.descendant=function(t,n){var r=this.children.find(n),o=r[0],i=r[1];return null==t.blotName&&t(o)||null!=t.blotName&&o instanceof t?[o,i]:o instanceof e?o.descendant(t,i):[null,-1]},e.prototype.descendants=function(t,n,r){void 0===n&&(n=0),void 0===r&&(r=Number.MAX_VALUE);var o=[],i=r;return this.children.forEachAt(n,r,function(n,r,l){(null==t.blotName&&t(n)||null!=t.blotName&&n instanceof t)&&o.push(n),n instanceof e&&(o=o.concat(n.descendants(t,r,i))),i-=l}),o},e.prototype.detach=function(){this.children.forEach(function(t){t.detach()}),t.prototype.detach.call(this)},e.prototype.formatAt=function(t,e,n,r){this.children.forEachAt(t,e,function(t,e,o){t.formatAt(e,o,n,r)})},e.prototype.insertAt=function(t,e,n){var r=this.children.find(t),o=r[0],i=r[1];if(o)o.insertAt(i,e,n);else{var l=null==n?a.create("text",e):a.create(e,n);this.appendChild(l)}},e.prototype.insertBefore=function(t,e){if(null!=this.statics.allowedChildren&&!this.statics.allowedChildren.some(function(e){return t instanceof e}))throw new a.ParchmentError("Cannot insert "+t.statics.blotName+" into "+this.statics.blotName);t.insertInto(this,e)},e.prototype.length=function(){return this.children.reduce(function(t,e){return t+e.length()},0)},e.prototype.moveChildren=function(t,e){this.children.forEach(function(n){t.insertBefore(n,e)})},e.prototype.optimize=function(e){if(t.prototype.optimize.call(this,e),0===this.children.length)if(null!=this.statics.defaultChild){var n=a.create(this.statics.defaultChild);this.appendChild(n),n.optimize(e)}else this.remove()},e.prototype.path=function(t,n){void 0===n&&(n=!1);var r=this.children.find(t,n),o=r[0],i=r[1],l=[[this,t]];return o instanceof e?l.concat(o.path(i,n)):(null!=o&&l.push([o,i]),l)},e.prototype.removeChild=function(t){this.children.remove(t)},e.prototype.replace=function(n){n instanceof e&&n.moveChildren(this),t.prototype.replace.call(this,n)},e.prototype.split=function(t,e){if(void 0===e&&(e=!1),!e){if(0===t)return this;if(t===this.length())return this.next}var n=this.clone();return this.parent.insertBefore(n,this.next),this.children.forEachAt(t,this.length(),function(t,r,o){t=t.split(r,e),n.appendChild(t)}),n},e.prototype.unwrap=function(){this.moveChildren(this.parent,this.next),this.remove()},e.prototype.update=function(t,e){var n=this,o=[],i=[];t.forEach(function(t){t.target===n.domNode&&"childList"===t.type&&(o.push.apply(o,t.addedNodes),i.push.apply(i,t.removedNodes))}),i.forEach(function(t){if(!(null!=t.parentNode&&"IFRAME"!==t.tagName&&document.body.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_CONTAINED_BY)){var e=a.find(t);null!=e&&(null!=e.domNode.parentNode&&e.domNode.parentNode!==n.domNode||e.detach())}}),o.filter(function(t){return t.parentNode==n.domNode}).sort(function(t,e){return t===e?0:t.compareDocumentPosition(e)&Node.DOCUMENT_POSITION_FOLLOWING?1:-1}).forEach(function(t){var e=null;null!=t.nextSibling&&(e=a.find(t.nextSibling));var o=r(t);o.next==e&&null!=o.next||(null!=o.parent&&o.parent.removeChild(n),n.insertBefore(o,e||void 0))})},e}(l.default);e.default=s},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(11),i=n(28),l=n(17),a=n(1),s=function(t){function e(e){var n=t.call(this,e)||this;return n.attributes=new i.default(n.domNode),n}return r(e,t),e.formats=function(t){return"string"==typeof this.tagName||(Array.isArray(this.tagName)?t.tagName.toLowerCase():void 0)},e.prototype.format=function(t,e){var n=a.query(t);n instanceof o.default?this.attributes.attribute(n,e):e&&(null==n||t===this.statics.blotName&&this.formats()[t]===e||this.replaceWith(t,e))},e.prototype.formats=function(){var t=this.attributes.values(),e=this.statics.formats(this.domNode);return null!=e&&(t[this.statics.blotName]=e),t},e.prototype.replaceWith=function(e,n){var r=t.prototype.replaceWith.call(this,e,n);return this.attributes.copy(r),r},e.prototype.update=function(e,n){var r=this;t.prototype.update.call(this,e,n),e.some(function(t){return t.target===r.domNode&&"attributes"===t.type})&&this.attributes.build()},e.prototype.wrap=function(n,r){var o=t.prototype.wrap.call(this,n,r);return o instanceof e&&o.statics.scope===this.statics.scope&&this.attributes.move(o),o},e}(l.default);e.default=s},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(27),i=n(1),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.value=function(t){return!0},e.prototype.index=function(t,e){return this.domNode===t||this.domNode.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_CONTAINED_BY?Math.min(e,1):-1},e.prototype.position=function(t,e){var n=[].indexOf.call(this.parent.domNode.childNodes,this.domNode);return t>0&&(n+=1),[this.parent.domNode,n]},e.prototype.value=function(){return t={},t[this.statics.blotName]=this.statics.value(this.domNode)||!0,t;var t},e.scope=i.Scope.INLINE_BLOT,e}(o.default);e.default=l},function(t,e,n){function r(t){this.ops=t,this.index=0,this.offset=0}var o=n(12),i=n(2),l={attributes:{compose:function(t,e,n){"object"!=typeof t&&(t={}),"object"!=typeof e&&(e={});var r=i(!0,{},e);n||(r=Object.keys(r).reduce(function(t,e){return null!=r[e]&&(t[e]=r[e]),t},{}));for(var o in t)void 0!==t[o]&&void 0===e[o]&&(r[o]=t[o]);return Object.keys(r).length>0?r:void 0},diff:function(t,e){"object"!=typeof t&&(t={}),"object"!=typeof e&&(e={});var n=Object.keys(t).concat(Object.keys(e)).reduce(function(n,r){return o(t[r],e[r])||(n[r]=void 0===e[r]?null:e[r]),n},{});return Object.keys(n).length>0?n:void 0},transform:function(t,e,n){if("object"!=typeof t)return e;if("object"==typeof e){if(!n)return e;var r=Object.keys(e).reduce(function(n,r){return void 0===t[r]&&(n[r]=e[r]),n},{});return Object.keys(r).length>0?r:void 0}}},iterator:function(t){return new r(t)},length:function(t){return"number"==typeof t.delete?t.delete:"number"==typeof t.retain?t.retain:"string"==typeof t.insert?t.insert.length:1}};r.prototype.hasNext=function(){return this.peekLength()<1/0},r.prototype.next=function(t){t||(t=1/0);var e=this.ops[this.index];if(e){var n=this.offset,r=l.length(e);if(t>=r-n?(t=r-n,this.index+=1,this.offset=0):this.offset+=t,"number"==typeof e.delete)return{delete:t};var o={};return e.attributes&&(o.attributes=e.attributes),"number"==typeof e.retain?o.retain=t:"string"==typeof e.insert?o.insert=e.insert.substr(n,t):o.insert=e.insert,o}return{retain:1/0}},r.prototype.peek=function(){return this.ops[this.index]},r.prototype.peekLength=function(){return this.ops[this.index]?l.length(this.ops[this.index])-this.offset:1/0},r.prototype.peekType=function(){return this.ops[this.index]?"number"==typeof this.ops[this.index].delete?"delete":"number"==typeof this.ops[this.index].retain?"retain":"insert":"retain"},t.exports=l},function(t,e){var n=function(){"use strict";function t(t,e){return null!=e&&t instanceof e}function e(n,r,o,i,c){function f(n,o){if(null===n)return null;if(0===o)return n;var y,v;if("object"!=typeof n)return n;if(t(n,a))y=new a;else if(t(n,s))y=new s;else if(t(n,u))y=new u(function(t,e){n.then(function(e){t(f(e,o-1))},function(t){e(f(t,o-1))})});else if(e.__isArray(n))y=[];else if(e.__isRegExp(n))y=new RegExp(n.source,l(n)),n.lastIndex&&(y.lastIndex=n.lastIndex);else if(e.__isDate(n))y=new Date(n.getTime());else{if(d&&Buffer.isBuffer(n))return y=new Buffer(n.length),n.copy(y),y;t(n,Error)?y=Object.create(n):void 0===i?(v=Object.getPrototypeOf(n),y=Object.create(v)):(y=Object.create(i),v=i)}if(r){var b=h.indexOf(n);if(-1!=b)return p[b];h.push(n),p.push(y)}t(n,a)&&n.forEach(function(t,e){var n=f(e,o-1),r=f(t,o-1);y.set(n,r)}),t(n,s)&&n.forEach(function(t){var e=f(t,o-1);y.add(e)});for(var g in n){var m;v&&(m=Object.getOwnPropertyDescriptor(v,g)),m&&null==m.set||(y[g]=f(n[g],o-1))}if(Object.getOwnPropertySymbols)for(var _=Object.getOwnPropertySymbols(n),g=0;g<_.length;g++){var O=_[g],w=Object.getOwnPropertyDescriptor(n,O);(!w||w.enumerable||c)&&(y[O]=f(n[O],o-1),w.enumerable||Object.defineProperty(y,O,{enumerable:!1}))}if(c)for(var x=Object.getOwnPropertyNames(n),g=0;g<x.length;g++){var k=x[g],w=Object.getOwnPropertyDescriptor(n,k);w&&w.enumerable||(y[k]=f(n[k],o-1),Object.defineProperty(y,k,{enumerable:!1}))}return y}"object"==typeof r&&(o=r.depth,i=r.prototype,c=r.includeNonEnumerable,r=r.circular);var h=[],p=[],d="undefined"!=typeof Buffer;return void 0===r&&(r=!0),void 0===o&&(o=1/0),f(n,o)}function n(t){return Object.prototype.toString.call(t)}function r(t){return"object"==typeof t&&"[object Date]"===n(t)}function o(t){return"object"==typeof t&&"[object Array]"===n(t)}function i(t){return"object"==typeof t&&"[object RegExp]"===n(t)}function l(t){var e="";return t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),e}var a;try{a=Map}catch(t){a=function(){}}var s;try{s=Set}catch(t){s=function(){}}var u;try{u=Promise}catch(t){u=function(){}}return e.clonePrototype=function(t){if(null===t)return null;var e=function(){};return e.prototype=t,new e},e.__objToStr=n,e.__isDate=r,e.__isArray=o,e.__isRegExp=i,e.__getRegExpFlags=l,e}();"object"==typeof t&&t.exports&&(t.exports=n)},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){try{e.parentNode}catch(t){return!1}return e instanceof Text&&(e=e.parentNode),t.contains(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.Range=void 0;var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=n(0),c=r(u),f=n(21),h=r(f),p=n(12),d=r(p),y=n(9),v=r(y),b=n(10),g=r(b),m=(0,g.default)("quill:selection"),_=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;i(this,t),this.index=e,this.length=n},O=function(){function t(e,n){var r=this;i(this,t),this.emitter=n,this.scroll=e,this.composing=!1,this.mouseDown=!1,this.root=this.scroll.domNode,this.cursor=c.default.create("cursor",this),this.lastRange=this.savedRange=new _(0,0),this.handleComposition(),this.handleDragging(),this.emitter.listenDOM("selectionchange",document,function(){r.mouseDown||setTimeout(r.update.bind(r,v.default.sources.USER),1)}),this.emitter.on(v.default.events.EDITOR_CHANGE,function(t,e){t===v.default.events.TEXT_CHANGE&&e.length()>0&&r.update(v.default.sources.SILENT)}),this.emitter.on(v.default.events.SCROLL_BEFORE_UPDATE,function(){if(r.hasFocus()){var t=r.getNativeRange();null!=t&&t.start.node!==r.cursor.textNode&&r.emitter.once(v.default.events.SCROLL_UPDATE,function(){try{r.setNativeRange(t.start.node,t.start.offset,t.end.node,t.end.offset)}catch(t){}})}}),this.emitter.on(v.default.events.SCROLL_OPTIMIZE,function(t,e){if(e.range){var n=e.range,o=n.startNode,i=n.startOffset,l=n.endNode,a=n.endOffset;r.setNativeRange(o,i,l,a)}}),this.update(v.default.sources.SILENT)}return s(t,[{key:"handleComposition",value:function(){var t=this;this.root.addEventListener("compositionstart",function(){t.composing=!0}),this.root.addEventListener("compositionend",function(){if(t.composing=!1,t.cursor.parent){var e=t.cursor.restore();if(!e)return;setTimeout(function(){t.setNativeRange(e.startNode,e.startOffset,e.endNode,e.endOffset)},1)}})}},{key:"handleDragging",value:function(){var t=this;this.emitter.listenDOM("mousedown",document.body,function(){t.mouseDown=!0}),this.emitter.listenDOM("mouseup",document.body,function(){t.mouseDown=!1,t.update(v.default.sources.USER)})}},{key:"focus",value:function(){this.hasFocus()||(this.root.focus(),this.setRange(this.savedRange))}},{key:"format",value:function(t,e){if(null==this.scroll.whitelist||this.scroll.whitelist[t]){this.scroll.update();var n=this.getNativeRange();if(null!=n&&n.native.collapsed&&!c.default.query(t,c.default.Scope.BLOCK)){if(n.start.node!==this.cursor.textNode){var r=c.default.find(n.start.node,!1);if(null==r)return;if(r instanceof c.default.Leaf){var o=r.split(n.start.offset);r.parent.insertBefore(this.cursor,o)}else r.insertBefore(this.cursor,n.start.node);this.cursor.attach()}this.cursor.format(t,e),this.scroll.optimize(),this.setNativeRange(this.cursor.textNode,this.cursor.textNode.data.length),this.update()}}}},{key:"getBounds",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=this.scroll.length();t=Math.min(t,n-1),e=Math.min(t+e,n-1)-t;var r=void 0,o=this.scroll.leaf(t),i=a(o,2),l=i[0],s=i[1];if(null==l)return null;var u=l.position(s,!0),c=a(u,2);r=c[0],s=c[1];var f=document.createRange();if(e>0){f.setStart(r,s);var h=this.scroll.leaf(t+e),p=a(h,2);if(l=p[0],s=p[1],null==l)return null;var d=l.position(s,!0),y=a(d,2);return r=y[0],s=y[1],f.setEnd(r,s),f.getBoundingClientRect()}var v="left",b=void 0;return r instanceof Text?(s<r.data.length?(f.setStart(r,s),f.setEnd(r,s+1)):(f.setStart(r,s-1),f.setEnd(r,s),v="right"),b=f.getBoundingClientRect()):(b=l.domNode.getBoundingClientRect(),s>0&&(v="right")),{bottom:b.top+b.height,height:b.height,left:b[v],right:b[v],top:b.top,width:0}}},{key:"getNativeRange",value:function(){var t=document.getSelection();if(null==t||t.rangeCount<=0)return null;var e=t.getRangeAt(0);if(null==e)return null;var n=this.normalizeNative(e);return m.info("getNativeRange",n),n}},{key:"getRange",value:function(){var t=this.getNativeRange();return null==t?[null,null]:[this.normalizedToRange(t),t]}},{key:"hasFocus",value:function(){return document.activeElement===this.root}},{key:"normalizedToRange",value:function(t){var e=this,n=[[t.start.node,t.start.offset]];t.native.collapsed||n.push([t.end.node,t.end.offset]);var r=n.map(function(t){var n=a(t,2),r=n[0],o=n[1],i=c.default.find(r,!0),l=i.offset(e.scroll);return 0===o?l:i instanceof c.default.Container?l+i.length():l+i.index(r,o)}),i=Math.min(Math.max.apply(Math,o(r)),this.scroll.length()-1),l=Math.min.apply(Math,[i].concat(o(r)));return new _(l,i-l)}},{key:"normalizeNative",value:function(t){if(!l(this.root,t.startContainer)||!t.collapsed&&!l(this.root,t.endContainer))return null;var e={start:{node:t.startContainer,offset:t.startOffset},end:{node:t.endContainer,offset:t.endOffset},native:t};return[e.start,e.end].forEach(function(t){for(var e=t.node,n=t.offset;!(e instanceof Text)&&e.childNodes.length>0;)if(e.childNodes.length>n)e=e.childNodes[n],n=0;else{if(e.childNodes.length!==n)break;e=e.lastChild,n=e instanceof Text?e.data.length:e.childNodes.length+1}t.node=e,t.offset=n}),e}},{key:"rangeToNative",value:function(t){var e=this,n=t.collapsed?[t.index]:[t.index,t.index+t.length],r=[],o=this.scroll.length();return n.forEach(function(t,n){t=Math.min(o-1,t);var i=void 0,l=e.scroll.leaf(t),s=a(l,2),u=s[0],c=s[1],f=u.position(c,0!==n),h=a(f,2);i=h[0],c=h[1],r.push(i,c)}),r.length<2&&(r=r.concat(r)),r}},{key:"scrollIntoView",value:function(t){var e=this.lastRange;if(null!=e){var n=this.getBounds(e.index,e.length);if(null!=n){var r=this.scroll.length()-1,o=this.scroll.line(Math.min(e.index,r)),i=a(o,1),l=i[0],s=l;if(e.length>0){var u=this.scroll.line(Math.min(e.index+e.length,r));s=a(u,1)[0]}if(null!=l&&null!=s){var c=t.getBoundingClientRect();n.top<c.top?t.scrollTop-=c.top-n.top:n.bottom>c.bottom&&(t.scrollTop+=n.bottom-c.bottom)}}}}},{key:"setNativeRange",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:e,o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if(m.info("setNativeRange",t,e,n,r),null==t||null!=this.root.parentNode&&null!=t.parentNode&&null!=n.parentNode){var i=document.getSelection();if(null!=i)if(null!=t){this.hasFocus()||this.root.focus();var l=(this.getNativeRange()||{}).native;if(null==l||o||t!==l.startContainer||e!==l.startOffset||n!==l.endContainer||r!==l.endOffset){"BR"==t.tagName&&(e=[].indexOf.call(t.parentNode.childNodes,t),t=t.parentNode),"BR"==n.tagName&&(r=[].indexOf.call(n.parentNode.childNodes,n),n=n.parentNode);var a=document.createRange();a.setStart(t,e),a.setEnd(n,r),i.removeAllRanges(),i.addRange(a)}}else i.removeAllRanges(),this.root.blur(),document.body.focus()}}},{key:"setRange",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:v.default.sources.API;if("string"==typeof e&&(n=e,e=!1),m.info("setRange",t),null!=t){var r=this.rangeToNative(t);this.setNativeRange.apply(this,o(r).concat([e]))}else this.setNativeRange(null);this.update(n)}},{key:"update",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v.default.sources.USER,e=this.lastRange,n=this.getRange(),r=a(n,2),o=r[0],i=r[1];if(this.lastRange=o,null!=this.lastRange&&(this.savedRange=this.lastRange),!(0,d.default)(e,this.lastRange)){var l;!this.composing&&null!=i&&i.native.collapsed&&i.start.node!==this.cursor.textNode&&this.cursor.restore();var s=[v.default.events.SELECTION_CHANGE,(0,h.default)(this.lastRange),(0,h.default)(e),t];if((l=this.emitter).emit.apply(l,[v.default.events.EDITOR_CHANGE].concat(s)),t!==v.default.sources.SILENT){var u;(u=this.emitter).emit.apply(u,s)}}}}]),t}();e.Range=_,e.default=O},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=n(0),s=r(a),u=n(3),c=r(u),f=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),e}(s.default.Container);f.allowedChildren=[c.default,u.BlockEmbed,f],e.default=f},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.ColorStyle=e.ColorClass=e.ColorAttributor=void 0;var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"value",value:function(t){var n=a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"value",this).call(this,t);return n.startsWith("rgb(")?(n=n.replace(/^[^\d]+/,"").replace(/[^\d]+$/,""),"#"+n.split(",").map(function(t){return("00"+parseInt(t).toString(16)).slice(-2)}).join("")):n}}]),e}(u.default.Attributor.Style),f=new u.default.Attributor.Class("color","ql-color",{scope:u.default.Scope.INLINE}),h=new c("color","color",{scope:u.default.Scope.INLINE});e.ColorAttributor=c,e.ColorClass=f,e.ColorStyle=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e){var n,r=t===D.keys.LEFT?"prefix":"suffix";return n={key:t,shiftKey:e,altKey:null},o(n,r,/^$/),o(n,"handler",function(n){var r=n.index;t===D.keys.RIGHT&&(r+=n.length+1);var o=this.quill.getLeaf(r);return!(b(o,1)[0]instanceof T.default.Embed)||(t===D.keys.LEFT?e?this.quill.setSelection(n.index-1,n.length+1,S.default.sources.USER):this.quill.setSelection(n.index-1,S.default.sources.USER):e?this.quill.setSelection(n.index,n.length+1,S.default.sources.USER):this.quill.setSelection(n.index+n.length+1,S.default.sources.USER),!1)}),n}function u(t,e){if(!(0===t.index||this.quill.getLength()<=1)){var n=this.quill.getLine(t.index),r=b(n,1),o=r[0],i={};if(0===e.offset){var l=this.quill.getLine(t.index-1),a=b(l,1),s=a[0];if(null!=s&&s.length()>1){var u=o.formats(),c=this.quill.getFormat(t.index-1,1);i=A.default.attributes.diff(u,c)||{}}}var f=/[\uD800-\uDBFF][\uDC00-\uDFFF]$/.test(e.prefix)?2:1;this.quill.deleteText(t.index-f,f,S.default.sources.USER),Object.keys(i).length>0&&this.quill.formatLine(t.index-f,f,i,S.default.sources.USER),this.quill.focus()}}function c(t,e){var n=/^[\uD800-\uDBFF][\uDC00-\uDFFF]/.test(e.suffix)?2:1;if(!(t.index>=this.quill.getLength()-n)){var r={},o=0,i=this.quill.getLine(t.index),l=b(i,1),a=l[0];if(e.offset>=a.length()-1){var s=this.quill.getLine(t.index+1),u=b(s,1),c=u[0];if(c){var f=a.formats(),h=this.quill.getFormat(t.index,1);r=A.default.attributes.diff(f,h)||{},o=c.length()}}this.quill.deleteText(t.index,n,S.default.sources.USER),Object.keys(r).length>0&&this.quill.formatLine(t.index+o-1,n,r,S.default.sources.USER)}}function f(t){var e=this.quill.getLines(t),n={};if(e.length>1){var r=e[0].formats(),o=e[e.length-1].formats();n=A.default.attributes.diff(o,r)||{}}this.quill.deleteText(t,S.default.sources.USER),Object.keys(n).length>0&&this.quill.formatLine(t.index,1,n,S.default.sources.USER),this.quill.setSelection(t.index,S.default.sources.SILENT),this.quill.focus()}function h(t,e){var n=this;t.length>0&&this.quill.scroll.deleteAt(t.index,t.length);var r=Object.keys(e.format).reduce(function(t,n){return T.default.query(n,T.default.Scope.BLOCK)&&!Array.isArray(e.format[n])&&(t[n]=e.format[n]),t},{});this.quill.insertText(t.index,"\n",r,S.default.sources.USER),this.quill.setSelection(t.index+1,S.default.sources.SILENT),this.quill.focus(),Object.keys(e.format).forEach(function(t){null==r[t]&&(Array.isArray(e.format[t])||"link"!==t&&n.quill.format(t,e.format[t],S.default.sources.USER))})}function p(t){return{key:D.keys.TAB,shiftKey:!t,format:{"code-block":!0},handler:function(e){var n=T.default.query("code-block"),r=e.index,o=e.length,i=this.quill.scroll.descendant(n,r),l=b(i,2),a=l[0],s=l[1];if(null!=a){var u=this.quill.getIndex(a),c=a.newlineIndex(s,!0)+1,f=a.newlineIndex(u+s+o),h=a.domNode.textContent.slice(c,f).split("\n");s=0,h.forEach(function(e,i){t?(a.insertAt(c+s,n.TAB),s+=n.TAB.length,0===i?r+=n.TAB.length:o+=n.TAB.length):e.startsWith(n.TAB)&&(a.deleteAt(c+s,n.TAB.length),s-=n.TAB.length,0===i?r-=n.TAB.length:o-=n.TAB.length),s+=e.length+1}),this.quill.update(S.default.sources.USER),this.quill.setSelection(r,o,S.default.sources.SILENT)}}}}function d(t){return{key:t[0].toUpperCase(),shortKey:!0,handler:function(e,n){this.quill.format(t,!n.format[t],S.default.sources.USER)}}}function y(t){if("string"==typeof t||"number"==typeof t)return y({key:t});if("object"===(void 0===t?"undefined":v(t))&&(t=(0,_.default)(t,!1)),"string"==typeof t.key)if(null!=D.keys[t.key.toUpperCase()])t.key=D.keys[t.key.toUpperCase()];else{if(1!==t.key.length)return null;t.key=t.key.toUpperCase().charCodeAt(0)}return t.shortKey&&(t[B]=t.shortKey,delete t.shortKey),t}Object.defineProperty(e,"__esModule",{value:!0}),e.SHORTKEY=e.default=void 0;var v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},b=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),g=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m=n(21),_=r(m),O=n(12),w=r(O),x=n(2),k=r(x),E=n(4),N=r(E),j=n(20),A=r(j),q=n(0),T=r(q),P=n(6),S=r(P),C=n(10),L=r(C),M=n(7),R=r(M),I=(0,L.default)("quill:keyboard"),B=/Mac/i.test(navigator.platform)?"metaKey":"ctrlKey",D=function(t){function e(t,n){i(this,e);var r=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.bindings={},Object.keys(r.options.bindings).forEach(function(e){("list autofill"!==e||null==t.scroll.whitelist||t.scroll.whitelist.list)&&r.options.bindings[e]&&r.addBinding(r.options.bindings[e])}),r.addBinding({key:e.keys.ENTER,shiftKey:null},h),r.addBinding({key:e.keys.ENTER,metaKey:null,ctrlKey:null,altKey:null},function(){}),/Firefox/i.test(navigator.userAgent)?(r.addBinding({key:e.keys.BACKSPACE},{collapsed:!0},u),r.addBinding({key:e.keys.DELETE},{collapsed:!0},c)):(r.addBinding({key:e.keys.BACKSPACE},{collapsed:!0,prefix:/^.?$/},u),r.addBinding({key:e.keys.DELETE},{collapsed:!0,suffix:/^.?$/},c)),r.addBinding({key:e.keys.BACKSPACE},{collapsed:!1},f),r.addBinding({key:e.keys.DELETE},{collapsed:!1},f),r.addBinding({key:e.keys.BACKSPACE,altKey:null,ctrlKey:null,metaKey:null,shiftKey:null},{collapsed:!0,offset:0},u),r.listen(),r}return a(e,t),g(e,null,[{key:"match",value:function(t,e){return e=y(e),!["altKey","ctrlKey","metaKey","shiftKey"].some(function(n){return!!e[n]!==t[n]&&null!==e[n]})&&e.key===(t.which||t.keyCode)}}]),g(e,[{key:"addBinding",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=y(t);if(null==r||null==r.key)return I.warn("Attempted to add invalid keyboard binding",r);"function"==typeof e&&(e={handler:e}),"function"==typeof n&&(n={handler:n}),r=(0,k.default)(r,e,n),this.bindings[r.key]=this.bindings[r.key]||[],this.bindings[r.key].push(r)}},{key:"listen",value:function(){var t=this;this.quill.root.addEventListener("keydown",function(n){if(!n.defaultPrevented){var r=n.which||n.keyCode,o=(t.bindings[r]||[]).filter(function(t){return e.match(n,t)});if(0!==o.length){var i=t.quill.getSelection();if(null!=i&&t.quill.hasFocus()){var l=t.quill.getLine(i.index),a=b(l,2),s=a[0],u=a[1],c=t.quill.getLeaf(i.index),f=b(c,2),h=f[0],p=f[1],d=0===i.length?[h,p]:t.quill.getLeaf(i.index+i.length),y=b(d,2),g=y[0],m=y[1],_=h instanceof T.default.Text?h.value().slice(0,p):"",O=g instanceof T.default.Text?g.value().slice(m):"",x={collapsed:0===i.length,empty:0===i.length&&s.length()<=1,format:t.quill.getFormat(i),offset:u,prefix:_,suffix:O};o.some(function(e){if(null!=e.collapsed&&e.collapsed!==x.collapsed)return!1;if(null!=e.empty&&e.empty!==x.empty)return!1;if(null!=e.offset&&e.offset!==x.offset)return!1;if(Array.isArray(e.format)){if(e.format.every(function(t){return null==x.format[t]}))return!1}else if("object"===v(e.format)&&!Object.keys(e.format).every(function(t){return!0===e.format[t]?null!=x.format[t]:!1===e.format[t]?null==x.format[t]:(0,w.default)(e.format[t],x.format[t])}))return!1;return!(null!=e.prefix&&!e.prefix.test(x.prefix))&&(!(null!=e.suffix&&!e.suffix.test(x.suffix))&&!0!==e.handler.call(t,i,x))})&&n.preventDefault()}}}})}}]),e}(R.default);D.keys={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46},D.DEFAULTS={bindings:{bold:d("bold"),italic:d("italic"),underline:d("underline"),indent:{key:D.keys.TAB,format:["blockquote","indent","list"],handler:function(t,e){if(e.collapsed&&0!==e.offset)return!0;this.quill.format("indent","+1",S.default.sources.USER)}},outdent:{key:D.keys.TAB,shiftKey:!0,format:["blockquote","indent","list"],handler:function(t,e){if(e.collapsed&&0!==e.offset)return!0;this.quill.format("indent","-1",S.default.sources.USER)}},"outdent backspace":{key:D.keys.BACKSPACE,collapsed:!0,shiftKey:null,metaKey:null,ctrlKey:null,altKey:null,format:["indent","list"],offset:0,handler:function(t,e){null!=e.format.indent?this.quill.format("indent","-1",S.default.sources.USER):null!=e.format.list&&this.quill.format("list",!1,S.default.sources.USER)}},"indent code-block":p(!0),"outdent code-block":p(!1),"remove tab":{key:D.keys.TAB,shiftKey:!0,collapsed:!0,prefix:/\t$/,handler:function(t){this.quill.deleteText(t.index-1,1,S.default.sources.USER)}},tab:{key:D.keys.TAB,handler:function(t){this.quill.history.cutoff();var e=(new N.default).retain(t.index).delete(t.length).insert("\t");this.quill.updateContents(e,S.default.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(t.index+1,S.default.sources.SILENT)}},"list empty enter":{key:D.keys.ENTER,collapsed:!0,format:["list"],empty:!0,handler:function(t,e){this.quill.format("list",!1,S.default.sources.USER),e.format.indent&&this.quill.format("indent",!1,S.default.sources.USER)}},"checklist enter":{key:D.keys.ENTER,collapsed:!0,format:{list:"checked"},handler:function(t){var e=this.quill.getLine(t.index),n=b(e,2),r=n[0],o=n[1],i=(0,k.default)({},r.formats(),{list:"checked"}),l=(new N.default).retain(t.index).insert("\n",i).retain(r.length()-o-1).retain(1,{list:"unchecked"});this.quill.updateContents(l,S.default.sources.USER),this.quill.setSelection(t.index+1,S.default.sources.SILENT),this.quill.scrollIntoView()}},"header enter":{key:D.keys.ENTER,collapsed:!0,format:["header"],suffix:/^$/,handler:function(t,e){var n=this.quill.getLine(t.index),r=b(n,2),o=r[0],i=r[1],l=(new N.default).retain(t.index).insert("\n",e.format).retain(o.length()-i-1).retain(1,{header:null});this.quill.updateContents(l,S.default.sources.USER),this.quill.setSelection(t.index+1,S.default.sources.SILENT),this.quill.scrollIntoView()}},"list autofill":{key:" ",collapsed:!0,format:{list:!1},prefix:/^\s*?(\d+\.|-|\*|\[ ?\]|\[x\])$/,handler:function(t,e){var n=e.prefix.length,r=this.quill.getLine(t.index),o=b(r,2),i=o[0],l=o[1];if(l>n)return!0;var a=void 0;switch(e.prefix.trim()){case"[]":case"[ ]":a="unchecked";break;case"[x]":a="checked";break;case"-":case"*":a="bullet";break;default:a="ordered"}this.quill.insertText(t.index," ",S.default.sources.USER),this.quill.history.cutoff();var s=(new N.default).retain(t.index-l).delete(n+1).retain(i.length()-2-l).retain(1,{list:a});this.quill.updateContents(s,S.default.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(t.index-n,S.default.sources.SILENT)}},"code exit":{key:D.keys.ENTER,collapsed:!0,format:["code-block"],prefix:/\n\n$/,suffix:/^\s+$/,handler:function(t){var e=this.quill.getLine(t.index),n=b(e,2),r=n[0],o=n[1],i=(new N.default).retain(t.index+r.length()-o-2).retain(1,{"code-block":null}).delete(1);this.quill.updateContents(i,S.default.sources.USER)}},"embed left":s(D.keys.LEFT,!1),"embed left shift":s(D.keys.LEFT,!0),"embed right":s(D.keys.RIGHT,!1),"embed right shift":s(D.keys.RIGHT,!0)}},e.default=D,e.SHORTKEY=B},function(t,e,n){"use strict";t.exports={align:{"":n(75),center:n(76),right:n(77),justify:n(78)},background:n(79),blockquote:n(80),bold:n(81),clean:n(82),code:n(40),"code-block":n(40),color:n(83),direction:{"":n(84),rtl:n(85)},float:{center:n(86),full:n(87),left:n(88),right:n(89)},formula:n(90),header:{1:n(91),2:n(92)},italic:n(93),image:n(94),indent:{"+1":n(95),"-1":n(96)},link:n(97),list:{ordered:n(98),bullet:n(99),check:n(100)},script:{sub:n(101),super:n(102)},strike:n(103),underline:n(104),video:n(105)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),o=function(){function t(t){this.domNode=t,this.domNode[r.DATA_KEY]={blot:this}}return Object.defineProperty(t.prototype,"statics",{get:function(){return this.constructor},enumerable:!0,configurable:!0}),t.create=function(t){if(null==this.tagName)throw new r.ParchmentError("Blot definition missing tagName");var e;return Array.isArray(this.tagName)?("string"==typeof t&&(t=t.toUpperCase(),parseInt(t).toString()===t&&(t=parseInt(t))),e="number"==typeof t?document.createElement(this.tagName[t-1]):this.tagName.indexOf(t)>-1?document.createElement(t):document.createElement(this.tagName[0])):e=document.createElement(this.tagName),this.className&&e.classList.add(this.className),e},t.prototype.attach=function(){null!=this.parent&&(this.scroll=this.parent.scroll)},t.prototype.clone=function(){var t=this.domNode.cloneNode(!1);return r.create(t)},t.prototype.detach=function(){null!=this.parent&&this.parent.removeChild(this),delete this.domNode[r.DATA_KEY]},t.prototype.deleteAt=function(t,e){this.isolate(t,e).remove()},t.prototype.formatAt=function(t,e,n,o){var i=this.isolate(t,e);if(null!=r.query(n,r.Scope.BLOT)&&o)i.wrap(n,o);else if(null!=r.query(n,r.Scope.ATTRIBUTE)){var l=r.create(this.statics.scope);i.wrap(l),l.format(n,o)}},t.prototype.insertAt=function(t,e,n){var o=null==n?r.create("text",e):r.create(e,n),i=this.split(t);this.parent.insertBefore(o,i)},t.prototype.insertInto=function(t,e){void 0===e&&(e=null),null!=this.parent&&this.parent.children.remove(this);var n=null;t.children.insertBefore(this,e),null!=e&&(n=e.domNode),this.domNode.parentNode==t.domNode&&this.domNode.nextSibling==n||t.domNode.insertBefore(this.domNode,n),this.parent=t,this.attach()},t.prototype.isolate=function(t,e){var n=this.split(t);return n.split(e),n},t.prototype.length=function(){return 1},t.prototype.offset=function(t){return void 0===t&&(t=this.parent),null==this.parent||this==t?0:this.parent.children.offset(this)+this.parent.offset(t)},t.prototype.optimize=function(t){null!=this.domNode[r.DATA_KEY]&&delete this.domNode[r.DATA_KEY].mutations},t.prototype.remove=function(){null!=this.domNode.parentNode&&this.domNode.parentNode.removeChild(this.domNode),this.detach()},t.prototype.replace=function(t){null!=t.parent&&(t.parent.insertBefore(this,t.next),t.remove())},t.prototype.replaceWith=function(t,e){var n="string"==typeof t?r.create(t,e):t;return n.replace(this),n},t.prototype.split=function(t,e){return 0===t?this:this.next},t.prototype.update=function(t,e){},t.prototype.wrap=function(t,e){var n="string"==typeof t?r.create(t,e):t;return null!=this.parent&&this.parent.insertBefore(n,this.next),n.appendChild(this),n},t.blotName="abstract",t}();e.default=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(11),o=n(29),i=n(30),l=n(1),a=function(){function t(t){this.attributes={},this.domNode=t,this.build()}return t.prototype.attribute=function(t,e){e?t.add(this.domNode,e)&&(null!=t.value(this.domNode)?this.attributes[t.attrName]=t:delete this.attributes[t.attrName]):(t.remove(this.domNode),delete this.attributes[t.attrName])},t.prototype.build=function(){var t=this;this.attributes={};var e=r.default.keys(this.domNode),n=o.default.keys(this.domNode),a=i.default.keys(this.domNode);e.concat(n).concat(a).forEach(function(e){var n=l.query(e,l.Scope.ATTRIBUTE);n instanceof r.default&&(t.attributes[n.attrName]=n)})},t.prototype.copy=function(t){var e=this;Object.keys(this.attributes).forEach(function(n){var r=e.attributes[n].value(e.domNode);t.format(n,r)})},t.prototype.move=function(t){var e=this;this.copy(t),Object.keys(this.attributes).forEach(function(t){e.attributes[t].remove(e.domNode)}),this.attributes={}},t.prototype.values=function(){var t=this;return Object.keys(this.attributes).reduce(function(e,n){return e[n]=t.attributes[n].value(t.domNode),e},{})},t}();e.default=a},function(t,e,n){"use strict";function r(t,e){return(t.getAttribute("class")||"").split(/\s+/).filter(function(t){return 0===t.indexOf(e+"-")})}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(11),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.keys=function(t){return(t.getAttribute("class")||"").split(/\s+/).map(function(t){return t.split("-").slice(0,-1).join("-")})},e.prototype.add=function(t,e){return!!this.canAdd(t,e)&&(this.remove(t),t.classList.add(this.keyName+"-"+e),!0)},e.prototype.remove=function(t){r(t,this.keyName).forEach(function(e){t.classList.remove(e)}),0===t.classList.length&&t.removeAttribute("class")},e.prototype.value=function(t){var e=r(t,this.keyName)[0]||"",n=e.slice(this.keyName.length+1);return this.canAdd(t,n)?n:""},e}(i.default);e.default=l},function(t,e,n){"use strict";function r(t){var e=t.split("-"),n=e.slice(1).map(function(t){return t[0].toUpperCase()+t.slice(1)}).join("");return e[0]+n}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(11),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.keys=function(t){return(t.getAttribute("style")||"").split(";").map(function(t){return t.split(":")[0].trim()})},e.prototype.add=function(t,e){return!!this.canAdd(t,e)&&(t.style[r(this.keyName)]=e,!0)},e.prototype.remove=function(t){t.style[r(this.keyName)]="",t.getAttribute("style")||t.removeAttribute("style")},e.prototype.value=function(t){var e=t.style[r(this.keyName)];return this.canAdd(t,e)?e:""},e}(i.default);e.default=l},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=n(0),f=r(c),h=n(8),p=r(h),d=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.selection=n,r.textNode=document.createTextNode(e.CONTENTS),r.domNode.appendChild(r.textNode),r._length=0,r}return l(e,t),u(e,null,[{key:"value",value:function(){}}]),u(e,[{key:"detach",value:function(){null!=this.parent&&this.parent.removeChild(this)}},{key:"format",value:function(t,n){if(0!==this._length)return s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n);for(var r=this,o=0;null!=r&&r.statics.scope!==f.default.Scope.BLOCK_BLOT;)o+=r.offset(r.parent),r=r.parent;null!=r&&(this._length=e.CONTENTS.length,r.optimize(),r.formatAt(o,e.CONTENTS.length,t,n),this._length=0)}},{key:"index",value:function(t,n){return t===this.textNode?0:s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"index",this).call(this,t,n)}},{key:"length",value:function(){return this._length}},{key:"position",value:function(){return[this.textNode,this.textNode.data.length]}},{key:"remove",value:function(){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"remove",this).call(this),this.parent=null}},{key:"restore",value:function(){if(!this.selection.composing&&null!=this.parent){var t=this.textNode,n=this.selection.getNativeRange(),r=void 0,o=void 0,i=void 0;if(null!=n&&n.start.node===t&&n.end.node===t){var l=[t,n.start.offset,n.end.offset];r=l[0],o=l[1],i=l[2]}for(;null!=this.domNode.lastChild&&this.domNode.lastChild!==this.textNode;)this.domNode.parentNode.insertBefore(this.domNode.lastChild,this.domNode);if(this.textNode.data!==e.CONTENTS){var s=this.textNode.data.split(e.CONTENTS).join("");this.next instanceof p.default?(r=this.next.domNode,this.next.insertAt(0,s),this.textNode.data=e.CONTENTS):(this.textNode.data=s,this.parent.insertBefore(f.default.create(this.textNode),this),this.textNode=document.createTextNode(e.CONTENTS),this.domNode.appendChild(this.textNode))}if(this.remove(),null!=o){var u=[o,i].map(function(t){return Math.max(0,Math.min(r.data.length,t-1))}),c=a(u,2);return o=c[0],i=c[1],{startNode:r,startOffset:o,endNode:r,endOffset:i}}}}},{key:"update",value:function(t,e){var n=this;if(t.some(function(t){return"characterData"===t.type&&t.target===n.textNode})){var r=this.restore();r&&(e.range=r)}}},{key:"value",value:function(){return""}}]),e}(f.default.Embed);d.blotName="cursor",d.className="ql-cursor",d.tagName="span",d.CONTENTS="\ufeff",e.default=d},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=function(){function t(e,n){r(this,t),this.quill=e,this.options=n,this.modules={}}return o(t,[{key:"init",value:function(){var t=this;Object.keys(this.options.modules).forEach(function(e){null==t.modules[e]&&t.addModule(e)})}},{key:"addModule",value:function(t){var e=this.quill.constructor.import("modules/"+t);return this.modules[t]=new e(this.quill,this.options.modules[t]||{}),this.modules[t]}}]),t}();i.DEFAULTS={modules:{}},i.themes={default:i},e.default=i},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(0),c=r(u),f=n(8),h=r(f),p="\ufeff",d=function(t){function e(t){o(this,e);var n=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.contentNode=document.createElement("span"),n.contentNode.setAttribute("contenteditable",!1),[].slice.call(n.domNode.childNodes).forEach(function(t){n.contentNode.appendChild(t)}),n.leftGuard=document.createTextNode(p),n.rightGuard=document.createTextNode(p),n.domNode.appendChild(n.leftGuard),n.domNode.appendChild(n.contentNode),n.domNode.appendChild(n.rightGuard),n}return l(e,t),a(e,[{key:"index",value:function(t,n){return t===this.leftGuard?0:t===this.rightGuard?1:s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"index",this).call(this,t,n)}},{key:"restore",value:function(t){var e=void 0,n=void 0,r=t.data.split(p).join("");if(t===this.leftGuard)if(this.prev instanceof h.default){var o=this.prev.length();this.prev.insertAt(o,r),e={startNode:this.prev.domNode,startOffset:o+r.length}}else n=document.createTextNode(r),this.parent.insertBefore(c.default.create(n),this),e={startNode:n,startOffset:r.length};else t===this.rightGuard&&(this.next instanceof h.default?(this.next.insertAt(0,r),e={startNode:this.next.domNode,startOffset:r.length}):(n=document.createTextNode(r),this.parent.insertBefore(c.default.create(n),this.next),e={startNode:n,startOffset:r.length}));return t.data=p,e}},{key:"update",value:function(t,e){var n=this;t.forEach(function(t){if("characterData"===t.type&&(t.target===n.leftGuard||t.target===n.rightGuard)){var r=n.restore(t.target);r&&(e.range=r)}})}}]),e}(c.default.Embed);e.default=d},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.AlignStyle=e.AlignClass=e.AlignAttribute=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i={scope:o.default.Scope.BLOCK,whitelist:["right","center","justify"]},l=new o.default.Attributor.Attribute("align","align",i),a=new o.default.Attributor.Class("align","ql-align",i),s=new o.default.Attributor.Style("align","text-align",i);e.AlignAttribute=l,e.AlignClass=a,e.AlignStyle=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.BackgroundStyle=e.BackgroundClass=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i=n(24),l=new o.default.Attributor.Class("background","ql-bg",{scope:o.default.Scope.INLINE}),a=new i.ColorAttributor("background","background-color",{scope:o.default.Scope.INLINE});e.BackgroundClass=l,e.BackgroundStyle=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DirectionStyle=e.DirectionClass=e.DirectionAttribute=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i={scope:o.default.Scope.BLOCK,whitelist:["rtl"]},l=new o.default.Attributor.Attribute("direction","dir",i),a=new o.default.Attributor.Class("direction","ql-direction",i),s=new o.default.Attributor.Style("direction","direction",i);e.DirectionAttribute=l,e.DirectionClass=a,e.DirectionStyle=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.FontClass=e.FontStyle=void 0;var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c={scope:u.default.Scope.INLINE,whitelist:["serif","monospace"]},f=new u.default.Attributor.Class("font","ql-font",c),h=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"value",value:function(t){return a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"value",this).call(this,t).replace(/["']/g,"")}}]),e}(u.default.Attributor.Style),p=new h("font","font-family",c);e.FontStyle=p,e.FontClass=f},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SizeStyle=e.SizeClass=void 0;var r=n(0),o=function(t){return t&&t.__esModule?t:{default:t}}(r),i=new o.default.Attributor.Class("size","ql-size",{scope:o.default.Scope.INLINE,whitelist:["small","large","huge"]}),l=new o.default.Attributor.Style("size","font-size",{scope:o.default.Scope.INLINE,whitelist:["10px","18px","32px"]});e.SizeClass=i,e.SizeStyle=l},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(5),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"optimize",value:function(t){a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t),this.domNode.tagName!==this.statics.tagName[0]&&this.replaceWith(this.statics.blotName)}}],[{key:"create",value:function(){return a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this)}},{key:"formats",value:function(){return!0}}]),e}(u.default);c.blotName="bold",c.tagName=["STRONG","B"],e.default=c},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polyline class="ql-even ql-stroke" points="5 7 3 9 5 11"></polyline> <polyline class="ql-even ql-stroke" points="13 7 15 9 13 11"></polyline> <line class=ql-stroke x1=10 x2=8 y1=5 y2=13></line> </svg>'},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(16),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(t,n){r(this,e);var i=o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.label.innerHTML=n,i.container.classList.add("ql-color-picker"),[].slice.call(i.container.querySelectorAll(".ql-picker-item"),0,7).forEach(function(t){t.classList.add("ql-primary")}),i}return i(e,t),l(e,[{key:"buildItem",value:function(t){var n=a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"buildItem",this).call(this,t);return n.style.backgroundColor=t.getAttribute("value")||"",n}},{key:"selectItem",value:function(t,n){a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"selectItem",this).call(this,t,n);var r=this.label.querySelector(".ql-color-label"),o=t?t.getAttribute("data-value")||"":"";r&&("line"===r.tagName?r.style.stroke=o:r.style.fill=o)}}]),e}(u.default);e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(16),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(t,n){r(this,e);var i=o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.container.classList.add("ql-icon-picker"),[].forEach.call(i.container.querySelectorAll(".ql-picker-item"),function(t){t.innerHTML=n[t.getAttribute("data-value")||""]}),i.defaultItem=i.container.querySelector(".ql-selected"),i.selectItem(i.defaultItem),i}return i(e,t),l(e,[{key:"selectItem",value:function(t,n){a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"selectItem",this).call(this,t,n),t=t||this.defaultItem,this.label.innerHTML=t.innerHTML}}]),e}(u.default);e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var o=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),i=function(){function t(e,n){var o=this;r(this,t),this.quill=e,this.boundsContainer=n||document.body,this.root=e.addContainer("ql-tooltip"),this.root.innerHTML=this.constructor.TEMPLATE,this.quill.root===this.quill.scrollingContainer&&this.quill.root.addEventListener("scroll",function(){o.root.style.marginTop=-1*o.quill.root.scrollTop+"px"}),this.hide()}return o(t,[{key:"hide",value:function(){this.root.classList.add("ql-hidden")}},{key:"position",value:function(t){var e=t.left+t.width/2-this.root.offsetWidth/2,n=t.bottom+this.quill.root.scrollTop;this.root.style.left=e+"px",this.root.style.top=n+"px",this.root.classList.remove("ql-flip");var r=this.boundsContainer.getBoundingClientRect(),o=this.root.getBoundingClientRect(),i=0;if(o.right>r.right&&(i=r.right-o.right,this.root.style.left=e+i+"px"),o.left<r.left&&(i=r.left-o.left,this.root.style.left=e+i+"px"),o.bottom>r.bottom){var l=o.bottom-o.top,a=t.bottom-t.top+l;this.root.style.top=n-a+"px",this.root.classList.add("ql-flip")}return i}},{key:"show",value:function(){this.root.classList.remove("ql-editing"),this.root.classList.remove("ql-hidden")}}]),t}();e.default=i},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){var e=t.match(/^(?:(https?):\/\/)?(?:(?:www|m)\.)?youtube\.com\/watch.*v=([a-zA-Z0-9_-]+)/)||t.match(/^(?:(https?):\/\/)?(?:(?:www|m)\.)?youtu\.be\/([a-zA-Z0-9_-]+)/);return e?(e[1]||"https")+"://www.youtube.com/embed/"+e[2]+"?showinfo=0":(e=t.match(/^(?:(https?):\/\/)?(?:www\.)?vimeo\.com\/(\d+)/))?(e[1]||"https")+"://player.vimeo.com/video/"+e[2]+"/":t}function s(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];e.forEach(function(e){var r=document.createElement("option");e===n?r.setAttribute("selected","selected"):r.setAttribute("value",e),t.appendChild(r)})}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.BaseTooltip=void 0;var u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},f=n(2),h=r(f),p=n(4),d=r(p),y=n(9),v=r(y),b=n(25),g=r(b),m=n(32),_=r(m),O=n(41),w=r(O),x=n(42),k=r(x),E=n(16),N=r(E),j=n(43),A=r(j),q=[!1,"center","right","justify"],T=["#000000","#e60000","#ff9900","#ffff00","#008a00","#0066cc","#9933ff","#ffffff","#facccc","#ffebcc","#ffffcc","#cce8cc","#cce0f5","#ebd6ff","#bbbbbb","#f06666","#ffc266","#ffff66","#66b966","#66a3e0","#c285ff","#888888","#a10000","#b26b00","#b2b200","#006100","#0047b2","#6b24b2","#444444","#5c0000","#663d00","#666600","#003700","#002966","#3d1466"],P=[!1,"serif","monospace"],S=["1","2","3",!1],C=["small",!1,"large","huge"],L=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n)),l=function e(n){if(!document.body.contains(t.root))return document.body.removeEventListener("click",e);null==r.tooltip||r.tooltip.root.contains(n.target)||document.activeElement===r.tooltip.textbox||r.quill.hasFocus()||r.tooltip.hide(),null!=r.pickers&&r.pickers.forEach(function(t){t.container.contains(n.target)||t.close()})};return t.emitter.listenDOM("click",document.body,l),r}return l(e,t),u(e,[{key:"addModule",value:function(t){var n=c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"addModule",this).call(this,t);return"toolbar"===t&&this.extendToolbar(n),n}},{key:"buildButtons",value:function(t,e){t.forEach(function(t){(t.getAttribute("class")||"").split(/\s+/).forEach(function(n){if(n.startsWith("ql-")&&(n=n.slice("ql-".length),null!=e[n]))if("direction"===n)t.innerHTML=e[n][""]+e[n].rtl;else if("string"==typeof e[n])t.innerHTML=e[n];else{var r=t.value||"";null!=r&&e[n][r]&&(t.innerHTML=e[n][r])}})})}},{key:"buildPickers",value:function(t,e){var n=this;this.pickers=t.map(function(t){if(t.classList.contains("ql-align"))return null==t.querySelector("option")&&s(t,q),new k.default(t,e.align);if(t.classList.contains("ql-background")||t.classList.contains("ql-color")){var n=t.classList.contains("ql-background")?"background":"color";return null==t.querySelector("option")&&s(t,T,"background"===n?"#ffffff":"#000000"),new w.default(t,e[n])}return null==t.querySelector("option")&&(t.classList.contains("ql-font")?s(t,P):t.classList.contains("ql-header")?s(t,S):t.classList.contains("ql-size")&&s(t,C)),new N.default(t)});var r=function(){n.pickers.forEach(function(t){t.update()})};this.quill.on(v.default.events.EDITOR_CHANGE,r)}}]),e}(_.default);L.DEFAULTS=(0,h.default)(!0,{},_.default.DEFAULTS,{modules:{toolbar:{handlers:{formula:function(){this.quill.theme.tooltip.edit("formula")},image:function(){var t=this,e=this.container.querySelector("input.ql-image[type=file]");null==e&&(e=document.createElement("input"),e.setAttribute("type","file"),e.setAttribute("accept","image/png, image/gif, image/jpeg, image/bmp, image/x-icon"),e.classList.add("ql-image"),e.addEventListener("change",function(){if(null!=e.files&&null!=e.files[0]){var n=new FileReader;n.onload=function(n){var r=t.quill.getSelection(!0);t.quill.updateContents((new d.default).retain(r.index).delete(r.length).insert({image:n.target.result}),v.default.sources.USER),t.quill.setSelection(r.index+1,v.default.sources.SILENT),e.value=""},n.readAsDataURL(e.files[0])}}),this.container.appendChild(e)),e.click()},video:function(){this.quill.theme.tooltip.edit("video")}}}}});var M=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.textbox=r.root.querySelector('input[type="text"]'),r.listen(),r}return l(e,t),u(e,[{key:"listen",value:function(){var t=this;this.textbox.addEventListener("keydown",function(e){g.default.match(e,"enter")?(t.save(),e.preventDefault()):g.default.match(e,"escape")&&(t.cancel(),e.preventDefault())})}},{key:"cancel",value:function(){this.hide()}},{key:"edit",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"link",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.root.classList.remove("ql-hidden"),this.root.classList.add("ql-editing"),null!=e?this.textbox.value=e:t!==this.root.getAttribute("data-mode")&&(this.textbox.value=""),this.position(this.quill.getBounds(this.quill.selection.savedRange)),this.textbox.select(),this.textbox.setAttribute("placeholder",this.textbox.getAttribute("data-"+t)||""),this.root.setAttribute("data-mode",t)}},{key:"restoreFocus",value:function(){var t=this.quill.scrollingContainer.scrollTop;this.quill.focus(),this.quill.scrollingContainer.scrollTop=t}},{key:"save",value:function(){var t=this.textbox.value;switch(this.root.getAttribute("data-mode")){case"link":var e=this.quill.root.scrollTop;this.linkRange?(this.quill.formatText(this.linkRange,"link",t,v.default.sources.USER),delete this.linkRange):(this.restoreFocus(),this.quill.format("link",t,v.default.sources.USER)),this.quill.root.scrollTop=e;break;case"video":t=a(t);case"formula":if(!t)break;var n=this.quill.getSelection(!0);if(null!=n){var r=n.index+n.length;this.quill.insertEmbed(r,this.root.getAttribute("data-mode"),t,v.default.sources.USER),"formula"===this.root.getAttribute("data-mode")&&this.quill.insertText(r+1," ",v.default.sources.USER),this.quill.setSelection(r+2,v.default.sources.USER)}}this.textbox.value="",this.hide()}}]),e}(A.default);e.BaseTooltip=M,e.default=L},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var o=n(46),i=r(o),l=n(34),a=n(36),s=n(62),u=n(63),c=r(u),f=n(64),h=r(f),p=n(65),d=r(p),y=n(35),v=n(24),b=n(37),g=n(38),m=n(39),_=r(m),O=n(66),w=r(O),x=n(15),k=r(x),E=n(67),N=r(E),j=n(68),A=r(j),q=n(69),T=r(q),P=n(70),S=r(P),C=n(71),L=r(C),M=n(13),R=r(M),I=n(72),B=r(I),D=n(73),U=r(D),F=n(74),H=r(F),K=n(26),z=r(K),Z=n(16),V=r(Z),W=n(41),G=r(W),Y=n(42),X=r(Y),$=n(43),Q=r($),J=n(107),tt=r(J),et=n(108),nt=r(et);i.default.register({"attributors/attribute/direction":a.DirectionAttribute,"attributors/class/align":l.AlignClass,"attributors/class/background":y.BackgroundClass,"attributors/class/color":v.ColorClass,"attributors/class/direction":a.DirectionClass,"attributors/class/font":b.FontClass,"attributors/class/size":g.SizeClass,"attributors/style/align":l.AlignStyle,"attributors/style/background":y.BackgroundStyle,"attributors/style/color":v.ColorStyle,"attributors/style/direction":a.DirectionStyle,"attributors/style/font":b.FontStyle,"attributors/style/size":g.SizeStyle},!0),i.default.register({"formats/align":l.AlignClass,"formats/direction":a.DirectionClass,"formats/indent":s.IndentClass,"formats/background":y.BackgroundStyle,"formats/color":v.ColorStyle,"formats/font":b.FontClass,"formats/size":g.SizeClass,"formats/blockquote":c.default,"formats/code-block":R.default,"formats/header":h.default,"formats/list":d.default,"formats/bold":_.default,"formats/code":M.Code,"formats/italic":w.default,"formats/link":k.default,"formats/script":N.default,"formats/strike":A.default,"formats/underline":T.default,"formats/image":S.default,"formats/video":L.default,"formats/list/item":p.ListItem,"modules/formula":B.default,"modules/syntax":U.default,"modules/toolbar":H.default,"themes/bubble":tt.default,"themes/snow":nt.default,"ui/icons":z.default,"ui/picker":V.default,"ui/icon-picker":X.default,"ui/color-picker":G.default,"ui/tooltip":Q.default},!0),e.default=i.default},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var o=n(0),i=r(o),l=n(6),a=r(l),s=n(3),u=r(s),c=n(14),f=r(c),h=n(23),p=r(h),d=n(31),y=r(d),v=n(33),b=r(v),g=n(5),m=r(g),_=n(59),O=r(_),w=n(8),x=r(w),k=n(60),E=r(k),N=n(61),j=r(N),A=n(25),q=r(A);a.default.register({"blots/block":u.default,"blots/block/embed":s.BlockEmbed,"blots/break":f.default,"blots/container":p.default,"blots/cursor":y.default,"blots/embed":b.default,"blots/inline":m.default,"blots/scroll":O.default,"blots/text":x.default,"modules/clipboard":E.default,"modules/history":j.default,"modules/keyboard":q.default}),i.default.register(u.default,f.default,y.default,m.default,O.default,x.default),e.default=a.default},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(){this.head=this.tail=null,this.length=0}return t.prototype.append=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.insertBefore(t[0],null),t.length>1&&this.append.apply(this,t.slice(1))},t.prototype.contains=function(t){for(var e,n=this.iterator();e=n();)if(e===t)return!0;return!1},t.prototype.insertBefore=function(t,e){t&&(t.next=e,null!=e?(t.prev=e.prev,null!=e.prev&&(e.prev.next=t),e.prev=t,e===this.head&&(this.head=t)):null!=this.tail?(this.tail.next=t,t.prev=this.tail,this.tail=t):(t.prev=null,this.head=this.tail=t),this.length+=1)},t.prototype.offset=function(t){for(var e=0,n=this.head;null!=n;){if(n===t)return e;e+=n.length(),n=n.next}return-1},t.prototype.remove=function(t){this.contains(t)&&(null!=t.prev&&(t.prev.next=t.next),null!=t.next&&(t.next.prev=t.prev),t===this.head&&(this.head=t.next),t===this.tail&&(this.tail=t.prev),this.length-=1)},t.prototype.iterator=function(t){return void 0===t&&(t=this.head),function(){var e=t;return null!=t&&(t=t.next),e}},t.prototype.find=function(t,e){void 0===e&&(e=!1);for(var n,r=this.iterator();n=r();){var o=n.length();if(t<o||e&&t===o&&(null==n.next||0!==n.next.length()))return[n,t];t-=o}return[null,0]},t.prototype.forEach=function(t){for(var e,n=this.iterator();e=n();)t(e)},t.prototype.forEachAt=function(t,e,n){if(!(e<=0))for(var r,o=this.find(t),i=o[0],l=o[1],a=t-l,s=this.iterator(i);(r=s())&&a<t+e;){var u=r.length();t>a?n(r,t-a,Math.min(e,a+u-t)):n(r,0,Math.min(u,t+e-a)),a+=u}},t.prototype.map=function(t){return this.reduce(function(e,n){return e.push(t(n)),e},[])},t.prototype.reduce=function(t,e){for(var n,r=this.iterator();n=r();)e=t(e,n);return e},t}();e.default=r},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(17),i=n(1),l={attributes:!0,characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0},a=function(t){function e(e){var n=t.call(this,e)||this;return n.scroll=n,n.observer=new MutationObserver(function(t){n.update(t)}),n.observer.observe(n.domNode,l),n.attach(),n}return r(e,t),e.prototype.detach=function(){t.prototype.detach.call(this),this.observer.disconnect()},e.prototype.deleteAt=function(e,n){this.update(),0===e&&n===this.length()?this.children.forEach(function(t){t.remove()}):t.prototype.deleteAt.call(this,e,n)},e.prototype.formatAt=function(e,n,r,o){this.update(),t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.insertAt=function(e,n,r){this.update(),t.prototype.insertAt.call(this,e,n,r)},e.prototype.optimize=function(e,n){var r=this;void 0===e&&(e=[]),void 0===n&&(n={}),t.prototype.optimize.call(this,n);for(var l=[].slice.call(this.observer.takeRecords());l.length>0;)e.push(l.pop());for(var a=function(t,e){void 0===e&&(e=!0),null!=t&&t!==r&&null!=t.domNode.parentNode&&(null==t.domNode[i.DATA_KEY].mutations&&(t.domNode[i.DATA_KEY].mutations=[]),e&&a(t.parent))},s=function(t){null!=t.domNode[i.DATA_KEY]&&null!=t.domNode[i.DATA_KEY].mutations&&(t instanceof o.default&&t.children.forEach(s),t.optimize(n))},u=e,c=0;u.length>0;c+=1){if(c>=100)throw new Error("[Parchment] Maximum optimize iterations reached");for(u.forEach(function(t){var e=i.find(t.target,!0);null!=e&&(e.domNode===t.target&&("childList"===t.type?(a(i.find(t.previousSibling,!1)),[].forEach.call(t.addedNodes,function(t){var e=i.find(t,!1);a(e,!1),e instanceof o.default&&e.children.forEach(function(t){a(t,!1)})})):"attributes"===t.type&&a(e.prev)),a(e))}),this.children.forEach(s),u=[].slice.call(this.observer.takeRecords()),l=u.slice();l.length>0;)e.push(l.pop())}},e.prototype.update=function(e,n){var r=this;void 0===n&&(n={}),e=e||this.observer.takeRecords(),e.map(function(t){var e=i.find(t.target,!0);return null==e?null:null==e.domNode[i.DATA_KEY].mutations?(e.domNode[i.DATA_KEY].mutations=[t],e):(e.domNode[i.DATA_KEY].mutations.push(t),null)}).forEach(function(t){null!=t&&t!==r&&null!=t.domNode[i.DATA_KEY]&&t.update(t.domNode[i.DATA_KEY].mutations||[],n)}),null!=this.domNode[i.DATA_KEY].mutations&&t.prototype.update.call(this,this.domNode[i.DATA_KEY].mutations,n),this.optimize(e,n)},e.blotName="scroll",e.defaultChild="block",e.scope=i.Scope.BLOCK_BLOT,e.tagName="DIV",e}(o.default);e.default=a},function(t,e,n){"use strict";function r(t,e){if(Object.keys(t).length!==Object.keys(e).length)return!1;for(var n in t)if(t[n]!==e[n])return!1;return!0}var o=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var i=n(18),l=n(1),a=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e.formats=function(n){if(n.tagName!==e.tagName)return t.formats.call(this,n)},e.prototype.format=function(n,r){var o=this;n!==this.statics.blotName||r?t.prototype.format.call(this,n,r):(this.children.forEach(function(t){t instanceof i.default||(t=t.wrap(e.blotName,!0)),o.attributes.copy(t)}),this.unwrap())},e.prototype.formatAt=function(e,n,r,o){if(null!=this.formats()[r]||l.query(r,l.Scope.ATTRIBUTE)){this.isolate(e,n).format(r,o)}else t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.optimize=function(n){t.prototype.optimize.call(this,n);var o=this.formats();if(0===Object.keys(o).length)return this.unwrap();var i=this.next;i instanceof e&&i.prev===this&&r(o,i.formats())&&(i.moveChildren(this),i.remove())},e.blotName="inline",e.scope=l.Scope.INLINE_BLOT,e.tagName="SPAN",e}(i.default);e.default=a},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(18),i=n(1),l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.formats=function(n){var r=i.query(e.blotName).tagName;if(n.tagName!==r)return t.formats.call(this,n)},e.prototype.format=function(n,r){null!=i.query(n,i.Scope.BLOCK)&&(n!==this.statics.blotName||r?t.prototype.format.call(this,n,r):this.replaceWith(e.blotName))},e.prototype.formatAt=function(e,n,r,o){null!=i.query(r,i.Scope.BLOCK)?this.format(r,o):t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.insertAt=function(e,n,r){if(null==r||null!=i.query(n,i.Scope.INLINE))t.prototype.insertAt.call(this,e,n,r);else{var o=this.split(e),l=i.create(n,r);o.parent.insertBefore(l,o)}},e.prototype.update=function(e,n){navigator.userAgent.match(/Trident/)?this.build():t.prototype.update.call(this,e,n)},e.blotName="block",e.scope=i.Scope.BLOCK_BLOT,e.tagName="P",e}(o.default);e.default=l},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(19),i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.formats=function(t){},e.prototype.format=function(e,n){t.prototype.formatAt.call(this,0,this.length(),e,n)},e.prototype.formatAt=function(e,n,r,o){0===e&&n===this.length()?this.format(r,o):t.prototype.formatAt.call(this,e,n,r,o)},e.prototype.formats=function(){return this.statics.formats(this.domNode)},e}(o.default);e.default=i},function(t,e,n){"use strict";var r=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(e,"__esModule",{value:!0});var o=n(19),i=n(1),l=function(t){function e(e){var n=t.call(this,e)||this;return n.text=n.statics.value(n.domNode),n}return r(e,t),e.create=function(t){return document.createTextNode(t)},e.value=function(t){var e=t.data;return e.normalize&&(e=e.normalize()),e},e.prototype.deleteAt=function(t,e){this.domNode.data=this.text=this.text.slice(0,t)+this.text.slice(t+e)},e.prototype.index=function(t,e){return this.domNode===t?e:-1},e.prototype.insertAt=function(e,n,r){null==r?(this.text=this.text.slice(0,e)+n+this.text.slice(e),this.domNode.data=this.text):t.prototype.insertAt.call(this,e,n,r)},e.prototype.length=function(){return this.text.length},e.prototype.optimize=function(n){t.prototype.optimize.call(this,n),this.text=this.statics.value(this.domNode),0===this.text.length?this.remove():this.next instanceof e&&this.next.prev===this&&(this.insertAt(this.length(),this.next.value()),this.next.remove())},e.prototype.position=function(t,e){return void 0===e&&(e=!1),[this.domNode,t]},e.prototype.split=function(t,e){if(void 0===e&&(e=!1),!e){if(0===t)return this;if(t===this.length())return this.next}var n=i.create(this.domNode.splitText(t));return this.parent.insertBefore(n,this.next),this.text=this.statics.value(this.domNode),n},e.prototype.update=function(t,e){var n=this;t.some(function(t){return"characterData"===t.type&&t.target===n.domNode})&&(this.text=this.statics.value(this.domNode))},e.prototype.value=function(){return this.text},e.blotName="text",e.scope=i.Scope.INLINE_BLOT,e}(o.default);e.default=l},function(t,e,n){"use strict";var r=document.createElement("div");if(r.classList.toggle("test-class",!1),r.classList.contains("test-class")){var o=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(t,e){return arguments.length>1&&!this.contains(t)==!e?e:o.call(this,t)}}String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return e=e||0,this.substr(e,t.length)===t}),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){var n=this.toString();("number"!=typeof e||!isFinite(e)||Math.floor(e)!==e||e>n.length)&&(e=n.length),e-=t.length;var r=n.indexOf(t,e);return-1!==r&&r===e}),Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,n=Object(this),r=n.length>>>0,o=arguments[1],i=0;i<r;i++)if(e=n[i],t.call(o,e,i,n))return e}}),document.addEventListener("DOMContentLoaded",function(){document.execCommand("enableObjectResizing",!1,!1),document.execCommand("autoUrlDetect",!1,!1)})},function(t,e){function n(t,e,n){if(t==e)return t?[[v,t]]:[];(n<0||t.length<n)&&(n=null);var o=l(t,e),i=t.substring(0,o);t=t.substring(o),e=e.substring(o),o=a(t,e);var s=t.substring(t.length-o);t=t.substring(0,t.length-o),e=e.substring(0,e.length-o);var c=r(t,e);return i&&c.unshift([v,i]),s&&c.push([v,s]),u(c),null!=n&&(c=f(c,n)),c=h(c)}function r(t,e){var r;if(!t)return[[y,e]];if(!e)return[[d,t]];var i=t.length>e.length?t:e,l=t.length>e.length?e:t,a=i.indexOf(l);if(-1!=a)return r=[[y,i.substring(0,a)],[v,l],[y,i.substring(a+l.length)]],t.length>e.length&&(r[0][0]=r[2][0]=d),r;if(1==l.length)return[[d,t],[y,e]];var u=s(t,e);if(u){var c=u[0],f=u[1],h=u[2],p=u[3],b=u[4],g=n(c,h),m=n(f,p);return g.concat([[v,b]],m)}return o(t,e)}function o(t,e){for(var n=t.length,r=e.length,o=Math.ceil((n+r)/2),l=o,a=2*o,s=new Array(a),u=new Array(a),c=0;c<a;c++)s[c]=-1,u[c]=-1;s[l+1]=0,u[l+1]=0;for(var f=n-r,h=f%2!=0,p=0,v=0,b=0,g=0,m=0;m<o;m++){for(var _=-m+p;_<=m-v;_+=2){var O,w=l+_;O=_==-m||_!=m&&s[w-1]<s[w+1]?s[w+1]:s[w-1]+1;for(var x=O-_;O<n&&x<r&&t.charAt(O)==e.charAt(x);)O++,x++;if(s[w]=O,O>n)v+=2;else if(x>r)p+=2;else if(h){var k=l+f-_;if(k>=0&&k<a&&-1!=u[k]){var E=n-u[k];if(O>=E)return i(t,e,O,x)}}}for(var N=-m+b;N<=m-g;N+=2){var E,k=l+N;E=N==-m||N!=m&&u[k-1]<u[k+1]?u[k+1]:u[k-1]+1;for(var j=E-N;E<n&&j<r&&t.charAt(n-E-1)==e.charAt(r-j-1);)E++,j++;if(u[k]=E,E>n)g+=2;else if(j>r)b+=2;else if(!h){var w=l+f-N;if(w>=0&&w<a&&-1!=s[w]){var O=s[w],x=l+O-w;if(E=n-E,O>=E)return i(t,e,O,x)}}}}return[[d,t],[y,e]]}function i(t,e,r,o){var i=t.substring(0,r),l=e.substring(0,o),a=t.substring(r),s=e.substring(o),u=n(i,l),c=n(a,s);return u.concat(c)}function l(t,e){if(!t||!e||t.charAt(0)!=e.charAt(0))return 0;for(var n=0,r=Math.min(t.length,e.length),o=r,i=0;n<o;)t.substring(i,o)==e.substring(i,o)?(n=o,i=n):r=o,o=Math.floor((r-n)/2+n);return o}function a(t,e){if(!t||!e||t.charAt(t.length-1)!=e.charAt(e.length-1))return 0;for(var n=0,r=Math.min(t.length,e.length),o=r,i=0;n<o;)t.substring(t.length-o,t.length-i)==e.substring(e.length-o,e.length-i)?(n=o,i=n):r=o,o=Math.floor((r-n)/2+n);return o}function s(t,e){function n(t,e,n){for(var r,o,i,s,u=t.substring(n,n+Math.floor(t.length/4)),c=-1,f="";-1!=(c=e.indexOf(u,c+1));){var h=l(t.substring(n),e.substring(c)),p=a(t.substring(0,n),e.substring(0,c));f.length<p+h&&(f=e.substring(c-p,c)+e.substring(c,c+h),r=t.substring(0,n-p),o=t.substring(n+h),i=e.substring(0,c-p),s=e.substring(c+h))}return 2*f.length>=t.length?[r,o,i,s,f]:null}var r=t.length>e.length?t:e,o=t.length>e.length?e:t;if(r.length<4||2*o.length<r.length)return null;var i,s=n(r,o,Math.ceil(r.length/4)),u=n(r,o,Math.ceil(r.length/2));if(!s&&!u)return null;i=u?s&&s[4].length>u[4].length?s:u:s;var c,f,h,p;return t.length>e.length?(c=i[0],f=i[1],h=i[2],p=i[3]):(h=i[0],p=i[1],c=i[2],f=i[3]),[c,f,h,p,i[4]]}function u(t){t.push([v,""]);for(var e,n=0,r=0,o=0,i="",s="";n<t.length;)switch(t[n][0]){case y:o++,s+=t[n][1],n++;break;case d:r++,i+=t[n][1],n++;break;case v:r+o>1?(0!==r&&0!==o&&(e=l(s,i),0!==e&&(n-r-o>0&&t[n-r-o-1][0]==v?t[n-r-o-1][1]+=s.substring(0,e):(t.splice(0,0,[v,s.substring(0,e)]),n++),s=s.substring(e),i=i.substring(e)),0!==(e=a(s,i))&&(t[n][1]=s.substring(s.length-e)+t[n][1],s=s.substring(0,s.length-e),i=i.substring(0,i.length-e))),0===r?t.splice(n-o,r+o,[y,s]):0===o?t.splice(n-r,r+o,[d,i]):t.splice(n-r-o,r+o,[d,i],[y,s]),n=n-r-o+(r?1:0)+(o?1:0)+1):0!==n&&t[n-1][0]==v?(t[n-1][1]+=t[n][1],t.splice(n,1)):n++,o=0,r=0,i="",s=""}""===t[t.length-1][1]&&t.pop();var c=!1;for(n=1;n<t.length-1;)t[n-1][0]==v&&t[n+1][0]==v&&(t[n][1].substring(t[n][1].length-t[n-1][1].length)==t[n-1][1]?(t[n][1]=t[n-1][1]+t[n][1].substring(0,t[n][1].length-t[n-1][1].length),t[n+1][1]=t[n-1][1]+t[n+1][1],t.splice(n-1,1),c=!0):t[n][1].substring(0,t[n+1][1].length)==t[n+1][1]&&(t[n-1][1]+=t[n+1][1],t[n][1]=t[n][1].substring(t[n+1][1].length)+t[n+1][1],t.splice(n+1,1),c=!0)),n++;c&&u(t)}function c(t,e){if(0===e)return[v,t];for(var n=0,r=0;r<t.length;r++){var o=t[r];if(o[0]===d||o[0]===v){var i=n+o[1].length;if(e===i)return[r+1,t];if(e<i){t=t.slice();var l=e-n,a=[o[0],o[1].slice(0,l)],s=[o[0],o[1].slice(l)];return t.splice(r,1,a,s),[r+1,t]}n=i}}throw new Error("cursor_pos is out of bounds!")}function f(t,e){var n=c(t,e),r=n[1],o=n[0],i=r[o],l=r[o+1];if(null==i)return t;if(i[0]!==v)return t;if(null!=l&&i[1]+l[1]===l[1]+i[1])return r.splice(o,2,l,i),p(r,o,2);if(null!=l&&0===l[1].indexOf(i[1])){r.splice(o,2,[l[0],i[1]],[0,i[1]]);var a=l[1].slice(i[1].length);return a.length>0&&r.splice(o+2,0,[l[0],a]),p(r,o,3)}return t}function h(t){for(var e=!1,n=function(t){return t.charCodeAt(0)>=56320&&t.charCodeAt(0)<=57343},r=2;r<t.length;r+=1)t[r-2][0]===v&&function(t){return t.charCodeAt(t.length-1)>=55296&&t.charCodeAt(t.length-1)<=56319}(t[r-2][1])&&t[r-1][0]===d&&n(t[r-1][1])&&t[r][0]===y&&n(t[r][1])&&(e=!0,t[r-1][1]=t[r-2][1].slice(-1)+t[r-1][1],t[r][1]=t[r-2][1].slice(-1)+t[r][1],t[r-2][1]=t[r-2][1].slice(0,-1));if(!e)return t;for(var o=[],r=0;r<t.length;r+=1)t[r][1].length>0&&o.push(t[r]);return o}function p(t,e,n){for(var r=e+n-1;r>=0&&r>=e-1;r--)if(r+1<t.length){var o=t[r],i=t[r+1];o[0]===i[1]&&t.splice(r,2,[o[0],o[1]+i[1]])}return t}var d=-1,y=1,v=0,b=n;b.INSERT=y,b.DELETE=d,b.EQUAL=v,t.exports=b},function(t,e){function n(t){var e=[];for(var n in t)e.push(n);return e}e=t.exports="function"==typeof Object.keys?Object.keys:n,e.shim=n},function(t,e){function n(t){return"[object Arguments]"==Object.prototype.toString.call(t)}function r(t){return t&&"object"==typeof t&&"number"==typeof t.length&&Object.prototype.hasOwnProperty.call(t,"callee")&&!Object.prototype.propertyIsEnumerable.call(t,"callee")||!1}var o="[object Arguments]"==function(){return Object.prototype.toString.call(arguments)}();e=t.exports=o?n:r,e.supported=n,e.unsupported=r},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){return Object.keys(e).reduce(function(n,r){return null==t[r]?n:(e[r]===t[r]?n[r]=e[r]:Array.isArray(e[r])?e[r].indexOf(t[r])<0&&(n[r]=e[r].concat([t[r]])):n[r]=[e[r],t[r]],n)},{})}function a(t){return t.reduce(function(t,e){if(1===e.insert){var n=(0,N.default)(e.attributes);return delete n.image,t.insert({image:e.attributes.image},n)}if(null==e.attributes||!0!==e.attributes.list&&!0!==e.attributes.bullet||(e=(0,N.default)(e),e.attributes.list?e.attributes.list="ordered":(e.attributes.list="bullet",delete e.attributes.bullet)),"string"==typeof e.insert){var r=e.insert.replace(/\r\n/g,"\n").replace(/\r/g,"\n");return t.insert(r,e.attributes)}return t.push(e)},new h.default)}Object.defineProperty(e,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),f=n(4),h=r(f),p=n(20),d=r(p),y=n(0),v=r(y),b=n(13),g=r(b),m=n(31),_=r(m),O=n(3),w=r(O),x=n(14),k=r(x),E=n(21),N=r(E),j=n(12),A=r(j),q=n(2),T=r(q),P=/^[ -~]*$/,S=function(){function t(e){i(this,t),this.scroll=e,this.delta=this.getDelta()}return c(t,[{key:"applyDelta",value:function(t){var e=this,n=!1;this.scroll.update();var r=this.scroll.length();return this.scroll.batchStart(),t=a(t),t.reduce(function(t,o){var i=o.retain||o.delete||o.insert.length||1,l=o.attributes||{};if(null!=o.insert){if("string"==typeof o.insert){var a=o.insert;a.endsWith("\n")&&n&&(n=!1,a=a.slice(0,-1)),t>=r&&!a.endsWith("\n")&&(n=!0),e.scroll.insertAt(t,a);var c=e.scroll.line(t),f=u(c,2),h=f[0],p=f[1],y=(0,T.default)({},(0,O.bubbleFormats)(h));if(h instanceof w.default){var b=h.descendant(v.default.Leaf,p),g=u(b,1),m=g[0];y=(0,T.default)(y,(0,O.bubbleFormats)(m))}l=d.default.attributes.diff(y,l)||{}}else if("object"===s(o.insert)){var _=Object.keys(o.insert)[0];if(null==_)return t;e.scroll.insertAt(t,_,o.insert[_])}r+=i}return Object.keys(l).forEach(function(n){e.scroll.formatAt(t,i,n,l[n])}),t+i},0),t.reduce(function(t,n){return"number"==typeof n.delete?(e.scroll.deleteAt(t,n.delete),t):t+(n.retain||n.insert.length||1)},0),this.scroll.batchEnd(),this.update(t)}},{key:"deleteText",value:function(t,e){return this.scroll.deleteAt(t,e),this.update((new h.default).retain(t).delete(e))}},{key:"formatLine",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.scroll.update(),Object.keys(r).forEach(function(o){if(null==n.scroll.whitelist||n.scroll.whitelist[o]){var i=n.scroll.lines(t,Math.max(e,1)),l=e;i.forEach(function(e){var i=e.length();if(e instanceof g.default){var a=t-e.offset(n.scroll),s=e.newlineIndex(a+l)-a+1;e.formatAt(a,s,o,r[o])}else e.format(o,r[o]);l-=i})}}),this.scroll.optimize(),this.update((new h.default).retain(t).retain(e,(0,N.default)(r)))}},{key:"formatText",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Object.keys(r).forEach(function(o){n.scroll.formatAt(t,e,o,r[o])}),this.update((new h.default).retain(t).retain(e,(0,N.default)(r)))}},{key:"getContents",value:function(t,e){return this.delta.slice(t,t+e)}},{key:"getDelta",value:function(){return this.scroll.lines().reduce(function(t,e){return t.concat(e.delta())},new h.default)}},{key:"getFormat",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=[],r=[];0===e?this.scroll.path(t).forEach(function(t){var e=u(t,1),o=e[0];o instanceof w.default?n.push(o):o instanceof v.default.Leaf&&r.push(o)}):(n=this.scroll.lines(t,e),r=this.scroll.descendants(v.default.Leaf,t,e));var o=[n,r].map(function(t){if(0===t.length)return{};for(var e=(0,O.bubbleFormats)(t.shift());Object.keys(e).length>0;){var n=t.shift();if(null==n)return e;e=l((0,O.bubbleFormats)(n),e)}return e});return T.default.apply(T.default,o)}},{key:"getText",value:function(t,e){return this.getContents(t,e).filter(function(t){return"string"==typeof t.insert}).map(function(t){return t.insert}).join("")}},{key:"insertEmbed",value:function(t,e,n){return this.scroll.insertAt(t,e,n),this.update((new h.default).retain(t).insert(o({},e,n)))}},{key:"insertText",value:function(t,e){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e=e.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),this.scroll.insertAt(t,e),Object.keys(r).forEach(function(o){n.scroll.formatAt(t,e.length,o,r[o])}),this.update((new h.default).retain(t).insert(e,(0,N.default)(r)))}},{key:"isBlank",value:function(){if(0==this.scroll.children.length)return!0;if(this.scroll.children.length>1)return!1;var t=this.scroll.children.head;return t.statics.blotName===w.default.blotName&&(!(t.children.length>1)&&t.children.head instanceof k.default)}},{key:"removeFormat",value:function(t,e){var n=this.getText(t,e),r=this.scroll.line(t+e),o=u(r,2),i=o[0],l=o[1],a=0,s=new h.default;null!=i&&(a=i instanceof g.default?i.newlineIndex(l)-l+1:i.length()-l,s=i.delta().slice(l,l+a-1).insert("\n"));var c=this.getContents(t,e+a),f=c.diff((new h.default).insert(n).concat(s)),p=(new h.default).retain(t).concat(f);return this.applyDelta(p)}},{key:"update",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,r=this.delta;if(1===e.length&&"characterData"===e[0].type&&e[0].target.data.match(P)&&v.default.find(e[0].target)){var o=v.default.find(e[0].target),i=(0,O.bubbleFormats)(o),l=o.offset(this.scroll),a=e[0].oldValue.replace(_.default.CONTENTS,""),s=(new h.default).insert(a),u=(new h.default).insert(o.value());t=(new h.default).retain(l).concat(s.diff(u,n)).reduce(function(t,e){return e.insert?t.insert(e.insert,i):t.push(e)},new h.default),this.delta=r.compose(t)}else this.delta=this.getDelta(),t&&(0,A.default)(r.compose(t),this.delta)||(t=r.diff(this.delta,n));return t}}]),t}();e.default=S},function(t,e){"use strict";function n(){}function r(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function o(){this._events=new n,this._eventsCount=0}var i=Object.prototype.hasOwnProperty,l="~";Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(l=!1)),o.prototype.eventNames=function(){var t,e,n=[];if(0===this._eventsCount)return n;for(e in t=this._events)i.call(t,e)&&n.push(l?e.slice(1):e);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(t)):n},o.prototype.listeners=function(t,e){var n=l?l+t:t,r=this._events[n];if(e)return!!r;if(!r)return[];if(r.fn)return[r.fn];for(var o=0,i=r.length,a=new Array(i);o<i;o++)a[o]=r[o].fn;return a},o.prototype.emit=function(t,e,n,r,o,i){var a=l?l+t:t;if(!this._events[a])return!1;var s,u,c=this._events[a],f=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),f){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,n),!0;case 4:return c.fn.call(c.context,e,n,r),!0;case 5:return c.fn.call(c.context,e,n,r,o),!0;case 6:return c.fn.call(c.context,e,n,r,o,i),!0}for(u=1,s=new Array(f-1);u<f;u++)s[u-1]=arguments[u];c.fn.apply(c.context,s)}else{var h,p=c.length;for(u=0;u<p;u++)switch(c[u].once&&this.removeListener(t,c[u].fn,void 0,!0),f){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,e);break;case 3:c[u].fn.call(c[u].context,e,n);break;case 4:c[u].fn.call(c[u].context,e,n,r);break;default:if(!s)for(h=1,s=new Array(f-1);h<f;h++)s[h-1]=arguments[h];c[u].fn.apply(c[u].context,s)}}return!0},o.prototype.on=function(t,e,n){var o=new r(e,n||this),i=l?l+t:t;return this._events[i]?this._events[i].fn?this._events[i]=[this._events[i],o]:this._events[i].push(o):(this._events[i]=o,this._eventsCount++),this},o.prototype.once=function(t,e,n){var o=new r(e,n||this,!0),i=l?l+t:t;return this._events[i]?this._events[i].fn?this._events[i]=[this._events[i],o]:this._events[i].push(o):(this._events[i]=o,this._eventsCount++),this},o.prototype.removeListener=function(t,e,r,o){var i=l?l+t:t;if(!this._events[i])return this;if(!e)return 0==--this._eventsCount?this._events=new n:delete this._events[i],this;var a=this._events[i];if(a.fn)a.fn!==e||o&&!a.once||r&&a.context!==r||(0==--this._eventsCount?this._events=new n:delete this._events[i]);else{for(var s=0,u=[],c=a.length;s<c;s++)(a[s].fn!==e||o&&!a[s].once||r&&a[s].context!==r)&&u.push(a[s]);u.length?this._events[i]=1===u.length?u[0]:u:0==--this._eventsCount?this._events=new n:delete this._events[i]}return this},o.prototype.removeAllListeners=function(t){var e;return t?(e=l?l+t:t,this._events[e]&&(0==--this._eventsCount?this._events=new n:delete this._events[e])):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prototype.setMaxListeners=function(){return this},o.prefixed=l,o.EventEmitter=o,void 0!==t&&(t.exports=o)},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){return t instanceof v.default||t instanceof y.BlockEmbed}Object.defineProperty(e,"__esModule",{value:!0});var s=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},f=n(0),h=r(f),p=n(9),d=r(p),y=n(3),v=r(y),b=n(14),g=r(b),m=n(13),_=r(m),O=n(23),w=r(O),x=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.emitter=n.emitter,Array.isArray(n.whitelist)&&(r.whitelist=n.whitelist.reduce(function(t,e){return t[e]=!0,t},{})),r.domNode.addEventListener("DOMNodeInserted",function(){}),r.optimize(),r.enable(),r}return l(e,t),u(e,[{key:"batchStart",value:function(){this.batch=!0}},{key:"batchEnd",value:function(){this.batch=!1,this.optimize()}},{key:"deleteAt",value:function(t,n){var r=this.line(t),o=s(r,2),i=o[0],l=o[1],a=this.line(t+n),u=s(a,1),f=u[0];if(c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deleteAt",this).call(this,t,n),null!=f&&i!==f&&l>0){if(i instanceof y.BlockEmbed||f instanceof y.BlockEmbed)return void this.optimize();if(i instanceof _.default){var h=i.newlineIndex(i.length(),!0);if(h>-1&&(i=i.split(h+1))===f)return void this.optimize()}else if(f instanceof _.default){var p=f.newlineIndex(0);p>-1&&f.split(p+1)}var d=f.children.head instanceof g.default?null:f.children.head;i.moveChildren(f,d),i.remove()}this.optimize()}},{key:"enable",value:function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.domNode.setAttribute("contenteditable",t)}},{key:"formatAt",value:function(t,n,r,o){(null==this.whitelist||this.whitelist[r])&&(c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"formatAt",this).call(this,t,n,r,o),this.optimize())}},{key:"insertAt",value:function(t,n,r){if(null==r||null==this.whitelist||this.whitelist[n]){if(t>=this.length())if(null==r||null==h.default.query(n,h.default.Scope.BLOCK)){var o=h.default.create(this.statics.defaultChild);this.appendChild(o),null==r&&n.endsWith("\n")&&(n=n.slice(0,-1)),o.insertAt(0,n,r)}else{var i=h.default.create(n,r);this.appendChild(i)}else c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertAt",this).call(this,t,n,r);this.optimize()}}},{key:"insertBefore",value:function(t,n){if(t.statics.scope===h.default.Scope.INLINE_BLOT){var r=h.default.create(this.statics.defaultChild);r.appendChild(t),t=r}c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertBefore",this).call(this,t,n)}},{key:"leaf",value:function(t){return this.path(t).pop()||[null,-1]}},{key:"line",value:function(t){return t===this.length()?this.line(t-1):this.descendant(a,t)}},{key:"lines",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Number.MAX_VALUE;return function t(e,n,r){var o=[],i=r;return e.children.forEachAt(n,r,function(e,n,r){a(e)?o.push(e):e instanceof h.default.Container&&(o=o.concat(t(e,n,i))),i-=r}),o}(this,t,e)}},{key:"optimize",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!0!==this.batch&&(c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t,n),t.length>0&&this.emitter.emit(d.default.events.SCROLL_OPTIMIZE,t,n))}},{key:"path",value:function(t){return c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"path",this).call(this,t).slice(1)}},{key:"update",value:function(t){if(!0!==this.batch){var n=d.default.sources.USER;"string"==typeof t&&(n=t),Array.isArray(t)||(t=this.observer.takeRecords()),t.length>0&&this.emitter.emit(d.default.events.SCROLL_BEFORE_UPDATE,n,t),c(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"update",this).call(this,t.concat([])),t.length>0&&this.emitter.emit(d.default.events.SCROLL_UPDATE,n,t)}}}]),e}(h.default.Scroll);x.blotName="scroll",x.className="ql-editor",x.tagName="DIV",x.defaultChild="block",x.allowedChildren=[v.default,y.BlockEmbed,w.default],e.default=x},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e,n){return"object"===(void 0===e?"undefined":x(e))?Object.keys(e).reduce(function(t,n){return s(t,n,e[n])},t):t.reduce(function(t,r){return r.attributes&&r.attributes[e]?t.push(r):t.insert(r.insert,(0,j.default)({},o({},e,n),r.attributes))},new q.default)}function u(t){if(t.nodeType!==Node.ELEMENT_NODE)return{};return t["__ql-computed-style"]||(t["__ql-computed-style"]=window.getComputedStyle(t))}function c(t,e){for(var n="",r=t.ops.length-1;r>=0&&n.length<e.length;--r){var o=t.ops[r];if("string"!=typeof o.insert)break;n=o.insert+n}return n.slice(-1*e.length)===e}function f(t){return 0!==t.childNodes.length&&["block","list-item"].indexOf(u(t).display)>-1}function h(t,e,n){return t.nodeType===t.TEXT_NODE?n.reduce(function(e,n){return n(t,e)},new q.default):t.nodeType===t.ELEMENT_NODE?[].reduce.call(t.childNodes||[],function(r,o){var i=h(o,e,n);return o.nodeType===t.ELEMENT_NODE&&(i=e.reduce(function(t,e){return e(o,t)},i),i=(o[W]||[]).reduce(function(t,e){return e(o,t)},i)),r.concat(i)},new q.default):new q.default}function p(t,e,n){return s(n,t,!0)}function d(t,e){var n=P.default.Attributor.Attribute.keys(t),r=P.default.Attributor.Class.keys(t),o=P.default.Attributor.Style.keys(t),i={};return n.concat(r).concat(o).forEach(function(e){var n=P.default.query(e,P.default.Scope.ATTRIBUTE);null!=n&&(i[n.attrName]=n.value(t),i[n.attrName])||(n=Y[e],null==n||n.attrName!==e&&n.keyName!==e||(i[n.attrName]=n.value(t)||void 0),null==(n=X[e])||n.attrName!==e&&n.keyName!==e||(n=X[e],i[n.attrName]=n.value(t)||void 0))}),Object.keys(i).length>0&&(e=s(e,i)),e}function y(t,e){var n=P.default.query(t);if(null==n)return e;if(n.prototype instanceof P.default.Embed){var r={},o=n.value(t);null!=o&&(r[n.blotName]=o,e=(new q.default).insert(r,n.formats(t)))}else"function"==typeof n.formats&&(e=s(e,n.blotName,n.formats(t)));return e}function v(t,e){return c(e,"\n")||e.insert("\n"),e}function b(){return new q.default}function g(t,e){var n=P.default.query(t);if(null==n||"list-item"!==n.blotName||!c(e,"\n"))return e;for(var r=-1,o=t.parentNode;!o.classList.contains("ql-clipboard");)"list"===(P.default.query(o)||{}).blotName&&(r+=1),o=o.parentNode;return r<=0?e:e.compose((new q.default).retain(e.length()-1).retain(1,{indent:r}))}function m(t,e){return c(e,"\n")||(f(t)||e.length()>0&&t.nextSibling&&f(t.nextSibling))&&e.insert("\n"),e}function _(t,e){if(f(t)&&null!=t.nextElementSibling&&!c(e,"\n\n")){var n=t.offsetHeight+parseFloat(u(t).marginTop)+parseFloat(u(t).marginBottom);t.nextElementSibling.offsetTop>t.offsetTop+1.5*n&&e.insert("\n")}return e}function O(t,e){var n={},r=t.style||{};return r.fontStyle&&"italic"===u(t).fontStyle&&(n.italic=!0),r.fontWeight&&(u(t).fontWeight.startsWith("bold")||parseInt(u(t).fontWeight)>=700)&&(n.bold=!0),Object.keys(n).length>0&&(e=s(e,n)),parseFloat(r.textIndent||0)>0&&(e=(new q.default).insert("\t").concat(e)),e}function w(t,e){var n=t.data;if("O:P"===t.parentNode.tagName)return e.insert(n.trim());if(0===n.trim().length&&t.parentNode.classList.contains("ql-clipboard"))return e;if(!u(t.parentNode).whiteSpace.startsWith("pre")){var r=function(t,e){return e=e.replace(/[^\u00a0]/g,""),e.length<1&&t?" ":e};n=n.replace(/\r\n/g," ").replace(/\n/g," "),n=n.replace(/\s\s+/g,r.bind(r,!0)),(null==t.previousSibling&&f(t.parentNode)||null!=t.previousSibling&&f(t.previousSibling))&&(n=n.replace(/^\s+/,r.bind(r,!1))),(null==t.nextSibling&&f(t.parentNode)||null!=t.nextSibling&&f(t.nextSibling))&&(n=n.replace(/\s+$/,r.bind(r,!1)))}return e.insert(n)}Object.defineProperty(e,"__esModule",{value:!0}),e.matchText=e.matchSpacing=e.matchNewline=e.matchBlot=e.matchAttributor=e.default=void 0;var x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},k=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),E=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),N=n(2),j=r(N),A=n(4),q=r(A),T=n(0),P=r(T),S=n(6),C=r(S),L=n(10),M=r(L),R=n(7),I=r(R),B=n(34),D=n(35),U=n(13),F=r(U),H=n(24),K=n(36),z=n(37),Z=n(38),V=(0,M.default)("quill:clipboard"),W="__ql-matcher",G=[[Node.TEXT_NODE,w],[Node.TEXT_NODE,m],["br",v],[Node.ELEMENT_NODE,m],[Node.ELEMENT_NODE,y],[Node.ELEMENT_NODE,_],[Node.ELEMENT_NODE,d],[Node.ELEMENT_NODE,O],["li",g],["b",p.bind(p,"bold")],["i",p.bind(p,"italic")],["style",b]],Y=[B.AlignAttribute,K.DirectionAttribute].reduce(function(t,e){return t[e.keyName]=e,t},{}),X=[B.AlignStyle,D.BackgroundStyle,H.ColorStyle,K.DirectionStyle,z.FontStyle,Z.SizeStyle].reduce(function(t,e){return t[e.keyName]=e,t},{}),$=function(t){function e(t,n){i(this,e);var r=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.root.addEventListener("paste",r.onPaste.bind(r)),r.container=r.quill.addContainer("ql-clipboard"),r.container.setAttribute("contenteditable",!0),r.container.setAttribute("tabindex",-1),r.matchers=[],G.concat(r.options.matchers).forEach(function(t){var e=k(t,2),o=e[0],i=e[1];(n.matchVisual||i!==_)&&r.addMatcher(o,i)}),r}return a(e,t),E(e,[{key:"addMatcher",value:function(t,e){this.matchers.push([t,e])}},{key:"convert",value:function(t){if("string"==typeof t)return this.container.innerHTML=t.replace(/\>\r?\n +\</g,"><"),this.convert();var e=this.quill.getFormat(this.quill.selection.savedRange.index);if(e[F.default.blotName]){var n=this.container.innerText;return this.container.innerHTML="",(new q.default).insert(n,o({},F.default.blotName,e[F.default.blotName]))}var r=this.prepareMatching(),i=k(r,2),l=i[0],a=i[1],s=h(this.container,l,a);return c(s,"\n")&&null==s.ops[s.ops.length-1].attributes&&(s=s.compose((new q.default).retain(s.length()-1).delete(1))),V.log("convert",this.container.innerHTML,s),this.container.innerHTML="",s}},{key:"dangerouslyPasteHTML",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:C.default.sources.API;if("string"==typeof t)this.quill.setContents(this.convert(t),e),this.quill.setSelection(0,C.default.sources.SILENT);else{var r=this.convert(e);this.quill.updateContents((new q.default).retain(t).concat(r),n),this.quill.setSelection(t+r.length(),C.default.sources.SILENT)}}},{key:"onPaste",value:function(t){var e=this;if(!t.defaultPrevented&&this.quill.isEnabled()){var n=this.quill.getSelection(),r=(new q.default).retain(n.index),o=this.quill.scrollingContainer.scrollTop;this.container.focus(),this.quill.selection.update(C.default.sources.SILENT),setTimeout(function(){r=r.concat(e.convert()).delete(n.length),e.quill.updateContents(r,C.default.sources.USER),e.quill.setSelection(r.length()-n.length,C.default.sources.SILENT),e.quill.scrollingContainer.scrollTop=o,e.quill.focus()},1)}}},{key:"prepareMatching",value:function(){var t=this,e=[],n=[];return this.matchers.forEach(function(r){var o=k(r,2),i=o[0],l=o[1];switch(i){case Node.TEXT_NODE:n.push(l);break;case Node.ELEMENT_NODE:e.push(l);break;default:[].forEach.call(t.container.querySelectorAll(i),function(t){t[W]=t[W]||[],t[W].push(l)})}}),[e,n]}}]),e}(I.default);$.DEFAULTS={matchers:[],matchVisual:!0},e.default=$,e.matchAttributor=d,e.matchBlot=y,e.matchNewline=m,e.matchSpacing=_,e.matchText=w},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function a(t){var e=t.ops[t.ops.length-1];return null!=e&&(null!=e.insert?"string"==typeof e.insert&&e.insert.endsWith("\n"):null!=e.attributes&&Object.keys(e.attributes).some(function(t){return null!=f.default.query(t,f.default.Scope.BLOCK)}))}function s(t){var e=t.reduce(function(t,e){return t+=e.delete||0},0),n=t.length()-e;return a(t)&&(n-=1),n}Object.defineProperty(e,"__esModule",{value:!0}),e.getLastChangeIndex=e.default=void 0;var u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=n(0),f=r(c),h=n(6),p=r(h),d=n(7),y=r(d),v=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.lastRecorded=0,r.ignoreChange=!1,r.clear(),r.quill.on(p.default.events.EDITOR_CHANGE,function(t,e,n,o){t!==p.default.events.TEXT_CHANGE||r.ignoreChange||(r.options.userOnly&&o!==p.default.sources.USER?r.transform(e):r.record(e,n))}),r.quill.keyboard.addBinding({key:"Z",shortKey:!0},r.undo.bind(r)),r.quill.keyboard.addBinding({key:"Z",shortKey:!0,shiftKey:!0},r.redo.bind(r)),/Win/i.test(navigator.platform)&&r.quill.keyboard.addBinding({key:"Y",shortKey:!0},r.redo.bind(r)),r}return l(e,t),u(e,[{key:"change",value:function(t,e){if(0!==this.stack[t].length){var n=this.stack[t].pop();this.stack[e].push(n),this.lastRecorded=0,this.ignoreChange=!0,this.quill.updateContents(n[t],p.default.sources.USER),this.ignoreChange=!1;var r=s(n[t]);this.quill.setSelection(r)}}},{key:"clear",value:function(){this.stack={undo:[],redo:[]}}},{key:"cutoff",value:function(){this.lastRecorded=0}},{key:"record",value:function(t,e){if(0!==t.ops.length){this.stack.redo=[];var n=this.quill.getContents().diff(e),r=Date.now();if(this.lastRecorded+this.options.delay>r&&this.stack.undo.length>0){var o=this.stack.undo.pop();n=n.compose(o.undo),t=o.redo.compose(t)}else this.lastRecorded=r;this.stack.undo.push({redo:t,undo:n}),this.stack.undo.length>this.options.maxStack&&this.stack.undo.shift()}}},{key:"redo",value:function(){this.change("redo","undo")}},{key:"transform",value:function(t){this.stack.undo.forEach(function(e){e.undo=t.transform(e.undo,!0),e.redo=t.transform(e.redo,!0)}),this.stack.redo.forEach(function(e){e.undo=t.transform(e.undo,!0),e.redo=t.transform(e.redo,!0)})}},{key:"undo",value:function(){this.change("undo","redo")}}]),e}(y.default);v.DEFAULTS={delay:1e3,maxStack:100,userOnly:!1},e.default=v,e.getLastChangeIndex=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.IndentClass=void 0;var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"add",value:function(t,n){if("+1"===n||"-1"===n){var r=this.value(t)||0;n="+1"===n?r+1:r-1}return 0===n?(this.remove(t),!0):a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"add",this).call(this,t,n)}},{key:"canAdd",value:function(t,n){return a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"canAdd",this).call(this,t,n)||a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"canAdd",this).call(this,t,parseInt(n))}},{key:"value",value:function(t){return parseInt(a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"value",this).call(this,t))||void 0}}]),e}(u.default.Attributor.Class),f=new c("indent","ql-indent",{scope:u.default.Scope.BLOCK,whitelist:[1,2,3,4,5,6,7,8]});e.IndentClass=f},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(3),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="blockquote",s.tagName="blockquote",e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=n(3),s=function(t){return t&&t.__esModule?t:{default:t}}(a),u=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,null,[{key:"formats",value:function(t){return this.tagName.indexOf(t.tagName)+1}}]),e}(s.default);u.blotName="header",u.tagName=["H1","H2","H3","H4","H5","H6"],e.default=u},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.ListItem=void 0;var s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},c=n(0),f=r(c),h=n(3),p=r(h),d=n(23),y=r(d),v=function(t){function e(){return i(this,e),l(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return a(e,t),s(e,[{key:"format",value:function(t,n){t!==b.blotName||n?u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n):this.replaceWith(f.default.create(this.statics.scope))}},{key:"remove",value:function(){null==this.prev&&null==this.next?this.parent.remove():u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"remove",this).call(this)}},{key:"replaceWith",value:function(t,n){return this.parent.isolate(this.offset(this.parent),this.length()),t===this.parent.statics.blotName?(this.parent.replaceWith(t,n),this):(this.parent.unwrap(),u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replaceWith",this).call(this,t,n))}}],[{key:"formats",value:function(t){return t.tagName===this.tagName?void 0:u(e.__proto__||Object.getPrototypeOf(e),"formats",this).call(this,t)}}]),e}(p.default);v.blotName="list-item",v.tagName="LI";var b=function(t){function e(t){i(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t)),r=function(e){if(e.target.parentNode===t){var r=n.statics.formats(t),o=f.default.find(e.target);"checked"===r?o.format("list","unchecked"):"unchecked"===r&&o.format("list","checked")}};return t.addEventListener("touchstart",r),t.addEventListener("mousedown",r),n}return a(e,t),s(e,null,[{key:"create",value:function(t){var n="ordered"===t?"OL":"UL",r=u(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,n);return"checked"!==t&&"unchecked"!==t||r.setAttribute("data-checked","checked"===t),r}},{key:"formats",value:function(t){return"OL"===t.tagName?"ordered":"UL"===t.tagName?t.hasAttribute("data-checked")?"true"===t.getAttribute("data-checked")?"checked":"unchecked":"bullet":void 0}}]),s(e,[{key:"format",value:function(t,e){this.children.length>0&&this.children.tail.format(t,e)}},{key:"formats",value:function(){return o({},this.statics.blotName,this.statics.formats(this.domNode))}},{key:"insertBefore",value:function(t,n){if(t instanceof v)u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"insertBefore",this).call(this,t,n);else{var r=null==n?this.length():n.offset(this),o=this.split(r);o.parent.insertBefore(t,o)}}},{key:"optimize",value:function(t){u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"optimize",this).call(this,t);var n=this.next;null!=n&&n.prev===this&&n.statics.blotName===this.statics.blotName&&n.domNode.tagName===this.domNode.tagName&&n.domNode.getAttribute("data-checked")===this.domNode.getAttribute("data-checked")&&(n.moveChildren(this),n.remove())}},{key:"replace",value:function(t){if(t.statics.blotName!==this.statics.blotName){var n=f.default.create(this.statics.defaultChild);t.moveChildren(n),this.appendChild(n)}u(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replace",this).call(this,t)}}]),e}(y.default);b.blotName="list",b.scope=f.default.Scope.BLOCK_BLOT,b.tagName=["OL","UL"],b.defaultChild="list-item",b.allowedChildren=[v],e.ListItem=v,e.default=b},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(39),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="italic",s.tagName=["EM","I"],e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(5),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,null,[{key:"create",value:function(t){return"super"===t?document.createElement("sup"):"sub"===t?document.createElement("sub"):a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t)}},{key:"formats",value:function(t){return"SUB"===t.tagName?"sub":"SUP"===t.tagName?"super":void 0}}]),e}(u.default);c.blotName="script",c.tagName=["SUB","SUP"],e.default=c},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(5),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="strike",s.tagName="S",e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=n(5),a=function(t){return t&&t.__esModule?t:{default:t}}(l),s=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),e}(a.default);s.blotName="underline",s.tagName="U",e.default=s},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(0),u=function(t){return t&&t.__esModule?t:{default:t}}(s),c=n(15),f=["alt","height","width"],h=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"format",value:function(t,n){f.indexOf(t)>-1?n?this.domNode.setAttribute(t,n):this.domNode.removeAttribute(t):a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n)}}],[{key:"create",value:function(t){var n=a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return"string"==typeof t&&n.setAttribute("src",this.sanitize(t)),n}},{key:"formats",value:function(t){return f.reduce(function(e,n){return t.hasAttribute(n)&&(e[n]=t.getAttribute(n)),e},{})}},{key:"match",value:function(t){return/\.(jpe?g|gif|png)$/.test(t)||/^data:image\/.+;base64/.test(t)}},{key:"sanitize",value:function(t){return(0,c.sanitize)(t,["http","https","data"])?t:"//:0"}},{key:"value",value:function(t){return t.getAttribute("src")}}]),e}(u.default.Embed);h.blotName="image",h.tagName="IMG",e.default=h},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=n(3),u=n(15),c=function(t){return t&&t.__esModule?t:{default:t}}(u),f=["height","width"],h=function(t){function e(){return r(this,e),o(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return i(e,t),l(e,[{key:"format",value:function(t,n){f.indexOf(t)>-1?n?this.domNode.setAttribute(t,n):this.domNode.removeAttribute(t):a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"format",this).call(this,t,n)}}],[{key:"create",value:function(t){var n=a(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return n.setAttribute("frameborder","0"),n.setAttribute("allowfullscreen",!0),n.setAttribute("src",this.sanitize(t)),n}},{key:"formats",value:function(t){return f.reduce(function(e,n){return t.hasAttribute(n)&&(e[n]=t.getAttribute(n)),e},{})}},{key:"sanitize",value:function(t){return c.default.sanitize(t)}},{key:"value",value:function(t){return t.getAttribute("src")}}]),e}(s.BlockEmbed);h.blotName="video",h.className="ql-video",h.tagName="IFRAME",e.default=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.FormulaBlot=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(33),c=r(u),f=n(6),h=r(f),p=n(7),d=r(p),y=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),a(e,null,[{key:"create",value:function(t){var n=s(e.__proto__||Object.getPrototypeOf(e),"create",this).call(this,t);return"string"==typeof t&&(window.katex.render(t,n,{throwOnError:!1,errorColor:"#f00"}),n.setAttribute("data-value",t)),n}},{key:"value",value:function(t){return t.getAttribute("data-value")}}]),e}(c.default);y.blotName="formula",y.className="ql-formula",y.tagName="SPAN";var v=function(t){function e(){o(this,e);var t=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));if(null==window.katex)throw new Error("Formula module requires KaTeX.");return t}return l(e,t),a(e,null,[{key:"register",value:function(){h.default.register(y,!0)}}]),e}(d.default);e.FormulaBlot=y,e.default=v},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.CodeToken=e.CodeBlock=void 0;var a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=n(0),c=r(u),f=n(6),h=r(f),p=n(7),d=r(p),y=n(13),v=r(y),b=function(t){function e(){return o(this,e),i(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return l(e,t),a(e,[{key:"replaceWith",value:function(t){this.domNode.textContent=this.domNode.textContent,this.attach(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"replaceWith",this).call(this,t)}},{key:"highlight",value:function(t){var e=this.domNode.textContent;this.cachedText!==e&&((e.trim().length>0||null==this.cachedText)&&(this.domNode.innerHTML=t(e),this.domNode.normalize(),this.attach()),this.cachedText=e)}}]),e}(v.default);b.className="ql-syntax";var g=new c.default.Attributor.Class("token","hljs",{scope:c.default.Scope.INLINE}),m=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));if("function"!=typeof r.options.highlight)throw new Error("Syntax module requires highlight.js. Please include the library on the page before Quill.");var l=null;return r.quill.on(h.default.events.SCROLL_OPTIMIZE,function(){clearTimeout(l),l=setTimeout(function(){r.highlight(),l=null},r.options.interval)}),r.highlight(),r}return l(e,t),a(e,null,[{key:"register",value:function(){h.default.register(g,!0),h.default.register(b,!0)}}]),a(e,[{key:"highlight",value:function(){var t=this;if(!this.quill.selection.composing){this.quill.update(h.default.sources.USER);var e=this.quill.getSelection();this.quill.scroll.descendants(b).forEach(function(e){e.highlight(t.options.highlight)}),this.quill.update(h.default.sources.SILENT),null!=e&&this.quill.setSelection(e,h.default.sources.SILENT)}}}]),e}(d.default);m.DEFAULTS={highlight:function(){return null==window.hljs?null:function(t){return window.hljs.highlightAuto(t).value}}(),interval:1e3},e.CodeBlock=b,e.CodeToken=g,e.default=m},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e,n){var r=document.createElement("button");r.setAttribute("type","button"),r.classList.add("ql-"+e),null!=n&&(r.value=n),t.appendChild(r)}function u(t,e){Array.isArray(e[0])||(e=[e]),e.forEach(function(e){var n=document.createElement("span");n.classList.add("ql-formats"),e.forEach(function(t){if("string"==typeof t)s(n,t);else{var e=Object.keys(t)[0],r=t[e];Array.isArray(r)?c(n,e,r):s(n,e,r)}}),t.appendChild(n)})}function c(t,e,n){var r=document.createElement("select");r.classList.add("ql-"+e),n.forEach(function(t){var e=document.createElement("option");!1!==t?e.setAttribute("value",t):e.setAttribute("selected","selected"),r.appendChild(e)}),t.appendChild(r)}Object.defineProperty(e,"__esModule",{value:!0}),e.addControls=e.default=void 0;var f=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),p=n(4),d=r(p),y=n(0),v=r(y),b=n(6),g=r(b),m=n(10),_=r(m),O=n(7),w=r(O),x=(0,_.default)("quill:toolbar"),k=function(t){function e(t,n){i(this,e);var r=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));if(Array.isArray(r.options.container)){var o=document.createElement("div");u(o,r.options.container),t.container.parentNode.insertBefore(o,t.container),r.container=o}else"string"==typeof r.options.container?r.container=document.querySelector(r.options.container):r.container=r.options.container;if(!(r.container instanceof HTMLElement)){var a;return a=x.error("Container required for toolbar",r.options),l(r,a)}return r.container.classList.add("ql-toolbar"),r.controls=[],r.handlers={},Object.keys(r.options.handlers).forEach(function(t){r.addHandler(t,r.options.handlers[t])}),[].forEach.call(r.container.querySelectorAll("button, select"),function(t){r.attach(t)}),r.quill.on(g.default.events.EDITOR_CHANGE,function(t,e){t===g.default.events.SELECTION_CHANGE&&r.update(e)}),r.quill.on(g.default.events.SCROLL_OPTIMIZE,function(){var t=r.quill.selection.getRange(),e=f(t,1),n=e[0];r.update(n)}),r}return a(e,t),h(e,[{key:"addHandler",value:function(t,e){this.handlers[t]=e}},{key:"attach",value:function(t){var e=this,n=[].find.call(t.classList,function(t){return 0===t.indexOf("ql-")});if(n){if(n=n.slice("ql-".length),"BUTTON"===t.tagName&&t.setAttribute("type","button"),null==this.handlers[n]){if(null!=this.quill.scroll.whitelist&&null==this.quill.scroll.whitelist[n])return void x.warn("ignoring attaching to disabled format",n,t);if(null==v.default.query(n))return void x.warn("ignoring attaching to nonexistent format",n,t)}var r="SELECT"===t.tagName?"change":"click";t.addEventListener(r,function(r){var i=void 0;if("SELECT"===t.tagName){if(t.selectedIndex<0)return;var l=t.options[t.selectedIndex];i=!l.hasAttribute("selected")&&(l.value||!1)}else i=!t.classList.contains("ql-active")&&(t.value||!t.hasAttribute("value")),r.preventDefault();e.quill.focus();var a=e.quill.selection.getRange(),s=f(a,1),u=s[0];if(null!=e.handlers[n])e.handlers[n].call(e,i);else if(v.default.query(n).prototype instanceof v.default.Embed){if(!(i=prompt("Enter "+n)))return;e.quill.updateContents((new d.default).retain(u.index).delete(u.length).insert(o({},n,i)),g.default.sources.USER)}else e.quill.format(n,i,g.default.sources.USER);e.update(u)}),this.controls.push([n,t])}}},{key:"update",value:function(t){var e=null==t?{}:this.quill.getFormat(t);this.controls.forEach(function(n){var r=f(n,2),o=r[0],i=r[1];if("SELECT"===i.tagName){var l=void 0;if(null==t)l=null;else if(null==e[o])l=i.querySelector("option[selected]");else if(!Array.isArray(e[o])){var a=e[o];"string"==typeof a&&(a=a.replace(/\"/g,'\\"')),l=i.querySelector('option[value="'+a+'"]')}null==l?(i.value="",i.selectedIndex=-1):l.selected=!0}else if(null==t)i.classList.remove("ql-active");else if(i.hasAttribute("value")){var s=e[o]===i.getAttribute("value")||null!=e[o]&&e[o].toString()===i.getAttribute("value")||null==e[o]&&!i.getAttribute("value");i.classList.toggle("ql-active",s)}else i.classList.toggle("ql-active",null!=e[o])})}}]),e}(w.default);k.DEFAULTS={},k.DEFAULTS={container:null,handlers:{clean:function(){var t=this,e=this.quill.getSelection();if(null!=e)if(0==e.length){var n=this.quill.getFormat();Object.keys(n).forEach(function(e){null!=v.default.query(e,v.default.Scope.INLINE)&&t.quill.format(e,!1)})}else this.quill.removeFormat(e,g.default.sources.USER)},direction:function(t){var e=this.quill.getFormat().align;"rtl"===t&&null==e?this.quill.format("align","right",g.default.sources.USER):t||"right"!==e||this.quill.format("align",!1,g.default.sources.USER),this.quill.format("direction",t,g.default.sources.USER)},indent:function(t){var e=this.quill.getSelection(),n=this.quill.getFormat(e),r=parseInt(n.indent||0);if("+1"===t||"-1"===t){var o="+1"===t?1:-1;"rtl"===n.direction&&(o*=-1),this.quill.format("indent",r+o,g.default.sources.USER)}},link:function(t){!0===t&&(t=prompt("Enter link URL:")),this.quill.format("link",t,g.default.sources.USER)},list:function(t){var e=this.quill.getSelection(),n=this.quill.getFormat(e);"check"===t?"checked"===n.list||"unchecked"===n.list?this.quill.format("list",!1,g.default.sources.USER):this.quill.format("list","unchecked",g.default.sources.USER):this.quill.format("list",t,g.default.sources.USER)}}},e.default=k,e.addControls=u},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=3 x2=15 y1=9 y2=9></line> <line class=ql-stroke x1=3 x2=13 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=9 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=15 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=14 x2=4 y1=14 y2=14></line> <line class=ql-stroke x1=12 x2=6 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=15 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=15 x2=5 y1=14 y2=14></line> <line class=ql-stroke x1=15 x2=9 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=15 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=15 x2=3 y1=14 y2=14></line> <line class=ql-stroke x1=15 x2=3 y1=4 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <g class="ql-fill ql-color-label"> <polygon points="6 6.868 6 6 5 6 5 7 5.942 7 6 6.868"></polygon> <rect height=1 width=1 x=4 y=4></rect> <polygon points="6.817 5 6 5 6 6 6.38 6 6.817 5"></polygon> <rect height=1 width=1 x=2 y=6></rect> <rect height=1 width=1 x=3 y=5></rect> <rect height=1 width=1 x=4 y=7></rect> <polygon points="4 11.439 4 11 3 11 3 12 3.755 12 4 11.439"></polygon> <rect height=1 width=1 x=2 y=12></rect> <rect height=1 width=1 x=2 y=9></rect> <rect height=1 width=1 x=2 y=15></rect> <polygon points="4.63 10 4 10 4 11 4.192 11 4.63 10"></polygon> <rect height=1 width=1 x=3 y=8></rect> <path d=M10.832,4.2L11,4.582V4H10.708A1.948,1.948,0,0,1,10.832,4.2Z></path> <path d=M7,4.582L7.168,4.2A1.929,1.929,0,0,1,7.292,4H7V4.582Z></path> <path d=M8,13H7.683l-0.351.8a1.933,1.933,0,0,1-.124.2H8V13Z></path> <rect height=1 width=1 x=12 y=2></rect> <rect height=1 width=1 x=11 y=3></rect> <path d=M9,3H8V3.282A1.985,1.985,0,0,1,9,3Z></path> <rect height=1 width=1 x=2 y=3></rect> <rect height=1 width=1 x=6 y=2></rect> <rect height=1 width=1 x=3 y=2></rect> <rect height=1 width=1 x=5 y=3></rect> <rect height=1 width=1 x=9 y=2></rect> <rect height=1 width=1 x=15 y=14></rect> <polygon points="13.447 10.174 13.469 10.225 13.472 10.232 13.808 11 14 11 14 10 13.37 10 13.447 10.174"></polygon> <rect height=1 width=1 x=13 y=7></rect> <rect height=1 width=1 x=15 y=5></rect> <rect height=1 width=1 x=14 y=6></rect> <rect height=1 width=1 x=15 y=8></rect> <rect height=1 width=1 x=14 y=9></rect> <path d=M3.775,14H3v1H4V14.314A1.97,1.97,0,0,1,3.775,14Z></path> <rect height=1 width=1 x=14 y=3></rect> <polygon points="12 6.868 12 6 11.62 6 12 6.868"></polygon> <rect height=1 width=1 x=15 y=2></rect> <rect height=1 width=1 x=12 y=5></rect> <rect height=1 width=1 x=13 y=4></rect> <polygon points="12.933 9 13 9 13 8 12.495 8 12.933 9"></polygon> <rect height=1 width=1 x=9 y=14></rect> <rect height=1 width=1 x=8 y=15></rect> <path d=M6,14.926V15H7V14.316A1.993,1.993,0,0,1,6,14.926Z></path> <rect height=1 width=1 x=5 y=15></rect> <path d=M10.668,13.8L10.317,13H10v1h0.792A1.947,1.947,0,0,1,10.668,13.8Z></path> <rect height=1 width=1 x=11 y=15></rect> <path d=M14.332,12.2a1.99,1.99,0,0,1,.166.8H15V12H14.245Z></path> <rect height=1 width=1 x=14 y=15></rect> <rect height=1 width=1 x=15 y=11></rect> </g> <polyline class=ql-stroke points="5.5 13 9 5 12.5 13"></polyline> <line class=ql-stroke x1=11.63 x2=6.38 y1=11 y2=11></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <rect class="ql-fill ql-stroke" height=3 width=3 x=4 y=5></rect> <rect class="ql-fill ql-stroke" height=3 width=3 x=11 y=5></rect> <path class="ql-even ql-fill ql-stroke" d=M7,8c0,4.031-3,5-3,5></path> <path class="ql-even ql-fill ql-stroke" d=M14,8c0,4.031-3,5-3,5></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-stroke d=M5,4H9.5A2.5,2.5,0,0,1,12,6.5v0A2.5,2.5,0,0,1,9.5,9H5A0,0,0,0,1,5,9V4A0,0,0,0,1,5,4Z></path> <path class=ql-stroke d=M5,9h5.5A2.5,2.5,0,0,1,13,11.5v0A2.5,2.5,0,0,1,10.5,14H5a0,0,0,0,1,0,0V9A0,0,0,0,1,5,9Z></path> </svg>'},function(t,e){t.exports='<svg class="" viewbox="0 0 18 18"> <line class=ql-stroke x1=5 x2=13 y1=3 y2=3></line> <line class=ql-stroke x1=6 x2=9.35 y1=12 y2=3></line> <line class=ql-stroke x1=11 x2=15 y1=11 y2=15></line> <line class=ql-stroke x1=15 x2=11 y1=11 y2=15></line> <rect class=ql-fill height=1 rx=0.5 ry=0.5 width=7 x=2 y=14></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class="ql-color-label ql-stroke ql-transparent" x1=3 x2=15 y1=15 y2=15></line> <polyline class=ql-stroke points="5.5 11 9 3 12.5 11"></polyline> <line class=ql-stroke x1=11.63 x2=6.38 y1=9 y2=9></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polygon class="ql-stroke ql-fill" points="3 11 5 9 3 7 3 11"></polygon> <line class="ql-stroke ql-fill" x1=15 x2=11 y1=4 y2=4></line> <path class=ql-fill d=M11,3a3,3,0,0,0,0,6h1V3H11Z></path> <rect class=ql-fill height=11 width=1 x=11 y=4></rect> <rect class=ql-fill height=11 width=1 x=13 y=4></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polygon class="ql-stroke ql-fill" points="15 12 13 10 15 8 15 12"></polygon> <line class="ql-stroke ql-fill" x1=9 x2=5 y1=4 y2=4></line> <path class=ql-fill d=M5,3A3,3,0,0,0,5,9H6V3H5Z></path> <rect class=ql-fill height=11 width=1 x=5 y=4></rect> <rect class=ql-fill height=11 width=1 x=7 y=4></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M14,16H4a1,1,0,0,1,0-2H14A1,1,0,0,1,14,16Z /> <path class=ql-fill d=M14,4H4A1,1,0,0,1,4,2H14A1,1,0,0,1,14,4Z /> <rect class=ql-fill x=3 y=6 width=12 height=6 rx=1 ry=1 /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M13,16H5a1,1,0,0,1,0-2h8A1,1,0,0,1,13,16Z /> <path class=ql-fill d=M13,4H5A1,1,0,0,1,5,2h8A1,1,0,0,1,13,4Z /> <rect class=ql-fill x=2 y=6 width=14 height=6 rx=1 ry=1 /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M15,8H13a1,1,0,0,1,0-2h2A1,1,0,0,1,15,8Z /> <path class=ql-fill d=M15,12H13a1,1,0,0,1,0-2h2A1,1,0,0,1,15,12Z /> <path class=ql-fill d=M15,16H5a1,1,0,0,1,0-2H15A1,1,0,0,1,15,16Z /> <path class=ql-fill d=M15,4H5A1,1,0,0,1,5,2H15A1,1,0,0,1,15,4Z /> <rect class=ql-fill x=2 y=6 width=8 height=6 rx=1 ry=1 /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M5,8H3A1,1,0,0,1,3,6H5A1,1,0,0,1,5,8Z /> <path class=ql-fill d=M5,12H3a1,1,0,0,1,0-2H5A1,1,0,0,1,5,12Z /> <path class=ql-fill d=M13,16H3a1,1,0,0,1,0-2H13A1,1,0,0,1,13,16Z /> <path class=ql-fill d=M13,4H3A1,1,0,0,1,3,2H13A1,1,0,0,1,13,4Z /> <rect class=ql-fill x=8 y=6 width=8 height=6 rx=1 ry=1 transform="translate(24 18) rotate(-180)"/> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M11.759,2.482a2.561,2.561,0,0,0-3.53.607A7.656,7.656,0,0,0,6.8,6.2C6.109,9.188,5.275,14.677,4.15,14.927a1.545,1.545,0,0,0-1.3-.933A0.922,0.922,0,0,0,2,15.036S1.954,16,4.119,16s3.091-2.691,3.7-5.553c0.177-.826.36-1.726,0.554-2.6L8.775,6.2c0.381-1.421.807-2.521,1.306-2.676a1.014,1.014,0,0,0,1.02.56A0.966,0.966,0,0,0,11.759,2.482Z></path> <rect class=ql-fill height=1.6 rx=0.8 ry=0.8 width=5 x=5.15 y=6.2></rect> <path class=ql-fill d=M13.663,12.027a1.662,1.662,0,0,1,.266-0.276q0.193,0.069.456,0.138a2.1,2.1,0,0,0,.535.069,1.075,1.075,0,0,0,.767-0.3,1.044,1.044,0,0,0,.314-0.8,0.84,0.84,0,0,0-.238-0.619,0.8,0.8,0,0,0-.594-0.239,1.154,1.154,0,0,0-.781.3,4.607,4.607,0,0,0-.781,1q-0.091.15-.218,0.346l-0.246.38c-0.068-.288-0.137-0.582-0.212-0.885-0.459-1.847-2.494-.984-2.941-0.8-0.482.2-.353,0.647-0.094,0.529a0.869,0.869,0,0,1,1.281.585c0.217,0.751.377,1.436,0.527,2.038a5.688,5.688,0,0,1-.362.467,2.69,2.69,0,0,1-.264.271q-0.221-.08-0.471-0.147a2.029,2.029,0,0,0-.522-0.066,1.079,1.079,0,0,0-.768.3A1.058,1.058,0,0,0,9,15.131a0.82,0.82,0,0,0,.832.852,1.134,1.134,0,0,0,.787-0.3,5.11,5.11,0,0,0,.776-0.993q0.141-.219.215-0.34c0.046-.076.122-0.194,0.223-0.346a2.786,2.786,0,0,0,.918,1.726,2.582,2.582,0,0,0,2.376-.185c0.317-.181.212-0.565,0-0.494A0.807,0.807,0,0,1,14.176,15a5.159,5.159,0,0,1-.913-2.446l0,0Q13.487,12.24,13.663,12.027Z></path> </svg>'},function(t,e){t.exports='<svg viewBox="0 0 18 18"> <path class=ql-fill d=M10,4V14a1,1,0,0,1-2,0V10H3v4a1,1,0,0,1-2,0V4A1,1,0,0,1,3,4V8H8V4a1,1,0,0,1,2,0Zm6.06787,9.209H14.98975V7.59863a.54085.54085,0,0,0-.605-.60547h-.62744a1.01119,1.01119,0,0,0-.748.29688L11.645,8.56641a.5435.5435,0,0,0-.022.8584l.28613.30762a.53861.53861,0,0,0,.84717.0332l.09912-.08789a1.2137,1.2137,0,0,0,.2417-.35254h.02246s-.01123.30859-.01123.60547V13.209H12.041a.54085.54085,0,0,0-.605.60547v.43945a.54085.54085,0,0,0,.605.60547h4.02686a.54085.54085,0,0,0,.605-.60547v-.43945A.54085.54085,0,0,0,16.06787,13.209Z /> </svg>'},function(t,e){t.exports='<svg viewBox="0 0 18 18"> <path class=ql-fill d=M16.73975,13.81445v.43945a.54085.54085,0,0,1-.605.60547H11.855a.58392.58392,0,0,1-.64893-.60547V14.0127c0-2.90527,3.39941-3.42187,3.39941-4.55469a.77675.77675,0,0,0-.84717-.78125,1.17684,1.17684,0,0,0-.83594.38477c-.2749.26367-.561.374-.85791.13184l-.4292-.34082c-.30811-.24219-.38525-.51758-.1543-.81445a2.97155,2.97155,0,0,1,2.45361-1.17676,2.45393,2.45393,0,0,1,2.68408,2.40918c0,2.45312-3.1792,2.92676-3.27832,3.93848h2.79443A.54085.54085,0,0,1,16.73975,13.81445ZM9,3A.99974.99974,0,0,0,8,4V8H3V4A1,1,0,0,0,1,4V14a1,1,0,0,0,2,0V10H8v4a1,1,0,0,0,2,0V4A.99974.99974,0,0,0,9,3Z /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=7 x2=13 y1=4 y2=4></line> <line class=ql-stroke x1=5 x2=11 y1=14 y2=14></line> <line class=ql-stroke x1=8 x2=10 y1=14 y2=4></line> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <rect class=ql-stroke height=10 width=12 x=3 y=4></rect> <circle class=ql-fill cx=6 cy=7 r=1></circle> <polyline class="ql-even ql-fill" points="5 12 5 11 7 9 8 10 11 7 13 9 13 12 5 12"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=3 x2=15 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=9 x2=15 y1=9 y2=9></line> <polyline class="ql-fill ql-stroke" points="3 7 3 11 5 9 3 7"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=3 x2=15 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=9 x2=15 y1=9 y2=9></line> <polyline class=ql-stroke points="5 7 5 11 3 9 5 7"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=7 x2=11 y1=7 y2=11></line> <path class="ql-even ql-stroke" d=M8.9,4.577a3.476,3.476,0,0,1,.36,4.679A3.476,3.476,0,0,1,4.577,8.9C3.185,7.5,2.035,6.4,4.217,4.217S7.5,3.185,8.9,4.577Z></path> <path class="ql-even ql-stroke" d=M13.423,9.1a3.476,3.476,0,0,0-4.679-.36,3.476,3.476,0,0,0,.36,4.679c1.392,1.392,2.5,2.542,4.679.36S14.815,10.5,13.423,9.1Z></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=7 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=7 x2=15 y1=9 y2=9></line> <line class=ql-stroke x1=7 x2=15 y1=14 y2=14></line> <line class="ql-stroke ql-thin" x1=2.5 x2=4.5 y1=5.5 y2=5.5></line> <path class=ql-fill d=M3.5,6A0.5,0.5,0,0,1,3,5.5V3.085l-0.276.138A0.5,0.5,0,0,1,2.053,3c-0.124-.247-0.023-0.324.224-0.447l1-.5A0.5,0.5,0,0,1,4,2.5v3A0.5,0.5,0,0,1,3.5,6Z></path> <path class="ql-stroke ql-thin" d=M4.5,10.5h-2c0-.234,1.85-1.076,1.85-2.234A0.959,0.959,0,0,0,2.5,8.156></path> <path class="ql-stroke ql-thin" d=M2.5,14.846a0.959,0.959,0,0,0,1.85-.109A0.7,0.7,0,0,0,3.75,14a0.688,0.688,0,0,0,.6-0.736,0.959,0.959,0,0,0-1.85-.109></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class=ql-stroke x1=6 x2=15 y1=4 y2=4></line> <line class=ql-stroke x1=6 x2=15 y1=9 y2=9></line> <line class=ql-stroke x1=6 x2=15 y1=14 y2=14></line> <line class=ql-stroke x1=3 x2=3 y1=4 y2=4></line> <line class=ql-stroke x1=3 x2=3 y1=9 y2=9></line> <line class=ql-stroke x1=3 x2=3 y1=14 y2=14></line> </svg>'},function(t,e){t.exports='<svg class="" viewbox="0 0 18 18"> <line class=ql-stroke x1=9 x2=15 y1=4 y2=4></line> <polyline class=ql-stroke points="3 4 4 5 6 3"></polyline> <line class=ql-stroke x1=9 x2=15 y1=14 y2=14></line> <polyline class=ql-stroke points="3 14 4 15 6 13"></polyline> <line class=ql-stroke x1=9 x2=15 y1=9 y2=9></line> <polyline class=ql-stroke points="3 9 4 10 6 8"></polyline> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M15.5,15H13.861a3.858,3.858,0,0,0,1.914-2.975,1.8,1.8,0,0,0-1.6-1.751A1.921,1.921,0,0,0,12.021,11.7a0.50013,0.50013,0,1,0,.957.291h0a0.914,0.914,0,0,1,1.053-.725,0.81,0.81,0,0,1,.744.762c0,1.076-1.16971,1.86982-1.93971,2.43082A1.45639,1.45639,0,0,0,12,15.5a0.5,0.5,0,0,0,.5.5h3A0.5,0.5,0,0,0,15.5,15Z /> <path class=ql-fill d=M9.65,5.241a1,1,0,0,0-1.409.108L6,7.964,3.759,5.349A1,1,0,0,0,2.192,6.59178Q2.21541,6.6213,2.241,6.649L4.684,9.5,2.241,12.35A1,1,0,0,0,3.71,13.70722q0.02557-.02768.049-0.05722L6,11.036,8.241,13.65a1,1,0,1,0,1.567-1.24277Q9.78459,12.3777,9.759,12.35L7.316,9.5,9.759,6.651A1,1,0,0,0,9.65,5.241Z /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-fill d=M15.5,7H13.861a4.015,4.015,0,0,0,1.914-2.975,1.8,1.8,0,0,0-1.6-1.751A1.922,1.922,0,0,0,12.021,3.7a0.5,0.5,0,1,0,.957.291,0.917,0.917,0,0,1,1.053-.725,0.81,0.81,0,0,1,.744.762c0,1.077-1.164,1.925-1.934,2.486A1.423,1.423,0,0,0,12,7.5a0.5,0.5,0,0,0,.5.5h3A0.5,0.5,0,0,0,15.5,7Z /> <path class=ql-fill d=M9.651,5.241a1,1,0,0,0-1.41.108L6,7.964,3.759,5.349a1,1,0,1,0-1.519,1.3L4.683,9.5,2.241,12.35a1,1,0,1,0,1.519,1.3L6,11.036,8.241,13.65a1,1,0,0,0,1.519-1.3L7.317,9.5,9.759,6.651A1,1,0,0,0,9.651,5.241Z /> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <line class="ql-stroke ql-thin" x1=15.5 x2=2.5 y1=8.5 y2=9.5></line> <path class=ql-fill d=M9.007,8C6.542,7.791,6,7.519,6,6.5,6,5.792,7.283,5,9,5c1.571,0,2.765.679,2.969,1.309a1,1,0,0,0,1.9-.617C13.356,4.106,11.354,3,9,3,6.2,3,4,4.538,4,6.5a3.2,3.2,0,0,0,.5,1.843Z></path> <path class=ql-fill d=M8.984,10C11.457,10.208,12,10.479,12,11.5c0,0.708-1.283,1.5-3,1.5-1.571,0-2.765-.679-2.969-1.309a1,1,0,1,0-1.9.617C4.644,13.894,6.646,15,9,15c2.8,0,5-1.538,5-3.5a3.2,3.2,0,0,0-.5-1.843Z></path> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <path class=ql-stroke d=M5,3V9a4.012,4.012,0,0,0,4,4H9a4.012,4.012,0,0,0,4-4V3></path> <rect class=ql-fill height=1 rx=0.5 ry=0.5 width=12 x=3 y=15></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <rect class=ql-stroke height=12 width=12 x=3 y=3></rect> <rect class=ql-fill height=12 width=1 x=5 y=3></rect> <rect class=ql-fill height=12 width=1 x=12 y=3></rect> <rect class=ql-fill height=2 width=8 x=5 y=8></rect> <rect class=ql-fill height=1 width=3 x=3 y=5></rect> <rect class=ql-fill height=1 width=3 x=3 y=7></rect> <rect class=ql-fill height=1 width=3 x=3 y=10></rect> <rect class=ql-fill height=1 width=3 x=3 y=12></rect> <rect class=ql-fill height=1 width=3 x=12 y=5></rect> <rect class=ql-fill height=1 width=3 x=12 y=7></rect> <rect class=ql-fill height=1 width=3 x=12 y=10></rect> <rect class=ql-fill height=1 width=3 x=12 y=12></rect> </svg>'},function(t,e){t.exports='<svg viewbox="0 0 18 18"> <polygon class=ql-stroke points="7 11 9 13 11 11 7 11"></polygon> <polygon class=ql-stroke points="7 7 9 5 11 7 7 7"></polygon> </svg>'},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.BubbleTooltip=void 0;var a=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=n(2),c=r(u),f=n(9),h=r(f),p=n(44),d=r(p),y=n(22),v=n(26),b=r(v),g=[["bold","italic","link"],[{header:1},{header:2},"blockquote"]],m=function(t){function e(t,n){o(this,e),null!=n.modules.toolbar&&null==n.modules.toolbar.container&&(n.modules.toolbar.container=g);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.container.classList.add("ql-bubble"),r}return l(e,t),s(e,[{key:"extendToolbar",value:function(t){this.tooltip=new _(this.quill,this.options.bounds),this.tooltip.root.appendChild(t.container),this.buildButtons([].slice.call(t.container.querySelectorAll("button")),b.default),this.buildPickers([].slice.call(t.container.querySelectorAll("select")),b.default)}}]),e}(d.default);m.DEFAULTS=(0,c.default)(!0,{},d.default.DEFAULTS,{modules:{toolbar:{handlers:{link:function(t){t?this.quill.theme.tooltip.edit():this.quill.format("link",!1)}}}}});var _=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.on(h.default.events.EDITOR_CHANGE,function(t,e,n,o){if(t===h.default.events.SELECTION_CHANGE)if(null!=e&&e.length>0&&o===h.default.sources.USER){r.show(),r.root.style.left="0px",r.root.style.width="",r.root.style.width=r.root.offsetWidth+"px";var i=r.quill.getLines(e.index,e.length);if(1===i.length)r.position(r.quill.getBounds(e));else{var l=i[i.length-1],a=r.quill.getIndex(l),s=Math.min(l.length()-1,e.index+e.length-a),u=r.quill.getBounds(new y.Range(a,s));r.position(u)}}else document.activeElement!==r.textbox&&r.quill.hasFocus()&&r.hide()}),r}return l(e,t),s(e,[{key:"listen",value:function(){var t=this;a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"listen",this).call(this),this.root.querySelector(".ql-close").addEventListener("click",function(){t.root.classList.remove("ql-editing")}),this.quill.on(h.default.events.SCROLL_OPTIMIZE,function(){setTimeout(function(){if(!t.root.classList.contains("ql-hidden")){var e=t.quill.getSelection();null!=e&&t.position(t.quill.getBounds(e))}},1)})}},{key:"cancel",value:function(){this.show()}},{key:"position",value:function(t){var n=a(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"position",this).call(this,t),r=this.root.querySelector(".ql-tooltip-arrow");if(r.style.marginLeft="",0===n)return n;r.style.marginLeft=-1*n-r.offsetWidth/2+"px"}}]),e}(p.BaseTooltip);_.TEMPLATE=['<span class="ql-tooltip-arrow"></span>','<div class="ql-tooltip-editor">','<input type="text" data-formula="e=mc^2" data-link="https://quilljs.com" data-video="Embed URL">','<a class="ql-close"></a>',"</div>"].join(""),e.BubbleTooltip=_,e.default=m},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function l(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var a=function(){function t(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var l,a=t[Symbol.iterator]();!(r=(l=a.next()).done)&&(n.push(l.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var l=o.get;if(void 0!==l)return l.call(r)},u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=n(2),f=r(c),h=n(9),p=r(h),d=n(44),y=r(d),v=n(15),b=r(v),g=n(22),m=n(26),_=r(m),O=[[{header:["1","2","3",!1]}],["bold","italic","underline","link"],[{list:"ordered"},{list:"bullet"}],["clean"]],w=function(t){function e(t,n){o(this,e),null!=n.modules.toolbar&&null==n.modules.toolbar.container&&(n.modules.toolbar.container=O);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.quill.container.classList.add("ql-snow"),r}return l(e,t),u(e,[{key:"extendToolbar",value:function(t){t.container.classList.add("ql-snow"),this.buildButtons([].slice.call(t.container.querySelectorAll("button")),_.default),this.buildPickers([].slice.call(t.container.querySelectorAll("select")),_.default),this.tooltip=new x(this.quill,this.options.bounds),t.container.querySelector(".ql-link")&&this.quill.keyboard.addBinding({key:"K",shortKey:!0},function(e,n){t.handlers.link.call(t,!n.format.link)})}}]),e}(y.default);w.DEFAULTS=(0,f.default)(!0,{},y.default.DEFAULTS,{modules:{toolbar:{handlers:{link:function(t){if(t){var e=this.quill.getSelection();if(null==e||0==e.length)return;var n=this.quill.getText(e);/^\S+@\S+\.\S+$/.test(n)&&0!==n.indexOf("mailto:")&&(n="mailto:"+n);this.quill.theme.tooltip.edit("link",n)}else this.quill.format("link",!1)}}}}});var x=function(t){function e(t,n){o(this,e);var r=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,n));return r.preview=r.root.querySelector("a.ql-preview"),r}return l(e,t),u(e,[{key:"listen",value:function(){var t=this;s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"listen",this).call(this),this.root.querySelector("a.ql-action").addEventListener("click",function(e){t.root.classList.contains("ql-editing")?t.save():t.edit("link",t.preview.textContent),e.preventDefault()}),this.root.querySelector("a.ql-remove").addEventListener("click",function(e){if(null!=t.linkRange){var n=t.linkRange;t.restoreFocus(),t.quill.formatText(n,"link",!1,p.default.sources.USER),delete t.linkRange}e.preventDefault(),t.hide()}),this.quill.on(p.default.events.SELECTION_CHANGE,function(e,n,r){if(null!=e){if(0===e.length&&r===p.default.sources.USER){var o=t.quill.scroll.descendant(b.default,e.index),i=a(o,2),l=i[0],s=i[1];if(null!=l){t.linkRange=new g.Range(e.index-s,l.length());var u=b.default.formats(l.domNode);return t.preview.textContent=u,t.preview.setAttribute("href",u),t.show(),void t.position(t.quill.getBounds(t.linkRange))}}else delete t.linkRange;t.hide()}})}},{key:"show",value:function(){s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"show",this).call(this),this.root.removeAttribute("data-mode")}}]),e}(d.BaseTooltip);x.TEMPLATE=['<a class="ql-preview" target="_blank" href="about:blank"></a>','<input type="text" data-formula="e=mc^2" data-link="https://quilljs.com" data-video="Embed URL">','<a class="ql-action"></a>','<a class="ql-remove"></a>'].join(""),e.default=w}]).default});





var bold = Quill.import('formats/bold');
bold.tagName = 'b';   // Quill uses <strong> by default
Quill.register(bold, true);

var italic = Quill.import('formats/italic');
italic.tagName = 'i';   // Quill uses <em> by default
Quill.register(italic, true);
/*
 Highcharts JS v7.2.1 (2019-10-31)

 (c) 2009-2018 Torstein Honsi

 License: www.highcharts.com/license
*/
(function(P,M){"object"===typeof module&&module.exports?(M["default"]=M,module.exports=P.document?M(P):M):"function"===typeof define&&define.amd?define("highcharts/highcharts",function(){return M(P)}):(P.Highcharts&&P.Highcharts.error(16,!0),P.Highcharts=M(P))})("undefined"!==typeof window?window:this,function(P){function M(c,f,F,G){c.hasOwnProperty(f)||(c[f]=G.apply(null,F))}var I={};M(I,"parts/Globals.js",[],function(){var c="undefined"!==typeof P?P:"undefined"!==typeof window?window:{},f=c.document,
F=c.navigator&&c.navigator.userAgent||"",G=f&&f.createElementNS&&!!f.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect,z=/(edge|msie|trident)/i.test(F)&&!c.opera,B=-1!==F.indexOf("Firefox"),t=-1!==F.indexOf("Chrome"),v=B&&4>parseInt(F.split("Firefox/")[1],10);return{product:"Highcharts",version:"7.2.1",deg2rad:2*Math.PI/360,doc:f,hasBidiBug:v,hasTouch:!!c.TouchEvent,isMS:z,isWebKit:-1!==F.indexOf("AppleWebKit"),isFirefox:B,isChrome:t,isSafari:!t&&-1!==F.indexOf("Safari"),isTouchDevice:/(Mobile|Android|Windows Phone)/.test(F),
SVG_NS:"http://www.w3.org/2000/svg",chartCount:0,seriesTypes:{},symbolSizes:{},svg:G,win:c,marginNames:["plotTop","marginRight","marginBottom","plotLeft"],noop:function(){},charts:[],dateFormats:{}}});M(I,"parts/Utilities.js",[I["parts/Globals.js"]],function(c){function f(a,d){return parseInt(a,d||10)}function F(a){return"string"===typeof a}function G(a){a=Object.prototype.toString.call(a);return"[object Array]"===a||"[object Array Iterator]"===a}function z(a,d){return!!a&&"object"===typeof a&&(!d||
!G(a))}function B(a){return z(a)&&"number"===typeof a.nodeType}function t(a){var d=a&&a.constructor;return!(!z(a,!0)||B(a)||!d||!d.name||"Object"===d.name)}function v(a){return"number"===typeof a&&!isNaN(a)&&Infinity>a&&-Infinity<a}function C(a){return"undefined"!==typeof a&&null!==a}function H(a,d,e){var b;F(d)?C(e)?a.setAttribute(d,e):a&&a.getAttribute&&((b=a.getAttribute(d))||"class"!==d||(b=a.getAttribute(d+"Name"))):n(d,function(d,e){a.setAttribute(e,d)});return b}function y(a,d){var e;a||(a=
{});for(e in d)a[e]=d[e];return a}function h(){for(var a=arguments,d=a.length,e=0;e<d;e++){var b=a[e];if("undefined"!==typeof b&&null!==b)return b}}function n(a,d,e){for(var b in a)Object.hasOwnProperty.call(a,b)&&d.call(e||a[b],a[b],b,a)}c.timers=[];var q=c.charts,g=c.doc,b=c.win;c.error=function(a,d,e,l){var g=v(a),h=g?"Highcharts error #"+a+": www.highcharts.com/errors/"+a+"/":a.toString(),p=function(){if(d)throw Error(h);b.console&&console.log(h)};if("undefined"!==typeof l){var u="";g&&(h+="?");
c.objectEach(l,function(a,d){u+="\n"+d+": "+a;g&&(h+=encodeURI(d)+"="+encodeURI(a))});h+=u}e?c.fireEvent(e,"displayError",{code:a,message:h,params:l},p):p()};c.Fx=function(a,d,e){this.options=d;this.elem=a;this.prop=e};c.Fx.prototype={dSetter:function(){var a=this.paths[0],d=this.paths[1],e=[],b=this.now,g=a.length;if(1===b)e=this.toD;else if(g===d.length&&1>b)for(;g--;){var c=parseFloat(a[g]);e[g]=isNaN(c)||"A"===d[g-4]||"A"===d[g-5]?d[g]:b*parseFloat(""+(d[g]-c))+c}else e=d;this.elem.attr("d",e,
null,!0)},update:function(){var a=this.elem,d=this.prop,e=this.now,b=this.options.step;if(this[d+"Setter"])this[d+"Setter"]();else a.attr?a.element&&a.attr(d,e,null,!0):a.style[d]=e+this.unit;b&&b.call(a,e,this)},run:function(a,d,e){var l=this,g=l.options,h=function(a){return h.stopped?!1:l.step(a)},p=b.requestAnimationFrame||function(a){setTimeout(a,13)},u=function(){for(var a=0;a<c.timers.length;a++)c.timers[a]()||c.timers.splice(a--,1);c.timers.length&&p(u)};a!==d||this.elem["forceAnimate:"+this.prop]?
(this.startTime=+new Date,this.start=a,this.end=d,this.unit=e,this.now=this.start,this.pos=0,h.elem=this.elem,h.prop=this.prop,h()&&1===c.timers.push(h)&&p(u)):(delete g.curAnim[this.prop],g.complete&&0===Object.keys(g.curAnim).length&&g.complete.call(this.elem))},step:function(a){var d=+new Date,e=this.options,b=this.elem,g=e.complete,c=e.duration,p=e.curAnim;if(b.attr&&!b.element)a=!1;else if(a||d>=c+this.startTime){this.now=this.end;this.pos=1;this.update();var u=p[this.prop]=!0;n(p,function(a){!0!==
a&&(u=!1)});u&&g&&g.call(b);a=!1}else this.pos=e.easing((d-this.startTime)/c),this.now=this.start+(this.end-this.start)*this.pos,this.update(),a=!0;return a},initPath:function(a,d,e){function b(a){for(A=a.length;A--;){var d="M"===a[A]||"L"===a[A];var e=/[a-zA-Z]/.test(a[A+3]);d&&e&&a.splice(A+1,0,a[A+1],a[A+2],a[A+1],a[A+2])}}function g(a,d){for(;a.length<h;){a[0]=d[h-a.length];var e=a.slice(0,r);[].splice.apply(a,[0,0].concat(e));w&&(e=a.slice(a.length-r),[].splice.apply(a,[a.length,0].concat(e)),
A--)}a[0]="M"}function c(a,d){for(var e=(h-a.length)/r;0<e&&e--;)x=a.slice().splice(a.length/m-r,r*m),x[0]=d[h-r-e*r],k&&(x[r-6]=x[r-2],x[r-5]=x[r-1]),[].splice.apply(a,[a.length/m,0].concat(x)),w&&e--}d=d||"";var p=a.startX,u=a.endX,k=-1<d.indexOf("C"),r=k?7:3,x,A;d=d.split(" ");e=e.slice();var w=a.isArea,m=w?2:1;k&&(b(d),b(e));if(p&&u){for(A=0;A<p.length;A++)if(p[A]===u[0]){var K=A;break}else if(p[0]===u[u.length-p.length+A]){K=A;var J=!0;break}else if(p[p.length-1]===u[u.length-p.length+A]){K=
p.length-A;break}"undefined"===typeof K&&(d=[])}if(d.length&&v(K)){var h=e.length+K*m*r;J?(g(d,e),c(e,d)):(g(e,d),c(d,e))}return[d,e]},fillSetter:function(){c.Fx.prototype.strokeSetter.apply(this,arguments)},strokeSetter:function(){this.elem.attr(this.prop,c.color(this.start).tweenTo(c.color(this.end),this.pos),null,!0)}};c.merge=function(){var a,d=arguments,e={},b=function(a,d){"object"!==typeof a&&(a={});n(d,function(e,k){!z(e,!0)||t(e)||B(e)?a[k]=d[k]:a[k]=b(a[k]||{},e)});return a};!0===d[0]&&
(e=d[1],d=Array.prototype.slice.call(d,2));var g=d.length;for(a=0;a<g;a++)e=b(e,d[a]);return e};c.clearTimeout=function(a){C(a)&&clearTimeout(a)};c.css=function(a,d){c.isMS&&!c.svg&&d&&"undefined"!==typeof d.opacity&&(d.filter="alpha(opacity="+100*d.opacity+")");y(a.style,d)};c.createElement=function(a,d,e,b,L){a=g.createElement(a);var l=c.css;d&&y(a,d);L&&l(a,{padding:"0",border:"none",margin:"0"});e&&l(a,e);b&&b.appendChild(a);return a};c.extendClass=function(a,d){var e=function(){};e.prototype=
new a;y(e.prototype,d);return e};c.pad=function(a,d,e){return Array((d||2)+1-String(a).replace("-","").length).join(e||"0")+a};c.relativeLength=function(a,d,e){return/%$/.test(a)?d*parseFloat(a)/100+(e||0):parseFloat(a)};c.wrap=function(a,d,e){var b=a[d];a[d]=function(){var a=Array.prototype.slice.call(arguments),d=arguments,l=this;l.proceed=function(){b.apply(l,arguments.length?arguments:d)};a.unshift(b);a=e.apply(this,a);l.proceed=null;return a}};c.datePropsToTimestamps=function(a){n(a,function(d,
e){z(d)&&"function"===typeof d.getTime?a[e]=d.getTime():(z(d)||G(d))&&c.datePropsToTimestamps(d)})};c.formatSingle=function(a,d,e){var b=/\.([0-9])/,g=c.defaultOptions.lang;/f$/.test(a)?(e=(e=a.match(b))?e[1]:-1,null!==d&&(d=c.numberFormat(d,e,g.decimalPoint,-1<a.indexOf(",")?g.thousandsSep:""))):d=(e||c.time).dateFormat(a,d);return d};c.format=function(a,d,e){for(var b="{",g=!1,h,p,u,k,r=[],x;a;){b=a.indexOf(b);if(-1===b)break;h=a.slice(0,b);if(g){h=h.split(":");p=h.shift().split(".");k=p.length;
x=d;for(u=0;u<k;u++)x&&(x=x[p[u]]);h.length&&(x=c.formatSingle(h.join(":"),x,e));r.push(x)}else r.push(h);a=a.slice(b+1);b=(g=!g)?"}":"{"}r.push(a);return r.join("")};c.getMagnitude=function(a){return Math.pow(10,Math.floor(Math.log(a)/Math.LN10))};c.normalizeTickInterval=function(a,d,e,b,g){var l=a;e=h(e,1);var p=a/e;d||(d=g?[1,1.2,1.5,2,2.5,3,4,5,6,8,10]:[1,2,2.5,5,10],!1===b&&(1===e?d=d.filter(function(a){return 0===a%1}):.1>=e&&(d=[1/e])));for(b=0;b<d.length&&!(l=d[b],g&&l*e>=a||!g&&p<=(d[b]+
(d[b+1]||d[b]))/2);b++);return l=c.correctFloat(l*e,-Math.round(Math.log(.001)/Math.LN10))};c.stableSort=function(a,d){var b=a.length,l,g;for(g=0;g<b;g++)a[g].safeI=g;a.sort(function(a,b){l=d(a,b);return 0===l?a.safeI-b.safeI:l});for(g=0;g<b;g++)delete a[g].safeI};c.correctFloat=function(a,d){return parseFloat(a.toPrecision(d||14))};c.animObject=function(a){return z(a)?c.merge(a):{duration:a?500:0}};c.timeUnits={millisecond:1,second:1E3,minute:6E4,hour:36E5,day:864E5,week:6048E5,month:24192E5,year:314496E5};
c.numberFormat=function(a,d,b,l){a=+a||0;d=+d;var e=c.defaultOptions.lang,g=(a.toString().split(".")[1]||"").split("e")[0].length,p=a.toString().split("e");if(-1===d)d=Math.min(g,20);else if(!v(d))d=2;else if(d&&p[1]&&0>p[1]){var u=d+ +p[1];0<=u?(p[0]=(+p[0]).toExponential(u).split("e")[0],d=u):(p[0]=p[0].split(".")[0]||0,a=20>d?(p[0]*Math.pow(10,p[1])).toFixed(d):0,p[1]=0)}var k=(Math.abs(p[1]?p[0]:a)+Math.pow(10,-Math.max(d,g)-1)).toFixed(d);g=String(f(k));u=3<g.length?g.length%3:0;b=h(b,e.decimalPoint);
l=h(l,e.thousandsSep);a=(0>a?"-":"")+(u?g.substr(0,u)+l:"");a+=g.substr(u).replace(/(\d{3})(?=\d)/g,"$1"+l);d&&(a+=b+k.slice(-d));p[1]&&0!==+a&&(a+="e"+p[1]);return a};Math.easeInOutSine=function(a){return-.5*(Math.cos(Math.PI*a)-1)};c.getStyle=function(a,d,e){if("width"===d)return d=Math.min(a.offsetWidth,a.scrollWidth),e=a.getBoundingClientRect&&a.getBoundingClientRect().width,e<d&&e>=d-1&&(d=Math.floor(e)),Math.max(0,d-c.getStyle(a,"padding-left")-c.getStyle(a,"padding-right"));if("height"===d)return Math.max(0,
Math.min(a.offsetHeight,a.scrollHeight)-c.getStyle(a,"padding-top")-c.getStyle(a,"padding-bottom"));b.getComputedStyle||c.error(27,!0);if(a=b.getComputedStyle(a,void 0))a=a.getPropertyValue(d),h(e,"opacity"!==d)&&(a=f(a));return a};c.inArray=function(a,d,b){return d.indexOf(a,b)};c.find=Array.prototype.find?function(a,d){return a.find(d)}:function(a,d){var b,l=a.length;for(b=0;b<l;b++)if(d(a[b],b))return a[b]};c.keys=Object.keys;c.offset=function(a){var d=g.documentElement;a=a.parentElement||a.parentNode?
a.getBoundingClientRect():{top:0,left:0};return{top:a.top+(b.pageYOffset||d.scrollTop)-(d.clientTop||0),left:a.left+(b.pageXOffset||d.scrollLeft)-(d.clientLeft||0)}};c.stop=function(a,b){for(var d=c.timers.length;d--;)c.timers[d].elem!==a||b&&b!==c.timers[d].prop||(c.timers[d].stopped=!0)};n({map:"map",each:"forEach",grep:"filter",reduce:"reduce",some:"some"},function(a,b){c[b]=function(b){return Array.prototype[a].apply(b,[].slice.call(arguments,1))}});c.addEvent=function(a,b,e,l){void 0===l&&(l=
{});var d=a.addEventListener||c.addEventListenerPolyfill;var g="function"===typeof a&&a.prototype?a.prototype.protoEvents=a.prototype.protoEvents||{}:a.hcEvents=a.hcEvents||{};c.Point&&a instanceof c.Point&&a.series&&a.series.chart&&(a.series.chart.runTrackerClick=!0);d&&d.call(a,b,e,!1);g[b]||(g[b]=[]);g[b].push({fn:e,order:"number"===typeof l.order?l.order:Infinity});g[b].sort(function(a,b){return a.order-b.order});return function(){c.removeEvent(a,b,e)}};c.removeEvent=function(a,b,e){function d(b,
d){var e=a.removeEventListener||c.removeEventListenerPolyfill;e&&e.call(a,b,d,!1)}function g(e){var l;if(a.nodeName){if(b){var k={};k[b]=!0}else k=e;n(k,function(a,b){if(e[b])for(l=e[b].length;l--;)d(b,e[b][l].fn)})}}var h;["protoEvents","hcEvents"].forEach(function(l,c){var k=(c=c?a:a.prototype)&&c[l];k&&(b?(h=k[b]||[],e?(k[b]=h.filter(function(a){return e!==a.fn}),d(b,e)):(g(k),k[b]=[])):(g(k),c[l]={}))})};c.fireEvent=function(a,b,e,l){var d;e=e||{};if(g.createEvent&&(a.dispatchEvent||a.fireEvent)){var c=
g.createEvent("Events");c.initEvent(b,!0,!0);y(c,e);a.dispatchEvent?a.dispatchEvent(c):a.fireEvent(b,c)}else e.target||y(e,{preventDefault:function(){e.defaultPrevented=!0},target:a,type:b}),function(b,l){void 0===b&&(b=[]);void 0===l&&(l=[]);var k=0,r=0,g=b.length+l.length;for(d=0;d<g;d++)!1===(b[k]?l[r]?b[k].order<=l[r].order?b[k++]:l[r++]:b[k++]:l[r++]).fn.call(a,e)&&e.preventDefault()}(a.protoEvents&&a.protoEvents[b],a.hcEvents&&a.hcEvents[b]);l&&!e.defaultPrevented&&l.call(a,e)};c.animate=function(a,
b,e){var d,g="",h,p;if(!z(e)){var u=arguments;e={duration:u[2],easing:u[3],complete:u[4]}}v(e.duration)||(e.duration=400);e.easing="function"===typeof e.easing?e.easing:Math[e.easing]||Math.easeInOutSine;e.curAnim=c.merge(b);n(b,function(k,l){c.stop(a,l);p=new c.Fx(a,e,l);h=null;"d"===l?(p.paths=p.initPath(a,a.d,b.d),p.toD=b.d,d=0,h=1):a.attr?d=a.attr(l):(d=parseFloat(c.getStyle(a,l))||0,"opacity"!==l&&(g="px"));h||(h=k);h&&h.match&&h.match("px")&&(h=h.replace(/px/g,""));p.run(d,h,g)})};c.seriesType=
function(a,b,e,l,g){var d=c.getOptions(),p=c.seriesTypes;d.plotOptions[a]=c.merge(d.plotOptions[b],e);p[a]=c.extendClass(p[b]||function(){},l);p[a].prototype.type=a;g&&(p[a].prototype.pointClass=c.extendClass(c.Point,g));return p[a]};c.uniqueKey=function(){var a=Math.random().toString(36).substring(2,9),b=0;return function(){return"highcharts-"+a+"-"+b++}}();c.isFunction=function(a){return"function"===typeof a};b.jQuery&&(b.jQuery.fn.highcharts=function(){var a=[].slice.call(arguments);if(this[0])return a[0]?
(new (c[F(a[0])?a.shift():"Chart"])(this[0],a[0],a[1]),this):q[H(this[0],"data-highcharts-chart")]});return{arrayMax:function(a){for(var b=a.length,e=a[0];b--;)a[b]>e&&(e=a[b]);return e},arrayMin:function(a){for(var b=a.length,e=a[0];b--;)a[b]<e&&(e=a[b]);return e},attr:H,defined:C,destroyObjectProperties:function(a,b){n(a,function(d,l){d&&d!==b&&d.destroy&&d.destroy();delete a[l]})},discardElement:function(a){var b=c.garbageBin;b||(b=c.createElement("div"));a&&b.appendChild(a);b.innerHTML=""},erase:function(a,
b){for(var d=a.length;d--;)if(a[d]===b){a.splice(d,1);break}},extend:y,isArray:G,isClass:t,isDOMElement:B,isNumber:v,isObject:z,isString:F,objectEach:n,pick:h,pInt:f,setAnimation:function(a,b){b.renderer.globalAnimation=h(a,b.options.chart.animation,!0)},splat:function(a){return G(a)?a:[a]},syncTimeout:function(a,b,e){if(0<b)return setTimeout(a,b,e);a.call(0,e);return-1}}});M(I,"parts/Color.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.isNumber,G=f.pInt,z=c.merge;c.Color=
function(f){if(!(this instanceof c.Color))return new c.Color(f);this.init(f)};c.Color.prototype={parsers:[{regex:/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]?(?:\.[0-9]+)?)\s*\)/,parse:function(c){return[G(c[1]),G(c[2]),G(c[3]),parseFloat(c[4],10)]}},{regex:/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/,parse:function(c){return[G(c[1]),G(c[2]),G(c[3]),1]}}],names:{white:"#ffffff",black:"#000000"},init:function(f){var t,v;if((this.input=f=this.names[f&&
f.toLowerCase?f.toLowerCase():""]||f)&&f.stops)this.stops=f.stops.map(function(f){return new c.Color(f[1])});else{if(f&&f.charAt&&"#"===f.charAt()){var C=f.length;f=parseInt(f.substr(1),16);7===C?t=[(f&16711680)>>16,(f&65280)>>8,f&255,1]:4===C&&(t=[(f&3840)>>4|(f&3840)>>8,(f&240)>>4|f&240,(f&15)<<4|f&15,1])}if(!t)for(v=this.parsers.length;v--&&!t;){var B=this.parsers[v];(C=B.regex.exec(f))&&(t=B.parse(C))}}this.rgba=t||[]},get:function(c){var f=this.input,v=this.rgba;if(this.stops){var C=z(f);C.stops=
[].concat(C.stops);this.stops.forEach(function(f,v){C.stops[v]=[C.stops[v][0],f.get(c)]})}else C=v&&F(v[0])?"rgb"===c||!c&&1===v[3]?"rgb("+v[0]+","+v[1]+","+v[2]+")":"a"===c?v[3]:"rgba("+v.join(",")+")":f;return C},brighten:function(c){var f,v=this.rgba;if(this.stops)this.stops.forEach(function(f){f.brighten(c)});else if(F(c)&&0!==c)for(f=0;3>f;f++)v[f]+=G(255*c),0>v[f]&&(v[f]=0),255<v[f]&&(v[f]=255);return this},setOpacity:function(c){this.rgba[3]=c;return this},tweenTo:function(c,f){var v=this.rgba,
t=c.rgba;t.length&&v&&v.length?(c=1!==t[3]||1!==v[3],f=(c?"rgba(":"rgb(")+Math.round(t[0]+(v[0]-t[0])*(1-f))+","+Math.round(t[1]+(v[1]-t[1])*(1-f))+","+Math.round(t[2]+(v[2]-t[2])*(1-f))+(c?","+(t[3]+(v[3]-t[3])*(1-f)):"")+")"):f=c.input||"none";return f}};c.color=function(f){return new c.Color(f)}});M(I,"parts/SvgRenderer.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.attr,G=f.defined,z=f.destroyObjectProperties,B=f.erase,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isObject,
y=f.isString,h=f.objectEach,n=f.pick,q=f.pInt,g=f.splat,b=c.addEvent,a=c.animate,d=c.charts,e=c.color,l=c.css,L=c.createElement,E=c.deg2rad,p=c.doc,u=c.hasTouch,k=c.isFirefox,r=c.isMS,x=c.isWebKit,A=c.merge,w=c.noop,m=c.removeEvent,K=c.stop,J=c.svg,U=c.SVG_NS,S=c.symbolSizes,Q=c.win;var O=c.SVGElement=function(){return this};t(O.prototype,{opacity:1,SVG_NS:U,textProps:"direction fontSize fontWeight fontFamily fontStyle color lineHeight width textAlign textDecoration textOverflow textOutline cursor".split(" "),
init:function(a,b){this.element="span"===b?L(b):p.createElementNS(this.SVG_NS,b);this.renderer=a;c.fireEvent(this,"afterInit")},animate:function(b,d,m){var D=c.animObject(n(d,this.renderer.globalAnimation,!0));n(p.hidden,p.msHidden,p.webkitHidden,!1)&&(D.duration=0);0!==D.duration?(m&&(D.complete=m),a(this,b,D)):(this.attr(b,void 0,m),h(b,function(a,b){D.step&&D.step.call(this,a,{prop:b,pos:1})},this));return this},complexColor:function(a,b,d){var D=this.renderer,m,e,w,N,k,l,g,r,x,p,K,J=[],T;c.fireEvent(this.renderer,
"complexColor",{args:arguments},function(){a.radialGradient?e="radialGradient":a.linearGradient&&(e="linearGradient");e&&(w=a[e],k=D.gradients,g=a.stops,p=d.radialReference,v(w)&&(a[e]=w={x1:w[0],y1:w[1],x2:w[2],y2:w[3],gradientUnits:"userSpaceOnUse"}),"radialGradient"===e&&p&&!G(w.gradientUnits)&&(N=w,w=A(w,D.getRadialAttr(p,N),{gradientUnits:"userSpaceOnUse"})),h(w,function(a,b){"id"!==b&&J.push(b,a)}),h(g,function(a){J.push(a)}),J=J.join(","),k[J]?K=k[J].attr("id"):(w.id=K=c.uniqueKey(),k[J]=l=
D.createElement(e).attr(w).add(D.defs),l.radAttr=N,l.stops=[],g.forEach(function(a){0===a[1].indexOf("rgba")?(m=c.color(a[1]),r=m.get("rgb"),x=m.get("a")):(r=a[1],x=1);a=D.createElement("stop").attr({offset:a[0],"stop-color":r,"stop-opacity":x}).add(l);l.stops.push(a)})),T="url("+D.url+"#"+K+")",d.setAttribute(b,T),d.gradient=J,a.toString=function(){return T})})},applyTextOutline:function(a){var b=this.element,D;-1!==a.indexOf("contrast")&&(a=a.replace(/contrast/g,this.renderer.getContrast(b.style.fill)));
a=a.split(" ");var d=a[a.length-1];if((D=a[0])&&"none"!==D&&c.svg){this.fakeTS=!0;a=[].slice.call(b.getElementsByTagName("tspan"));this.ySetter=this.xSetter;D=D.replace(/(^[\d\.]+)(.*?)$/g,function(a,b,D){return 2*b+D});this.removeTextOutline(a);var m=b.firstChild;a.forEach(function(a,e){0===e&&(a.setAttribute("x",b.getAttribute("x")),e=b.getAttribute("y"),a.setAttribute("y",e||0),null===e&&b.setAttribute("y",0));a=a.cloneNode(1);F(a,{"class":"highcharts-text-outline",fill:d,stroke:d,"stroke-width":D,
"stroke-linejoin":"round"});b.insertBefore(a,m)})}},removeTextOutline:function(a){for(var b=a.length,D;b--;)D=a[b],"highcharts-text-outline"===D.getAttribute("class")&&B(a,this.element.removeChild(D))},symbolCustomAttribs:"x y width height r start end innerR anchorX anchorY rounded".split(" "),attr:function(a,b,d,e){var D=this.element,m,w=this,N,k,l=this.symbolCustomAttribs;if("string"===typeof a&&void 0!==b){var g=a;a={};a[g]=b}"string"===typeof a?w=(this[a+"Getter"]||this._defaultGetter).call(this,
a,D):(h(a,function(b,d){N=!1;e||K(this,d);this.symbolName&&-1!==c.inArray(d,l)&&(m||(this.symbolAttr(a),m=!0),N=!0);!this.rotation||"x"!==d&&"y"!==d||(this.doTransform=!0);N||(k=this[d+"Setter"]||this._defaultSetter,k.call(this,b,d,D),!this.styledMode&&this.shadows&&/^(width|height|visibility|x|y|d|transform|cx|cy|r)$/.test(d)&&this.updateShadows(d,b,k))},this),this.afterSetters());d&&d.call(this);return w},afterSetters:function(){this.doTransform&&(this.updateTransform(),this.doTransform=!1)},updateShadows:function(a,
b,d){for(var D=this.shadows,e=D.length;e--;)d.call(D[e],"height"===a?Math.max(b-(D[e].cutHeight||0),0):"d"===a?this.d:b,a,D[e])},addClass:function(a,b){var D=b?"":this.attr("class")||"";a=(a||"").split(/ /g).reduce(function(a,b){-1===D.indexOf(b)&&a.push(b);return a},D?[D]:[]).join(" ");a!==D&&this.attr("class",a);return this},hasClass:function(a){return-1!==(this.attr("class")||"").split(" ").indexOf(a)},removeClass:function(a){return this.attr("class",(this.attr("class")||"").replace(y(a)?new RegExp(" ?"+
a+" ?"):a,""))},symbolAttr:function(a){var b=this;"x y r start end width height innerR anchorX anchorY clockwise".split(" ").forEach(function(D){b[D]=n(a[D],b[D])});b.attr({d:b.renderer.symbols[b.symbolName](b.x,b.y,b.width,b.height,b)})},clip:function(a){return this.attr("clip-path",a?"url("+this.renderer.url+"#"+a.id+")":"none")},crisp:function(a,b){b=b||a.strokeWidth||0;var D=Math.round(b)%2/2;a.x=Math.floor(a.x||this.x||0)+D;a.y=Math.floor(a.y||this.y||0)+D;a.width=Math.floor((a.width||this.width||
0)-2*D);a.height=Math.floor((a.height||this.height||0)-2*D);G(a.strokeWidth)&&(a.strokeWidth=b);return a},css:function(a){var b=this.styles,D={},d=this.element,e="",m=!b,w=["textOutline","textOverflow","width"];a&&a.color&&(a.fill=a.color);b&&h(a,function(a,d){a!==b[d]&&(D[d]=a,m=!0)});if(m){b&&(a=t(b,D));if(a)if(null===a.width||"auto"===a.width)delete this.textWidth;else if("text"===d.nodeName.toLowerCase()&&a.width)var k=this.textWidth=q(a.width);this.styles=a;k&&!J&&this.renderer.forExport&&delete a.width;
if(d.namespaceURI===this.SVG_NS){var g=function(a,b){return"-"+b.toLowerCase()};h(a,function(a,b){-1===w.indexOf(b)&&(e+=b.replace(/([A-Z])/g,g)+":"+a+";")});e&&F(d,"style",e)}else l(d,a);this.added&&("text"===this.element.nodeName&&this.renderer.buildText(this),a&&a.textOutline&&this.applyTextOutline(a.textOutline))}return this},getStyle:function(a){return Q.getComputedStyle(this.element||this,"").getPropertyValue(a)},strokeWidth:function(){if(!this.renderer.styledMode)return this["stroke-width"]||
0;var a=this.getStyle("stroke-width");if(a.indexOf("px")===a.length-2)a=q(a);else{var b=p.createElementNS(U,"rect");F(b,{width:a,"stroke-width":0});this.element.parentNode.appendChild(b);a=b.getBBox().width;b.parentNode.removeChild(b)}return a},on:function(a,b){var d=this,D=d.element;u&&"click"===a?(D.ontouchstart=function(a){d.touchEventFired=Date.now();a.preventDefault();b.call(D,a)},D.onclick=function(a){(-1===Q.navigator.userAgent.indexOf("Android")||1100<Date.now()-(d.touchEventFired||0))&&b.call(D,
a)}):D["on"+a]=b;return this},setRadialReference:function(a){var b=this.renderer.gradients[this.element.gradient];this.element.radialReference=a;b&&b.radAttr&&b.animate(this.renderer.getRadialAttr(a,b.radAttr));return this},translate:function(a,b){return this.attr({translateX:a,translateY:b})},invert:function(a){this.inverted=a;this.updateTransform();return this},updateTransform:function(){var a=this.translateX||0,b=this.translateY||0,d=this.scaleX,e=this.scaleY,m=this.inverted,w=this.rotation,k=
this.matrix,l=this.element;m&&(a+=this.width,b+=this.height);a=["translate("+a+","+b+")"];G(k)&&a.push("matrix("+k.join(",")+")");m?a.push("rotate(90) scale(-1,1)"):w&&a.push("rotate("+w+" "+n(this.rotationOriginX,l.getAttribute("x"),0)+" "+n(this.rotationOriginY,l.getAttribute("y")||0)+")");(G(d)||G(e))&&a.push("scale("+n(d,1)+" "+n(e,1)+")");a.length&&l.setAttribute("transform",a.join(" "))},toFront:function(){var a=this.element;a.parentNode.appendChild(a);return this},align:function(a,b,d){var e,
m={};var D=this.renderer;var w=D.alignedObjects;var k,l;if(a){if(this.alignOptions=a,this.alignByTranslate=b,!d||y(d))this.alignTo=e=d||"renderer",B(w,this),w.push(this),d=null}else a=this.alignOptions,b=this.alignByTranslate,e=this.alignTo;d=n(d,D[e],D);e=a.align;D=a.verticalAlign;w=(d.x||0)+(a.x||0);var N=(d.y||0)+(a.y||0);"right"===e?k=1:"center"===e&&(k=2);k&&(w+=(d.width-(a.width||0))/k);m[b?"translateX":"x"]=Math.round(w);"bottom"===D?l=1:"middle"===D&&(l=2);l&&(N+=(d.height-(a.height||0))/
l);m[b?"translateY":"y"]=Math.round(N);this[this.placed?"animate":"attr"](m);this.placed=!0;this.alignAttr=m;return this},getBBox:function(a,b){var d,e=this.renderer,m=this.element,D=this.styles,w=this.textStr,k,l=e.cache,N=e.cacheKeys,g=m.namespaceURI===this.SVG_NS;b=n(b,this.rotation,0);var r=e.styledMode?m&&O.prototype.getStyle.call(m,"font-size"):D&&D.fontSize;if(G(w)){var c=w.toString();-1===c.indexOf("<")&&(c=c.replace(/[0-9]/g,"0"));c+=["",b,r,this.textWidth,D&&D.textOverflow].join()}c&&!a&&
(d=l[c]);if(!d){if(g||e.forExport){try{(k=this.fakeTS&&function(a){[].forEach.call(m.querySelectorAll(".highcharts-text-outline"),function(b){b.style.display=a})})&&k("none"),d=m.getBBox?t({},m.getBBox()):{width:m.offsetWidth,height:m.offsetHeight},k&&k("")}catch(aa){""}if(!d||0>d.width)d={width:0,height:0}}else d=this.htmlGetBBox();e.isSVG&&(a=d.width,e=d.height,g&&(d.height=e={"11px,17":14,"13px,20":16}[D&&D.fontSize+","+Math.round(e)]||e),b&&(D=b*E,d.width=Math.abs(e*Math.sin(D))+Math.abs(a*Math.cos(D)),
d.height=Math.abs(e*Math.cos(D))+Math.abs(a*Math.sin(D))));if(c&&0<d.height){for(;250<N.length;)delete l[N.shift()];l[c]||N.push(c);l[c]=d}}return d},show:function(a){return this.attr({visibility:a?"inherit":"visible"})},hide:function(a){a?this.attr({y:-9999}):this.attr({visibility:"hidden"});return this},fadeOut:function(a){var b=this;b.animate({opacity:0},{duration:a||150,complete:function(){b.attr({y:-9999})}})},add:function(a){var b=this.renderer,d=this.element;a&&(this.parentGroup=a);this.parentInverted=
a&&a.inverted;void 0!==this.textStr&&b.buildText(this);this.added=!0;if(!a||a.handleZ||this.zIndex)var e=this.zIndexSetter();e||(a?a.element:b.box).appendChild(d);if(this.onAdd)this.onAdd();return this},safeRemoveChild:function(a){var b=a.parentNode;b&&b.removeChild(a)},destroy:function(){var a=this,b=a.element||{},d=a.renderer,e=d.isSVG&&"SPAN"===b.nodeName&&a.parentGroup,m=b.ownerSVGElement,w=a.clipPath;b.onclick=b.onmouseout=b.onmouseover=b.onmousemove=b.point=null;K(a);w&&m&&([].forEach.call(m.querySelectorAll("[clip-path],[CLIP-PATH]"),
function(a){-1<a.getAttribute("clip-path").indexOf(w.element.id)&&a.removeAttribute("clip-path")}),a.clipPath=w.destroy());if(a.stops){for(m=0;m<a.stops.length;m++)a.stops[m]=a.stops[m].destroy();a.stops=null}a.safeRemoveChild(b);for(d.styledMode||a.destroyShadows();e&&e.div&&0===e.div.childNodes.length;)b=e.parentGroup,a.safeRemoveChild(e.div),delete e.div,e=b;a.alignTo&&B(d.alignedObjects,a);h(a,function(b,d){a[d]&&a[d].parentGroup===a&&a[d].destroy&&a[d].destroy();delete a[d]})},shadow:function(a,
b,d){var e=[],m,w=this.element;if(!a)this.destroyShadows();else if(!this.shadows){var D=n(a.width,3);var k=(a.opacity||.15)/D;var l=this.parentInverted?"(-1,-1)":"("+n(a.offsetX,1)+", "+n(a.offsetY,1)+")";for(m=1;m<=D;m++){var g=w.cloneNode(0);var r=2*D+1-2*m;F(g,{stroke:a.color||"#000000","stroke-opacity":k*m,"stroke-width":r,transform:"translate"+l,fill:"none"});g.setAttribute("class",(g.getAttribute("class")||"")+" highcharts-shadow");d&&(F(g,"height",Math.max(F(g,"height")-r,0)),g.cutHeight=r);
b?b.element.appendChild(g):w.parentNode&&w.parentNode.insertBefore(g,w);e.push(g)}this.shadows=e}return this},destroyShadows:function(){(this.shadows||[]).forEach(function(a){this.safeRemoveChild(a)},this);this.shadows=void 0},xGetter:function(a){"circle"===this.element.nodeName&&("x"===a?a="cx":"y"===a&&(a="cy"));return this._defaultGetter(a)},_defaultGetter:function(a){a=n(this[a+"Value"],this[a],this.element?this.element.getAttribute(a):null,0);/^[\-0-9\.]+$/.test(a)&&(a=parseFloat(a));return a},
dSetter:function(a,b,d){a&&a.join&&(a=a.join(" "));/(NaN| {2}|^$)/.test(a)&&(a="M 0 0");this[b]!==a&&(d.setAttribute(b,a),this[b]=a)},dashstyleSetter:function(a){var b,d=this["stroke-width"];"inherit"===d&&(d=1);if(a=a&&a.toLowerCase()){a=a.replace("shortdashdotdot","3,1,1,1,1,1,").replace("shortdashdot","3,1,1,1").replace("shortdot","1,1,").replace("shortdash","3,1,").replace("longdash","8,3,").replace(/dot/g,"1,3,").replace("dash","4,3,").replace(/,$/,"").split(",");for(b=a.length;b--;)a[b]=q(a[b])*
d;a=a.join(",").replace(/NaN/g,"none");this.element.setAttribute("stroke-dasharray",a)}},alignSetter:function(a){var b={left:"start",center:"middle",right:"end"};b[a]&&(this.alignValue=a,this.element.setAttribute("text-anchor",b[a]))},opacitySetter:function(a,b,d){this[b]=a;d.setAttribute(b,a)},titleSetter:function(a){var b=this.element.getElementsByTagName("title")[0];b||(b=p.createElementNS(this.SVG_NS,"title"),this.element.appendChild(b));b.firstChild&&b.removeChild(b.firstChild);b.appendChild(p.createTextNode(String(n(a,
"")).replace(/<[^>]*>/g,"").replace(/&lt;/g,"<").replace(/&gt;/g,">")))},textSetter:function(a){a!==this.textStr&&(delete this.bBox,delete this.textPxLength,this.textStr=a,this.added&&this.renderer.buildText(this))},setTextPath:function(a,b){var d=this.element,e={textAnchor:"text-anchor"},m=!1,D=this.textPathWrapper,k=!D;b=A(!0,{enabled:!0,attributes:{dy:-5,startOffset:"50%",textAnchor:"middle"}},b);var l=b.attributes;if(a&&b&&b.enabled){this.options&&this.options.padding&&(l.dx=-this.options.padding);
D||(this.textPathWrapper=D=this.renderer.createElement("textPath"),m=!0);var g=D.element;(b=a.element.getAttribute("id"))||a.element.setAttribute("id",b=c.uniqueKey());if(k)for(a=d.getElementsByTagName("tspan");a.length;)a[0].setAttribute("y",0),g.appendChild(a[0]);m&&D.add({element:this.text?this.text.element:d});g.setAttributeNS("http://www.w3.org/1999/xlink","href",this.renderer.url+"#"+b);G(l.dy)&&(g.parentNode.setAttribute("dy",l.dy),delete l.dy);G(l.dx)&&(g.parentNode.setAttribute("dx",l.dx),
delete l.dx);h(l,function(a,b){g.setAttribute(e[b]||b,a)});d.removeAttribute("transform");this.removeTextOutline.call(D,[].slice.call(d.getElementsByTagName("tspan")));this.text&&!this.renderer.styledMode&&this.attr({fill:"none","stroke-width":0});this.applyTextOutline=this.updateTransform=w}else D&&(delete this.updateTransform,delete this.applyTextOutline,this.destroyTextPath(d,a));return this},destroyTextPath:function(a,b){var d;b.element.setAttribute("id","");for(d=this.textPathWrapper.element.childNodes;d.length;)a.firstChild.appendChild(d[0]);
a.firstChild.removeChild(this.textPathWrapper.element);delete b.textPathWrapper},fillSetter:function(a,b,d){"string"===typeof a?d.setAttribute(b,a):a&&this.complexColor(a,b,d)},visibilitySetter:function(a,b,d){"inherit"===a?d.removeAttribute(b):this[b]!==a&&d.setAttribute(b,a);this[b]=a},zIndexSetter:function(a,b){var d=this.renderer,e=this.parentGroup,m=(e||d).element||d.box,w=this.element,k=!1;d=m===d.box;var D=this.added;var l;G(a)?(w.setAttribute("data-z-index",a),a=+a,this[b]===a&&(D=!1)):G(this[b])&&
w.removeAttribute("data-z-index");this[b]=a;if(D){(a=this.zIndex)&&e&&(e.handleZ=!0);b=m.childNodes;for(l=b.length-1;0<=l&&!k;l--){e=b[l];D=e.getAttribute("data-z-index");var g=!G(D);if(e!==w)if(0>a&&g&&!d&&!l)m.insertBefore(w,b[l]),k=!0;else if(q(D)<=a||g&&(!G(a)||0<=a))m.insertBefore(w,b[l+1]||null),k=!0}k||(m.insertBefore(w,b[d?3:0]||null),k=!0)}return k},_defaultSetter:function(a,b,d){d.setAttribute(b,a)}});O.prototype.yGetter=O.prototype.xGetter;O.prototype.translateXSetter=O.prototype.translateYSetter=
O.prototype.rotationSetter=O.prototype.verticalAlignSetter=O.prototype.rotationOriginXSetter=O.prototype.rotationOriginYSetter=O.prototype.scaleXSetter=O.prototype.scaleYSetter=O.prototype.matrixSetter=function(a,b){this[b]=a;this.doTransform=!0};O.prototype["stroke-widthSetter"]=O.prototype.strokeSetter=function(a,b,d){this[b]=a;this.stroke&&this["stroke-width"]?(O.prototype.fillSetter.call(this,this.stroke,"stroke",d),d.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0):"stroke-width"===
b&&0===a&&this.hasStroke?(d.removeAttribute("stroke"),this.hasStroke=!1):this.renderer.styledMode&&this["stroke-width"]&&(d.setAttribute("stroke-width",this["stroke-width"]),this.hasStroke=!0)};f=c.SVGRenderer=function(){this.init.apply(this,arguments)};t(f.prototype,{Element:O,SVG_NS:U,init:function(a,d,e,m,w,g,r){var D=this.createElement("svg").attr({version:"1.1","class":"highcharts-root"});r||D.css(this.getStyle(m));m=D.element;a.appendChild(m);F(a,"dir","ltr");-1===a.innerHTML.indexOf("xmlns")&&
F(m,"xmlns",this.SVG_NS);this.isSVG=!0;this.box=m;this.boxWrapper=D;this.alignedObjects=[];this.url=(k||x)&&p.getElementsByTagName("base").length?Q.location.href.split("#")[0].replace(/<[^>]*>/g,"").replace(/([\('\)])/g,"\\$1").replace(/ /g,"%20"):"";this.createElement("desc").add().element.appendChild(p.createTextNode("Created with Highcharts 7.2.1"));this.defs=this.createElement("defs").add();this.allowHTML=g;this.forExport=w;this.styledMode=r;this.gradients={};this.cache={};this.cacheKeys=[];this.imgCount=
0;this.setSize(d,e,!1);var c;k&&a.getBoundingClientRect&&(d=function(){l(a,{left:0,top:0});c=a.getBoundingClientRect();l(a,{left:Math.ceil(c.left)-c.left+"px",top:Math.ceil(c.top)-c.top+"px"})},d(),this.unSubPixelFix=b(Q,"resize",d))},definition:function(a){function b(a,e){var m;g(a).forEach(function(a){var w=d.createElement(a.tagName),k={};h(a,function(a,b){"tagName"!==b&&"children"!==b&&"textContent"!==b&&(k[b]=a)});w.attr(k);w.add(e||d.defs);a.textContent&&w.element.appendChild(p.createTextNode(a.textContent));
b(a.children||[],w);m=w});return m}var d=this;return b(a)},getStyle:function(a){return this.style=t({fontFamily:'"Lucida Grande", "Lucida Sans Unicode", Arial, Helvetica, sans-serif',fontSize:"12px"},a)},setStyle:function(a){this.boxWrapper.css(this.getStyle(a))},isHidden:function(){return!this.boxWrapper.getBBox().width},destroy:function(){var a=this.defs;this.box=null;this.boxWrapper=this.boxWrapper.destroy();z(this.gradients||{});this.gradients=null;a&&(this.defs=a.destroy());this.unSubPixelFix&&
this.unSubPixelFix();return this.alignedObjects=null},createElement:function(a){var b=new this.Element;b.init(this,a);return b},draw:w,getRadialAttr:function(a,b){return{cx:a[0]-a[2]/2+b.cx*a[2],cy:a[1]-a[2]/2+b.cy*a[2],r:b.r*a[2]}},truncate:function(a,b,d,e,m,w,k){var l=this,D=a.rotation,g,r=e?1:0,c=(d||e).length,x=c,J=[],K=function(a){b.firstChild&&b.removeChild(b.firstChild);a&&b.appendChild(p.createTextNode(a))},N=function(w,D){D=D||w;if(void 0===J[D])if(b.getSubStringLength)try{J[D]=m+b.getSubStringLength(0,
e?D+1:D)}catch(ba){""}else l.getSpanWidth&&(K(k(d||e,w)),J[D]=m+l.getSpanWidth(a,b));return J[D]},A;a.rotation=0;var h=N(b.textContent.length);if(A=m+h>w){for(;r<=c;)x=Math.ceil((r+c)/2),e&&(g=k(e,x)),h=N(x,g&&g.length-1),r===c?r=c+1:h>w?c=x-1:r=x;0===c?K(""):d&&c===d.length-1||K(g||k(d||e,x))}e&&e.splice(0,x);a.actualWidth=h;a.rotation=D;return A},escapes:{"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"},buildText:function(a){var b=a.element,d=this,e=d.forExport,m=n(a.textStr,"").toString(),
w=-1!==m.indexOf("<"),k=b.childNodes,D,g=F(b,"x"),r=a.styles,c=a.textWidth,x=r&&r.lineHeight,K=r&&r.textOutline,A=r&&"ellipsis"===r.textOverflow,u=r&&"nowrap"===r.whiteSpace,L=r&&r.fontSize,E,f=k.length;r=c&&!a.added&&this.box;var S=function(a){var m;d.styledMode||(m=/(px|em)$/.test(a&&a.style.fontSize)?a.style.fontSize:L||d.style.fontSize||12);return x?q(x):d.fontMetrics(m,a.getAttribute("style")?a:b).h},v=function(a,b){h(d.escapes,function(d,m){b&&-1!==b.indexOf(d)||(a=a.toString().replace(new RegExp(d,
"g"),m))});return a},O=function(a,b){var d=a.indexOf("<");a=a.substring(d,a.indexOf(">")-d);d=a.indexOf(b+"=");if(-1!==d&&(d=d+b.length+1,b=a.charAt(d),'"'===b||"'"===b))return a=a.substring(d+1),a.substring(0,a.indexOf(b))},Q=/<br.*?>/g;var t=[m,A,u,x,K,L,c].join();if(t!==a.textCache){for(a.textCache=t;f--;)b.removeChild(k[f]);w||K||A||c||-1!==m.indexOf(" ")&&(!u||Q.test(m))?(r&&r.appendChild(b),w?(m=d.styledMode?m.replace(/<(b|strong)>/g,'<span class="highcharts-strong">').replace(/<(i|em)>/g,'<span class="highcharts-emphasized">'):
m.replace(/<(b|strong)>/g,'<span style="font-weight:bold">').replace(/<(i|em)>/g,'<span style="font-style:italic">'),m=m.replace(/<a/g,"<span").replace(/<\/(b|strong|i|em|a)>/g,"</span>").split(Q)):m=[m],m=m.filter(function(a){return""!==a}),m.forEach(function(m,w){var k=0,r=0;m=m.replace(/^\s+|\s+$/g,"").replace(/<span/g,"|||<span").replace(/<\/span>/g,"</span>|||");var x=m.split("|||");x.forEach(function(m){if(""!==m||1===x.length){var K={},N=p.createElementNS(d.SVG_NS,"tspan"),h,n;(h=O(m,"class"))&&
F(N,"class",h);if(h=O(m,"style"))h=h.replace(/(;| |^)color([ :])/,"$1fill$2"),F(N,"style",h);(n=O(m,"href"))&&!e&&(F(N,"onclick",'location.href="'+n+'"'),F(N,"class","highcharts-anchor"),d.styledMode||l(N,{cursor:"pointer"}));m=v(m.replace(/<[a-zA-Z\/](.|\n)*?>/g,"")||" ");if(" "!==m){N.appendChild(p.createTextNode(m));k?K.dx=0:w&&null!==g&&(K.x=g);F(N,K);b.appendChild(N);!k&&E&&(!J&&e&&l(N,{display:"block"}),F(N,"dy",S(N)));if(c){var T=m.replace(/([^\^])-/g,"$1- ").split(" ");K=!u&&(1<x.length||
w||1<T.length);n=0;var f=S(N);if(A)D=d.truncate(a,N,m,void 0,0,Math.max(0,c-parseInt(L||12,10)),function(a,b){return a.substring(0,b)+"\u2026"});else if(K)for(;T.length;)T.length&&!u&&0<n&&(N=p.createElementNS(U,"tspan"),F(N,{dy:f,x:g}),h&&F(N,"style",h),N.appendChild(p.createTextNode(T.join(" ").replace(/- /g,"-"))),b.appendChild(N)),d.truncate(a,N,null,T,0===n?r:0,c,function(a,b){return T.slice(0,b).join(" ").replace(/- /g,"-")}),r=a.actualWidth,n++}k++}}});E=E||b.childNodes.length}),A&&D&&a.attr("title",
v(a.textStr,["&lt;","&gt;"])),r&&r.removeChild(b),K&&a.applyTextOutline&&a.applyTextOutline(K)):b.appendChild(p.createTextNode(v(m)))}},getContrast:function(a){a=e(a).rgba;a[0]*=1;a[1]*=1.2;a[2]*=.5;return 459<a[0]+a[1]+a[2]?"#000000":"#FFFFFF"},button:function(a,d,m,e,w,k,l,g,c,x){var D=this.label(a,d,m,c,null,null,x,null,"button"),p=0,K=this.styledMode;D.attr(A({padding:8,r:2},w));if(!K){w=A({fill:"#f7f7f7",stroke:"#cccccc","stroke-width":1,style:{color:"#333333",cursor:"pointer",fontWeight:"normal"}},
w);var J=w.style;delete w.style;k=A(w,{fill:"#e6e6e6"},k);var N=k.style;delete k.style;l=A(w,{fill:"#e6ebf5",style:{color:"#000000",fontWeight:"bold"}},l);var h=l.style;delete l.style;g=A(w,{style:{color:"#cccccc"}},g);var u=g.style;delete g.style}b(D.element,r?"mouseover":"mouseenter",function(){3!==p&&D.setState(1)});b(D.element,r?"mouseout":"mouseleave",function(){3!==p&&D.setState(p)});D.setState=function(a){1!==a&&(D.state=p=a);D.removeClass(/highcharts-button-(normal|hover|pressed|disabled)/).addClass("highcharts-button-"+
["normal","hover","pressed","disabled"][a||0]);K||D.attr([w,k,l,g][a||0]).css([J,N,h,u][a||0])};K||D.attr(w).css(t({cursor:"default"},J));return D.on("click",function(a){3!==p&&e.call(D,a)})},crispLine:function(a,b){a[1]===a[4]&&(a[1]=a[4]=Math.round(a[1])-b%2/2);a[2]===a[5]&&(a[2]=a[5]=Math.round(a[2])+b%2/2);return a},path:function(a){var b=this.styledMode?{}:{fill:"none"};v(a)?b.d=a:H(a)&&t(b,a);return this.createElement("path").attr(b)},circle:function(a,b,d){a=H(a)?a:void 0===a?{}:{x:a,y:b,r:d};
b=this.createElement("circle");b.xSetter=b.ySetter=function(a,b,d){d.setAttribute("c"+b,a)};return b.attr(a)},arc:function(a,b,d,m,e,w){H(a)?(m=a,b=m.y,d=m.r,a=m.x):m={innerR:m,start:e,end:w};a=this.symbol("arc",a,b,d,d,m);a.r=d;return a},rect:function(a,b,d,m,e,w){e=H(a)?a.r:e;var k=this.createElement("rect");a=H(a)?a:void 0===a?{}:{x:a,y:b,width:Math.max(d,0),height:Math.max(m,0)};this.styledMode||(void 0!==w&&(a.strokeWidth=w,a=k.crisp(a)),a.fill="none");e&&(a.r=e);k.rSetter=function(a,b,d){k.r=
a;F(d,{rx:a,ry:a})};k.rGetter=function(){return k.r};return k.attr(a)},setSize:function(a,b,d){var m=this.alignedObjects,e=m.length;this.width=a;this.height=b;for(this.boxWrapper.animate({width:a,height:b},{step:function(){this.attr({viewBox:"0 0 "+this.attr("width")+" "+this.attr("height")})},duration:n(d,!0)?void 0:0});e--;)m[e].align()},g:function(a){var b=this.createElement("g");return a?b.attr({"class":"highcharts-"+a}):b},image:function(a,d,m,e,w,k){var l={preserveAspectRatio:"none"},g=function(a,
b){a.setAttributeNS?a.setAttributeNS("http://www.w3.org/1999/xlink","href",b):a.setAttribute("hc-svg-href",b)},r=function(b){g(c.element,a);k.call(c,b)};1<arguments.length&&t(l,{x:d,y:m,width:e,height:w});var c=this.createElement("image").attr(l);k?(g(c.element,"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),l=new Q.Image,b(l,"load",r),l.src=a,l.complete&&r({})):g(c.element,a);return c},symbol:function(a,b,m,e,w,k){var g=this,r=/^url\((.*?)\)$/,c=r.test(a),D=!c&&(this.symbols[a]?
a:"circle"),x=D&&this.symbols[D],K=G(b)&&x&&x.call(this.symbols,Math.round(b),Math.round(m),e,w,k);if(x){var J=this.path(K);g.styledMode||J.attr("fill","none");t(J,{symbolName:D,x:b,y:m,width:e,height:w});k&&t(J,k)}else if(c){var A=a.match(r)[1];J=this.image(A);J.imgwidth=n(S[A]&&S[A].width,k&&k.width);J.imgheight=n(S[A]&&S[A].height,k&&k.height);var h=function(){J.attr({width:J.width,height:J.height})};["width","height"].forEach(function(a){J[a+"Setter"]=function(a,b){var d={},m=this["img"+b],e=
"width"===b?"translateX":"translateY";this[b]=a;G(m)&&(k&&"within"===k.backgroundSize&&this.width&&this.height&&(m=Math.round(m*Math.min(this.width/this.imgwidth,this.height/this.imgheight))),this.element&&this.element.setAttribute(b,m),this.alignByTranslate||(d[e]=((this[b]||0)-m)/2,this.attr(d)))}});G(b)&&J.attr({x:b,y:m});J.isImg=!0;G(J.imgwidth)&&G(J.imgheight)?h():(J.attr({width:0,height:0}),L("img",{onload:function(){var a=d[g.chartIndex];0===this.width&&(l(this,{position:"absolute",top:"-999em"}),
p.body.appendChild(this));S[A]={width:this.width,height:this.height};J.imgwidth=this.width;J.imgheight=this.height;J.element&&h();this.parentNode&&this.parentNode.removeChild(this);g.imgCount--;if(!g.imgCount&&a&&a.onload)a.onload()},src:A}),this.imgCount++)}return J},symbols:{circle:function(a,b,d,m){return this.arc(a+d/2,b+m/2,d/2,m/2,{start:.5*Math.PI,end:2.5*Math.PI,open:!1})},square:function(a,b,d,m){return["M",a,b,"L",a+d,b,a+d,b+m,a,b+m,"Z"]},triangle:function(a,b,d,m){return["M",a+d/2,b,"L",
a+d,b+m,a,b+m,"Z"]},"triangle-down":function(a,b,d,m){return["M",a,b,"L",a+d,b,a+d/2,b+m,"Z"]},diamond:function(a,b,d,m){return["M",a+d/2,b,"L",a+d,b+m/2,a+d/2,b+m,a,b+m/2,"Z"]},arc:function(a,b,d,m,e){var w=e.start,k=e.r||d,l=e.r||m||d,g=e.end-.001;d=e.innerR;m=n(e.open,.001>Math.abs(e.end-e.start-2*Math.PI));var r=Math.cos(w),c=Math.sin(w),x=Math.cos(g);g=Math.sin(g);w=.001>e.end-w-Math.PI?0:1;e=["M",a+k*r,b+l*c,"A",k,l,0,w,n(e.clockwise,1),a+k*x,b+l*g];G(d)&&e.push(m?"M":"L",a+d*x,b+d*g,"A",d,
d,0,w,0,a+d*r,b+d*c);e.push(m?"":"Z");return e},callout:function(a,b,d,m,e){var w=Math.min(e&&e.r||0,d,m),k=w+6,l=e&&e.anchorX;e=e&&e.anchorY;var g=["M",a+w,b,"L",a+d-w,b,"C",a+d,b,a+d,b,a+d,b+w,"L",a+d,b+m-w,"C",a+d,b+m,a+d,b+m,a+d-w,b+m,"L",a+w,b+m,"C",a,b+m,a,b+m,a,b+m-w,"L",a,b+w,"C",a,b,a,b,a+w,b];l&&l>d?e>b+k&&e<b+m-k?g.splice(13,3,"L",a+d,e-6,a+d+6,e,a+d,e+6,a+d,b+m-w):g.splice(13,3,"L",a+d,m/2,l,e,a+d,m/2,a+d,b+m-w):l&&0>l?e>b+k&&e<b+m-k?g.splice(33,3,"L",a,e+6,a-6,e,a,e-6,a,b+w):g.splice(33,
3,"L",a,m/2,l,e,a,m/2,a,b+w):e&&e>m&&l>a+k&&l<a+d-k?g.splice(23,3,"L",l+6,b+m,l,b+m+6,l-6,b+m,a+w,b+m):e&&0>e&&l>a+k&&l<a+d-k&&g.splice(3,3,"L",l-6,b,l,b-6,l+6,b,d-w,b);return g}},clipRect:function(a,b,d,m){var e=c.uniqueKey()+"-",w=this.createElement("clipPath").attr({id:e}).add(this.defs);a=this.rect(a,b,d,m,0).add(w);a.id=e;a.clipPath=w;a.count=0;return a},text:function(a,b,d,m){var e={};if(m&&(this.allowHTML||!this.forExport))return this.html(a,b,d);e.x=Math.round(b||0);d&&(e.y=Math.round(d));
G(a)&&(e.text=a);a=this.createElement("text").attr(e);m||(a.xSetter=function(a,b,d){var m=d.getElementsByTagName("tspan"),e=d.getAttribute(b),w;for(w=0;w<m.length;w++){var k=m[w];k.getAttribute(b)===e&&k.setAttribute(b,a)}d.setAttribute(b,a)});return a},fontMetrics:function(a,b){a=!this.styledMode&&/px/.test(a)||!Q.getComputedStyle?a||b&&b.style&&b.style.fontSize||this.style&&this.style.fontSize:b&&O.prototype.getStyle.call(b,"font-size");a=/px/.test(a)?q(a):12;b=24>a?a+3:Math.round(1.2*a);return{h:b,
b:Math.round(.8*b),f:a}},rotCorr:function(a,b,d){var m=a;b&&d&&(m=Math.max(m*Math.cos(b*E),4));return{x:-a/3*Math.sin(b*E),y:m}},label:function(a,b,d,e,w,k,l,g,r){var c=this,x=c.styledMode,J=c.g("button"!==r&&"label"),p=J.text=c.text("",0,0,l).attr({zIndex:1}),K,h,D=0,u=3,L=0,n,N,E,U,f,q={},T,S,v=/^url\((.*?)\)$/.test(e),Q=x||v,y=function(){return x?K.strokeWidth()%2/2:(T?parseInt(T,10):0)%2/2};r&&J.addClass("highcharts-"+r);var R=function(){var a=p.element.style,b={};h=(void 0===n||void 0===N||f)&&
G(p.textStr)&&p.getBBox();J.width=(n||h.width||0)+2*u+L;J.height=(N||h.height||0)+2*u;S=u+Math.min(c.fontMetrics(a&&a.fontSize,p).b,h?h.height:Infinity);Q&&(K||(J.box=K=c.symbols[e]||v?c.symbol(e):c.rect(),K.addClass(("button"===r?"":"highcharts-label-box")+(r?" highcharts-"+r+"-box":"")),K.add(J),a=y(),b.x=a,b.y=(g?-S:0)+a),b.width=Math.round(J.width),b.height=Math.round(J.height),K.attr(t(b,q)),q={})};var B=function(){var a=L+u;var b=g?0:S;G(n)&&h&&("center"===f||"right"===f)&&(a+={center:.5,right:1}[f]*
(n-h.width));if(a!==p.x||b!==p.y)p.attr("x",a),p.hasBoxWidthChanged&&(h=p.getBBox(!0),R()),void 0!==b&&p.attr("y",b);p.x=a;p.y=b};var V=function(a,b){K?K.attr(a,b):q[a]=b};J.onAdd=function(){p.add(J);J.attr({text:a||0===a?a:"",x:b,y:d});K&&G(w)&&J.attr({anchorX:w,anchorY:k})};J.widthSetter=function(a){n=C(a)?a:null};J.heightSetter=function(a){N=a};J["text-alignSetter"]=function(a){f=a};J.paddingSetter=function(a){G(a)&&a!==u&&(u=J.padding=a,B())};J.paddingLeftSetter=function(a){G(a)&&a!==L&&(L=a,
B())};J.alignSetter=function(a){a={left:0,center:.5,right:1}[a];a!==D&&(D=a,h&&J.attr({x:E}))};J.textSetter=function(a){void 0!==a&&p.attr({text:a});R();B()};J["stroke-widthSetter"]=function(a,b){a&&(Q=!0);T=this["stroke-width"]=a;V(b,a)};x?J.rSetter=function(a,b){V(b,a)}:J.strokeSetter=J.fillSetter=J.rSetter=function(a,b){"r"!==b&&("fill"===b&&a&&(Q=!0),J[b]=a);V(b,a)};J.anchorXSetter=function(a,b){w=J.anchorX=a;V(b,Math.round(a)-y()-E)};J.anchorYSetter=function(a,b){k=J.anchorY=a;V(b,a-U)};J.xSetter=
function(a){J.x=a;D&&(a-=D*((n||h.width)+2*u),J["forceAnimate:x"]=!0);E=Math.round(a);J.attr("translateX",E)};J.ySetter=function(a){U=J.y=Math.round(a);J.attr("translateY",U)};var H=J.css;l={css:function(a){if(a){var b={};a=A(a);J.textProps.forEach(function(d){void 0!==a[d]&&(b[d]=a[d],delete a[d])});p.css(b);"width"in b&&R();"fontSize"in b&&(R(),B())}return H.call(J,a)},getBBox:function(){return{width:h.width+2*u,height:h.height+2*u,x:h.x-u,y:h.y-u}},destroy:function(){m(J.element,"mouseenter");
m(J.element,"mouseleave");p&&(p=p.destroy());K&&(K=K.destroy());O.prototype.destroy.call(J);J=c=R=B=V=null}};x||(l.shadow=function(a){a&&(R(),K&&K.shadow(a));return J});return t(J,l)}});c.Renderer=f});M(I,"parts/Html.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.attr,G=f.defined,z=f.extend,B=f.pick,t=f.pInt,v=c.createElement,C=c.css,H=c.isFirefox,y=c.isMS,h=c.isWebKit,n=c.SVGElement;f=c.SVGRenderer;var q=c.win;z(n.prototype,{htmlCss:function(g){var b="SPAN"===this.element.tagName&&
g&&"width"in g,a=B(b&&g.width,void 0);if(b){delete g.width;this.textWidth=a;var d=!0}g&&"ellipsis"===g.textOverflow&&(g.whiteSpace="nowrap",g.overflow="hidden");this.styles=z(this.styles,g);C(this.element,g);d&&this.htmlUpdateTransform();return this},htmlGetBBox:function(){var g=this.element;return{x:g.offsetLeft,y:g.offsetTop,width:g.offsetWidth,height:g.offsetHeight}},htmlUpdateTransform:function(){if(this.added){var g=this.renderer,b=this.element,a=this.translateX||0,d=this.translateY||0,e=this.x||
0,l=this.y||0,c=this.textAlign||"left",h={left:0,center:.5,right:1}[c],p=this.styles,u=p&&p.whiteSpace;C(b,{marginLeft:a,marginTop:d});!g.styledMode&&this.shadows&&this.shadows.forEach(function(b){C(b,{marginLeft:a+1,marginTop:d+1})});this.inverted&&[].forEach.call(b.childNodes,function(a){g.invertChild(a,b)});if("SPAN"===b.tagName){p=this.rotation;var k=this.textWidth&&t(this.textWidth),r=[p,c,b.innerHTML,this.textWidth,this.textAlign].join(),x;(x=k!==this.oldTextWidth)&&!(x=k>this.oldTextWidth)&&
((x=this.textPxLength)||(C(b,{width:"",whiteSpace:u||"nowrap"}),x=b.offsetWidth),x=x>k);x&&(/[ \-]/.test(b.textContent||b.innerText)||"ellipsis"===b.style.textOverflow)?(C(b,{width:k+"px",display:"block",whiteSpace:u||"normal"}),this.oldTextWidth=k,this.hasBoxWidthChanged=!0):this.hasBoxWidthChanged=!1;r!==this.cTT&&(u=g.fontMetrics(b.style.fontSize,b).b,!G(p)||p===(this.oldRotation||0)&&c===this.oldAlign||this.setSpanRotation(p,h,u),this.getSpanCorrection(!G(p)&&this.textPxLength||b.offsetWidth,
u,h,p,c));C(b,{left:e+(this.xCorr||0)+"px",top:l+(this.yCorr||0)+"px"});this.cTT=r;this.oldRotation=p;this.oldAlign=c}}else this.alignOnAdd=!0},setSpanRotation:function(g,b,a){var d={},e=this.renderer.getTransformKey();d[e]=d.transform="rotate("+g+"deg)";d[e+(H?"Origin":"-origin")]=d.transformOrigin=100*b+"% "+a+"px";C(this.element,d)},getSpanCorrection:function(g,b,a){this.xCorr=-g*a;this.yCorr=-b}});z(f.prototype,{getTransformKey:function(){return y&&!/Edge/.test(q.navigator.userAgent)?"-ms-transform":
h?"-webkit-transform":H?"MozTransform":q.opera?"-o-transform":""},html:function(g,b,a){var d=this.createElement("span"),e=d.element,l=d.renderer,c=l.isSVG,h=function(a,b){["opacity","visibility"].forEach(function(d){a[d+"Setter"]=function(e,k,l){var w=a.div?a.div.style:b;n.prototype[d+"Setter"].call(this,e,k,l);w&&(w[k]=e)}});a.addedSetters=!0};d.textSetter=function(a){a!==e.innerHTML&&(delete this.bBox,delete this.oldTextWidth);this.textStr=a;e.innerHTML=B(a,"");d.doTransform=!0};c&&h(d,d.element.style);
d.xSetter=d.ySetter=d.alignSetter=d.rotationSetter=function(a,b){"align"===b&&(b="textAlign");d[b]=a;d.doTransform=!0};d.afterSetters=function(){this.doTransform&&(this.htmlUpdateTransform(),this.doTransform=!1)};d.attr({text:g,x:Math.round(b),y:Math.round(a)}).css({position:"absolute"});l.styledMode||d.css({fontFamily:this.style.fontFamily,fontSize:this.style.fontSize});e.style.whiteSpace="nowrap";d.css=d.htmlCss;c&&(d.add=function(a){var b=l.box.parentNode,k=[];if(this.parentGroup=a){var g=a.div;
if(!g){for(;a;)k.push(a),a=a.parentGroup;k.reverse().forEach(function(a){function e(b,d){a[d]=b;"translateX"===d?m.left=b+"px":m.top=b+"px";a.doTransform=!0}var w=F(a.element,"class");g=a.div=a.div||v("div",w?{className:w}:void 0,{position:"absolute",left:(a.translateX||0)+"px",top:(a.translateY||0)+"px",display:a.display,opacity:a.opacity,pointerEvents:a.styles&&a.styles.pointerEvents},g||b);var m=g.style;z(a,{classSetter:function(a){return function(b){this.element.setAttribute("class",b);a.className=
b}}(g),on:function(){k[0].div&&d.on.apply({element:k[0].div},arguments);return a},translateXSetter:e,translateYSetter:e});a.addedSetters||h(a)})}}else g=b;g.appendChild(e);d.added=!0;d.alignOnAdd&&d.htmlUpdateTransform();return d});return d}})});M(I,"parts/Time.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.extend,z=f.isObject,B=f.objectEach,t=f.pick,v=f.splat,C=c.merge,H=c.timeUnits,y=c.win;c.Time=function(c){this.update(c,!1)};c.Time.prototype={defaultOptions:{Date:void 0,
getTimezoneOffset:void 0,timezone:void 0,timezoneOffset:0,useUTC:!0},update:function(c){var h=t(c&&c.useUTC,!0),f=this;this.options=c=C(!0,this.options||{},c);this.Date=c.Date||y.Date||Date;this.timezoneOffset=(this.useUTC=h)&&c.timezoneOffset;this.getTimezoneOffset=this.timezoneOffsetFunction();(this.variableTimezone=!(h&&!c.getTimezoneOffset&&!c.timezone))||this.timezoneOffset?(this.get=function(g,b){var a=b.getTime(),d=a-f.getTimezoneOffset(b);b.setTime(d);g=b["getUTC"+g]();b.setTime(a);return g},
this.set=function(g,b,a){if("Milliseconds"===g||"Seconds"===g||"Minutes"===g&&0===b.getTimezoneOffset()%60)b["set"+g](a);else{var d=f.getTimezoneOffset(b);d=b.getTime()-d;b.setTime(d);b["setUTC"+g](a);g=f.getTimezoneOffset(b);d=b.getTime()+g;b.setTime(d)}}):h?(this.get=function(g,b){return b["getUTC"+g]()},this.set=function(g,b,a){return b["setUTC"+g](a)}):(this.get=function(g,b){return b["get"+g]()},this.set=function(g,b,a){return b["set"+g](a)})},makeTime:function(h,n,f,g,b,a){if(this.useUTC){var d=
this.Date.UTC.apply(0,arguments);var e=this.getTimezoneOffset(d);d+=e;var l=this.getTimezoneOffset(d);e!==l?d+=l-e:e-36E5!==this.getTimezoneOffset(d-36E5)||c.isSafari||(d-=36E5)}else d=(new this.Date(h,n,t(f,1),t(g,0),t(b,0),t(a,0))).getTime();return d},timezoneOffsetFunction:function(){var h=this,n=this.options,f=y.moment;if(!this.useUTC)return function(g){return 6E4*(new Date(g)).getTimezoneOffset()};if(n.timezone){if(f)return function(g){return 6E4*-f.tz(g,n.timezone).utcOffset()};c.error(25)}return this.useUTC&&
n.getTimezoneOffset?function(g){return 6E4*n.getTimezoneOffset(g)}:function(){return 6E4*(h.timezoneOffset||0)}},dateFormat:function(h,n,f){if(!F(n)||isNaN(n))return c.defaultOptions.lang.invalidDate||"";h=t(h,"%Y-%m-%d %H:%M:%S");var g=this,b=new this.Date(n),a=this.get("Hours",b),d=this.get("Day",b),e=this.get("Date",b),l=this.get("Month",b),L=this.get("FullYear",b),E=c.defaultOptions.lang,p=E.weekdays,u=E.shortWeekdays,k=c.pad;b=G({a:u?u[d]:p[d].substr(0,3),A:p[d],d:k(e),e:k(e,2," "),w:d,b:E.shortMonths[l],
B:E.months[l],m:k(l+1),o:l+1,y:L.toString().substr(2,2),Y:L,H:k(a),k:a,I:k(a%12||12),l:a%12||12,M:k(g.get("Minutes",b)),p:12>a?"AM":"PM",P:12>a?"am":"pm",S:k(b.getSeconds()),L:k(Math.floor(n%1E3),3)},c.dateFormats);B(b,function(a,b){for(;-1!==h.indexOf("%"+b);)h=h.replace("%"+b,"function"===typeof a?a.call(g,n):a)});return f?h.substr(0,1).toUpperCase()+h.substr(1):h},resolveDTLFormat:function(c){return z(c,!0)?c:(c=v(c),{main:c[0],from:c[1],to:c[2]})},getTimeTicks:function(c,n,f,g){var b=this,a=[],
d={};var e=new b.Date(n);var l=c.unitRange,h=c.count||1,E;g=t(g,1);if(F(n)){b.set("Milliseconds",e,l>=H.second?0:h*Math.floor(b.get("Milliseconds",e)/h));l>=H.second&&b.set("Seconds",e,l>=H.minute?0:h*Math.floor(b.get("Seconds",e)/h));l>=H.minute&&b.set("Minutes",e,l>=H.hour?0:h*Math.floor(b.get("Minutes",e)/h));l>=H.hour&&b.set("Hours",e,l>=H.day?0:h*Math.floor(b.get("Hours",e)/h));l>=H.day&&b.set("Date",e,l>=H.month?1:Math.max(1,h*Math.floor(b.get("Date",e)/h)));if(l>=H.month){b.set("Month",e,l>=
H.year?0:h*Math.floor(b.get("Month",e)/h));var p=b.get("FullYear",e)}l>=H.year&&b.set("FullYear",e,p-p%h);l===H.week&&(p=b.get("Day",e),b.set("Date",e,b.get("Date",e)-p+g+(p<g?-7:0)));p=b.get("FullYear",e);g=b.get("Month",e);var u=b.get("Date",e),k=b.get("Hours",e);n=e.getTime();b.variableTimezone&&(E=f-n>4*H.month||b.getTimezoneOffset(n)!==b.getTimezoneOffset(f));n=e.getTime();for(e=1;n<f;)a.push(n),n=l===H.year?b.makeTime(p+e*h,0):l===H.month?b.makeTime(p,g+e*h):!E||l!==H.day&&l!==H.week?E&&l===
H.hour&&1<h?b.makeTime(p,g,u,k+e*h):n+l*h:b.makeTime(p,g,u+e*h*(l===H.day?1:7)),e++;a.push(n);l<=H.hour&&1E4>a.length&&a.forEach(function(a){0===a%18E5&&"000000000"===b.dateFormat("%H%M%S%L",a)&&(d[a]="day")})}a.info=G(c,{higherRanks:d,totalRange:l*h});return a}}});M(I,"parts/Options.js",[I["parts/Globals.js"]],function(c){var f=c.color,F=c.merge;c.defaultOptions={colors:"#7cb5ec #434348 #90ed7d #f7a35c #8085e9 #f15c80 #e4d354 #2b908f #f45b5b #91e8e1".split(" "),symbols:["circle","diamond","square",
"triangle","triangle-down"],lang:{loading:"Loading...",months:"January February March April May June July August September October November December".split(" "),shortMonths:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),weekdays:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),decimalPoint:".",numericSymbols:"kMGTPE".split(""),resetZoom:"Reset zoom",resetZoomTitle:"Reset zoom level 1:1",thousandsSep:" "},global:{},time:c.Time.prototype.defaultOptions,chart:{styledMode:!1,
borderRadius:0,colorCount:10,defaultSeriesType:"line",ignoreHiddenSeries:!0,spacing:[10,10,15,10],resetZoomButton:{theme:{zIndex:6},position:{align:"right",x:-10,y:10}},width:null,height:null,borderColor:"#335cad",backgroundColor:"#ffffff",plotBorderColor:"#cccccc"},title:{text:"Chart title",align:"center",margin:15,widthAdjust:-44},subtitle:{text:"",align:"center",widthAdjust:-44},caption:{margin:15,text:"",align:"left",verticalAlign:"bottom"},plotOptions:{},labels:{style:{position:"absolute",color:"#333333"}},
legend:{enabled:!0,align:"center",alignColumns:!0,layout:"horizontal",labelFormatter:function(){return this.name},borderColor:"#999999",borderRadius:0,navigation:{activeColor:"#003399",inactiveColor:"#cccccc"},itemStyle:{color:"#333333",cursor:"pointer",fontSize:"12px",fontWeight:"bold",textOverflow:"ellipsis"},itemHoverStyle:{color:"#000000"},itemHiddenStyle:{color:"#cccccc"},shadow:!1,itemCheckboxStyle:{position:"absolute",width:"13px",height:"13px"},squareSymbol:!0,symbolPadding:5,verticalAlign:"bottom",
x:0,y:0,title:{style:{fontWeight:"bold"}}},loading:{labelStyle:{fontWeight:"bold",position:"relative",top:"45%"},style:{position:"absolute",backgroundColor:"#ffffff",opacity:.5,textAlign:"center"}},tooltip:{enabled:!0,animation:c.svg,borderRadius:3,dateTimeLabelFormats:{millisecond:"%A, %b %e, %H:%M:%S.%L",second:"%A, %b %e, %H:%M:%S",minute:"%A, %b %e, %H:%M",hour:"%A, %b %e, %H:%M",day:"%A, %b %e, %Y",week:"Week from %A, %b %e, %Y",month:"%B %Y",year:"%Y"},footerFormat:"",padding:8,snap:c.isTouchDevice?
25:10,headerFormat:'<span style="font-size: 10px">{point.key}</span><br/>',pointFormat:'<span style="color:{point.color}">\u25cf</span> {series.name}: <b>{point.y}</b><br/>',backgroundColor:f("#f7f7f7").setOpacity(.85).get(),borderWidth:1,shadow:!0,style:{color:"#333333",cursor:"default",fontSize:"12px",pointerEvents:"none",whiteSpace:"nowrap"}},credits:{enabled:!0,href:"https://www.highcharts.com?credits",position:{align:"right",x:-10,verticalAlign:"bottom",y:-5},style:{cursor:"pointer",color:"#999999",
fontSize:"9px"},text:"Highcharts.com"}};c.setOptions=function(f){c.defaultOptions=F(!0,c.defaultOptions,f);(f.time||f.global)&&c.time.update(F(c.defaultOptions.global,c.defaultOptions.time,f.global,f.time));return c.defaultOptions};c.getOptions=function(){return c.defaultOptions};c.defaultPlotOptions=c.defaultOptions.plotOptions;c.time=new c.Time(F(c.defaultOptions.global,c.defaultOptions.time));c.dateFormat=function(f,z,B){return c.time.dateFormat(f,z,B)};""});M(I,"parts/Tick.js",[I["parts/Globals.js"],
I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.destroyObjectProperties,z=f.extend,B=f.isNumber,t=f.pick,v=c.correctFloat,C=c.fireEvent,H=c.merge,y=c.deg2rad;c.Tick=function(c,n,f,g,b){this.axis=c;this.pos=n;this.type=f||"";this.isNewLabel=this.isNew=!0;this.parameters=b||{};this.tickmarkOffset=this.parameters.tickmarkOffset;this.options=this.parameters.options;f||g||this.addLabel()};c.Tick.prototype={addLabel:function(){var c=this,n=c.axis,f=n.options,g=n.chart,b=n.categories,a=n.names,
d=c.pos,e=t(c.options&&c.options.labels,f.labels),l=n.tickPositions,L=d===l[0],E=d===l[l.length-1];b=this.parameters.category||(b?t(b[d],a[d],d):d);var p=c.label;l=l.info;var u,k;if(n.isDatetimeAxis&&l){var r=g.time.resolveDTLFormat(f.dateTimeLabelFormats[!f.grid&&l.higherRanks[d]||l.unitName]);var x=r.main}c.isFirst=L;c.isLast=E;c.formatCtx={axis:n,chart:g,isFirst:L,isLast:E,dateTimeLabelFormat:x,tickPositionInfo:l,value:n.isLog?v(n.lin2log(b)):b,pos:d};f=n.labelFormatter.call(c.formatCtx,this.formatCtx);
if(k=r&&r.list)c.shortenLabel=function(){for(u=0;u<k.length;u++)if(p.attr({text:n.labelFormatter.call(z(c.formatCtx,{dateTimeLabelFormat:k[u]}))}),p.getBBox().width<n.getSlotWidth(c)-2*t(e.padding,5))return;p.attr({text:""})};if(F(p))p&&p.textStr!==f&&(!p.textWidth||e.style&&e.style.width||p.styles.width||p.css({width:null}),p.attr({text:f}),p.textPxLength=p.getBBox().width);else{if(c.label=p=F(f)&&e.enabled?g.renderer.text(f,0,0,e.useHTML).add(n.labelGroup):null)g.styledMode||p.css(H(e.style)),p.textPxLength=
p.getBBox().width;c.rotation=0}},getLabelSize:function(){return this.label?this.label.getBBox()[this.axis.horiz?"height":"width"]:0},handleOverflow:function(c){var h=this.axis,f=h.options.labels,g=c.x,b=h.chart.chartWidth,a=h.chart.spacing,d=t(h.labelLeft,Math.min(h.pos,a[3]));a=t(h.labelRight,Math.max(h.isRadial?0:h.pos+h.len,b-a[1]));var e=this.label,l=this.rotation,L={left:0,center:.5,right:1}[h.labelAlign||e.attr("align")],E=e.getBBox().width,p=h.getSlotWidth(this),u=p,k=1,r,x={};if(l||"justify"!==
t(f.overflow,"justify"))0>l&&g-L*E<d?r=Math.round(g/Math.cos(l*y)-d):0<l&&g+L*E>a&&(r=Math.round((b-g)/Math.cos(l*y)));else if(b=g+(1-L)*E,g-L*E<d?u=c.x+u*(1-L)-d:b>a&&(u=a-c.x+u*L,k=-1),u=Math.min(p,u),u<p&&"center"===h.labelAlign&&(c.x+=k*(p-u-L*(p-Math.min(E,u)))),E>u||h.autoRotation&&(e.styles||{}).width)r=u;r&&(this.shortenLabel?this.shortenLabel():(x.width=Math.floor(r),(f.style||{}).textOverflow||(x.textOverflow="ellipsis"),e.css(x)))},getPosition:function(h,n,f,g){var b=this.axis,a=b.chart,
d=g&&a.oldChartHeight||a.chartHeight;h={x:h?c.correctFloat(b.translate(n+f,null,null,g)+b.transB):b.left+b.offset+(b.opposite?(g&&a.oldChartWidth||a.chartWidth)-b.right-b.left:0),y:h?d-b.bottom+b.offset-(b.opposite?b.height:0):c.correctFloat(d-b.translate(n+f,null,null,g)-b.transB)};h.y=Math.max(Math.min(h.y,1E5),-1E5);C(this,"afterGetPosition",{pos:h});return h},getLabelPosition:function(c,n,f,g,b,a,d,e){var l=this.axis,h=l.transA,E=l.isLinked&&l.linkedParent?l.linkedParent.reversed:l.reversed,p=
l.staggerLines,u=l.tickRotCorr||{x:0,y:0},k=b.y,r=g||l.reserveSpaceDefault?0:-l.labelOffset*("center"===l.labelAlign?.5:1),x={};F(k)||(k=0===l.side?f.rotation?-8:-f.getBBox().height:2===l.side?u.y+8:Math.cos(f.rotation*y)*(u.y-f.getBBox(!1,0).height/2));c=c+b.x+r+u.x-(a&&g?a*h*(E?-1:1):0);n=n+k-(a&&!g?a*h*(E?1:-1):0);p&&(f=d/(e||1)%p,l.opposite&&(f=p-f-1),n+=l.labelOffset/p*f);x.x=c;x.y=Math.round(n);C(this,"afterGetLabelPosition",{pos:x,tickmarkOffset:a,index:d});return x},getMarkPath:function(c,
n,f,g,b,a){return a.crispLine(["M",c,n,"L",c+(b?0:-f),n+(b?f:0)],g)},renderGridLine:function(c,n,f){var g=this.axis,b=g.options,a=this.gridLine,d={},e=this.pos,l=this.type,h=t(this.tickmarkOffset,g.tickmarkOffset),E=g.chart.renderer,p=l?l+"Grid":"grid",u=b[p+"LineWidth"],k=b[p+"LineColor"];b=b[p+"LineDashStyle"];a||(g.chart.styledMode||(d.stroke=k,d["stroke-width"]=u,b&&(d.dashstyle=b)),l||(d.zIndex=1),c&&(n=0),this.gridLine=a=E.path().attr(d).addClass("highcharts-"+(l?l+"-":"")+"grid-line").add(g.gridGroup));
if(a&&(f=g.getPlotLinePath({value:e+h,lineWidth:a.strokeWidth()*f,force:"pass",old:c})))a[c||this.isNew?"attr":"animate"]({d:f,opacity:n})},renderMark:function(c,n,f){var g=this.axis,b=g.options,a=g.chart.renderer,d=this.type,e=d?d+"Tick":"tick",l=g.tickSize(e),h=this.mark,E=!h,p=c.x;c=c.y;var u=t(b[e+"Width"],!d&&g.isXAxis?1:0);b=b[e+"Color"];l&&(g.opposite&&(l[0]=-l[0]),E&&(this.mark=h=a.path().addClass("highcharts-"+(d?d+"-":"")+"tick").add(g.axisGroup),g.chart.styledMode||h.attr({stroke:b,"stroke-width":u})),
h[E?"attr":"animate"]({d:this.getMarkPath(p,c,l[0],h.strokeWidth()*f,g.horiz,a),opacity:n}))},renderLabel:function(c,n,f,g){var b=this.axis,a=b.horiz,d=b.options,e=this.label,l=d.labels,h=l.step;b=t(this.tickmarkOffset,b.tickmarkOffset);var E=!0,p=c.x;c=c.y;e&&B(p)&&(e.xy=c=this.getLabelPosition(p,c,e,a,l,b,g,h),this.isFirst&&!this.isLast&&!t(d.showFirstLabel,1)||this.isLast&&!this.isFirst&&!t(d.showLastLabel,1)?E=!1:!a||l.step||l.rotation||n||0===f||this.handleOverflow(c),h&&g%h&&(E=!1),E&&B(c.y)?
(c.opacity=f,e[this.isNewLabel?"attr":"animate"](c),this.isNewLabel=!1):(e.attr("y",-9999),this.isNewLabel=!0))},render:function(h,n,f){var g=this.axis,b=g.horiz,a=this.pos,d=t(this.tickmarkOffset,g.tickmarkOffset);a=this.getPosition(b,a,d,n);d=a.x;var e=a.y;g=b&&d===g.pos+g.len||!b&&e===g.pos?-1:1;f=t(f,1);this.isActive=!0;this.renderGridLine(n,f,g);this.renderMark(a,f,g);this.renderLabel(a,n,f,h);this.isNew=!1;c.fireEvent(this,"afterRender")},destroy:function(){G(this,this.axis)}}});M(I,"parts/Axis.js",
[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.arrayMax,G=f.arrayMin,z=f.defined,B=f.destroyObjectProperties,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isString,y=f.objectEach,h=f.pick,n=f.splat,q=f.syncTimeout,g=c.addEvent,b=c.animObject,a=c.color,d=c.correctFloat,e=c.defaultOptions,l=c.deg2rad,L=c.fireEvent,E=c.format,p=c.getMagnitude,u=c.merge,k=c.normalizeTickInterval,r=c.removeEvent,x=c.seriesTypes,A=c.Tick;f=function(){this.init.apply(this,arguments)};t(f.prototype,{defaultOptions:{dateTimeLabelFormats:{millisecond:{main:"%H:%M:%S.%L",
range:!1},second:{main:"%H:%M:%S",range:!1},minute:{main:"%H:%M",range:!1},hour:{main:"%H:%M",range:!1},day:{main:"%e. %b"},week:{main:"%e. %b"},month:{main:"%b '%y"},year:{main:"%Y"}},endOnTick:!1,labels:{enabled:!0,indentation:10,x:0,style:{color:"#666666",cursor:"default",fontSize:"11px"}},maxPadding:.01,minorTickLength:2,minorTickPosition:"outside",minPadding:.01,showEmpty:!0,startOfWeek:1,startOnTick:!1,tickLength:10,tickPixelInterval:100,tickmarkPlacement:"between",tickPosition:"outside",title:{align:"middle",
style:{color:"#666666"}},type:"linear",minorGridLineColor:"#f2f2f2",minorGridLineWidth:1,minorTickColor:"#999999",lineColor:"#ccd6eb",lineWidth:1,gridLineColor:"#e6e6e6",tickColor:"#ccd6eb"},defaultYAxisOptions:{endOnTick:!0,maxPadding:.05,minPadding:.05,tickPixelInterval:72,showLastLabel:!0,labels:{x:-8},startOnTick:!0,title:{rotation:270,text:"Values"},stackLabels:{allowOverlap:!1,enabled:!1,crop:!0,overflow:"justify",formatter:function(){return c.numberFormat(this.total,-1)},style:{color:"#000000",
fontSize:"11px",fontWeight:"bold",textOutline:"1px contrast"}},gridLineWidth:1,lineWidth:0},defaultLeftAxisOptions:{labels:{x:-15},title:{rotation:270}},defaultRightAxisOptions:{labels:{x:15},title:{rotation:90}},defaultBottomAxisOptions:{labels:{autoRotation:[-45],x:0},margin:15,title:{rotation:0}},defaultTopAxisOptions:{labels:{autoRotation:[-45],x:0},margin:15,title:{rotation:0}},init:function(a,b){var d=b.isX,m=this;m.chart=a;m.horiz=a.inverted&&!m.isZAxis?!d:d;m.isXAxis=d;m.coll=m.coll||(d?"xAxis":
"yAxis");L(this,"init",{userOptions:b});m.opposite=b.opposite;m.side=b.side||(m.horiz?m.opposite?0:2:m.opposite?1:3);m.setOptions(b);var e=this.options,w=e.type;m.labelFormatter=e.labels.formatter||m.defaultLabelFormatter;m.userOptions=b;m.minPixelPadding=0;m.reversed=e.reversed;m.visible=!1!==e.visible;m.zoomEnabled=!1!==e.zoomEnabled;m.hasNames="category"===w||!0===e.categories;m.categories=e.categories||m.hasNames;m.names||(m.names=[],m.names.keys={});m.plotLinesAndBandsGroups={};m.isLog="logarithmic"===
w;m.isDatetimeAxis="datetime"===w;m.positiveValuesOnly=m.isLog&&!m.allowNegativeLog;m.isLinked=z(e.linkedTo);m.ticks={};m.labelEdge=[];m.minorTicks={};m.plotLinesAndBands=[];m.alternateBands={};m.len=0;m.minRange=m.userMinRange=e.minRange||e.maxZoom;m.range=e.range;m.offset=e.offset||0;m.stacks={};m.oldStacks={};m.stacksTouched=0;m.max=null;m.min=null;m.crosshair=h(e.crosshair,n(a.options.tooltip.crosshairs)[d?0:1],!1);b=m.options.events;-1===a.axes.indexOf(m)&&(d?a.axes.splice(a.xAxis.length,0,m):
a.axes.push(m),a[m.coll].push(m));m.series=m.series||[];a.inverted&&!m.isZAxis&&d&&void 0===m.reversed&&(m.reversed=!0);y(b,function(a,b){c.isFunction(a)&&g(m,b,a)});m.lin2log=e.linearToLogConverter||m.lin2log;m.isLog&&(m.val2lin=m.log2lin,m.lin2val=m.lin2log);L(this,"afterInit")},setOptions:function(a){this.options=u(this.defaultOptions,"yAxis"===this.coll&&this.defaultYAxisOptions,[this.defaultTopAxisOptions,this.defaultRightAxisOptions,this.defaultBottomAxisOptions,this.defaultLeftAxisOptions][this.side],
u(e[this.coll],a));L(this,"afterSetOptions",{userOptions:a})},defaultLabelFormatter:function(){var a=this.axis,b=this.value,d=a.chart.time,k=a.categories,l=this.dateTimeLabelFormat,g=e.lang,r=g.numericSymbols;g=g.numericSymbolMagnitude||1E3;var x=r&&r.length,p=a.options.labels.format;a=a.isLog?Math.abs(b):a.tickInterval;if(p)var h=E(p,this,d);else if(k)h=b;else if(l)h=d.dateFormat(l,b);else if(x&&1E3<=a)for(;x--&&void 0===h;)d=Math.pow(g,x+1),a>=d&&0===10*b%d&&null!==r[x]&&0!==b&&(h=c.numberFormat(b/
d,-1)+r[x]);void 0===h&&(h=1E4<=Math.abs(b)?c.numberFormat(b,-1):c.numberFormat(b,-1,void 0,""));return h},getSeriesExtremes:function(){var a=this,b=a.chart,d;L(this,"getSeriesExtremes",null,function(){a.hasVisibleSeries=!1;a.dataMin=a.dataMax=a.threshold=null;a.softThreshold=!a.isXAxis;a.buildStacks&&a.buildStacks();a.series.forEach(function(m){if(m.visible||!b.options.chart.ignoreHiddenSeries){var e=m.options,w=e.threshold;a.hasVisibleSeries=!0;a.positiveValuesOnly&&0>=w&&(w=null);if(a.isXAxis){if(e=
m.xData,e.length){d=m.getXExtremes(e);var k=d.min;var c=d.max;C(k)||k instanceof Date||(e=e.filter(C),d=m.getXExtremes(e),k=d.min,c=d.max);e.length&&(a.dataMin=Math.min(h(a.dataMin,k),k),a.dataMax=Math.max(h(a.dataMax,c),c))}}else if(m.getExtremes(),c=m.dataMax,k=m.dataMin,z(k)&&z(c)&&(a.dataMin=Math.min(h(a.dataMin,k),k),a.dataMax=Math.max(h(a.dataMax,c),c)),z(w)&&(a.threshold=w),!e.softThreshold||a.positiveValuesOnly)a.softThreshold=!1}})});L(this,"afterGetSeriesExtremes")},translate:function(a,
b,d,e,k,c){var m=this.linkedParent||this,w=1,l=0,g=e?m.oldTransA:m.transA;e=e?m.oldMin:m.min;var r=m.minPixelPadding;k=(m.isOrdinal||m.isBroken||m.isLog&&k)&&m.lin2val;g||(g=m.transA);d&&(w*=-1,l=m.len);m.reversed&&(w*=-1,l-=w*(m.sector||m.len));b?(a=(a*w+l-r)/g+e,k&&(a=m.lin2val(a))):(k&&(a=m.val2lin(a)),a=C(e)?w*(a-e)*g+l+w*r+(C(c)?g*c:0):void 0);return a},toPixels:function(a,b){return this.translate(a,!1,!this.horiz,null,!0)+(b?0:this.pos)},toValue:function(a,b){return this.translate(a-(b?0:this.pos),
!0,!this.horiz,null,!0)},getPlotLinePath:function(a){var b=this,d=b.chart,e=b.left,w=b.top,k=a.old,c=a.value,l=a.translatedValue,g=a.lineWidth,r=a.force,x,p,A,u,n=k&&d.oldChartHeight||d.chartHeight,f=k&&d.oldChartWidth||d.chartWidth,E,q=b.transB,v=function(a,b,d){if("pass"!==r&&a<b||a>d)r?a=Math.min(Math.max(b,a),d):E=!0;return a};a={value:c,lineWidth:g,old:k,force:r,acrossPanes:a.acrossPanes,translatedValue:l};L(this,"getPlotLinePath",a,function(a){l=h(l,b.translate(c,null,null,k));l=Math.min(Math.max(-1E5,
l),1E5);x=A=Math.round(l+q);p=u=Math.round(n-l-q);C(l)?b.horiz?(p=w,u=n-b.bottom,x=A=v(x,e,e+b.width)):(x=e,A=f-b.right,p=u=v(p,w,w+b.height)):(E=!0,r=!1);a.path=E&&!r?null:d.renderer.crispLine(["M",x,p,"L",A,u],g||1)});return a.path},getLinearTickPositions:function(a,b,e){var m=d(Math.floor(b/a)*a);e=d(Math.ceil(e/a)*a);var w=[],k;d(m+a)===m&&(k=20);if(this.single)return[b];for(b=m;b<=e;){w.push(b);b=d(b+a,k);if(b===c)break;var c=b}return w},getMinorTickInterval:function(){var a=this.options;return!0===
a.minorTicks?h(a.minorTickInterval,"auto"):!1===a.minorTicks?null:a.minorTickInterval},getMinorTickPositions:function(){var a=this,b=a.options,d=a.tickPositions,e=a.minorTickInterval,k=[],c=a.pointRangePadding||0,l=a.min-c;c=a.max+c;var g=c-l;if(g&&g/e<a.len/3)if(a.isLog)this.paddedTicks.forEach(function(b,d,m){d&&k.push.apply(k,a.getLogTickPositions(e,m[d-1],m[d],!0))});else if(a.isDatetimeAxis&&"auto"===this.getMinorTickInterval())k=k.concat(a.getTimeTicks(a.normalizeTimeTickInterval(e),l,c,b.startOfWeek));
else for(b=l+(d[0]-l)%e;b<=c&&b!==k[0];b+=e)k.push(b);0!==k.length&&a.trimTicks(k);return k},adjustForMinRange:function(){var a=this.options,b=this.min,d=this.max,e,k,c,l,g;this.isXAxis&&void 0===this.minRange&&!this.isLog&&(z(a.min)||z(a.max)?this.minRange=null:(this.series.forEach(function(a){l=a.xData;for(k=g=a.xIncrement?1:l.length-1;0<k;k--)if(c=l[k]-l[k-1],void 0===e||c<e)e=c}),this.minRange=Math.min(5*e,this.dataMax-this.dataMin)));if(d-b<this.minRange){var r=this.dataMax-this.dataMin>=this.minRange;
var x=this.minRange;var p=(x-d+b)/2;p=[b-p,h(a.min,b-p)];r&&(p[2]=this.isLog?this.log2lin(this.dataMin):this.dataMin);b=F(p);d=[b+x,h(a.max,b+x)];r&&(d[2]=this.isLog?this.log2lin(this.dataMax):this.dataMax);d=G(d);d-b<x&&(p[0]=d-x,p[1]=h(a.min,d-x),b=F(p))}this.min=b;this.max=d},getClosest:function(){var a;this.categories?a=1:this.series.forEach(function(b){var d=b.closestPointRange,m=b.visible||!b.chart.options.chart.ignoreHiddenSeries;!b.noSharedTooltip&&z(d)&&m&&(a=z(a)?Math.min(a,d):d)});return a},
nameToX:function(a){var b=v(this.categories),d=b?this.categories:this.names,e=a.options.x;a.series.requireSorting=!1;z(e)||(e=!1===this.options.uniqueNames?a.series.autoIncrement():b?d.indexOf(a.name):h(d.keys[a.name],-1));if(-1===e){if(!b)var k=d.length}else k=e;void 0!==k&&(this.names[k]=a.name,this.names.keys[a.name]=k);return k},updateNames:function(){var a=this,b=this.names;0<b.length&&(Object.keys(b.keys).forEach(function(a){delete b.keys[a]}),b.length=0,this.minRange=this.userMinRange,(this.series||
[]).forEach(function(b){b.xIncrement=null;if(!b.points||b.isDirtyData)a.max=Math.max(a.max,b.xData.length-1),b.processData(),b.generatePoints();b.data.forEach(function(d,e){if(d&&d.options&&void 0!==d.name){var m=a.nameToX(d);void 0!==m&&m!==d.x&&(d.x=m,b.xData[e]=m)}})}))},setAxisTranslation:function(a){var b=this,d=b.max-b.min,e=b.axisPointRange||0,k=0,w=0,c=b.linkedParent,l=!!b.categories,g=b.transA,r=b.isXAxis;if(r||l||e){var p=b.getClosest();c?(k=c.minPointOffset,w=c.pointRangePadding):b.series.forEach(function(a){var d=
l?1:r?h(a.options.pointRange,p,0):b.axisPointRange||0,m=a.options.pointPlacement;e=Math.max(e,d);if(!b.single||l)a=x.xrange&&a instanceof x.xrange?!r:r,k=Math.max(k,a&&H(m)?0:d/2),w=Math.max(w,a&&"on"===m?0:d)});c=b.ordinalSlope&&p?b.ordinalSlope/p:1;b.minPointOffset=k*=c;b.pointRangePadding=w*=c;b.pointRange=Math.min(e,b.single&&l?1:d);r&&(b.closestPointRange=p)}a&&(b.oldTransA=g);b.translationSlope=b.transA=g=b.staticScale||b.len/(d+w||1);b.transB=b.horiz?b.left:b.bottom;b.minPixelPadding=g*k;L(this,
"afterSetAxisTranslation")},minFromRange:function(){return this.max-this.range},setTickInterval:function(a){var b=this,e=b.chart,w=b.options,l=b.isLog,g=b.isDatetimeAxis,r=b.isXAxis,x=b.isLinked,A=w.maxPadding,u=w.minPadding,n=w.tickInterval,f=w.tickPixelInterval,E=b.categories,q=C(b.threshold)?b.threshold:null,v=b.softThreshold;g||E||x||this.getTickAmount();var t=h(b.userMin,w.min);var y=h(b.userMax,w.max);if(x){b.linkedParent=e[b.coll][w.linkedTo];var B=b.linkedParent.getExtremes();b.min=h(B.min,
B.dataMin);b.max=h(B.max,B.dataMax);w.type!==b.linkedParent.options.type&&c.error(11,1,e)}else{if(!v&&z(q))if(b.dataMin>=q)B=q,u=0;else if(b.dataMax<=q){var H=q;A=0}b.min=h(t,B,b.dataMin);b.max=h(y,H,b.dataMax)}l&&(b.positiveValuesOnly&&!a&&0>=Math.min(b.min,h(b.dataMin,b.min))&&c.error(10,1,e),b.min=d(b.log2lin(b.min),16),b.max=d(b.log2lin(b.max),16));b.range&&z(b.max)&&(b.userMin=b.min=t=Math.max(b.dataMin,b.minFromRange()),b.userMax=y=b.max,b.range=null);L(b,"foundExtremes");b.beforePadding&&b.beforePadding();
b.adjustForMinRange();!(E||b.axisPointRange||b.usePercentage||x)&&z(b.min)&&z(b.max)&&(e=b.max-b.min)&&(!z(t)&&u&&(b.min-=e*u),!z(y)&&A&&(b.max+=e*A));C(w.softMin)&&!C(b.userMin)&&w.softMin<b.min&&(b.min=t=w.softMin);C(w.softMax)&&!C(b.userMax)&&w.softMax>b.max&&(b.max=y=w.softMax);C(w.floor)&&(b.min=Math.min(Math.max(b.min,w.floor),Number.MAX_VALUE));C(w.ceiling)&&(b.max=Math.max(Math.min(b.max,w.ceiling),h(b.userMax,-Number.MAX_VALUE)));v&&z(b.dataMin)&&(q=q||0,!z(t)&&b.min<q&&b.dataMin>=q?b.min=
b.options.minRange?Math.min(q,b.max-b.minRange):q:!z(y)&&b.max>q&&b.dataMax<=q&&(b.max=b.options.minRange?Math.max(q,b.min+b.minRange):q));b.tickInterval=b.min===b.max||void 0===b.min||void 0===b.max?1:x&&!n&&f===b.linkedParent.options.tickPixelInterval?n=b.linkedParent.tickInterval:h(n,this.tickAmount?(b.max-b.min)/Math.max(this.tickAmount-1,1):void 0,E?1:(b.max-b.min)*f/Math.max(b.len,f));r&&!a&&b.series.forEach(function(a){a.processData(b.min!==b.oldMin||b.max!==b.oldMax)});b.setAxisTranslation(!0);
b.beforeSetTickPositions&&b.beforeSetTickPositions();b.postProcessTickInterval&&(b.tickInterval=b.postProcessTickInterval(b.tickInterval));b.pointRange&&!n&&(b.tickInterval=Math.max(b.pointRange,b.tickInterval));a=h(w.minTickInterval,b.isDatetimeAxis&&b.closestPointRange);!n&&b.tickInterval<a&&(b.tickInterval=a);g||l||n||(b.tickInterval=k(b.tickInterval,null,p(b.tickInterval),h(w.allowDecimals,!(.5<b.tickInterval&&5>b.tickInterval&&1E3<b.max&&9999>b.max)),!!this.tickAmount));this.tickAmount||(b.tickInterval=
b.unsquish());this.setTickPositions()},setTickPositions:function(){var a=this.options,b=a.tickPositions;var d=this.getMinorTickInterval();var e=a.tickPositioner,k=a.startOnTick,l=a.endOnTick;this.tickmarkOffset=this.categories&&"between"===a.tickmarkPlacement&&1===this.tickInterval?.5:0;this.minorTickInterval="auto"===d&&this.tickInterval?this.tickInterval/5:d;this.single=this.min===this.max&&z(this.min)&&!this.tickAmount&&(parseInt(this.min,10)===this.min||!1!==a.allowDecimals);this.tickPositions=
d=b&&b.slice();!d&&(!this.ordinalPositions&&(this.max-this.min)/this.tickInterval>Math.max(2*this.len,200)?(d=[this.min,this.max],c.error(19,!1,this.chart)):d=this.isDatetimeAxis?this.getTimeTicks(this.normalizeTimeTickInterval(this.tickInterval,a.units),this.min,this.max,a.startOfWeek,this.ordinalPositions,this.closestPointRange,!0):this.isLog?this.getLogTickPositions(this.tickInterval,this.min,this.max):this.getLinearTickPositions(this.tickInterval,this.min,this.max),d.length>this.len&&(d=[d[0],
d.pop()],d[0]===d[1]&&(d.length=1)),this.tickPositions=d,e&&(e=e.apply(this,[this.min,this.max])))&&(this.tickPositions=d=e);this.paddedTicks=d.slice(0);this.trimTicks(d,k,l);this.isLinked||(this.single&&2>d.length&&!this.categories&&(this.min-=.5,this.max+=.5),b||e||this.adjustTickAmount());L(this,"afterSetTickPositions")},trimTicks:function(a,b,d){var e=a[0],m=a[a.length-1],k=this.minPointOffset||0;L(this,"trimTicks");if(!this.isLinked){if(b&&-Infinity!==e)this.min=e;else for(;this.min-k>a[0];)a.shift();
if(d)this.max=m;else for(;this.max+k<a[a.length-1];)a.pop();0===a.length&&z(e)&&!this.options.tickPositions&&a.push((m+e)/2)}},alignToOthers:function(){var a={},b,d=this.options;!1===this.chart.options.chart.alignTicks||!1===d.alignTicks||!1===d.startOnTick||!1===d.endOnTick||this.isLog||this.chart[this.coll].forEach(function(d){var e=d.options;e=[d.horiz?e.left:e.top,e.width,e.height,e.pane].join();d.series.length&&(a[e]?b=!0:a[e]=1)});return b},getTickAmount:function(){var a=this.options,b=a.tickAmount,
d=a.tickPixelInterval;!z(a.tickInterval)&&this.len<d&&!this.isRadial&&!this.isLog&&a.startOnTick&&a.endOnTick&&(b=2);!b&&this.alignToOthers()&&(b=Math.ceil(this.len/d)+1);4>b&&(this.finalTickAmt=b,b=5);this.tickAmount=b},adjustTickAmount:function(){var a=this.options,b=this.tickInterval,e=this.tickPositions,k=this.tickAmount,c=this.finalTickAmt,l=e&&e.length,g=h(this.threshold,this.softThreshold?0:null),r;if(this.hasData()){if(l<k){for(r=this.min;e.length<k;)e.length%2||r===g?e.push(d(e[e.length-
1]+b)):e.unshift(d(e[0]-b));this.transA*=(l-1)/(k-1);this.min=a.startOnTick?e[0]:Math.min(this.min,e[0]);this.max=a.endOnTick?e[e.length-1]:Math.max(this.max,e[e.length-1])}else l>k&&(this.tickInterval*=2,this.setTickPositions());if(z(c)){for(b=a=e.length;b--;)(3===c&&1===b%2||2>=c&&0<b&&b<a-1)&&e.splice(b,1);this.finalTickAmt=void 0}}},setScale:function(){var a=this.series.some(function(a){return a.isDirtyData||a.isDirty||a.xAxis&&a.xAxis.isDirty}),b;this.oldMin=this.min;this.oldMax=this.max;this.oldAxisLength=
this.len;this.setAxisSize();(b=this.len!==this.oldAxisLength)||a||this.isLinked||this.forceRedraw||this.userMin!==this.oldUserMin||this.userMax!==this.oldUserMax||this.alignToOthers()?(this.resetStacks&&this.resetStacks(),this.forceRedraw=!1,this.getSeriesExtremes(),this.setTickInterval(),this.oldUserMin=this.userMin,this.oldUserMax=this.userMax,this.isDirty||(this.isDirty=b||this.min!==this.oldMin||this.max!==this.oldMax)):this.cleanStacks&&this.cleanStacks();L(this,"afterSetScale")},setExtremes:function(a,
b,d,e,k){var m=this,w=m.chart;d=h(d,!0);m.series.forEach(function(a){delete a.kdTree});k=t(k,{min:a,max:b});L(m,"setExtremes",k,function(){m.userMin=a;m.userMax=b;m.eventArgs=k;d&&w.redraw(e)})},zoom:function(a,b){var d=this.dataMin,e=this.dataMax,m=this.options,k=Math.min(d,h(m.min,d)),w=Math.max(e,h(m.max,e));a={newMin:a,newMax:b};L(this,"zoom",a,function(a){var b=a.newMin,m=a.newMax;if(b!==this.min||m!==this.max)this.allowZoomOutside||(z(d)&&(b<k&&(b=k),b>w&&(b=w)),z(e)&&(m<k&&(m=k),m>w&&(m=w))),
this.displayBtn=void 0!==b||void 0!==m,this.setExtremes(b,m,!1,void 0,{trigger:"zoom"});a.zoomed=!0});return a.zoomed},setAxisSize:function(){var a=this.chart,b=this.options,d=b.offsets||[0,0,0,0],e=this.horiz,k=this.width=Math.round(c.relativeLength(h(b.width,a.plotWidth-d[3]+d[1]),a.plotWidth)),l=this.height=Math.round(c.relativeLength(h(b.height,a.plotHeight-d[0]+d[2]),a.plotHeight)),g=this.top=Math.round(c.relativeLength(h(b.top,a.plotTop+d[0]),a.plotHeight,a.plotTop));b=this.left=Math.round(c.relativeLength(h(b.left,
a.plotLeft+d[3]),a.plotWidth,a.plotLeft));this.bottom=a.chartHeight-l-g;this.right=a.chartWidth-k-b;this.len=Math.max(e?k:l,0);this.pos=e?b:g},getExtremes:function(){var a=this.isLog;return{min:a?d(this.lin2log(this.min)):this.min,max:a?d(this.lin2log(this.max)):this.max,dataMin:this.dataMin,dataMax:this.dataMax,userMin:this.userMin,userMax:this.userMax}},getThreshold:function(a){var b=this.isLog,d=b?this.lin2log(this.min):this.min;b=b?this.lin2log(this.max):this.max;null===a||-Infinity===a?a=d:Infinity===
a?a=b:d>a?a=d:b<a&&(a=b);return this.translate(a,0,1,0,1)},autoLabelAlign:function(a){var b=(h(a,0)-90*this.side+720)%360;a={align:"center"};L(this,"autoLabelAlign",a,function(a){15<b&&165>b?a.align="right":195<b&&345>b&&(a.align="left")});return a.align},tickSize:function(a){var b=this.options,d=b[a+"Length"],e=h(b[a+"Width"],"tick"===a&&this.isXAxis&&!this.categories?1:0);if(e&&d){"inside"===b[a+"Position"]&&(d=-d);var k=[d,e]}a={tickSize:k};L(this,"afterTickSize",a);return a.tickSize},labelMetrics:function(){var a=
this.tickPositions&&this.tickPositions[0]||0;return this.chart.renderer.fontMetrics(this.options.labels.style&&this.options.labels.style.fontSize,this.ticks[a]&&this.ticks[a].label)},unsquish:function(){var a=this.options.labels,b=this.horiz,e=this.tickInterval,k=e,c=this.len/(((this.categories?1:0)+this.max-this.min)/e),g,r=a.rotation,x=this.labelMetrics(),p,A=Number.MAX_VALUE,u,n=this.max-this.min,f=function(a){var b=a/(c||1);b=1<b?Math.ceil(b):1;b*e>n&&Infinity!==a&&Infinity!==c&&n&&(b=Math.ceil(n/
e));return d(b*e)};b?(u=!a.staggerLines&&!a.step&&(z(r)?[r]:c<h(a.autoRotationLimit,80)&&a.autoRotation))&&u.forEach(function(a){if(a===r||a&&-90<=a&&90>=a){p=f(Math.abs(x.h/Math.sin(l*a)));var b=p+Math.abs(a/360);b<A&&(A=b,g=a,k=p)}}):a.step||(k=f(x.h));this.autoRotation=u;this.labelRotation=h(g,r);return k},getSlotWidth:function(a){var b=this.chart,d=this.horiz,e=this.options.labels,k=Math.max(this.tickPositions.length-(this.categories?0:1),1),c=b.margin[3];return a&&a.slotWidth||d&&2>(e.step||
0)&&!e.rotation&&(this.staggerLines||1)*this.len/k||!d&&(e.style&&parseInt(e.style.width,10)||c&&c-b.spacing[3]||.33*b.chartWidth)},renderUnsquish:function(){var a=this.chart,b=a.renderer,d=this.tickPositions,e=this.ticks,k=this.options.labels,c=k&&k.style||{},l=this.horiz,g=this.getSlotWidth(),r=Math.max(1,Math.round(g-2*(k.padding||5))),x={},p=this.labelMetrics(),h=k.style&&k.style.textOverflow,A=0;H(k.rotation)||(x.rotation=k.rotation||0);d.forEach(function(a){(a=e[a])&&a.label&&a.label.textPxLength>
A&&(A=a.label.textPxLength)});this.maxLabelLength=A;if(this.autoRotation)A>r&&A>p.h?x.rotation=this.labelRotation:this.labelRotation=0;else if(g){var u=r;if(!h){var n="clip";for(r=d.length;!l&&r--;){var f=d[r];if(f=e[f].label)f.styles&&"ellipsis"===f.styles.textOverflow?f.css({textOverflow:"clip"}):f.textPxLength>g&&f.css({width:g+"px"}),f.getBBox().height>this.len/d.length-(p.h-p.f)&&(f.specificTextOverflow="ellipsis")}}}x.rotation&&(u=A>.5*a.chartHeight?.33*a.chartHeight:A,h||(n="ellipsis"));if(this.labelAlign=
k.align||this.autoLabelAlign(this.labelRotation))x.align=this.labelAlign;d.forEach(function(a){var b=(a=e[a])&&a.label,d=c.width,k={};b&&(b.attr(x),a.shortenLabel?a.shortenLabel():u&&!d&&"nowrap"!==c.whiteSpace&&(u<b.textPxLength||"SPAN"===b.element.tagName)?(k.width=u,h||(k.textOverflow=b.specificTextOverflow||n),b.css(k)):b.styles&&b.styles.width&&!k.width&&!d&&b.css({width:null}),delete b.specificTextOverflow,a.rotation=x.rotation)},this);this.tickRotCorr=b.rotCorr(p.b,this.labelRotation||0,0!==
this.side)},hasData:function(){return this.series.some(function(a){return a.hasData()})||this.options.showEmpty&&z(this.min)&&z(this.max)},addTitle:function(a){var b=this.chart.renderer,d=this.horiz,e=this.opposite,k=this.options.title,c,l=this.chart.styledMode;this.axisTitle||((c=k.textAlign)||(c=(d?{low:"left",middle:"center",high:"right"}:{low:e?"right":"left",middle:"center",high:e?"left":"right"})[k.align]),this.axisTitle=b.text(k.text,0,0,k.useHTML).attr({zIndex:7,rotation:k.rotation||0,align:c}).addClass("highcharts-axis-title"),
l||this.axisTitle.css(u(k.style)),this.axisTitle.add(this.axisGroup),this.axisTitle.isNew=!0);l||k.style.width||this.isRadial||this.axisTitle.css({width:this.len});this.axisTitle[a?"show":"hide"](a)},generateTick:function(a){var b=this.ticks;b[a]?b[a].addLabel():b[a]=new A(this,a)},getOffset:function(){var a=this,b=a.chart,d=b.renderer,e=a.options,k=a.tickPositions,c=a.ticks,l=a.horiz,g=a.side,r=b.inverted&&!a.isZAxis?[1,0,3,2][g]:g,x,p=0,A=0,u=e.title,n=e.labels,f=0,E=b.axisOffset;b=b.clipOffset;
var q=[-1,1,1,-1][g],v=e.className,t=a.axisParent;var C=a.hasData();a.showAxis=x=C||h(e.showEmpty,!0);a.staggerLines=a.horiz&&n.staggerLines;a.axisGroup||(a.gridGroup=d.g("grid").attr({zIndex:e.gridZIndex||1}).addClass("highcharts-"+this.coll.toLowerCase()+"-grid "+(v||"")).add(t),a.axisGroup=d.g("axis").attr({zIndex:e.zIndex||2}).addClass("highcharts-"+this.coll.toLowerCase()+" "+(v||"")).add(t),a.labelGroup=d.g("axis-labels").attr({zIndex:n.zIndex||7}).addClass("highcharts-"+a.coll.toLowerCase()+
"-labels "+(v||"")).add(t));C||a.isLinked?(k.forEach(function(b,d){a.generateTick(b,d)}),a.renderUnsquish(),a.reserveSpaceDefault=0===g||2===g||{1:"left",3:"right"}[g]===a.labelAlign,h(n.reserveSpace,"center"===a.labelAlign?!0:null,a.reserveSpaceDefault)&&k.forEach(function(a){f=Math.max(c[a].getLabelSize(),f)}),a.staggerLines&&(f*=a.staggerLines),a.labelOffset=f*(a.opposite?-1:1)):y(c,function(a,b){a.destroy();delete c[b]});if(u&&u.text&&!1!==u.enabled&&(a.addTitle(x),x&&!1!==u.reserveSpace)){a.titleOffset=
p=a.axisTitle.getBBox()[l?"height":"width"];var B=u.offset;A=z(B)?0:h(u.margin,l?5:10)}a.renderLine();a.offset=q*h(e.offset,E[g]?E[g]+(e.margin||0):0);a.tickRotCorr=a.tickRotCorr||{x:0,y:0};d=0===g?-a.labelMetrics().h:2===g?a.tickRotCorr.y:0;A=Math.abs(f)+A;f&&(A=A-d+q*(l?h(n.y,a.tickRotCorr.y+8*q):n.x));a.axisTitleMargin=h(B,A);a.getMaxLabelDimensions&&(a.maxLabelDimensions=a.getMaxLabelDimensions(c,k));l=this.tickSize("tick");E[g]=Math.max(E[g],a.axisTitleMargin+p+q*a.offset,A,k&&k.length&&l?l[0]+
q*a.offset:0);e=e.offset?0:2*Math.floor(a.axisLine.strokeWidth()/2);b[r]=Math.max(b[r],e);L(this,"afterGetOffset")},getLinePath:function(a){var b=this.chart,d=this.opposite,e=this.offset,k=this.horiz,c=this.left+(d?this.width:0)+e;e=b.chartHeight-this.bottom-(d?this.height:0)+e;d&&(a*=-1);return b.renderer.crispLine(["M",k?this.left:c,k?e:this.top,"L",k?b.chartWidth-this.right:c,k?e:b.chartHeight-this.bottom],a)},renderLine:function(){this.axisLine||(this.axisLine=this.chart.renderer.path().addClass("highcharts-axis-line").add(this.axisGroup),
this.chart.styledMode||this.axisLine.attr({stroke:this.options.lineColor,"stroke-width":this.options.lineWidth,zIndex:7}))},getTitlePosition:function(){var a=this.horiz,b=this.left,d=this.top,e=this.len,k=this.options.title,c=a?b:d,l=this.opposite,g=this.offset,r=k.x||0,x=k.y||0,p=this.axisTitle,A=this.chart.renderer.fontMetrics(k.style&&k.style.fontSize,p);p=Math.max(p.getBBox(null,0).height-A.h-1,0);e={low:c+(a?0:e),middle:c+e/2,high:c+(a?e:0)}[k.align];b=(a?d+this.height:b)+(a?1:-1)*(l?-1:1)*this.axisTitleMargin+
[-p,p,A.f,-p][this.side];a={x:a?e+r:b+(l?this.width:0)+g+r,y:a?b+x-(l?this.height:0)+g:e+x};L(this,"afterGetTitlePosition",{titlePosition:a});return a},renderMinorTick:function(a){var b=this.chart.hasRendered&&C(this.oldMin),d=this.minorTicks;d[a]||(d[a]=new A(this,a,"minor"));b&&d[a].isNew&&d[a].render(null,!0);d[a].render(null,!1,1)},renderTick:function(a,b){var d=this.isLinked,e=this.ticks,k=this.chart.hasRendered&&C(this.oldMin);if(!d||a>=this.min&&a<=this.max)e[a]||(e[a]=new A(this,a)),k&&e[a].isNew&&
e[a].render(b,!0,-1),e[a].render(b)},render:function(){var a=this,d=a.chart,e=a.options,k=a.isLog,l=a.isLinked,g=a.tickPositions,r=a.axisTitle,x=a.ticks,p=a.minorTicks,h=a.alternateBands,u=e.stackLabels,n=e.alternateGridColor,f=a.tickmarkOffset,E=a.axisLine,v=a.showAxis,t=b(d.renderer.globalAnimation),B,H;a.labelEdge.length=0;a.overlap=!1;[x,p,h].forEach(function(a){y(a,function(a){a.isActive=!1})});if(a.hasData()||l)a.minorTickInterval&&!a.categories&&a.getMinorTickPositions().forEach(function(b){a.renderMinorTick(b)}),
g.length&&(g.forEach(function(b,d){a.renderTick(b,d)}),f&&(0===a.min||a.single)&&(x[-1]||(x[-1]=new A(a,-1,null,!0)),x[-1].render(-1))),n&&g.forEach(function(b,e){H=void 0!==g[e+1]?g[e+1]+f:a.max-f;0===e%2&&b<a.max&&H<=a.max+(d.polar?-f:f)&&(h[b]||(h[b]=new c.PlotLineOrBand(a)),B=b+f,h[b].options={from:k?a.lin2log(B):B,to:k?a.lin2log(H):H,color:n},h[b].render(),h[b].isActive=!0)}),a._addedPlotLB||((e.plotLines||[]).concat(e.plotBands||[]).forEach(function(b){a.addPlotBandOrLine(b)}),a._addedPlotLB=
!0);[x,p,h].forEach(function(a){var b,e=[],k=t.duration;y(a,function(a,b){a.isActive||(a.render(b,!1,0),a.isActive=!1,e.push(b))});q(function(){for(b=e.length;b--;)a[e[b]]&&!a[e[b]].isActive&&(a[e[b]].destroy(),delete a[e[b]])},a!==h&&d.hasRendered&&k?k:0)});E&&(E[E.isPlaced?"animate":"attr"]({d:this.getLinePath(E.strokeWidth())}),E.isPlaced=!0,E[v?"show":"hide"](v));r&&v&&(e=a.getTitlePosition(),C(e.y)?(r[r.isNew?"attr":"animate"](e),r.isNew=!1):(r.attr("y",-9999),r.isNew=!0));u&&u.enabled&&a.renderStackTotals();
a.isDirty=!1;L(this,"afterRender")},redraw:function(){this.visible&&(this.render(),this.plotLinesAndBands.forEach(function(a){a.render()}));this.series.forEach(function(a){a.isDirty=!0})},keepProps:"extKey hcEvents names series userMax userMin".split(" "),destroy:function(a){var b=this,d=b.stacks,e=b.plotLinesAndBands,k;L(this,"destroy",{keepEvents:a});a||r(b);y(d,function(a,b){B(a);d[b]=null});[b.ticks,b.minorTicks,b.alternateBands].forEach(function(a){B(a)});if(e)for(a=e.length;a--;)e[a].destroy();
"stackTotalGroup axisLine axisTitle axisGroup gridGroup labelGroup cross scrollbar".split(" ").forEach(function(a){b[a]&&(b[a]=b[a].destroy())});for(k in b.plotLinesAndBandsGroups)b.plotLinesAndBandsGroups[k]=b.plotLinesAndBandsGroups[k].destroy();y(b,function(a,d){-1===b.keepProps.indexOf(d)&&delete b[d]})},drawCrosshair:function(b,d){var e,k=this.crosshair,c=h(k.snap,!0),l,g=this.cross;L(this,"drawCrosshair",{e:b,point:d});b||(b=this.cross&&this.cross.e);if(this.crosshair&&!1!==(z(d)||!c)){c?z(d)&&
(l=h("colorAxis"!==this.coll?d.crosshairPos:null,this.isXAxis?d.plotX:this.len-d.plotY)):l=b&&(this.horiz?b.chartX-this.pos:this.len-b.chartY+this.pos);z(l)&&(e=this.getPlotLinePath({value:d&&(this.isXAxis?d.x:h(d.stackY,d.y)),translatedValue:l})||null);if(!z(e)){this.hideCrosshair();return}c=this.categories&&!this.isRadial;g||(this.cross=g=this.chart.renderer.path().addClass("highcharts-crosshair highcharts-crosshair-"+(c?"category ":"thin ")+k.className).attr({zIndex:h(k.zIndex,2)}).add(),this.chart.styledMode||
(g.attr({stroke:k.color||(c?a("#ccd6eb").setOpacity(.25).get():"#cccccc"),"stroke-width":h(k.width,1)}).css({"pointer-events":"none"}),k.dashStyle&&g.attr({dashstyle:k.dashStyle})));g.show().attr({d:e});c&&!k.width&&g.attr({"stroke-width":this.transA});this.cross.e=b}else this.hideCrosshair();L(this,"afterDrawCrosshair",{e:b,point:d})},hideCrosshair:function(){this.cross&&this.cross.hide();L(this,"afterHideCrosshair")}});return c.Axis=f});M(I,"parts/DateTimeAxis.js",[I["parts/Globals.js"]],function(c){var f=
c.Axis,F=c.getMagnitude,G=c.normalizeTickInterval,z=c.timeUnits;f.prototype.getTimeTicks=function(){return this.chart.time.getTimeTicks.apply(this.chart.time,arguments)};f.prototype.normalizeTimeTickInterval=function(c,f){var v=f||[["millisecond",[1,2,5,10,20,25,50,100,200,500]],["second",[1,2,5,10,15,30]],["minute",[1,2,5,10,15,30]],["hour",[1,2,3,4,6,8,12]],["day",[1,2]],["week",[1,2]],["month",[1,2,3,4,6]],["year",null]];f=v[v.length-1];var t=z[f[0]],B=f[1],y;for(y=0;y<v.length&&!(f=v[y],t=z[f[0]],
B=f[1],v[y+1]&&c<=(t*B[B.length-1]+z[v[y+1][0]])/2);y++);t===z.year&&c<5*t&&(B=[1,2,5]);c=G(c/t,B,"year"===f[0]?Math.max(F(c/t),1):1);return{unitRange:t,count:c,unitName:f[0]}}});M(I,"parts/LogarithmicAxis.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.pick;f=c.Axis;var G=c.getMagnitude,z=c.normalizeTickInterval;f.prototype.getLogTickPositions=function(c,f,v,C){var t=this.options,y=this.len,h=[];C||(this._minorAutoInterval=null);if(.5<=c)c=Math.round(c),h=this.getLinearTickPositions(c,
f,v);else if(.08<=c){y=Math.floor(f);var n,q;for(t=.3<c?[1,2,4]:.15<c?[1,2,4,6,8]:[1,2,3,4,5,6,7,8,9];y<v+1&&!q;y++){var g=t.length;for(n=0;n<g&&!q;n++){var b=this.log2lin(this.lin2log(y)*t[n]);b>f&&(!C||a<=v)&&void 0!==a&&h.push(a);a>v&&(q=!0);var a=b}}}else f=this.lin2log(f),v=this.lin2log(v),c=C?this.getMinorTickInterval():t.tickInterval,c=F("auto"===c?null:c,this._minorAutoInterval,t.tickPixelInterval/(C?5:1)*(v-f)/((C?y/this.tickPositions.length:y)||1)),c=z(c,null,G(c)),h=this.getLinearTickPositions(c,
f,v).map(this.log2lin),C||(this._minorAutoInterval=c/5);C||(this.tickInterval=c);return h};f.prototype.log2lin=function(c){return Math.log(c)/Math.LN10};f.prototype.lin2log=function(c){return Math.pow(10,c)}});M(I,"parts/PlotLineOrBand.js",[I["parts/Globals.js"],I["parts/Axis.js"],I["parts/Utilities.js"]],function(c,f,F){var G=F.arrayMax,z=F.arrayMin,B=F.defined,t=F.destroyObjectProperties,v=F.erase,C=F.extend,H=F.objectEach,y=F.pick,h=c.merge;c.PlotLineOrBand=function(c,h){this.axis=c;h&&(this.options=
h,this.id=h.id)};c.PlotLineOrBand.prototype={render:function(){c.fireEvent(this,"render");var f=this,q=f.axis,g=q.horiz,b=f.options,a=b.label,d=f.label,e=b.to,l=b.from,L=b.value,E=B(l)&&B(e),p=B(L),u=f.svgElem,k=!u,r=[],x=b.color,A=y(b.zIndex,0),w=b.events;r={"class":"highcharts-plot-"+(E?"band ":"line ")+(b.className||"")};var m={},K=q.chart.renderer,J=E?"bands":"lines";q.isLog&&(l=q.log2lin(l),e=q.log2lin(e),L=q.log2lin(L));q.chart.styledMode||(p?(r.stroke=x||"#999999",r["stroke-width"]=y(b.width,
1),b.dashStyle&&(r.dashstyle=b.dashStyle)):E&&(r.fill=x||"#e6ebf5",b.borderWidth&&(r.stroke=b.borderColor,r["stroke-width"]=b.borderWidth)));m.zIndex=A;J+="-"+A;(x=q.plotLinesAndBandsGroups[J])||(q.plotLinesAndBandsGroups[J]=x=K.g("plot-"+J).attr(m).add());k&&(f.svgElem=u=K.path().attr(r).add(x));if(p)r=q.getPlotLinePath({value:L,lineWidth:u.strokeWidth(),acrossPanes:b.acrossPanes});else if(E)r=q.getPlotBandPath(l,e,b);else return;(k||!u.d)&&r&&r.length?(u.attr({d:r}),w&&H(w,function(a,b){u.on(b,
function(a){w[b].apply(f,[a])})})):u&&(r?(u.show(!0),u.animate({d:r})):u.d&&(u.hide(),d&&(f.label=d=d.destroy())));a&&(B(a.text)||B(a.formatter))&&r&&r.length&&0<q.width&&0<q.height&&!r.isFlat?(a=h({align:g&&E&&"center",x:g?!E&&4:10,verticalAlign:!g&&E&&"middle",y:g?E?16:10:E?6:-4,rotation:g&&!E&&90},a),this.renderLabel(a,r,E,A)):d&&d.hide();return f},renderLabel:function(c,h,g,b){var a=this.label,d=this.axis.chart.renderer;a||(a={align:c.textAlign||c.align,rotation:c.rotation,"class":"highcharts-plot-"+
(g?"band":"line")+"-label "+(c.className||"")},a.zIndex=b,b=this.getLabelText(c),this.label=a=d.text(b,0,0,c.useHTML).attr(a).add(),this.axis.chart.styledMode||a.css(c.style));d=h.xBounds||[h[1],h[4],g?h[6]:h[1]];h=h.yBounds||[h[2],h[5],g?h[7]:h[2]];g=z(d);b=z(h);a.align(c,!1,{x:g,y:b,width:G(d)-g,height:G(h)-b});a.show(!0)},getLabelText:function(c){return B(c.formatter)?c.formatter.call(this):c.text},destroy:function(){v(this.axis.plotLinesAndBands,this);delete this.axis;t(this)}};C(f.prototype,
{getPlotBandPath:function(c,h){var g=this.getPlotLinePath({value:h,force:!0,acrossPanes:this.options.acrossPanes}),b=this.getPlotLinePath({value:c,force:!0,acrossPanes:this.options.acrossPanes}),a=[],d=this.horiz,e=1;c=c<this.min&&h<this.min||c>this.max&&h>this.max;if(b&&g){if(c){var l=b.toString()===g.toString();e=0}for(c=0;c<b.length;c+=6)d&&g[c+1]===b[c+1]?(g[c+1]+=e,g[c+4]+=e):d||g[c+2]!==b[c+2]||(g[c+2]+=e,g[c+5]+=e),a.push("M",b[c+1],b[c+2],"L",b[c+4],b[c+5],g[c+4],g[c+5],g[c+1],g[c+2],"z"),
a.isFlat=l}return a},addPlotBand:function(c){return this.addPlotBandOrLine(c,"plotBands")},addPlotLine:function(c){return this.addPlotBandOrLine(c,"plotLines")},addPlotBandOrLine:function(h,f){var g=(new c.PlotLineOrBand(this,h)).render(),b=this.userOptions;if(g){if(f){var a=b[f]||[];a.push(h);b[f]=a}this.plotLinesAndBands.push(g)}return g},removePlotBandOrLine:function(c){for(var h=this.plotLinesAndBands,g=this.options,b=this.userOptions,a=h.length;a--;)h[a].id===c&&h[a].destroy();[g.plotLines||
[],b.plotLines||[],g.plotBands||[],b.plotBands||[]].forEach(function(b){for(a=b.length;a--;)b[a].id===c&&v(b,b[a])})},removePlotBand:function(c){this.removePlotBandOrLine(c)},removePlotLine:function(c){this.removePlotBandOrLine(c)}})});M(I,"parts/Tooltip.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.discardElement,z=f.extend,B=f.isNumber,t=f.isString,v=f.pick,C=f.splat,H=f.syncTimeout;"";var y=c.doc,h=c.format,n=c.merge,q=c.timeUnits;c.Tooltip=function(){this.init.apply(this,
arguments)};c.Tooltip.prototype={init:function(c,b){this.chart=c;this.options=b;this.crosshairs=[];this.now={x:0,y:0};this.isHidden=!0;this.split=b.split&&!c.inverted;this.shared=b.shared||this.split;this.outside=v(b.outside,!(!c.scrollablePixelsX&&!c.scrollablePixelsY))},cleanSplit:function(c){this.chart.series.forEach(function(b){var a=b&&b.tt;a&&(!a.isActive||c?b.tt=a.destroy():a.isActive=!1)})},applyFilter:function(){var c=this.chart;c.renderer.definition({tagName:"filter",id:"drop-shadow-"+c.index,
opacity:.5,children:[{tagName:"feGaussianBlur","in":"SourceAlpha",stdDeviation:1},{tagName:"feOffset",dx:1,dy:1},{tagName:"feComponentTransfer",children:[{tagName:"feFuncA",type:"linear",slope:.3}]},{tagName:"feMerge",children:[{tagName:"feMergeNode"},{tagName:"feMergeNode","in":"SourceGraphic"}]}]});c.renderer.definition({tagName:"style",textContent:".highcharts-tooltip-"+c.index+"{filter:url(#drop-shadow-"+c.index+")}"})},getLabel:function(){var g=this,b=this.chart.renderer,a=this.chart.styledMode,
d=this.options,e="tooltip"+(F(d.className)?" "+d.className:""),l;if(!this.label){this.outside&&(this.container=l=c.doc.createElement("div"),l.className="highcharts-tooltip-container",c.css(l,{position:"absolute",top:"1px",pointerEvents:d.style&&d.style.pointerEvents,zIndex:3}),c.doc.body.appendChild(l),this.renderer=b=new c.Renderer(l,0,0,{},void 0,void 0,b.styledMode));this.split?this.label=b.g(e):(this.label=b.label("",0,0,d.shape||"callout",null,null,d.useHTML,null,e).attr({padding:d.padding,r:d.borderRadius}),
a||this.label.attr({fill:d.backgroundColor,"stroke-width":d.borderWidth}).css(d.style).shadow(d.shadow));a&&(this.applyFilter(),this.label.addClass("highcharts-tooltip-"+this.chart.index));if(g.outside&&!g.split){var h={x:this.label.xSetter,y:this.label.ySetter};this.label.xSetter=function(a,b){h[b].call(this.label,g.distance);l.style.left=a+"px"};this.label.ySetter=function(a,b){h[b].call(this.label,g.distance);l.style.top=a+"px"}}this.label.attr({zIndex:8}).add()}return this.label},update:function(c){this.destroy();
n(!0,this.chart.options.tooltip.userOptions,c);this.init(this.chart,n(!0,this.options,c))},destroy:function(){this.label&&(this.label=this.label.destroy());this.split&&this.tt&&(this.cleanSplit(this.chart,!0),this.tt=this.tt.destroy());this.renderer&&(this.renderer=this.renderer.destroy(),G(this.container));c.clearTimeout(this.hideTimer);c.clearTimeout(this.tooltipTimeout)},move:function(g,b,a,d){var e=this,l=e.now,h=!1!==e.options.animation&&!e.isHidden&&(1<Math.abs(g-l.x)||1<Math.abs(b-l.y)),f=
e.followPointer||1<e.len;z(l,{x:h?(2*l.x+g)/3:g,y:h?(l.y+b)/2:b,anchorX:f?void 0:h?(2*l.anchorX+a)/3:a,anchorY:f?void 0:h?(l.anchorY+d)/2:d});e.getLabel().attr(l);h&&(c.clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(function(){e&&e.move(g,b,a,d)},32))},hide:function(g){var b=this;c.clearTimeout(this.hideTimer);g=v(g,this.options.hideDelay,500);this.isHidden||(this.hideTimer=H(function(){b.getLabel()[g?"fadeOut":"hide"]();b.isHidden=!0},g))},getAnchor:function(c,b){var a=this.chart,
d=a.pointer,e=a.inverted,l=a.plotTop,g=a.plotLeft,h=0,p=0,f,k;c=C(c);this.followPointer&&b?(void 0===b.chartX&&(b=d.normalize(b)),c=[b.chartX-a.plotLeft,b.chartY-l]):c[0].tooltipPos?c=c[0].tooltipPos:(c.forEach(function(a){f=a.series.yAxis;k=a.series.xAxis;h+=a.plotX+(!e&&k?k.left-g:0);p+=(a.plotLow?(a.plotLow+a.plotHigh)/2:a.plotY)+(!e&&f?f.top-l:0)}),h/=c.length,p/=c.length,c=[e?a.plotWidth-p:h,this.shared&&!e&&1<c.length&&b?b.chartY-l:e?a.plotHeight-h:p]);return c.map(Math.round)},getPosition:function(c,
b,a){var d=this.chart,e=this.distance,l={},g=d.inverted&&a.h||0,h,p=this.outside,f=p?y.documentElement.clientWidth-2*e:d.chartWidth,k=p?Math.max(y.body.scrollHeight,y.documentElement.scrollHeight,y.body.offsetHeight,y.documentElement.offsetHeight,y.documentElement.clientHeight):d.chartHeight,r=d.pointer.getChartPosition(),x=d.containerScaling,A=function(a){return x?a*x.scaleX:a},w=function(a){return x?a*x.scaleY:a},m=function(l){var m="x"===l;return[l,m?f:k,m?c:b].concat(p?[m?A(c):w(b),m?r.left-e+
A(a.plotX+d.plotLeft):r.top-e+w(a.plotY+d.plotTop),0,m?f:k]:[m?c:b,m?a.plotX+d.plotLeft:a.plotY+d.plotTop,m?d.plotLeft:d.plotTop,m?d.plotLeft+d.plotWidth:d.plotTop+d.plotHeight])},n=m("y"),J=m("x"),q=!this.followPointer&&v(a.ttBelow,!d.inverted===!!a.negative),t=function(a,b,d,c,k,m,r){var x="y"===a?w(e):A(e),p=(d-c)/2,h=c<k-e,f=k+e+c<b,u=k-x-d+p;k=k+x-p;if(q&&f)l[a]=k;else if(!q&&h)l[a]=u;else if(h)l[a]=Math.min(r-c,0>u-g?u:u-g);else if(f)l[a]=Math.max(m,k+g+d>b?k:k+g);else return!1},C=function(a,
b,d,k,c){var m;c<e||c>b-e?m=!1:l[a]=c<d/2?1:c>b-k/2?b-k-2:c-d/2;return m},O=function(a){var b=n;n=J;J=b;h=a},D=function(){!1!==t.apply(0,n)?!1!==C.apply(0,J)||h||(O(!0),D()):h?l.x=l.y=0:(O(!0),D())};(d.inverted||1<this.len)&&O();D();return l},defaultFormatter:function(c){var b=this.points||C(this);var a=[c.tooltipFooterHeaderFormatter(b[0])];a=a.concat(c.bodyFormatter(b));a.push(c.tooltipFooterHeaderFormatter(b[0],!0));return a},refresh:function(g,b){var a=this.chart,d=this.options,e=g,l={},h=[],
f=d.formatter||this.defaultFormatter;l=this.shared;var p=a.styledMode;if(d.enabled){c.clearTimeout(this.hideTimer);this.followPointer=C(e)[0].series.tooltipOptions.followPointer;var u=this.getAnchor(e,b);b=u[0];var k=u[1];!l||e.series&&e.series.noSharedTooltip?l=e.getLabelConfig():(a.pointer.applyInactiveState(e),e.forEach(function(a){a.setState("hover");h.push(a.getLabelConfig())}),l={x:e[0].category,y:e[0].y},l.points=h,e=e[0]);this.len=h.length;a=f.call(l,this);f=e.series;this.distance=v(f.tooltipOptions.distance,
16);!1===a?this.hide():(this.split?this.renderSplit(a,C(g)):(g=this.getLabel(),d.style.width&&!p||g.css({width:this.chart.spacingBox.width}),g.attr({text:a&&a.join?a.join(""):a}),g.removeClass(/highcharts-color-[\d]+/g).addClass("highcharts-color-"+v(e.colorIndex,f.colorIndex)),p||g.attr({stroke:d.borderColor||e.color||f.color||"#666666"}),this.updatePosition({plotX:b,plotY:k,negative:e.negative,ttBelow:e.ttBelow,h:u[2]||0})),this.isHidden&&this.label&&this.label.attr({opacity:1}).show(),this.isHidden=
!1);c.fireEvent(this,"refresh")}},renderSplit:function(g,b){var a=this,d=[],e=this.chart,l=e.renderer,h=!0,f=this.options,p=0,u,k=this.getLabel(),r=e.plotTop;t(g)&&(g=[!1,g]);g.slice(0,b.length+1).forEach(function(c,m){if(!1!==c&&""!==c){m=b[m-1]||{isHeader:!0,plotX:b[0].plotX,plotY:e.plotHeight};var g=m.series||a,x=g.tt,w=m.series||{},A="highcharts-color-"+v(m.colorIndex,w.colorIndex,"none");x||(x={padding:f.padding,r:f.borderRadius},e.styledMode||(x.fill=f.backgroundColor,x["stroke-width"]=f.borderWidth),
g.tt=x=l.label(null,null,null,(m.isHeader?f.headerShape:f.shape)||"callout",null,null,f.useHTML).addClass(m.isHeader?"highcharts-tooltip-header ":"highcharts-tooltip-box "+A).attr(x).add(k));x.isActive=!0;x.attr({text:c});e.styledMode||x.css(f.style).shadow(f.shadow).attr({stroke:f.borderColor||m.color||w.color||"#333333"});c=x.getBBox();A=c.width+x.strokeWidth();m.isHeader?(p=c.height,e.xAxis[0].opposite&&(u=!0,r-=p),c=Math.max(0,Math.min(m.plotX+e.plotLeft-A/2,e.chartWidth+(e.scrollablePixelsX?
e.scrollablePixelsX-e.marginRight:0)-A))):c=m.plotX+e.plotLeft-v(f.distance,16)-A;0>c&&(h=!1);m.isHeader?w=u?-p:e.plotHeight+p:(w=w.yAxis,w=w.pos-r+Math.max(0,Math.min(m.plotY||0,w.len)));d.push({target:w,rank:m.isHeader?1:0,size:g.tt.getBBox().height+1,point:m,x:c,tt:x})}});this.cleanSplit();f.positioner&&d.forEach(function(b){var d=f.positioner.call(a,b.tt.getBBox().width,b.size,b.point);b.x=d.x;b.align=0;b.target=d.y;b.rank=v(d.rank,b.rank)});c.distribute(d,e.plotHeight+p);d.forEach(function(b){var d=
b.point,c=d.series,k=c&&c.yAxis;b.tt.attr({visibility:void 0===b.pos?"hidden":"inherit",x:h||d.isHeader||f.positioner?b.x:d.plotX+e.plotLeft+a.distance,y:b.pos+r,anchorX:d.isHeader?d.plotX+e.plotLeft:d.plotX+c.xAxis.pos,anchorY:d.isHeader?e.plotTop+e.plotHeight/2:k.pos+Math.max(0,Math.min(d.plotY,k.len))})});var x=a.container;g=a.renderer;if(a.outside&&x&&g){var A=e.pointer.getChartPosition();x.style.left=A.left+"px";x.style.top=A.top+"px";x=k.getBBox();g.setSize(x.width+x.x,x.height+x.y,!1)}},updatePosition:function(g){var b=
this.chart,a=b.pointer,d=this.getLabel(),e=g.plotX+b.plotLeft,l=g.plotY+b.plotTop;a=a.getChartPosition();g=(this.options.positioner||this.getPosition).call(this,d.width,d.height,g);if(this.outside){var h=(this.options.borderWidth||0)+2*this.distance;this.renderer.setSize(d.width+h,d.height+h,!1);if(b=b.containerScaling)c.css(this.container,{transform:"scale("+b.scaleX+", "+b.scaleY+")"}),e*=b.scaleX,l*=b.scaleY;e+=a.left-g.x;l+=a.top-g.y}this.move(Math.round(g.x),Math.round(g.y||0),e,l)},getDateFormat:function(c,
b,a,d){var e=this.chart.time,l=e.dateFormat("%m-%d %H:%M:%S.%L",b),g={millisecond:15,second:12,minute:9,hour:6,day:3},h="millisecond";for(p in q){if(c===q.week&&+e.dateFormat("%w",b)===a&&"00:00:00.000"===l.substr(6)){var p="week";break}if(q[p]>c){p=h;break}if(g[p]&&l.substr(g[p])!=="01-01 00:00:00.000".substr(g[p]))break;"week"!==p&&(h=p)}if(p)var f=e.resolveDTLFormat(d[p]).main;return f},getXDateFormat:function(c,b,a){b=b.dateTimeLabelFormats;var d=a&&a.closestPointRange;return(d?this.getDateFormat(d,
c.x,a.options.startOfWeek,b):b.day)||b.year},tooltipFooterHeaderFormatter:function(g,b){var a=b?"footer":"header",d=g.series,e=d.tooltipOptions,l=e.xDateFormat,f=d.xAxis,n=f&&"datetime"===f.options.type&&B(g.key),p=e[a+"Format"];b={isFooter:b,labelConfig:g};c.fireEvent(this,"headerFormatter",b,function(a){n&&!l&&(l=this.getXDateFormat(g,e,f));n&&l&&(g.point&&g.point.tooltipDateKeys||["key"]).forEach(function(a){p=p.replace("{point."+a+"}","{point."+a+":"+l+"}")});d.chart.styledMode&&(p=this.styledModeFormat(p));
a.text=h(p,{point:g,series:d},this.chart.time)});return b.text},bodyFormatter:function(c){return c.map(function(b){var a=b.series.tooltipOptions;return(a[(b.point.formatPrefix||"point")+"Formatter"]||b.point.tooltipFormatter).call(b.point,a[(b.point.formatPrefix||"point")+"Format"]||"")})},styledModeFormat:function(c){return c.replace('style="font-size: 10px"','class="highcharts-header"').replace(/style="color:{(point|series)\.color}"/g,'class="highcharts-color-{$1.colorIndex}"')}}});M(I,"parts/Pointer.js",
[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.attr,G=f.defined,z=f.extend,B=f.isNumber,t=f.isObject,v=f.objectEach,C=f.pick,H=f.splat,y=c.addEvent,h=c.charts,n=c.color,q=c.css,g=c.find,b=c.fireEvent,a=c.offset,d=c.Tooltip;c.Pointer=function(a,b){this.init(a,b)};c.Pointer.prototype={init:function(a,b){this.options=b;this.chart=a;this.runChartClick=b.chart.events&&!!b.chart.events.click;this.pinchDown=[];this.lastValidTouch={};d&&(a.tooltip=new d(a,b.tooltip),this.followTouchMove=
C(b.tooltip.followTouchMove,!0));this.setDOMEvents()},zoomOption:function(a){var b=this.chart,d=b.options.chart,e=d.zoomType||"";b=b.inverted;/touch/.test(a.type)&&(e=C(d.pinchType,e));this.zoomX=a=/x/.test(e);this.zoomY=e=/y/.test(e);this.zoomHor=a&&!b||e&&b;this.zoomVert=e&&!b||a&&b;this.hasZoom=a||e},getChartPosition:function(){return this.chartPosition||(this.chartPosition=a(this.chart.container))},normalize:function(a,b){var d=a.touches?a.touches.length?a.touches.item(0):a.changedTouches[0]:
a;b||(b=this.getChartPosition());var e=d.pageX-b.left;b=d.pageY-b.top;if(d=this.chart.containerScaling)e/=d.scaleX,b/=d.scaleY;return z(a,{chartX:Math.round(e),chartY:Math.round(b)})},getCoordinates:function(a){var b={xAxis:[],yAxis:[]};this.chart.axes.forEach(function(d){b[d.isXAxis?"xAxis":"yAxis"].push({axis:d,value:d.toValue(a[d.horiz?"chartX":"chartY"])})});return b},findNearestKDPoint:function(a,b,d){var e;a.forEach(function(a){var c=!(a.noSharedTooltip&&b)&&0>a.options.findNearestPointBy.indexOf("y");
a=a.searchPoint(d,c);if((c=t(a,!0))&&!(c=!t(e,!0))){c=e.distX-a.distX;var k=e.dist-a.dist,l=(a.series.group&&a.series.group.zIndex)-(e.series.group&&e.series.group.zIndex);c=0<(0!==c&&b?c:0!==k?k:0!==l?l:e.series.index>a.series.index?-1:1)}c&&(e=a)});return e},getPointFromEvent:function(a){a=a.target;for(var b;a&&!b;)b=a.point,a=a.parentNode;return b},getChartCoordinatesFromPoint:function(a,b){var d=a.series,e=d.xAxis;d=d.yAxis;var c=C(a.clientX,a.plotX),l=a.shapeArgs;if(e&&d)return b?{chartX:e.len+
e.pos-c,chartY:d.len+d.pos-a.plotY}:{chartX:c+e.pos,chartY:a.plotY+d.pos};if(l&&l.x&&l.y)return{chartX:l.x,chartY:l.y}},getHoverData:function(a,b,d,c,h,f){var e,l=[];c=!(!c||!a);var x=b&&!b.stickyTracking?[b]:d.filter(function(a){return a.visible&&!(!h&&a.directTouch)&&C(a.options.enableMouseTracking,!0)&&a.stickyTracking});b=(e=c||!f?a:this.findNearestKDPoint(x,h,f))&&e.series;e&&(h&&!b.noSharedTooltip?(x=d.filter(function(a){return a.visible&&!(!h&&a.directTouch)&&C(a.options.enableMouseTracking,
!0)&&!a.noSharedTooltip}),x.forEach(function(a){var b=g(a.points,function(a){return a.x===e.x&&!a.isNull});t(b)&&(a.chart.isBoosting&&(b=a.getPoint(b)),l.push(b))})):l.push(e));return{hoverPoint:e,hoverSeries:b,hoverPoints:l}},runPointActions:function(a,b){var d=this.chart,e=d.tooltip&&d.tooltip.options.enabled?d.tooltip:void 0,l=e?e.shared:!1,g=b||d.hoverPoint,k=g&&g.series||d.hoverSeries;k=this.getHoverData(g,k,d.series,(!a||"touchmove"!==a.type)&&(!!b||k&&k.directTouch&&this.isDirectTouch),l,a);
g=k.hoverPoint;var r=k.hoverPoints;b=(k=k.hoverSeries)&&k.tooltipOptions.followPointer;l=l&&k&&!k.noSharedTooltip;if(g&&(g!==d.hoverPoint||e&&e.isHidden)){(d.hoverPoints||[]).forEach(function(a){-1===r.indexOf(a)&&a.setState()});if(d.hoverSeries!==k)k.onMouseOver();this.applyInactiveState(r);(r||[]).forEach(function(a){a.setState("hover")});d.hoverPoint&&d.hoverPoint.firePointEvent("mouseOut");if(!g.series)return;g.firePointEvent("mouseOver");d.hoverPoints=r;d.hoverPoint=g;e&&e.refresh(l?r:g,a)}else b&&
e&&!e.isHidden&&(g=e.getAnchor([{}],a),e.updatePosition({plotX:g[0],plotY:g[1]}));this.unDocMouseMove||(this.unDocMouseMove=y(d.container.ownerDocument,"mousemove",function(a){var b=h[c.hoverChartIndex];if(b)b.pointer.onDocumentMouseMove(a)}));d.axes.forEach(function(b){var d=C(b.crosshair.snap,!0),e=d?c.find(r,function(a){return a.series[b.coll]===b}):void 0;e||!d?b.drawCrosshair(a,e):b.hideCrosshair()})},applyInactiveState:function(a){var b=[],d;(a||[]).forEach(function(a){d=a.series;b.push(d);
d.linkedParent&&b.push(d.linkedParent);d.linkedSeries&&(b=b.concat(d.linkedSeries));d.navigatorSeries&&b.push(d.navigatorSeries)});this.chart.series.forEach(function(a){-1===b.indexOf(a)?a.setState("inactive",!0):a.options.inactiveOtherPoints&&a.setAllPointsToState("inactive")})},reset:function(a,b){var d=this.chart,e=d.hoverSeries,c=d.hoverPoint,g=d.hoverPoints,k=d.tooltip,l=k&&k.shared?g:c;a&&l&&H(l).forEach(function(b){b.series.isCartesian&&void 0===b.plotX&&(a=!1)});if(a)k&&l&&H(l).length&&(k.refresh(l),
k.shared&&g?g.forEach(function(a){a.setState(a.state,!0);a.series.isCartesian&&(a.series.xAxis.crosshair&&a.series.xAxis.drawCrosshair(null,a),a.series.yAxis.crosshair&&a.series.yAxis.drawCrosshair(null,a))}):c&&(c.setState(c.state,!0),d.axes.forEach(function(a){a.crosshair&&a.drawCrosshair(null,c)})));else{if(c)c.onMouseOut();g&&g.forEach(function(a){a.setState()});if(e)e.onMouseOut();k&&k.hide(b);this.unDocMouseMove&&(this.unDocMouseMove=this.unDocMouseMove());d.axes.forEach(function(a){a.hideCrosshair()});
this.hoverX=d.hoverPoints=d.hoverPoint=null}},scaleGroups:function(a,b){var d=this.chart,e;d.series.forEach(function(c){e=a||c.getPlotBox();c.xAxis&&c.xAxis.zoomEnabled&&c.group&&(c.group.attr(e),c.markerGroup&&(c.markerGroup.attr(e),c.markerGroup.clip(b?d.clipRect:null)),c.dataLabelsGroup&&c.dataLabelsGroup.attr(e))});d.clipRect.attr(b||d.clipBox)},dragStart:function(a){var b=this.chart;b.mouseIsDown=a.type;b.cancelClick=!1;b.mouseDownX=this.mouseDownX=a.chartX;b.mouseDownY=this.mouseDownY=a.chartY},
drag:function(a){var b=this.chart,d=b.options.chart,e=a.chartX,c=a.chartY,g=this.zoomHor,k=this.zoomVert,r=b.plotLeft,h=b.plotTop,A=b.plotWidth,w=b.plotHeight,m=this.selectionMarker,f=this.mouseDownX,J=this.mouseDownY,v=d.panKey&&a[d.panKey+"Key"];if(!m||!m.touch)if(e<r?e=r:e>r+A&&(e=r+A),c<h?c=h:c>h+w&&(c=h+w),this.hasDragged=Math.sqrt(Math.pow(f-e,2)+Math.pow(J-c,2)),10<this.hasDragged){var q=b.isInsidePlot(f-r,J-h);b.hasCartesianSeries&&(this.zoomX||this.zoomY)&&q&&!v&&!m&&(this.selectionMarker=
m=b.renderer.rect(r,h,g?1:A,k?1:w,0).attr({"class":"highcharts-selection-marker",zIndex:7}).add(),b.styledMode||m.attr({fill:d.selectionMarkerFill||n("#335cad").setOpacity(.25).get()}));m&&g&&(e-=f,m.attr({width:Math.abs(e),x:(0<e?0:e)+f}));m&&k&&(e=c-J,m.attr({height:Math.abs(e),y:(0<e?0:e)+J}));q&&!m&&d.panning&&b.pan(a,d.panning)}},drop:function(a){var d=this,e=this.chart,c=this.hasPinched;if(this.selectionMarker){var g={originalEvent:a,xAxis:[],yAxis:[]},h=this.selectionMarker,k=h.attr?h.attr("x"):
h.x,r=h.attr?h.attr("y"):h.y,x=h.attr?h.attr("width"):h.width,A=h.attr?h.attr("height"):h.height,w;if(this.hasDragged||c)e.axes.forEach(function(b){if(b.zoomEnabled&&G(b.min)&&(c||d[{xAxis:"zoomX",yAxis:"zoomY"}[b.coll]])){var e=b.horiz,m="touchend"===a.type?b.minPixelPadding:0,l=b.toValue((e?k:r)+m);e=b.toValue((e?k+x:r+A)-m);g[b.coll].push({axis:b,min:Math.min(l,e),max:Math.max(l,e)});w=!0}}),w&&b(e,"selection",g,function(a){e.zoom(z(a,c?{animation:!1}:null))});B(e.index)&&(this.selectionMarker=
this.selectionMarker.destroy());c&&this.scaleGroups()}e&&B(e.index)&&(q(e.container,{cursor:e._cursor}),e.cancelClick=10<this.hasDragged,e.mouseIsDown=this.hasDragged=this.hasPinched=!1,this.pinchDown=[])},onContainerMouseDown:function(a){a=this.normalize(a);2!==a.button&&(this.zoomOption(a),a.preventDefault&&a.preventDefault(),this.dragStart(a))},onDocumentMouseUp:function(a){h[c.hoverChartIndex]&&h[c.hoverChartIndex].pointer.drop(a)},onDocumentMouseMove:function(a){var b=this.chart,d=this.chartPosition;
a=this.normalize(a,d);!d||this.inClass(a.target,"highcharts-tracker")||b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)||this.reset()},onContainerMouseLeave:function(a){var b=h[c.hoverChartIndex];b&&(a.relatedTarget||a.toElement)&&(b.pointer.reset(),b.pointer.chartPosition=void 0)},onContainerMouseMove:function(a){var b=this.chart;G(c.hoverChartIndex)&&h[c.hoverChartIndex]&&h[c.hoverChartIndex].mouseIsDown||(c.hoverChartIndex=b.index);a=this.normalize(a);a.preventDefault||(a.returnValue=!1);
"mousedown"===b.mouseIsDown&&this.drag(a);!this.inClass(a.target,"highcharts-tracker")&&!b.isInsidePlot(a.chartX-b.plotLeft,a.chartY-b.plotTop)||b.openMenu||this.runPointActions(a)},inClass:function(a,b){for(var d;a;){if(d=F(a,"class")){if(-1!==d.indexOf(b))return!0;if(-1!==d.indexOf("highcharts-container"))return!1}a=a.parentNode}},onTrackerMouseOut:function(a){var b=this.chart.hoverSeries;a=a.relatedTarget||a.toElement;this.isDirectTouch=!1;if(!(!b||!a||b.stickyTracking||this.inClass(a,"highcharts-tooltip")||
this.inClass(a,"highcharts-series-"+b.index)&&this.inClass(a,"highcharts-tracker")))b.onMouseOut()},onContainerClick:function(a){var d=this.chart,e=d.hoverPoint,c=d.plotLeft,g=d.plotTop;a=this.normalize(a);d.cancelClick||(e&&this.inClass(a.target,"highcharts-tracker")?(b(e.series,"click",z(a,{point:e})),d.hoverPoint&&e.firePointEvent("click",a)):(z(a,this.getCoordinates(a)),d.isInsidePlot(a.chartX-c,a.chartY-g)&&b(d,"click",a)))},setDOMEvents:function(){var a=this,b=a.chart.container,d=b.ownerDocument;
b.onmousedown=function(b){a.onContainerMouseDown(b)};b.onmousemove=function(b){a.onContainerMouseMove(b)};b.onclick=function(b){a.onContainerClick(b)};this.unbindContainerMouseLeave=y(b,"mouseleave",a.onContainerMouseLeave);c.unbindDocumentMouseUp||(c.unbindDocumentMouseUp=y(d,"mouseup",a.onDocumentMouseUp));c.hasTouch&&(y(b,"touchstart",function(b){a.onContainerTouchStart(b)}),y(b,"touchmove",function(b){a.onContainerTouchMove(b)}),c.unbindDocumentTouchEnd||(c.unbindDocumentTouchEnd=y(d,"touchend",
a.onDocumentTouchEnd)))},destroy:function(){var a=this;a.unDocMouseMove&&a.unDocMouseMove();this.unbindContainerMouseLeave();c.chartCount||(c.unbindDocumentMouseUp&&(c.unbindDocumentMouseUp=c.unbindDocumentMouseUp()),c.unbindDocumentTouchEnd&&(c.unbindDocumentTouchEnd=c.unbindDocumentTouchEnd()));clearInterval(a.tooltipTimeout);v(a,function(b,d){a[d]=null})}}});M(I,"parts/TouchPointer.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.extend,G=f.pick,z=c.charts,B=c.noop;F(c.Pointer.prototype,
{pinchTranslate:function(c,f,C,B,y,h){this.zoomHor&&this.pinchTranslateDirection(!0,c,f,C,B,y,h);this.zoomVert&&this.pinchTranslateDirection(!1,c,f,C,B,y,h)},pinchTranslateDirection:function(c,f,C,B,y,h,n,q){var g=this.chart,b=c?"x":"y",a=c?"X":"Y",d="chart"+a,e=c?"width":"height",l=g["plot"+(c?"Left":"Top")],v,t,p=q||1,u=g.inverted,k=g.bounds[c?"h":"v"],r=1===f.length,x=f[0][d],A=C[0][d],w=!r&&f[1][d],m=!r&&C[1][d];C=function(){!r&&20<Math.abs(x-w)&&(p=q||Math.abs(A-m)/Math.abs(x-w));t=(l-A)/p+x;
v=g["plot"+(c?"Width":"Height")]/p};C();f=t;if(f<k.min){f=k.min;var K=!0}else f+v>k.max&&(f=k.max-v,K=!0);K?(A-=.8*(A-n[b][0]),r||(m-=.8*(m-n[b][1])),C()):n[b]=[A,m];u||(h[b]=t-l,h[e]=v);h=u?1/p:p;y[e]=v;y[b]=f;B[u?c?"scaleY":"scaleX":"scale"+a]=p;B["translate"+a]=h*l+(A-h*x)},pinch:function(c){var f=this,t=f.chart,z=f.pinchDown,y=c.touches,h=y.length,n=f.lastValidTouch,q=f.hasZoom,g=f.selectionMarker,b={},a=1===h&&(f.inClass(c.target,"highcharts-tracker")&&t.runTrackerClick||f.runChartClick),d={};
1<h&&(f.initiated=!0);q&&f.initiated&&!a&&c.preventDefault();[].map.call(y,function(a){return f.normalize(a)});"touchstart"===c.type?([].forEach.call(y,function(a,b){z[b]={chartX:a.chartX,chartY:a.chartY}}),n.x=[z[0].chartX,z[1]&&z[1].chartX],n.y=[z[0].chartY,z[1]&&z[1].chartY],t.axes.forEach(function(a){if(a.zoomEnabled){var b=t.bounds[a.horiz?"h":"v"],d=a.minPixelPadding,e=a.toPixels(Math.min(G(a.options.min,a.dataMin),a.dataMin)),c=a.toPixels(Math.max(G(a.options.max,a.dataMax),a.dataMax)),g=Math.max(e,
c);b.min=Math.min(a.pos,Math.min(e,c)-d);b.max=Math.max(a.pos+a.len,g+d)}}),f.res=!0):f.followTouchMove&&1===h?this.runPointActions(f.normalize(c)):z.length&&(g||(f.selectionMarker=g=F({destroy:B,touch:!0},t.plotBox)),f.pinchTranslate(z,y,b,g,d,n),f.hasPinched=q,f.scaleGroups(b,d),f.res&&(f.res=!1,this.reset(!1,0)))},touch:function(f,v){var t=this.chart,z;if(t.index!==c.hoverChartIndex)this.onContainerMouseLeave({relatedTarget:!0});c.hoverChartIndex=t.index;if(1===f.touches.length)if(f=this.normalize(f),
(z=t.isInsidePlot(f.chartX-t.plotLeft,f.chartY-t.plotTop))&&!t.openMenu){v&&this.runPointActions(f);if("touchmove"===f.type){v=this.pinchDown;var y=v[0]?4<=Math.sqrt(Math.pow(v[0].chartX-f.chartX,2)+Math.pow(v[0].chartY-f.chartY,2)):!1}G(y,!0)&&this.pinch(f)}else v&&this.reset();else 2===f.touches.length&&this.pinch(f)},onContainerTouchStart:function(c){this.zoomOption(c);this.touch(c,!0)},onContainerTouchMove:function(c){this.touch(c)},onDocumentTouchEnd:function(f){z[c.hoverChartIndex]&&z[c.hoverChartIndex].pointer.drop(f)}})});
M(I,"parts/MSPointer.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.extend,G=f.objectEach,z=c.addEvent,B=c.charts,t=c.css,v=c.doc,C=c.noop;f=c.Pointer;var H=c.removeEvent,y=c.win,h=c.wrap;if(!c.hasTouch&&(y.PointerEvent||y.MSPointerEvent)){var n={},q=!!y.PointerEvent,g=function(){var a=[];a.item=function(a){return this[a]};G(n,function(b){a.push({pageX:b.pageX,pageY:b.pageY,target:b.target})});return a},b=function(a,b,e,l){"touch"!==a.pointerType&&a.pointerType!==a.MSPOINTER_TYPE_TOUCH||
!B[c.hoverChartIndex]||(l(a),l=B[c.hoverChartIndex].pointer,l[b]({type:e,target:a.currentTarget,preventDefault:C,touches:g()}))};F(f.prototype,{onContainerPointerDown:function(a){b(a,"onContainerTouchStart","touchstart",function(a){n[a.pointerId]={pageX:a.pageX,pageY:a.pageY,target:a.currentTarget}})},onContainerPointerMove:function(a){b(a,"onContainerTouchMove","touchmove",function(a){n[a.pointerId]={pageX:a.pageX,pageY:a.pageY};n[a.pointerId].target||(n[a.pointerId].target=a.currentTarget)})},onDocumentPointerUp:function(a){b(a,
"onDocumentTouchEnd","touchend",function(a){delete n[a.pointerId]})},batchMSEvents:function(a){a(this.chart.container,q?"pointerdown":"MSPointerDown",this.onContainerPointerDown);a(this.chart.container,q?"pointermove":"MSPointerMove",this.onContainerPointerMove);a(v,q?"pointerup":"MSPointerUp",this.onDocumentPointerUp)}});h(f.prototype,"init",function(a,b,e){a.call(this,b,e);this.hasZoom&&t(b.container,{"-ms-touch-action":"none","touch-action":"none"})});h(f.prototype,"setDOMEvents",function(a){a.apply(this);
(this.hasZoom||this.followTouchMove)&&this.batchMSEvents(z)});h(f.prototype,"destroy",function(a){this.batchMSEvents(H);a.call(this)})}});M(I,"parts/Legend.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.discardElement,z=f.isNumber,B=f.pick,t=f.setAnimation,v=c.addEvent,C=c.css,H=c.fireEvent;f=c.isFirefox;var y=c.marginNames,h=c.merge,n=c.stableSort,q=c.win,g=c.wrap;c.Legend=function(b,a){this.init(b,a)};c.Legend.prototype={init:function(b,a){this.chart=b;this.setOptions(a);
a.enabled&&(this.render(),v(this.chart,"endResize",function(){this.legend.positionCheckboxes()}),this.proximate?this.unchartrender=v(this.chart,"render",function(){this.legend.proximatePositions();this.legend.positionItems()}):this.unchartrender&&this.unchartrender())},setOptions:function(b){var a=B(b.padding,8);this.options=b;this.chart.styledMode||(this.itemStyle=b.itemStyle,this.itemHiddenStyle=h(this.itemStyle,b.itemHiddenStyle));this.itemMarginTop=b.itemMarginTop||0;this.itemMarginBottom=b.itemMarginBottom||
0;this.padding=a;this.initialItemY=a-5;this.symbolWidth=B(b.symbolWidth,16);this.pages=[];this.proximate="proximate"===b.layout&&!this.chart.inverted},update:function(b,a){var d=this.chart;this.setOptions(h(!0,this.options,b));this.destroy();d.isDirtyLegend=d.isDirtyBox=!0;B(a,!0)&&d.redraw();H(this,"afterUpdate")},colorizeItem:function(b,a){b.legendGroup[a?"removeClass":"addClass"]("highcharts-legend-item-hidden");if(!this.chart.styledMode){var d=this.options,e=b.legendItem,c=b.legendLine,g=b.legendSymbol,
h=this.itemHiddenStyle.color;d=a?d.itemStyle.color:h;var f=a?b.color||h:h,u=b.options&&b.options.marker,k={fill:f};e&&e.css({fill:d,color:d});c&&c.attr({stroke:f});g&&(u&&g.isMarker&&(k=b.pointAttribs(),a||(k.stroke=k.fill=h)),g.attr(k))}H(this,"afterColorizeItem",{item:b,visible:a})},positionItems:function(){this.allItems.forEach(this.positionItem,this);this.chart.isResizing||this.positionCheckboxes()},positionItem:function(b){var a=this.options,d=a.symbolPadding;a=!a.rtl;var e=b._legendItemPos,
c=e[0];e=e[1];var g=b.checkbox;if((b=b.legendGroup)&&b.element)b[F(b.translateY)?"animate":"attr"]({translateX:a?c:this.legendWidth-c-2*d-4,translateY:e});g&&(g.x=c,g.y=e)},destroyItem:function(b){var a=b.checkbox;["legendItem","legendLine","legendSymbol","legendGroup"].forEach(function(a){b[a]&&(b[a]=b[a].destroy())});a&&G(b.checkbox)},destroy:function(){function b(a){this[a]&&(this[a]=this[a].destroy())}this.getAllItems().forEach(function(a){["legendItem","legendGroup"].forEach(b,a)});"clipRect up down pager nav box title group".split(" ").forEach(b,
this);this.display=null},positionCheckboxes:function(){var b=this.group&&this.group.alignAttr,a=this.clipHeight||this.legendHeight,d=this.titleHeight;if(b){var e=b.translateY;this.allItems.forEach(function(c){var g=c.checkbox;if(g){var l=e+d+g.y+(this.scrollOffset||0)+3;C(g,{left:b.translateX+c.checkboxOffset+g.x-20+"px",top:l+"px",display:this.proximate||l>e-6&&l<e+a-6?"":"none"})}},this)}},renderTitle:function(){var b=this.options,a=this.padding,d=b.title,e=0;d.text&&(this.title||(this.title=this.chart.renderer.label(d.text,
a-3,a-4,null,null,null,b.useHTML,null,"legend-title").attr({zIndex:1}),this.chart.styledMode||this.title.css(d.style),this.title.add(this.group)),d.width||this.title.css({width:this.maxLegendWidth+"px"}),b=this.title.getBBox(),e=b.height,this.offsetWidth=b.width,this.contentGroup.attr({translateY:e}));this.titleHeight=e},setText:function(b){var a=this.options;b.legendItem.attr({text:a.labelFormat?c.format(a.labelFormat,b,this.chart.time):a.labelFormatter.call(b)})},renderItem:function(b){var a=this.chart,
d=a.renderer,e=this.options,c=this.symbolWidth,g=e.symbolPadding,f=this.itemStyle,p=this.itemHiddenStyle,u="horizontal"===e.layout?B(e.itemDistance,20):0,k=!e.rtl,r=b.legendItem,x=!b.series,A=!x&&b.series.drawLegendSymbol?b.series:b,w=A.options;w=this.createCheckboxForItem&&w&&w.showCheckbox;u=c+g+u+(w?20:0);var m=e.useHTML,n=b.options.className;r||(b.legendGroup=d.g("legend-item").addClass("highcharts-"+A.type+"-series highcharts-color-"+b.colorIndex+(n?" "+n:"")+(x?" highcharts-series-"+b.index:
"")).attr({zIndex:1}).add(this.scrollGroup),b.legendItem=r=d.text("",k?c+g:-g,this.baseline||0,m),a.styledMode||r.css(h(b.visible?f:p)),r.attr({align:k?"left":"right",zIndex:2}).add(b.legendGroup),this.baseline||(this.fontMetrics=d.fontMetrics(a.styledMode?12:f.fontSize,r),this.baseline=this.fontMetrics.f+3+this.itemMarginTop,r.attr("y",this.baseline)),this.symbolHeight=e.symbolHeight||this.fontMetrics.f,A.drawLegendSymbol(this,b),this.setItemEvents&&this.setItemEvents(b,r,m));w&&!b.checkbox&&this.createCheckboxForItem(b);
this.colorizeItem(b,b.visible);!a.styledMode&&f.width||r.css({width:(e.itemWidth||this.widthOption||a.spacingBox.width)-u});this.setText(b);a=r.getBBox();b.itemWidth=b.checkboxOffset=e.itemWidth||b.legendItemWidth||a.width+u;this.maxItemWidth=Math.max(this.maxItemWidth,b.itemWidth);this.totalItemWidth+=b.itemWidth;this.itemHeight=b.itemHeight=Math.round(b.legendItemHeight||a.height||this.symbolHeight)},layoutItem:function(b){var a=this.options,d=this.padding,e="horizontal"===a.layout,c=b.itemHeight,
g=this.itemMarginBottom,h=this.itemMarginTop,f=e?B(a.itemDistance,20):0,u=this.maxLegendWidth;a=a.alignColumns&&this.totalItemWidth>u?this.maxItemWidth:b.itemWidth;e&&this.itemX-d+a>u&&(this.itemX=d,this.lastLineHeight&&(this.itemY+=h+this.lastLineHeight+g),this.lastLineHeight=0);this.lastItemY=h+this.itemY+g;this.lastLineHeight=Math.max(c,this.lastLineHeight);b._legendItemPos=[this.itemX,this.itemY];e?this.itemX+=a:(this.itemY+=h+c+g,this.lastLineHeight=c);this.offsetWidth=this.widthOption||Math.max((e?
this.itemX-d-(b.checkbox?0:f):a)+d,this.offsetWidth)},getAllItems:function(){var b=[];this.chart.series.forEach(function(a){var d=a&&a.options;a&&B(d.showInLegend,F(d.linkedTo)?!1:void 0,!0)&&(b=b.concat(a.legendItems||("point"===d.legendType?a.data:a)))});H(this,"afterGetAllItems",{allItems:b});return b},getAlignment:function(){var b=this.options;return this.proximate?b.align.charAt(0)+"tv":b.floating?"":b.align.charAt(0)+b.verticalAlign.charAt(0)+b.layout.charAt(0)},adjustMargins:function(b,a){var d=
this.chart,e=this.options,c=this.getAlignment();c&&[/(lth|ct|rth)/,/(rtv|rm|rbv)/,/(rbh|cb|lbh)/,/(lbv|lm|ltv)/].forEach(function(g,l){g.test(c)&&!F(b[l])&&(d[y[l]]=Math.max(d[y[l]],d.legend[(l+1)%2?"legendHeight":"legendWidth"]+[1,-1,-1,1][l]*e[l%2?"x":"y"]+B(e.margin,12)+a[l]+(d.titleOffset[l]||0)))})},proximatePositions:function(){var b=this.chart,a=[],d="left"===this.options.align;this.allItems.forEach(function(e){var g=d;if(e.yAxis&&e.points){e.xAxis.options.reversed&&(g=!g);var h=c.find(g?e.points:
e.points.slice(0).reverse(),function(a){return z(a.plotY)});g=this.itemMarginTop+e.legendItem.getBBox().height+this.itemMarginBottom;var f=e.yAxis.top-b.plotTop;e.visible?(h=h?h.plotY:e.yAxis.height,h+=f-.3*g):h=f+e.yAxis.height;a.push({target:h,size:g,item:e})}},this);c.distribute(a,b.plotHeight);a.forEach(function(a){a.item._legendItemPos[1]=b.plotTop-b.spacing[0]+a.pos})},render:function(){var b=this.chart,a=b.renderer,d=this.group,e,g=this.box,f=this.options,q=this.padding;this.itemX=q;this.itemY=
this.initialItemY;this.lastItemY=this.offsetWidth=0;this.widthOption=c.relativeLength(f.width,b.spacingBox.width-q);var p=b.spacingBox.width-2*q-f.x;-1<["rm","lm"].indexOf(this.getAlignment().substring(0,2))&&(p/=2);this.maxLegendWidth=this.widthOption||p;d||(this.group=d=a.g("legend").attr({zIndex:7}).add(),this.contentGroup=a.g().attr({zIndex:1}).add(d),this.scrollGroup=a.g().add(this.contentGroup));this.renderTitle();p=this.getAllItems();n(p,function(a,b){return(a.options&&a.options.legendIndex||
0)-(b.options&&b.options.legendIndex||0)});f.reversed&&p.reverse();this.allItems=p;this.display=e=!!p.length;this.itemHeight=this.totalItemWidth=this.maxItemWidth=this.lastLineHeight=0;p.forEach(this.renderItem,this);p.forEach(this.layoutItem,this);p=(this.widthOption||this.offsetWidth)+q;var u=this.lastItemY+this.lastLineHeight+this.titleHeight;u=this.handleOverflow(u);u+=q;g||(this.box=g=a.rect().addClass("highcharts-legend-box").attr({r:f.borderRadius}).add(d),g.isNew=!0);b.styledMode||g.attr({stroke:f.borderColor,
"stroke-width":f.borderWidth||0,fill:f.backgroundColor||"none"}).shadow(f.shadow);0<p&&0<u&&(g[g.isNew?"attr":"animate"](g.crisp.call({},{x:0,y:0,width:p,height:u},g.strokeWidth())),g.isNew=!1);g[e?"show":"hide"]();b.styledMode&&"none"===d.getStyle("display")&&(p=u=0);this.legendWidth=p;this.legendHeight=u;e&&(a=b.spacingBox,g=a.y,/(lth|ct|rth)/.test(this.getAlignment())&&0<b.titleOffset[0]?g+=b.titleOffset[0]:/(lbh|cb|rbh)/.test(this.getAlignment())&&0<b.titleOffset[2]&&(g-=b.titleOffset[2]),g!==
a.y&&(a=h(a,{y:g})),d.align(h(f,{width:p,height:u,verticalAlign:this.proximate?"top":f.verticalAlign}),!0,a));this.proximate||this.positionItems();H(this,"afterRender")},handleOverflow:function(b){var a=this,d=this.chart,e=d.renderer,c=this.options,g=c.y,h=this.padding;g=d.spacingBox.height+("top"===c.verticalAlign?-g:g)-h;var f=c.maxHeight,u,k=this.clipRect,r=c.navigation,x=B(r.animation,!0),A=r.arrowSize||12,w=this.nav,m=this.pages,n,J=this.allItems,q=function(b){"number"===typeof b?k.attr({height:b}):
k&&(a.clipRect=k.destroy(),a.contentGroup.clip());a.contentGroup.div&&(a.contentGroup.div.style.clip=b?"rect("+h+"px,9999px,"+(h+b)+"px,0)":"auto")},v=function(b){a[b]=e.circle(0,0,1.3*A).translate(A/2,A/2).add(w);d.styledMode||a[b].attr("fill","rgba(0,0,0,0.0001)");return a[b]};"horizontal"!==c.layout||"middle"===c.verticalAlign||c.floating||(g/=2);f&&(g=Math.min(g,f));m.length=0;b>g&&!1!==r.enabled?(this.clipHeight=u=Math.max(g-20-this.titleHeight-h,0),this.currentPage=B(this.currentPage,1),this.fullHeight=
b,J.forEach(function(a,b){var d=a._legendItemPos[1],e=Math.round(a.legendItem.getBBox().height),c=m.length;if(!c||d-m[c-1]>u&&(n||d)!==m[c-1])m.push(n||d),c++;a.pageIx=c-1;n&&(J[b-1].pageIx=c-1);b===J.length-1&&d+e-m[c-1]>u&&d!==n&&(m.push(d),a.pageIx=c);d!==n&&(n=d)}),k||(k=a.clipRect=e.clipRect(0,h,9999,0),a.contentGroup.clip(k)),q(u),w||(this.nav=w=e.g().attr({zIndex:1}).add(this.group),this.up=e.symbol("triangle",0,0,A,A).add(w),v("upTracker").on("click",function(){a.scroll(-1,x)}),this.pager=
e.text("",15,10).addClass("highcharts-legend-navigation"),d.styledMode||this.pager.css(r.style),this.pager.add(w),this.down=e.symbol("triangle-down",0,0,A,A).add(w),v("downTracker").on("click",function(){a.scroll(1,x)})),a.scroll(0),b=g):w&&(q(),this.nav=w.destroy(),this.scrollGroup.attr({translateY:1}),this.clipHeight=0);return b},scroll:function(b,a){var d=this.pages,e=d.length,c=this.currentPage+b;b=this.clipHeight;var g=this.options.navigation,h=this.pager,f=this.padding;c>e&&(c=e);0<c&&(void 0!==
a&&t(a,this.chart),this.nav.attr({translateX:f,translateY:b+this.padding+7+this.titleHeight,visibility:"visible"}),[this.up,this.upTracker].forEach(function(a){a.attr({"class":1===c?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})}),h.attr({text:c+"/"+e}),[this.down,this.downTracker].forEach(function(a){a.attr({x:18+this.pager.getBBox().width,"class":c===e?"highcharts-legend-nav-inactive":"highcharts-legend-nav-active"})},this),this.chart.styledMode||(this.up.attr({fill:1===c?g.inactiveColor:
g.activeColor}),this.upTracker.css({cursor:1===c?"default":"pointer"}),this.down.attr({fill:c===e?g.inactiveColor:g.activeColor}),this.downTracker.css({cursor:c===e?"default":"pointer"})),this.scrollOffset=-d[c-1]+this.initialItemY,this.scrollGroup.animate({translateY:this.scrollOffset}),this.currentPage=c,this.positionCheckboxes())}};c.LegendSymbolMixin={drawRectangle:function(b,a){var d=b.symbolHeight,e=b.options.squareSymbol;a.legendSymbol=this.chart.renderer.rect(e?(b.symbolWidth-d)/2:0,b.baseline-
d+1,e?d:b.symbolWidth,d,B(b.options.symbolRadius,d/2)).addClass("highcharts-point").attr({zIndex:3}).add(a.legendGroup)},drawLineMarker:function(b){var a=this.options,d=a.marker,e=b.symbolWidth,c=b.symbolHeight,g=c/2,f=this.chart.renderer,p=this.legendGroup;b=b.baseline-Math.round(.3*b.fontMetrics.b);var u={};this.chart.styledMode||(u={"stroke-width":a.lineWidth||0},a.dashStyle&&(u.dashstyle=a.dashStyle));this.legendLine=f.path(["M",0,b,"L",e,b]).addClass("highcharts-graph").attr(u).add(p);d&&!1!==
d.enabled&&e&&(a=Math.min(B(d.radius,g),g),0===this.symbol.indexOf("url")&&(d=h(d,{width:c,height:c}),a=0),this.legendSymbol=d=f.symbol(this.symbol,e/2-a,b-a,2*a,2*a,d).addClass("highcharts-point").add(p),d.isMarker=!0)}};(/Trident\/7\.0/.test(q.navigator&&q.navigator.userAgent)||f)&&g(c.Legend.prototype,"positionItem",function(b,a){var d=this,e=function(){a._legendItemPos&&b.call(d,a)};e();d.bubbleLegend||setTimeout(e)})});M(I,"parts/Chart.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,
f){var F=f.attr,G=f.defined,z=f.discardElement,B=f.erase,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isObject,y=f.isString,h=f.objectEach,n=f.pick,q=f.pInt,g=f.setAnimation,b=f.splat,a=f.syncTimeout,d=c.addEvent,e=c.animate,l=c.animObject,L=c.doc,E=c.Axis,p=c.createElement,u=c.defaultOptions,k=c.charts,r=c.css,x=c.find,A=c.fireEvent,w=c.Legend,m=c.marginNames,K=c.merge,J=c.Pointer,U=c.removeEvent,S=c.seriesTypes,Q=c.win,O=c.Chart=function(){this.getArgs.apply(this,arguments)};c.chart=function(a,b,d){return new O(a,
b,d)};t(O.prototype,{callbacks:[],getArgs:function(){var a=[].slice.call(arguments);if(y(a[0])||a[0].nodeName)this.renderTo=a.shift();this.init(a[0],a[1])},init:function(a,b){var e,g=a.series,m=a.plotOptions||{};A(this,"init",{args:arguments},function(){a.series=null;e=K(u,a);h(e.plotOptions,function(a,b){H(a)&&(a.tooltip=m[b]&&K(m[b].tooltip)||void 0)});e.tooltip.userOptions=a.chart&&a.chart.forExport&&a.tooltip.userOptions||a.tooltip;e.series=a.series=g;this.userOptions=a;var r=e.chart,l=r.events;
this.margin=[];this.spacing=[];this.bounds={h:{},v:{}};this.labelCollectors=[];this.callback=b;this.isResizing=0;this.options=e;this.axes=[];this.series=[];this.time=a.time&&Object.keys(a.time).length?new c.Time(a.time):c.time;this.styledMode=r.styledMode;this.hasCartesianSeries=r.showAxes;var f=this;f.index=k.length;k.push(f);c.chartCount++;l&&h(l,function(a,b){c.isFunction(a)&&d(f,b,a)});f.xAxis=[];f.yAxis=[];f.pointCount=f.colorCounter=f.symbolCounter=0;A(f,"afterInit");f.firstRender()})},initSeries:function(a){var b=
this.options.chart;b=a.type||b.type||b.defaultSeriesType;var d=S[b];d||c.error(17,!0,this,{missingModuleFor:b});b=new d;b.init(this,a);return b},orderSeries:function(a){var b=this.series;for(a=a||0;a<b.length;a++)b[a]&&(b[a].index=a,b[a].name=b[a].getName())},isInsidePlot:function(a,b,d){var e=d?b:a;a=d?a:b;return 0<=e&&e<=this.plotWidth&&0<=a&&a<=this.plotHeight},redraw:function(a){A(this,"beforeRedraw");var b=this.axes,d=this.series,e=this.pointer,c=this.legend,k=this.userOptions.legend,m=this.isDirtyLegend,
r=this.hasCartesianSeries,h=this.isDirtyBox,l=this.renderer,f=l.isHidden(),x=[];this.setResponsive&&this.setResponsive(!1);g(a,this);f&&this.temporaryDisplay();this.layOutTitles();for(a=d.length;a--;){var w=d[a];if(w.options.stacking){var p=!0;if(w.isDirty){var u=!0;break}}}if(u)for(a=d.length;a--;)w=d[a],w.options.stacking&&(w.isDirty=!0);d.forEach(function(a){a.isDirty&&("point"===a.options.legendType?(a.updateTotals&&a.updateTotals(),m=!0):k&&(k.labelFormatter||k.labelFormat)&&(m=!0));a.isDirtyData&&
A(a,"updatedData")});m&&c&&c.options.enabled&&(c.render(),this.isDirtyLegend=!1);p&&this.getStacks();r&&b.forEach(function(a){a.updateNames();a.setScale()});this.getMargins();r&&(b.forEach(function(a){a.isDirty&&(h=!0)}),b.forEach(function(a){var b=a.min+","+a.max;a.extKey!==b&&(a.extKey=b,x.push(function(){A(a,"afterSetExtremes",t(a.eventArgs,a.getExtremes()));delete a.eventArgs}));(h||p)&&a.redraw()}));h&&this.drawChartBox();A(this,"predraw");d.forEach(function(a){(h||a.isDirty)&&a.visible&&a.redraw();
a.isDirtyData=!1});e&&e.reset(!0);l.draw();A(this,"redraw");A(this,"render");f&&this.temporaryDisplay(!0);x.forEach(function(a){a.call()})},get:function(a){function b(b){return b.id===a||b.options&&b.options.id===a}var d=this.series,e;var c=x(this.axes,b)||x(this.series,b);for(e=0;!c&&e<d.length;e++)c=x(d[e].points||[],b);return c},getAxes:function(){var a=this,d=this.options,e=d.xAxis=b(d.xAxis||{});d=d.yAxis=b(d.yAxis||{});A(this,"getAxes");e.forEach(function(a,b){a.index=b;a.isX=!0});d.forEach(function(a,
b){a.index=b});e.concat(d).forEach(function(b){new E(a,b)});A(this,"afterGetAxes")},getSelectedPoints:function(){var a=[];this.series.forEach(function(b){a=a.concat((b[b.hasGroupedData?"points":"data"]||[]).filter(function(a){return n(a.selectedStaging,a.selected)}))});return a},getSelectedSeries:function(){return this.series.filter(function(a){return a.selected})},setTitle:function(a,b,d){this.applyDescription("title",a);this.applyDescription("subtitle",b);this.applyDescription("caption",void 0);
this.layOutTitles(d)},applyDescription:function(a,b){var d=this,e="title"===a?{color:"#333333",fontSize:this.options.isStock?"16px":"18px"}:{color:"#666666"};e=this.options[a]=K(!this.styledMode&&{style:e},this.options[a],b);var c=this[a];c&&b&&(this[a]=c=c.destroy());e&&!c&&(c=this.renderer.text(e.text,0,0,e.useHTML).attr({align:e.align,"class":"highcharts-"+a,zIndex:e.zIndex||4}).add(),c.update=function(b){d[{title:"setTitle",subtitle:"setSubtitle",caption:"setCaption"}[a]](b)},this.styledMode||
c.css(e.style),this[a]=c)},layOutTitles:function(a){var b=[0,0,0],d=this.renderer,e=this.spacingBox;["title","subtitle","caption"].forEach(function(a){var c=this[a],k=this.options[a],g=k.verticalAlign||"top";a="title"===a?-3:"top"===g?b[0]+2:0;if(c){if(!this.styledMode)var m=k.style.fontSize;m=d.fontMetrics(m,c).b;c.css({width:(k.width||e.width+(k.widthAdjust||0))+"px"});var r=Math.round(c.getBBox(k.useHTML).height);c.align(t({y:"bottom"===g?m:a+m,height:r},k),!1,"spacingBox");k.floating||("top"===
g?b[0]=Math.ceil(b[0]+r):"bottom"===g&&(b[2]=Math.ceil(b[2]+r)))}},this);b[0]&&"top"===(this.options.title.verticalAlign||"top")&&(b[0]+=this.options.title.margin);b[2]&&"bottom"===this.options.caption.verticalAlign&&(b[2]+=this.options.caption.margin);var c=!this.titleOffset||this.titleOffset.join(",")!==b.join(",");this.titleOffset=b;A(this,"afterLayOutTitles");!this.isDirtyBox&&c&&(this.isDirtyBox=this.isDirtyLegend=c,this.hasRendered&&n(a,!0)&&this.isDirtyBox&&this.redraw())},getChartSize:function(){var a=
this.options.chart,b=a.width;a=a.height;var d=this.renderTo;G(b)||(this.containerWidth=c.getStyle(d,"width"));G(a)||(this.containerHeight=c.getStyle(d,"height"));this.chartWidth=Math.max(0,b||this.containerWidth||600);this.chartHeight=Math.max(0,c.relativeLength(a,this.chartWidth)||(1<this.containerHeight?this.containerHeight:400))},temporaryDisplay:function(a){var b=this.renderTo;if(a)for(;b&&b.style;)b.hcOrigStyle&&(c.css(b,b.hcOrigStyle),delete b.hcOrigStyle),b.hcOrigDetached&&(L.body.removeChild(b),
b.hcOrigDetached=!1),b=b.parentNode;else for(;b&&b.style;){L.body.contains(b)||b.parentNode||(b.hcOrigDetached=!0,L.body.appendChild(b));if("none"===c.getStyle(b,"display",!1)||b.hcOricDetached)b.hcOrigStyle={display:b.style.display,height:b.style.height,overflow:b.style.overflow},a={display:"block",overflow:"hidden"},b!==this.renderTo&&(a.height=0),c.css(b,a),b.offsetWidth||b.style.setProperty("display","block","important");b=b.parentNode;if(b===L.body)break}},setClassName:function(a){this.container.className=
"highcharts-container "+(a||"")},getContainer:function(){var a=this.options,b=a.chart;var d=this.renderTo;var e=c.uniqueKey(),g,m;d||(this.renderTo=d=b.renderTo);y(d)&&(this.renderTo=d=L.getElementById(d));d||c.error(13,!0,this);var h=q(F(d,"data-highcharts-chart"));C(h)&&k[h]&&k[h].hasRendered&&k[h].destroy();F(d,"data-highcharts-chart",this.index);d.innerHTML="";b.skipClone||d.offsetWidth||this.temporaryDisplay();this.getChartSize();h=this.chartWidth;var l=this.chartHeight;r(d,{overflow:"hidden"});
this.styledMode||(g=t({position:"relative",overflow:"hidden",width:h+"px",height:l+"px",textAlign:"left",lineHeight:"normal",zIndex:0,"-webkit-tap-highlight-color":"rgba(0,0,0,0)"},b.style));this.container=d=p("div",{id:e},g,d);this._cursor=d.style.cursor;this.renderer=new (c[b.renderer]||c.Renderer)(d,h,l,null,b.forExport,a.exporting&&a.exporting.allowHTML,this.styledMode);this.setClassName(b.className);if(this.styledMode)for(m in a.defs)this.renderer.definition(a.defs[m]);else this.renderer.setStyle(b.style);
this.renderer.chartIndex=this.index;A(this,"afterGetContainer")},getMargins:function(a){var b=this.spacing,d=this.margin,e=this.titleOffset;this.resetMargins();e[0]&&!G(d[0])&&(this.plotTop=Math.max(this.plotTop,e[0]+b[0]));e[2]&&!G(d[2])&&(this.marginBottom=Math.max(this.marginBottom,e[2]+b[2]));this.legend&&this.legend.display&&this.legend.adjustMargins(d,b);A(this,"getMargins");a||this.getAxisMargins()},getAxisMargins:function(){var a=this,b=a.axisOffset=[0,0,0,0],d=a.colorAxis,e=a.margin,c=function(a){a.forEach(function(a){a.visible&&
a.getOffset()})};a.hasCartesianSeries?c(a.axes):d&&d.length&&c(d);m.forEach(function(d,c){G(e[c])||(a[d]+=b[c])});a.setChartSize()},reflow:function(b){var d=this,e=d.options.chart,k=d.renderTo,g=G(e.width)&&G(e.height),m=e.width||c.getStyle(k,"width");e=e.height||c.getStyle(k,"height");k=b?b.target:Q;if(!g&&!d.isPrinting&&m&&e&&(k===Q||k===L)){if(m!==d.containerWidth||e!==d.containerHeight)c.clearTimeout(d.reflowTimeout),d.reflowTimeout=a(function(){d.container&&d.setSize(void 0,void 0,!1)},b?100:
0);d.containerWidth=m;d.containerHeight=e}},setReflow:function(a){var b=this;!1===a||this.unbindReflow?!1===a&&this.unbindReflow&&(this.unbindReflow=this.unbindReflow()):(this.unbindReflow=d(Q,"resize",function(a){b.options&&b.reflow(a)}),d(this,"destroy",this.unbindReflow))},setSize:function(b,d,c){var k=this,m=k.renderer;k.isResizing+=1;g(c,k);k.oldChartHeight=k.chartHeight;k.oldChartWidth=k.chartWidth;void 0!==b&&(k.options.chart.width=b);void 0!==d&&(k.options.chart.height=d);k.getChartSize();
if(!k.styledMode){var h=m.globalAnimation;(h?e:r)(k.container,{width:k.chartWidth+"px",height:k.chartHeight+"px"},h)}k.setChartSize(!0);m.setSize(k.chartWidth,k.chartHeight,c);k.axes.forEach(function(a){a.isDirty=!0;a.setScale()});k.isDirtyLegend=!0;k.isDirtyBox=!0;k.layOutTitles();k.getMargins();k.redraw(c);k.oldChartHeight=null;A(k,"resize");a(function(){k&&A(k,"endResize",null,function(){--k.isResizing})},l(h).duration||0)},setChartSize:function(a){var b=this.inverted,d=this.renderer,e=this.chartWidth,
c=this.chartHeight,k=this.options.chart,g=this.spacing,m=this.clipOffset,r,h,l,f;this.plotLeft=r=Math.round(this.plotLeft);this.plotTop=h=Math.round(this.plotTop);this.plotWidth=l=Math.max(0,Math.round(e-r-this.marginRight));this.plotHeight=f=Math.max(0,Math.round(c-h-this.marginBottom));this.plotSizeX=b?f:l;this.plotSizeY=b?l:f;this.plotBorderWidth=k.plotBorderWidth||0;this.spacingBox=d.spacingBox={x:g[3],y:g[0],width:e-g[3]-g[1],height:c-g[0]-g[2]};this.plotBox=d.plotBox={x:r,y:h,width:l,height:f};
e=2*Math.floor(this.plotBorderWidth/2);b=Math.ceil(Math.max(e,m[3])/2);d=Math.ceil(Math.max(e,m[0])/2);this.clipBox={x:b,y:d,width:Math.floor(this.plotSizeX-Math.max(e,m[1])/2-b),height:Math.max(0,Math.floor(this.plotSizeY-Math.max(e,m[2])/2-d))};a||this.axes.forEach(function(a){a.setAxisSize();a.setAxisTranslation()});A(this,"afterSetChartSize",{skipAxes:a})},resetMargins:function(){A(this,"resetMargins");var a=this,b=a.options.chart;["margin","spacing"].forEach(function(d){var e=b[d],c=H(e)?e:[e,
e,e,e];["Top","Right","Bottom","Left"].forEach(function(e,k){a[d][k]=n(b[d+e],c[k])})});m.forEach(function(b,d){a[b]=n(a.margin[d],a.spacing[d])});a.axisOffset=[0,0,0,0];a.clipOffset=[0,0,0,0]},drawChartBox:function(){var a=this.options.chart,b=this.renderer,d=this.chartWidth,e=this.chartHeight,c=this.chartBackground,k=this.plotBackground,g=this.plotBorder,m=this.styledMode,r=this.plotBGImage,h=a.backgroundColor,l=a.plotBackgroundColor,f=a.plotBackgroundImage,x,w=this.plotLeft,p=this.plotTop,u=this.plotWidth,
n=this.plotHeight,J=this.plotBox,K=this.clipRect,q=this.clipBox,v="animate";c||(this.chartBackground=c=b.rect().addClass("highcharts-background").add(),v="attr");if(m)var y=x=c.strokeWidth();else{y=a.borderWidth||0;x=y+(a.shadow?8:0);h={fill:h||"none"};if(y||c["stroke-width"])h.stroke=a.borderColor,h["stroke-width"]=y;c.attr(h).shadow(a.shadow)}c[v]({x:x/2,y:x/2,width:d-x-y%2,height:e-x-y%2,r:a.borderRadius});v="animate";k||(v="attr",this.plotBackground=k=b.rect().addClass("highcharts-plot-background").add());
k[v](J);m||(k.attr({fill:l||"none"}).shadow(a.plotShadow),f&&(r?r.animate(J):this.plotBGImage=b.image(f,w,p,u,n).add()));K?K.animate({width:q.width,height:q.height}):this.clipRect=b.clipRect(q);v="animate";g||(v="attr",this.plotBorder=g=b.rect().addClass("highcharts-plot-border").attr({zIndex:1}).add());m||g.attr({stroke:a.plotBorderColor,"stroke-width":a.plotBorderWidth||0,fill:"none"});g[v](g.crisp({x:w,y:p,width:u,height:n},-g.strokeWidth()));this.isDirtyBox=!1;A(this,"afterDrawChartBox")},propFromSeries:function(){var a=
this,b=a.options.chart,d,e=a.options.series,c,k;["inverted","angular","polar"].forEach(function(g){d=S[b.type||b.defaultSeriesType];k=b[g]||d&&d.prototype[g];for(c=e&&e.length;!k&&c--;)(d=S[e[c].type])&&d.prototype[g]&&(k=!0);a[g]=k})},linkSeries:function(){var a=this,b=a.series;b.forEach(function(a){a.linkedSeries.length=0});b.forEach(function(b){var d=b.options.linkedTo;y(d)&&(d=":previous"===d?a.series[b.index-1]:a.get(d))&&d.linkedParent!==b&&(d.linkedSeries.push(b),b.linkedParent=d,b.visible=
n(b.options.visible,d.options.visible,b.visible))});A(this,"afterLinkSeries")},renderSeries:function(){this.series.forEach(function(a){a.translate();a.render()})},renderLabels:function(){var a=this,b=a.options.labels;b.items&&b.items.forEach(function(d){var e=t(b.style,d.style),c=q(e.left)+a.plotLeft,k=q(e.top)+a.plotTop+12;delete e.left;delete e.top;a.renderer.text(d.html,c,k).attr({zIndex:2}).css(e).add()})},render:function(){var a=this.axes,b=this.colorAxis,d=this.renderer,e=this.options,c=0,k=
function(a){a.forEach(function(a){a.visible&&a.render()})};this.setTitle();this.legend=new w(this,e.legend);this.getStacks&&this.getStacks();this.getMargins(!0);this.setChartSize();e=this.plotWidth;a.some(function(a){if(a.horiz&&a.visible&&a.options.labels.enabled&&a.series.length)return c=21,!0});var g=this.plotHeight=Math.max(this.plotHeight-c,0);a.forEach(function(a){a.setScale()});this.getAxisMargins();var m=1.1<e/this.plotWidth;var r=1.05<g/this.plotHeight;if(m||r)a.forEach(function(a){(a.horiz&&
m||!a.horiz&&r)&&a.setTickInterval(!0)}),this.getMargins();this.drawChartBox();this.hasCartesianSeries?k(a):b&&b.length&&k(b);this.seriesGroup||(this.seriesGroup=d.g("series-group").attr({zIndex:3}).add());this.renderSeries();this.renderLabels();this.addCredits();this.setResponsive&&this.setResponsive();this.updateContainerScaling();this.hasRendered=!0},addCredits:function(a){var b=this;a=K(!0,this.options.credits,a);a.enabled&&!this.credits&&(this.credits=this.renderer.text(a.text+(this.mapCredits||
""),0,0).addClass("highcharts-credits").on("click",function(){a.href&&(Q.location.href=a.href)}).attr({align:a.position.align,zIndex:8}),b.styledMode||this.credits.css(a.style),this.credits.add().align(a.position),this.credits.update=function(a){b.credits=b.credits.destroy();b.addCredits(a)})},updateContainerScaling:function(){var a=this.container;if(a.offsetWidth&&a.offsetHeight&&a.getBoundingClientRect){var b=a.getBoundingClientRect(),d=b.width/a.offsetWidth;a=b.height/a.offsetHeight;1!==d||1!==
a?this.containerScaling={scaleX:d,scaleY:a}:delete this.containerScaling}},destroy:function(){var a=this,b=a.axes,d=a.series,e=a.container,g,m=e&&e.parentNode;A(a,"destroy");a.renderer.forExport?B(k,a):k[a.index]=void 0;c.chartCount--;a.renderTo.removeAttribute("data-highcharts-chart");U(a);for(g=b.length;g--;)b[g]=b[g].destroy();this.scroller&&this.scroller.destroy&&this.scroller.destroy();for(g=d.length;g--;)d[g]=d[g].destroy();"title subtitle chartBackground plotBackground plotBGImage plotBorder seriesGroup clipRect credits pointer rangeSelector legend resetZoomButton tooltip renderer".split(" ").forEach(function(b){var d=
a[b];d&&d.destroy&&(a[b]=d.destroy())});e&&(e.innerHTML="",U(e),m&&z(e));h(a,function(b,d){delete a[d]})},firstRender:function(){var a=this,b=a.options;if(!a.isReadyToRender||a.isReadyToRender()){a.getContainer();a.resetMargins();a.setChartSize();a.propFromSeries();a.getAxes();(v(b.series)?b.series:[]).forEach(function(b){a.initSeries(b)});a.linkSeries();A(a,"beforeRender");J&&(a.pointer=new J(a,b));a.render();if(!a.renderer.imgCount&&a.onload)a.onload();a.temporaryDisplay(!0)}},onload:function(){this.callbacks.concat([this.callback]).forEach(function(a){a&&
void 0!==this.index&&a.apply(this,[this])},this);A(this,"load");A(this,"render");G(this.index)&&this.setReflow(this.options.chart.reflow);this.onload=null}})});M(I,"parts/ScrollablePlotArea.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.pick,G=c.addEvent;f=c.Chart;"";G(f,"afterSetChartSize",function(f){var z=this.options.chart.scrollablePlotArea,t=z&&z.minWidth;z=z&&z.minHeight;if(!this.renderer.forExport){if(t){if(this.scrollablePixelsX=t=Math.max(0,t-this.chartWidth)){this.plotWidth+=
t;this.inverted?(this.clipBox.height+=t,this.plotBox.height+=t):(this.clipBox.width+=t,this.plotBox.width+=t);var v={1:{name:"right",value:t}}}}else z&&(this.scrollablePixelsY=t=Math.max(0,z-this.chartHeight))&&(this.plotHeight+=t,this.inverted?(this.clipBox.width+=t,this.plotBox.width+=t):(this.clipBox.height+=t,this.plotBox.height+=t),v={2:{name:"bottom",value:t}});v&&!f.skipAxes&&this.axes.forEach(function(f){v[f.side]?f.getPlotLinePath=function(){var t=v[f.side].name,y=this[t];this[t]=y-v[f.side].value;
var h=c.Axis.prototype.getPlotLinePath.apply(this,arguments);this[t]=y;return h}:(f.setAxisSize(),f.setAxisTranslation())})}});G(f,"render",function(){this.scrollablePixelsX||this.scrollablePixelsY?(this.setUpScrolling&&this.setUpScrolling(),this.applyFixed()):this.fixedDiv&&this.applyFixed()});f.prototype.setUpScrolling=function(){var f={WebkitOverflowScrolling:"touch",overflowX:"hidden",overflowY:"hidden"};this.scrollablePixelsX&&(f.overflowX="auto");this.scrollablePixelsY&&(f.overflowY="auto");
this.scrollingContainer=c.createElement("div",{className:"highcharts-scrolling"},f,this.renderTo);this.innerContainer=c.createElement("div",{className:"highcharts-inner-container"},null,this.scrollingContainer);this.innerContainer.appendChild(this.container);this.setUpScrolling=null};f.prototype.moveFixedElements=function(){var c=this.container,f=this.fixedRenderer,t=".highcharts-contextbutton .highcharts-credits .highcharts-legend .highcharts-legend-checkbox .highcharts-navigator-series .highcharts-navigator-xaxis .highcharts-navigator-yaxis .highcharts-navigator .highcharts-reset-zoom .highcharts-scrollbar .highcharts-subtitle .highcharts-title".split(" "),
v;this.scrollablePixelsX&&!this.inverted?v=".highcharts-yaxis":this.scrollablePixelsX&&this.inverted?v=".highcharts-xaxis":this.scrollablePixelsY&&!this.inverted?v=".highcharts-xaxis":this.scrollablePixelsY&&this.inverted&&(v=".highcharts-yaxis");t.push(v,v+"-labels");t.forEach(function(v){[].forEach.call(c.querySelectorAll(v),function(c){(c.namespaceURI===f.SVG_NS?f.box:f.box.parentNode).appendChild(c);c.style.pointerEvents="auto"})})};f.prototype.applyFixed=function(){var f,B=!this.fixedDiv,t=this.options.chart.scrollablePlotArea;
B?(this.fixedDiv=c.createElement("div",{className:"highcharts-fixed"},{position:"absolute",overflow:"hidden",pointerEvents:"none",zIndex:2},null,!0),this.renderTo.insertBefore(this.fixedDiv,this.renderTo.firstChild),this.renderTo.style.overflow="visible",this.fixedRenderer=f=new c.Renderer(this.fixedDiv,this.chartWidth,this.chartHeight),this.scrollableMask=f.path().attr({fill:c.color(this.options.chart.backgroundColor||"#fff").setOpacity(F(t.opacity,.85)).get(),zIndex:-1}).addClass("highcharts-scrollable-mask").add(),
this.moveFixedElements(),G(this,"afterShowResetZoom",this.moveFixedElements),G(this,"afterLayOutTitles",this.moveFixedElements)):this.fixedRenderer.setSize(this.chartWidth,this.chartHeight);f=this.chartWidth+(this.scrollablePixelsX||0);var v=this.chartHeight+(this.scrollablePixelsY||0);c.stop(this.container);this.container.style.width=f+"px";this.container.style.height=v+"px";this.renderer.boxWrapper.attr({width:f,height:v,viewBox:[0,0,f,v].join(" ")});this.chartBackground.attr({width:f,height:v});
this.scrollablePixelsY&&(this.scrollingContainer.style.height=this.chartHeight+"px");B&&(t.scrollPositionX&&(this.scrollingContainer.scrollLeft=this.scrollablePixelsX*t.scrollPositionX),t.scrollPositionY&&(this.scrollingContainer.scrollTop=this.scrollablePixelsY*t.scrollPositionY));v=this.axisOffset;B=this.plotTop-v[0]-1;t=this.plotLeft-v[3]-1;f=this.plotTop+this.plotHeight+v[2]+1;v=this.plotLeft+this.plotWidth+v[1]+1;var C=this.plotLeft+this.plotWidth-(this.scrollablePixelsX||0),H=this.plotTop+this.plotHeight-
(this.scrollablePixelsY||0);B=this.scrollablePixelsX?["M",0,B,"L",this.plotLeft-1,B,"L",this.plotLeft-1,f,"L",0,f,"Z","M",C,B,"L",this.chartWidth,B,"L",this.chartWidth,f,"L",C,f,"Z"]:this.scrollablePixelsY?["M",t,0,"L",t,this.plotTop-1,"L",v,this.plotTop-1,"L",v,0,"Z","M",t,H,"L",t,this.chartHeight,"L",v,this.chartHeight,"L",v,H,"Z"]:["M",0,0];"adjustHeight"!==this.redrawTrigger&&this.scrollableMask.attr({d:B})}});M(I,"parts/Point.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=
f.defined,G=f.erase,z=f.extend,B=f.isArray,t=f.isNumber,v=f.isObject,C=f.pick,H,y=c.fireEvent,h=c.format,n=c.uniqueKey,q=c.removeEvent;c.Point=H=function(){};c.Point.prototype={init:function(c,b,a){this.series=c;this.applyOptions(b,a);this.id=F(this.id)?this.id:n();this.resolveColor();c.chart.pointCount++;y(this,"afterInit");return this},resolveColor:function(){var c=this.series;var b=c.chart.options.chart.colorCount;var a=c.chart.styledMode;a||this.options.color||(this.color=c.color);c.options.colorByPoint?
(a||(b=c.options.colors||c.chart.options.colors,this.color=this.color||b[c.colorCounter],b=b.length),a=c.colorCounter,c.colorCounter++,c.colorCounter===b&&(c.colorCounter=0)):a=c.colorIndex;this.colorIndex=C(this.colorIndex,a)},applyOptions:function(c,b){var a=this.series,d=a.options.pointValKey||a.pointValKey;c=H.prototype.optionsToObject.call(this,c);z(this,c);this.options=this.options?z(this.options,c):c;c.group&&delete this.group;c.dataLabels&&delete this.dataLabels;d&&(this.y=this[d]);this.formatPrefix=
(this.isNull=C(this.isValid&&!this.isValid(),null===this.x||!t(this.y)))?"null":"point";this.selected&&(this.state="select");"name"in this&&void 0===b&&a.xAxis&&a.xAxis.hasNames&&(this.x=a.xAxis.nameToX(this));void 0===this.x&&a&&(this.x=void 0===b?a.autoIncrement(this):b);return this},setNestedProperty:function(c,b,a){a.split(".").reduce(function(a,e,c,g){a[e]=g.length-1===c?b:v(a[e],!0)?a[e]:{};return a[e]},c);return c},optionsToObject:function(g){var b={},a=this.series,d=a.options.keys,e=d||a.pointArrayMap||
["y"],h=e.length,f=0,n=0;if(t(g)||null===g)b[e[0]]=g;else if(B(g))for(!d&&g.length>h&&(a=typeof g[0],"string"===a?b.name=g[0]:"number"===a&&(b.x=g[0]),f++);n<h;)d&&void 0===g[f]||(0<e[n].indexOf(".")?c.Point.prototype.setNestedProperty(b,g[f],e[n]):b[e[n]]=g[f]),f++,n++;else"object"===typeof g&&(b=g,g.dataLabels&&(a._hasPointLabels=!0),g.marker&&(a._hasPointMarkers=!0));return b},getClassName:function(){return"highcharts-point"+(this.selected?" highcharts-point-select":"")+(this.negative?" highcharts-negative":
"")+(this.isNull?" highcharts-null-point":"")+(void 0!==this.colorIndex?" highcharts-color-"+this.colorIndex:"")+(this.options.className?" "+this.options.className:"")+(this.zone&&this.zone.className?" "+this.zone.className.replace("highcharts-negative",""):"")},getZone:function(){var c=this.series,b=c.zones;c=c.zoneAxis||"y";var a=0,d;for(d=b[a];this[c]>=d.value;)d=b[++a];this.nonZonedColor||(this.nonZonedColor=this.color);this.color=d&&d.color&&!this.options.color?d.color:this.nonZonedColor;return d},
hasNewShapeType:function(){return this.graphic&&this.graphic.element.nodeName!==this.shapeType},destroy:function(){var c=this.series.chart,b=c.hoverPoints,a;c.pointCount--;b&&(this.setState(),G(b,this),b.length||(c.hoverPoints=null));if(this===c.hoverPoint)this.onMouseOut();if(this.graphic||this.dataLabel||this.dataLabels)q(this),this.destroyElements();this.legendItem&&c.legend.destroyItem(this);for(a in this)this[a]=null},destroyElements:function(c){var b=this,a=[],d;c=c||{graphic:1,dataLabel:1};
c.graphic&&a.push("graphic","shadowGroup");c.dataLabel&&a.push("dataLabel","dataLabelUpper","connector");for(d=a.length;d--;){var e=a[d];b[e]&&(b[e]=b[e].destroy())}["dataLabel","connector"].forEach(function(a){var d=a+"s";c[a]&&b[d]&&(b[d].forEach(function(a){a.element&&a.destroy()}),delete b[d])})},getLabelConfig:function(){return{x:this.category,y:this.y,color:this.color,colorIndex:this.colorIndex,key:this.name||this.category,series:this.series,point:this,percentage:this.percentage,total:this.total||
this.stackTotal}},tooltipFormatter:function(c){var b=this.series,a=b.tooltipOptions,d=C(a.valueDecimals,""),e=a.valuePrefix||"",g=a.valueSuffix||"";b.chart.styledMode&&(c=b.chart.tooltip.styledModeFormat(c));(b.pointArrayMap||["y"]).forEach(function(a){a="{point."+a;if(e||g)c=c.replace(RegExp(a+"}","g"),e+a+"}"+g);c=c.replace(RegExp(a+"}","g"),a+":,."+d+"f}")});return h(c,{point:this,series:this.series},b.chart.time)},firePointEvent:function(c,b,a){var d=this,e=this.series.options;(e.point.events[c]||
d.options&&d.options.events&&d.options.events[c])&&this.importEvents();"click"===c&&e.allowPointSelect&&(a=function(a){d.select&&d.select(null,a.ctrlKey||a.metaKey||a.shiftKey)});y(this,c,b,a)},visible:!0}});M(I,"parts/Series.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.arrayMax,G=f.arrayMin,z=f.defined,B=f.erase,t=f.extend,v=f.isArray,C=f.isNumber,H=f.isString,y=f.objectEach,h=f.pick,n=f.splat,q=f.syncTimeout,g=c.addEvent,b=c.animObject,a=c.correctFloat,d=c.defaultOptions,
e=c.defaultPlotOptions,l=c.fireEvent,L=c.merge,E=c.removeEvent,p=c.SVGElement,u=c.win;c.Series=c.seriesType("line",null,{lineWidth:2,allowPointSelect:!1,showCheckbox:!1,animation:{duration:1E3},events:{},marker:{lineWidth:0,lineColor:"#ffffff",enabledThreshold:2,radius:4,states:{normal:{animation:!0},hover:{animation:{duration:50},enabled:!0,radiusPlus:2,lineWidthPlus:1},select:{fillColor:"#cccccc",lineColor:"#000000",lineWidth:2}}},point:{events:{}},dataLabels:{align:"center",formatter:function(){return null===
this.y?"":c.numberFormat(this.y,-1)},padding:5,style:{fontSize:"11px",fontWeight:"bold",color:"contrast",textOutline:"1px contrast"},verticalAlign:"bottom",x:0,y:0},cropThreshold:300,opacity:1,pointRange:0,softThreshold:!0,states:{normal:{animation:!0},hover:{animation:{duration:50},lineWidthPlus:1,marker:{},halo:{size:10,opacity:.25}},select:{animation:{duration:0}},inactive:{animation:{duration:50},opacity:.2}},stickyTracking:!0,turboThreshold:1E3,findNearestPointBy:"x"},{axisTypes:["xAxis","yAxis"],
coll:"series",colorCounter:0,cropShoulder:1,directTouch:!1,isCartesian:!0,parallelArrays:["x","y"],pointClass:c.Point,requireSorting:!0,sorted:!0,init:function(a,b){l(this,"init",{options:b});var d=this,e=a.series,k;this.eventOptions=this.eventOptions||{};d.chart=a;d.options=b=d.setOptions(b);d.linkedSeries=[];d.bindAxes();t(d,{name:b.name,state:"",visible:!1!==b.visible,selected:!0===b.selected});var m=b.events;y(m,function(a,b){c.isFunction(a)&&d.eventOptions[b]!==a&&(c.isFunction(d.eventOptions[b])&&
E(d,b,d.eventOptions[b]),d.eventOptions[b]=a,g(d,b,a))});if(m&&m.click||b.point&&b.point.events&&b.point.events.click||b.allowPointSelect)a.runTrackerClick=!0;d.getColor();d.getSymbol();d.parallelArrays.forEach(function(a){d[a+"Data"]||(d[a+"Data"]=[])});d.points||d.data||d.setData(b.data,!1);d.isCartesian&&(a.hasCartesianSeries=!0);e.length&&(k=e[e.length-1]);d._i=h(k&&k._i,-1)+1;a.orderSeries(this.insert(e));l(this,"afterInit")},insert:function(a){var b=this.options.index,d;if(C(b)){for(d=a.length;d--;)if(b>=
h(a[d].options.index,a[d]._i)){a.splice(d+1,0,this);break}-1===d&&a.unshift(this);d+=1}else a.push(this);return h(d,a.length-1)},bindAxes:function(){var a=this,b=a.options,d=a.chart,e;l(this,"bindAxes",null,function(){(a.axisTypes||[]).forEach(function(k){d[k].forEach(function(d){e=d.options;if(b[k]===e.index||void 0!==b[k]&&b[k]===e.id||void 0===b[k]&&0===e.index)a.insert(d.series),a[k]=d,d.isDirty=!0});a[k]||a.optionalAxis===k||c.error(18,!0,d)})})},updateParallelArrays:function(a,b){var d=a.series,
c=arguments,e=C(b)?function(c){var e="y"===c&&d.toYData?d.toYData(a):a[c];d[c+"Data"][b]=e}:function(a){Array.prototype[b].apply(d[a+"Data"],Array.prototype.slice.call(c,2))};d.parallelArrays.forEach(e)},hasData:function(){return this.visible&&void 0!==this.dataMax&&void 0!==this.dataMin||this.visible&&this.yData&&0<this.yData.length},autoIncrement:function(){var a=this.options,b=this.xIncrement,d,c=a.pointIntervalUnit,e=this.chart.time;b=h(b,a.pointStart,0);this.pointInterval=d=h(this.pointInterval,
a.pointInterval,1);c&&(a=new e.Date(b),"day"===c?e.set("Date",a,e.get("Date",a)+d):"month"===c?e.set("Month",a,e.get("Month",a)+d):"year"===c&&e.set("FullYear",a,e.get("FullYear",a)+d),d=a.getTime()-b);this.xIncrement=b+d;return b},setOptions:function(a){var b=this.chart,c=b.options,e=c.plotOptions,k=b.userOptions||{};a=L(a);b=b.styledMode;var g={plotOptions:e,userOptions:a};l(this,"setOptions",g);var f=g.plotOptions[this.type],p=k.plotOptions||{};this.userOptions=g.userOptions;k=L(f,e.series,k.plotOptions&&
k.plotOptions[this.type],a);this.tooltipOptions=L(d.tooltip,d.plotOptions.series&&d.plotOptions.series.tooltip,d.plotOptions[this.type].tooltip,c.tooltip.userOptions,e.series&&e.series.tooltip,e[this.type].tooltip,a.tooltip);this.stickyTracking=h(a.stickyTracking,p[this.type]&&p[this.type].stickyTracking,p.series&&p.series.stickyTracking,this.tooltipOptions.shared&&!this.noSharedTooltip?!0:k.stickyTracking);null===f.marker&&delete k.marker;this.zoneAxis=k.zoneAxis;c=this.zones=(k.zones||[]).slice();
!k.negativeColor&&!k.negativeFillColor||k.zones||(e={value:k[this.zoneAxis+"Threshold"]||k.threshold||0,className:"highcharts-negative"},b||(e.color=k.negativeColor,e.fillColor=k.negativeFillColor),c.push(e));c.length&&z(c[c.length-1].value)&&c.push(b?{}:{color:this.color,fillColor:this.fillColor});l(this,"afterSetOptions",{options:k});return k},getName:function(){return h(this.options.name,"Series "+(this.index+1))},getCyclic:function(a,b,d){var c=this.chart,e=this.userOptions,k=a+"Index",g=a+"Counter",
f=d?d.length:h(c.options.chart[a+"Count"],c[a+"Count"]);if(!b){var r=h(e[k],e["_"+k]);z(r)||(c.series.length||(c[g]=0),e["_"+k]=r=c[g]%f,c[g]+=1);d&&(b=d[r])}void 0!==r&&(this[k]=r);this[a]=b},getColor:function(){this.chart.styledMode?this.getCyclic("color"):this.options.colorByPoint?this.options.color=null:this.getCyclic("color",this.options.color||e[this.type].color,this.chart.options.colors)},getSymbol:function(){this.getCyclic("symbol",this.options.marker.symbol,this.chart.options.symbols)},findPointIndex:function(a,
b){var d=a.id;a=a.x;var c=this.points,e;if(d){var k=(d=this.chart.get(d))&&d.index;void 0!==k&&(e=!0)}void 0===k&&C(a)&&(k=this.xData.indexOf(a,b));-1!==k&&void 0!==k&&this.cropped&&(k=k>=this.cropStart?k-this.cropStart:k);!e&&c[k]&&c[k].touched&&(k=void 0);return k},drawLegendSymbol:c.LegendSymbolMixin.drawLineMarker,updateData:function(a){var b=this.options,d=this.points,c=[],e,k,g,h=this.requireSorting,f=a.length===d.length,l=!0;this.xIncrement=null;a.forEach(function(a,k){var m=z(a)&&this.pointClass.prototype.optionsToObject.call({series:this},
a)||{};var r=m.x;if(m.id||C(r))if(r=this.findPointIndex(m,g),-1===r||void 0===r?c.push(a):d[r]&&a!==b.data[r]?(d[r].update(a,!1,null,!1),d[r].touched=!0,h&&(g=r+1)):d[r]&&(d[r].touched=!0),!f||k!==r||this.hasDerivedData)e=!0},this);if(e)for(a=d.length;a--;)(k=d[a])&&!k.touched&&k.remove(!1);else f?a.forEach(function(a,b){d[b].update&&a!==d[b].y&&d[b].update(a,!1,null,!1)}):l=!1;d.forEach(function(a){a&&(a.touched=!1)});if(!l)return!1;c.forEach(function(a){this.addPoint(a,!1,null,null,!1)},this);return!0},
setData:function(a,b,d,e){var k=this,g=k.points,f=g&&g.length||0,r,l=k.options,p=k.chart,x=null,A=k.xAxis;x=l.turboThreshold;var u=this.xData,n=this.yData,q=(r=k.pointArrayMap)&&r.length,y=l.keys,t=0,E=1,L;a=a||[];r=a.length;b=h(b,!0);!1!==e&&r&&f&&!k.cropped&&!k.hasGroupedData&&k.visible&&!k.isSeriesBoosting&&(L=this.updateData(a));if(!L){k.xIncrement=null;k.colorCounter=0;this.parallelArrays.forEach(function(a){k[a+"Data"].length=0});if(x&&r>x)if(x=k.getFirstValidPoint(a),C(x))for(d=0;d<r;d++)u[d]=
this.autoIncrement(),n[d]=a[d];else if(v(x))if(q)for(d=0;d<r;d++)e=a[d],u[d]=e[0],n[d]=e.slice(1,q+1);else for(y&&(t=y.indexOf("x"),E=y.indexOf("y"),t=0<=t?t:0,E=0<=E?E:1),d=0;d<r;d++)e=a[d],u[d]=e[t],n[d]=e[E];else c.error(12,!1,p);else for(d=0;d<r;d++)void 0!==a[d]&&(e={series:k},k.pointClass.prototype.applyOptions.apply(e,[a[d]]),k.updateParallelArrays(e,d));n&&H(n[0])&&c.error(14,!0,p);k.data=[];k.options.data=k.userOptions.data=a;for(d=f;d--;)g[d]&&g[d].destroy&&g[d].destroy();A&&(A.minRange=
A.userMinRange);k.isDirty=p.isDirtyBox=!0;k.isDirtyData=!!g;d=!1}"point"===l.legendType&&(this.processData(),this.generatePoints());b&&p.redraw(d)},processData:function(a){var b=this.xData,d=this.yData,e=b.length;var k=0;var g=this.xAxis,h=this.options;var f=h.cropThreshold;var l=this.getExtremesFromAll||h.getExtremesFromAll,p=this.isCartesian;h=g&&g.val2lin;var u=g&&g.isLog,n=this.requireSorting;if(p&&!this.isDirty&&!g.isDirty&&!this.yAxis.isDirty&&!a)return!1;if(g){a=g.getExtremes();var q=a.min;
var v=a.max}if(p&&this.sorted&&!l&&(!f||e>f||this.forceCrop))if(b[e-1]<q||b[0]>v)b=[],d=[];else if(this.yData&&(b[0]<q||b[e-1]>v)){k=this.cropData(this.xData,this.yData,q,v);b=k.xData;d=k.yData;k=k.start;var y=!0}for(f=b.length||1;--f;)if(e=u?h(b[f])-h(b[f-1]):b[f]-b[f-1],0<e&&(void 0===t||e<t))var t=e;else 0>e&&n&&(c.error(15,!1,this.chart),n=!1);this.cropped=y;this.cropStart=k;this.processedXData=b;this.processedYData=d;this.closestPointRange=this.basePointRange=t},cropData:function(a,b,d,e,c){var k=
a.length,g=0,f=k,r;c=h(c,this.cropShoulder);for(r=0;r<k;r++)if(a[r]>=d){g=Math.max(0,r-c);break}for(d=r;d<k;d++)if(a[d]>e){f=d+c;break}return{xData:a.slice(g,f),yData:b.slice(g,f),start:g,end:f}},generatePoints:function(){var a=this.options,b=a.data,d=this.data,e,c=this.processedXData,g=this.processedYData,f=this.pointClass,h=c.length,p=this.cropStart||0,u=this.hasGroupedData;a=a.keys;var q=[],v;d||u||(d=[],d.length=b.length,d=this.data=d);a&&u&&(this.options.keys=!1);for(v=0;v<h;v++){var y=p+v;if(u){var E=
(new f).init(this,[c[v]].concat(n(g[v])));E.dataGroup=this.groupMap[v];E.dataGroup.options&&(E.options=E.dataGroup.options,t(E,E.dataGroup.options),delete E.dataLabels)}else(E=d[y])||void 0===b[y]||(d[y]=E=(new f).init(this,b[y],c[v]));E&&(E.index=y,q[v]=E)}this.options.keys=a;if(d&&(h!==(e=d.length)||u))for(v=0;v<e;v++)v!==p||u||(v+=h),d[v]&&(d[v].destroyElements(),d[v].plotX=void 0);this.data=d;this.points=q;l(this,"afterGeneratePoints")},getXExtremes:function(a){return{min:G(a),max:F(a)}},getExtremes:function(a){var b=
this.xAxis,d=this.yAxis,e=this.processedXData||this.xData,c=[],k=0,g=0;var f=0;var h=this.requireSorting?this.cropShoulder:0,p=d?d.positiveValuesOnly:!1,u;a=a||this.stackedYData||this.processedYData||[];d=a.length;b&&(f=b.getExtremes(),g=f.min,f=f.max);for(u=0;u<d;u++){var n=e[u];var q=a[u];var y=(C(q)||v(q))&&(q.length||0<q||!p);n=this.getExtremesFromAll||this.options.getExtremesFromAll||this.cropped||!b||(e[u+h]||n)>=g&&(e[u-h]||n)<=f;if(y&&n)if(y=q.length)for(;y--;)C(q[y])&&(c[k++]=q[y]);else c[k++]=
q}this.dataMin=G(c);this.dataMax=F(c);l(this,"afterGetExtremes")},getFirstValidPoint:function(a){for(var b=null,d=a.length,e=0;null===b&&e<d;)b=a[e],e++;return b},translate:function(){this.processedXData||this.processData();this.generatePoints();var b=this.options,d=b.stacking,e=this.xAxis,c=e.categories,g=this.yAxis,m=this.points,f=m.length,p=!!this.modifyValue,u,n=this.pointPlacementToXValue(),q=C(n),y=b.threshold,t=b.startFromThreshold?y:0,E,L=this.zoneAxis||"y",B=Number.MAX_VALUE;for(u=0;u<f;u++){var H=
m[u],G=H.x;var F=H.y;var I=H.low,M=d&&g.stacks[(this.negStacks&&F<(t?0:y)?"-":"")+this.stackKey];g.positiveValuesOnly&&null!==F&&0>=F&&(H.isNull=!0);H.plotX=E=a(Math.min(Math.max(-1E5,e.translate(G,0,0,0,1,n,"flags"===this.type)),1E5));if(d&&this.visible&&M&&M[G]){var X=this.getStackIndicator(X,G,this.index);if(!H.isNull){var P=M[G];var Y=P.points[X.key]}}v(Y)&&(I=Y[0],F=Y[1],I===t&&X.key===M[G].base&&(I=h(C(y)&&y,g.min)),g.positiveValuesOnly&&0>=I&&(I=null),H.total=H.stackTotal=P.total,H.percentage=
P.total&&H.y/P.total*100,H.stackY=F,this.irregularWidths||P.setOffset(this.pointXOffset||0,this.barW||0));H.yBottom=z(I)?Math.min(Math.max(-1E5,g.translate(I,0,1,0,1)),1E5):null;p&&(F=this.modifyValue(F,H));H.plotY=F="number"===typeof F&&Infinity!==F?Math.min(Math.max(-1E5,g.translate(F,0,1,0,1)),1E5):void 0;H.isInside=void 0!==F&&0<=F&&F<=g.len&&0<=E&&E<=e.len;H.clientX=q?a(e.translate(G,0,0,0,1,n)):E;H.negative=H[L]<(b[L+"Threshold"]||y||0);H.category=c&&void 0!==c[H.x]?c[H.x]:H.x;if(!H.isNull){void 0!==
Z&&(B=Math.min(B,Math.abs(E-Z)));var Z=E}H.zone=this.zones.length&&H.getZone()}this.closestPointRangePx=B;l(this,"afterTranslate")},getValidPoints:function(a,b,d){var e=this.chart;return(a||this.points||[]).filter(function(a){return b&&!e.isInsidePlot(a.plotX,a.plotY,e.inverted)?!1:d||!a.isNull})},getClipBox:function(a,b){var d=this.options,e=this.chart,c=e.inverted,k=this.xAxis,g=k&&this.yAxis;a&&!1===d.clip&&g?a=c?{y:-e.chartWidth+g.len+g.pos,height:e.chartWidth,width:e.chartHeight,x:-e.chartHeight+
k.len+k.pos}:{y:-g.pos,height:e.chartHeight,width:e.chartWidth,x:-k.pos}:(a=this.clipBox||e.clipBox,b&&(a.width=e.plotSizeX,a.x=0));return b?{width:a.width,x:a.x}:a},setClip:function(a){var b=this.chart,d=this.options,e=b.renderer,c=b.inverted,k=this.clipBox,g=this.getClipBox(a),f=this.sharedClipKey||["_sharedClip",a&&a.duration,a&&a.easing,g.height,d.xAxis,d.yAxis].join(),h=b[f],l=b[f+"m"];h||(a&&(g.width=0,c&&(g.x=b.plotSizeX+(!1!==d.clip?0:b.plotTop)),b[f+"m"]=l=e.clipRect(c?b.plotSizeX+99:-99,
c?-b.plotLeft:-b.plotTop,99,c?b.chartWidth:b.chartHeight)),b[f]=h=e.clipRect(g),h.count={length:0});a&&!h.count[this.index]&&(h.count[this.index]=!0,h.count.length+=1);if(!1!==d.clip||a)this.group.clip(a||k?h:b.clipRect),this.markerGroup.clip(l),this.sharedClipKey=f;a||(h.count[this.index]&&(delete h.count[this.index],--h.count.length),0===h.count.length&&f&&b[f]&&(k||(b[f]=b[f].destroy()),b[f+"m"]&&(b[f+"m"]=b[f+"m"].destroy())))},animate:function(a){var d=this.chart,e=b(this.options.animation);
if(a)this.setClip(e);else{var c=this.sharedClipKey;a=d[c];var k=this.getClipBox(e,!0);a&&a.animate(k,e);d[c+"m"]&&d[c+"m"].animate({width:k.width+99,x:k.x-(d.inverted?0:99)},e);this.animate=null}},afterAnimate:function(){this.setClip();l(this,"afterAnimate");this.finishedAnimating=!0},drawPoints:function(){var a=this.points,b=this.chart,d,e=this.options.marker,c=this[this.specialGroup]||this.markerGroup;var g=this.xAxis;var f=h(e.enabled,!g||g.isRadial?!0:null,this.closestPointRangePx>=e.enabledThreshold*
e.radius);if(!1!==e.enabled||this._hasPointMarkers)for(g=0;g<a.length;g++){var l=a[g];var p=(d=l.graphic)?"animate":"attr";var u=l.marker||{};var n=!!l.marker;var q=f&&void 0===u.enabled||u.enabled;var v=!1!==l.isInside;if(q&&!l.isNull){var y=h(u.symbol,this.symbol);q=this.markerAttribs(l,l.selected&&"select");d?d[v?"show":"hide"](v).animate(q):v&&(0<q.width||l.hasImage)&&(l.graphic=d=b.renderer.symbol(y,q.x,q.y,q.width,q.height,n?u:e).add(c));if(d&&!b.styledMode)d[p](this.pointAttribs(l,l.selected&&
"select"));d&&d.addClass(l.getClassName(),!0)}else d&&(l.graphic=d.destroy())}},markerAttribs:function(a,b){var d=this.options.marker,e=a.marker||{},c=e.symbol||d.symbol,k=h(e.radius,d.radius);b&&(d=d.states[b],b=e.states&&e.states[b],k=h(b&&b.radius,d&&d.radius,k+(d&&d.radiusPlus||0)));a.hasImage=c&&0===c.indexOf("url");a.hasImage&&(k=0);a={x:Math.floor(a.plotX)-k,y:a.plotY-k};k&&(a.width=a.height=2*k);return a},pointAttribs:function(a,b){var d=this.options.marker,e=a&&a.options,c=e&&e.marker||{},
k=this.color,g=e&&e.color,f=a&&a.color;e=h(c.lineWidth,d.lineWidth);var l=a&&a.zone&&a.zone.color;a=1;k=g||l||f||k;g=c.fillColor||d.fillColor||k;k=c.lineColor||d.lineColor||k;b=b||"normal";d=d.states[b];b=c.states&&c.states[b]||{};e=h(b.lineWidth,d.lineWidth,e+h(b.lineWidthPlus,d.lineWidthPlus,0));g=b.fillColor||d.fillColor||g;k=b.lineColor||d.lineColor||k;a=h(b.opacity,d.opacity,a);return{stroke:k,"stroke-width":e,fill:g,opacity:a}},destroy:function(a){var b=this,d=b.chart,e=/AppleWebKit\/533/.test(u.navigator.userAgent),
k,g,f=b.data||[],h,n;l(b,"destroy");a||E(b);(b.axisTypes||[]).forEach(function(a){(n=b[a])&&n.series&&(B(n.series,b),n.isDirty=n.forceRedraw=!0)});b.legendItem&&b.chart.legend.destroyItem(b);for(g=f.length;g--;)(h=f[g])&&h.destroy&&h.destroy();b.points=null;c.clearTimeout(b.animationTimeout);y(b,function(a,b){a instanceof p&&!a.survive&&(k=e&&"group"===b?"hide":"destroy",a[k]())});d.hoverSeries===b&&(d.hoverSeries=null);B(d.series,b);d.orderSeries();y(b,function(d,e){a&&"hcEvents"===e||delete b[e]})},
getGraphPath:function(a,b,d){var e=this,c=e.options,k=c.step,g,f=[],h=[],l;a=a||e.points;(g=a.reversed)&&a.reverse();(k={right:1,center:2}[k]||k&&3)&&g&&(k=4-k);!c.connectNulls||b||d||(a=this.getValidPoints(a));a.forEach(function(g,m){var r=g.plotX,p=g.plotY,u=a[m-1];(g.leftCliff||u&&u.rightCliff)&&!d&&(l=!0);g.isNull&&!z(b)&&0<m?l=!c.connectNulls:g.isNull&&!b?l=!0:(0===m||l?m=["M",g.plotX,g.plotY]:e.getPointSpline?m=e.getPointSpline(a,g,m):k?(m=1===k?["L",u.plotX,p]:2===k?["L",(u.plotX+r)/2,u.plotY,
"L",(u.plotX+r)/2,p]:["L",r,u.plotY],m.push("L",r,p)):m=["L",r,p],h.push(g.x),k&&(h.push(g.x),2===k&&h.push(g.x)),f.push.apply(f,m),l=!1)});f.xMap=h;return e.graphPath=f},drawGraph:function(){var a=this,b=this.options,d=(this.gappedPath||this.getGraphPath).call(this),e=this.chart.styledMode,c=[["graph","highcharts-graph"]];e||c[0].push(b.lineColor||this.color||"#cccccc",b.dashStyle);c=a.getZonesGraphs(c);c.forEach(function(c,k){var g=c[0],f=a[g],h=f?"animate":"attr";f?(f.endX=a.preventGraphAnimation?
null:d.xMap,f.animate({d:d})):d.length&&(a[g]=f=a.chart.renderer.path(d).addClass(c[1]).attr({zIndex:1}).add(a.group));f&&!e&&(g={stroke:c[2],"stroke-width":b.lineWidth,fill:a.fillGraph&&a.color||"none"},c[3]?g.dashstyle=c[3]:"square"!==b.linecap&&(g["stroke-linecap"]=g["stroke-linejoin"]="round"),f[h](g).shadow(2>k&&b.shadow));f&&(f.startX=d.xMap,f.isArea=d.isArea)})},getZonesGraphs:function(a){this.zones.forEach(function(b,d){d=["zone-graph-"+d,"highcharts-graph highcharts-zone-graph-"+d+" "+(b.className||
"")];this.chart.styledMode||d.push(b.color||this.color,b.dashStyle||this.options.dashStyle);a.push(d)},this);return a},applyZones:function(){var a=this,b=this.chart,d=b.renderer,e=this.zones,c,g,f=this.clips||[],l,p=this.graph,u=this.area,n=Math.max(b.chartWidth,b.chartHeight),q=this[(this.zoneAxis||"y")+"Axis"],v=b.inverted,y,t,E,C=!1;if(e.length&&(p||u)&&q&&void 0!==q.min){var L=q.reversed;var z=q.horiz;p&&!this.showLine&&p.hide();u&&u.hide();var B=q.getExtremes();e.forEach(function(e,k){c=L?z?
b.plotWidth:0:z?0:q.toPixels(B.min)||0;c=Math.min(Math.max(h(g,c),0),n);g=Math.min(Math.max(Math.round(q.toPixels(h(e.value,B.max),!0)||0),0),n);C&&(c=g=q.toPixels(B.max));y=Math.abs(c-g);t=Math.min(c,g);E=Math.max(c,g);q.isXAxis?(l={x:v?E:t,y:0,width:y,height:n},z||(l.x=b.plotHeight-l.x)):(l={x:0,y:v?E:t,width:n,height:y},z&&(l.y=b.plotWidth-l.y));v&&d.isVML&&(l=q.isXAxis?{x:0,y:L?t:E,height:l.width,width:b.chartWidth}:{x:l.y-b.plotLeft-b.spacingBox.x,y:0,width:l.height,height:b.chartHeight});f[k]?
f[k].animate(l):f[k]=d.clipRect(l);p&&a["zone-graph-"+k].clip(f[k]);u&&a["zone-area-"+k].clip(f[k]);C=e.value>B.max;a.resetZones&&0===g&&(g=void 0)});this.clips=f}else a.visible&&(p&&p.show(!0),u&&u.show(!0))},invertGroups:function(a){function b(){["group","markerGroup"].forEach(function(b){d[b]&&(e.renderer.isVML&&d[b].attr({width:d.yAxis.len,height:d.xAxis.len}),d[b].width=d.yAxis.len,d[b].height=d.xAxis.len,d[b].invert(a))})}var d=this,e=d.chart;if(d.xAxis){var c=g(e,"resize",b);g(d,"destroy",
c);b(a);d.invertGroups=b}},plotGroup:function(a,b,d,e,c){var k=this[a],g=!k;g&&(this[a]=k=this.chart.renderer.g().attr({zIndex:e||.1}).add(c));k.addClass("highcharts-"+b+" highcharts-series-"+this.index+" highcharts-"+this.type+"-series "+(z(this.colorIndex)?"highcharts-color-"+this.colorIndex+" ":"")+(this.options.className||"")+(k.hasClass("highcharts-tracker")?" highcharts-tracker":""),!0);k.attr({visibility:d})[g?"attr":"animate"](this.getPlotBox());return k},getPlotBox:function(){var a=this.chart,
b=this.xAxis,d=this.yAxis;a.inverted&&(b=d,d=this.xAxis);return{translateX:b?b.left:a.plotLeft,translateY:d?d.top:a.plotTop,scaleX:1,scaleY:1}},render:function(){var a=this,d=a.chart,e=a.options,c=!!a.animate&&d.renderer.isSVG&&b(e.animation).duration,g=a.visible?"inherit":"hidden",f=e.zIndex,h=a.hasRendered,p=d.seriesGroup,u=d.inverted;l(this,"render");var n=a.plotGroup("group","series",g,f,p);a.markerGroup=a.plotGroup("markerGroup","markers",g,f,p);c&&a.animate(!0);n.inverted=a.isCartesian||a.invertable?
u:!1;a.drawGraph&&(a.drawGraph(),a.applyZones());a.visible&&a.drawPoints();a.drawDataLabels&&a.drawDataLabels();a.redrawPoints&&a.redrawPoints();a.drawTracker&&!1!==a.options.enableMouseTracking&&a.drawTracker();a.invertGroups(u);!1===e.clip||a.sharedClipKey||h||n.clip(d.clipRect);c&&a.animate();h||(a.animationTimeout=q(function(){a.afterAnimate()},c||0));a.isDirty=!1;a.hasRendered=!0;l(a,"afterRender")},redraw:function(){var a=this.chart,b=this.isDirty||this.isDirtyData,d=this.group,e=this.xAxis,
c=this.yAxis;d&&(a.inverted&&d.attr({width:a.plotWidth,height:a.plotHeight}),d.animate({translateX:h(e&&e.left,a.plotLeft),translateY:h(c&&c.top,a.plotTop)}));this.translate();this.render();b&&delete this.kdTree},kdAxisArray:["clientX","plotY"],searchPoint:function(a,b){var d=this.xAxis,e=this.yAxis,c=this.chart.inverted;return this.searchKDTree({clientX:c?d.len-a.chartY+d.pos:a.chartX-d.pos,plotY:c?e.len-a.chartX+e.pos:a.chartY-e.pos},b,a)},buildKDTree:function(a){function b(a,e,c){var g;if(g=a&&
a.length){var k=d.kdAxisArray[e%c];a.sort(function(a,b){return a[k]-b[k]});g=Math.floor(g/2);return{point:a[g],left:b(a.slice(0,g),e+1,c),right:b(a.slice(g+1),e+1,c)}}}this.buildingKdTree=!0;var d=this,e=-1<d.options.findNearestPointBy.indexOf("y")?2:1;delete d.kdTree;q(function(){d.kdTree=b(d.getValidPoints(null,!d.directTouch),e,e);d.buildingKdTree=!1},d.options.kdNow||a&&"touchstart"===a.type?0:1)},searchKDTree:function(a,b,d){function e(a,b,d,h){var l=b.point,m=c.kdAxisArray[d%h],p=l;var r=z(a[g])&&
z(l[g])?Math.pow(a[g]-l[g],2):null;var u=z(a[k])&&z(l[k])?Math.pow(a[k]-l[k],2):null;u=(r||0)+(u||0);l.dist=z(u)?Math.sqrt(u):Number.MAX_VALUE;l.distX=z(r)?Math.sqrt(r):Number.MAX_VALUE;m=a[m]-l[m];u=0>m?"left":"right";r=0>m?"right":"left";b[u]&&(u=e(a,b[u],d+1,h),p=u[f]<p[f]?u:l);b[r]&&Math.sqrt(m*m)<p[f]&&(a=e(a,b[r],d+1,h),p=a[f]<p[f]?a:p);return p}var c=this,g=this.kdAxisArray[0],k=this.kdAxisArray[1],f=b?"distX":"dist";b=-1<c.options.findNearestPointBy.indexOf("y")?2:1;this.kdTree||this.buildingKdTree||
this.buildKDTree(d);if(this.kdTree)return e(a,this.kdTree,b,b)},pointPlacementToXValue:function(){var a=this.xAxis,b=this.options.pointPlacement;"between"===b&&(b=a.reversed?-.5:.5);C(b)&&(b*=h(this.options.pointRange||a.pointRange));return b}});""});M(I,"parts/Stacking.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.destroyObjectProperties,z=f.objectEach,B=f.pick;f=c.Axis;var t=c.Chart,v=c.correctFloat,C=c.format,H=c.Series;c.StackItem=function(c,f,n,q,g){var b=
c.chart.inverted;this.axis=c;this.isNegative=n;this.options=f=f||{};this.x=q;this.total=null;this.points={};this.stack=g;this.rightCliff=this.leftCliff=0;this.alignOptions={align:f.align||(b?n?"left":"right":"center"),verticalAlign:f.verticalAlign||(b?"middle":n?"bottom":"top"),y:f.y,x:f.x};this.textAlign=f.textAlign||(b?n?"right":"left":"center")};c.StackItem.prototype={destroy:function(){G(this,this.axis)},render:function(c){var f=this.axis.chart,n=this.options,q=n.format;q=q?C(q,this,f.time):n.formatter.call(this);
this.label?this.label.attr({text:q,visibility:"hidden"}):(this.label=f.renderer.label(q,null,null,n.shape,null,null,n.useHTML,!1,"stack-labels"),q={text:q,align:this.textAlign,rotation:n.rotation,padding:B(n.padding,0),visibility:"hidden"},this.label.attr(q),f.styledMode||this.label.css(n.style),this.label.added||this.label.add(c));this.label.labelrank=f.plotHeight},setOffset:function(c,f,n,q,g){var b=this.axis,a=b.chart;q=b.translate(b.usePercentage?100:q?q:this.total,0,0,0,1);n=b.translate(n?n:
0);n=F(q)&&Math.abs(q-n);c=B(g,a.xAxis[0].translate(this.x))+c;b=F(q)&&this.getStackBox(a,this,c,q,f,n,b);f=this.label;c=this.isNegative;g="justify"===B(this.options.overflow,"justify");if(f&&b){n=f.getBBox();var d=a.inverted?c?n.width:0:n.width/2,e=a.inverted?n.height/2:c?-4:n.height+4;this.alignOptions.x=B(this.options.x,0);f.align(this.alignOptions,null,b);q=f.alignAttr;f.show();q.y-=e;g&&(q.x-=d,H.prototype.justifyDataLabel.call(this.axis,f,this.alignOptions,q,n,b),q.x+=d);q.x=f.alignAttr.x;f.attr({x:q.x,
y:q.y});B(!g&&this.options.crop,!0)&&((a=a.isInsidePlot(f.x+(a.inverted?0:-n.width/2),f.y)&&a.isInsidePlot(f.x+(a.inverted?c?-n.width:n.width:n.width/2),f.y+n.height))||f.hide())}},getStackBox:function(c,f,n,q,g,b,a){var d=f.axis.reversed,e=c.inverted;c=a.height+a.pos-(e?c.plotLeft:c.plotTop);f=f.isNegative&&!d||!f.isNegative&&d;return{x:e?f?q:q-b:n,y:e?c-n-g:f?c-q-b:c-q,width:e?b:g,height:e?g:b}}};t.prototype.getStacks=function(){var c=this,f=c.inverted;c.yAxis.forEach(function(c){c.stacks&&c.hasVisibleSeries&&
(c.oldStacks=c.stacks)});c.series.forEach(function(h){var n=h.xAxis&&h.xAxis.options||{};!h.options.stacking||!0!==h.visible&&!1!==c.options.chart.ignoreHiddenSeries||(h.stackKey=[h.type,B(h.options.stack,""),f?n.top:n.left,f?n.height:n.width].join())})};f.prototype.buildStacks=function(){var c=this.series,f=B(this.options.reversedStacks,!0),n=c.length,q;if(!this.isXAxis){this.usePercentage=!1;for(q=n;q--;)c[f?q:n-q-1].setStackedPoints();for(q=0;q<n;q++)c[q].modifyStacks()}};f.prototype.renderStackTotals=
function(){var c=this.chart,f=c.renderer,n=this.stacks,q=this.stackTotalGroup;q||(this.stackTotalGroup=q=f.g("stack-labels").attr({visibility:"visible",zIndex:6}).add());q.translate(c.plotLeft,c.plotTop);z(n,function(c){z(c,function(b){b.render(q)})})};f.prototype.resetStacks=function(){var c=this,f=c.stacks;c.isXAxis||z(f,function(f){z(f,function(h,g){h.touched<c.stacksTouched?(h.destroy(),delete f[g]):(h.total=null,h.cumulative=null)})})};f.prototype.cleanStacks=function(){if(!this.isXAxis){if(this.oldStacks)var c=
this.stacks=this.oldStacks;z(c,function(c){z(c,function(c){c.cumulative=c.total})})}};H.prototype.setStackedPoints=function(){if(this.options.stacking&&(!0===this.visible||!1===this.chart.options.chart.ignoreHiddenSeries)){var f=this.processedXData,h=this.processedYData,n=[],q=h.length,g=this.options,b=g.threshold,a=B(g.startFromThreshold&&b,0),d=g.stack;g=g.stacking;var e=this.stackKey,l="-"+e,t=this.negStacks,E=this.yAxis,p=E.stacks,u=E.oldStacks,k,r;E.stacksTouched+=1;for(r=0;r<q;r++){var x=f[r];
var A=h[r];var w=this.getStackIndicator(w,x,this.index);var m=w.key;var K=(k=t&&A<(a?0:b))?l:e;p[K]||(p[K]={});p[K][x]||(u[K]&&u[K][x]?(p[K][x]=u[K][x],p[K][x].total=null):p[K][x]=new c.StackItem(E,E.options.stackLabels,k,x,d));K=p[K][x];null!==A?(K.points[m]=K.points[this.index]=[B(K.cumulative,a)],F(K.cumulative)||(K.base=m),K.touched=E.stacksTouched,0<w.index&&!1===this.singleStacks&&(K.points[m][0]=K.points[this.index+","+x+",0"][0])):K.points[m]=K.points[this.index]=null;"percent"===g?(k=k?e:
l,t&&p[k]&&p[k][x]?(k=p[k][x],K.total=k.total=Math.max(k.total,K.total)+Math.abs(A)||0):K.total=v(K.total+(Math.abs(A)||0))):K.total=v(K.total+(A||0));K.cumulative=B(K.cumulative,a)+(A||0);null!==A&&(K.points[m].push(K.cumulative),n[r]=K.cumulative)}"percent"===g&&(E.usePercentage=!0);this.stackedYData=n;E.oldStacks={}}};H.prototype.modifyStacks=function(){var c=this,f=c.stackKey,n=c.yAxis.stacks,q=c.processedXData,g,b=c.options.stacking;c[b+"Stacker"]&&[f,"-"+f].forEach(function(a){for(var d=q.length,
e,f;d--;)if(e=q[d],g=c.getStackIndicator(g,e,c.index,a),f=(e=n[a]&&n[a][e])&&e.points[g.key])c[b+"Stacker"](f,e,d)})};H.prototype.percentStacker=function(c,f,n){f=f.total?100/f.total:0;c[0]=v(c[0]*f);c[1]=v(c[1]*f);this.stackedYData[n]=c[1]};H.prototype.getStackIndicator=function(c,f,n,q){!F(c)||c.x!==f||q&&c.key!==q?c={x:f,index:0,key:q}:c.index++;c.key=[n,f,c.index].join();return c}});M(I,"parts/Dynamics.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.erase,
z=f.extend,B=f.isArray,t=f.isNumber,v=f.isObject,C=f.isString,H=f.objectEach,y=f.pick,h=f.setAnimation,n=f.splat,q=c.addEvent,g=c.animate,b=c.Axis;f=c.Chart;var a=c.createElement,d=c.css,e=c.fireEvent,l=c.merge,L=c.Point,E=c.Series,p=c.seriesTypes;c.cleanRecursively=function(a,b){var d={};H(a,function(e,g){if(v(a[g],!0)&&!a.nodeType&&b[g])e=c.cleanRecursively(a[g],b[g]),Object.keys(e).length&&(d[g]=e);else if(v(a[g])||a[g]!==b[g])d[g]=a[g]});return d};z(f.prototype,{addSeries:function(a,b,d){var c,
g=this;a&&(b=y(b,!0),e(g,"addSeries",{options:a},function(){c=g.initSeries(a);g.isDirtyLegend=!0;g.linkSeries();e(g,"afterAddSeries",{series:c});b&&g.redraw(d)}));return c},addAxis:function(a,b,d,c){return this.createAxis(b?"xAxis":"yAxis",{axis:a,redraw:d,animation:c})},addColorAxis:function(a,b,d){return this.createAxis("colorAxis",{axis:a,redraw:b,animation:d})},createAxis:function(a,d){var e=this.options,g="colorAxis"===a,k=d.redraw,f=d.animation;d=l(d.axis,{index:this[a].length,isX:"xAxis"===
a});var h=g?new c.ColorAxis(this,d):new b(this,d);e[a]=n(e[a]||{});e[a].push(d);g&&(this.isDirtyLegend=!0,this.axes.forEach(function(a){a.series=[]}),this.series.forEach(function(a){a.bindAxes();a.isDirtyData=!0}));y(k,!0)&&this.redraw(f);return h},showLoading:function(b){var c=this,e=c.options,f=c.loadingDiv,h=e.loading,l=function(){f&&d(f,{left:c.plotLeft+"px",top:c.plotTop+"px",width:c.plotWidth+"px",height:c.plotHeight+"px"})};f||(c.loadingDiv=f=a("div",{className:"highcharts-loading highcharts-loading-hidden"},
null,c.container),c.loadingSpan=a("span",{className:"highcharts-loading-inner"},null,f),q(c,"redraw",l));f.className="highcharts-loading";c.loadingSpan.innerHTML=y(b,e.lang.loading,"");c.styledMode||(d(f,z(h.style,{zIndex:10})),d(c.loadingSpan,h.labelStyle),c.loadingShown||(d(f,{opacity:0,display:""}),g(f,{opacity:h.style.opacity||.5},{duration:h.showDuration||0})));c.loadingShown=!0;l()},hideLoading:function(){var a=this.options,b=this.loadingDiv;b&&(b.className="highcharts-loading highcharts-loading-hidden",
this.styledMode||g(b,{opacity:0},{duration:a.loading.hideDuration||100,complete:function(){d(b,{display:"none"})}}));this.loadingShown=!1},propsRequireDirtyBox:"backgroundColor borderColor borderWidth borderRadius plotBackgroundColor plotBackgroundImage plotBorderColor plotBorderWidth plotShadow shadow".split(" "),propsRequireReflow:"margin marginTop marginRight marginBottom marginLeft spacing spacingTop spacingRight spacingBottom spacingLeft".split(" "),propsRequireUpdateSeries:"chart.inverted chart.polar chart.ignoreHiddenSeries chart.type colors plotOptions time tooltip".split(" "),
collectionsWithUpdate:"xAxis yAxis zAxis colorAxis series pane".split(" "),update:function(a,b,d,g){var k=this,f={credits:"addCredits",title:"setTitle",subtitle:"setSubtitle",caption:"setCaption"},h,p,r,u=a.isResponsiveOptions,q=[];e(k,"update",{options:a});u||k.setResponsive(!1,!0);a=c.cleanRecursively(a,k.options);l(!0,k.userOptions,a);if(h=a.chart){l(!0,k.options.chart,h);"className"in h&&k.setClassName(h.className);"reflow"in h&&k.setReflow(h.reflow);if("inverted"in h||"polar"in h||"type"in h){k.propFromSeries();
var x=!0}"alignTicks"in h&&(x=!0);H(h,function(a,b){-1!==k.propsRequireUpdateSeries.indexOf("chart."+b)&&(p=!0);-1!==k.propsRequireDirtyBox.indexOf(b)&&(k.isDirtyBox=!0);u||-1===k.propsRequireReflow.indexOf(b)||(r=!0)});!k.styledMode&&"style"in h&&k.renderer.setStyle(h.style)}!k.styledMode&&a.colors&&(this.options.colors=a.colors);a.plotOptions&&l(!0,this.options.plotOptions,a.plotOptions);a.time&&this.time===c.time&&(this.time=new c.Time(a.time));H(a,function(a,b){if(k[b]&&"function"===typeof k[b].update)k[b].update(a,
!1);else if("function"===typeof k[f[b]])k[f[b]](a);"chart"!==b&&-1!==k.propsRequireUpdateSeries.indexOf(b)&&(p=!0)});this.collectionsWithUpdate.forEach(function(b){if(a[b]){if("series"===b){var c=[];k[b].forEach(function(a,b){a.options.isInternal||c.push(y(a.options.index,b))})}n(a[b]).forEach(function(a,e){(e=F(a.id)&&k.get(a.id)||k[b][c?c[e]:e])&&e.coll===b&&(e.update(a,!1),d&&(e.touched=!0));!e&&d&&k.collectionsWithInit[b]&&(k.collectionsWithInit[b][0].apply(k,[a].concat(k.collectionsWithInit[b][1]||
[]).concat([!1])).touched=!0)});d&&k[b].forEach(function(a){a.touched||a.options.isInternal?delete a.touched:q.push(a)})}});q.forEach(function(a){a.remove&&a.remove(!1)});x&&k.axes.forEach(function(a){a.update({},!1)});p&&k.series.forEach(function(a){a.update({},!1)});a.loading&&l(!0,k.options.loading,a.loading);x=h&&h.width;h=h&&h.height;C(h)&&(h=c.relativeLength(h,x||k.chartWidth));r||t(x)&&x!==k.chartWidth||t(h)&&h!==k.chartHeight?k.setSize(x,h,g):y(b,!0)&&k.redraw(g);e(k,"afterUpdate",{options:a,
redraw:b,animation:g})},setSubtitle:function(a,b){this.applyDescription("subtitle",a);this.layOutTitles(b)},setCaption:function(a,b){this.applyDescription("caption",a);this.layOutTitles(b)}});f.prototype.collectionsWithInit={xAxis:[f.prototype.addAxis,[!0]],yAxis:[f.prototype.addAxis,[!1]],colorAxis:[f.prototype.addColorAxis,[!1]],series:[f.prototype.addSeries]};z(L.prototype,{update:function(a,b,d,c){function e(){g.applyOptions(a);null===g.y&&f&&(g.graphic=f.destroy());v(a,!0)&&(f&&f.element&&a&&
a.marker&&void 0!==a.marker.symbol&&(g.graphic=f.destroy()),a&&a.dataLabels&&g.dataLabel&&(g.dataLabel=g.dataLabel.destroy()),g.connector&&(g.connector=g.connector.destroy()));h=g.index;k.updateParallelArrays(g,h);p.data[h]=v(p.data[h],!0)||v(a,!0)?g.options:y(a,p.data[h]);k.isDirty=k.isDirtyData=!0;!k.fixedBox&&k.hasCartesianSeries&&(l.isDirtyBox=!0);"point"===p.legendType&&(l.isDirtyLegend=!0);b&&l.redraw(d)}var g=this,k=g.series,f=g.graphic,h,l=k.chart,p=k.options;b=y(b,!0);!1===c?e():g.firePointEvent("update",
{options:a},e)},remove:function(a,b){this.series.removePoint(this.series.data.indexOf(this),a,b)}});z(E.prototype,{addPoint:function(a,b,d,c,g){var k=this.options,f=this.data,h=this.chart,l=this.xAxis;l=l&&l.hasNames&&l.names;var p=k.data,r=this.xData,n;b=y(b,!0);var u={series:this};this.pointClass.prototype.applyOptions.apply(u,[a]);var q=u.x;var x=r.length;if(this.requireSorting&&q<r[x-1])for(n=!0;x&&r[x-1]>q;)x--;this.updateParallelArrays(u,"splice",x,0,0);this.updateParallelArrays(u,x);l&&u.name&&
(l[q]=u.name);p.splice(x,0,a);n&&(this.data.splice(x,0,null),this.processData());"point"===k.legendType&&this.generatePoints();d&&(f[0]&&f[0].remove?f[0].remove(!1):(f.shift(),this.updateParallelArrays(u,"shift"),p.shift()));!1!==g&&e(this,"addPoint",{point:u});this.isDirtyData=this.isDirty=!0;b&&h.redraw(c)},removePoint:function(a,b,d){var c=this,e=c.data,g=e[a],k=c.points,f=c.chart,l=function(){k&&k.length===e.length&&k.splice(a,1);e.splice(a,1);c.options.data.splice(a,1);c.updateParallelArrays(g||
{series:c},"splice",a,1);g&&g.destroy();c.isDirty=!0;c.isDirtyData=!0;b&&f.redraw()};h(d,f);b=y(b,!0);g?g.firePointEvent("remove",null,l):l()},remove:function(a,b,d,c){function g(){k.destroy(c);k.remove=null;f.isDirtyLegend=f.isDirtyBox=!0;f.linkSeries();y(a,!0)&&f.redraw(b)}var k=this,f=k.chart;!1!==d?e(k,"remove",null,g):g()},update:function(a,b){a=c.cleanRecursively(a,this.userOptions);e(this,"update",{options:a});var d=this,g=d.chart,k=d.userOptions,f=d.initialType||d.type,h=a.type||k.type||g.options.chart.type,
n=!(this.hasDerivedData||a.dataGrouping||h&&h!==this.type||void 0!==a.pointStart||a.pointInterval||a.pointIntervalUnit||a.keys),u=p[f].prototype,q,v=["group","markerGroup","dataLabelsGroup","transformGroup"],t=["eventOptions","navigatorSeries","baseSeries"],E=d.finishedAnimating&&{animation:!1},C={};n&&(t.push("data","isDirtyData","points","processedXData","processedYData","xIncrement","_hasPointMarkers","_hasPointLabels","mapMap","mapData","minY","maxY","minX","maxX"),!1!==a.visible&&t.push("area",
"graph"),d.parallelArrays.forEach(function(a){t.push(a+"Data")}),a.data&&this.setData(a.data,!1));a=l(k,E,{index:void 0===k.index?d.index:k.index,pointStart:y(k.pointStart,d.xData[0])},!n&&{data:d.options.data},a);n&&a.data&&(a.data=d.options.data);t=v.concat(t);t.forEach(function(a){t[a]=d[a];delete d[a]});d.remove(!1,null,!1,!0);for(q in u)d[q]=void 0;p[h||f]?z(d,p[h||f].prototype):c.error(17,!0,g,{missingModuleFor:h||f});t.forEach(function(a){d[a]=t[a]});d.init(g,a);if(n&&this.points){var L=d.options;
!1===L.visible?(C.graphic=1,C.dataLabel=1):d._hasPointLabels||(h=L.marker,u=L.dataLabels,h&&(!1===h.enabled||"symbol"in h)&&(C.graphic=1),u&&!1===u.enabled&&(C.dataLabel=1));this.points.forEach(function(a){a&&a.series&&(a.resolveColor(),Object.keys(C).length&&a.destroyElements(C),!1===L.showInLegend&&a.legendItem&&g.legend.destroyItem(a))},this)}a.zIndex!==k.zIndex&&v.forEach(function(b){d[b]&&d[b].attr({zIndex:a.zIndex})});d.initialType=f;g.linkSeries();e(this,"afterUpdate");y(b,!0)&&g.redraw(n?
void 0:!1)},setName:function(a){this.name=this.options.name=this.userOptions.name=a;this.chart.isDirtyLegend=!0}});z(b.prototype,{update:function(a,b){var d=this.chart,c=a&&a.events||{};a=l(this.userOptions,a);d.options[this.coll].indexOf&&(d.options[this.coll][d.options[this.coll].indexOf(this.userOptions)]=a);H(d.options[this.coll].events,function(a,b){"undefined"===typeof c[b]&&(c[b]=void 0)});this.destroy(!0);this.init(d,z(a,{events:c}));d.isDirtyBox=!0;y(b,!0)&&d.redraw()},remove:function(a){for(var b=
this.chart,d=this.coll,c=this.series,e=c.length;e--;)c[e]&&c[e].remove(!1);G(b.axes,this);G(b[d],this);B(b.options[d])?b.options[d].splice(this.options.index,1):delete b.options[d];b[d].forEach(function(a,b){a.options.index=a.userOptions.index=b});this.destroy();b.isDirtyBox=!0;y(a,!0)&&b.redraw()},setTitle:function(a,b){this.update({title:a},b)},setCategories:function(a,b){this.update({categories:a},b)}})});M(I,"parts/AreaSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=
f.objectEach,G=f.pick,z=c.color,B=c.Series;f=c.seriesType;f("area","line",{softThreshold:!1,threshold:0},{singleStacks:!1,getStackPoints:function(c){var f=[],t=[],z=this.xAxis,y=this.yAxis,h=y.stacks[this.stackKey],n={},q=this.index,g=y.series,b=g.length,a=G(y.options.reversedStacks,!0)?1:-1,d;c=c||this.points;if(this.options.stacking){for(d=0;d<c.length;d++)c[d].leftNull=c[d].rightNull=void 0,n[c[d].x]=c[d];F(h,function(a,b){null!==a.total&&t.push(b)});t.sort(function(a,b){return a-b});var e=g.map(function(a){return a.visible});
t.forEach(function(c,g){var l=0,p,u;if(n[c]&&!n[c].isNull)f.push(n[c]),[-1,1].forEach(function(k){var f=1===k?"rightNull":"leftNull",l=0,v=h[t[g+k]];if(v)for(d=q;0<=d&&d<b;)p=v.points[d],p||(d===q?n[c][f]=!0:e[d]&&(u=h[c].points[d])&&(l-=u[1]-u[0])),d+=a;n[c][1===k?"rightCliff":"leftCliff"]=l});else{for(d=q;0<=d&&d<b;){if(p=h[c].points[d]){l=p[1];break}d+=a}l=y.translate(l,0,1,0,1);f.push({isNull:!0,plotX:z.translate(c,0,0,0,1),x:c,plotY:l,yBottom:l})}})}return f},getGraphPath:function(c){var f=B.prototype.getGraphPath,
t=this.options,z=t.stacking,y=this.yAxis,h,n=[],q=[],g=this.index,b=y.stacks[this.stackKey],a=t.threshold,d=Math.round(y.getThreshold(t.threshold));t=G(t.connectNulls,"percent"===z);var e=function(e,f,k){var h=c[e];e=z&&b[h.x].points[g];var l=h[k+"Null"]||0;k=h[k+"Cliff"]||0;h=!0;if(k||l){var p=(l?e[0]:e[1])+k;var u=e[0]+k;h=!!l}else!z&&c[f]&&c[f].isNull&&(p=u=a);void 0!==p&&(q.push({plotX:L,plotY:null===p?d:y.getThreshold(p),isNull:h,isCliff:!0}),n.push({plotX:L,plotY:null===u?d:y.getThreshold(u),
doCurve:!1}))};c=c||this.points;z&&(c=this.getStackPoints(c));for(h=0;h<c.length;h++){z||(c[h].leftCliff=c[h].rightCliff=c[h].leftNull=c[h].rightNull=void 0);var l=c[h].isNull;var L=G(c[h].rectPlotX,c[h].plotX);var E=G(c[h].yBottom,d);if(!l||t)t||e(h,h-1,"left"),l&&!z&&t||(q.push(c[h]),n.push({x:h,plotX:L,plotY:E})),t||e(h,h+1,"right")}h=f.call(this,q,!0,!0);n.reversed=!0;l=f.call(this,n,!0,!0);l.length&&(l[0]="L");l=h.concat(l);f=f.call(this,q,!1,t);l.xMap=h.xMap;this.areaPath=l;return f},drawGraph:function(){this.areaPath=
[];B.prototype.drawGraph.apply(this);var c=this,f=this.areaPath,C=this.options,H=[["area","highcharts-area",this.color,C.fillColor]];this.zones.forEach(function(f,h){H.push(["zone-area-"+h,"highcharts-area highcharts-zone-area-"+h+" "+f.className,f.color||c.color,f.fillColor||C.fillColor])});H.forEach(function(v){var h=v[0],n=c[h],q=n?"animate":"attr",g={};n?(n.endX=c.preventGraphAnimation?null:f.xMap,n.animate({d:f})):(g.zIndex=0,n=c[h]=c.chart.renderer.path(f).addClass(v[1]).add(c.group),n.isArea=
!0);c.chart.styledMode||(g.fill=G(v[3],z(v[2]).setOpacity(G(C.fillOpacity,.75)).get()));n[q](g);n.startX=f.xMap;n.shiftUnit=C.step?2:1})},drawLegendSymbol:c.LegendSymbolMixin.drawRectangle});""});M(I,"parts/SplineSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.pick;c=c.seriesType;c("spline","line",{},{getPointSpline:function(c,f,B){var t=f.plotX,v=f.plotY,C=c[B-1];B=c[B+1];if(C&&!C.isNull&&!1!==C.doCurve&&!f.isCliff&&B&&!B.isNull&&!1!==B.doCurve&&!f.isCliff){c=C.plotY;
var z=B.plotX;B=B.plotY;var y=0;var h=(1.5*t+C.plotX)/2.5;var n=(1.5*v+c)/2.5;z=(1.5*t+z)/2.5;var q=(1.5*v+B)/2.5;z!==h&&(y=(q-n)*(z-t)/(z-h)+v-q);n+=y;q+=y;n>c&&n>v?(n=Math.max(c,v),q=2*v-n):n<c&&n<v&&(n=Math.min(c,v),q=2*v-n);q>B&&q>v?(q=Math.max(B,v),n=2*v-q):q<B&&q<v&&(q=Math.min(B,v),n=2*v-q);f.rightContX=z;f.rightContY=q}f=["C",F(C.rightContX,C.plotX),F(C.rightContY,C.plotY),F(h,t),F(n,v),t,v];C.rightContX=C.rightContY=null;return f}});""});M(I,"parts/AreaSplineSeries.js",[I["parts/Globals.js"]],
function(c){var f=c.seriesTypes.area.prototype,F=c.seriesType;F("areaspline","spline",c.defaultPlotOptions.area,{getStackPoints:f.getStackPoints,getGraphPath:f.getGraphPath,drawGraph:f.drawGraph,drawLegendSymbol:c.LegendSymbolMixin.drawRectangle});""});M(I,"parts/ColumnSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.extend,z=f.isNumber,B=f.pick,t=c.animObject,v=c.color,C=c.merge,H=c.Series;f=c.seriesType;var y=c.svg;f("column","line",{borderRadius:0,crisp:!0,
groupPadding:.2,marker:null,pointPadding:.1,minPointLength:0,cropThreshold:50,pointRange:null,states:{hover:{halo:!1,brightness:.1},select:{color:"#cccccc",borderColor:"#000000"}},dataLabels:{align:null,verticalAlign:null,y:null},softThreshold:!1,startFromThreshold:!0,stickyTracking:!1,tooltip:{distance:6},threshold:0,borderColor:"#ffffff"},{cropShoulder:0,directTouch:!0,trackerGroups:["group","dataLabelsGroup"],negStacks:!0,init:function(){H.prototype.init.apply(this,arguments);var c=this,f=c.chart;
f.hasRendered&&f.series.forEach(function(f){f.type===c.type&&(f.isDirty=!0)})},getColumnMetrics:function(){var c=this,f=c.options,q=c.xAxis,g=c.yAxis,b=q.options.reversedStacks;b=q.reversed&&!b||!q.reversed&&b;var a,d={},e=0;!1===f.grouping?e=1:c.chart.series.forEach(function(b){var f=b.yAxis,k=b.options;if(b.type===c.type&&(b.visible||!c.chart.options.chart.ignoreHiddenSeries)&&g.len===f.len&&g.pos===f.pos){if(k.stacking){a=b.stackKey;void 0===d[a]&&(d[a]=e++);var h=d[a]}else!1!==k.grouping&&(h=
e++);b.columnIndex=h}});var l=Math.min(Math.abs(q.transA)*(q.ordinalSlope||f.pointRange||q.closestPointRange||q.tickInterval||1),q.len),v=l*f.groupPadding,t=(l-2*v)/(e||1);f=Math.min(f.maxPointWidth||q.len,B(f.pointWidth,t*(1-2*f.pointPadding)));c.columnMetrics={width:f,offset:(t-f)/2+(v+((c.columnIndex||0)+(b?1:0))*t-l/2)*(b?-1:1)};return c.columnMetrics},crispCol:function(c,f,q,g){var b=this.chart,a=this.borderWidth,d=-(a%2?.5:0);a=a%2?.5:1;b.inverted&&b.renderer.isVML&&(a+=1);this.options.crisp&&
(q=Math.round(c+q)+d,c=Math.round(c)+d,q-=c);g=Math.round(f+g)+a;d=.5>=Math.abs(f)&&.5<g;f=Math.round(f)+a;g-=f;d&&g&&(--f,g+=1);return{x:c,y:f,width:q,height:g}},translate:function(){var c=this,f=c.chart,q=c.options,g=c.dense=2>c.closestPointRange*c.xAxis.transA;g=c.borderWidth=B(q.borderWidth,g?0:1);var b=c.yAxis,a=q.threshold,d=c.translatedThreshold=b.getThreshold(a),e=B(q.minPointLength,5),l=c.getColumnMetrics(),v=l.width,t=c.barW=Math.max(v,1+2*g),p=c.pointXOffset=l.offset,u=c.dataMin,k=c.dataMax;
f.inverted&&(d-=.5);q.pointPadding&&(t=Math.ceil(t));H.prototype.translate.apply(c);c.points.forEach(function(g){var h=B(g.yBottom,d),l=999+Math.abs(h),r=v;l=Math.min(Math.max(-l,g.plotY),b.len+l);var m=g.plotX+p,n=t,q=Math.min(l,h),y=Math.max(l,h)-q;if(e&&Math.abs(y)<e){y=e;var E=!b.reversed&&!g.negative||b.reversed&&g.negative;g.y===a&&c.dataMax<=a&&b.min<a&&u!==k&&(E=!E);q=Math.abs(q-d)>e?h-e:d-(E?e:0)}F(g.options.pointWidth)&&(r=n=Math.ceil(g.options.pointWidth),m-=Math.round((r-v)/2));g.barX=
m;g.pointWidth=r;g.tooltipPos=f.inverted?[b.len+b.pos-f.plotLeft-l,c.xAxis.len-m-n/2,y]:[m+n/2,l+b.pos-f.plotTop,y];g.shapeType=c.pointClass.prototype.shapeType||"rect";g.shapeArgs=c.crispCol.apply(c,g.isNull?[m,d,n,0]:[m,q,n,y])})},getSymbol:c.noop,drawLegendSymbol:c.LegendSymbolMixin.drawRectangle,drawGraph:function(){this.group[this.dense?"addClass":"removeClass"]("highcharts-dense-data")},pointAttribs:function(c,f){var h=this.options,g=this.pointAttrToOptions||{};var b=g.stroke||"borderColor";
var a=g["stroke-width"]||"borderWidth",d=c&&c.color||this.color,e=c&&c[b]||h[b]||this.color||d,l=c&&c[a]||h[a]||this[a]||0;g=c&&c.options.dashStyle||h.dashStyle;var n=B(h.opacity,1);if(c&&this.zones.length){var t=c.getZone();d=c.options.color||t&&(t.color||c.nonZonedColor)||this.color;t&&(e=t.borderColor||e,g=t.dashStyle||g,l=t.borderWidth||l)}f&&(c=C(h.states[f],c.options.states&&c.options.states[f]||{}),f=c.brightness,d=c.color||void 0!==f&&v(d).brighten(c.brightness).get()||d,e=c[b]||e,l=c[a]||
l,g=c.dashStyle||g,n=B(c.opacity,n));b={fill:d,stroke:e,"stroke-width":l,opacity:n};g&&(b.dashstyle=g);return b},drawPoints:function(){var c=this,f=this.chart,q=c.options,g=f.renderer,b=q.animationLimit||250,a;c.points.forEach(function(d){var e=d.graphic,l=e&&f.pointCount<b?"animate":"attr";if(z(d.plotY)&&null!==d.y){a=d.shapeArgs;e&&d.hasNewShapeType()&&(e=e.destroy());if(e)e[l](C(a));else d.graphic=e=g[d.shapeType](a).add(d.group||c.group);if(q.borderRadius)e[l]({r:q.borderRadius});f.styledMode||
e[l](c.pointAttribs(d,d.selected&&"select")).shadow(!1!==d.allowShadow&&q.shadow,null,q.stacking&&!q.borderRadius);e.addClass(d.getClassName(),!0)}else e&&(d.graphic=e.destroy())})},animate:function(c){var f=this,h=this.yAxis,g=f.options,b=this.chart.inverted,a={},d=b?"translateX":"translateY";if(y)if(c)a.scaleY=.001,c=Math.min(h.pos+h.len,Math.max(h.pos,h.toPixels(g.threshold))),b?a.translateX=c-h.len:a.translateY=c,f.clipBox&&f.setClip(),f.group.attr(a);else{var e=f.group.attr(d);f.group.animate({scaleY:1},
G(t(f.options.animation),{step:function(b,c){a[d]=e+c.pos*(h.pos-e);f.group.attr(a)}}));f.animate=null}},remove:function(){var c=this,f=c.chart;f.hasRendered&&f.series.forEach(function(f){f.type===c.type&&(f.isDirty=!0)});H.prototype.remove.apply(c,arguments)}});""});M(I,"parts/BarSeries.js",[I["parts/Globals.js"]],function(c){c=c.seriesType;c("bar","column",null,{inverted:!0});""});M(I,"parts/ScatterSeries.js",[I["parts/Globals.js"]],function(c){var f=c.Series,F=c.seriesType;F("scatter","line",{lineWidth:0,
findNearestPointBy:"xy",jitter:{x:0,y:0},marker:{enabled:!0},tooltip:{headerFormat:'<span style="color:{point.color}">\u25cf</span> <span style="font-size: 10px"> {series.name}</span><br/>',pointFormat:"x: <b>{point.x}</b><br/>y: <b>{point.y}</b><br/>"}},{sorted:!1,requireSorting:!1,noSharedTooltip:!0,trackerGroups:["group","markerGroup","dataLabelsGroup"],takeOrdinalPosition:!1,drawGraph:function(){this.options.lineWidth&&f.prototype.drawGraph.call(this)},applyJitter:function(){var c=this,f=this.options.jitter,
B=this.points.length;f&&this.points.forEach(function(t,v){["x","y"].forEach(function(C,z){var y="plot"+C.toUpperCase();if(f[C]&&!t.isNull){var h=c[C+"Axis"];var n=f[C]*h.transA;if(h&&!h.isLog){var q=Math.max(0,t[y]-n);h=Math.min(h.len,t[y]+n);z=1E4*Math.sin(v+z*B);t[y]=q+(h-q)*(z-Math.floor(z));"x"===C&&(t.clientX=t.plotX)}}})})}});c.addEvent(f,"afterTranslate",function(){this.applyJitter&&this.applyJitter()});""});M(I,"mixins/centered-series.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,
f){var F=f.isNumber,G=f.pick,z=c.deg2rad,B=c.relativeLength;c.CenteredSeriesMixin={getCenter:function(){var c=this.options,f=this.chart,C=2*(c.slicedOffset||0),z=f.plotWidth-2*C;f=f.plotHeight-2*C;var y=c.center;y=[G(y[0],"50%"),G(y[1],"50%"),c.size||"100%",c.innerSize||0];var h=Math.min(z,f),n;for(n=0;4>n;++n){var q=y[n];c=2>n||2===n&&/%$/.test(q);y[n]=B(q,[z,f,h,y[2]][n])+(c?C:0)}y[3]>y[2]&&(y[3]=y[2]);return y},getStartAndEndRadians:function(c,f){c=F(c)?c:0;f=F(f)&&f>c&&360>f-c?f:c+360;return{start:z*
(c+-90),end:z*(f+-90)}}}});M(I,"parts/PieSeries.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.isNumber,z=f.pick,B=f.setAnimation,t=c.addEvent;f=c.CenteredSeriesMixin;var v=f.getStartAndEndRadians,C=c.merge,H=c.noop,y=c.Point,h=c.Series,n=c.seriesType,q=c.fireEvent;n("pie","line",{center:[null,null],clip:!1,colorByPoint:!0,dataLabels:{allowOverlap:!0,connectorPadding:5,distance:30,enabled:!0,formatter:function(){return this.point.isNull?void 0:this.point.name},
softConnector:!0,x:0,connectorShape:"fixedOffset",crookDistance:"70%"},fillColor:void 0,ignoreHiddenPoint:!0,inactiveOtherPoints:!0,legendType:"point",marker:null,size:null,showInLegend:!1,slicedOffset:10,stickyTracking:!1,tooltip:{followPointer:!0},borderColor:"#ffffff",borderWidth:1,lineWidth:void 0,states:{hover:{brightness:.1}}},{isCartesian:!1,requireSorting:!1,directTouch:!0,noSharedTooltip:!0,trackerGroups:["group","dataLabelsGroup"],axisTypes:[],pointAttribs:c.seriesTypes.column.prototype.pointAttribs,
animate:function(c){var b=this,a=b.points,d=b.startAngleRad;c||(a.forEach(function(a){var c=a.graphic,e=a.shapeArgs;c&&(c.attr({r:a.startR||b.center[3]/2,start:d,end:d}),c.animate({r:e.r,start:e.start,end:e.end},b.options.animation))}),b.animate=null)},hasData:function(){return!!this.processedXData.length},updateTotals:function(){var c,b=0,a=this.points,d=a.length,e=this.options.ignoreHiddenPoint;for(c=0;c<d;c++){var f=a[c];b+=e&&!f.visible?0:f.isNull?0:f.y}this.total=b;for(c=0;c<d;c++)f=a[c],f.percentage=
0<b&&(f.visible||!e)?f.y/b*100:0,f.total=b},generatePoints:function(){h.prototype.generatePoints.call(this);this.updateTotals()},getX:function(c,b,a){var d=this.center,e=this.radii?this.radii[a.index]:d[2]/2;return d[0]+(b?-1:1)*Math.cos(Math.asin(Math.max(Math.min((c-d[1])/(e+a.labelDistance),1),-1)))*(e+a.labelDistance)+(0<a.labelDistance?(b?-1:1)*this.options.dataLabels.padding:0)},translate:function(g){this.generatePoints();var b=0,a=this.options,d=a.slicedOffset,e=d+(a.borderWidth||0),f=v(a.startAngle,
a.endAngle),h=this.startAngleRad=f.start;f=(this.endAngleRad=f.end)-h;var n=this.points,p=a.dataLabels.distance;a=a.ignoreHiddenPoint;var u,k=n.length;g||(this.center=g=this.getCenter());for(u=0;u<k;u++){var r=n[u];var x=h+b*f;if(!a||r.visible)b+=r.percentage/100;var A=h+b*f;r.shapeType="arc";r.shapeArgs={x:g[0],y:g[1],r:g[2]/2,innerR:g[3]/2,start:Math.round(1E3*x)/1E3,end:Math.round(1E3*A)/1E3};r.labelDistance=z(r.options.dataLabels&&r.options.dataLabels.distance,p);r.labelDistance=c.relativeLength(r.labelDistance,
r.shapeArgs.r);this.maxLabelDistance=Math.max(this.maxLabelDistance||0,r.labelDistance);A=(A+x)/2;A>1.5*Math.PI?A-=2*Math.PI:A<-Math.PI/2&&(A+=2*Math.PI);r.slicedTranslation={translateX:Math.round(Math.cos(A)*d),translateY:Math.round(Math.sin(A)*d)};var w=Math.cos(A)*g[2]/2;var m=Math.sin(A)*g[2]/2;r.tooltipPos=[g[0]+.7*w,g[1]+.7*m];r.half=A<-Math.PI/2||A>Math.PI/2?1:0;r.angle=A;x=Math.min(e,r.labelDistance/5);r.labelPosition={natural:{x:g[0]+w+Math.cos(A)*r.labelDistance,y:g[1]+m+Math.sin(A)*r.labelDistance},
"final":{},alignment:0>r.labelDistance?"center":r.half?"right":"left",connectorPosition:{breakAt:{x:g[0]+w+Math.cos(A)*x,y:g[1]+m+Math.sin(A)*x},touchingSliceAt:{x:g[0]+w,y:g[1]+m}}}}q(this,"afterTranslate")},drawEmpty:function(){var c=this.options;if(0===this.total){var b=this.center[0];var a=this.center[1];this.graph||(this.graph=this.chart.renderer.circle(b,a,0).addClass("highcharts-graph").add(this.group));this.graph.animate({"stroke-width":c.borderWidth,cx:b,cy:a,r:this.center[2]/2,fill:c.fillColor||
"none",stroke:c.color||"#cccccc"})}else this.graph&&(this.graph=this.graph.destroy())},redrawPoints:function(){var c=this,b=c.chart,a=b.renderer,d,e,f,h,n=c.options.shadow;this.drawEmpty();!n||c.shadowGroup||b.styledMode||(c.shadowGroup=a.g("shadow").attr({zIndex:-1}).add(c.group));c.points.forEach(function(g){var l={};e=g.graphic;if(!g.isNull&&e){h=g.shapeArgs;d=g.getTranslate();if(!b.styledMode){var k=g.shadowGroup;n&&!k&&(k=g.shadowGroup=a.g("shadow").add(c.shadowGroup));k&&k.attr(d);f=c.pointAttribs(g,
g.selected&&"select")}g.delayedRendering?(e.setRadialReference(c.center).attr(h).attr(d),b.styledMode||e.attr(f).attr({"stroke-linejoin":"round"}).shadow(n,k),g.delayedRendering=!1):(e.setRadialReference(c.center),b.styledMode||C(!0,l,f),C(!0,l,h,d),e.animate(l));e.attr({visibility:g.visible?"inherit":"hidden"});e.addClass(g.getClassName())}else e&&(g.graphic=e.destroy())})},drawPoints:function(){var c=this.chart.renderer;this.points.forEach(function(b){b.graphic||(b.graphic=c[b.shapeType](b.shapeArgs).add(b.series.group),
b.delayedRendering=!0)})},searchPoint:H,sortByAngle:function(c,b){c.sort(function(a,d){return void 0!==a.angle&&(d.angle-a.angle)*b})},drawLegendSymbol:c.LegendSymbolMixin.drawRectangle,getCenter:f.getCenter,getSymbol:H,drawGraph:null},{init:function(){y.prototype.init.apply(this,arguments);var c=this;c.name=z(c.name,"Slice");var b=function(a){c.slice("select"===a.type)};t(c,"select",b);t(c,"unselect",b);return c},isValid:function(){return G(this.y)&&0<=this.y},setVisible:function(c,b){var a=this,
d=a.series,e=d.chart,f=d.options.ignoreHiddenPoint;b=z(b,f);c!==a.visible&&(a.visible=a.options.visible=c=void 0===c?!a.visible:c,d.options.data[d.data.indexOf(a)]=a.options,["graphic","dataLabel","connector","shadowGroup"].forEach(function(b){if(a[b])a[b][c?"show":"hide"](!0)}),a.legendItem&&e.legend.colorizeItem(a,c),c||"hover"!==a.state||a.setState(""),f&&(d.isDirty=!0),b&&e.redraw())},slice:function(c,b,a){var d=this.series;B(a,d.chart);z(b,!0);this.sliced=this.options.sliced=F(c)?c:!this.sliced;
d.options.data[d.data.indexOf(this)]=this.options;this.graphic.animate(this.getTranslate());this.shadowGroup&&this.shadowGroup.animate(this.getTranslate())},getTranslate:function(){return this.sliced?this.slicedTranslation:{translateX:0,translateY:0}},haloPath:function(c){var b=this.shapeArgs;return this.sliced||!this.visible?[]:this.series.chart.renderer.symbols.arc(b.x,b.y,b.r+c,b.r+c,{innerR:b.r-1,start:b.start,end:b.end})},connectorShapes:{fixedOffset:function(c,b,a){var d=b.breakAt;b=b.touchingSliceAt;
return["M",c.x,c.y].concat(a.softConnector?["C",c.x+("left"===c.alignment?-5:5),c.y,2*d.x-b.x,2*d.y-b.y,d.x,d.y]:["L",d.x,d.y]).concat(["L",b.x,b.y])},straight:function(c,b){b=b.touchingSliceAt;return["M",c.x,c.y,"L",b.x,b.y]},crookedLine:function(f,b,a){b=b.touchingSliceAt;var d=this.series,e=d.center[0],g=d.chart.plotWidth,h=d.chart.plotLeft;d=f.alignment;var n=this.shapeArgs.r;a=c.relativeLength(a.crookDistance,1);a="left"===d?e+n+(g+h-e-n)*(1-a):h+(e-n)*a;e=["L",a,f.y];if("left"===d?a>f.x||a<
b.x:a<f.x||a>b.x)e=[];return["M",f.x,f.y].concat(e).concat(["L",b.x,b.y])}},getConnectorPath:function(){var c=this.labelPosition,b=this.series.options.dataLabels,a=b.connectorShape,d=this.connectorShapes;d[a]&&(a=d[a]);return a.call(this,{x:c.final.x,y:c.final.y,alignment:c.alignment},c.connectorPosition,b)}});""});M(I,"parts/DataLabels.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.arrayMax,G=f.defined,z=f.extend,B=f.isArray,t=f.objectEach,v=f.pick,C=f.splat,H=c.format,
y=c.merge;f=c.noop;var h=c.relativeLength,n=c.Series,q=c.seriesTypes,g=c.stableSort;c.distribute=function(b,a,d){function e(a,b){return a.target-b.target}var f,h=!0,n=b,p=[];var u=0;var k=n.reducedLen||a;for(f=b.length;f--;)u+=b[f].size;if(u>k){g(b,function(a,b){return(b.rank||0)-(a.rank||0)});for(u=f=0;u<=k;)u+=b[f].size,f++;p=b.splice(f-1,b.length)}g(b,e);for(b=b.map(function(a){return{size:a.size,targets:[a.target],align:v(a.align,.5)}});h;){for(f=b.length;f--;)h=b[f],u=(Math.min.apply(0,h.targets)+
Math.max.apply(0,h.targets))/2,h.pos=Math.min(Math.max(0,u-h.size*h.align),a-h.size);f=b.length;for(h=!1;f--;)0<f&&b[f-1].pos+b[f-1].size>b[f].pos&&(b[f-1].size+=b[f].size,b[f-1].targets=b[f-1].targets.concat(b[f].targets),b[f-1].align=.5,b[f-1].pos+b[f-1].size>a&&(b[f-1].pos=a-b[f-1].size),b.splice(f,1),h=!0)}n.push.apply(n,p);f=0;b.some(function(b){var e=0;if(b.targets.some(function(){n[f].pos=b.pos+e;if(Math.abs(n[f].pos-n[f].target)>d)return n.slice(0,f+1).forEach(function(a){delete a.pos}),n.reducedLen=
(n.reducedLen||a)-.1*a,n.reducedLen>.1*a&&c.distribute(n,a,d),!0;e+=n[f].size;f++}))return!0});g(n,e)};n.prototype.drawDataLabels=function(){function b(a,b){var d=b.filter;return d?(b=d.operator,a=a[d.property],d=d.value,">"===b&&a>d||"<"===b&&a<d||">="===b&&a>=d||"<="===b&&a<=d||"=="===b&&a==d||"==="===b&&a===d?!0:!1):!0}function a(a,b){var d=[],c;if(B(a)&&!B(b))d=a.map(function(a){return y(a,b)});else if(B(b)&&!B(a))d=b.map(function(b){return y(a,b)});else if(B(a)||B(b))for(c=Math.max(a.length,
b.length);c--;)d[c]=y(a[c],b[c]);else d=y(a,b);return d}var d=this,e=d.chart,f=d.options,g=f.dataLabels,h=d.points,p,n=d.hasRendered||0,k=c.animObject(f.animation).duration,r=Math.min(k,200),q=!e.renderer.forExport&&v(g.defer,0<r),A=e.renderer;g=a(a(e.options.plotOptions&&e.options.plotOptions.series&&e.options.plotOptions.series.dataLabels,e.options.plotOptions&&e.options.plotOptions[d.type]&&e.options.plotOptions[d.type].dataLabels),g);c.fireEvent(this,"drawDataLabels");if(B(g)||g.enabled||d._hasPointLabels){var w=
d.plotGroup("dataLabelsGroup","data-labels",q&&!n?"hidden":"inherit",g.zIndex||6);q&&(w.attr({opacity:+n}),n||setTimeout(function(){var a=d.dataLabelsGroup;a&&(d.visible&&w.show(!0),a[f.animation?"animate":"attr"]({opacity:1},{duration:r}))},k-r));h.forEach(function(c){p=C(a(g,c.dlOptions||c.options&&c.options.dataLabels));p.forEach(function(a,g){var k=a.enabled&&(!c.isNull||c.dataLabelOnNull)&&b(c,a),h=c.dataLabels?c.dataLabels[g]:c.dataLabel,l=c.connectors?c.connectors[g]:c.connector,p=v(a.distance,
c.labelDistance),m=!h;if(k){var r=c.getLabelConfig();var n=v(a[c.formatPrefix+"Format"],a.format);r=G(n)?H(n,r,e.time):(a[c.formatPrefix+"Formatter"]||a.formatter).call(r,a);n=a.style;var u=a.rotation;e.styledMode||(n.color=v(a.color,n.color,d.color,"#000000"),"contrast"===n.color&&(c.contrastColor=A.getContrast(c.color||d.color),n.color=!G(p)&&a.inside||0>p||f.stacking?c.contrastColor:"#000000"),f.cursor&&(n.cursor=f.cursor));var q={r:a.borderRadius||0,rotation:u,padding:a.padding,zIndex:1};e.styledMode||
(q.fill=a.backgroundColor,q.stroke=a.borderColor,q["stroke-width"]=a.borderWidth);t(q,function(a,b){void 0===a&&delete q[b]})}!h||k&&G(r)?k&&G(r)&&(h?q.text=r:(c.dataLabels=c.dataLabels||[],h=c.dataLabels[g]=u?A.text(r,0,-9999).addClass("highcharts-data-label"):A.label(r,0,-9999,a.shape,null,null,a.useHTML,null,"data-label"),g||(c.dataLabel=h),h.addClass(" highcharts-data-label-color-"+c.colorIndex+" "+(a.className||"")+(a.useHTML?" highcharts-tracker":""))),h.options=a,h.attr(q),e.styledMode||h.css(n).shadow(a.shadow),
h.added||h.add(w),a.textPath&&!a.useHTML&&h.setTextPath(c.getDataLabelPath&&c.getDataLabelPath(h)||c.graphic,a.textPath),d.alignDataLabel(c,h,a,null,m)):(c.dataLabel=c.dataLabel&&c.dataLabel.destroy(),c.dataLabels&&(1===c.dataLabels.length?delete c.dataLabels:delete c.dataLabels[g]),g||delete c.dataLabel,l&&(c.connector=c.connector.destroy(),c.connectors&&(1===c.connectors.length?delete c.connectors:delete c.connectors[g])))})})}c.fireEvent(this,"afterDrawDataLabels")};n.prototype.alignDataLabel=
function(b,a,d,c,f){var e=this.chart,g=this.isCartesian&&e.inverted,h=v(b.dlBox&&b.dlBox.centerX,b.plotX,-9999),l=v(b.plotY,-9999),k=a.getBBox(),n=d.rotation,q=d.align,A=this.visible&&(b.series.forceDL||e.isInsidePlot(h,Math.round(l),g)||c&&e.isInsidePlot(h,g?c.x+1:c.y+c.height-1,g)),w="justify"===v(d.overflow,"justify");if(A){var m=e.renderer.fontMetrics(e.styledMode?void 0:d.style.fontSize,a).b;c=z({x:g?this.yAxis.len-l:h,y:Math.round(g?this.xAxis.len-h:l),width:0,height:0},c);z(d,{width:k.width,
height:k.height});n?(w=!1,h=e.renderer.rotCorr(m,n),h={x:c.x+d.x+c.width/2+h.x,y:c.y+d.y+{top:0,middle:.5,bottom:1}[d.verticalAlign]*c.height},a[f?"attr":"animate"](h).attr({align:q}),l=(n+720)%360,l=180<l&&360>l,"left"===q?h.y-=l?k.height:0:"center"===q?(h.x-=k.width/2,h.y-=k.height/2):"right"===q&&(h.x-=k.width,h.y-=l?0:k.height),a.placed=!0,a.alignAttr=h):(a.align(d,null,c),h=a.alignAttr);w&&0<=c.height?this.justifyDataLabel(a,d,h,k,c,f):v(d.crop,!0)&&(A=e.isInsidePlot(h.x,h.y)&&e.isInsidePlot(h.x+
k.width,h.y+k.height));if(d.shape&&!n)a[f?"attr":"animate"]({anchorX:g?e.plotWidth-b.plotY:b.plotX,anchorY:g?e.plotHeight-b.plotX:b.plotY})}A||(a.hide(!0),a.placed=!1)};n.prototype.justifyDataLabel=function(b,a,d,c,f,g){var e=this.chart,h=a.align,l=a.verticalAlign,k=b.box?0:b.padding||0;var n=d.x+k;if(0>n){"right"===h?(a.align="left",a.inside=!0):a.x=-n;var q=!0}n=d.x+c.width-k;n>e.plotWidth&&("left"===h?(a.align="right",a.inside=!0):a.x=e.plotWidth-n,q=!0);n=d.y+k;0>n&&("bottom"===l?(a.verticalAlign=
"top",a.inside=!0):a.y=-n,q=!0);n=d.y+c.height-k;n>e.plotHeight&&("top"===l?(a.verticalAlign="bottom",a.inside=!0):a.y=e.plotHeight-n,q=!0);q&&(b.placed=!g,b.align(a,null,f));return q};q.pie&&(q.pie.prototype.dataLabelPositioners={radialDistributionY:function(b){return b.top+b.distributeBox.pos},radialDistributionX:function(b,a,d,c){return b.getX(d<a.top+2||d>a.bottom-2?c:d,a.half,a)},justify:function(b,a,d){return d[0]+(b.half?-1:1)*(a+b.labelDistance)},alignToPlotEdges:function(b,a,d,c){b=b.getBBox().width;
return a?b+c:d-b-c},alignToConnectors:function(b,a,d,c){var e=0,f;b.forEach(function(a){f=a.dataLabel.getBBox().width;f>e&&(e=f)});return a?e+c:d-e-c}},q.pie.prototype.drawDataLabels=function(){var b=this,a=b.data,d,e=b.chart,f=b.options.dataLabels,g=f.connectorPadding,h,p=e.plotWidth,u=e.plotHeight,k=e.plotLeft,r=Math.round(e.chartWidth/3),q,A=b.center,w=A[2]/2,m=A[1],t,z,C,B,H=[[],[]],I,D,N,M,R=[0,0,0,0],P=b.dataLabelPositioners,W;b.visible&&(f.enabled||b._hasPointLabels)&&(a.forEach(function(a){a.dataLabel&&
a.visible&&a.dataLabel.shortened&&(a.dataLabel.attr({width:"auto"}).css({width:"auto",textOverflow:"clip"}),a.dataLabel.shortened=!1)}),n.prototype.drawDataLabels.apply(b),a.forEach(function(a){a.dataLabel&&(a.visible?(H[a.half].push(a),a.dataLabel._pos=null,!G(f.style.width)&&!G(a.options.dataLabels&&a.options.dataLabels.style&&a.options.dataLabels.style.width)&&a.dataLabel.getBBox().width>r&&(a.dataLabel.css({width:.7*r}),a.dataLabel.shortened=!0)):(a.dataLabel=a.dataLabel.destroy(),a.dataLabels&&
1===a.dataLabels.length&&delete a.dataLabels))}),H.forEach(function(a,h){var l=a.length,n=[],r;if(l){b.sortByAngle(a,h-.5);if(0<b.maxLabelDistance){var q=Math.max(0,m-w-b.maxLabelDistance);var x=Math.min(m+w+b.maxLabelDistance,e.plotHeight);a.forEach(function(a){0<a.labelDistance&&a.dataLabel&&(a.top=Math.max(0,m-w-a.labelDistance),a.bottom=Math.min(m+w+a.labelDistance,e.plotHeight),r=a.dataLabel.getBBox().height||21,a.distributeBox={target:a.labelPosition.natural.y-a.top+r/2,size:r,rank:a.y},n.push(a.distributeBox))});
q=x+r-q;c.distribute(n,q,q/5)}for(M=0;M<l;M++){d=a[M];C=d.labelPosition;t=d.dataLabel;N=!1===d.visible?"hidden":"inherit";D=q=C.natural.y;n&&G(d.distributeBox)&&(void 0===d.distributeBox.pos?N="hidden":(B=d.distributeBox.size,D=P.radialDistributionY(d)));delete d.positionIndex;if(f.justify)I=P.justify(d,w,A);else switch(f.alignTo){case "connectors":I=P.alignToConnectors(a,h,p,k);break;case "plotEdges":I=P.alignToPlotEdges(t,h,p,k);break;default:I=P.radialDistributionX(b,d,D,q)}t._attr={visibility:N,
align:C.alignment};t._pos={x:I+f.x+({left:g,right:-g}[C.alignment]||0),y:D+f.y-10};C.final.x=I;C.final.y=D;v(f.crop,!0)&&(z=t.getBBox().width,q=null,I-z<g&&1===h?(q=Math.round(z-I+g),R[3]=Math.max(q,R[3])):I+z>p-g&&0===h&&(q=Math.round(I+z-p+g),R[1]=Math.max(q,R[1])),0>D-B/2?R[0]=Math.max(Math.round(-D+B/2),R[0]):D+B/2>u&&(R[2]=Math.max(Math.round(D+B/2-u),R[2])),t.sideOverflow=q)}}}),0===F(R)||this.verifyDataLabelOverflow(R))&&(this.placeDataLabels(),this.points.forEach(function(a){W=y(f,a.options.dataLabels);
if(h=v(W.connectorWidth,1)){var d;q=a.connector;if((t=a.dataLabel)&&t._pos&&a.visible&&0<a.labelDistance){N=t._attr.visibility;if(d=!q)a.connector=q=e.renderer.path().addClass("highcharts-data-label-connector  highcharts-color-"+a.colorIndex+(a.className?" "+a.className:"")).add(b.dataLabelsGroup),e.styledMode||q.attr({"stroke-width":h,stroke:W.connectorColor||a.color||"#666666"});q[d?"attr":"animate"]({d:a.getConnectorPath()});q.attr("visibility",N)}else q&&(a.connector=q.destroy())}}))},q.pie.prototype.placeDataLabels=
function(){this.points.forEach(function(b){var a=b.dataLabel,d;a&&b.visible&&((d=a._pos)?(a.sideOverflow&&(a._attr.width=Math.max(a.getBBox().width-a.sideOverflow,0),a.css({width:a._attr.width+"px",textOverflow:(this.options.dataLabels.style||{}).textOverflow||"ellipsis"}),a.shortened=!0),a.attr(a._attr),a[a.moved?"animate":"attr"](d),a.moved=!0):a&&a.attr({y:-9999}));delete b.distributeBox},this)},q.pie.prototype.alignDataLabel=f,q.pie.prototype.verifyDataLabelOverflow=function(b){var a=this.center,
d=this.options,c=d.center,f=d.minSize||80,g=null!==d.size;if(!g){if(null!==c[0])var n=Math.max(a[2]-Math.max(b[1],b[3]),f);else n=Math.max(a[2]-b[1]-b[3],f),a[0]+=(b[3]-b[1])/2;null!==c[1]?n=Math.max(Math.min(n,a[2]-Math.max(b[0],b[2])),f):(n=Math.max(Math.min(n,a[2]-b[0]-b[2]),f),a[1]+=(b[0]-b[2])/2);n<a[2]?(a[2]=n,a[3]=Math.min(h(d.innerSize||0,n),n),this.translate(a),this.drawDataLabels&&this.drawDataLabels()):g=!0}return g});q.column&&(q.column.prototype.alignDataLabel=function(b,a,d,c,f){var e=
this.chart.inverted,g=b.series,h=b.dlBox||b.shapeArgs,l=v(b.below,b.plotY>v(this.translatedThreshold,g.yAxis.len)),k=v(d.inside,!!this.options.stacking);h&&(c=y(h),0>c.y&&(c.height+=c.y,c.y=0),h=c.y+c.height-g.yAxis.len,0<h&&(c.height-=h),e&&(c={x:g.yAxis.len-c.y-c.height,y:g.xAxis.len-c.x-c.width,width:c.height,height:c.width}),k||(e?(c.x+=l?0:c.width,c.width=0):(c.y+=l?c.height:0,c.height=0)));d.align=v(d.align,!e||k?"center":l?"right":"left");d.verticalAlign=v(d.verticalAlign,e||k?"middle":l?"top":
"bottom");n.prototype.alignDataLabel.call(this,b,a,d,c,f);d.inside&&b.contrastColor&&a.css({color:b.contrastColor})})});M(I,"modules/overlapping-datalabels.src.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.isArray,G=f.objectEach,z=f.pick;f=c.Chart;var B=c.addEvent,t=c.fireEvent;B(f,"render",function(){var c=[];(this.labelCollectors||[]).forEach(function(f){c=c.concat(f())});(this.yAxis||[]).forEach(function(f){f.options.stackLabels&&!f.options.stackLabels.allowOverlap&&
G(f.stacks,function(f){G(f,function(f){c.push(f.label)})})});(this.series||[]).forEach(function(f){var v=f.options.dataLabels;f.visible&&(!1!==v.enabled||f._hasPointLabels)&&f.points.forEach(function(f){f.visible&&(F(f.dataLabels)?f.dataLabels:f.dataLabel?[f.dataLabel]:[]).forEach(function(h){var n=h.options;h.labelrank=z(n.labelrank,f.labelrank,f.shapeArgs&&f.shapeArgs.height);n.allowOverlap||c.push(h)})})});this.hideOverlappingLabels(c)});f.prototype.hideOverlappingLabels=function(c){var f=this,
v=c.length,y=f.renderer,h,n,q;var g=function(a){var b=a.box?0:a.padding||0;var d=0;if(a&&(!a.alignAttr||a.placed)){var c=a.attr("x");var f=a.attr("y");c="number"===typeof c&&"number"===typeof f?{x:c,y:f}:a.alignAttr;f=a.parentGroup;a.width||(d=a.getBBox(),a.width=d.width,a.height=d.height,d=y.fontMetrics(null,a.element).h);return{x:c.x+(f.translateX||0)+b,y:c.y+(f.translateY||0)+b-d,width:a.width-2*b,height:a.height-2*b}}};for(n=0;n<v;n++)if(h=c[n])h.oldOpacity=h.opacity,h.newOpacity=1,h.absoluteBox=
g(h);c.sort(function(a,b){return(b.labelrank||0)-(a.labelrank||0)});for(n=0;n<v;n++){var b=(g=c[n])&&g.absoluteBox;for(h=n+1;h<v;++h){var a=(q=c[h])&&q.absoluteBox;!b||!a||g===q||0===g.newOpacity||0===q.newOpacity||a.x>b.x+b.width||a.x+a.width<b.x||a.y>b.y+b.height||a.y+a.height<b.y||((g.labelrank<q.labelrank?g:q).newOpacity=0)}}c.forEach(function(a){var b;if(a){var d=a.newOpacity;a.oldOpacity!==d&&(a.alignAttr&&a.placed?(d?a.show(!0):b=function(){a.hide(!0);a.placed=!1},a.alignAttr.opacity=d,a[a.isOld?
"animate":"attr"](a.alignAttr,null,b),t(f,"afterHideOverlappingLabels")):a.attr({opacity:d}));a.isOld=!0}})}});M(I,"parts/Interaction.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.defined,G=f.extend,z=f.isArray,B=f.isObject,t=f.objectEach,v=f.pick,C=c.addEvent;f=c.Chart;var H=c.createElement,y=c.css,h=c.defaultOptions,n=c.defaultPlotOptions,q=c.fireEvent,g=c.hasTouch,b=c.Legend,a=c.merge,d=c.Point,e=c.Series,l=c.seriesTypes,I=c.svg;var E=c.TrackerMixin={drawTrackerPoint:function(){var a=
this,b=a.chart,d=b.pointer,c=function(a){var b=d.getPointFromEvent(a);void 0!==b&&(d.isDirectTouch=!0,b.onMouseOver(a))},e;a.points.forEach(function(a){e=z(a.dataLabels)?a.dataLabels:a.dataLabel?[a.dataLabel]:[];a.graphic&&(a.graphic.element.point=a);e.forEach(function(b){b.div?b.div.point=a:b.element.point=a})});a._hasTracking||(a.trackerGroups.forEach(function(e){if(a[e]){a[e].addClass("highcharts-tracker").on("mouseover",c).on("mouseout",function(a){d.onTrackerMouseOut(a)});if(g)a[e].on("touchstart",
c);!b.styledMode&&a.options.cursor&&a[e].css(y).css({cursor:a.options.cursor})}}),a._hasTracking=!0);q(this,"afterDrawTracker")},drawTrackerGraph:function(){var a=this,b=a.options,d=b.trackByArea,c=[].concat(d?a.areaPath:a.graphPath),e=c.length,f=a.chart,h=f.pointer,l=f.renderer,n=f.options.tooltip.snap,v=a.tracker,t,y=function(){if(f.hoverSeries!==a)a.onMouseOver()},z="rgba(192,192,192,"+(I?.0001:.002)+")";if(e&&!d)for(t=e+1;t--;)"M"===c[t]&&c.splice(t+1,0,c[t+1]-n,c[t+2],"L"),(t&&"M"===c[t]||t===
e)&&c.splice(t,0,"L",c[t-2]+n,c[t-1]);v?v.attr({d:c}):a.graph&&(a.tracker=l.path(c).attr({visibility:a.visible?"visible":"hidden",zIndex:2}).addClass(d?"highcharts-tracker-area":"highcharts-tracker-line").add(a.group),f.styledMode||a.tracker.attr({"stroke-linejoin":"round",stroke:z,fill:d?z:"none","stroke-width":a.graph.strokeWidth()+(d?0:2*n)}),[a.tracker,a.markerGroup].forEach(function(a){a.addClass("highcharts-tracker").on("mouseover",y).on("mouseout",function(a){h.onTrackerMouseOut(a)});b.cursor&&
!f.styledMode&&a.css({cursor:b.cursor});if(g)a.on("touchstart",y)}));q(this,"afterDrawTracker")}};l.column&&(l.column.prototype.drawTracker=E.drawTrackerPoint);l.pie&&(l.pie.prototype.drawTracker=E.drawTrackerPoint);l.scatter&&(l.scatter.prototype.drawTracker=E.drawTrackerPoint);G(b.prototype,{setItemEvents:function(b,c,e){var f=this,g=f.chart.renderer.boxWrapper,k=b instanceof d,h="highcharts-legend-"+(k?"point":"series")+"-active",l=f.chart.styledMode;(e?c:b.legendGroup).on("mouseover",function(){b.visible&&
f.allItems.forEach(function(a){b!==a&&a.setState("inactive",!k)});b.setState("hover");b.visible&&g.addClass(h);l||c.css(f.options.itemHoverStyle)}).on("mouseout",function(){f.chart.styledMode||c.css(a(b.visible?f.itemStyle:f.itemHiddenStyle));f.allItems.forEach(function(a){b!==a&&a.setState("",!k)});g.removeClass(h);b.setState()}).on("click",function(a){var c=function(){b.setVisible&&b.setVisible();f.allItems.forEach(function(a){b!==a&&a.setState(b.visible?"inactive":"",!k)})};g.removeClass(h);a=
{browserEvent:a};b.firePointEvent?b.firePointEvent("legendItemClick",a,c):q(b,"legendItemClick",a,c)})},createCheckboxForItem:function(a){a.checkbox=H("input",{type:"checkbox",className:"highcharts-legend-checkbox",checked:a.selected,defaultChecked:a.selected},this.options.itemCheckboxStyle,this.chart.container);C(a.checkbox,"click",function(b){q(a.series||a,"checkboxClick",{checked:b.target.checked,item:a},function(){a.select()})})}});G(f.prototype,{showResetZoom:function(){function a(){b.zoomOut()}
var b=this,c=h.lang,d=b.options.chart.resetZoomButton,e=d.theme,f=e.states,g="chart"===d.relativeTo||"spaceBox"===d.relativeTo?null:"plotBox";q(this,"beforeShowResetZoom",null,function(){b.resetZoomButton=b.renderer.button(c.resetZoom,null,null,a,e,f&&f.hover).attr({align:d.position.align,title:c.resetZoomTitle}).addClass("highcharts-reset-zoom").add().align(d.position,!1,g)});q(this,"afterShowResetZoom")},zoomOut:function(){q(this,"selection",{resetSelection:!0},this.zoom)},zoom:function(a){var b=
this,c,d=b.pointer,e=!1,f=b.inverted?d.mouseDownX:d.mouseDownY;!a||a.resetSelection?(b.axes.forEach(function(a){c=a.zoom()}),d.initiated=!1):a.xAxis.concat(a.yAxis).forEach(function(a){var g=a.axis,k=b.inverted?g.left:g.top,h=b.inverted?k+g.width:k+g.height,l=g.isXAxis,m=!1;if(!l&&f>=k&&f<=h||l||!F(f))m=!0;d[l?"zoomX":"zoomY"]&&m&&(c=g.zoom(a.min,a.max),g.displayBtn&&(e=!0))});var g=b.resetZoomButton;e&&!g?b.showResetZoom():!e&&B(g)&&(b.resetZoomButton=g.destroy());c&&b.redraw(v(b.options.chart.animation,
a&&a.animation,100>b.pointCount))},pan:function(a,b){var c=this,d=c.hoverPoints,e;q(this,"pan",{originalEvent:a},function(){d&&d.forEach(function(a){a.setState()});("xy"===b?[1,0]:[1]).forEach(function(b){b=c[b?"xAxis":"yAxis"][0];var d=b.horiz,f=a[d?"chartX":"chartY"];d=d?"mouseDownX":"mouseDownY";var g=c[d],k=(b.pointRange||0)/2,h=b.reversed&&!c.inverted||!b.reversed&&c.inverted?-1:1,l=b.getExtremes(),p=b.toValue(g-f,!0)+k*h;h=b.toValue(g+b.len-f,!0)-k*h;var n=h<p;g=n?h:p;p=n?p:h;h=Math.min(l.dataMin,
k?l.min:b.toValue(b.toPixels(l.min)-b.minPixelPadding));k=Math.max(l.dataMax,k?l.max:b.toValue(b.toPixels(l.max)+b.minPixelPadding));n=h-g;0<n&&(p+=n,g=h);n=p-k;0<n&&(p=k,g-=n);b.series.length&&g!==l.min&&p!==l.max&&(b.setExtremes(g,p,!1,!1,{trigger:"pan"}),e=!0);c[d]=f});e&&c.redraw(!1);y(c.container,{cursor:"move"})})}});G(d.prototype,{select:function(a,b){var c=this,d=c.series,e=d.chart;this.selectedStaging=a=v(a,!c.selected);c.firePointEvent(a?"select":"unselect",{accumulate:b},function(){c.selected=
c.options.selected=a;d.options.data[d.data.indexOf(c)]=c.options;c.setState(a&&"select");b||e.getSelectedPoints().forEach(function(a){var b=a.series;a.selected&&a!==c&&(a.selected=a.options.selected=!1,b.options.data[b.data.indexOf(a)]=a.options,a.setState(e.hoverPoints&&b.options.inactiveOtherPoints?"inactive":""),a.firePointEvent("unselect"))})});delete this.selectedStaging},onMouseOver:function(a){var b=this.series.chart,c=b.pointer;a=a?c.normalize(a):c.getChartCoordinatesFromPoint(this,b.inverted);
c.runPointActions(a,this)},onMouseOut:function(){var a=this.series.chart;this.firePointEvent("mouseOut");this.series.options.inactiveOtherPoints||(a.hoverPoints||[]).forEach(function(a){a.setState()});a.hoverPoints=a.hoverPoint=null},importEvents:function(){if(!this.hasImportedEvents){var b=this,d=a(b.series.options.point,b.options).events;b.events=d;t(d,function(a,d){c.isFunction(a)&&C(b,d,a)});this.hasImportedEvents=!0}},setState:function(a,b){var c=this.series,d=this.state,e=c.options.states[a||
"normal"]||{},f=n[c.type].marker&&c.options.marker,g=f&&!1===f.enabled,h=f&&f.states&&f.states[a||"normal"]||{},l=!1===h.enabled,p=c.stateMarkerGraphic,u=this.marker||{},t=c.chart,y=c.halo,z,B=f&&c.markerAttribs;a=a||"";if(!(a===this.state&&!b||this.selected&&"select"!==a||!1===e.enabled||a&&(l||g&&!1===h.enabled)||a&&u.states&&u.states[a]&&!1===u.states[a].enabled)){this.state=a;B&&(z=c.markerAttribs(this,a));if(this.graphic){d&&this.graphic.removeClass("highcharts-point-"+d);a&&this.graphic.addClass("highcharts-point-"+
a);if(!t.styledMode){var C=c.pointAttribs(this,a);var H=v(t.options.chart.animation,e.animation);c.options.inactiveOtherPoints&&((this.dataLabels||[]).forEach(function(a){a&&a.animate({opacity:C.opacity},H)}),this.connector&&this.connector.animate({opacity:C.opacity},H));this.graphic.animate(C,H)}z&&this.graphic.animate(z,v(t.options.chart.animation,h.animation,f.animation));p&&p.hide()}else{if(a&&h){d=u.symbol||c.symbol;p&&p.currentSymbol!==d&&(p=p.destroy());if(z)if(p)p[b?"animate":"attr"]({x:z.x,
y:z.y});else d&&(c.stateMarkerGraphic=p=t.renderer.symbol(d,z.x,z.y,z.width,z.height).add(c.markerGroup),p.currentSymbol=d);!t.styledMode&&p&&p.attr(c.pointAttribs(this,a))}p&&(p[a&&this.isInside?"show":"hide"](),p.element.point=this)}a=e.halo;e=(p=this.graphic||p)&&p.visibility||"inherit";a&&a.size&&p&&"hidden"!==e?(y||(c.halo=y=t.renderer.path().add(p.parentGroup)),y.show()[b?"animate":"attr"]({d:this.haloPath(a.size)}),y.attr({"class":"highcharts-halo highcharts-color-"+v(this.colorIndex,c.colorIndex)+
(this.className?" "+this.className:""),visibility:e,zIndex:-1}),y.point=this,t.styledMode||y.attr(G({fill:this.color||c.color,"fill-opacity":a.opacity},a.attributes))):y&&y.point&&y.point.haloPath&&y.animate({d:y.point.haloPath(0)},null,y.hide);q(this,"afterSetState")}},haloPath:function(a){return this.series.chart.renderer.symbols.circle(Math.floor(this.plotX)-a,this.plotY-a,2*a,2*a)}});G(e.prototype,{onMouseOver:function(){var a=this.chart,b=a.hoverSeries;if(b&&b!==this)b.onMouseOut();this.options.events.mouseOver&&
q(this,"mouseOver");this.setState("hover");a.hoverSeries=this},onMouseOut:function(){var a=this.options,b=this.chart,c=b.tooltip,d=b.hoverPoint;b.hoverSeries=null;if(d)d.onMouseOut();this&&a.events.mouseOut&&q(this,"mouseOut");!c||this.stickyTracking||c.shared&&!this.noSharedTooltip||c.hide();b.series.forEach(function(a){a.setState("",!0)})},setState:function(a,b){var c=this,d=c.options,e=c.graph,f=d.inactiveOtherPoints,g=d.states,h=d.lineWidth,l=d.opacity,n=v(g[a||"normal"]&&g[a||"normal"].animation,
c.chart.options.chart.animation);d=0;a=a||"";if(c.state!==a&&([c.group,c.markerGroup,c.dataLabelsGroup].forEach(function(b){b&&(c.state&&b.removeClass("highcharts-series-"+c.state),a&&b.addClass("highcharts-series-"+a))}),c.state=a,!c.chart.styledMode)){if(g[a]&&!1===g[a].enabled)return;a&&(h=g[a].lineWidth||h+(g[a].lineWidthPlus||0),l=v(g[a].opacity,l));if(e&&!e.dashstyle)for(g={"stroke-width":h},e.animate(g,n);c["zone-graph-"+d];)c["zone-graph-"+d].attr(g),d+=1;f||[c.group,c.markerGroup,c.dataLabelsGroup,
c.labelBySeries].forEach(function(a){a&&a.animate({opacity:l},n)})}b&&f&&c.points&&c.setAllPointsToState(a)},setAllPointsToState:function(a){this.points.forEach(function(b){b.setState&&b.setState(a)})},setVisible:function(a,b){var c=this,d=c.chart,e=c.legendItem,f=d.options.chart.ignoreHiddenSeries,g=c.visible;var h=(c.visible=a=c.options.visible=c.userOptions.visible=void 0===a?!g:a)?"show":"hide";["group","dataLabelsGroup","markerGroup","tracker","tt"].forEach(function(a){if(c[a])c[a][h]()});if(d.hoverSeries===
c||(d.hoverPoint&&d.hoverPoint.series)===c)c.onMouseOut();e&&d.legend.colorizeItem(c,a);c.isDirty=!0;c.options.stacking&&d.series.forEach(function(a){a.options.stacking&&a.visible&&(a.isDirty=!0)});c.linkedSeries.forEach(function(b){b.setVisible(a,!1)});f&&(d.isDirtyBox=!0);q(c,h);!1!==b&&d.redraw()},show:function(){this.setVisible(!0)},hide:function(){this.setVisible(!1)},select:function(a){this.selected=a=this.options.selected=void 0===a?!this.selected:a;this.checkbox&&(this.checkbox.checked=a);
q(this,a?"select":"unselect")},drawTracker:E.drawTrackerGraph})});M(I,"parts/Responsive.js",[I["parts/Globals.js"],I["parts/Utilities.js"]],function(c,f){var F=f.isArray,G=f.isObject,z=f.objectEach,B=f.pick,t=f.splat;f=c.Chart;f.prototype.setResponsive=function(f,t){var v=this.options.responsive,y=[],h=this.currentResponsive;!t&&v&&v.rules&&v.rules.forEach(function(f){void 0===f._id&&(f._id=c.uniqueKey());this.matchResponsiveRule(f,y)},this);t=c.merge.apply(0,y.map(function(f){return c.find(v.rules,
function(c){return c._id===f}).chartOptions}));t.isResponsiveOptions=!0;y=y.toString()||void 0;y!==(h&&h.ruleIds)&&(h&&this.update(h.undoOptions,f,!0),y?(h=this.currentOptions(t),h.isResponsiveOptions=!0,this.currentResponsive={ruleIds:y,mergedOptions:t,undoOptions:h},this.update(t,f,!0)):this.currentResponsive=void 0)};f.prototype.matchResponsiveRule=function(c,f){var t=c.condition;(t.callback||function(){return this.chartWidth<=B(t.maxWidth,Number.MAX_VALUE)&&this.chartHeight<=B(t.maxHeight,Number.MAX_VALUE)&&
this.chartWidth>=B(t.minWidth,0)&&this.chartHeight>=B(t.minHeight,0)}).call(this)&&f.push(c._id)};f.prototype.currentOptions=function(c){function f(c,n,q,g){var b;z(c,function(a,c){if(!g&&-1<v.collectionsWithUpdate.indexOf(c))for(a=t(a),q[c]=[],b=0;b<a.length;b++)n[c][b]&&(q[c][b]={},f(a[b],n[c][b],q[c][b],g+1));else G(a)?(q[c]=F(a)?[]:{},f(a,n[c]||{},q[c],g+1)):q[c]=void 0===n[c]?null:n[c]})}var v=this,y={};f(c,this.options,y,0);return y}});M(I,"masters/highcharts.src.js",[I["parts/Globals.js"],
I["parts/Utilities.js"]],function(c,f){var F=f.extend;F(c,{arrayMax:f.arrayMax,arrayMin:f.arrayMin,attr:f.attr,defined:f.defined,erase:f.erase,extend:f.extend,isArray:f.isArray,isClass:f.isClass,isDOMElement:f.isDOMElement,isNumber:f.isNumber,isObject:f.isObject,isString:f.isString,objectEach:f.objectEach,pick:f.pick,pInt:f.pInt,setAnimation:f.setAnimation,splat:f.splat,syncTimeout:f.syncTimeout});return c});I["masters/highcharts.src.js"]._modules=I;return I["masters/highcharts.src.js"]});



/*
 Highcharts JS v7.2.1 (2019-10-31)

 (c) 2009-2018 Torstein Honsi

 License: www.highcharts.com/license
*/
(function(u){"object"===typeof module&&module.exports?(u["default"]=u,module.exports=u):"function"===typeof define&&define.amd?define("highcharts/highcharts-more",["highcharts"],function(B){u(B);u.Highcharts=B;return u}):u("undefined"!==typeof Highcharts?Highcharts:void 0)})(function(u){function B(b,a,h,g){b.hasOwnProperty(a)||(b[a]=g.apply(null,h))}u=u?u._modules:{};B(u,"parts-more/Pane.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){function h(e,c){this.init(e,c)}var g=a.extend,
m=a.splat,n=b.CenteredSeriesMixin,q=b.merge;g(h.prototype,{coll:"pane",init:function(e,c){this.chart=c;this.background=[];c.pane.push(this);this.setOptions(e)},setOptions:function(e){this.options=q(this.defaultOptions,this.chart.angular?{background:{}}:void 0,e)},render:function(){var e=this.options,c=this.options.background,a=this.chart.renderer;this.group||(this.group=a.g("pane-group").attr({zIndex:e.zIndex||0}).add());this.updateCenter();if(c)for(c=m(c),e=Math.max(c.length,this.background.length||
0),a=0;a<e;a++)c[a]&&this.axis?this.renderBackground(q(this.defaultBackgroundOptions,c[a]),a):this.background[a]&&(this.background[a]=this.background[a].destroy(),this.background.splice(a,1))},renderBackground:function(a,c){var e="animate",v={"class":"highcharts-pane "+(a.className||"")};this.chart.styledMode||g(v,{fill:a.backgroundColor,stroke:a.borderColor,"stroke-width":a.borderWidth});this.background[c]||(this.background[c]=this.chart.renderer.path().add(this.group),e="attr");this.background[c][e]({d:this.axis.getPlotBandPath(a.from,
a.to,a)}).attr(v)},defaultOptions:{center:["50%","50%"],size:"85%",startAngle:0},defaultBackgroundOptions:{shape:"circle",borderWidth:1,borderColor:"#cccccc",backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#ffffff"],[1,"#e6e6e6"]]},from:-Number.MAX_VALUE,innerRadius:0,to:Number.MAX_VALUE,outerRadius:"105%"},updateCenter:function(a){this.center=(a||this.axis||{}).center=n.getCenter.call(this)},update:function(a,c){q(!0,this.options,a);q(!0,this.chart.options.pane,a);this.setOptions(this.options);
this.render();this.chart.axes.forEach(function(a){a.pane===this&&(a.pane=null,a.update({},c))},this)}});b.Pane=h});B(u,"parts-more/RadialAxis.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.extend,g=a.pick,m=a.pInt;a=b.addEvent;var n=b.Axis,q=b.merge,e=b.noop,c=b.Tick,f=b.wrap,v=b.correctFloat,t=n.prototype,p=c.prototype;var x={getOffset:e,redraw:function(){this.isDirty=!1},render:function(){this.isDirty=!1},createLabelCollector:function(){return!1},setScale:e,setCategories:e,
setTitle:e};var z={defaultRadialGaugeOptions:{labels:{align:"center",x:0,y:null},minorGridLineWidth:0,minorTickInterval:"auto",minorTickLength:10,minorTickPosition:"inside",minorTickWidth:1,tickLength:10,tickPosition:"inside",tickWidth:2,title:{rotation:0},zIndex:2},defaultRadialXOptions:{gridLineWidth:1,labels:{align:null,distance:15,x:0,y:null,style:{textOverflow:"none"}},maxPadding:0,minPadding:0,showLastLabel:!1,tickLength:0},defaultRadialYOptions:{gridLineInterpolation:"circle",labels:{align:"right",
x:-3,y:-2},showLastLabel:!1,title:{x:4,text:null,rotation:90}},setOptions:function(l){l=this.options=q(this.defaultOptions,this.defaultRadialOptions,l);l.plotBands||(l.plotBands=[]);b.fireEvent(this,"afterSetOptions")},getOffset:function(){t.getOffset.call(this);this.chart.axisOffset[this.side]=0},getLinePath:function(l,d){l=this.center;var k=this.chart,r=g(d,l[2]/2-this.offset);this.isCircular||void 0!==d?(d=this.chart.renderer.symbols.arc(this.left+l[0],this.top+l[1],r,r,{start:this.startAngleRad,
end:this.endAngleRad,open:!0,innerR:0}),d.xBounds=[this.left+l[0]],d.yBounds=[this.top+l[1]-r]):(d=this.postTranslate(this.angleRad,r),d=["M",l[0]+k.plotLeft,l[1]+k.plotTop,"L",d.x,d.y]);return d},setAxisTranslation:function(){t.setAxisTranslation.call(this);this.center&&(this.transA=this.isCircular?(this.endAngleRad-this.startAngleRad)/(this.max-this.min||1):this.center[2]/2/(this.max-this.min||1),this.minPixelPadding=this.isXAxis?this.transA*this.minPointOffset:0)},beforeSetTickPositions:function(){if(this.autoConnect=
this.isCircular&&void 0===g(this.userMax,this.options.max)&&v(this.endAngleRad-this.startAngleRad)===v(2*Math.PI))this.max+=this.categories&&1||this.pointRange||this.closestPointRange||0},setAxisSize:function(){t.setAxisSize.call(this);this.isRadial&&(this.pane.updateCenter(this),this.isCircular&&(this.sector=this.endAngleRad-this.startAngleRad),this.len=this.width=this.height=this.center[2]*g(this.sector,1)/2)},getPosition:function(l,d){return this.postTranslate(this.isCircular?this.translate(l):
this.angleRad,g(this.isCircular?d:this.translate(l),this.center[2]/2)-this.offset)},postTranslate:function(l,d){var k=this.chart,r=this.center;l=this.startAngleRad+l;return{x:k.plotLeft+r[0]+Math.cos(l)*d,y:k.plotTop+r[1]+Math.sin(l)*d}},getPlotBandPath:function(l,d,k){var r=this.center,w=this.startAngleRad,c=r[2]/2,a=[g(k.outerRadius,"100%"),k.innerRadius,g(k.thickness,10)],e=Math.min(this.offset,0),v=/%$/;var p=this.isCircular;if("polygon"===this.options.gridLineInterpolation)a=this.getPlotLinePath({value:l}).concat(this.getPlotLinePath({value:d,
reverse:!0}));else{l=Math.max(l,this.min);d=Math.min(d,this.max);p||(a[0]=this.translate(l),a[1]=this.translate(d));a=a.map(function(d){v.test(d)&&(d=m(d,10)*c/100);return d});if("circle"!==k.shape&&p)l=w+this.translate(l),d=w+this.translate(d);else{l=-Math.PI/2;d=1.5*Math.PI;var t=!0}a[0]-=e;a[2]-=e;a=this.chart.renderer.symbols.arc(this.left+r[0],this.top+r[1],a[0],a[0],{start:Math.min(l,d),end:Math.max(l,d),innerR:g(a[1],a[0]-a[2]),open:t});p&&(p=(d+l)/2,e=this.left+r[0]+r[2]/2*Math.cos(p),a.xBounds=
p>-Math.PI/2&&p<Math.PI/2?[e,this.chart.plotWidth]:[0,e],a.yBounds=[this.top+r[1]+r[2]/2*Math.sin(p)],a.yBounds[0]+=p>-Math.PI&&0>p||p>Math.PI?-10:10)}return a},getPlotLinePath:function(c){var d=this,k=d.center,r=d.chart,w=c.value;c=c.reverse;var l=d.getPosition(w),a=d.pane.options.background?d.pane.options.background[0]||d.pane.options.background:{},e=a.innerRadius||"0%",p=a.outerRadius||"100%";a=k[0]+r.plotLeft;k=k[1]+r.plotTop;var v=l.x;l=l.y;var t,f;if(d.isCircular){r="string"===typeof e?b.relativeLength(e,
1):e/Math.sqrt(Math.pow(v-a,2)+Math.pow(l-k,2));c="string"===typeof p?b.relativeLength(p,1):p/Math.sqrt(Math.pow(v-a,2)+Math.pow(l-k,2));var g=["M",a+r*(v-a),k-r*(k-l),"L",v-(1-c)*(v-a),l+(1-c)*(k-l)]}else"circle"===d.options.gridLineInterpolation?(w=d.translate(w),g=d.getLinePath(0,w)):(r.xAxis.forEach(function(k){k.pane===d.pane&&(t=k)}),g=[],w=d.translate(w),r=t.tickPositions,t.autoConnect&&(r=r.concat([r[0]])),c&&(r=[].concat(r).reverse()),r.forEach(function(d,k){f=t.getPosition(d,w);g.push(k?
"L":"M",f.x,f.y)}));return g},getTitlePosition:function(){var c=this.center,d=this.chart,k=this.options.title;return{x:d.plotLeft+c[0]+(k.x||0),y:d.plotTop+c[1]-{high:.5,middle:.25,low:0}[k.align]*c[2]+(k.y||0)}},createLabelCollector:function(){var c=this;return function(){if(c.isRadial&&c.tickPositions&&!0!==c.options.labels.allowOverlap)return c.tickPositions.map(function(d){return c.ticks[d]&&c.ticks[d].label}).filter(function(d){return!!d})}}};a(n,"init",function(c){var d=this.chart,k=d.angular,
r=d.polar,w=this.isXAxis,a=k&&w,l,e=d.options;c=c.userOptions.pane||0;c=this.pane=d.pane&&d.pane[c];if("colorAxis"===this.coll)this.isRadial=!1;else{if(k){if(h(this,a?x:z),l=!w)this.defaultRadialOptions=this.defaultRadialGaugeOptions}else r&&(h(this,z),this.defaultRadialOptions=(l=w)?this.defaultRadialXOptions:q(this.defaultYAxisOptions,this.defaultRadialYOptions));k||r?(this.isRadial=!0,d.inverted=!1,e.chart.zoomType=null,this.labelCollector||(this.labelCollector=this.createLabelCollector()),this.labelCollector&&
d.labelCollectors.push(this.labelCollector)):this.isRadial=!1;c&&l&&(c.axis=this);this.isCircular=l}});a(n,"afterInit",function(){var c=this.chart,d=this.options,k=this.pane,r=k&&k.options;c.angular&&this.isXAxis||!k||!c.angular&&!c.polar||(this.angleRad=(d.angle||0)*Math.PI/180,this.startAngleRad=(r.startAngle-90)*Math.PI/180,this.endAngleRad=(g(r.endAngle,r.startAngle+360)-90)*Math.PI/180,this.offset=d.offset||0)});a(n,"autoLabelAlign",function(c){this.isRadial&&(c.align=void 0,c.preventDefault())});
a(n,"destroy",function(){if(this.chart&&this.chart.labelCollectors){var c=this.chart.labelCollectors.indexOf(this.labelCollector);0<=c&&this.chart.labelCollectors.splice(c,1)}});a(c,"afterGetPosition",function(c){this.axis.getPosition&&h(c.pos,this.axis.getPosition(this.pos))});a(c,"afterGetLabelPosition",function(c){var d=this.axis,k=this.label,r=k.getBBox(),w=d.options.labels,a=w.y,l=20,e=w.align,v=(d.translate(this.pos)+d.startAngleRad+Math.PI/2)/Math.PI*180%360,p=Math.round(v),t="end",f=0>p?p+
360:p,m=f,h=0,n=0,z=null===w.y?.3*-r.height:0;if(d.isRadial){var x=d.getPosition(this.pos,d.center[2]/2+b.relativeLength(g(w.distance,-25),d.center[2]/2,-d.center[2]/2));"auto"===w.rotation?k.attr({rotation:v}):null===a&&(a=d.chart.renderer.fontMetrics(k.styles&&k.styles.fontSize).b-r.height/2);null===e&&(d.isCircular?(r.width>d.len*d.tickInterval/(d.max-d.min)&&(l=0),e=v>l&&v<180-l?"left":v>180+l&&v<360-l?"right":"center"):e="center",k.attr({align:e}));if("auto"===e&&2===d.tickPositions.length&&
d.isCircular){90<f&&180>f?f=180-f:270<f&&360>=f&&(f=540-f);180<m&&360>=m&&(m=360-m);if(d.pane.options.startAngle===p||d.pane.options.startAngle===p+360||d.pane.options.startAngle===p-360)t="start";e=-90<=p&&90>=p||-360<=p&&-270>=p||270<=p&&360>=p?"start"===t?"right":"left":"start"===t?"left":"right";70<m&&110>m&&(e="center");15>f||180<=f&&195>f?h=.3*r.height:15<=f&&35>=f?h="start"===t?0:.75*r.height:195<=f&&215>=f?h="start"===t?.75*r.height:0:35<f&&90>=f?h="start"===t?.25*-r.height:r.height:215<f&&
270>=f&&(h="start"===t?r.height:.25*-r.height);15>m?n="start"===t?.15*-r.height:.15*r.height:165<m&&180>=m&&(n="start"===t?.15*r.height:.15*-r.height);k.attr({align:e});k.translate(n,h+z)}c.pos.x=x.x+w.x;c.pos.y=x.y+a}});f(p,"getMarkPath",function(c,d,k,r,w,a,e){var l=this.axis;l.isRadial?(c=l.getPosition(this.pos,l.center[2]/2+r),d=["M",d,k,"L",c.x,c.y]):d=c.call(this,d,k,r,w,a,e);return d})});B(u,"parts-more/AreaRangeSeries.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=
a.defined,g=a.extend,m=a.isArray,n=a.isNumber,q=a.pick;a=b.seriesType;var e=b.seriesTypes,c=b.Series.prototype,f=b.Point.prototype;a("arearange","area",{lineWidth:1,threshold:null,tooltip:{pointFormat:'<span style="color:{series.color}">\u25cf</span> {series.name}: <b>{point.low}</b> - <b>{point.high}</b><br/>'},trackByArea:!0,dataLabels:{align:null,verticalAlign:null,xLow:0,xHigh:0,yLow:0,yHigh:0}},{pointArrayMap:["low","high"],pointValKey:"low",deferTranslatePolar:!0,toYData:function(c){return[c.low,
c.high]},highToXY:function(c){var a=this.chart,e=this.xAxis.postTranslate(c.rectPlotX,this.yAxis.len-c.plotHigh);c.plotHighX=e.x-a.plotLeft;c.plotHigh=e.y-a.plotTop;c.plotLowX=c.plotX},translate:function(){var c=this,a=c.yAxis,p=!!c.modifyValue;e.area.prototype.translate.apply(c);c.points.forEach(function(e){var f=e.high,l=e.plotY;e.isNull?e.plotY=null:(e.plotLow=l,e.plotHigh=a.translate(p?c.modifyValue(f,e):f,0,1,0,1),p&&(e.yBottom=e.plotHigh))});this.chart.polar&&this.points.forEach(function(a){c.highToXY(a);
a.tooltipPos=[(a.plotHighX+a.plotLowX)/2,(a.plotHigh+a.plotLow)/2]})},getGraphPath:function(c){var a=[],p=[],f,g=e.area.prototype.getGraphPath;var l=this.options;var d=this.chart.polar&&!1!==l.connectEnds,k=l.connectNulls,r=l.step;c=c||this.points;for(f=c.length;f--;){var w=c[f];w.isNull||d||k||c[f+1]&&!c[f+1].isNull||p.push({plotX:w.plotX,plotY:w.plotY,doCurve:!1});var F={polarPlotY:w.polarPlotY,rectPlotX:w.rectPlotX,yBottom:w.yBottom,plotX:q(w.plotHighX,w.plotX),plotY:w.plotHigh,isNull:w.isNull};
p.push(F);a.push(F);w.isNull||d||k||c[f-1]&&!c[f-1].isNull||p.push({plotX:w.plotX,plotY:w.plotY,doCurve:!1})}c=g.call(this,c);r&&(!0===r&&(r="left"),l.step={left:"right",center:"center",right:"left"}[r]);a=g.call(this,a);p=g.call(this,p);l.step=r;l=[].concat(c,a);this.chart.polar||"M"!==p[0]||(p[0]="L");this.graphPath=l;this.areaPath=c.concat(p);l.isArea=!0;l.xMap=c.xMap;this.areaPath.xMap=c.xMap;return l},drawDataLabels:function(){var a=this.points,e=a.length,f,b=[],h=this.options.dataLabels,l,d=
this.chart.inverted;if(m(h))if(1<h.length){var k=h[0];var r=h[1]}else k=h[0],r={enabled:!1};else k=g({},h),k.x=h.xHigh,k.y=h.yHigh,r=g({},h),r.x=h.xLow,r.y=h.yLow;if(k.enabled||this._hasPointLabels){for(f=e;f--;)if(l=a[f]){var w=k.inside?l.plotHigh<l.plotLow:l.plotHigh>l.plotLow;l.y=l.high;l._plotY=l.plotY;l.plotY=l.plotHigh;b[f]=l.dataLabel;l.dataLabel=l.dataLabelUpper;l.below=w;d?k.align||(k.align=w?"right":"left"):k.verticalAlign||(k.verticalAlign=w?"top":"bottom")}this.options.dataLabels=k;c.drawDataLabels&&
c.drawDataLabels.apply(this,arguments);for(f=e;f--;)if(l=a[f])l.dataLabelUpper=l.dataLabel,l.dataLabel=b[f],delete l.dataLabels,l.y=l.low,l.plotY=l._plotY}if(r.enabled||this._hasPointLabels){for(f=e;f--;)if(l=a[f])w=r.inside?l.plotHigh<l.plotLow:l.plotHigh>l.plotLow,l.below=!w,d?r.align||(r.align=w?"left":"right"):r.verticalAlign||(r.verticalAlign=w?"bottom":"top");this.options.dataLabels=r;c.drawDataLabels&&c.drawDataLabels.apply(this,arguments)}if(k.enabled)for(f=e;f--;)if(l=a[f])l.dataLabels=[l.dataLabelUpper,
l.dataLabel].filter(function(d){return!!d});this.options.dataLabels=h},alignDataLabel:function(){e.column.prototype.alignDataLabel.apply(this,arguments)},drawPoints:function(){var a=this.points.length,e;c.drawPoints.apply(this,arguments);for(e=0;e<a;){var f=this.points[e];f.origProps={plotY:f.plotY,plotX:f.plotX,isInside:f.isInside,negative:f.negative,zone:f.zone,y:f.y};f.lowerGraphic=f.graphic;f.graphic=f.upperGraphic;f.plotY=f.plotHigh;h(f.plotHighX)&&(f.plotX=f.plotHighX);f.y=f.high;f.negative=
f.high<(this.options.threshold||0);f.zone=this.zones.length&&f.getZone();this.chart.polar||(f.isInside=f.isTopInside=void 0!==f.plotY&&0<=f.plotY&&f.plotY<=this.yAxis.len&&0<=f.plotX&&f.plotX<=this.xAxis.len);e++}c.drawPoints.apply(this,arguments);for(e=0;e<a;)f=this.points[e],f.upperGraphic=f.graphic,f.graphic=f.lowerGraphic,g(f,f.origProps),delete f.origProps,e++},setStackedPoints:b.noop},{setState:function(){var c=this.state,a=this.series,e=a.chart.polar;h(this.plotHigh)||(this.plotHigh=a.yAxis.toPixels(this.high,
!0));h(this.plotLow)||(this.plotLow=this.plotY=a.yAxis.toPixels(this.low,!0));a.stateMarkerGraphic&&(a.lowerStateMarkerGraphic=a.stateMarkerGraphic,a.stateMarkerGraphic=a.upperStateMarkerGraphic);this.graphic=this.upperGraphic;this.plotY=this.plotHigh;e&&(this.plotX=this.plotHighX);f.setState.apply(this,arguments);this.state=c;this.plotY=this.plotLow;this.graphic=this.lowerGraphic;e&&(this.plotX=this.plotLowX);a.stateMarkerGraphic&&(a.upperStateMarkerGraphic=a.stateMarkerGraphic,a.stateMarkerGraphic=
a.lowerStateMarkerGraphic,a.lowerStateMarkerGraphic=void 0);f.setState.apply(this,arguments)},haloPath:function(){var c=this.series.chart.polar,a=[];this.plotY=this.plotLow;c&&(this.plotX=this.plotLowX);this.isInside&&(a=f.haloPath.apply(this,arguments));this.plotY=this.plotHigh;c&&(this.plotX=this.plotHighX);this.isTopInside&&(a=a.concat(f.haloPath.apply(this,arguments)));return a},destroyElements:function(){["lowerGraphic","upperGraphic"].forEach(function(c){this[c]&&(this[c]=this[c].destroy())},
this);this.graphic=null;return f.destroyElements.apply(this,arguments)},isValid:function(){return n(this.low)&&n(this.high)}});""});B(u,"parts-more/AreaSplineRangeSeries.js",[u["parts/Globals.js"]],function(b){var a=b.seriesType;a("areasplinerange","arearange",null,{getPointSpline:b.seriesTypes.spline.prototype.getPointSpline});""});B(u,"parts-more/ColumnRangeSeries.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.pick;a=b.defaultPlotOptions;var g=b.merge,m=b.noop,n=b.seriesType,
q=b.seriesTypes.column.prototype;n("columnrange","arearange",g(a.column,a.arearange,{pointRange:null,marker:null,states:{hover:{halo:!1}}}),{translate:function(){var a=this,c=a.yAxis,f=a.xAxis,g=f.startAngleRad,m,b=a.chart,n=a.xAxis.isRadial,z=Math.max(b.chartWidth,b.chartHeight)+999,l;q.translate.apply(a);a.points.forEach(function(d){var k=d.shapeArgs,r=a.options.minPointLength;d.plotHigh=l=Math.min(Math.max(-z,c.translate(d.high,0,1,0,1)),z);d.plotLow=Math.min(Math.max(-z,d.plotY),z);var w=l;var e=
h(d.rectPlotY,d.plotY)-l;Math.abs(e)<r?(r-=e,e+=r,w-=r/2):0>e&&(e*=-1,w-=e);n?(m=d.barX+g,d.shapeType="path",d.shapeArgs={d:a.polarArc(w+e,w,m,m+d.pointWidth)}):(k.height=e,k.y=w,d.tooltipPos=b.inverted?[c.len+c.pos-b.plotLeft-w-e/2,f.len+f.pos-b.plotTop-k.x-k.width/2,e]:[f.left-b.plotLeft+k.x+k.width/2,c.pos-b.plotTop+w+e/2,e])})},directTouch:!0,trackerGroups:["group","dataLabelsGroup"],drawGraph:m,getSymbol:m,crispCol:function(){return q.crispCol.apply(this,arguments)},drawPoints:function(){return q.drawPoints.apply(this,
arguments)},drawTracker:function(){return q.drawTracker.apply(this,arguments)},getColumnMetrics:function(){return q.getColumnMetrics.apply(this,arguments)},pointAttribs:function(){return q.pointAttribs.apply(this,arguments)},animate:function(){return q.animate.apply(this,arguments)},polarArc:function(){return q.polarArc.apply(this,arguments)},translate3dPoints:function(){return q.translate3dPoints.apply(this,arguments)},translate3dShapes:function(){return q.translate3dShapes.apply(this,arguments)}},
{setState:q.pointClass.prototype.setState});""});B(u,"parts-more/ColumnPyramidSeries.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.pick;a=b.seriesType;var g=b.seriesTypes.column.prototype;a("columnpyramid","column",{},{translate:function(){var a=this,b=a.chart,q=a.options,e=a.dense=2>a.closestPointRange*a.xAxis.transA;e=a.borderWidth=h(q.borderWidth,e?0:1);var c=a.yAxis,f=q.threshold,v=a.translatedThreshold=c.getThreshold(f),t=h(q.minPointLength,5),p=a.getColumnMetrics(),
x=p.width,z=a.barW=Math.max(x,1+2*e),l=a.pointXOffset=p.offset;b.inverted&&(v-=.5);q.pointPadding&&(z=Math.ceil(z));g.translate.apply(a);a.points.forEach(function(d){var k=h(d.yBottom,v),r=999+Math.abs(k),w=Math.min(Math.max(-r,d.plotY),c.len+r);r=d.plotX+l;var e=z/2,C=Math.min(w,k);k=Math.max(w,k)-C;d.barX=r;d.pointWidth=x;d.tooltipPos=b.inverted?[c.len+c.pos-b.plotLeft-w,a.xAxis.len-r-e,k]:[r+e,w+c.pos-b.plotTop,k];w=f+(d.total||d.y);"percent"===q.stacking&&(w=f+(0>d.y)?-100:100);w=c.toPixels(w,
!0);var g=b.plotHeight-w-(b.plotHeight-v);var m=e*(C-w)/g;var p=e*(C+k-w)/g;g=r-m+e;m=r+m+e;var n=r+p+e;p=r-p+e;var E=C-t;var D=C+k;0>d.y&&(E=C,D=C+k+t);b.inverted&&(n=b.plotWidth-C,g=w-(b.plotWidth-v),m=e*(w-n)/g,p=e*(w-(n-k))/g,g=r+e+m,m=g-2*m,n=r-p+e,p=r+p+e,E=C,D=C+k-t,0>d.y&&(D=C+k+t));d.shapeType="path";d.shapeArgs={x:g,y:E,width:m-g,height:k,d:["M",g,E,"L",m,E,n,D,p,D,"Z"]}})}});""});B(u,"parts-more/GaugeSeries.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.isNumber,
g=a.pick,m=a.pInt,n=b.merge,q=b.Series;a=b.seriesType;var e=b.TrackerMixin;a("gauge","line",{dataLabels:{borderColor:"#cccccc",borderRadius:3,borderWidth:1,crop:!1,defer:!1,enabled:!0,verticalAlign:"top",y:15,zIndex:2},dial:{},pivot:{},tooltip:{headerFormat:""},showInLegend:!1},{angular:!0,directTouch:!0,drawGraph:b.noop,fixedBox:!0,forceDL:!0,noSharedTooltip:!0,trackerGroups:["group","dataLabelsGroup"],translate:function(){var c=this.yAxis,a=this.options,e=c.center;this.generatePoints();this.points.forEach(function(f){var b=
n(a.dial,f.dial),v=m(g(b.radius,"80%"))*e[2]/200,t=m(g(b.baseLength,"70%"))*v/100,l=m(g(b.rearLength,"10%"))*v/100,d=b.baseWidth||3,k=b.topWidth||1,r=a.overshoot,w=c.startAngleRad+c.translate(f.y,null,null,null,!0);h(r)?(r=r/180*Math.PI,w=Math.max(c.startAngleRad-r,Math.min(c.endAngleRad+r,w))):!1===a.wrap&&(w=Math.max(c.startAngleRad,Math.min(c.endAngleRad,w)));w=180*w/Math.PI;f.shapeType="path";f.shapeArgs={d:b.path||["M",-l,-d/2,"L",t,-d/2,v,-k/2,v,k/2,t,d/2,-l,d/2,"z"],translateX:e[0],translateY:e[1],
rotation:w};f.plotX=e[0];f.plotY=e[1]})},drawPoints:function(){var c=this,a=c.chart,e=c.yAxis.center,b=c.pivot,m=c.options,h=m.pivot,q=a.renderer;c.points.forEach(function(e){var d=e.graphic,k=e.shapeArgs,r=k.d,w=n(m.dial,e.dial);d?(d.animate(k),k.d=r):e.graphic=q[e.shapeType](k).attr({rotation:k.rotation,zIndex:1}).addClass("highcharts-dial").add(c.group);if(!a.styledMode)e.graphic[d?"animate":"attr"]({stroke:w.borderColor||"none","stroke-width":w.borderWidth||0,fill:w.backgroundColor||"#000000"})});
b?b.animate({translateX:e[0],translateY:e[1]}):(c.pivot=q.circle(0,0,g(h.radius,5)).attr({zIndex:2}).addClass("highcharts-pivot").translate(e[0],e[1]).add(c.group),a.styledMode||c.pivot.attr({"stroke-width":h.borderWidth||0,stroke:h.borderColor||"#cccccc",fill:h.backgroundColor||"#000000"}))},animate:function(c){var a=this;c||(a.points.forEach(function(c){var e=c.graphic;e&&(e.attr({rotation:180*a.yAxis.startAngleRad/Math.PI}),e.animate({rotation:c.shapeArgs.rotation},a.options.animation))}),a.animate=
null)},render:function(){this.group=this.plotGroup("group","series",this.visible?"visible":"hidden",this.options.zIndex,this.chart.seriesGroup);q.prototype.render.call(this);this.group.clip(this.chart.clipRect)},setData:function(c,a){q.prototype.setData.call(this,c,!1);this.processData();this.generatePoints();g(a,!0)&&this.chart.redraw()},hasData:function(){return!!this.points.length},drawTracker:e&&e.drawTrackerPoint},{setState:function(c){this.state=c}});""});B(u,"parts-more/BoxPlotSeries.js",[u["parts/Globals.js"],
u["parts/Utilities.js"]],function(b,a){var h=a.pick;a=b.noop;var g=b.seriesType,m=b.seriesTypes;g("boxplot","column",{threshold:null,tooltip:{pointFormat:'<span style="color:{point.color}">\u25cf</span> <b> {series.name}</b><br/>Maximum: {point.high}<br/>Upper quartile: {point.q3}<br/>Median: {point.median}<br/>Lower quartile: {point.q1}<br/>Minimum: {point.low}<br/>'},whiskerLength:"50%",fillColor:"#ffffff",lineWidth:1,medianWidth:2,whiskerWidth:2},{pointArrayMap:["low","q1","median","q3","high"],
toYData:function(a){return[a.low,a.q1,a.median,a.q3,a.high]},pointValKey:"high",pointAttribs:function(){return{}},drawDataLabels:a,translate:function(){var a=this.yAxis,b=this.pointArrayMap;m.column.prototype.translate.apply(this);this.points.forEach(function(e){b.forEach(function(c){null!==e[c]&&(e[c+"Plot"]=a.translate(e[c],0,1,0,1))})})},drawPoints:function(){var a=this,b=a.options,e=a.chart,c=e.renderer,f,g,m,p,x,z,l=0,d,k,r,w,F=!1!==a.doQuartiles,C,H=a.options.whiskerLength;a.points.forEach(function(A){var v=
A.graphic,t=v?"animate":"attr",n=A.shapeArgs,q={},G={},y={},I={},u=A.color||a.color;void 0!==A.plotY&&(d=n.width,k=Math.floor(n.x),r=k+d,w=Math.round(d/2),f=Math.floor(F?A.q1Plot:A.lowPlot),g=Math.floor(F?A.q3Plot:A.lowPlot),m=Math.floor(A.highPlot),p=Math.floor(A.lowPlot),v||(A.graphic=v=c.g("point").add(a.group),A.stem=c.path().addClass("highcharts-boxplot-stem").add(v),H&&(A.whiskers=c.path().addClass("highcharts-boxplot-whisker").add(v)),F&&(A.box=c.path(void 0).addClass("highcharts-boxplot-box").add(v)),
A.medianShape=c.path(void 0).addClass("highcharts-boxplot-median").add(v)),e.styledMode||(G.stroke=A.stemColor||b.stemColor||u,G["stroke-width"]=h(A.stemWidth,b.stemWidth,b.lineWidth),G.dashstyle=A.stemDashStyle||b.stemDashStyle,A.stem.attr(G),H&&(y.stroke=A.whiskerColor||b.whiskerColor||u,y["stroke-width"]=h(A.whiskerWidth,b.whiskerWidth,b.lineWidth),A.whiskers.attr(y)),F&&(q.fill=A.fillColor||b.fillColor||u,q.stroke=b.lineColor||u,q["stroke-width"]=b.lineWidth||0,A.box.attr(q)),I.stroke=A.medianColor||
b.medianColor||u,I["stroke-width"]=h(A.medianWidth,b.medianWidth,b.lineWidth),A.medianShape.attr(I)),z=A.stem.strokeWidth()%2/2,l=k+w+z,A.stem[t]({d:["M",l,g,"L",l,m,"M",l,f,"L",l,p]}),F&&(z=A.box.strokeWidth()%2/2,f=Math.floor(f)+z,g=Math.floor(g)+z,k+=z,r+=z,A.box[t]({d:["M",k,g,"L",k,f,"L",r,f,"L",r,g,"L",k,g,"z"]})),H&&(z=A.whiskers.strokeWidth()%2/2,m+=z,p+=z,C=/%$/.test(H)?w*parseFloat(H)/100:H/2,A.whiskers[t]({d:["M",l-C,m,"L",l+C,m,"M",l-C,p,"L",l+C,p]})),x=Math.round(A.medianPlot),z=A.medianShape.strokeWidth()%
2/2,x+=z,A.medianShape[t]({d:["M",k,x,"L",r,x]}))})},setStackedPoints:a});""});B(u,"parts-more/ErrorBarSeries.js",[u["parts/Globals.js"]],function(b){var a=b.noop,h=b.seriesType,g=b.seriesTypes;h("errorbar","boxplot",{color:"#000000",grouping:!1,linkedTo:":previous",tooltip:{pointFormat:'<span style="color:{point.color}">\u25cf</span> {series.name}: <b>{point.low}</b> - <b>{point.high}</b><br/>'},whiskerWidth:null},{type:"errorbar",pointArrayMap:["low","high"],toYData:function(a){return[a.low,a.high]},
pointValKey:"high",doQuartiles:!1,drawDataLabels:g.arearange?function(){var a=this.pointValKey;g.arearange.prototype.drawDataLabels.call(this);this.data.forEach(function(b){b.y=b[a]})}:a,getColumnMetrics:function(){return this.linkedParent&&this.linkedParent.columnMetrics||g.column.prototype.getColumnMetrics.call(this)}});""});B(u,"parts-more/WaterfallSeries.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.arrayMax,g=a.arrayMin,m=a.isNumber,n=a.objectEach,q=a.pick,e=b.correctFloat;
a=b.addEvent;var c=b.Axis,f=b.Chart,v=b.Point,t=b.Series,p=b.StackItem,x=b.seriesType,z=b.seriesTypes;a(c,"afterInit",function(){this.isXAxis||(this.waterfallStacks={changed:!1})});a(f,"beforeRedraw",function(){for(var a=this.axes,d=this.series,k=d.length;k--;)d[k].options.stacking&&(a.forEach(function(d){d.isXAxis||(d.waterfallStacks.changed=!0)}),k=0)});a(c,"afterRender",function(){var a=this.options.stackLabels;a&&a.enabled&&this.waterfallStacks&&this.renderWaterfallStackTotals()});c.prototype.renderWaterfallStackTotals=
function(){var a=this.waterfallStacks,d=this.stackTotalGroup,k=new p(this,this.options.stackLabels,!1,0,void 0);this.dummyStackItem=k;n(a,function(a){n(a,function(a){k.total=a.stackTotal;a.label&&(k.label=a.label);p.prototype.render.call(k,d);a.label=k.label;delete k.label})});k.total=null};x("waterfall","column",{dataLabels:{inside:!0},lineWidth:1,lineColor:"#333333",dashStyle:"Dot",borderColor:"#333333",states:{hover:{lineWidthPlus:0}}},{pointValKey:"y",showLine:!0,generatePoints:function(){var a;
z.column.prototype.generatePoints.apply(this);var d=0;for(a=this.points.length;d<a;d++){var k=this.points[d];var c=this.processedYData[d];if(k.isIntermediateSum||k.isSum)k.y=e(c)}},translate:function(){var a=this.options,d=this.yAxis,k,c=q(a.minPointLength,5),e=c/2,f=a.threshold,b=a.stacking,g=d.waterfallStacks[this.stackKey];z.column.prototype.translate.apply(this);var m=k=f;var h=this.points;var v=0;for(a=h.length;v<a;v++){var p=h[v];var t=this.processedYData[v];var n=p.shapeArgs;var y=[0,t];var x=
p.y;if(b){if(g){y=g[v];if("overlap"===b){var u=y.stackState[y.stateIndex--];u=0<=x?u:u-x;Object.hasOwnProperty.call(y,"absolutePos")&&delete y.absolutePos;Object.hasOwnProperty.call(y,"absoluteNeg")&&delete y.absoluteNeg}else 0<=x?(u=y.threshold+y.posTotal,y.posTotal-=x):(u=y.threshold+y.negTotal,y.negTotal-=x,u-=x),!y.posTotal&&Object.hasOwnProperty.call(y,"absolutePos")&&(y.posTotal=y.absolutePos,delete y.absolutePos),!y.negTotal&&Object.hasOwnProperty.call(y,"absoluteNeg")&&(y.negTotal=y.absoluteNeg,
delete y.absoluteNeg);p.isSum||(y.connectorThreshold=y.threshold+y.stackTotal);d.reversed?(t=0<=x?u-x:u+x,x=u):(t=u,x=u-x);p.below=t<=q(f,0);n.y=d.translate(t,0,1,0,1);n.height=Math.abs(n.y-d.translate(x,0,1,0,1))}if(x=d.dummyStackItem)x.x=v,x.label=g[v].label,x.setOffset(this.pointXOffset||0,this.barW||0,this.stackedYNeg[v],this.stackedYPos[v])}else u=Math.max(m,m+x)+y[0],n.y=d.translate(u,0,1,0,1),p.isSum?(n.y=d.translate(y[1],0,1,0,1),n.height=Math.min(d.translate(y[0],0,1,0,1),d.len)-n.y):p.isIntermediateSum?
(0<=x?(t=y[1]+k,x=k):(t=k,x=y[1]+k),d.reversed&&(t^=x,x^=t,t^=x),n.y=d.translate(t,0,1,0,1),n.height=Math.abs(n.y-Math.min(d.translate(x,0,1,0,1),d.len)),k+=y[1]):(n.height=0<t?d.translate(m,0,1,0,1)-n.y:d.translate(m,0,1,0,1)-d.translate(m-t,0,1,0,1),m+=t,p.below=m<q(f,0)),0>n.height&&(n.y+=n.height,n.height*=-1);p.plotY=n.y=Math.round(n.y)-this.borderWidth%2/2;n.height=Math.max(Math.round(n.height),.001);p.yBottom=n.y+n.height;n.height<=c&&!p.isNull?(n.height=c,n.y-=e,p.plotY=n.y,p.minPointLengthOffset=
0>p.y?-e:e):(p.isNull&&(n.width=0),p.minPointLengthOffset=0);n=p.plotY+(p.negative?n.height:0);this.chart.inverted?p.tooltipPos[0]=d.len-n:p.tooltipPos[1]=n}},processData:function(a){var d=this.options,k=this.yData,c=d.data,w=k.length,f=d.threshold||0,l,b,g,m,h;for(h=b=l=g=m=0;h<w;h++){var p=k[h];var v=c&&c[h]?c[h]:{};"sum"===p||v.isSum?k[h]=e(b):"intermediateSum"===p||v.isIntermediateSum?(k[h]=e(l),l=0):(b+=p,l+=p);g=Math.min(b,g);m=Math.max(b,m)}t.prototype.processData.call(this,a);d.stacking||
(this.dataMin=g+f,this.dataMax=m)},toYData:function(a){return a.isSum?"sum":a.isIntermediateSum?"intermediateSum":a.y},updateParallelArrays:function(a,d){t.prototype.updateParallelArrays.call(this,a,d);if("sum"===this.yData[0]||"intermediateSum"===this.yData[0])this.yData[0]=null},pointAttribs:function(a,d){var k=this.options.upColor;k&&!a.options.color&&(a.color=0<a.y?k:null);a=z.column.prototype.pointAttribs.call(this,a,d);delete a.dashstyle;return a},getGraphPath:function(){return["M",0,0]},getCrispPath:function(){var a=
this.data,d=this.yAxis,k=a.length,c=Math.round(this.graph.strokeWidth())%2/2,e=Math.round(this.borderWidth)%2/2,f=this.xAxis.reversed,b=this.yAxis.reversed,g=this.options.stacking,m=[],h;for(h=1;h<k;h++){var p=a[h].shapeArgs;var v=a[h-1];var n=a[h-1].shapeArgs;var t=d.waterfallStacks[this.stackKey];var y=0<v.y?-n.height:0;if(t){t=t[h-1];g?(t=t.connectorThreshold,y=Math.round(d.translate(t,0,1,0,1)+(b?y:0))-c):y=n.y+v.minPointLengthOffset+e-c;var q=["M",n.x+(f?0:n.width),y,"L",p.x+(f?p.width:0),y]}if(!g&&
0>v.y&&!b||0<v.y&&b)q[2]+=n.height,q[5]+=n.height;m=m.concat(q)}return m},drawGraph:function(){t.prototype.drawGraph.call(this);this.graph.attr({d:this.getCrispPath()})},setStackedPoints:function(){function a(d,a,k,c){if(B)for(k;k<B;k++)q.stackState[k]+=c;else q.stackState[0]=d,B=q.stackState.length;q.stackState.push(q.stackState[B-1]+a)}var d=this.options,k=this.yAxis.waterfallStacks,c=d.threshold,e=c||0,f=e,b=this.stackKey,g=this.xData,m=g.length,h,p;this.yAxis.usePercentage=!1;var v=h=p=e;if(this.visible||
!this.chart.options.chart.ignoreHiddenSeries){k[b]||(k[b]={});b=k[b];for(var n=0;n<m;n++){var t=g[n];if(!b[t]||k.changed)b[t]={negTotal:0,posTotal:0,stackTotal:0,threshold:0,stateIndex:0,stackState:[],label:k.changed&&b[t]?b[t].label:void 0};var q=b[t];var x=this.yData[n];0<=x?q.posTotal+=x:q.negTotal+=x;var z=d.data[n];t=q.absolutePos=q.posTotal;var u=q.absoluteNeg=q.negTotal;q.stackTotal=t+u;var B=q.stackState.length;z&&z.isIntermediateSum?(a(p,h,0,p),p=h,h=c,e^=f,f^=e,e^=f):z&&z.isSum?(a(c,v,B),
e=c):(a(e,x,0,v),z&&(v+=x,h+=x));q.stateIndex++;q.threshold=e;e+=q.stackTotal}k.changed=!1}},getExtremes:function(){var a=this.options.stacking;if(a){var d=this.yAxis;d=d.waterfallStacks;var k=this.stackedYNeg=[];var c=this.stackedYPos=[];"overlap"===a?n(d[this.stackKey],function(d){k.push(g(d.stackState));c.push(h(d.stackState))}):n(d[this.stackKey],function(d){k.push(d.negTotal+d.threshold);c.push(d.posTotal+d.threshold)});this.dataMin=g(k);this.dataMax=h(c)}}},{getClassName:function(){var a=v.prototype.getClassName.call(this);
this.isSum?a+=" highcharts-sum":this.isIntermediateSum&&(a+=" highcharts-intermediate-sum");return a},isValid:function(){return m(this.y)||this.isSum||this.isIntermediateSum}});""});B(u,"parts-more/PolygonSeries.js",[u["parts/Globals.js"]],function(b){var a=b.Series,h=b.seriesType,g=b.seriesTypes;h("polygon","scatter",{marker:{enabled:!1,states:{hover:{enabled:!1}}},stickyTracking:!1,tooltip:{followPointer:!0,pointFormat:""},trackByArea:!0},{type:"polygon",getGraphPath:function(){for(var b=a.prototype.getGraphPath.call(this),
g=b.length+1;g--;)(g===b.length||"M"===b[g])&&0<g&&b.splice(g,0,"z");return this.areaPath=b},drawGraph:function(){this.options.fillColor=this.color;g.area.prototype.drawGraph.call(this)},drawLegendSymbol:b.LegendSymbolMixin.drawRectangle,drawTracker:a.prototype.drawTracker,setStackedPoints:b.noop});""});B(u,"parts-more/BubbleLegend.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.arrayMax,g=a.arrayMin,m=a.isNumber,n=a.objectEach,q=a.pick;a=b.Series;var e=b.Legend,c=b.Chart,
f=b.addEvent,v=b.wrap,t=b.color,p=b.numberFormat,x=b.merge,z=b.noop,l=b.stableSort,d=b.setOptions;d({legend:{bubbleLegend:{borderColor:void 0,borderWidth:2,className:void 0,color:void 0,connectorClassName:void 0,connectorColor:void 0,connectorDistance:60,connectorWidth:1,enabled:!1,labels:{className:void 0,allowOverlap:!1,format:"",formatter:void 0,align:"right",style:{fontSize:10,color:void 0},x:0,y:0},maxSize:60,minSize:10,legendIndex:0,ranges:{value:void 0,borderColor:void 0,color:void 0,connectorColor:void 0},
sizeBy:"area",sizeByAbsoluteValue:!1,zIndex:1,zThreshold:0}}});b.BubbleLegend=function(d,a){this.init(d,a)};b.BubbleLegend.prototype={init:function(d,a){this.options=d;this.visible=!0;this.chart=a.chart;this.legend=a},setState:z,addToLegend:function(d){d.splice(this.options.legendIndex,0,this)},drawLegendSymbol:function(d){var a=this.chart,c=this.options,k=q(d.options.itemDistance,20),e=c.ranges;var f=c.connectorDistance;this.fontMetrics=a.renderer.fontMetrics(c.labels.style.fontSize.toString()+"px");
e&&e.length&&m(e[0].value)?(l(e,function(d,a){return a.value-d.value}),this.ranges=e,this.setOptions(),this.render(),a=this.getMaxLabelSize(),e=this.ranges[0].radius,d=2*e,f=f-e+a.width,f=0<f?f:0,this.maxLabel=a,this.movementX="left"===c.labels.align?f:0,this.legendItemWidth=d+f+k,this.legendItemHeight=d+this.fontMetrics.h/2):d.options.bubbleLegend.autoRanges=!0},setOptions:function(){var d=this.ranges,a=this.options,c=this.chart.series[a.seriesIndex],e=this.legend.baseline,f={"z-index":a.zIndex,
"stroke-width":a.borderWidth},b={"z-index":a.zIndex,"stroke-width":a.connectorWidth},g=this.getLabelStyles(),l=c.options.marker.fillOpacity,h=this.chart.styledMode;d.forEach(function(k,r){h||(f.stroke=q(k.borderColor,a.borderColor,c.color),f.fill=q(k.color,a.color,1!==l?t(c.color).setOpacity(l).get("rgba"):c.color),b.stroke=q(k.connectorColor,a.connectorColor,c.color));d[r].radius=this.getRangeRadius(k.value);d[r]=x(d[r],{center:d[0].radius-d[r].radius+e});h||x(!0,d[r],{bubbleStyle:x(!1,f),connectorStyle:x(!1,
b),labelStyle:g})},this)},getLabelStyles:function(){var d=this.options,a={},c="left"===d.labels.align,e=this.legend.options.rtl;n(d.labels.style,function(d,c){"color"!==c&&"fontSize"!==c&&"z-index"!==c&&(a[c]=d)});return x(!1,a,{"font-size":d.labels.style.fontSize,fill:q(d.labels.style.color,"#000000"),"z-index":d.zIndex,align:e||c?"right":"left"})},getRangeRadius:function(d){var a=this.options;return this.chart.series[this.options.seriesIndex].getRadius.call(this,a.ranges[a.ranges.length-1].value,
a.ranges[0].value,a.minSize,a.maxSize,d)},render:function(){var d=this.chart.renderer,a=this.options.zThreshold;this.symbols||(this.symbols={connectors:[],bubbleItems:[],labels:[]});this.legendSymbol=d.g("bubble-legend");this.legendItem=d.g("bubble-legend-item");this.legendSymbol.translateX=0;this.legendSymbol.translateY=0;this.ranges.forEach(function(d){d.value>=a&&this.renderRange(d)},this);this.legendSymbol.add(this.legendItem);this.legendItem.add(this.legendGroup);this.hideOverlappingLabels()},
renderRange:function(d){var a=this.options,c=a.labels,k=this.chart.renderer,e=this.symbols,f=e.labels,b=d.center,g=Math.abs(d.radius),l=a.connectorDistance,h=c.align,m=c.style.fontSize;l=this.legend.options.rtl||"left"===h?-l:l;c=a.connectorWidth;var p=this.ranges[0].radius,v=b-g-a.borderWidth/2+c/2;m=m/2-(this.fontMetrics.h-m)/2;var t=k.styledMode;"center"===h&&(l=0,a.connectorDistance=0,d.labelStyle.align="center");h=v+a.labels.y;var n=p+l+a.labels.x;e.bubbleItems.push(k.circle(p,b+((v%1?1:.5)-
(c%2?0:.5)),g).attr(t?{}:d.bubbleStyle).addClass((t?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-symbol "+(a.className||"")).add(this.legendSymbol));e.connectors.push(k.path(k.crispLine(["M",p,v,"L",p+l,v],a.connectorWidth)).attr(t?{}:d.connectorStyle).addClass((t?"highcharts-color-"+this.options.seriesIndex+" ":"")+"highcharts-bubble-legend-connectors "+(a.connectorClassName||"")).add(this.legendSymbol));d=k.text(this.formatLabel(d),n,h+m).attr(t?{}:d.labelStyle).addClass("highcharts-bubble-legend-labels "+
(a.labels.className||"")).add(this.legendSymbol);f.push(d);d.placed=!0;d.alignAttr={x:n,y:h+m}},getMaxLabelSize:function(){var d,a;this.symbols.labels.forEach(function(c){a=c.getBBox(!0);d=d?a.width>d.width?a:d:a});return d||{}},formatLabel:function(d){var a=this.options,c=a.labels.formatter;return(a=a.labels.format)?b.format(a,d):c?c.call(d):p(d.value,1)},hideOverlappingLabels:function(){var d=this.chart,a=this.symbols;!this.options.labels.allowOverlap&&a&&(d.hideOverlappingLabels(a.labels),a.labels.forEach(function(d,
c){d.newOpacity?d.newOpacity!==d.oldOpacity&&a.connectors[c].show():a.connectors[c].hide()}))},getRanges:function(){var d=this.legend.bubbleLegend,a=d.options.ranges,c,e=Number.MAX_VALUE,f=-Number.MAX_VALUE;d.chart.series.forEach(function(d){d.isBubble&&!d.ignoreSeries&&(c=d.zData.filter(m),c.length&&(e=q(d.options.zMin,Math.min(e,Math.max(g(c),!1===d.options.displayNegative?d.options.zThreshold:-Number.MAX_VALUE))),f=q(d.options.zMax,Math.max(f,h(c)))))});var b=e===f?[{value:f}]:[{value:e},{value:(e+
f)/2},{value:f,autoRanges:!0}];a.length&&a[0].radius&&b.reverse();b.forEach(function(d,c){a&&a[c]&&(b[c]=x(!1,a[c],d))});return b},predictBubbleSizes:function(){var d=this.chart,a=this.fontMetrics,c=d.legend.options,e="horizontal"===c.layout,f=e?d.legend.lastLineHeight:0,b=d.plotSizeX,g=d.plotSizeY,l=d.series[this.options.seriesIndex];d=Math.ceil(l.minPxSize);var h=Math.ceil(l.maxPxSize);l=l.options.maxSize;var m=Math.min(g,b);if(c.floating||!/%$/.test(l))a=h;else if(l=parseFloat(l),a=(m+f-a.h/2)*
l/100/(l/100+1),e&&g-a>=b||!e&&b-a>=g)a=h;return[d,Math.ceil(a)]},updateRanges:function(d,a){var c=this.legend.options.bubbleLegend;c.minSize=d;c.maxSize=a;c.ranges=this.getRanges()},correctSizes:function(){var d=this.legend,a=this.chart.series[this.options.seriesIndex];1<Math.abs(Math.ceil(a.maxPxSize)-this.options.maxSize)&&(this.updateRanges(this.options.minSize,a.maxPxSize),d.render())}};f(b.Legend,"afterGetAllItems",function(d){var a=this.bubbleLegend,c=this.options,e=c.bubbleLegend,k=this.chart.getVisibleBubbleSeriesIndex();
a&&a.ranges&&a.ranges.length&&(e.ranges.length&&(e.autoRanges=!!e.ranges[0].autoRanges),this.destroyItem(a));0<=k&&c.enabled&&e.enabled&&(e.seriesIndex=k,this.bubbleLegend=new b.BubbleLegend(e,this),this.bubbleLegend.addToLegend(d.allItems))});c.prototype.getVisibleBubbleSeriesIndex=function(){for(var d=this.series,a=0;a<d.length;){if(d[a]&&d[a].isBubble&&d[a].visible&&d[a].zData.length)return a;a++}return-1};e.prototype.getLinesHeights=function(){var d=this.allItems,a=[],c=d.length,e,f=0;for(e=0;e<
c;e++)if(d[e].legendItemHeight&&(d[e].itemHeight=d[e].legendItemHeight),d[e]===d[c-1]||d[e+1]&&d[e]._legendItemPos[1]!==d[e+1]._legendItemPos[1]){a.push({height:0});var b=a[a.length-1];for(f;f<=e;f++)d[f].itemHeight>b.height&&(b.height=d[f].itemHeight);b.step=e}return a};e.prototype.retranslateItems=function(d){var a,c,e,k=this.options.rtl,f=0;this.allItems.forEach(function(b,r){a=b.legendGroup.translateX;c=b._legendItemPos[1];if((e=b.movementX)||k&&b.ranges)e=k?a-b.options.maxSize/2:a+e,b.legendGroup.attr({translateX:e});
r>d[f].step&&f++;b.legendGroup.attr({translateY:Math.round(c+d[f].height/2)});b._legendItemPos[1]=c+d[f].height/2})};f(a,"legendItemClick",function(){var d=this.chart,a=this.visible,c=this.chart.legend;c&&c.bubbleLegend&&(this.visible=!a,this.ignoreSeries=a,d=0<=d.getVisibleBubbleSeriesIndex(),c.bubbleLegend.visible!==d&&(c.update({bubbleLegend:{enabled:d}}),c.bubbleLegend.visible=d),this.visible=a)});v(c.prototype,"drawChartBox",function(d,a,c){var e=this.legend,k=0<=this.getVisibleBubbleSeriesIndex();
if(e&&e.options.enabled&&e.bubbleLegend&&e.options.bubbleLegend.autoRanges&&k){var f=e.bubbleLegend.options;k=e.bubbleLegend.predictBubbleSizes();e.bubbleLegend.updateRanges(k[0],k[1]);f.placed||(e.group.placed=!1,e.allItems.forEach(function(d){d.legendGroup.translateY=null}));e.render();this.getMargins();this.axes.forEach(function(d){d.visible&&d.render();f.placed||(d.setScale(),d.updateNames(),n(d.ticks,function(d){d.isNew=!0;d.isNewLabel=!0}))});f.placed=!0;this.getMargins();d.call(this,a,c);e.bubbleLegend.correctSizes();
e.retranslateItems(e.getLinesHeights())}else d.call(this,a,c),e&&e.options.enabled&&e.bubbleLegend&&(e.render(),e.retranslateItems(e.getLinesHeights()))})});B(u,"parts-more/BubbleSeries.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.arrayMax,g=a.arrayMin,m=a.extend,n=a.isNumber,q=a.pick,e=a.pInt;a=b.Axis;var c=b.color,f=b.noop,v=b.Point,t=b.Series,p=b.seriesType,x=b.seriesTypes;p("bubble","scatter",{dataLabels:{formatter:function(){return this.point.z},inside:!0,verticalAlign:"middle"},
animationLimit:250,marker:{lineColor:null,lineWidth:1,fillOpacity:.5,radius:null,states:{hover:{radiusPlus:0}},symbol:"circle"},minSize:8,maxSize:"20%",softThreshold:!1,states:{hover:{halo:{size:5}}},tooltip:{pointFormat:"({point.x}, {point.y}), Size: {point.z}"},turboThreshold:0,zThreshold:0,zoneAxis:"z"},{pointArrayMap:["y","z"],parallelArrays:["x","y","z"],trackerGroups:["group","dataLabelsGroup"],specialGroup:"group",bubblePadding:!0,zoneAxis:"z",directTouch:!0,isBubble:!0,pointAttribs:function(a,
e){var d=this.options.marker.fillOpacity;a=t.prototype.pointAttribs.call(this,a,e);1!==d&&(a.fill=c(a.fill).setOpacity(d).get("rgba"));return a},getRadii:function(a,c,d){var e=this.zData,f=this.yData,b=d.minPxSize,g=d.maxPxSize,l=[];var h=0;for(d=e.length;h<d;h++){var m=e[h];l.push(this.getRadius(a,c,b,g,m,f[h]))}this.radii=l},getRadius:function(a,c,d,e,f,b){var k=this.options,r="width"!==k.sizeBy,g=k.zThreshold,l=c-a,h=.5;if(null===b||null===f)return null;if(n(f)){k.sizeByAbsoluteValue&&(f=Math.abs(f-
g),l=Math.max(c-g,Math.abs(a-g)),a=0);if(f<a)return d/2-1;0<l&&(h=(f-a)/l)}r&&0<=h&&(h=Math.sqrt(h));return Math.ceil(d+h*(e-d))/2},animate:function(a){!a&&this.points.length<this.options.animationLimit&&(this.points.forEach(function(a){var d=a.graphic;if(d&&d.width){var c={x:d.x,y:d.y,width:d.width,height:d.height};d.attr({x:a.plotX,y:a.plotY,width:1,height:1});d.animate(c,this.options.animation)}},this),this.animate=null)},hasData:function(){return!!this.processedXData.length},translate:function(){var a,
c=this.data,d=this.radii;x.scatter.prototype.translate.call(this);for(a=c.length;a--;){var e=c[a];var f=d?d[a]:0;n(f)&&f>=this.minPxSize/2?(e.marker=m(e.marker,{radius:f,width:2*f,height:2*f}),e.dlBox={x:e.plotX-f,y:e.plotY-f,width:2*f,height:2*f}):e.shapeArgs=e.plotY=e.dlBox=void 0}},alignDataLabel:x.column.prototype.alignDataLabel,buildKDTree:f,applyZones:f},{haloPath:function(a){return v.prototype.haloPath.call(this,0===a?0:(this.marker?this.marker.radius||0:0)+a)},ttBelow:!1});a.prototype.beforePadding=
function(){var a=this,c=this.len,d=this.chart,f=0,b=c,m=this.isXAxis,p=m?"xData":"yData",t=this.min,v={},x=Math.min(d.plotWidth,d.plotHeight),u=Number.MAX_VALUE,B=-Number.MAX_VALUE,E=this.max-t,D=c/E,G=[];this.series.forEach(function(c){var f=c.options;!c.bubblePadding||!c.visible&&d.options.chart.ignoreHiddenSeries||(a.allowZoomOutside=!0,G.push(c),m&&(["minSize","maxSize"].forEach(function(d){var a=f[d],c=/%$/.test(a);a=e(a);v[d]=c?x*a/100:a}),c.minPxSize=v.minSize,c.maxPxSize=Math.max(v.maxSize,
v.minSize),c=c.zData.filter(n),c.length&&(u=q(f.zMin,Math.min(u,Math.max(g(c),!1===f.displayNegative?f.zThreshold:-Number.MAX_VALUE))),B=q(f.zMax,Math.max(B,h(c))))))});G.forEach(function(d){var c=d[p],e=c.length;m&&d.getRadii(u,B,d);if(0<E)for(;e--;)if(n(c[e])&&a.dataMin<=c[e]&&c[e]<=a.dataMax){var k=d.radii?d.radii[e]:0;f=Math.min((c[e]-t)*D-k,f);b=Math.max((c[e]-t)*D+k,b)}});G.length&&0<E&&!this.isLog&&(b-=c,D*=(c+Math.max(0,f)-Math.min(b,c))/c,[["min","userMin",f],["max","userMax",b]].forEach(function(d){void 0===
q(a.options[d[0]],a[d[1]])&&(a[d[0]]+=d[2]/D)}))};""});B(u,"modules/networkgraph/integrations.js",[u["parts/Globals.js"]],function(b){b.networkgraphIntegrations={verlet:{attractiveForceFunction:function(a,b){return(b-a)/a},repulsiveForceFunction:function(a,b){return(b-a)/a*(b>a?1:0)},barycenter:function(){var a=this.options.gravitationalConstant,b=this.barycenter.xFactor,g=this.barycenter.yFactor;b=(b-(this.box.left+this.box.width)/2)*a;g=(g-(this.box.top+this.box.height)/2)*a;this.nodes.forEach(function(a){a.fixedPosition||
(a.plotX-=b/a.mass/a.degree,a.plotY-=g/a.mass/a.degree)})},repulsive:function(a,b,g){b=b*this.diffTemperature/a.mass/a.degree;a.fixedPosition||(a.plotX+=g.x*b,a.plotY+=g.y*b)},attractive:function(a,b,g){var h=a.getMass(),n=-g.x*b*this.diffTemperature;b=-g.y*b*this.diffTemperature;a.fromNode.fixedPosition||(a.fromNode.plotX-=n*h.fromNode/a.fromNode.degree,a.fromNode.plotY-=b*h.fromNode/a.fromNode.degree);a.toNode.fixedPosition||(a.toNode.plotX+=n*h.toNode/a.toNode.degree,a.toNode.plotY+=b*h.toNode/
a.toNode.degree)},integrate:function(a,b){var g=-a.options.friction,m=a.options.maxSpeed,h=(b.plotX+b.dispX-b.prevX)*g;g*=b.plotY+b.dispY-b.prevY;var q=Math.abs,e=q(h)/(h||1);q=q(g)/(g||1);h=e*Math.min(m,Math.abs(h));g=q*Math.min(m,Math.abs(g));b.prevX=b.plotX+b.dispX;b.prevY=b.plotY+b.dispY;b.plotX+=h;b.plotY+=g;b.temperature=a.vectorLength({x:h,y:g})},getK:function(a){return Math.pow(a.box.width*a.box.height/a.nodes.length,.5)}},euler:{attractiveForceFunction:function(a,b){return a*a/b},repulsiveForceFunction:function(a,
b){return b*b/a},barycenter:function(){var a=this.options.gravitationalConstant,b=this.barycenter.xFactor,g=this.barycenter.yFactor;this.nodes.forEach(function(m){if(!m.fixedPosition){var h=m.getDegree();h*=1+h/2;m.dispX+=(b-m.plotX)*a*h/m.degree;m.dispY+=(g-m.plotY)*a*h/m.degree}})},repulsive:function(a,b,g,m){a.dispX+=g.x/m*b/a.degree;a.dispY+=g.y/m*b/a.degree},attractive:function(a,b,g,m){var h=a.getMass(),q=g.x/m*b;b*=g.y/m;a.fromNode.fixedPosition||(a.fromNode.dispX-=q*h.fromNode/a.fromNode.degree,
a.fromNode.dispY-=b*h.fromNode/a.fromNode.degree);a.toNode.fixedPosition||(a.toNode.dispX+=q*h.toNode/a.toNode.degree,a.toNode.dispY+=b*h.toNode/a.toNode.degree)},integrate:function(a,b){b.dispX+=b.dispX*a.options.friction;b.dispY+=b.dispY*a.options.friction;var g=b.temperature=a.vectorLength({x:b.dispX,y:b.dispY});0!==g&&(b.plotX+=b.dispX/g*Math.min(Math.abs(b.dispX),a.temperature),b.plotY+=b.dispY/g*Math.min(Math.abs(b.dispY),a.temperature))},getK:function(a){return Math.pow(a.box.width*a.box.height/
a.nodes.length,.3)}}}});B(u,"modules/networkgraph/QuadTree.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){a=a.extend;var h=b.QuadTreeNode=function(a){this.box=a;this.boxSize=Math.min(a.width,a.height);this.nodes=[];this.body=this.isInternal=!1;this.isEmpty=!0};a(h.prototype,{insert:function(a,b){this.isInternal?this.nodes[this.getBoxPosition(a)].insert(a,b-1):(this.isEmpty=!1,this.body?b?(this.isInternal=!0,this.divideBox(),!0!==this.body&&(this.nodes[this.getBoxPosition(this.body)].insert(this.body,
b-1),this.body=!0),this.nodes[this.getBoxPosition(a)].insert(a,b-1)):(b=new h({top:a.plotX,left:a.plotY,width:.1,height:.1}),b.body=a,b.isInternal=!1,this.nodes.push(b)):(this.isInternal=!1,this.body=a))},updateMassAndCenter:function(){var a=0,b=0,h=0;this.isInternal?(this.nodes.forEach(function(g){g.isEmpty||(a+=g.mass,b+=g.plotX*g.mass,h+=g.plotY*g.mass)}),b/=a,h/=a):this.body&&(a=this.body.mass,b=this.body.plotX,h=this.body.plotY);this.mass=a;this.plotX=b;this.plotY=h},divideBox:function(){var a=
this.box.width/2,b=this.box.height/2;this.nodes[0]=new h({left:this.box.left,top:this.box.top,width:a,height:b});this.nodes[1]=new h({left:this.box.left+a,top:this.box.top,width:a,height:b});this.nodes[2]=new h({left:this.box.left+a,top:this.box.top+b,width:a,height:b});this.nodes[3]=new h({left:this.box.left,top:this.box.top+b,width:a,height:b})},getBoxPosition:function(a){var b=a.plotY<this.box.top+this.box.height/2;return a.plotX<this.box.left+this.box.width/2?b?0:3:b?1:2}});b=b.QuadTree=function(a,
b,n,q){this.box={left:a,top:b,width:n,height:q};this.maxDepth=25;this.root=new h(this.box,"0");this.root.isInternal=!0;this.root.isRoot=!0;this.root.divideBox()};a(b.prototype,{insertNodes:function(a){a.forEach(function(a){this.root.insert(a,this.maxDepth)},this)},visitNodeRecursive:function(a,b,h){var g;a||(a=this.root);a===this.root&&b&&(g=b(a));!1!==g&&(a.nodes.forEach(function(a){if(a.isInternal){b&&(g=b(a));if(!1===g)return;this.visitNodeRecursive(a,b,h)}else a.body&&b&&b(a.body);h&&h(a)},this),
a===this.root&&h&&h(a))},calculateMassAndCenter:function(){this.visitNodeRecursive(null,null,function(a){a.updateMassAndCenter()})}})});B(u,"modules/networkgraph/layouts.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.defined,g=a.extend,m=a.pick,n=a.setAnimation;a=b.addEvent;var q=b.Chart;b.layouts={"reingold-fruchterman":function(){}};g(b.layouts["reingold-fruchterman"].prototype,{init:function(a){this.options=a;this.nodes=[];this.links=[];this.series=[];this.box={x:0,y:0,
width:0,height:0};this.setInitialRendering(!0);this.integration=b.networkgraphIntegrations[a.integration];this.attractiveForce=m(a.attractiveForce,this.integration.attractiveForceFunction);this.repulsiveForce=m(a.repulsiveForce,this.integration.repulsiveForceFunction);this.approximation=a.approximation},start:function(){var a=this.series,c=this.options;this.currentStep=0;this.forces=a[0]&&a[0].forces||[];this.initialRendering&&(this.initPositions(),a.forEach(function(a){a.render()}));this.setK();
this.resetSimulation(c);c.enableSimulation&&this.step()},step:function(){var a=this,c=this.series,f=this.options;a.currentStep++;"barnes-hut"===a.approximation&&(a.createQuadTree(),a.quadTree.calculateMassAndCenter());a.forces.forEach(function(c){a[c+"Forces"](a.temperature)});a.applyLimits(a.temperature);a.temperature=a.coolDown(a.startTemperature,a.diffTemperature,a.currentStep);a.prevSystemTemperature=a.systemTemperature;a.systemTemperature=a.getSystemTemperature();f.enableSimulation&&(c.forEach(function(a){a.chart&&
a.render()}),a.maxIterations--&&isFinite(a.temperature)&&!a.isStable()?(a.simulation&&b.win.cancelAnimationFrame(a.simulation),a.simulation=b.win.requestAnimationFrame(function(){a.step()})):a.simulation=!1)},stop:function(){this.simulation&&b.win.cancelAnimationFrame(this.simulation)},setArea:function(a,c,b,g){this.box={left:a,top:c,width:b,height:g}},setK:function(){this.k=this.options.linkLength||this.integration.getK(this)},addElementsToCollection:function(a,c){a.forEach(function(a){-1===c.indexOf(a)&&
c.push(a)})},removeElementFromCollection:function(a,c){a=c.indexOf(a);-1!==a&&c.splice(a,1)},clear:function(){this.nodes.length=0;this.links.length=0;this.series.length=0;this.resetSimulation()},resetSimulation:function(){this.forcedStop=!1;this.systemTemperature=0;this.setMaxIterations();this.setTemperature();this.setDiffTemperature()},setMaxIterations:function(a){this.maxIterations=m(a,this.options.maxIterations)},setTemperature:function(){this.temperature=this.startTemperature=Math.sqrt(this.nodes.length)},
setDiffTemperature:function(){this.diffTemperature=this.startTemperature/(this.options.maxIterations+1)},setInitialRendering:function(a){this.initialRendering=a},createQuadTree:function(){this.quadTree=new b.QuadTree(this.box.left,this.box.top,this.box.width,this.box.height);this.quadTree.insertNodes(this.nodes)},initPositions:function(){var a=this.options.initialPositions;b.isFunction(a)?(a.call(this),this.nodes.forEach(function(a){h(a.prevX)||(a.prevX=a.plotX);h(a.prevY)||(a.prevY=a.plotY);a.dispX=
0;a.dispY=0})):"circle"===a?this.setCircularPositions():this.setRandomPositions()},setCircularPositions:function(){function a(c){c.linksFrom.forEach(function(d){n[d.toNode.id]||(n[d.toNode.id]=!0,p.push(d.toNode),a(d.toNode))})}var c=this.box,b=this.nodes,g=2*Math.PI/(b.length+1),h=b.filter(function(a){return 0===a.linksTo.length}),p=[],n={},q=this.options.initialPositionRadius;h.forEach(function(c){p.push(c);a(c)});p.length?b.forEach(function(a){-1===p.indexOf(a)&&p.push(a)}):p=b;p.forEach(function(a,
d){a.plotX=a.prevX=m(a.plotX,c.width/2+q*Math.cos(d*g));a.plotY=a.prevY=m(a.plotY,c.height/2+q*Math.sin(d*g));a.dispX=0;a.dispY=0})},setRandomPositions:function(){function a(a){a=a*a/Math.PI;return a-=Math.floor(a)}var c=this.box,b=this.nodes,g=b.length+1;b.forEach(function(b,e){b.plotX=b.prevX=m(b.plotX,c.width*a(e));b.plotY=b.prevY=m(b.plotY,c.height*a(g+e));b.dispX=0;b.dispY=0})},force:function(a){this.integration[a].apply(this,Array.prototype.slice.call(arguments,1))},barycenterForces:function(){this.getBarycenter();
this.force("barycenter")},getBarycenter:function(){var a=0,c=0,b=0;this.nodes.forEach(function(e){c+=e.plotX*e.mass;b+=e.plotY*e.mass;a+=e.mass});return this.barycenter={x:c,y:b,xFactor:c/a,yFactor:b/a}},barnesHutApproximation:function(a,c){var b=this.getDistXY(a,c),e=this.vectorLength(b);if(a!==c&&0!==e)if(c.isInternal)if(c.boxSize/e<this.options.theta&&0!==e){var g=this.repulsiveForce(e,this.k);this.force("repulsive",a,g*c.mass,b,e);var h=!1}else h=!0;else g=this.repulsiveForce(e,this.k),this.force("repulsive",
a,g*c.mass,b,e);return h},repulsiveForces:function(){var a=this;"barnes-hut"===a.approximation?a.nodes.forEach(function(c){a.quadTree.visitNodeRecursive(null,function(b){return a.barnesHutApproximation(c,b)})}):a.nodes.forEach(function(c){a.nodes.forEach(function(b){if(c!==b&&!c.fixedPosition){var e=a.getDistXY(c,b);var f=a.vectorLength(e);if(0!==f){var g=a.repulsiveForce(f,a.k);a.force("repulsive",c,g*b.mass,e,f)}}})})},attractiveForces:function(){var a=this,c,b,g;a.links.forEach(function(e){e.fromNode&&
e.toNode&&(c=a.getDistXY(e.fromNode,e.toNode),b=a.vectorLength(c),0!==b&&(g=a.attractiveForce(b,a.k),a.force("attractive",e,g,c,b)))})},applyLimits:function(){var a=this;a.nodes.forEach(function(c){c.fixedPosition||(a.integration.integrate(a,c),a.applyLimitBox(c,a.box),c.dispX=0,c.dispY=0)})},applyLimitBox:function(a,c){var b=a.radius;a.plotX=Math.max(Math.min(a.plotX,c.width-b),c.left+b);a.plotY=Math.max(Math.min(a.plotY,c.height-b),c.top+b)},coolDown:function(a,c,b){return a-c*b},isStable:function(){return.00001>
Math.abs(this.systemTemperature-this.prevSystemTemperature)||0>=this.temperature},getSystemTemperature:function(){return this.nodes.reduce(function(a,c){return a+c.temperature},0)},vectorLength:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},getDistR:function(a,c){a=this.getDistXY(a,c);return this.vectorLength(a)},getDistXY:function(a,c){var b=a.plotX-c.plotX;a=a.plotY-c.plotY;return{x:b,y:a,absX:Math.abs(b),absY:Math.abs(a)}}});a(q,"predraw",function(){this.graphLayoutsLookup&&this.graphLayoutsLookup.forEach(function(a){a.stop()})});
a(q,"render",function(){function a(a){a.maxIterations--&&isFinite(a.temperature)&&!a.isStable()&&!a.options.enableSimulation&&(a.beforeStep&&a.beforeStep(),a.step(),b=!1,c=!0)}var c=!1;if(this.graphLayoutsLookup){n(!1,this);for(this.graphLayoutsLookup.forEach(function(a){a.start()});!b;){var b=!0;this.graphLayoutsLookup.forEach(a)}c&&this.series.forEach(function(a){a&&a.layout&&a.render()})}})});B(u,"modules/networkgraph/draggable-nodes.js",[u["parts/Globals.js"]],function(b){var a=b.Chart,h=b.addEvent;
b.dragNodesMixin={onMouseDown:function(a,b){b=this.chart.pointer.normalize(b);a.fixedPosition={chartX:b.chartX,chartY:b.chartY,plotX:a.plotX,plotY:a.plotY};a.inDragMode=!0},onMouseMove:function(a,b){if(a.fixedPosition&&a.inDragMode){var g=this.chart,h=g.pointer.normalize(b);b=a.fixedPosition.chartX-h.chartX;h=a.fixedPosition.chartY-h.chartY;if(5<Math.abs(b)||5<Math.abs(h))b=a.fixedPosition.plotX-b,h=a.fixedPosition.plotY-h,g.isInsidePlot(b,h)&&(a.plotX=b,a.plotY=h,a.hasDragged=!0,this.redrawHalo(a),
this.layout.simulation?this.layout.resetSimulation():(this.layout.setInitialRendering(!1),this.layout.enableSimulation?this.layout.start():this.layout.setMaxIterations(1),this.chart.redraw(),this.layout.setInitialRendering(!0)))}},onMouseUp:function(a,b){a.fixedPosition&&a.hasDragged&&(this.layout.enableSimulation?this.layout.start():this.chart.redraw(),a.inDragMode=a.hasDragged=!1,this.options.fixedDraggable||delete a.fixedPosition)},redrawHalo:function(a){a&&this.halo&&this.halo.attr({d:a.haloPath(this.options.states.hover.halo.size)})}};
h(a,"load",function(){var a=this,b,n,q;a.container&&(b=h(a.container,"mousedown",function(b){var c=a.hoverPoint;c&&c.series&&c.series.hasDraggableNodes&&c.series.options.draggable&&(c.series.onMouseDown(c,b),n=h(a.container,"mousemove",function(a){return c&&c.series&&c.series.onMouseMove(c,a)}),q=h(a.container.ownerDocument,"mouseup",function(a){n();q();return c&&c.series&&c.series.onMouseUp(c,a)}))}));h(a,"destroy",function(){b()})})});B(u,"parts-more/PackedBubbleSeries.js",[u["parts/Globals.js"],
u["parts/Utilities.js"]],function(b,a){var h=a.defined,g=a.extend,m=a.isArray,n=a.isNumber,q=a.pick;a=b.seriesType;var e=b.Series,c=b.Point,f=b.addEvent,v=b.fireEvent,t=b.Chart,p=b.Color,x=b.layouts["reingold-fruchterman"],u=b.seriesTypes.bubble.prototype.pointClass,l=b.dragNodesMixin;b.networkgraphIntegrations.packedbubble={repulsiveForceFunction:function(a,c,b,e){return Math.min(a,(b.marker.radius+e.marker.radius)/2)},barycenter:function(){var a=this,c=a.options.gravitationalConstant,b=a.box,e=
a.nodes,f,h;e.forEach(function(d){a.options.splitSeries&&!d.isParentNode?(f=d.series.parentNode.plotX,h=d.series.parentNode.plotY):(f=b.width/2,h=b.height/2);d.fixedPosition||(d.plotX-=(d.plotX-f)*c/(d.mass*Math.sqrt(e.length)),d.plotY-=(d.plotY-h)*c/(d.mass*Math.sqrt(e.length)))})},repulsive:function(a,c,b,e){var d=c*this.diffTemperature/a.mass/a.degree;c=b.x*d;b=b.y*d;a.fixedPosition||(a.plotX+=c,a.plotY+=b);e.fixedPosition||(e.plotX-=c,e.plotY-=b)},integrate:b.networkgraphIntegrations.verlet.integrate,
getK:b.noop};b.layouts.packedbubble=b.extendClass(x,{beforeStep:function(){this.options.marker&&this.series.forEach(function(a){a&&a.calculateParentRadius()})},setCircularPositions:function(){var a=this,c=a.box,b=a.nodes,e=2*Math.PI/(b.length+1),f,h,g=a.options.initialPositionRadius;b.forEach(function(d,b){a.options.splitSeries&&!d.isParentNode?(f=d.series.parentNode.plotX,h=d.series.parentNode.plotY):(f=c.width/2,h=c.height/2);d.plotX=d.prevX=q(d.plotX,f+g*Math.cos(d.index||b*e));d.plotY=d.prevY=
q(d.plotY,h+g*Math.sin(d.index||b*e));d.dispX=0;d.dispY=0})},repulsiveForces:function(){var a=this,c,b,e,f=a.options.bubblePadding;a.nodes.forEach(function(d){d.degree=d.mass;d.neighbours=0;a.nodes.forEach(function(k){c=0;d===k||d.fixedPosition||!a.options.seriesInteraction&&d.series!==k.series||(e=a.getDistXY(d,k),b=a.vectorLength(e)-(d.marker.radius+k.marker.radius+f),0>b&&(d.degree+=.01,d.neighbours++,c=a.repulsiveForce(-b/Math.sqrt(d.neighbours),a.k,d,k)),a.force("repulsive",d,c*k.mass,e,k,b))})})},
applyLimitBox:function(a){if(this.options.splitSeries&&!a.isParentNode&&this.options.parentNodeLimit){var d=this.getDistXY(a,a.series.parentNode);var c=a.series.parentNodeRadius-a.marker.radius-this.vectorLength(d);0>c&&c>-2*a.marker.radius&&(a.plotX-=.01*d.x,a.plotY-=.01*d.y)}x.prototype.applyLimitBox.apply(this,arguments)},isStable:function(){return.00001>Math.abs(this.systemTemperature-this.prevSystemTemperature)||0>=this.temperature||0<this.systemTemperature&&.02>this.systemTemperature/this.nodes.length&&
this.enableSimulation}});a("packedbubble","bubble",{minSize:"10%",maxSize:"50%",sizeBy:"area",zoneAxis:"y",tooltip:{pointFormat:"Value: {point.value}"},draggable:!0,useSimulation:!0,dataLabels:{formatter:function(){return this.point.value},parentNodeFormatter:function(){return this.name},parentNodeTextPath:{enabled:!0},padding:0},layoutAlgorithm:{initialPositions:"circle",initialPositionRadius:20,bubblePadding:5,parentNodeLimit:!1,seriesInteraction:!0,dragBetweenSeries:!1,parentNodeOptions:{maxIterations:400,
gravitationalConstant:.03,maxSpeed:50,initialPositionRadius:100,seriesInteraction:!0,marker:{fillColor:null,fillOpacity:1,lineWidth:1,lineColor:null,symbol:"circle"}},enableSimulation:!0,type:"packedbubble",integration:"packedbubble",maxIterations:1E3,splitSeries:!1,maxSpeed:5,gravitationalConstant:.01,friction:-.981}},{hasDraggableNodes:!0,forces:["barycenter","repulsive"],pointArrayMap:["value"],pointValKey:"value",isCartesian:!1,axisTypes:[],noSharedTooltip:!0,accumulateAllPoints:function(a){var d=
a.chart,c=[],b,e;for(b=0;b<d.series.length;b++)if(a=d.series[b],a.visible||!d.options.chart.ignoreHiddenSeries)for(e=0;e<a.yData.length;e++)c.push([null,null,a.yData[e],a.index,e,{id:e,marker:{radius:0}}]);return c},init:function(){e.prototype.init.apply(this,arguments);f(this,"updatedData",function(){this.chart.series.forEach(function(a){a.type===this.type&&(a.isDirty=!0)},this)});return this},render:function(){var a=[];e.prototype.render.apply(this,arguments);this.options.dataLabels.allowOverlap||
(this.data.forEach(function(d){m(d.dataLabels)&&d.dataLabels.forEach(function(d){a.push(d)})}),this.chart.hideOverlappingLabels(a))},setVisible:function(){var a=this;e.prototype.setVisible.apply(a,arguments);a.parentNodeLayout&&a.graph?a.visible?(a.graph.show(),a.parentNode.dataLabel&&a.parentNode.dataLabel.show()):(a.graph.hide(),a.parentNodeLayout.removeElementFromCollection(a.parentNode,a.parentNodeLayout.nodes),a.parentNode.dataLabel&&a.parentNode.dataLabel.hide()):a.layout&&(a.visible?a.layout.addElementsToCollection(a.points,
a.layout.nodes):a.points.forEach(function(d){a.layout.removeElementFromCollection(d,a.layout.nodes)}))},drawDataLabels:function(){var a=this.options.dataLabels.textPath,c=this.points;e.prototype.drawDataLabels.apply(this,arguments);this.parentNode&&(this.parentNode.formatPrefix="parentNode",this.points=[this.parentNode],this.options.dataLabels.textPath=this.options.dataLabels.parentNodeTextPath,e.prototype.drawDataLabels.apply(this,arguments),this.points=c,this.options.dataLabels.textPath=a)},seriesBox:function(){var a=
this.chart,c=Math.max,b=Math.min,e,f=[a.plotLeft,a.plotLeft+a.plotWidth,a.plotTop,a.plotTop+a.plotHeight];this.data.forEach(function(a){h(a.plotX)&&h(a.plotY)&&a.marker.radius&&(e=a.marker.radius,f[0]=b(f[0],a.plotX-e),f[1]=c(f[1],a.plotX+e),f[2]=b(f[2],a.plotY-e),f[3]=c(f[3],a.plotY+e))});return n(f.width/f.height)?f:null},calculateParentRadius:function(){var a=this.seriesBox();this.parentNodeRadius=Math.min(Math.max(Math.sqrt(2*this.parentNodeMass/Math.PI)+20,20),a?Math.max(Math.sqrt(Math.pow(a.width,
2)+Math.pow(a.height,2))/2+20,20):Math.sqrt(2*this.parentNodeMass/Math.PI)+20);this.parentNode&&(this.parentNode.marker.radius=this.parentNode.radius=this.parentNodeRadius)},drawGraph:function(){if(this.layout&&this.layout.options.splitSeries){var a=this.chart,c=this.layout.options.parentNodeOptions.marker;c={fill:c.fillColor||p(this.color).brighten(.4).get(),opacity:c.fillOpacity,stroke:c.lineColor||this.color,"stroke-width":c.lineWidth};var e=this.visible?"inherit":"hidden";this.parentNodesGroup||
(this.parentNodesGroup=this.plotGroup("parentNodesGroup","parentNode",e,.1,a.seriesGroup),this.group.attr({zIndex:2}));this.calculateParentRadius();e=b.merge({x:this.parentNode.plotX-this.parentNodeRadius,y:this.parentNode.plotY-this.parentNodeRadius,width:2*this.parentNodeRadius,height:2*this.parentNodeRadius},c);this.parentNode.graphic||(this.graph=this.parentNode.graphic=a.renderer.symbol(c.symbol).add(this.parentNodesGroup));this.parentNode.graphic.attr(e)}},createParentNodes:function(){var a=
this,c=a.chart,b=a.parentNodeLayout,e,f=a.parentNode;a.parentNodeMass=0;a.points.forEach(function(d){a.parentNodeMass+=Math.PI*Math.pow(d.marker.radius,2)});a.calculateParentRadius();b.nodes.forEach(function(d){d.seriesIndex===a.index&&(e=!0)});b.setArea(0,0,c.plotWidth,c.plotHeight);e||(f||(f=(new u).init(this,{mass:a.parentNodeRadius/2,marker:{radius:a.parentNodeRadius},dataLabels:{inside:!1},dataLabelOnNull:!0,degree:a.parentNodeRadius,isParentNode:!0,seriesIndex:a.index})),a.parentNode&&(f.plotX=
a.parentNode.plotX,f.plotY=a.parentNode.plotY),a.parentNode=f,b.addElementsToCollection([a],b.series),b.addElementsToCollection([f],b.nodes))},addSeriesLayout:function(){var a=this.options.layoutAlgorithm,c=this.chart.graphLayoutsStorage,e=this.chart.graphLayoutsLookup,f=b.merge(a,a.parentNodeOptions,{enableSimulation:this.layout.options.enableSimulation});var h=c[a.type+"-series"];h||(c[a.type+"-series"]=h=new b.layouts[a.type],h.init(f),e.splice(h.index,0,h));this.parentNodeLayout=h;this.createParentNodes()},
addLayout:function(){var a=this.options.layoutAlgorithm,c=this.chart.graphLayoutsStorage,e=this.chart.graphLayoutsLookup,f=this.chart.options.chart;c||(this.chart.graphLayoutsStorage=c={},this.chart.graphLayoutsLookup=e=[]);var g=c[a.type];g||(a.enableSimulation=h(f.forExport)?!f.forExport:a.enableSimulation,c[a.type]=g=new b.layouts[a.type],g.init(a),e.splice(g.index,0,g));this.layout=g;this.points.forEach(function(a){a.mass=2;a.degree=1;a.collisionNmb=1});g.setArea(0,0,this.chart.plotWidth,this.chart.plotHeight);
g.addElementsToCollection([this],g.series);g.addElementsToCollection(this.points,g.nodes)},deferLayout:function(){var a=this.options.layoutAlgorithm;this.visible&&(this.addLayout(),a.splitSeries&&this.addSeriesLayout())},translate:function(){var a=this.chart,c=this.data,b=this.index,e,f=this.options.useSimulation;this.processedXData=this.xData;this.generatePoints();h(a.allDataPoints)||(a.allDataPoints=this.accumulateAllPoints(this),this.getPointRadius());if(f)var l=a.allDataPoints;else l=this.placeBubbles(a.allDataPoints),
this.options.draggable=!1;for(e=0;e<l.length;e++)if(l[e][3]===b){var p=c[l[e][4]];var t=l[e][2];f||(p.plotX=l[e][0]-a.plotLeft+a.diffX,p.plotY=l[e][1]-a.plotTop+a.diffY);p.marker=g(p.marker,{radius:t,width:2*t,height:2*t});p.radius=t}f&&this.deferLayout();v(this,"afterTranslate")},checkOverlap:function(a,c){var d=a[0]-c[0],b=a[1]-c[1];return-.001>Math.sqrt(d*d+b*b)-Math.abs(a[2]+c[2])},positionBubble:function(a,c,b){var d=Math.sqrt,e=Math.asin,f=Math.acos,k=Math.pow,h=Math.abs;d=d(k(a[0]-c[0],2)+
k(a[1]-c[1],2));f=f((k(d,2)+k(b[2]+c[2],2)-k(b[2]+a[2],2))/(2*(b[2]+c[2])*d));e=e(h(a[0]-c[0])/d);a=(0>a[1]-c[1]?0:Math.PI)+f+e*(0>(a[0]-c[0])*(a[1]-c[1])?1:-1);return[c[0]+(c[2]+b[2])*Math.sin(a),c[1]-(c[2]+b[2])*Math.cos(a),b[2],b[3],b[4]]},placeBubbles:function(a){var c=this.checkOverlap,d=this.positionBubble,b=[],e=1,f=0,h=0;var g=[];var l;a=a.sort(function(a,c){return c[2]-a[2]});if(a.length){b.push([[0,0,a[0][2],a[0][3],a[0][4]]]);if(1<a.length)for(b.push([[0,0-a[1][2]-a[0][2],a[1][2],a[1][3],
a[1][4]]]),l=2;l<a.length;l++)a[l][2]=a[l][2]||1,g=d(b[e][f],b[e-1][h],a[l]),c(g,b[e][0])?(b.push([]),h=0,b[e+1].push(d(b[e][f],b[e][0],a[l])),e++,f=0):1<e&&b[e-1][h+1]&&c(g,b[e-1][h+1])?(h++,b[e].push(d(b[e][f],b[e-1][h],a[l])),f++):(f++,b[e].push(g));this.chart.stages=b;this.chart.rawPositions=[].concat.apply([],b);this.resizeRadius();g=this.chart.rawPositions}return g},resizeRadius:function(){var a=this.chart,c=a.rawPositions,b=Math.min,e=Math.max,f=a.plotLeft,h=a.plotTop,g=a.plotHeight,l=a.plotWidth,
p,t,m;var n=p=Number.POSITIVE_INFINITY;var v=t=Number.NEGATIVE_INFINITY;for(m=0;m<c.length;m++){var q=c[m][2];n=b(n,c[m][0]-q);v=e(v,c[m][0]+q);p=b(p,c[m][1]-q);t=e(t,c[m][1]+q)}m=[v-n,t-p];b=b.apply([],[(l-f)/m[0],(g-h)/m[1]]);if(1e-10<Math.abs(b-1)){for(m=0;m<c.length;m++)c[m][2]*=b;this.placeBubbles(c)}else a.diffY=g/2+h-p-(t-p)/2,a.diffX=l/2+f-n-(v-n)/2},calculateZExtremes:function(){var a=this.options.zMin,c=this.options.zMax,b=Infinity,e=-Infinity;if(a&&c)return[a,c];this.chart.series.forEach(function(a){a.yData.forEach(function(a){h(a)&&
(a>e&&(e=a),a<b&&(b=a))})});a=q(a,b);c=q(c,e);return[a,c]},getPointRadius:function(){var a=this,c=a.chart,b=a.options,e=b.useSimulation,f=Math.min(c.plotWidth,c.plotHeight),h={},g=[],l=c.allDataPoints,p,t,m,n;["minSize","maxSize"].forEach(function(a){var c=parseInt(b[a],10),d=/%$/.test(b[a]);h[a]=d?f*c/100:c*Math.sqrt(l.length)});c.minRadius=p=h.minSize/Math.sqrt(l.length);c.maxRadius=t=h.maxSize/Math.sqrt(l.length);var v=e?a.calculateZExtremes():[p,t];(l||[]).forEach(function(c,b){m=e?Math.max(Math.min(c[2],
v[1]),v[0]):c[2];n=a.getRadius(v[0],v[1],p,t,m);0===n&&(n=null);l[b][2]=n;g.push(n)});a.radii=g},redrawHalo:l.redrawHalo,onMouseDown:l.onMouseDown,onMouseMove:l.onMouseMove,onMouseUp:function(a){if(a.fixedPosition&&!a.removed){var c,d,e=this.layout,f=this.parentNodeLayout;f&&e.options.dragBetweenSeries&&f.nodes.forEach(function(f){a&&a.marker&&f!==a.series.parentNode&&(c=e.getDistXY(a,f),d=e.vectorLength(c)-f.marker.radius-a.marker.radius,0>d&&(f.series.addPoint(b.merge(a.options,{plotX:a.plotX,plotY:a.plotY}),
!1),e.removeElementFromCollection(a,e.nodes),a.remove()))});l.onMouseUp.apply(this,arguments)}},destroy:function(){this.chart.graphLayoutsLookup&&this.chart.graphLayoutsLookup.forEach(function(a){a.removeElementFromCollection(this,a.series)},this);this.parentNode&&(this.parentNodeLayout.removeElementFromCollection(this.parentNode,this.parentNodeLayout.nodes),this.parentNode.dataLabel&&(this.parentNode.dataLabel=this.parentNode.dataLabel.destroy()));b.Series.prototype.destroy.apply(this,arguments)},
alignDataLabel:b.Series.prototype.alignDataLabel},{destroy:function(){this.series.layout&&this.series.layout.removeElementFromCollection(this,this.series.layout.nodes);return c.prototype.destroy.apply(this,arguments)}});f(t,"beforeRedraw",function(){this.allDataPoints&&delete this.allDataPoints});""});B(u,"parts-more/Polar.js",[u["parts/Globals.js"],u["parts/Utilities.js"]],function(b,a){var h=a.pick,g=a.splat,m=b.Series,n=b.seriesTypes;a=b.wrap;var q=m.prototype,e=b.Pointer.prototype;q.searchPointByAngle=
function(a){var c=this.chart,b=this.xAxis.pane.center;return this.searchKDTree({clientX:180+-180/Math.PI*Math.atan2(a.chartX-b[0]-c.plotLeft,a.chartY-b[1]-c.plotTop)})};q.getConnectors=function(a,b,e,h){var c=h?1:0;var f=0<=b&&b<=a.length-1?b:0>b?a.length-1+b:0;b=0>f-1?a.length-(1+c):f-1;c=f+1>a.length-1?c:f+1;var g=a[b];c=a[c];var l=g.plotX;g=g.plotY;var d=c.plotX;var k=c.plotY;c=a[f].plotX;f=a[f].plotY;l=(1.5*c+l)/2.5;g=(1.5*f+g)/2.5;d=(1.5*c+d)/2.5;var t=(1.5*f+k)/2.5;k=Math.sqrt(Math.pow(l-c,
2)+Math.pow(g-f,2));var m=Math.sqrt(Math.pow(d-c,2)+Math.pow(t-f,2));l=Math.atan2(g-f,l-c);t=Math.PI/2+(l+Math.atan2(t-f,d-c))/2;Math.abs(l-t)>Math.PI/2&&(t-=Math.PI);l=c+Math.cos(t)*k;g=f+Math.sin(t)*k;d=c+Math.cos(Math.PI+t)*m;t=f+Math.sin(Math.PI+t)*m;c={rightContX:d,rightContY:t,leftContX:l,leftContY:g,plotX:c,plotY:f};e&&(c.prevPointCont=this.getConnectors(a,b,!1,h));return c};q.toXY=function(a){var c=this.chart,b=a.plotX;var e=a.plotY;a.rectPlotX=b;a.rectPlotY=e;e=this.xAxis.postTranslate(a.plotX,
this.yAxis.len-e);a.plotX=a.polarPlotX=e.x-c.plotLeft;a.plotY=a.polarPlotY=e.y-c.plotTop;this.kdByAngle?(c=(b/Math.PI*180+this.xAxis.pane.options.startAngle)%360,0>c&&(c+=360),a.clientX=c):a.clientX=a.plotX};n.spline&&(a(n.spline.prototype,"getPointSpline",function(a,b,e,g){this.chart.polar?g?(a=this.getConnectors(b,g,!0,this.connectEnds),a=["C",a.prevPointCont.rightContX,a.prevPointCont.rightContY,a.leftContX,a.leftContY,a.plotX,a.plotY]):a=["M",e.plotX,e.plotY]:a=a.call(this,b,e,g);return a}),n.areasplinerange&&
(n.areasplinerange.prototype.getPointSpline=n.spline.prototype.getPointSpline));b.addEvent(m,"afterTranslate",function(){var a=this.chart,e;if(a.polar&&this.xAxis){(this.kdByAngle=a.tooltip&&a.tooltip.shared)?this.searchPoint=this.searchPointByAngle:this.options.findNearestPointBy="xy";if(!this.preventPostTranslate){var g=this.points;for(e=g.length;e--;)this.toXY(g[e]),!a.hasParallelCoordinates&&!this.yAxis.reversed&&g[e].y<this.yAxis.min&&(g[e].isNull=!0)}this.hasClipCircleSetter||(this.hasClipCircleSetter=
!!b.addEvent(this,"afterRender",function(){if(a.polar){var c=this.yAxis.center;this.group.clip(a.renderer.clipCircle(c[0],c[1],c[2]/2));this.setClip=b.noop}}))}},{order:2});a(q,"getGraphPath",function(a,b){var c=this,e;if(this.chart.polar){b=b||this.points;for(e=0;e<b.length;e++)if(!b[e].isNull){var f=e;break}if(!1!==this.options.connectEnds&&void 0!==f){this.connectEnds=!0;b.splice(b.length,0,b[f]);var g=!0}b.forEach(function(a){void 0===a.polarPlotY&&c.toXY(a)})}e=a.apply(this,[].slice.call(arguments,
1));g&&b.pop();return e});m=function(a,b){var c=this.chart,e=this.options.animation,f=this.group,g=this.markerGroup,h=this.xAxis.center,l=c.plotLeft,d=c.plotTop;c.polar?c.renderer.isSVG&&(!0===e&&(e={}),b?(a={translateX:h[0]+l,translateY:h[1]+d,scaleX:.001,scaleY:.001},f.attr(a),g&&g.attr(a)):(a={translateX:l,translateY:d,scaleX:1,scaleY:1},f.animate(a,e),g&&g.animate(a,e),this.animate=null)):a.call(this,b)};a(q,"animate",m);n.column&&(n=n.column.prototype,n.polarArc=function(a,b,e,g){var c=this.xAxis.center,
f=this.yAxis.len;return this.chart.renderer.symbols.arc(c[0],c[1],f-b,null,{start:e,end:g,innerR:f-h(a,f)})},a(n,"animate",m),a(n,"translate",function(a){var b=this.xAxis,c=b.startAngleRad,e;this.preventPostTranslate=!0;a.call(this);if(b.isRadial){var g=this.points;for(e=g.length;e--;){var h=g[e];a=h.barX+c;h.shapeType="path";h.shapeArgs={d:this.polarArc(h.yBottom,h.plotY,a,a+h.pointWidth)};this.toXY(h);h.tooltipPos=[h.plotX,h.plotY];h.ttBelow=h.plotY>b.center[1]}}}),a(n,"alignDataLabel",function(a,
b,e,g,h,m){this.chart.polar?(a=b.rectPlotX/Math.PI*180,null===g.align&&(g.align=20<a&&160>a?"left":200<a&&340>a?"right":"center"),null===g.verticalAlign&&(g.verticalAlign=45>a||315<a?"bottom":135<a&&225>a?"top":"middle"),q.alignDataLabel.call(this,b,e,g,h,m)):a.call(this,b,e,g,h,m)}));a(e,"getCoordinates",function(a,b){var c=this.chart,e={xAxis:[],yAxis:[]};c.polar?c.axes.forEach(function(a){var f=a.isXAxis,g=a.center;if("colorAxis"!==a.coll){var h=b.chartX-g[0]-c.plotLeft;g=b.chartY-g[1]-c.plotTop;
e[f?"xAxis":"yAxis"].push({axis:a,value:a.translate(f?Math.PI-Math.atan2(h,g):Math.sqrt(Math.pow(h,2)+Math.pow(g,2)),!0)})}}):e=a.call(this,b);return e});b.SVGRenderer.prototype.clipCircle=function(a,e,g){var c=b.uniqueKey(),f=this.createElement("clipPath").attr({id:c}).add(this.defs);a=this.circle(a,e,g).add(f);a.id=c;a.clipPath=f;return a};b.addEvent(b.Chart,"getAxes",function(){this.pane||(this.pane=[]);g(this.options.pane).forEach(function(a){new b.Pane(a,this)},this)});b.addEvent(b.Chart,"afterDrawChartBox",
function(){this.pane.forEach(function(a){a.render()})});a(b.Chart.prototype,"get",function(a,e){return b.find(this.pane,function(a){return a.options.id===e})||a.call(this,e)})});B(u,"masters/highcharts-more.src.js",[],function(){})});


/*
 Highcharts JS v7.2.1 (2019-10-31)

 Highcharts funnel module

 (c) 2010-2019 Torstein Honsi

 License: www.highcharts.com/license
*/
(function(a){"object"===typeof module&&module.exports?(a["default"]=a,module.exports=a):"function"===typeof define&&define.amd?define("highcharts/modules/funnel",["highcharts"],function(b){a(b);a.Highcharts=b;return a}):a("undefined"!==typeof Highcharts?Highcharts:void 0)})(function(a){function b(a,v,b,y){a.hasOwnProperty(v)||(a[v]=y.apply(null,b))}a=a?a._modules:{};b(a,"modules/funnel.src.js",[a["parts/Globals.js"],a["parts/Utilities.js"]],function(a,b){var v=b.pick;b=a.seriesType;var y=a.seriesTypes,
I=a.fireEvent,G=a.noop;b("funnel","pie",{animation:!1,center:["50%","50%"],width:"90%",neckWidth:"30%",height:"100%",neckHeight:"25%",reversed:!1,size:!0,dataLabels:{connectorWidth:1},states:{select:{color:"#cccccc",borderColor:"#000000"}}},{animate:G,translate:function(){function a(a,c){return/%$/.test(a)?c*parseInt(a,10)/100:parseInt(a,10)}var n=0,c=this,f=c.chart,e=c.options,g=e.reversed,d=e.ignoreHiddenPoint,b=f.plotWidth;f=f.plotHeight;var p=0,q=e.center,h=a(q[0],b),w=a(q[1],f),y=a(e.width,b),
r,t=a(e.height,f),z=a(e.neckWidth,b),F=a(e.neckHeight,f),A=w-t/2+t-F;b=c.data;var C,D,J="left"===e.dataLabels.position?1:0,B,k,E,u,l,x,m;c.getWidthAt=function(a){var c=w-t/2;return a>A||t===F?z:z+(y-z)*(1-(a-c)/(t-F))};c.getX=function(a,d,e){return h+(d?-1:1)*(c.getWidthAt(g?2*w-a:a)/2+e.labelDistance)};c.center=[h,w,t];c.centerX=h;b.forEach(function(a){d&&!1===a.visible||(n+=a.y)});b.forEach(function(a){m=null;D=n?a.y/n:0;k=w-t/2+p*t;l=k+D*t;r=c.getWidthAt(k);B=h-r/2;E=B+r;r=c.getWidthAt(l);u=h-
r/2;x=u+r;k>A?(B=u=h-z/2,E=x=h+z/2):l>A&&(m=l,r=c.getWidthAt(A),u=h-r/2,x=u+r,l=A);g&&(k=2*w-k,l=2*w-l,null!==m&&(m=2*w-m));C=["M",B,k,"L",E,k,x,l];null!==m&&C.push(x,m,u,m);C.push(u,l,"Z");a.shapeType="path";a.shapeArgs={d:C};a.percentage=100*D;a.plotX=h;a.plotY=(k+(m||l))/2;a.tooltipPos=[h,a.plotY];a.dlBox={x:u,y:k,topWidth:E-B,bottomWidth:x-u,height:Math.abs(v(l,m)-k),width:NaN};a.slice=G;a.half=J;d&&!1===a.visible||(p+=D)});I(c,"afterTranslate")},sortByAngle:function(a){a.sort(function(a,c){return a.plotY-
c.plotY})},drawDataLabels:function(){var a=this.data,b=this.options.dataLabels.distance,c,f=a.length;for(this.center[2]-=2*b;f--;){var e=a[f];var g=(c=e.half)?1:-1;var d=e.plotY;e.labelDistance=v(e.options.dataLabels&&e.options.dataLabels.distance,b);this.maxLabelDistance=Math.max(e.labelDistance,this.maxLabelDistance||0);var H=this.getX(d,c,e);e.labelPosition={natural:{x:0,y:d},"final":{},alignment:c?"right":"left",connectorPosition:{breakAt:{x:H+(e.labelDistance-5)*g,y:d},touchingSliceAt:{x:H+e.labelDistance*
g,y:d}}}}y[this.options.dataLabels.inside?"column":"pie"].prototype.drawDataLabels.call(this)},alignDataLabel:function(b,n,c,f,e){var g=b.series;f=g.options.reversed;var d=b.dlBox||b.shapeArgs,v=c.align,p=c.verticalAlign,q=g.center[1];g=g.getWidthAt((f?2*q-b.plotY:b.plotY)-d.height/2+n.height);g="middle"===p?(d.topWidth-d.bottomWidth)/4:(g-d.bottomWidth)/2;q=d.y;var h=d.x;"middle"===p?q=d.y-d.height/2+n.height/2:"top"===p&&(q=d.y-d.height+n.height+c.padding);if("top"===p&&!f||"bottom"===p&&f||"middle"===
p)"right"===v?h=d.x-c.padding+g:"left"===v&&(h=d.x+c.padding-g);f={x:h,y:f?q-d.height:q,width:d.bottomWidth,height:d.height};c.verticalAlign="bottom";a.Series.prototype.alignDataLabel.call(this,b,n,c,f,e);c.inside&&b.contrastColor&&n.css({color:b.contrastColor})}});b("pyramid","funnel",{neckWidth:"0%",neckHeight:"0%",reversed:!0});""});b(a,"masters/modules/funnel.src.js",[],function(){})});

(function(t){t.fn.circliful=function(i){var e=t.extend({startdegree:0,fgcolor:"#556b2f",bgcolor:"#eee",fill:!1,width:15,dimension:200,fontsize:15,percent:50,animationstep:1,iconsize:"20px",iconcolor:"#999",border:"default",complete:null,bordersize:10},i);return this.each(function(){function a(i,e,a){t("<span></span>").appendTo(i).addClass(e).text(s).prepend(l).css({"line-height":a+"px","font-size":h.fontsize+"px"})}function n(i,e){t("<span></span>").appendTo(i).addClass("circle-info-half").css("line-height",h.dimension*e+"px").text(r)}function o(i){t.each(c,function(a,n){h[n]=void 0!=i.data(n)?i.data(n):t(e).attr(n),"fill"==n&&void 0!=i.data("fill")&&(m=!0)})}function d(e){u.clearRect(0,0,g.width,g.height),u.beginPath(),u.arc(x,b,w,z,y,!1),u.lineWidth=h.width+1,u.strokeStyle=h.bgcolor,u.stroke(),m&&(u.fillStyle=h.fill,u.fill()),u.beginPath(),u.arc(x,b,w,-k+T,C*e-k+T,!1),"outline"==h.border?u.lineWidth=h.width+13:"inline"==h.border&&(u.lineWidth=h.width-13),u.strokeStyle=h.fgcolor,u.stroke(),p>M&&(M+=I,requestAnimationFrame(function(){d(Math.min(M,p)/100)},f)),M==p&&S&&i!==void 0&&t.isFunction(i.complete)&&(i.complete(),S=!1)}var s,r,c=["fgcolor","bgcolor","fill","width","dimension","fontsize","animationstep","endPercent","icon","iconcolor","iconsize","border","startdegree","bordersize"],h={},l="",p=0,f=t(this),m=!1;if(f.addClass("circliful"),o(f),void 0!=f.data("text")&&(s=f.data("text"),void 0!=f.data("icon")&&(l=t("<i></i>").addClass("fa "+t(this).data("icon")).css({color:h.iconcolor,"font-size":h.iconsize})),void 0!=f.data("type")?(F=t(this).data("type"),"half"==F?a(f,"circle-text-half",h.dimension/1.45):a(f,"circle-text",h.dimension)):a(f,"circle-text",h.dimension)),void 0!=t(this).data("total")&&void 0!=t(this).data("part")){var v=t(this).data("total")/100;percent=(t(this).data("part")/v/100).toFixed(3),p=(t(this).data("part")/v).toFixed(3)}else void 0!=t(this).data("percent")?(percent=t(this).data("percent")/100,p=t(this).data("percent")):percent=e.percent/100;void 0!=t(this).data("info")&&(r=t(this).data("info"),void 0!=t(this).data("type")?(F=t(this).data("type"),"half"==F?n(f,.9):n(f,1.25)):n(f,1.25)),t(this).width(h.dimension+"px");var g=t("<canvas></canvas>").attr({width:h.dimension,height:h.dimension}).appendTo(t(this)).get(0),u=g.getContext("2d");t(g).parent();var x=g.width/2,b=g.height/2,P=360*h.percent;P*(Math.PI/180);var w=g.width/2.5,y=2.3*Math.PI,z=0,M=0===h.animationstep?p:0,I=Math.max(h.animationstep,0),C=2*Math.PI,k=Math.PI/2,F="",S=!0,T=h.startdegree/180*Math.PI;void 0!=t(this).data("type")&&(F=t(this).data("type"),"half"==F&&(y=2*Math.PI,z=3.13,C=Math.PI,k=Math.PI/.996)),d(M/100)})}})(jQuery);AP.chart = function(canvas, type){
	if (type=="pie"){
		return new ChartPie(canvas);
	}
	
	if (type=="bar"){
		return new ChartBar(canvas);
	}
	
	if (type=="radar"){
		return new ChartRadar(canvas);
	}
	
	if (type=="list" || type=="table" || type=="stacked"){
		return new ChartList(canvas, type);
	}
	
	if (type=="line"){
		return new ChartLine(canvas);
	}
	
	if (type=="series"){
		return new ChartSeries(canvas);
	}
	
	if (type=="percent"){
		return new ChartPercent(canvas);
	}
	
	if (type=="funnel"){
		return new ChartFunnel(canvas);
	}
};


AP.chartFX=new function __APChartFX(){
	this.exportData=function(data, options){
		var r=[];
		for (var i=0; i<data.length; i++){
			r.push(parseInt(data[i].value));
		}
		return r;
	};
	
	this.exportLabels=function(data, options){
		var r=[];
		for (var i=0; i<data.length; i++){
			if (data[i].name && !data[i].label){
				data[i].label=data[i].name;
			}
			
			r.push(data[i].label);
		}
		return r;
	};
	
	this.exportColors=function(data, options){
		var r=[];
		for (var i=0; i<data.length; i++){
			var c=data[i].color;
			if (!c){
				c=AP.color(i);
			}
			
			if (AP.data.isInt(c)){
				c=AP.color(c);
			}
			r.push(c);
		}
		return r;
	};
	
	
	this.exportHC=function(data, options, color){
		var r=[];
		for (var i=0; i<data.length; i++){
			var c=data[i].color;
			
			if (!c){
				c=AP.color(i);
			}
			
			if (data[i].name && !data[i].label){
				data[i].label=data[i].name;
			}
			
			r.push({name: data[i].label, y: parseInt(data[i].value), color: c});
		}
		return r;
	};
	
	
	this.exportFunnel=function(data, options){
		
		var r=[];
		for (var i=0; i<data.length; i++){
			var c=data[i].color;
			
			if (!c){
				c=AP.color(i);
			}
			
			r.push([data[i].label, parseInt(data[i].value)]);
		}
		return r;
	};
};


AP.series=function(opts){
	var r=[];
	for (var i=0; i<opts.labels.length; i++){
		var obj={};
		if (opts.stacked){
			obj={label: opts.labels[i], value: [parseFloat(opts.values[i])]};	
		}else{
			obj={label: opts.labels[i], value: parseFloat(opts.values[i])};
		}
		
		if (opts.colors){
			obj.color=opts.colors[i];
		}
			
		r.push(obj);
	}
	
	return r;
};




AP.color=function(code, alpha){
	var colors=["#6091e0", "#51cc90", "#ed912f", 
        "#6b5cd1", "#ba4cad", "#40b74e",
        "#FFEB3B","#00BCD4","#9C27B0", 
        "#f1c40f", "#009688", "#673AB7",
        "#FF9800","#4CAF50","#3F51B5"];
	
	var codes={
		"best":"#4CAF50",
		"good":"#8BC34A",
		"average":"#CDDC39",
		"bad":"#FF9800",
		"worst": "#FF5722",
		"gray":"#9E9E9E",
		"gray2": "#ccc"
	};
	
	var color="#000";
	
	if (AP.data.isInt(code)){
		var key= code % colors.length;
		color= colors[key];
	}else{
		var c=code.toLowerCase();
		if (code.charAt(0)=="#"){
			color=c;
		}else{
			if (c=="success"){
				c="good";
			}
			
			if (codes[c]){
				color= codes[c];
			}else{
				color= codes["gray2"];	
			}	
		}
	}
	

	if (alpha){
		if (alpha>0 && alpha<1){
			return UI.color.rgba(color, alpha);	
		}else{
			if (alpha>1){
				return UI.color.darken(color, alpha/100);
			}
		}
	}
	
	return color;
};


AP.statusColor=function(status, alpha){
	status=parseInt(status);
	var color="#aaaaaa";
	if (status==0){
		color="#aaaaaa";
	}
	
	if (status==1){
		color= "#f24a37";
	}
	
	if (status==2){
		color= "#f9c134";
	}
	
	if (status==3){
		color= "#bce222";
	}
	
	if (status==4){
		color= "#6de21f";
	}
	
	if (status==5){
		color= "#24d82d";
	}
	

	return AP.color(color, alpha)
};


function ChartList(canvas, type){
	this.type=type;
	this.box=canvas;
	
	
	this.show=function(data, options){
		var id=AP.uuid();
		$("<div id='"+id+"'></div>").appendTo(this.box);
		
		if (this.type=="list"){
			return showList(id, data, options);
		}
		
		Highcharts.chart(id, {
		    chart: {
		        type: 'bar',
		        height: (options.height?options.height:400),
		        style: {
		            fontFamily: 'Roboto'
		        }
		    },
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    yAxis: {
		        min: 0,
		        visible: false,
		        title: {
		            text: 'Total fruit consumption'
		        }
		    },
		    legend: {
		        reversed: true
		    },
		    plotOptions: {
		        series: {
		            stacking: 'normal'
		        }
		    },
		    series: AP.select(options.stacked, function(e, index){
		    	return {
		    		name: e,
		    		data: getStackedData(data, index)
		    	};
		    })
		});
	};
	
	
	
	function showList(id, data, options){
		Highcharts.chart(id, {
		    chart: {
		        type: 'bar',
		        height: (options.height?options.height:400),
		        style: {
		            fontFamily: 'Roboto'
		        }
		    },
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    yAxis: {
		        min: 0,
		        visible: false,
		        title: {
		            text: options.title
		        }
		    },
		    legend: {
		        reversed: true
		    },
		    colors: AP.chartFX.exportColors(data, options),
		    plotOptions: {
		        series: {
		            stacking: 'normal'
		        },
		        bar:{
		        	colors: AP.chartFX.exportColors(data, options),
		        	showInLegend: options.legend
		        }
		    },
		    series: [{
		        name: options.unit,
		        colorByPoint: true,
		        data: AP.chartFX.exportData(data, options, true)
		    }]
		  })
	};
	
	
	
	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			r.push(data[i].value[index]);
		}
		
		return r;
	};
};


function ChartPie(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		options=$.extend({
			title: false,
			unit: ''
		}, options);
		
		if (options.height){
			this.canvas.css("height", options.height);
		}
		
		var dataLabels = {
			enabled: false
		};
		
		if (options.dataLabels){
			 dataLabels= {
				enabled: true,
				format: '<b>{point.name}</b>: {point.percentage:.1f} %',
				style: {
					color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
				}
			};
		}
		
		var pie={
			allowPointSelect: true,
			cursor: 'pointer',
			dataLabels: dataLabels,
			showInLegend: options.legend,
		};
		
		if (options.doughnut){
			pie.innerSize= options.doughnut+'%';
		}	
		
		// Build the chart
		
		var chart_opts = {
			plotBackgroundColor: null,
			plotBorderWidth: null,
			plotShadow: false,
			type: 'pie',
			style: {
				fontFamily: 'Roboto'
			},
			backgroundColor: 'transparent',
		};
		
		if (options.fit){
			chart_opts.margin=[0,0,0,0];
		}
		
		Highcharts.chart(this.id, {
			chart: chart_opts,
			legend: {
				layout: "vertical"
			},
			title: {
				text: (options.title?options.title:""),
				enabled: (options.title?true:false),
				style: {
					display: (options.title?'block':'none')
				}
			},
			tooltip: {
				pointFormat: ' {series.name}: <b>{point.y}</b> | {point.percentage:.1f}%'
			},
			plotOptions: {
				pie: pie
			},
			series: [{
				name: options.unit,
				colorByPoint: true,
				data: AP.chartFX.exportHC(data, options)
			}],
			credits: false
		});


	};
	
	
	
};


function ChartBar(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		options=$.extend({
			title: false,
			unit: ''
		}, options);
		
		
		if (options.height){
			this.canvas.css("height", options.height);
		}
		
		
		var dataLabels = {
            enabled: false
        };
		
		if (options.dataLabels){
			 dataLabels= {
                enabled: true,
                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                style: {
                    color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                }
            };
		}
		
		var points=AP.chartFX.exportData(data, options);
		
		if (data.length && "color" in data[0]){
			points= AP.chartFX.exportHC(data, options);
		}
		
		
		
		// Build the chart
	    Highcharts.chart(this.id, {
	        chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            style: {
		            fontFamily: 'Roboto'
		        },
		        backgroundColor:'rgba(255, 255, 255, 0.0)'
	        },
	        legend: {
                layout: "vertical",
            },
	        title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },
	        tooltip: {
	            pointFormat: ' {series.name}: <b>{point.y}</b> | {point.percentage:.1f}%'
	        },
	        
	        plotOptions: {
	        	allowPointSelect: true,
	            cursor: 'pointer',
	            dataLabels: dataLabels,
	            showInLegend: options.legend,
	        },
	        xAxis: [{
	            categories: AP.chartFX.exportLabels(data, options),
	            crosshair: false,
                legend: false
	        }],
	        yAxis: {
	            title: {
	                text: options.unit
	            }
	        },
	        series: [{
	            type: 'column',
	            name: options.unit,
	            showInLegend: options.legend,
	            data: points
	        }]
	    });


	};
	
	
	
};


function ChartLine(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		Highcharts.chart(this.id, {
			chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            style: {
		            fontFamily: 'Roboto'
		        },
		        height:300
	        },
	        title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },

		    subtitle: {
		    	text: (options.subtitle?options.subtitle:""),
	            enabled: (options.subtitle?true:false),
	            style: {
	            	display: (options.subtitle?'block':'none')
	            }
		    },
		    
		    colors: AP.chartFX.exportColors(data, options),
		    
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    
		    yAxis: {
		        title: {
		            text: options.unit
		        }
		    },
		    legend: {
		        layout: 'vertical',
		        align: 'right',
		        verticalAlign: 'middle'
		    },

		    plotOptions: {
		        series: {
		            pointWidth: 40
		        }
		    },

		    series: AP.select(options.stacked, function(e, index){
		    	return {
		    		name: e,
		    		data: getStackedData(data, index)
		    	};
		    })

		});
	};
	

	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			var v=data[i].value[index];
			if (AP.data.isInt(v)){
				v=parseInt(v);
			}else{
				v=parseFloat(v);
			}
			r.push(v);
		}
		
		return r;
	};
	
};


function ChartPercent(canvas){
	var id=AP.uuid();
	$("<div class='center relative js-percent-chart' style='margin:auto' id='"+id+"'></div>").appendTo(canvas);
	this.box=canvas;
	this.canvas="#"+id;
	
	
	this.show=function(percent, options){
		options.percent=percent;
		UI.graph.percent(this.canvas, options);
	};
};


AP.chartLegend=function(selector, data, options){
	$(selector).html(AP.render(data, function(e){
		return "<div class='cx-li'>" +
			"<div class='cx-dot'><span class='-ap icon-controller-stop' style='color:"+e.color+"'></span></div>" +
			"<div class='cx-label' style='color:"+e.color+"'>"+e.label+"</div>" +
			"<div class='cx-value'>"+AP.data.numberFormat(e.value)+"</div>" +
		"</div>";
	}));
};


function ChartFunnel(canvas){
	var id=AP.uuid();
	$("<div class='center' id='"+id+"'></div>").appendTo(canvas);
	this.box=canvas;
	// this.canvas=$(canvas).find("canvas")[0];
	this.id=id;
	
	this.show=function(data, options){
		if (options.legend){
			$(this.box).append("<div class='chart-legend'></div>");
		}
		
		
		Highcharts.chart(this.id, {
		    chart: {
		        type: 'funnel',
		        marginRight: 100,
		        height:300,
		        style: {
		            fontFamily: 'Roboto'
		        }
		    },
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            },
	            x: -50
	        },
		    plotOptions: {
		        series: {
		            dataLabels: {
		                enabled: true,
		                format: '<b>{point.name}</b> ({point.y:,.0f})',
		                color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
		                softConnector: true
		            },
		            neckWidth: '30%',
		            neckHeight: '25%'

		            //-- Other available options
		            // height: pixels or percent
		            // width: pixels or percent
		        }
		    },
		    legend: {
		        enabled: false
		    },
		    colors: AP.chartFX.exportColors(data, options),
		    series: [{
		        name: options.unit,
		        'data': AP.chartFX.exportFunnel(data) 
		    }]
		});
	}
};





function ChartRadar(canvas){
	$(canvas).find(".radar-chart").remove();
	this.id=AP.uuid();
	$("<div class='center radar-chart' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		options=$.extend({
			title: false,
			unit: ''
		}, options);
		
		
		Highcharts.chart( this.id, {
		    chart: {
		        polar: true,
		        type: 'line',
		        backgroundColor: null
		    },
		    
		    plotOptions:{
		    	line: {
		    		showInLegend: false
		    	}
		    },
		    
		    title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            },
	            x: -80
	        },

		    pane: {
		        size: '80%'
		    },

		    xAxis: {
		        categories: options.vertices,
		        tickmarkPlacement: 'on',
		        lineWidth: 0
		    },
		    
		    colors: AP.chartFX.exportColors(data, options),

		    yAxis: {
		        gridLineInterpolation: 'polygon',
		        lineWidth: 0,
		        min: 0,
		        max: 5
		    },

		    tooltip: {
		        shared: true,
		        pointFormat: '<span style="color:{series.color}">{series.name}: <b>{point.y:,.0f}</b><br/>'
		    },

		    legend: {
		        align: 'right',
		        verticalAlign: 'top',
		        y: 70,
		        layout: 'vertical'
		    },

		    series: AP.select(data, function(e, index){
		    	e.pointPlacement= 'on';
		    	e.name=e.label;
		    	e.data=e.value;
		    	return e;
		    })

		});
		
	}
	
	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			r.push(parseFloat(data[i].value[index]));
		}
		
		return r;
	};
};


function ChartSeries(canvas){
	this.id=AP.uuid();
	$("<div class='center' id='"+this.id+"'></div>").appendTo(canvas);
	this.canvas=$("#"+this.id);
	
	this.show=function(data, options){
		Highcharts.chart(this.id, {
			chart: {
	            plotBackgroundColor: null,
	            plotBorderWidth: null,
	            plotShadow: false,
	            style: {
		            fontFamily: 'Roboto'
		        },
		        height:300
	        },
	        title: {
	            text: (options.title?options.title:""),
	            enabled: (options.title?true:false),
	            style: {
	            	display: (options.title?'block':'none')
	            }
	        },

		    subtitle: {
		    	text: (options.subtitle?options.subtitle:""),
	            enabled: (options.subtitle?true:false),
	            style: {
	            	display: (options.subtitle?'block':'none')
	            }
		    },
		    
		    colors: AP.chartFX.exportColors(data, options),
		    
		    xAxis: {
		        categories: AP.chartFX.exportLabels(data, options)
		    },
		    
		    yAxis: {
		        title: {
		            text: options.unit
		        }
		    },
		    legend: {
		        layout: 'vertical',
		        align: 'right',
		        verticalAlign: 'middle'
		    },

		    plotOptions: {
		        series: {
		            pointWidth: 40
		        }
		    },

		    series: AP.select(data, function(e){
		    	var name=e.label;
		    	if (name in e){
		    		name=e.name;
		    	}
		    	var data=e.values;
		    	if (!data){
		    		data=e.value;
		    	}
		    	var type="line";
		    	if (e.type){
		    		type=e.type;
		    	}
		    	
		    	return {
		    		name: name,
		    		data: data,
		    		type: type
		    	};
		    })

		});
	};
	

	function getStackedData(data, index){
		var r=[];
		for (var i=0; i<data.length; i++){
			var v=data[i].value[index];
			if (AP.data.isInt(v)){
				v=parseInt(v);
			}else{
				v=parseFloat(v);
			}
			r.push(v);
		}
		
		return r;
	};
	
};


AP.sampleChart=function(canvas, type){
	if (canvas.charAt(0)=="#"){
		canvas=canvas.substr(1);
	}
	
	if (type=="pie"){

		// Build the chart
		Highcharts.chart(canvas, {
		    chart: {
		        plotBackgroundColor: null,
		        plotBorderWidth: null,
		        plotShadow: false,
		        type: 'pie',
		        backgroundColor:'rgba(255, 255, 255, 0.0)'
		    },
		    title: {
		        text: 'Browser market shares in January, 2018'
		    },
		    tooltip: {
		        pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
		    },
		    plotOptions: {
		        pie: {
		            allowPointSelect: true,
		            cursor: 'pointer',
		            dataLabels: {
		                enabled: false
		            },
		            showInLegend: true
		        }
		    },
		    series: [{
		        name: 'Brands',
		        colorByPoint: true,
		        data: [{
		            name: 'Chrome',
		            y: 61.41,
		            sliced: true,
		            selected: true
		        }, {
		            name: 'Internet Explorer',
		            y: 11.84
		        }, {
		            name: 'Firefox',
		            y: 10.85
		        }, {
		            name: 'Edge',
		            y: 4.67
		        }, {
		            name: 'Safari',
		            y: 4.18
		        }, {
		            name: 'Other',
		            y: 7.05
		        }]
		    }]
		});
	};
	
	if (type=="line"){
		Highcharts.chart(canvas, {
		    chart: {
		        zoomType: 'xy'
		    },
		    title: {
		        text: 'Average Monthly Temperature and Rainfall in Tokyo'
		    },
		    subtitle: {
		        text: 'Source: WorldClimate.com'
		    },
		    xAxis: [{
		        categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
		            'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
		        crosshair: true
		    }],
		    yAxis: [{ // Primary yAxis
		        labels: {
		            format: '{value}Â°C',
		            style: {
		                color: Highcharts.getOptions().colors[1]
		            }
		        },
		        title: {
		            text: 'Temperature',
		            style: {
		                color: Highcharts.getOptions().colors[1]
		            }
		        }
		    }, { // Secondary yAxis
		        title: {
		            text: 'Rainfall',
		            style: {
		                color: Highcharts.getOptions().colors[0]
		            }
		        },
		        labels: {
		            format: '{value} mm',
		            style: {
		                color: Highcharts.getOptions().colors[0]
		            }
		        },
		        opposite: true
		    }],
		    tooltip: {
		        shared: true
		    },
		    legend: {
		        layout: 'vertical',
		        align: 'left',
		        x: 120,
		        verticalAlign: 'top',
		        y: 100,
		        floating: true,
		        backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColor) || '#FFFFFF'
		    },
		    series: [{
		        name: 'Rainfall',
		        type: 'column',
		        yAxis: 1,
		        data: [49.9, 71.5, 106.4, 129.2, 144.0, 176.0, 135.6, 148.5, 216.4, 194.1, 95.6, 54.4],
		        tooltip: {
		            valueSuffix: ' mm'
		        }

		    }, {
		        name: 'Temperature',
		        type: 'spline',
		        data: [7.0, 6.9, 9.5, 14.5, 18.2, 21.5, 25.2, 26.5, 23.3, 18.3, 13.9, 9.6],
		        tooltip: {
		            valueSuffix: 'Â°C'
		        }
		    }]
		});
	}
	
	
	if (type=="bar"){

		Highcharts.chart(canvas, {
		    chart: {
		        type: 'column',
		        backgroundColor:'rgba(255, 255, 255, 0.0)'
		    },
		    title: {
		        text: 'Monthly Average Rainfall'
		    },
		    subtitle: {
		        text: 'Source: WorldClimate.com'
		    },
		    xAxis: {
		        categories: [
		            'Jan',
		            'Feb',
		            'Mar',
		            'Apr',
		            'May',
		            'Jun',
		            'Jul',
		            'Aug',
		            'Sep',
		            'Oct',
		            'Nov',
		            'Dec'
		        ],
		        crosshair: true
		    },
		    yAxis: {
		        min: 0,
		        title: {
		            text: 'Rainfall (mm)'
		        }
		    },
		    tooltip: {
		        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
		        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
		            '<td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',
		        footerFormat: '</table>',
		        shared: true,
		        useHTML: true
		    },
		    plotOptions: {
		        column: {
		            pointPadding: 0.2,
		            borderWidth: 0
		        }
		    },
		    series: [{
		        name: 'Tokyo',
		        data: [49.9, 71.5, 106.4, 129.2, 144.0, 176.0, 135.6, 148.5, 216.4, 194.1, 95.6, 54.4]

		    }, {
		        name: 'New York',
		        data: [83.6, 78.8, 98.5, 93.4, 106.0, 84.5, 105.0, 104.3, 91.2, 83.5, 106.6, 92.3]

		    }, {
		        name: 'London',
		        data: [48.9, 38.8, 39.3, 41.4, 47.0, 48.3, 59.0, 59.6, 52.4, 65.2, 59.3, 51.2]

		    }, {
		        name: 'Berlin',
		        data: [42.4, 33.2, 34.5, 39.7, 52.6, 75.5, 57.4, 60.4, 47.6, 39.1, 46.8, 51.1]

		    }]
		});
	}
};
//! moment.js
//! version : 2.16.0
//! authors : Tim Wood, Iskren Chernev, Moment.js contributors
//! license : MIT
//! momentjs.com
!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.moment=b()}(this,function(){"use strict";function a(){return od.apply(null,arguments)}
// This is done to register the method called with moment()
// without creating circular dependencies.
function b(a){od=a}function c(a){return a instanceof Array||"[object Array]"===Object.prototype.toString.call(a)}function d(a){
// IE8 will treat undefined and null as object if it wasn't for
// input != null
return null!=a&&"[object Object]"===Object.prototype.toString.call(a)}function e(a){var b;for(b in a)
// even if its not own property I'd still call it non-empty
return!1;return!0}function f(a){return"number"==typeof value||"[object Number]"===Object.prototype.toString.call(a)}function g(a){return a instanceof Date||"[object Date]"===Object.prototype.toString.call(a)}function h(a,b){var c,d=[];for(c=0;c<a.length;++c)d.push(b(a[c],c));return d}function i(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function j(a,b){for(var c in b)i(b,c)&&(a[c]=b[c]);return i(b,"toString")&&(a.toString=b.toString),i(b,"valueOf")&&(a.valueOf=b.valueOf),a}function k(a,b,c,d){return rb(a,b,c,d,!0).utc()}function l(){
// We need to deep clone this object.
return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1,parsedDateParts:[],meridiem:null}}function m(a){return null==a._pf&&(a._pf=l()),a._pf}function n(a){if(null==a._isValid){var b=m(a),c=qd.call(b.parsedDateParts,function(a){return null!=a}),d=!isNaN(a._d.getTime())&&b.overflow<0&&!b.empty&&!b.invalidMonth&&!b.invalidWeekday&&!b.nullInput&&!b.invalidFormat&&!b.userInvalidated&&(!b.meridiem||b.meridiem&&c);if(a._strict&&(d=d&&0===b.charsLeftOver&&0===b.unusedTokens.length&&void 0===b.bigHour),null!=Object.isFrozen&&Object.isFrozen(a))return d;a._isValid=d}return a._isValid}function o(a){var b=k(NaN);return null!=a?j(m(b),a):m(b).userInvalidated=!0,b}function p(a){return void 0===a}function q(a,b){var c,d,e;if(p(b._isAMomentObject)||(a._isAMomentObject=b._isAMomentObject),p(b._i)||(a._i=b._i),p(b._f)||(a._f=b._f),p(b._l)||(a._l=b._l),p(b._strict)||(a._strict=b._strict),p(b._tzm)||(a._tzm=b._tzm),p(b._isUTC)||(a._isUTC=b._isUTC),p(b._offset)||(a._offset=b._offset),p(b._pf)||(a._pf=m(b)),p(b._locale)||(a._locale=b._locale),rd.length>0)for(c in rd)d=rd[c],e=b[d],p(e)||(a[d]=e);return a}
// Moment prototype object
function r(b){q(this,b),this._d=new Date(null!=b._d?b._d.getTime():NaN),
// Prevent infinite loop in case updateOffset creates new moment
// objects.
sd===!1&&(sd=!0,a.updateOffset(this),sd=!1)}function s(a){return a instanceof r||null!=a&&null!=a._isAMomentObject}function t(a){return a<0?Math.ceil(a)||0:Math.floor(a)}function u(a){var b=+a,c=0;return 0!==b&&isFinite(b)&&(c=t(b)),c}
// compare two arrays, return the number of differences
function v(a,b,c){var d,e=Math.min(a.length,b.length),f=Math.abs(a.length-b.length),g=0;for(d=0;d<e;d++)(c&&a[d]!==b[d]||!c&&u(a[d])!==u(b[d]))&&g++;return g+f}function w(b){a.suppressDeprecationWarnings===!1&&"undefined"!=typeof console&&console.warn&&console.warn("Deprecation warning: "+b)}function x(b,c){var d=!0;return j(function(){if(null!=a.deprecationHandler&&a.deprecationHandler(null,b),d){for(var e,f=[],g=0;g<arguments.length;g++){if(e="","object"==typeof arguments[g]){e+="\n["+g+"] ";for(var h in arguments[0])e+=h+": "+arguments[0][h]+", ";e=e.slice(0,-2)}else e=arguments[g];f.push(e)}w(b+"\nArguments: "+Array.prototype.slice.call(f).join("")+"\n"+(new Error).stack),d=!1}return c.apply(this,arguments)},c)}function y(b,c){null!=a.deprecationHandler&&a.deprecationHandler(b,c),td[b]||(w(c),td[b]=!0)}function z(a){return a instanceof Function||"[object Function]"===Object.prototype.toString.call(a)}function A(a){var b,c;for(c in a)b=a[c],z(b)?this[c]=b:this["_"+c]=b;this._config=a,
// Lenient ordinal parsing accepts just a number in addition to
// number + (possibly) stuff coming from _ordinalParseLenient.
this._ordinalParseLenient=new RegExp(this._ordinalParse.source+"|"+/\d{1,2}/.source)}function B(a,b){var c,e=j({},a);for(c in b)i(b,c)&&(d(a[c])&&d(b[c])?(e[c]={},j(e[c],a[c]),j(e[c],b[c])):null!=b[c]?e[c]=b[c]:delete e[c]);for(c in a)i(a,c)&&!i(b,c)&&d(a[c])&&(
// make sure changes to properties don't modify parent config
e[c]=j({},e[c]));return e}function C(a){null!=a&&this.set(a)}function D(a,b,c){var d=this._calendar[a]||this._calendar.sameElse;return z(d)?d.call(b,c):d}function E(a){var b=this._longDateFormat[a],c=this._longDateFormat[a.toUpperCase()];return b||!c?b:(this._longDateFormat[a]=c.replace(/MMMM|MM|DD|dddd/g,function(a){return a.slice(1)}),this._longDateFormat[a])}function F(){return this._invalidDate}function G(a){return this._ordinal.replace("%d",a)}function H(a,b,c,d){var e=this._relativeTime[c];return z(e)?e(a,b,c,d):e.replace(/%d/i,a)}function I(a,b){var c=this._relativeTime[a>0?"future":"past"];return z(c)?c(b):c.replace(/%s/i,b)}function J(a,b){var c=a.toLowerCase();Dd[c]=Dd[c+"s"]=Dd[b]=a}function K(a){return"string"==typeof a?Dd[a]||Dd[a.toLowerCase()]:void 0}function L(a){var b,c,d={};for(c in a)i(a,c)&&(b=K(c),b&&(d[b]=a[c]));return d}function M(a,b){Ed[a]=b}function N(a){var b=[];for(var c in a)b.push({unit:c,priority:Ed[c]});return b.sort(function(a,b){return a.priority-b.priority}),b}function O(b,c){return function(d){return null!=d?(Q(this,b,d),a.updateOffset(this,c),this):P(this,b)}}function P(a,b){return a.isValid()?a._d["get"+(a._isUTC?"UTC":"")+b]():NaN}function Q(a,b,c){a.isValid()&&a._d["set"+(a._isUTC?"UTC":"")+b](c)}
// MOMENTS
function R(a){return a=K(a),z(this[a])?this[a]():this}function S(a,b){if("object"==typeof a){a=L(a);for(var c=N(a),d=0;d<c.length;d++)this[c[d].unit](a[c[d].unit])}else if(a=K(a),z(this[a]))return this[a](b);return this}function T(a,b,c){var d=""+Math.abs(a),e=b-d.length,f=a>=0;return(f?c?"+":"":"-")+Math.pow(10,Math.max(0,e)).toString().substr(1)+d}
// token:    'M'
// padded:   ['MM', 2]
// ordinal:  'Mo'
// callback: function () { this.month() + 1 }
function U(a,b,c,d){var e=d;"string"==typeof d&&(e=function(){return this[d]()}),a&&(Id[a]=e),b&&(Id[b[0]]=function(){return T(e.apply(this,arguments),b[1],b[2])}),c&&(Id[c]=function(){return this.localeData().ordinal(e.apply(this,arguments),a)})}function V(a){return a.match(/\[[\s\S]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function W(a){var b,c,d=a.match(Fd);for(b=0,c=d.length;b<c;b++)Id[d[b]]?d[b]=Id[d[b]]:d[b]=V(d[b]);return function(b){var e,f="";for(e=0;e<c;e++)f+=d[e]instanceof Function?d[e].call(b,a):d[e];return f}}
// format date using native date object
function X(a,b){return a.isValid()?(b=Y(b,a.localeData()),Hd[b]=Hd[b]||W(b),Hd[b](a)):a.localeData().invalidDate()}function Y(a,b){function c(a){return b.longDateFormat(a)||a}var d=5;for(Gd.lastIndex=0;d>=0&&Gd.test(a);)a=a.replace(Gd,c),Gd.lastIndex=0,d-=1;return a}function Z(a,b,c){$d[a]=z(b)?b:function(a,d){return a&&c?c:b}}function $(a,b){return i($d,a)?$d[a](b._strict,b._locale):new RegExp(_(a))}
// Code from http://stackoverflow.com/questions/3561493/is-there-a-regexp-escape-function-in-javascript
function _(a){return aa(a.replace("\\","").replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(a,b,c,d,e){return b||c||d||e}))}function aa(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function ba(a,b){var c,d=b;for("string"==typeof a&&(a=[a]),f(b)&&(d=function(a,c){c[b]=u(a)}),c=0;c<a.length;c++)_d[a[c]]=d}function ca(a,b){ba(a,function(a,c,d,e){d._w=d._w||{},b(a,d._w,d,e)})}function da(a,b,c){null!=b&&i(_d,a)&&_d[a](b,c._a,c,a)}function ea(a,b){return new Date(Date.UTC(a,b+1,0)).getUTCDate()}function fa(a,b){return a?c(this._months)?this._months[a.month()]:this._months[(this._months.isFormat||ke).test(b)?"format":"standalone"][a.month()]:this._months}function ga(a,b){return a?c(this._monthsShort)?this._monthsShort[a.month()]:this._monthsShort[ke.test(b)?"format":"standalone"][a.month()]:this._monthsShort}function ha(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._monthsParse)for(
// this is not used
this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[],d=0;d<12;++d)f=k([2e3,d]),this._shortMonthsParse[d]=this.monthsShort(f,"").toLocaleLowerCase(),this._longMonthsParse[d]=this.months(f,"").toLocaleLowerCase();return c?"MMM"===b?(e=je.call(this._shortMonthsParse,g),e!==-1?e:null):(e=je.call(this._longMonthsParse,g),e!==-1?e:null):"MMM"===b?(e=je.call(this._shortMonthsParse,g),e!==-1?e:(e=je.call(this._longMonthsParse,g),e!==-1?e:null)):(e=je.call(this._longMonthsParse,g),e!==-1?e:(e=je.call(this._shortMonthsParse,g),e!==-1?e:null))}function ia(a,b,c){var d,e,f;if(this._monthsParseExact)return ha.call(this,a,b,c);
// TODO: add sorting
// Sorting makes sure if one month (or abbr) is a prefix of another
// see sorting in computeMonthsParse
for(this._monthsParse||(this._monthsParse=[],this._longMonthsParse=[],this._shortMonthsParse=[]),d=0;d<12;d++){
// test the regex
if(
// make the regex if we don't have it already
e=k([2e3,d]),c&&!this._longMonthsParse[d]&&(this._longMonthsParse[d]=new RegExp("^"+this.months(e,"").replace(".","")+"$","i"),this._shortMonthsParse[d]=new RegExp("^"+this.monthsShort(e,"").replace(".","")+"$","i")),c||this._monthsParse[d]||(f="^"+this.months(e,"")+"|^"+this.monthsShort(e,""),this._monthsParse[d]=new RegExp(f.replace(".",""),"i")),c&&"MMMM"===b&&this._longMonthsParse[d].test(a))return d;if(c&&"MMM"===b&&this._shortMonthsParse[d].test(a))return d;if(!c&&this._monthsParse[d].test(a))return d}}
// MOMENTS
function ja(a,b){var c;if(!a.isValid())
// No op
return a;if("string"==typeof b)if(/^\d+$/.test(b))b=u(b);else
// TODO: Another silent failure?
if(b=a.localeData().monthsParse(b),!f(b))return a;return c=Math.min(a.date(),ea(a.year(),b)),a._d["set"+(a._isUTC?"UTC":"")+"Month"](b,c),a}function ka(b){return null!=b?(ja(this,b),a.updateOffset(this,!0),this):P(this,"Month")}function la(){return ea(this.year(),this.month())}function ma(a){return this._monthsParseExact?(i(this,"_monthsRegex")||oa.call(this),a?this._monthsShortStrictRegex:this._monthsShortRegex):(i(this,"_monthsShortRegex")||(this._monthsShortRegex=ne),this._monthsShortStrictRegex&&a?this._monthsShortStrictRegex:this._monthsShortRegex)}function na(a){return this._monthsParseExact?(i(this,"_monthsRegex")||oa.call(this),a?this._monthsStrictRegex:this._monthsRegex):(i(this,"_monthsRegex")||(this._monthsRegex=oe),this._monthsStrictRegex&&a?this._monthsStrictRegex:this._monthsRegex)}function oa(){function a(a,b){return b.length-a.length}var b,c,d=[],e=[],f=[];for(b=0;b<12;b++)
// make the regex if we don't have it already
c=k([2e3,b]),d.push(this.monthsShort(c,"")),e.push(this.months(c,"")),f.push(this.months(c,"")),f.push(this.monthsShort(c,""));for(
// Sorting makes sure if one month (or abbr) is a prefix of another it
// will match the longer piece.
d.sort(a),e.sort(a),f.sort(a),b=0;b<12;b++)d[b]=aa(d[b]),e[b]=aa(e[b]);for(b=0;b<24;b++)f[b]=aa(f[b]);this._monthsRegex=new RegExp("^("+f.join("|")+")","i"),this._monthsShortRegex=this._monthsRegex,this._monthsStrictRegex=new RegExp("^("+e.join("|")+")","i"),this._monthsShortStrictRegex=new RegExp("^("+d.join("|")+")","i")}
// HELPERS
function pa(a){return qa(a)?366:365}function qa(a){return a%4===0&&a%100!==0||a%400===0}function ra(){return qa(this.year())}function sa(a,b,c,d,e,f,g){
//can't just apply() to create a date:
//http://stackoverflow.com/questions/181348/instantiating-a-javascript-object-by-calling-prototype-constructor-apply
var h=new Date(a,b,c,d,e,f,g);
//the date constructor remaps years 0-99 to 1900-1999
return a<100&&a>=0&&isFinite(h.getFullYear())&&h.setFullYear(a),h}function ta(a){var b=new Date(Date.UTC.apply(null,arguments));
//the Date.UTC function remaps years 0-99 to 1900-1999
return a<100&&a>=0&&isFinite(b.getUTCFullYear())&&b.setUTCFullYear(a),b}
// start-of-first-week - start-of-year
function ua(a,b,c){var// first-week day -- which january is always in the first week (4 for iso, 1 for other)
d=7+b-c,
// first-week day local weekday -- which local weekday is fwd
e=(7+ta(a,0,d).getUTCDay()-b)%7;return-e+d-1}
//http://en.wikipedia.org/wiki/ISO_week_date#Calculating_a_date_given_the_year.2C_week_number_and_weekday
function va(a,b,c,d,e){var f,g,h=(7+c-d)%7,i=ua(a,d,e),j=1+7*(b-1)+h+i;return j<=0?(f=a-1,g=pa(f)+j):j>pa(a)?(f=a+1,g=j-pa(a)):(f=a,g=j),{year:f,dayOfYear:g}}function wa(a,b,c){var d,e,f=ua(a.year(),b,c),g=Math.floor((a.dayOfYear()-f-1)/7)+1;return g<1?(e=a.year()-1,d=g+xa(e,b,c)):g>xa(a.year(),b,c)?(d=g-xa(a.year(),b,c),e=a.year()+1):(e=a.year(),d=g),{week:d,year:e}}function xa(a,b,c){var d=ua(a,b,c),e=ua(a+1,b,c);return(pa(a)-d+e)/7}
// HELPERS
// LOCALES
function ya(a){return wa(a,this._week.dow,this._week.doy).week}function za(){return this._week.dow}function Aa(){return this._week.doy}
// MOMENTS
function Ba(a){var b=this.localeData().week(this);return null==a?b:this.add(7*(a-b),"d")}function Ca(a){var b=wa(this,1,4).week;return null==a?b:this.add(7*(a-b),"d")}
// HELPERS
function Da(a,b){return"string"!=typeof a?a:isNaN(a)?(a=b.weekdaysParse(a),"number"==typeof a?a:null):parseInt(a,10)}function Ea(a,b){return"string"==typeof a?b.weekdaysParse(a)%7||7:isNaN(a)?null:a}function Fa(a,b){return a?c(this._weekdays)?this._weekdays[a.day()]:this._weekdays[this._weekdays.isFormat.test(b)?"format":"standalone"][a.day()]:this._weekdays}function Ga(a){return a?this._weekdaysShort[a.day()]:this._weekdaysShort}function Ha(a){return a?this._weekdaysMin[a.day()]:this._weekdaysMin}function Ia(a,b,c){var d,e,f,g=a.toLocaleLowerCase();if(!this._weekdaysParse)for(this._weekdaysParse=[],this._shortWeekdaysParse=[],this._minWeekdaysParse=[],d=0;d<7;++d)f=k([2e3,1]).day(d),this._minWeekdaysParse[d]=this.weekdaysMin(f,"").toLocaleLowerCase(),this._shortWeekdaysParse[d]=this.weekdaysShort(f,"").toLocaleLowerCase(),this._weekdaysParse[d]=this.weekdays(f,"").toLocaleLowerCase();return c?"dddd"===b?(e=je.call(this._weekdaysParse,g),e!==-1?e:null):"ddd"===b?(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:null):(e=je.call(this._minWeekdaysParse,g),e!==-1?e:null):"dddd"===b?(e=je.call(this._weekdaysParse,g),e!==-1?e:(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:(e=je.call(this._minWeekdaysParse,g),e!==-1?e:null))):"ddd"===b?(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:(e=je.call(this._weekdaysParse,g),e!==-1?e:(e=je.call(this._minWeekdaysParse,g),e!==-1?e:null))):(e=je.call(this._minWeekdaysParse,g),e!==-1?e:(e=je.call(this._weekdaysParse,g),e!==-1?e:(e=je.call(this._shortWeekdaysParse,g),e!==-1?e:null)))}function Ja(a,b,c){var d,e,f;if(this._weekdaysParseExact)return Ia.call(this,a,b,c);for(this._weekdaysParse||(this._weekdaysParse=[],this._minWeekdaysParse=[],this._shortWeekdaysParse=[],this._fullWeekdaysParse=[]),d=0;d<7;d++){
// test the regex
if(
// make the regex if we don't have it already
e=k([2e3,1]).day(d),c&&!this._fullWeekdaysParse[d]&&(this._fullWeekdaysParse[d]=new RegExp("^"+this.weekdays(e,"").replace(".",".?")+"$","i"),this._shortWeekdaysParse[d]=new RegExp("^"+this.weekdaysShort(e,"").replace(".",".?")+"$","i"),this._minWeekdaysParse[d]=new RegExp("^"+this.weekdaysMin(e,"").replace(".",".?")+"$","i")),this._weekdaysParse[d]||(f="^"+this.weekdays(e,"")+"|^"+this.weekdaysShort(e,"")+"|^"+this.weekdaysMin(e,""),this._weekdaysParse[d]=new RegExp(f.replace(".",""),"i")),c&&"dddd"===b&&this._fullWeekdaysParse[d].test(a))return d;if(c&&"ddd"===b&&this._shortWeekdaysParse[d].test(a))return d;if(c&&"dd"===b&&this._minWeekdaysParse[d].test(a))return d;if(!c&&this._weekdaysParse[d].test(a))return d}}
// MOMENTS
function Ka(a){if(!this.isValid())return null!=a?this:NaN;var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=a?(a=Da(a,this.localeData()),this.add(a-b,"d")):b}function La(a){if(!this.isValid())return null!=a?this:NaN;var b=(this.day()+7-this.localeData()._week.dow)%7;return null==a?b:this.add(a-b,"d")}function Ma(a){if(!this.isValid())return null!=a?this:NaN;
// behaves the same as moment#day except
// as a getter, returns 7 instead of 0 (1-7 range instead of 0-6)
// as a setter, sunday should belong to the previous week.
if(null!=a){var b=Ea(a,this.localeData());return this.day(this.day()%7?b:b-7)}return this.day()||7}function Na(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysStrictRegex:this._weekdaysRegex):(i(this,"_weekdaysRegex")||(this._weekdaysRegex=ue),this._weekdaysStrictRegex&&a?this._weekdaysStrictRegex:this._weekdaysRegex)}function Oa(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex):(i(this,"_weekdaysShortRegex")||(this._weekdaysShortRegex=ve),this._weekdaysShortStrictRegex&&a?this._weekdaysShortStrictRegex:this._weekdaysShortRegex)}function Pa(a){return this._weekdaysParseExact?(i(this,"_weekdaysRegex")||Qa.call(this),a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex):(i(this,"_weekdaysMinRegex")||(this._weekdaysMinRegex=we),this._weekdaysMinStrictRegex&&a?this._weekdaysMinStrictRegex:this._weekdaysMinRegex)}function Qa(){function a(a,b){return b.length-a.length}var b,c,d,e,f,g=[],h=[],i=[],j=[];for(b=0;b<7;b++)
// make the regex if we don't have it already
c=k([2e3,1]).day(b),d=this.weekdaysMin(c,""),e=this.weekdaysShort(c,""),f=this.weekdays(c,""),g.push(d),h.push(e),i.push(f),j.push(d),j.push(e),j.push(f);for(
// Sorting makes sure if one weekday (or abbr) is a prefix of another it
// will match the longer piece.
g.sort(a),h.sort(a),i.sort(a),j.sort(a),b=0;b<7;b++)h[b]=aa(h[b]),i[b]=aa(i[b]),j[b]=aa(j[b]);this._weekdaysRegex=new RegExp("^("+j.join("|")+")","i"),this._weekdaysShortRegex=this._weekdaysRegex,this._weekdaysMinRegex=this._weekdaysRegex,this._weekdaysStrictRegex=new RegExp("^("+i.join("|")+")","i"),this._weekdaysShortStrictRegex=new RegExp("^("+h.join("|")+")","i"),this._weekdaysMinStrictRegex=new RegExp("^("+g.join("|")+")","i")}
// FORMATTING
function Ra(){return this.hours()%12||12}function Sa(){return this.hours()||24}function Ta(a,b){U(a,0,0,function(){return this.localeData().meridiem(this.hours(),this.minutes(),b)})}
// PARSING
function Ua(a,b){return b._meridiemParse}
// LOCALES
function Va(a){
// IE8 Quirks Mode & IE7 Standards Mode do not allow accessing strings like arrays
// Using charAt should be more compatible.
return"p"===(a+"").toLowerCase().charAt(0)}function Wa(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"}function Xa(a){return a?a.toLowerCase().replace("_","-"):a}
// pick the locale from the array
// try ['en-au', 'en-gb'] as 'en-au', 'en-gb', 'en', as in move through the list trying each
// substring from most specific to least, but move to the next array item if it's a more specific variant than the current root
function Ya(a){for(var b,c,d,e,f=0;f<a.length;){for(e=Xa(a[f]).split("-"),b=e.length,c=Xa(a[f+1]),c=c?c.split("-"):null;b>0;){if(d=Za(e.slice(0,b).join("-")))return d;if(c&&c.length>=b&&v(e,c,!0)>=b-1)
//the next array item is better than a shallower substring of this one
break;b--}f++}return null}function Za(a){var b=null;
// TODO: Find a better way to register and load all the locales in Node
if(!Be[a]&&"undefined"!=typeof module&&module&&module.exports)try{b=xe._abbr,require("./locale/"+a),
// because defineLocale currently also sets the global locale, we
// want to undo that for lazy loaded locales
$a(b)}catch(a){}return Be[a]}
// This function will load locale and then set the global locale.  If
// no arguments are passed in, it will simply return the current global
// locale key.
function $a(a,b){var c;
// moment.duration._locale = moment._locale = data;
return a&&(c=p(b)?bb(a):_a(a,b),c&&(xe=c)),xe._abbr}function _a(a,b){if(null!==b){var c=Ae;if(b.abbr=a,null!=Be[a])y("defineLocaleOverride","use moment.updateLocale(localeName, config) to change an existing locale. moment.defineLocale(localeName, config) should only be used for creating a new locale See http://momentjs.com/guides/#/warnings/define-locale/ for more info."),c=Be[a]._config;else if(null!=b.parentLocale){if(null==Be[b.parentLocale])return Ce[b.parentLocale]||(Ce[b.parentLocale]=[]),Ce[b.parentLocale].push({name:a,config:b}),null;c=Be[b.parentLocale]._config}
// backwards compat for now: also set the locale
// make sure we set the locale AFTER all child locales have been
// created, so we won't end up with the child locale set.
return Be[a]=new C(B(c,b)),Ce[a]&&Ce[a].forEach(function(a){_a(a.name,a.config)}),$a(a),Be[a]}
// useful for testing
return delete Be[a],null}function ab(a,b){if(null!=b){var c,d=Ae;
// MERGE
null!=Be[a]&&(d=Be[a]._config),b=B(d,b),c=new C(b),c.parentLocale=Be[a],Be[a]=c,
// backwards compat for now: also set the locale
$a(a)}else
// pass null for config to unupdate, useful for tests
null!=Be[a]&&(null!=Be[a].parentLocale?Be[a]=Be[a].parentLocale:null!=Be[a]&&delete Be[a]);return Be[a]}
// returns locale data
function bb(a){var b;if(a&&a._locale&&a._locale._abbr&&(a=a._locale._abbr),!a)return xe;if(!c(a)){if(
//short-circuit everything else
b=Za(a))return b;a=[a]}return Ya(a)}function cb(){return wd(Be)}function db(a){var b,c=a._a;return c&&m(a).overflow===-2&&(b=c[be]<0||c[be]>11?be:c[ce]<1||c[ce]>ea(c[ae],c[be])?ce:c[de]<0||c[de]>24||24===c[de]&&(0!==c[ee]||0!==c[fe]||0!==c[ge])?de:c[ee]<0||c[ee]>59?ee:c[fe]<0||c[fe]>59?fe:c[ge]<0||c[ge]>999?ge:-1,m(a)._overflowDayOfYear&&(b<ae||b>ce)&&(b=ce),m(a)._overflowWeeks&&b===-1&&(b=he),m(a)._overflowWeekday&&b===-1&&(b=ie),m(a).overflow=b),a}
// date from iso format
function eb(a){var b,c,d,e,f,g,h=a._i,i=De.exec(h)||Ee.exec(h);if(i){for(m(a).iso=!0,b=0,c=Ge.length;b<c;b++)if(Ge[b][1].exec(i[1])){e=Ge[b][0],d=Ge[b][2]!==!1;break}if(null==e)return void(a._isValid=!1);if(i[3]){for(b=0,c=He.length;b<c;b++)if(He[b][1].exec(i[3])){
// match[2] should be 'T' or space
f=(i[2]||" ")+He[b][0];break}if(null==f)return void(a._isValid=!1)}if(!d&&null!=f)return void(a._isValid=!1);if(i[4]){if(!Fe.exec(i[4]))return void(a._isValid=!1);g="Z"}a._f=e+(f||"")+(g||""),kb(a)}else a._isValid=!1}
// date from iso format or fallback
function fb(b){var c=Ie.exec(b._i);return null!==c?void(b._d=new Date(+c[1])):(eb(b),void(b._isValid===!1&&(delete b._isValid,a.createFromInputFallback(b))))}
// Pick the first defined of two or three arguments.
function gb(a,b,c){return null!=a?a:null!=b?b:c}function hb(b){
// hooks is actually the exported moment object
var c=new Date(a.now());return b._useUTC?[c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()]:[c.getFullYear(),c.getMonth(),c.getDate()]}
// convert an array to a date.
// the array should mirror the parameters below
// note: all values past the year are optional and will default to the lowest possible value.
// [year, month, day , hour, minute, second, millisecond]
function ib(a){var b,c,d,e,f=[];if(!a._d){
// Default to current date.
// * if no year, month, day of month are given, default to today
// * if day of month is given, default month and year
// * if month is given, default only year
// * if year is given, don't default anything
for(d=hb(a),
//compute day of the year from weeks and weekdays
a._w&&null==a._a[ce]&&null==a._a[be]&&jb(a),
//if the day of the year is set, figure out what it is
a._dayOfYear&&(e=gb(a._a[ae],d[ae]),a._dayOfYear>pa(e)&&(m(a)._overflowDayOfYear=!0),c=ta(e,0,a._dayOfYear),a._a[be]=c.getUTCMonth(),a._a[ce]=c.getUTCDate()),b=0;b<3&&null==a._a[b];++b)a._a[b]=f[b]=d[b];
// Zero out whatever was not defaulted, including time
for(;b<7;b++)a._a[b]=f[b]=null==a._a[b]?2===b?1:0:a._a[b];
// Check for 24:00:00.000
24===a._a[de]&&0===a._a[ee]&&0===a._a[fe]&&0===a._a[ge]&&(a._nextDay=!0,a._a[de]=0),a._d=(a._useUTC?ta:sa).apply(null,f),
// Apply timezone offset from input. The actual utcOffset can be changed
// with parseZone.
null!=a._tzm&&a._d.setUTCMinutes(a._d.getUTCMinutes()-a._tzm),a._nextDay&&(a._a[de]=24)}}function jb(a){var b,c,d,e,f,g,h,i;if(b=a._w,null!=b.GG||null!=b.W||null!=b.E)f=1,g=4,
// TODO: We need to take the current isoWeekYear, but that depends on
// how we interpret now (local, utc, fixed offset). So create
// a now version of current config (take local/utc/offset flags, and
// create now).
c=gb(b.GG,a._a[ae],wa(sb(),1,4).year),d=gb(b.W,1),e=gb(b.E,1),(e<1||e>7)&&(i=!0);else{f=a._locale._week.dow,g=a._locale._week.doy;var j=wa(sb(),f,g);c=gb(b.gg,a._a[ae],j.year),
// Default to current week.
d=gb(b.w,j.week),null!=b.d?(
// weekday -- low day numbers are considered next week
e=b.d,(e<0||e>6)&&(i=!0)):null!=b.e?(
// local weekday -- counting starts from begining of week
e=b.e+f,(b.e<0||b.e>6)&&(i=!0)):
// default to begining of week
e=f}d<1||d>xa(c,f,g)?m(a)._overflowWeeks=!0:null!=i?m(a)._overflowWeekday=!0:(h=va(c,d,e,f,g),a._a[ae]=h.year,a._dayOfYear=h.dayOfYear)}
// date from string and format string
function kb(b){
// TODO: Move this to another part of the creation flow to prevent circular deps
if(b._f===a.ISO_8601)return void eb(b);b._a=[],m(b).empty=!0;
// This array is used to make a Date, either with `new Date` or `Date.UTC`
var c,d,e,f,g,h=""+b._i,i=h.length,j=0;for(e=Y(b._f,b._locale).match(Fd)||[],c=0;c<e.length;c++)f=e[c],d=(h.match($(f,b))||[])[0],
// console.log('token', token, 'parsedInput', parsedInput,
//         'regex', getParseRegexForToken(token, config));
d&&(g=h.substr(0,h.indexOf(d)),g.length>0&&m(b).unusedInput.push(g),h=h.slice(h.indexOf(d)+d.length),j+=d.length),
// don't parse if it's not a known token
Id[f]?(d?m(b).empty=!1:m(b).unusedTokens.push(f),da(f,d,b)):b._strict&&!d&&m(b).unusedTokens.push(f);
// add remaining unparsed input length to the string
m(b).charsLeftOver=i-j,h.length>0&&m(b).unusedInput.push(h),
// clear _12h flag if hour is <= 12
b._a[de]<=12&&m(b).bigHour===!0&&b._a[de]>0&&(m(b).bigHour=void 0),m(b).parsedDateParts=b._a.slice(0),m(b).meridiem=b._meridiem,
// handle meridiem
b._a[de]=lb(b._locale,b._a[de],b._meridiem),ib(b),db(b)}function lb(a,b,c){var d;
// Fallback
return null==c?b:null!=a.meridiemHour?a.meridiemHour(b,c):null!=a.isPM?(d=a.isPM(c),d&&b<12&&(b+=12),d||12!==b||(b=0),b):b}
// date from string and array of format strings
function mb(a){var b,c,d,e,f;if(0===a._f.length)return m(a).invalidFormat=!0,void(a._d=new Date(NaN));for(e=0;e<a._f.length;e++)f=0,b=q({},a),null!=a._useUTC&&(b._useUTC=a._useUTC),b._f=a._f[e],kb(b),n(b)&&(
// if there is any input that was not parsed add a penalty for that format
f+=m(b).charsLeftOver,
//or tokens
f+=10*m(b).unusedTokens.length,m(b).score=f,(null==d||f<d)&&(d=f,c=b));j(a,c||b)}function nb(a){if(!a._d){var b=L(a._i);a._a=h([b.year,b.month,b.day||b.date,b.hour,b.minute,b.second,b.millisecond],function(a){return a&&parseInt(a,10)}),ib(a)}}function ob(a){var b=new r(db(pb(a)));
// Adding is smart enough around DST
return b._nextDay&&(b.add(1,"d"),b._nextDay=void 0),b}function pb(a){var b=a._i,d=a._f;return a._locale=a._locale||bb(a._l),null===b||void 0===d&&""===b?o({nullInput:!0}):("string"==typeof b&&(a._i=b=a._locale.preparse(b)),s(b)?new r(db(b)):(g(b)?a._d=b:c(d)?mb(a):d?kb(a):qb(a),n(a)||(a._d=null),a))}function qb(b){var d=b._i;void 0===d?b._d=new Date(a.now()):g(d)?b._d=new Date(d.valueOf()):"string"==typeof d?fb(b):c(d)?(b._a=h(d.slice(0),function(a){return parseInt(a,10)}),ib(b)):"object"==typeof d?nb(b):f(d)?
// from milliseconds
b._d=new Date(d):a.createFromInputFallback(b)}function rb(a,b,f,g,h){var i={};
// object construction must be done this way.
// https://github.com/moment/moment/issues/1423
return f!==!0&&f!==!1||(g=f,f=void 0),(d(a)&&e(a)||c(a)&&0===a.length)&&(a=void 0),i._isAMomentObject=!0,i._useUTC=i._isUTC=h,i._l=f,i._i=a,i._f=b,i._strict=g,ob(i)}function sb(a,b,c,d){return rb(a,b,c,d,!1)}
// Pick a moment m from moments so that m[fn](other) is true for all
// other. This relies on the function fn to be transitive.
//
// moments should either be an array of moment objects or an array, whose
// first element is an array of moment objects.
function tb(a,b){var d,e;if(1===b.length&&c(b[0])&&(b=b[0]),!b.length)return sb();for(d=b[0],e=1;e<b.length;++e)b[e].isValid()&&!b[e][a](d)||(d=b[e]);return d}
// TODO: Use [].sort instead?
function ub(){var a=[].slice.call(arguments,0);return tb("isBefore",a)}function vb(){var a=[].slice.call(arguments,0);return tb("isAfter",a)}function wb(a){var b=L(a),c=b.year||0,d=b.quarter||0,e=b.month||0,f=b.week||0,g=b.day||0,h=b.hour||0,i=b.minute||0,j=b.second||0,k=b.millisecond||0;
// representation for dateAddRemove
this._milliseconds=+k+1e3*j+// 1000
6e4*i+// 1000 * 60
1e3*h*60*60,//using 1000 * 60 * 60 instead of 36e5 to avoid floating point rounding errors https://github.com/moment/moment/issues/2978
// Because of dateAddRemove treats 24 hours as different from a
// day when working around DST, we need to store them separately
this._days=+g+7*f,
// It is impossible translate months into days without knowing
// which months you are are talking about, so we have to store
// it separately.
this._months=+e+3*d+12*c,this._data={},this._locale=bb(),this._bubble()}function xb(a){return a instanceof wb}function yb(a){return a<0?Math.round(-1*a)*-1:Math.round(a)}
// FORMATTING
function zb(a,b){U(a,0,0,function(){var a=this.utcOffset(),c="+";return a<0&&(a=-a,c="-"),c+T(~~(a/60),2)+b+T(~~a%60,2)})}function Ab(a,b){var c=(b||"").match(a);if(null===c)return null;var d=c[c.length-1]||[],e=(d+"").match(Me)||["-",0,0],f=+(60*e[1])+u(e[2]);return 0===f?0:"+"===e[0]?f:-f}
// Return a moment from input, that is local/utc/zone equivalent to model.
function Bb(b,c){var d,e;
// Use low-level api, because this fn is low-level api.
return c._isUTC?(d=c.clone(),e=(s(b)||g(b)?b.valueOf():sb(b).valueOf())-d.valueOf(),d._d.setTime(d._d.valueOf()+e),a.updateOffset(d,!1),d):sb(b).local()}function Cb(a){
// On Firefox.24 Date#getTimezoneOffset returns a floating point.
// https://github.com/moment/moment/pull/1871
return 15*-Math.round(a._d.getTimezoneOffset()/15)}
// MOMENTS
// keepLocalTime = true means only change the timezone, without
// affecting the local hour. So 5:31:26 +0300 --[utcOffset(2, true)]-->
// 5:31:26 +0200 It is possible that 5:31:26 doesn't exist with offset
// +0200, so we adjust the time as needed, to be valid.
//
// Keeping the time actually adds/subtracts (one hour)
// from the actual represented time. That is why we call updateOffset
// a second time. In case it wants us to change the offset again
// _changeInProgress == true case, then we have to adjust, because
// there is no such time in the given timezone.
function Db(b,c){var d,e=this._offset||0;if(!this.isValid())return null!=b?this:NaN;if(null!=b){if("string"==typeof b){if(b=Ab(Xd,b),null===b)return this}else Math.abs(b)<16&&(b=60*b);return!this._isUTC&&c&&(d=Cb(this)),this._offset=b,this._isUTC=!0,null!=d&&this.add(d,"m"),e!==b&&(!c||this._changeInProgress?Tb(this,Ob(b-e,"m"),1,!1):this._changeInProgress||(this._changeInProgress=!0,a.updateOffset(this,!0),this._changeInProgress=null)),this}return this._isUTC?e:Cb(this)}function Eb(a,b){return null!=a?("string"!=typeof a&&(a=-a),this.utcOffset(a,b),this):-this.utcOffset()}function Fb(a){return this.utcOffset(0,a)}function Gb(a){return this._isUTC&&(this.utcOffset(0,a),this._isUTC=!1,a&&this.subtract(Cb(this),"m")),this}function Hb(){if(null!=this._tzm)this.utcOffset(this._tzm);else if("string"==typeof this._i){var a=Ab(Wd,this._i);null!=a?this.utcOffset(a):this.utcOffset(0,!0)}return this}function Ib(a){return!!this.isValid()&&(a=a?sb(a).utcOffset():0,(this.utcOffset()-a)%60===0)}function Jb(){return this.utcOffset()>this.clone().month(0).utcOffset()||this.utcOffset()>this.clone().month(5).utcOffset()}function Kb(){if(!p(this._isDSTShifted))return this._isDSTShifted;var a={};if(q(a,this),a=pb(a),a._a){var b=a._isUTC?k(a._a):sb(a._a);this._isDSTShifted=this.isValid()&&v(a._a,b.toArray())>0}else this._isDSTShifted=!1;return this._isDSTShifted}function Lb(){return!!this.isValid()&&!this._isUTC}function Mb(){return!!this.isValid()&&this._isUTC}function Nb(){return!!this.isValid()&&(this._isUTC&&0===this._offset)}function Ob(a,b){var c,d,e,g=a,
// matching against regexp is expensive, do it on demand
h=null;// checks for null or undefined
return xb(a)?g={ms:a._milliseconds,d:a._days,M:a._months}:f(a)?(g={},b?g[b]=a:g.milliseconds=a):(h=Ne.exec(a))?(c="-"===h[1]?-1:1,g={y:0,d:u(h[ce])*c,h:u(h[de])*c,m:u(h[ee])*c,s:u(h[fe])*c,ms:u(yb(1e3*h[ge]))*c}):(h=Oe.exec(a))?(c="-"===h[1]?-1:1,g={y:Pb(h[2],c),M:Pb(h[3],c),w:Pb(h[4],c),d:Pb(h[5],c),h:Pb(h[6],c),m:Pb(h[7],c),s:Pb(h[8],c)}):null==g?g={}:"object"==typeof g&&("from"in g||"to"in g)&&(e=Rb(sb(g.from),sb(g.to)),g={},g.ms=e.milliseconds,g.M=e.months),d=new wb(g),xb(a)&&i(a,"_locale")&&(d._locale=a._locale),d}function Pb(a,b){
// We'd normally use ~~inp for this, but unfortunately it also
// converts floats to ints.
// inp may be undefined, so careful calling replace on it.
var c=a&&parseFloat(a.replace(",","."));
// apply sign while we're at it
return(isNaN(c)?0:c)*b}function Qb(a,b){var c={milliseconds:0,months:0};return c.months=b.month()-a.month()+12*(b.year()-a.year()),a.clone().add(c.months,"M").isAfter(b)&&--c.months,c.milliseconds=+b-+a.clone().add(c.months,"M"),c}function Rb(a,b){var c;return a.isValid()&&b.isValid()?(b=Bb(b,a),a.isBefore(b)?c=Qb(a,b):(c=Qb(b,a),c.milliseconds=-c.milliseconds,c.months=-c.months),c):{milliseconds:0,months:0}}
// TODO: remove 'name' arg after deprecation is removed
function Sb(a,b){return function(c,d){var e,f;
//invert the arguments, but complain about it
return null===d||isNaN(+d)||(y(b,"moment()."+b+"(period, number) is deprecated. Please use moment()."+b+"(number, period). See http://momentjs.com/guides/#/warnings/add-inverted-param/ for more info."),f=c,c=d,d=f),c="string"==typeof c?+c:c,e=Ob(c,d),Tb(this,e,a),this}}function Tb(b,c,d,e){var f=c._milliseconds,g=yb(c._days),h=yb(c._months);b.isValid()&&(e=null==e||e,f&&b._d.setTime(b._d.valueOf()+f*d),g&&Q(b,"Date",P(b,"Date")+g*d),h&&ja(b,P(b,"Month")+h*d),e&&a.updateOffset(b,g||h))}function Ub(a,b){var c=a.diff(b,"days",!0);return c<-6?"sameElse":c<-1?"lastWeek":c<0?"lastDay":c<1?"sameDay":c<2?"nextDay":c<7?"nextWeek":"sameElse"}function Vb(b,c){
// We want to compare the start of today, vs this.
// Getting start-of-today depends on whether we're local/utc/offset or not.
var d=b||sb(),e=Bb(d,this).startOf("day"),f=a.calendarFormat(this,e)||"sameElse",g=c&&(z(c[f])?c[f].call(this,d):c[f]);return this.format(g||this.localeData().calendar(f,this,sb(d)))}function Wb(){return new r(this)}function Xb(a,b){var c=s(a)?a:sb(a);return!(!this.isValid()||!c.isValid())&&(b=K(p(b)?"millisecond":b),"millisecond"===b?this.valueOf()>c.valueOf():c.valueOf()<this.clone().startOf(b).valueOf())}function Yb(a,b){var c=s(a)?a:sb(a);return!(!this.isValid()||!c.isValid())&&(b=K(p(b)?"millisecond":b),"millisecond"===b?this.valueOf()<c.valueOf():this.clone().endOf(b).valueOf()<c.valueOf())}function Zb(a,b,c,d){return d=d||"()",("("===d[0]?this.isAfter(a,c):!this.isBefore(a,c))&&(")"===d[1]?this.isBefore(b,c):!this.isAfter(b,c))}function $b(a,b){var c,d=s(a)?a:sb(a);return!(!this.isValid()||!d.isValid())&&(b=K(b||"millisecond"),"millisecond"===b?this.valueOf()===d.valueOf():(c=d.valueOf(),this.clone().startOf(b).valueOf()<=c&&c<=this.clone().endOf(b).valueOf()))}function _b(a,b){return this.isSame(a,b)||this.isAfter(a,b)}function ac(a,b){return this.isSame(a,b)||this.isBefore(a,b)}function bc(a,b,c){var d,e,f,g;// 1000
// 1000 * 60
// 1000 * 60 * 60
// 1000 * 60 * 60 * 24, negate dst
// 1000 * 60 * 60 * 24 * 7, negate dst
return this.isValid()?(d=Bb(a,this),d.isValid()?(e=6e4*(d.utcOffset()-this.utcOffset()),b=K(b),"year"===b||"month"===b||"quarter"===b?(g=cc(this,d),"quarter"===b?g/=3:"year"===b&&(g/=12)):(f=this-d,g="second"===b?f/1e3:"minute"===b?f/6e4:"hour"===b?f/36e5:"day"===b?(f-e)/864e5:"week"===b?(f-e)/6048e5:f),c?g:t(g)):NaN):NaN}function cc(a,b){
// difference in months
var c,d,e=12*(b.year()-a.year())+(b.month()-a.month()),
// b is in (anchor - 1 month, anchor + 1 month)
f=a.clone().add(e,"months");
//check for negative zero, return zero if negative zero
// linear across the month
// linear across the month
return b-f<0?(c=a.clone().add(e-1,"months"),d=(b-f)/(f-c)):(c=a.clone().add(e+1,"months"),d=(b-f)/(c-f)),-(e+d)||0}function dc(){return this.clone().locale("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")}function ec(){var a=this.clone().utc();return 0<a.year()&&a.year()<=9999?z(Date.prototype.toISOString)?this.toDate().toISOString():X(a,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):X(a,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")}/**
 * Return a human readable representation of a moment that can
 * also be evaluated to get a new moment which is the same
 *
 * @link https://nodejs.org/dist/latest/docs/api/util.html#util_custom_inspect_function_on_objects
 */
function fc(){if(!this.isValid())return"moment.invalid(/* "+this._i+" */)";var a="moment",b="";this.isLocal()||(a=0===this.utcOffset()?"moment.utc":"moment.parseZone",b="Z");var c="["+a+'("]',d=0<this.year()&&this.year()<=9999?"YYYY":"YYYYYY",e="-MM-DD[T]HH:mm:ss.SSS",f=b+'[")]';return this.format(c+d+e+f)}function gc(b){b||(b=this.isUtc()?a.defaultFormatUtc:a.defaultFormat);var c=X(this,b);return this.localeData().postformat(c)}function hc(a,b){return this.isValid()&&(s(a)&&a.isValid()||sb(a).isValid())?Ob({to:this,from:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function ic(a){return this.from(sb(),a)}function jc(a,b){return this.isValid()&&(s(a)&&a.isValid()||sb(a).isValid())?Ob({from:this,to:a}).locale(this.locale()).humanize(!b):this.localeData().invalidDate()}function kc(a){return this.to(sb(),a)}
// If passed a locale key, it will set the locale for this
// instance.  Otherwise, it will return the locale configuration
// variables for this instance.
function lc(a){var b;return void 0===a?this._locale._abbr:(b=bb(a),null!=b&&(this._locale=b),this)}function mc(){return this._locale}function nc(a){
// the following switch intentionally omits break keywords
// to utilize falling through the cases.
switch(a=K(a)){case"year":this.month(0);/* falls through */
case"quarter":case"month":this.date(1);/* falls through */
case"week":case"isoWeek":case"day":case"date":this.hours(0);/* falls through */
case"hour":this.minutes(0);/* falls through */
case"minute":this.seconds(0);/* falls through */
case"second":this.milliseconds(0)}
// weeks are a special case
// quarters are also special
return"week"===a&&this.weekday(0),"isoWeek"===a&&this.isoWeekday(1),"quarter"===a&&this.month(3*Math.floor(this.month()/3)),this}function oc(a){
// 'date' is an alias for 'day', so it should be considered as such.
return a=K(a),void 0===a||"millisecond"===a?this:("date"===a&&(a="day"),this.startOf(a).add(1,"isoWeek"===a?"week":a).subtract(1,"ms"))}function pc(){return this._d.valueOf()-6e4*(this._offset||0)}function qc(){return Math.floor(this.valueOf()/1e3)}function rc(){return new Date(this.valueOf())}function sc(){var a=this;return[a.year(),a.month(),a.date(),a.hour(),a.minute(),a.second(),a.millisecond()]}function tc(){var a=this;return{years:a.year(),months:a.month(),date:a.date(),hours:a.hours(),minutes:a.minutes(),seconds:a.seconds(),milliseconds:a.milliseconds()}}function uc(){
// new Date(NaN).toJSON() === null
return this.isValid()?this.toISOString():null}function vc(){return n(this)}function wc(){return j({},m(this))}function xc(){return m(this).overflow}function yc(){return{input:this._i,format:this._f,locale:this._locale,isUTC:this._isUTC,strict:this._strict}}function zc(a,b){U(0,[a,a.length],0,b)}
// MOMENTS
function Ac(a){return Ec.call(this,a,this.week(),this.weekday(),this.localeData()._week.dow,this.localeData()._week.doy)}function Bc(a){return Ec.call(this,a,this.isoWeek(),this.isoWeekday(),1,4)}function Cc(){return xa(this.year(),1,4)}function Dc(){var a=this.localeData()._week;return xa(this.year(),a.dow,a.doy)}function Ec(a,b,c,d,e){var f;return null==a?wa(this,d,e).year:(f=xa(a,d,e),b>f&&(b=f),Fc.call(this,a,b,c,d,e))}function Fc(a,b,c,d,e){var f=va(a,b,c,d,e),g=ta(f.year,0,f.dayOfYear);return this.year(g.getUTCFullYear()),this.month(g.getUTCMonth()),this.date(g.getUTCDate()),this}
// MOMENTS
function Gc(a){return null==a?Math.ceil((this.month()+1)/3):this.month(3*(a-1)+this.month()%3)}
// HELPERS
// MOMENTS
function Hc(a){var b=Math.round((this.clone().startOf("day")-this.clone().startOf("year"))/864e5)+1;return null==a?b:this.add(a-b,"d")}function Ic(a,b){b[ge]=u(1e3*("0."+a))}
// MOMENTS
function Jc(){return this._isUTC?"UTC":""}function Kc(){return this._isUTC?"Coordinated Universal Time":""}function Lc(a){return sb(1e3*a)}function Mc(){return sb.apply(null,arguments).parseZone()}function Nc(a){return a}function Oc(a,b,c,d){var e=bb(),f=k().set(d,b);return e[c](f,a)}function Pc(a,b,c){if(f(a)&&(b=a,a=void 0),a=a||"",null!=b)return Oc(a,b,c,"month");var d,e=[];for(d=0;d<12;d++)e[d]=Oc(a,d,c,"month");return e}
// ()
// (5)
// (fmt, 5)
// (fmt)
// (true)
// (true, 5)
// (true, fmt, 5)
// (true, fmt)
function Qc(a,b,c,d){"boolean"==typeof a?(f(b)&&(c=b,b=void 0),b=b||""):(b=a,c=b,a=!1,f(b)&&(c=b,b=void 0),b=b||"");var e=bb(),g=a?e._week.dow:0;if(null!=c)return Oc(b,(c+g)%7,d,"day");var h,i=[];for(h=0;h<7;h++)i[h]=Oc(b,(h+g)%7,d,"day");return i}function Rc(a,b){return Pc(a,b,"months")}function Sc(a,b){return Pc(a,b,"monthsShort")}function Tc(a,b,c){return Qc(a,b,c,"weekdays")}function Uc(a,b,c){return Qc(a,b,c,"weekdaysShort")}function Vc(a,b,c){return Qc(a,b,c,"weekdaysMin")}function Wc(){var a=this._data;return this._milliseconds=Ze(this._milliseconds),this._days=Ze(this._days),this._months=Ze(this._months),a.milliseconds=Ze(a.milliseconds),a.seconds=Ze(a.seconds),a.minutes=Ze(a.minutes),a.hours=Ze(a.hours),a.months=Ze(a.months),a.years=Ze(a.years),this}function Xc(a,b,c,d){var e=Ob(b,c);return a._milliseconds+=d*e._milliseconds,a._days+=d*e._days,a._months+=d*e._months,a._bubble()}
// supports only 2.0-style add(1, 's') or add(duration)
function Yc(a,b){return Xc(this,a,b,1)}
// supports only 2.0-style subtract(1, 's') or subtract(duration)
function Zc(a,b){return Xc(this,a,b,-1)}function $c(a){return a<0?Math.floor(a):Math.ceil(a)}function _c(){var a,b,c,d,e,f=this._milliseconds,g=this._days,h=this._months,i=this._data;
// if we have a mix of positive and negative values, bubble down first
// check: https://github.com/moment/moment/issues/2166
// The following code bubbles up values, see the tests for
// examples of what that means.
// convert days to months
// 12 months -> 1 year
return f>=0&&g>=0&&h>=0||f<=0&&g<=0&&h<=0||(f+=864e5*$c(bd(h)+g),g=0,h=0),i.milliseconds=f%1e3,a=t(f/1e3),i.seconds=a%60,b=t(a/60),i.minutes=b%60,c=t(b/60),i.hours=c%24,g+=t(c/24),e=t(ad(g)),h+=e,g-=$c(bd(e)),d=t(h/12),h%=12,i.days=g,i.months=h,i.years=d,this}function ad(a){
// 400 years have 146097 days (taking into account leap year rules)
// 400 years have 12 months === 4800
return 4800*a/146097}function bd(a){
// the reverse of daysToMonths
return 146097*a/4800}function cd(a){var b,c,d=this._milliseconds;if(a=K(a),"month"===a||"year"===a)return b=this._days+d/864e5,c=this._months+ad(b),"month"===a?c:c/12;switch(
// handle milliseconds separately because of floating point math errors (issue #1867)
b=this._days+Math.round(bd(this._months)),a){case"week":return b/7+d/6048e5;case"day":return b+d/864e5;case"hour":return 24*b+d/36e5;case"minute":return 1440*b+d/6e4;case"second":return 86400*b+d/1e3;
// Math.floor prevents floating point math errors here
case"millisecond":return Math.floor(864e5*b)+d;default:throw new Error("Unknown unit "+a)}}
// TODO: Use this.as('ms')?
function dd(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*u(this._months/12)}function ed(a){return function(){return this.as(a)}}function fd(a){return a=K(a),this[a+"s"]()}function gd(a){return function(){return this._data[a]}}function hd(){return t(this.days()/7)}
// helper function for moment.fn.from, moment.fn.fromNow, and moment.duration.fn.humanize
function id(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function jd(a,b,c){var d=Ob(a).abs(),e=of(d.as("s")),f=of(d.as("m")),g=of(d.as("h")),h=of(d.as("d")),i=of(d.as("M")),j=of(d.as("y")),k=e<pf.s&&["s",e]||f<=1&&["m"]||f<pf.m&&["mm",f]||g<=1&&["h"]||g<pf.h&&["hh",g]||h<=1&&["d"]||h<pf.d&&["dd",h]||i<=1&&["M"]||i<pf.M&&["MM",i]||j<=1&&["y"]||["yy",j];return k[2]=b,k[3]=+a>0,k[4]=c,id.apply(null,k)}
// This function allows you to set the rounding function for relative time strings
function kd(a){return void 0===a?of:"function"==typeof a&&(of=a,!0)}
// This function allows you to set a threshold for relative time strings
function ld(a,b){return void 0!==pf[a]&&(void 0===b?pf[a]:(pf[a]=b,!0))}function md(a){var b=this.localeData(),c=jd(this,!a,b);return a&&(c=b.pastFuture(+this,c)),b.postformat(c)}function nd(){
// for ISO strings we do not use the normal bubbling rules:
//  * milliseconds bubble up until they become hours
//  * days do not bubble at all
//  * months bubble up until they become years
// This is because there is no context-free conversion between hours and days
// (think of clock changes)
// and also not between days and months (28-31 days per month)
var a,b,c,d=qf(this._milliseconds)/1e3,e=qf(this._days),f=qf(this._months);
// 3600 seconds -> 60 minutes -> 1 hour
a=t(d/60),b=t(a/60),d%=60,a%=60,
// 12 months -> 1 year
c=t(f/12),f%=12;
// inspired by https://github.com/dordille/moment-isoduration/blob/master/moment.isoduration.js
var g=c,h=f,i=e,j=b,k=a,l=d,m=this.asSeconds();return m?(m<0?"-":"")+"P"+(g?g+"Y":"")+(h?h+"M":"")+(i?i+"D":"")+(j||k||l?"T":"")+(j?j+"H":"")+(k?k+"M":"")+(l?l+"S":""):"P0D"}var od,pd;pd=Array.prototype.some?Array.prototype.some:function(a){for(var b=Object(this),c=b.length>>>0,d=0;d<c;d++)if(d in b&&a.call(this,b[d],d,b))return!0;return!1};var qd=pd,rd=a.momentProperties=[],sd=!1,td={};a.suppressDeprecationWarnings=!1,a.deprecationHandler=null;var ud;ud=Object.keys?Object.keys:function(a){var b,c=[];for(b in a)i(a,b)&&c.push(b);return c};var vd,wd=ud,xd={sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},yd={LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"},zd="Invalid date",Ad="%d",Bd=/\d{1,2}/,Cd={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},Dd={},Ed={},Fd=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g,Gd=/(\[[^\[]*\])|(\\)?(LTS|LT|LL?L?L?|l{1,4})/g,Hd={},Id={},Jd=/\d/,Kd=/\d\d/,Ld=/\d{3}/,Md=/\d{4}/,Nd=/[+-]?\d{6}/,Od=/\d\d?/,Pd=/\d\d\d\d?/,Qd=/\d\d\d\d\d\d?/,Rd=/\d{1,3}/,Sd=/\d{1,4}/,Td=/[+-]?\d{1,6}/,Ud=/\d+/,Vd=/[+-]?\d+/,Wd=/Z|[+-]\d\d:?\d\d/gi,Xd=/Z|[+-]\d\d(?::?\d\d)?/gi,Yd=/[+-]?\d+(\.\d{1,3})?/,Zd=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,$d={},_d={},ae=0,be=1,ce=2,de=3,ee=4,fe=5,ge=6,he=7,ie=8;vd=Array.prototype.indexOf?Array.prototype.indexOf:function(a){
// I know
var b;for(b=0;b<this.length;++b)if(this[b]===a)return b;return-1};var je=vd;
// FORMATTING
U("M",["MM",2],"Mo",function(){return this.month()+1}),U("MMM",0,0,function(a){return this.localeData().monthsShort(this,a)}),U("MMMM",0,0,function(a){return this.localeData().months(this,a)}),
// ALIASES
J("month","M"),
// PRIORITY
M("month",8),
// PARSING
Z("M",Od),Z("MM",Od,Kd),Z("MMM",function(a,b){return b.monthsShortRegex(a)}),Z("MMMM",function(a,b){return b.monthsRegex(a)}),ba(["M","MM"],function(a,b){b[be]=u(a)-1}),ba(["MMM","MMMM"],function(a,b,c,d){var e=c._locale.monthsParse(a,d,c._strict);
// if we didn't find a month name, mark the date as invalid.
null!=e?b[be]=e:m(c).invalidMonth=a});
// LOCALES
var ke=/D[oD]?(\[[^\[\]]*\]|\s)+MMMM?/,le="January_February_March_April_May_June_July_August_September_October_November_December".split("_"),me="Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),ne=Zd,oe=Zd;
// FORMATTING
U("Y",0,0,function(){var a=this.year();return a<=9999?""+a:"+"+a}),U(0,["YY",2],0,function(){return this.year()%100}),U(0,["YYYY",4],0,"year"),U(0,["YYYYY",5],0,"year"),U(0,["YYYYYY",6,!0],0,"year"),
// ALIASES
J("year","y"),
// PRIORITIES
M("year",1),
// PARSING
Z("Y",Vd),Z("YY",Od,Kd),Z("YYYY",Sd,Md),Z("YYYYY",Td,Nd),Z("YYYYYY",Td,Nd),ba(["YYYYY","YYYYYY"],ae),ba("YYYY",function(b,c){c[ae]=2===b.length?a.parseTwoDigitYear(b):u(b)}),ba("YY",function(b,c){c[ae]=a.parseTwoDigitYear(b)}),ba("Y",function(a,b){b[ae]=parseInt(a,10)}),
// HOOKS
a.parseTwoDigitYear=function(a){return u(a)+(u(a)>68?1900:2e3)};
// MOMENTS
var pe=O("FullYear",!0);
// FORMATTING
U("w",["ww",2],"wo","week"),U("W",["WW",2],"Wo","isoWeek"),
// ALIASES
J("week","w"),J("isoWeek","W"),
// PRIORITIES
M("week",5),M("isoWeek",5),
// PARSING
Z("w",Od),Z("ww",Od,Kd),Z("W",Od),Z("WW",Od,Kd),ca(["w","ww","W","WW"],function(a,b,c,d){b[d.substr(0,1)]=u(a)});var qe={dow:0,// Sunday is the first day of the week.
doy:6};
// FORMATTING
U("d",0,"do","day"),U("dd",0,0,function(a){return this.localeData().weekdaysMin(this,a)}),U("ddd",0,0,function(a){return this.localeData().weekdaysShort(this,a)}),U("dddd",0,0,function(a){return this.localeData().weekdays(this,a)}),U("e",0,0,"weekday"),U("E",0,0,"isoWeekday"),
// ALIASES
J("day","d"),J("weekday","e"),J("isoWeekday","E"),
// PRIORITY
M("day",11),M("weekday",11),M("isoWeekday",11),
// PARSING
Z("d",Od),Z("e",Od),Z("E",Od),Z("dd",function(a,b){return b.weekdaysMinRegex(a)}),Z("ddd",function(a,b){return b.weekdaysShortRegex(a)}),Z("dddd",function(a,b){return b.weekdaysRegex(a)}),ca(["dd","ddd","dddd"],function(a,b,c,d){var e=c._locale.weekdaysParse(a,d,c._strict);
// if we didn't get a weekday name, mark the date as invalid
null!=e?b.d=e:m(c).invalidWeekday=a}),ca(["d","e","E"],function(a,b,c,d){b[d]=u(a)});
// LOCALES
var re="Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),se="Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),te="Su_Mo_Tu_We_Th_Fr_Sa".split("_"),ue=Zd,ve=Zd,we=Zd;U("H",["HH",2],0,"hour"),U("h",["hh",2],0,Ra),U("k",["kk",2],0,Sa),U("hmm",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)}),U("hmmss",0,0,function(){return""+Ra.apply(this)+T(this.minutes(),2)+T(this.seconds(),2)}),U("Hmm",0,0,function(){return""+this.hours()+T(this.minutes(),2)}),U("Hmmss",0,0,function(){return""+this.hours()+T(this.minutes(),2)+T(this.seconds(),2)}),Ta("a",!0),Ta("A",!1),
// ALIASES
J("hour","h"),
// PRIORITY
M("hour",13),Z("a",Ua),Z("A",Ua),Z("H",Od),Z("h",Od),Z("HH",Od,Kd),Z("hh",Od,Kd),Z("hmm",Pd),Z("hmmss",Qd),Z("Hmm",Pd),Z("Hmmss",Qd),ba(["H","HH"],de),ba(["a","A"],function(a,b,c){c._isPm=c._locale.isPM(a),c._meridiem=a}),ba(["h","hh"],function(a,b,c){b[de]=u(a),m(c).bigHour=!0}),ba("hmm",function(a,b,c){var d=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d)),m(c).bigHour=!0}),ba("hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d,2)),b[fe]=u(a.substr(e)),m(c).bigHour=!0}),ba("Hmm",function(a,b,c){var d=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d))}),ba("Hmmss",function(a,b,c){var d=a.length-4,e=a.length-2;b[de]=u(a.substr(0,d)),b[ee]=u(a.substr(d,2)),b[fe]=u(a.substr(e))});var xe,ye=/[ap]\.?m?\.?/i,ze=O("Hours",!0),Ae={calendar:xd,longDateFormat:yd,invalidDate:zd,ordinal:Ad,ordinalParse:Bd,relativeTime:Cd,months:le,monthsShort:me,week:qe,weekdays:re,weekdaysMin:te,weekdaysShort:se,meridiemParse:ye},Be={},Ce={},De=/^\s*((?:[+-]\d{6}|\d{4})-(?:\d\d-\d\d|W\d\d-\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?::\d\d(?::\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Ee=/^\s*((?:[+-]\d{6}|\d{4})(?:\d\d\d\d|W\d\d\d|W\d\d|\d\d\d|\d\d))(?:(T| )(\d\d(?:\d\d(?:\d\d(?:[.,]\d+)?)?)?)([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Fe=/Z|[+-]\d\d(?::?\d\d)?/,Ge=[["YYYYYY-MM-DD",/[+-]\d{6}-\d\d-\d\d/],["YYYY-MM-DD",/\d{4}-\d\d-\d\d/],["GGGG-[W]WW-E",/\d{4}-W\d\d-\d/],["GGGG-[W]WW",/\d{4}-W\d\d/,!1],["YYYY-DDD",/\d{4}-\d{3}/],["YYYY-MM",/\d{4}-\d\d/,!1],["YYYYYYMMDD",/[+-]\d{10}/],["YYYYMMDD",/\d{8}/],
// YYYYMM is NOT allowed by the standard
["GGGG[W]WWE",/\d{4}W\d{3}/],["GGGG[W]WW",/\d{4}W\d{2}/,!1],["YYYYDDD",/\d{7}/]],He=[["HH:mm:ss.SSSS",/\d\d:\d\d:\d\d\.\d+/],["HH:mm:ss,SSSS",/\d\d:\d\d:\d\d,\d+/],["HH:mm:ss",/\d\d:\d\d:\d\d/],["HH:mm",/\d\d:\d\d/],["HHmmss.SSSS",/\d\d\d\d\d\d\.\d+/],["HHmmss,SSSS",/\d\d\d\d\d\d,\d+/],["HHmmss",/\d\d\d\d\d\d/],["HHmm",/\d\d\d\d/],["HH",/\d\d/]],Ie=/^\/?Date\((\-?\d+)/i;a.createFromInputFallback=x("value provided is not in a recognized ISO format. moment construction falls back to js Date(), which is not reliable across all browsers and versions. Non ISO date formats are discouraged and will be removed in an upcoming major release. Please refer to http://momentjs.com/guides/#/warnings/js-date/ for more info.",function(a){a._d=new Date(a._i+(a._useUTC?" UTC":""))}),
// constant that refers to the ISO standard
a.ISO_8601=function(){};var Je=x("moment().min is deprecated, use moment.max instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=sb.apply(null,arguments);return this.isValid()&&a.isValid()?a<this?this:a:o()}),Ke=x("moment().max is deprecated, use moment.min instead. http://momentjs.com/guides/#/warnings/min-max/",function(){var a=sb.apply(null,arguments);return this.isValid()&&a.isValid()?a>this?this:a:o()}),Le=function(){return Date.now?Date.now():+new Date};zb("Z",":"),zb("ZZ",""),
// PARSING
Z("Z",Xd),Z("ZZ",Xd),ba(["Z","ZZ"],function(a,b,c){c._useUTC=!0,c._tzm=Ab(Xd,a)});
// HELPERS
// timezone chunker
// '+10:00' > ['10',  '00']
// '-1530'  > ['-15', '30']
var Me=/([\+\-]|\d\d)/gi;
// HOOKS
// This function will be called whenever a moment is mutated.
// It is intended to keep the offset in sync with the timezone.
a.updateOffset=function(){};
// ASP.NET json date format regex
var Ne=/^(\-)?(?:(\d*)[. ])?(\d+)\:(\d+)(?:\:(\d+)(\.\d*)?)?$/,Oe=/^(-)?P(?:(-?[0-9,.]*)Y)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)W)?(?:(-?[0-9,.]*)D)?(?:T(?:(-?[0-9,.]*)H)?(?:(-?[0-9,.]*)M)?(?:(-?[0-9,.]*)S)?)?$/;Ob.fn=wb.prototype;var Pe=Sb(1,"add"),Qe=Sb(-1,"subtract");a.defaultFormat="YYYY-MM-DDTHH:mm:ssZ",a.defaultFormatUtc="YYYY-MM-DDTHH:mm:ss[Z]";var Re=x("moment().lang() is deprecated. Instead, use moment().localeData() to get the language configuration. Use moment().locale() to change languages.",function(a){return void 0===a?this.localeData():this.locale(a)});
// FORMATTING
U(0,["gg",2],0,function(){return this.weekYear()%100}),U(0,["GG",2],0,function(){return this.isoWeekYear()%100}),zc("gggg","weekYear"),zc("ggggg","weekYear"),zc("GGGG","isoWeekYear"),zc("GGGGG","isoWeekYear"),
// ALIASES
J("weekYear","gg"),J("isoWeekYear","GG"),
// PRIORITY
M("weekYear",1),M("isoWeekYear",1),
// PARSING
Z("G",Vd),Z("g",Vd),Z("GG",Od,Kd),Z("gg",Od,Kd),Z("GGGG",Sd,Md),Z("gggg",Sd,Md),Z("GGGGG",Td,Nd),Z("ggggg",Td,Nd),ca(["gggg","ggggg","GGGG","GGGGG"],function(a,b,c,d){b[d.substr(0,2)]=u(a)}),ca(["gg","GG"],function(b,c,d,e){c[e]=a.parseTwoDigitYear(b)}),
// FORMATTING
U("Q",0,"Qo","quarter"),
// ALIASES
J("quarter","Q"),
// PRIORITY
M("quarter",7),
// PARSING
Z("Q",Jd),ba("Q",function(a,b){b[be]=3*(u(a)-1)}),
// FORMATTING
U("D",["DD",2],"Do","date"),
// ALIASES
J("date","D"),
// PRIOROITY
M("date",9),
// PARSING
Z("D",Od),Z("DD",Od,Kd),Z("Do",function(a,b){return a?b._ordinalParse:b._ordinalParseLenient}),ba(["D","DD"],ce),ba("Do",function(a,b){b[ce]=u(a.match(Od)[0],10)});
// MOMENTS
var Se=O("Date",!0);
// FORMATTING
U("DDD",["DDDD",3],"DDDo","dayOfYear"),
// ALIASES
J("dayOfYear","DDD"),
// PRIORITY
M("dayOfYear",4),
// PARSING
Z("DDD",Rd),Z("DDDD",Ld),ba(["DDD","DDDD"],function(a,b,c){c._dayOfYear=u(a)}),
// FORMATTING
U("m",["mm",2],0,"minute"),
// ALIASES
J("minute","m"),
// PRIORITY
M("minute",14),
// PARSING
Z("m",Od),Z("mm",Od,Kd),ba(["m","mm"],ee);
// MOMENTS
var Te=O("Minutes",!1);
// FORMATTING
U("s",["ss",2],0,"second"),
// ALIASES
J("second","s"),
// PRIORITY
M("second",15),
// PARSING
Z("s",Od),Z("ss",Od,Kd),ba(["s","ss"],fe);
// MOMENTS
var Ue=O("Seconds",!1);
// FORMATTING
U("S",0,0,function(){return~~(this.millisecond()/100)}),U(0,["SS",2],0,function(){return~~(this.millisecond()/10)}),U(0,["SSS",3],0,"millisecond"),U(0,["SSSS",4],0,function(){return 10*this.millisecond()}),U(0,["SSSSS",5],0,function(){return 100*this.millisecond()}),U(0,["SSSSSS",6],0,function(){return 1e3*this.millisecond()}),U(0,["SSSSSSS",7],0,function(){return 1e4*this.millisecond()}),U(0,["SSSSSSSS",8],0,function(){return 1e5*this.millisecond()}),U(0,["SSSSSSSSS",9],0,function(){return 1e6*this.millisecond()}),
// ALIASES
J("millisecond","ms"),
// PRIORITY
M("millisecond",16),
// PARSING
Z("S",Rd,Jd),Z("SS",Rd,Kd),Z("SSS",Rd,Ld);var Ve;for(Ve="SSSS";Ve.length<=9;Ve+="S")Z(Ve,Ud);for(Ve="S";Ve.length<=9;Ve+="S")ba(Ve,Ic);
// MOMENTS
var We=O("Milliseconds",!1);
// FORMATTING
U("z",0,0,"zoneAbbr"),U("zz",0,0,"zoneName");var Xe=r.prototype;Xe.add=Pe,Xe.calendar=Vb,Xe.clone=Wb,Xe.diff=bc,Xe.endOf=oc,Xe.format=gc,Xe.from=hc,Xe.fromNow=ic,Xe.to=jc,Xe.toNow=kc,Xe.get=R,Xe.invalidAt=xc,Xe.isAfter=Xb,Xe.isBefore=Yb,Xe.isBetween=Zb,Xe.isSame=$b,Xe.isSameOrAfter=_b,Xe.isSameOrBefore=ac,Xe.isValid=vc,Xe.lang=Re,Xe.locale=lc,Xe.localeData=mc,Xe.max=Ke,Xe.min=Je,Xe.parsingFlags=wc,Xe.set=S,Xe.startOf=nc,Xe.subtract=Qe,Xe.toArray=sc,Xe.toObject=tc,Xe.toDate=rc,Xe.toISOString=ec,Xe.inspect=fc,Xe.toJSON=uc,Xe.toString=dc,Xe.unix=qc,Xe.valueOf=pc,Xe.creationData=yc,
// Year
Xe.year=pe,Xe.isLeapYear=ra,
// Week Year
Xe.weekYear=Ac,Xe.isoWeekYear=Bc,
// Quarter
Xe.quarter=Xe.quarters=Gc,
// Month
Xe.month=ka,Xe.daysInMonth=la,
// Week
Xe.week=Xe.weeks=Ba,Xe.isoWeek=Xe.isoWeeks=Ca,Xe.weeksInYear=Dc,Xe.isoWeeksInYear=Cc,
// Day
Xe.date=Se,Xe.day=Xe.days=Ka,Xe.weekday=La,Xe.isoWeekday=Ma,Xe.dayOfYear=Hc,
// Hour
Xe.hour=Xe.hours=ze,
// Minute
Xe.minute=Xe.minutes=Te,
// Second
Xe.second=Xe.seconds=Ue,
// Millisecond
Xe.millisecond=Xe.milliseconds=We,
// Offset
Xe.utcOffset=Db,Xe.utc=Fb,Xe.local=Gb,Xe.parseZone=Hb,Xe.hasAlignedHourOffset=Ib,Xe.isDST=Jb,Xe.isLocal=Lb,Xe.isUtcOffset=Mb,Xe.isUtc=Nb,Xe.isUTC=Nb,
// Timezone
Xe.zoneAbbr=Jc,Xe.zoneName=Kc,
// Deprecations
Xe.dates=x("dates accessor is deprecated. Use date instead.",Se),Xe.months=x("months accessor is deprecated. Use month instead",ka),Xe.years=x("years accessor is deprecated. Use year instead",pe),Xe.zone=x("moment().zone is deprecated, use moment().utcOffset instead. http://momentjs.com/guides/#/warnings/zone/",Eb),Xe.isDSTShifted=x("isDSTShifted is deprecated. See http://momentjs.com/guides/#/warnings/dst-shifted/ for more information",Kb);var Ye=C.prototype;Ye.calendar=D,Ye.longDateFormat=E,Ye.invalidDate=F,Ye.ordinal=G,Ye.preparse=Nc,Ye.postformat=Nc,Ye.relativeTime=H,Ye.pastFuture=I,Ye.set=A,
// Month
Ye.months=fa,Ye.monthsShort=ga,Ye.monthsParse=ia,Ye.monthsRegex=na,Ye.monthsShortRegex=ma,
// Week
Ye.week=ya,Ye.firstDayOfYear=Aa,Ye.firstDayOfWeek=za,
// Day of Week
Ye.weekdays=Fa,Ye.weekdaysMin=Ha,Ye.weekdaysShort=Ga,Ye.weekdaysParse=Ja,Ye.weekdaysRegex=Na,Ye.weekdaysShortRegex=Oa,Ye.weekdaysMinRegex=Pa,
// Hours
Ye.isPM=Va,Ye.meridiem=Wa,$a("en",{ordinalParse:/\d{1,2}(th|st|nd|rd)/,ordinal:function(a){var b=a%10,c=1===u(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th";return a+c}}),
// Side effect imports
a.lang=x("moment.lang is deprecated. Use moment.locale instead.",$a),a.langData=x("moment.langData is deprecated. Use moment.localeData instead.",bb);var Ze=Math.abs,$e=ed("ms"),_e=ed("s"),af=ed("m"),bf=ed("h"),cf=ed("d"),df=ed("w"),ef=ed("M"),ff=ed("y"),gf=gd("milliseconds"),hf=gd("seconds"),jf=gd("minutes"),kf=gd("hours"),lf=gd("days"),mf=gd("months"),nf=gd("years"),of=Math.round,pf={s:45,// seconds to minute
m:45,// minutes to hour
h:22,// hours to day
d:26,// days to month
M:11},qf=Math.abs,rf=wb.prototype;
// Deprecations
// Side effect imports
// FORMATTING
// PARSING
// Side effect imports
return rf.abs=Wc,rf.add=Yc,rf.subtract=Zc,rf.as=cd,rf.asMilliseconds=$e,rf.asSeconds=_e,rf.asMinutes=af,rf.asHours=bf,rf.asDays=cf,rf.asWeeks=df,rf.asMonths=ef,rf.asYears=ff,rf.valueOf=dd,rf._bubble=_c,rf.get=fd,rf.milliseconds=gf,rf.seconds=hf,rf.minutes=jf,rf.hours=kf,rf.days=lf,rf.weeks=hd,rf.months=mf,rf.years=nf,rf.humanize=md,rf.toISOString=nd,rf.toString=nd,rf.toJSON=nd,rf.locale=lc,rf.localeData=mc,rf.toIsoString=x("toIsoString() is deprecated. Please use toISOString() instead (notice the capitals)",nd),rf.lang=Re,U("X",0,0,"unix"),U("x",0,0,"valueOf"),Z("x",Vd),Z("X",Yd),ba("X",function(a,b,c){c._d=new Date(1e3*parseFloat(a,10))}),ba("x",function(a,b,c){c._d=new Date(u(a))}),a.version="2.16.0",b(sb),a.fn=Xe,a.min=ub,a.max=vb,a.now=Le,a.utc=k,a.unix=Lc,a.months=Rc,a.isDate=g,a.locale=$a,a.invalid=o,a.duration=Ob,a.isMoment=s,a.weekdays=Tc,a.parseZone=Mc,a.localeData=bb,a.isDuration=xb,a.monthsShort=Sc,a.weekdaysMin=Vc,a.defineLocale=_a,a.updateLocale=ab,a.locales=cb,a.weekdaysShort=Uc,a.normalizeUnits=K,a.relativeTimeRounding=kd,a.relativeTimeThreshold=ld,a.calendarFormat=Ub,a.prototype=Xe,a});// jquery.daterangepicker.js
// author : Chunlong Liu
// license : MIT
// www.jszen.com

(function(factory) {
    if (typeof define === 'function' && define.amd) {
        // AMD. Register as an anonymous module.
        define(['jquery', 'moment'], factory);
    } else if (typeof exports === 'object' && typeof module !== 'undefined') {
        // CommonJS. Register as a module
        module.exports = factory(require('jquery'), require('moment'));
    } else {
        // Browser globals
        factory(jQuery, moment);
    }
}(function($, moment) {
    'use strict';
    $.dateRangePickerLanguages = {
        "default": //default language: English
        {
            "selected": "Selected:",
            "day": "Day",
            "days": "Days",
            "apply": "Close",
            "week-1": "mo",
            "week-2": "tu",
            "week-3": "we",
            "week-4": "th",
            "week-5": "fr",
            "week-6": "sa",
            "week-7": "su",
            "week-number": "W",
            "month-name": ["january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december"],
            "shortcuts": "Shortcuts",
            "custom-values": "Custom Values",
            "past": "Past",
            "following": "Following",
            "previous": "Previous",
            "prev-week": "Week",
            "prev-month": "Month",
            "prev-year": "Year",
            "next": "Next",
            "next-week": "Week",
            "next-month": "Month",
            "next-year": "Year",
            "less-than": "Date range should not be more than %d days",
            "more-than": "Date range should not be less than %d days",
            "default-more": "Please select a date range longer than %d days",
            "default-single": "Please select a date",
            "default-less": "Please select a date range less than %d days",
            "default-range": "Please select a date range between %d and %d days",
            "default-default": "Please select a date range",
            "time": "Time",
            "hour": "Hour",
            "minute": "Minute"
        },
        "id": {
            "selected": "Terpilih:",
            "day": "Hari",
            "days": "Hari",
            "apply": "Tutup",
            "week-1": "sen",
            "week-2": "sel",
            "week-3": "rab",
            "week-4": "kam",
            "week-5": "jum",
            "week-6": "sab",
            "week-7": "min",
            "week-number": "W",
            "month-name": ["januari", "februari", "maret", "april", "mei", "juni", "juli", "agustus", "september", "oktober", "november", "desember"],
            "shortcuts": "Pintas",
            "custom-values": "Nilai yang ditentukan",
            "past": "Yang Lalu",
            "following": "Mengikuti",
            "previous": "Sebelumnya",
            "prev-week": "Minggu",
            "prev-month": "Bulan",
            "prev-year": "Tahun",
            "next": "Selanjutnya",
            "next-week": "Minggu",
            "next-month": "Bulan",
            "next-year": "Tahun",
            "less-than": "Tanggal harus lebih dari %d hari",
            "more-than": "Tanggal harus kurang dari %d hari",
            "default-more": "Jarak tanggal harus lebih lama dari %d hari",
            "default-single": "Silakan pilih tanggal",
            "default-less": "Jarak rentang tanggal tidak boleh lebih lama dari %d hari",
            "default-range": "Rentang tanggal harus antara %d dan %d hari",
            "default-default": "Silakan pilih rentang tanggal",
            "time": "Waktu",
            "hour": "Jam",
            "minute": "Menit"
        },
        "az": {
            "selected": "SeĂ§ildi:",
            "day": " gĂ¼n",
            "days": " gĂ¼n",
            "apply": "tÉ™tbiq",
            "week-1": "1",
            "week-2": "2",
            "week-3": "3",
            "week-4": "4",
            "week-5": "5",
            "week-6": "6",
            "week-7": "7",
            "month-name": ["yanvar", "fevral", "mart", "aprel", "may", "iyun", "iyul", "avqust", "sentyabr", "oktyabr", "noyabr", "dekabr"],
            "shortcuts": "QÄ±sayollar",
            "past": "KeĂ§miÅŸ",
            "following": "NĂ¶vbÉ™ti",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "Ă–ncÉ™ki hÉ™ftÉ™",
            "prev-month": "Ă–ncÉ™ki ay",
            "prev-year": "Ă–ncÉ™ki il",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "NĂ¶vbÉ™ti hÉ™ftÉ™",
            "next-month": "NĂ¶vbÉ™ti ay",
            "next-year": "NĂ¶vbÉ™ti il",
            "less-than": "Tarix aralÄ±ÄŸÄ± %d gĂ¼ndÉ™n Ă§ox olmamalÄ±dÄ±r",
            "more-than": "Tarix aralÄ±ÄŸÄ± %d gĂ¼ndÉ™n az olmamalÄ±dÄ±r",
            "default-more": "%d gĂ¼ndÉ™n Ă§ox bir tarix seĂ§in",
            "default-single": "Tarix seĂ§in",
            "default-less": "%d gĂ¼ndÉ™n az bir tarix seĂ§in",
            "default-range": "%d vÉ™ %d gĂ¼n aralÄ±ÄŸÄ±nda tarixlÉ™r seĂ§in",
            "default-default": "Tarix aralÄ±ÄŸÄ± seĂ§in"
        },
        "bg": {
            "selected": "Đ˜Đ·Đ±Ñ€Đ°Đ½Đ¾:",
            "day": "Đ”ĐµĐ½",
            "days": "Đ”Đ½Đ¸",
            "apply": "Đ—Đ°Ñ‚Đ²Đ¾Ñ€Đ¸",
            "week-1": "Đ¿Đ½",
            "week-2": "Đ²Ñ‚",
            "week-3": "ÑÑ€",
            "week-4": "Ñ‡Ñ‚",
            "week-5": "Đ¿Ñ‚",
            "week-6": "ÑĐ±",
            "week-7": "Đ½Đ´",
            "week-number": "Đ¡",
            "month-name": ["ÑĐ½ÑƒĐ°Ñ€Đ¸", "Ñ„ĐµĐ²Ñ€ÑƒĐ°Ñ€Đ¸", "Đ¼Đ°Ñ€Ñ‚", "Đ°Đ¿Ñ€Đ¸Đ»", "Đ¼Đ°Đ¹", "ÑĐ½Đ¸", "ÑĐ»Đ¸", "Đ°Đ²Đ³ÑƒÑÑ‚", "ÑĐµĐ¿Ñ‚ĐµĐ¼Đ²Ñ€Đ¸", "Đ¾ĐºÑ‚Đ¾Đ¼Đ²Ñ€Đ¸", "Đ½Đ¾ĐµĐ¼Đ²Ñ€Đ¸", "Đ´ĐµĐºĐµĐ¼Đ²Ñ€Đ¸"],
            "shortcuts": "ĐŸÑ€ĐµĐºĐ¸ Đ¿ÑÑ‚Đ¸Ñ‰Đ°",
            "custom-values": "ĐŸĐµÑ€ÑĐ¾Đ½Đ°Đ»Đ¸Đ·Đ¸Ñ€Đ°Đ½Đ¸ ÑÑ‚Đ¾Đ¹Đ½Đ¾ÑÑ‚Đ¸",
            "past": "ĐœĐ¸Đ½Đ°Đ»",
            "following": "Đ¡Đ»ĐµĐ´Đ²Đ°Ñ‰",
            "previous": "ĐŸÑ€ĐµĐ´Đ¸ÑˆĐµĐ½",
            "prev-week": "Đ¡ĐµĐ´Đ¼Đ¸Ñ†Đ°",
            "prev-month": "ĐœĐµÑĐµÑ†",
            "prev-year": "Đ“Đ¾Đ´Đ¸Đ½Đ°",
            "next": "Đ¡Đ»ĐµĐ´Đ²Đ°Ñ‰",
            "next-week": "Đ¡ĐµĐ´Đ¼Đ¸Ñ†Đ°",
            "next-month": "ĐœĐµÑĐµÑ†",
            "next-year": "Đ“Đ¾Đ´Đ¸Đ½Đ°",
            "less-than": "ĐŸĐµÑ€Đ¸Đ¾Đ´ÑÑ‚ Đ¾Ñ‚ Đ²Ñ€ĐµĐ¼Đµ Đ½Đµ Ñ‚Ñ€ÑĐ±Đ²Đ° Đ´Đ° Đµ Đ¿Đ¾Đ²ĐµÑ‡Đµ Đ¾Ñ‚ %d Đ´Đ½Đ¸",
            "more-than": "ĐŸĐµÑ€Đ¸Đ¾Đ´ÑÑ‚ Đ¾Ñ‚ Đ²Ñ€ĐµĐ¼Đµ Đ½Đµ Ñ‚Ñ€ÑĐ±Đ²Đ° Đ´Đ° Đµ Đ¿Đ¾-Đ¼Đ°Đ»ĐºĐ¾ Đ¾Ñ‚ %d Đ´Đ½Đ¸",
            "default-more": "ĐœĐ¾Đ»Ñ Đ¸Đ·Đ±ĐµÑ€ĐµÑ‚Đµ Đ¿ĐµÑ€Đ¸Đ¾Đ´ Đ¿Đ¾-Đ´ÑĐ»ÑĐ³ Đ¾Ñ‚ %d Đ´Đ½Đ¸",
            "default-single": "ĐœĐ¾Đ»Ñ Đ¸Đ·Đ±ĐµÑ€ĐµÑ‚Đµ Đ´Đ°Ñ‚Đ°",
            "default-less": "ĐœĐ¾Đ»Ñ Đ¸Đ·Đ±ĐµÑ€ĐµÑ‚Đµ Đ¿ĐµÑ€Đ¸Đ¾Đ´ Đ¿Đ¾-ĐºÑÑ Đ¾Ñ‚ %d Đ´Đ½Đ¸",
            "default-range": "ĐœĐ¾Đ»Ñ Đ¸Đ·Đ±ĐµÑ€ĐµÑ‚Đµ Đ¿ĐµÑ€Đ¸Đ¾Đ´ Đ¼ĐµĐ¶Đ´Ñƒ %d Đ¸ %d Đ´Đ½Đ¸",
            "default-default": "ĐœĐ¾Đ»Ñ Đ¸Đ·Đ±ĐµÑ€ĐµÑ‚Đµ Đ¿ĐµÑ€Đ¸Đ¾Đ´",
            "time": "Đ’Ñ€ĐµĐ¼Đµ",
            "hour": "Đ§Đ°Ñ",
            "minute": "ĐœĐ¸Đ½ÑƒÑ‚Đ°"
        },
        "cn": //simplified chinese
        {
            "selected": "å·²é€‰æ‹©:",
            "day": "å¤©",
            "days": "å¤©",
            "apply": "ç¡®å®",
            "week-1": "ä¸€",
            "week-2": "äºŒ",
            "week-3": "ä¸‰",
            "week-4": "å››",
            "week-5": "äº”",
            "week-6": "å…­",
            "week-7": "æ—¥",
            "week-number": "å‘¨",
            "month-name": ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"],
            "shortcuts": "å¿«æ·é€‰æ‹©",
            "past": "è¿‡å»",
            "following": "å°†æ¥",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "ä¸å‘¨",
            "prev-month": "ä¸ä¸ªæœˆ",
            "prev-year": "å»å¹´",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "ä¸‹å‘¨",
            "next-month": "ä¸‹ä¸ªæœˆ",
            "next-year": "æ˜å¹´",
            "less-than": "æ‰€é€‰æ—¥æœŸèŒƒå›´ä¸èƒ½å¤§äº%då¤©",
            "more-than": "æ‰€é€‰æ—¥æœŸèŒƒå›´ä¸èƒ½å°äº%då¤©",
            "default-more": "è¯·é€‰æ‹©å¤§äº%då¤©ç„æ—¥æœŸèŒƒå›´",
            "default-less": "è¯·é€‰æ‹©å°äº%då¤©ç„æ—¥æœŸèŒƒå›´",
            "default-range": "è¯·é€‰æ‹©%då¤©åˆ°%då¤©ç„æ—¥æœŸèŒƒå›´",
            "default-single": "è¯·é€‰æ‹©ä¸€ä¸ªæ—¥æœŸ",
            "default-default": "è¯·é€‰æ‹©ä¸€ä¸ªæ—¥æœŸèŒƒå›´",
            "time": "æ—¶é—´",
            "hour": "å°æ—¶",
            "minute": "åˆ†é’Ÿ"
        },
        "cz": {
            "selected": "VybrĂ¡no:",
            "day": "Den",
            "days": "Dny",
            "apply": "ZavÅ™Ă­t",
            "week-1": "po",
            "week-2": "Ăºt",
            "week-3": "st",
            "week-4": "Ät",
            "week-5": "pĂ¡",
            "week-6": "so",
            "week-7": "ne",
            "month-name": ["leden", "Ăºnor", "bÅ™ezen", "duben", "kvÄ›ten", "Äerven", "Äervenec", "srpen", "zĂ¡Å™Ă­", "Å™Ă­jen", "listopad", "prosinec"],
            "shortcuts": "Zkratky",
            "past": "po",
            "following": "nĂ¡sledujĂ­cĂ­",
            "previous": "pÅ™edchozĂ­",
            "prev-week": "tĂ½den",
            "prev-month": "mÄ›sĂ­c",
            "prev-year": "rok",
            "next": "dalÅ¡Ă­",
            "next-week": "tĂ½den",
            "next-month": "mÄ›sĂ­c",
            "next-year": "rok",
            "less-than": "Rozsah data by nemÄ›l bĂ½t vÄ›tÅ¡Ă­ neÅ¾ %d dnÅ¯",
            "more-than": "Rozsah data by nemÄ›l bĂ½t menÅ¡Ă­ neÅ¾ %d dnÅ¯",
            "default-more": "ProsĂ­m zvolte rozsah data vÄ›tÅ¡Ă­ neÅ¾ %d dnÅ¯",
            "default-single": "ProsĂ­m zvolte datum",
            "default-less": "ProsĂ­m zvolte rozsah data menÅ¡Ă­ neÅ¾ %d dnÅ¯",
            "default-range": "ProsĂ­m zvolte rozsah data mezi %d a %d dny",
            "default-default": "ProsĂ­m zvolte rozsah data"
        },
        "de": {
            "selected": "Auswahl:",
            "day": "Tag",
            "days": "Tage",
            "apply": "SchlieĂŸen",
            "week-1": "mo",
            "week-2": "di",
            "week-3": "mi",
            "week-4": "do",
            "week-5": "fr",
            "week-6": "sa",
            "week-7": "so",
            "month-name": ["januar", "februar", "mĂ¤rz", "april", "mai", "juni", "juli", "august", "september", "oktober", "november", "dezember"],
            "shortcuts": "Schnellwahl",
            "past": "Vorherige",
            "following": "Folgende",
            "previous": "Vorherige",
            "prev-week": "Woche",
            "prev-month": "Monat",
            "prev-year": "Jahr",
            "next": "NĂ¤chste",
            "next-week": "Woche",
            "next-month": "Monat",
            "next-year": "Jahr",
            "less-than": "Datumsbereich darf nicht grĂ¶ĂŸer sein als %d Tage",
            "more-than": "Datumsbereich darf nicht kleiner sein als %d Tage",
            "default-more": "Bitte mindestens %d Tage auswĂ¤hlen",
            "default-single": "Bitte ein Datum auswĂ¤hlen",
            "default-less": "Bitte weniger als %d Tage auswĂ¤hlen",
            "default-range": "Bitte einen Datumsbereich zwischen %d und %d Tagen auswĂ¤hlen",
            "default-default": "Bitte ein Start- und Enddatum auswĂ¤hlen",
            "Time": "Zeit",
            "hour": "Stunde",
            "minute": "Minute"
        },
        "es": {
            "selected": "Seleccionado:",
            "day": "DĂ­a",
            "days": "DĂ­as",
            "apply": "Cerrar",
            "week-1": "lu",
            "week-2": "ma",
            "week-3": "mi",
            "week-4": "ju",
            "week-5": "vi",
            "week-6": "sa",
            "week-7": "do",
            "month-name": ["enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"],
            "shortcuts": "Accesos directos",
            "past": "Pasado",
            "following": "Siguiente",
            "previous": "Anterior",
            "prev-week": "Semana",
            "prev-month": "Mes",
            "prev-year": "AĂ±o",
            "next": "Siguiente",
            "next-week": "Semana",
            "next-month": "Mes",
            "next-year": "AĂ±o",
            "less-than": "El rango no deberĂ­a ser mayor de %d dĂ­as",
            "more-than": "El rango no deberĂ­a ser menor de %d dĂ­as",
            "default-more": "Por favor selecciona un rango mayor a %d dĂ­as",
            "default-single": "Por favor selecciona un dĂ­a",
            "default-less": "Por favor selecciona un rango menor a %d dĂ­as",
            "default-range": "Por favor selecciona un rango entre %d y %d dĂ­as",
            "default-default": "Por favor selecciona un rango de fechas."
        },
        "fr": {
            "selected": "SĂ©lection:",
            "day": "Jour",
            "days": "Jours",
            "apply": "Fermer",
            "week-1": "lu",
            "week-2": "ma",
            "week-3": "me",
            "week-4": "je",
            "week-5": "ve",
            "week-6": "sa",
            "week-7": "di",
            "month-name": ["janvier", "fĂ©vrier", "mars", "avril", "mai", "juin", "juillet", "aoĂ»t", "septembre", "octobre", "novembre", "dĂ©cembre"],
            "shortcuts": "Raccourcis",
            "past": "PassĂ©",
            "following": "Suivant",
            "previous": "PrĂ©cĂ©dent",
            "prev-week": "Semaine",
            "prev-month": "Mois",
            "prev-year": "AnnĂ©e",
            "next": "Suivant",
            "next-week": "Semaine",
            "next-month": "Mois",
            "next-year": "AnnĂ©e",
            "less-than": "L'intervalle ne doit pas Ăªtre supĂ©rieure Ă  %d jours",
            "more-than": "L'intervalle ne doit pas Ăªtre infĂ©rieure Ă  %d jours",
            "default-more": "Merci de choisir une intervalle supĂ©rieure Ă  %d jours",
            "default-single": "Merci de choisir une date",
            "default-less": "Merci de choisir une intervalle infĂ©rieure %d jours",
            "default-range": "Merci de choisir une intervalle comprise entre %d et %d jours",
            "default-default": "Merci de choisir une date"
        },
        "hu": {
            "selected": "KivĂ¡lasztva:",
            "day": "Nap",
            "days": "Nap",
            "apply": "Ok",
            "week-1": "h",
            "week-2": "k",
            "week-3": "sz",
            "week-4": "cs",
            "week-5": "p",
            "week-6": "sz",
            "week-7": "v",
            "month-name": ["januĂ¡r", "februĂ¡r", "mĂ¡rcius", "Ă¡prilis", "mĂ¡jus", "jĂºnius", "jĂºlius", "augusztus", "szeptember", "oktĂ³ber", "november", "december"],
            "shortcuts": "GyorsvĂ¡lasztĂ³",
            "past": "MĂºlt",
            "following": "KĂ¶vetkezÅ‘",
            "previous": "ElÅ‘zÅ‘",
            "prev-week": "HĂ©t",
            "prev-month": "HĂ³nap",
            "prev-year": "Ă‰v",
            "next": "KĂ¶vetkezÅ‘",
            "next-week": "HĂ©t",
            "next-month": "HĂ³nap",
            "next-year": "Ă‰v",
            "less-than": "A kivĂ¡lasztĂ¡s nem lehet tĂ¶bb %d napnĂ¡l",
            "more-than": "A kivĂ¡lasztĂ¡s nem lehet tĂ¶bb %d napnĂ¡l",
            "default-more": "VĂ¡lassz ki egy idÅ‘szakot ami hosszabb mint %d nap",
            "default-single": "VĂ¡lassz egy napot",
            "default-less": "VĂ¡lassz ki egy idÅ‘szakot ami rĂ¶videbb mint %d nap",
            "default-range": "VĂ¡lassz ki egy %d - %d nap hosszĂº idÅ‘szakot",
            "default-default": "VĂ¡lassz ki egy idÅ‘szakot"
        },
        "it": {
            "selected": "Selezionati:",
            "day": "Giorno",
            "days": "Giorni",
            "apply": "Chiudi",
            "week-1": "lu",
            "week-2": "ma",
            "week-3": "me",
            "week-4": "gi",
            "week-5": "ve",
            "week-6": "sa",
            "week-7": "do",
            "month-name": ["gennaio", "febbraio", "marzo", "aprile", "maggio", "giugno", "luglio", "agosto", "settembre", "ottobre", "novembre", "dicembre"],
            "shortcuts": "Scorciatoie",
            "past": "Scorso",
            "following": "Successivo",
            "previous": "Precedente",
            "prev-week": "Settimana",
            "prev-month": "Mese",
            "prev-year": "Anno",
            "next": "Prossimo",
            "next-week": "Settimana",
            "next-month": "Mese",
            "next-year": "Anno",
            "less-than": "L'intervallo non dev'essere maggiore di %d giorni",
            "more-than": "L'intervallo non dev'essere minore di %d giorni",
            "default-more": "Seleziona un intervallo maggiore di %d giorni",
            "default-single": "Seleziona una data",
            "default-less": "Seleziona un intervallo minore di %d giorni",
            "default-range": "Seleziona un intervallo compreso tra i %d e i %d giorni",
            "default-default": "Seleziona un intervallo di date"
        },
        "ko": {
            "selected": "ê¸°ê°„:",
            "day": "́¼",
            "days": "́¼ê°„",
            "apply": "ë‹«ê¸°",
            "week-1": "́›”",
            "week-2": "í™”",
            "week-3": "́ˆ˜",
            "week-4": "ëª©",
            "week-5": "ê¸ˆ",
            "week-6": "í† ",
            "week-7": "́¼",
            "week-number": "́£¼",
            "month-name": ["1́›”", "2́›”", "3́›”", "4́›”", "5́›”", "6́›”", "7́›”", "8́›”", "9́›”", "10́›”", "11́›”", "12́›”"],
            "shortcuts": "ë‹΅¶•í‚¤ë“¤",
            "past": "́§€ë‚œ(́˜¤ë˜ê¸°́¤€)",
            "following": "́´í›„(́˜¤ë˜ê¸°́¤€)",
            "previous": "́´́ „",
            "prev-week": "1́£¼",
            "prev-month": "1ë‹¬",
            "prev-year": "1ë…„",
            "next": "ë‹¤́Œ",
            "next-week": "1́£¼",
            "next-month": "1ë‹¬",
            "next-year": "1ë…„",
            "less-than": "ë‚ ́§œ ë²”́œ„ë” %d ́¼ë³´ë‹¤ ë§́„ ́ˆ˜ ́—†́µë‹ˆë‹¤",
            "more-than": "ë‚ ́§œ ë²”́œ„ë” %d ́¼ë³´ë‹¤ ́‘́„ ́ˆ˜ ́—†́µë‹ˆë‹¤",
            "default-more": "ë‚ ́§œ ë²”́œ„ë¥¼ %d ́¼ë³´ë‹¤ ê¸¸ê²Œ ́„ íƒí•´ ́£¼́„¸́”",
            "default-single": "ë‚ ́§œë¥¼ ́„ íƒí•´ ́£¼́„¸́”",
            "default-less": "%d ́¼ë³´ë‹¤ ́‘́€ ë‚ ́§œë¥¼ ́„ íƒí•´ ́£¼́„¸́”",
            "default-range": "%d́™€ %d ́¼ ́‚¬́´́˜ ë‚ ́§œ ë²”́œ„ë¥¼ ́„ íƒí•´ ́£¼́„¸́”",
            "default-default": "ë‚ ́§œ ë²”́œ„ë¥¼ ́„ íƒí•´ ́£¼́„¸́”",
            "time": "́‹œê°",
            "hour": "́‹œ",
            "minute": "ë¶„"
        },
        "no": {
            "selected": "Valgt:",
            "day": "Dag",
            "days": "Dager",
            "apply": "Lukk",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "on",
            "week-4": "to",
            "week-5": "fr",
            "week-6": "lĂ¸",
            "week-7": "sĂ¸",
            "month-name": ["januar", "februar", "mars", "april", "mai", "juni", "juli", "august", "september", "oktober", "november", "desember"],
            "shortcuts": "Snarveier",
            "custom-values": "Egendefinerte Verdier",
            "past": "Over", // Not quite sure about the context of this one
            "following": "FĂ¸lger",
            "previous": "Forrige",
            "prev-week": "Uke",
            "prev-month": "MĂ¥ned",
            "prev-year": "Ă…r",
            "next": "Neste",
            "next-week": "Uke",
            "next-month": "MĂ¥ned",
            "next-year": "Ă…r",
            "less-than": "Datoperioden skal ikkje vĂ¦re lengre enn %d dager",
            "more-than": "Datoperioden skal ikkje vĂ¦re kortere enn %d dager",
            "default-more": "Vennligst velg ein datoperiode lengre enn %d dager",
            "default-single": "Vennligst velg ein dato",
            "default-less": "Vennligst velg ein datoperiode mindre enn %d dager",
            "default-range": "Vennligst velg ein datoperiode mellom %d og %d dager",
            "default-default": "Vennligst velg ein datoperiode",
            "time": "Tid",
            "hour": "Time",
            "minute": "Minutter"
        },
        "nl": {
            "selected": "Geselecteerd:",
            "day": "Dag",
            "days": "Dagen",
            "apply": "Ok",
            "week-1": "ma",
            "week-2": "di",
            "week-3": "wo",
            "week-4": "do",
            "week-5": "vr",
            "week-6": "za",
            "week-7": "zo",
            "month-name": ["januari", "februari", "maart", "april", "mei", "juni", "juli", "augustus", "september", "oktober", "november", "december"],
            "shortcuts": "Snelkoppelingen",
            "custom-values": "Aangepaste waarden",
            "past": "Verleden",
            "following": "Komend",
            "previous": "Vorige",
            "prev-week": "Week",
            "prev-month": "Maand",
            "prev-year": "Jaar",
            "next": "Volgende",
            "next-week": "Week",
            "next-month": "Maand",
            "next-year": "Jaar",
            "less-than": "Interval moet langer dan %d dagen zijn",
            "more-than": "Interval mag niet minder dan %d dagen zijn",
            "default-more": "Selecteer een interval langer dan %dagen",
            "default-single": "Selecteer een datum",
            "default-less": "Selecteer een interval minder dan %d dagen",
            "default-range": "Selecteer een interval tussen %d en %d dagen",
            "default-default": "Selecteer een interval",
            "time": "Tijd",
            "hour": "Uur",
            "minute": "Minuut"
        },
        "ru": {
            "selected": "Đ’Ñ‹Đ±Ñ€Đ°Đ½Đ¾:",
            "day": "Đ”ĐµĐ½ÑŒ",
            "days": "Đ”Đ½ĐµĐ¹",
            "apply": "ĐŸÑ€Đ¸Đ¼ĐµĐ½Đ¸Ñ‚ÑŒ",
            "week-1": "Đ¿Đ½",
            "week-2": "Đ²Ñ‚",
            "week-3": "ÑÑ€",
            "week-4": "Ñ‡Ñ‚",
            "week-5": "Đ¿Ñ‚",
            "week-6": "ÑĐ±",
            "week-7": "Đ²Ñ",
            "month-name": ["ÑĐ½Đ²Đ°Ñ€ÑŒ", "Ñ„ĐµĐ²Ñ€Đ°Đ»ÑŒ", "Đ¼Đ°Ñ€Ñ‚", "Đ°Đ¿Ñ€ĐµĐ»ÑŒ", "Đ¼Đ°Đ¹", "Đ¸ÑĐ½ÑŒ", "Đ¸ÑĐ»ÑŒ", "Đ°Đ²Đ³ÑƒÑÑ‚", "ÑĐµĐ½Ñ‚ÑĐ±Ñ€ÑŒ", "Đ¾ĐºÑ‚ÑĐ±Ñ€ÑŒ", "Đ½Đ¾ÑĐ±Ñ€ÑŒ", "Đ´ĐµĐºĐ°Đ±Ñ€ÑŒ"],
            "shortcuts": "Đ‘Ñ‹ÑÑ‚Ñ€Ñ‹Đ¹ Đ²Ñ‹Đ±Đ¾Ñ€",
            "custom-values": "ĐŸĐ¾Đ»ÑŒĐ·Đ¾Đ²Đ°Ñ‚ĐµĐ»ÑŒÑĐºĐ¸Đµ Đ·Đ½Đ°Ñ‡ĐµĐ½Đ¸Ñ",
            "past": "ĐŸÑ€Đ¾ÑˆĐµĐ´ÑˆĐ¸Đµ",
            "following": "Đ¡Đ»ĐµĐ´ÑƒÑÑ‰Đ¸Đµ",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "ĐĐµĐ´ĐµĐ»Ñ",
            "prev-month": "ĐœĐµÑÑÑ†",
            "prev-year": "Đ“Đ¾Đ´",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "ĐĐµĐ´ĐµĐ»Ñ",
            "next-month": "ĐœĐµÑÑÑ†",
            "next-year": "Đ“Đ¾Đ´",
            "less-than": "Đ”Đ¸Đ°Đ¿Đ°Đ·Đ¾Đ½ Đ½Đµ Đ¼Đ¾Đ¶ĐµÑ‚ Đ±Ñ‹Ñ‚ÑŒ Đ±Đ¾Đ»ÑŒÑˆĐµ %d Đ´Đ½ĐµĐ¹",
            "more-than": "Đ”Đ¸Đ°Đ¿Đ°Đ·Đ¾Đ½ Đ½Đµ Đ¼Đ¾Đ¶ĐµÑ‚ Đ±Ñ‹Ñ‚ÑŒ Đ¼ĐµĐ½ÑŒÑˆĐµ %d Đ´Đ½ĐµĐ¹",
            "default-more": "ĐŸĐ¾Đ¶Đ°Đ»ÑƒĐ¹ÑÑ‚Đ° Đ²Ñ‹Đ±ĐµÑ€Đ¸Ñ‚Đµ Đ´Đ¸Đ°Đ¿Đ°Đ·Đ¾Đ½ Đ±Đ¾Đ»ÑŒÑˆĐµ %d Đ´Đ½ĐµĐ¹",
            "default-single": "ĐŸĐ¾Đ¶Đ°Đ»ÑƒĐ¹ÑÑ‚Đ° Đ²Ñ‹Đ±ĐµÑ€Đ¸Ñ‚Đµ Đ´Đ°Ñ‚Ñƒ",
            "default-less": "ĐŸĐ¾Đ¶Đ°Đ»ÑƒĐ¹ÑÑ‚Đ° Đ²Ñ‹Đ±ĐµÑ€Đ¸Ñ‚Đµ Đ´Đ¸Đ°Đ¿Đ°Đ·Đ¾Đ½ Đ¼ĐµĐ½ÑŒÑˆĐµ %d Đ´Đ½ĐµĐ¹",
            "default-range": "ĐŸĐ¾Đ¶Đ°Đ»ÑƒĐ¹ÑÑ‚Đ° Đ²Ñ‹Đ±ĐµÑ€Đ¸Ñ‚Đµ Đ´Đ¸Đ°Đ¿Đ°Đ·Đ¾Đ½ Đ¼ĐµĐ¶Đ´Ñƒ %d Đ¸ %d Đ´Đ½ÑĐ¼Đ¸",
            "default-default": "ĐŸĐ¾Đ¶Đ°Đ»ÑƒĐ¹ÑÑ‚Đ° Đ²Ñ‹Đ±ĐµÑ€Đ¸Ñ‚Đµ Đ´Đ¸Đ°Đ¿Đ°Đ·Đ¾Đ½",
            "time": "Đ’Ñ€ĐµĐ¼Ñ",
            "hour": "Đ§Đ°ÑÑ‹",
            "minute": "ĐœĐ¸Đ½ÑƒÑ‚Ñ‹"
        },
        "pl": {
            "selected": "Wybrany:",
            "day": "DzieÅ„",
            "days": "Dni",
            "apply": "Zamknij",
            "week-1": "pon",
            "week-2": "wt",
            "week-3": "Å›r",
            "week-4": "czw",
            "week-5": "pt",
            "week-6": "so",
            "week-7": "nd",
            "month-name": ["styczeÅ„", "luty", "marzec", "kwiecieÅ„", "maj", "czerwiec", "lipiec", "sierpieÅ„", "wrzesieÅ„", "paÅºdziernik", "listopad", "grudzieÅ„"],
            "shortcuts": "SkrĂ³ty",
            "custom-values": "Niestandardowe wartoÅ›ci",
            "past": "PrzeszÅ‚e",
            "following": "NastÄ™pne",
            "previous": "Poprzednie",
            "prev-week": "tydzieÅ„",
            "prev-month": "miesiÄ…c",
            "prev-year": "rok",
            "next": "NastÄ™pny",
            "next-week": "tydzieÅ„",
            "next-month": "miesiÄ…c",
            "next-year": "rok",
            "less-than": "Okres nie powinien byÄ‡ dÅ‚uÅ¼szy niÅ¼ %d dni",
            "more-than": "Okres nie powinien byÄ‡ krĂ³tszy niÅ¼  %d ni",
            "default-more": "Wybierz okres dÅ‚uÅ¼szy niÅ¼ %d dni",
            "default-single": "Wybierz datÄ™",
            "default-less": "Wybierz okres krĂ³tszy niÅ¼ %d dni",
            "default-range": "Wybierz okres trwajÄ…cy od %d do %d dni",
            "default-default": "Wybierz okres",
            "time": "Czas",
            "hour": "Godzina",
            "minute": "Minuta"
        },
        "se": {
            "selected": "Vald:",
            "day": "dag",
            "days": "dagar",
            "apply": "godkĂ¤nn",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "on",
            "week-4": "to",
            "week-5": "fr",
            "week-6": "lĂ¶",
            "week-7": "sĂ¶",
            "month-name": ["januari", "februari", "mars", "april", "maj", "juni", "juli", "augusti", "september", "oktober", "november", "december"],
            "shortcuts": "genvĂ¤gar",
            "custom-values": "Anpassade vĂ¤rden",
            "past": "Ă¶ver",
            "following": "fĂ¶ljande",
            "previous": "fĂ¶rra",
            "prev-week": "vecka",
            "prev-month": "mĂ¥nad",
            "prev-year": "Ă¥r",
            "next": "nĂ¤sta",
            "next-week": "vecka",
            "next-month": "mĂ¥ned",
            "next-year": "Ă¥r",
            "less-than": "Datumintervall bĂ¶r inte vara mindre Ă¤n %d dagar",
            "more-than": "Datumintervall bĂ¶r inte vara mer Ă¤n %d dagar",
            "default-more": "VĂ¤lj ett datumintervall lĂ¤ngre Ă¤n %d dagar",
            "default-single": "VĂ¤lj ett datum",
            "default-less": "VĂ¤lj ett datumintervall mindre Ă¤n %d dagar",
            "default-range": "VĂ¤lj ett datumintervall mellan %d och %d dagar",
            "default-default": "VĂ¤lj ett datumintervall",
            "time": "tid",
            "hour": "timme",
            "minute": "minut"
        },
        "pt": //Portuguese (European)
        {
            "selected": "Selecionado:",
            "day": "Dia",
            "days": "Dias",
            "apply": "Fechar",
            "week-1": "seg",
            "week-2": "ter",
            "week-3": "qua",
            "week-4": "qui",
            "week-5": "sex",
            "week-6": "sab",
            "week-7": "dom",
            "week-number": "N",
            "month-name": ["janeiro", "fevereiro", "marĂ§o", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"],
            "shortcuts": "Atalhos",
            "custom-values": "Valores Personalizados",
            "past": "Passado",
            "following": "Seguinte",
            "previous": "Anterior",
            "prev-week": "Semana",
            "prev-month": "MĂªs",
            "prev-year": "Ano",
            "next": "PrĂ³ximo",
            "next-week": "PrĂ³xima Semana",
            "next-month": "PrĂ³ximo MĂªs",
            "next-year": "PrĂ³ximo Ano",
            "less-than": "O perĂ­odo selecionado nĂ£o deve ser maior que %d dias",
            "more-than": "O perĂ­odo selecionado nĂ£o deve ser menor que %d dias",
            "default-more": "Selecione um perĂ­odo superior a %d dias",
            "default-single": "Selecione uma data",
            "default-less": "Selecione um perĂ­odo inferior a %d dias",
            "default-range": "Selecione um perĂ­odo de %d a %d dias",
            "default-default": "Selecione um perĂ­odo",
            "time": "Tempo",
            "hour": "Hora",
            "minute": "Minuto"
        },
        "tc": // traditional chinese
        {
            "selected": "å·²é¸æ“‡:",
            "day": "å¤©",
            "days": "å¤©",
            "apply": "ç¢ºå®",
            "week-1": "ä¸€",
            "week-2": "äºŒ",
            "week-3": "ä¸‰",
            "week-4": "å››",
            "week-5": "äº”",
            "week-6": "å…­",
            "week-7": "æ—¥",
            "week-number": "å‘¨",
            "month-name": ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"],
            "shortcuts": "å¿«é€Ÿé¸æ“‡",
            "past": "éå»",
            "following": "å°‡ä¾†",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "ä¸é€±",
            "prev-month": "ä¸å€‹æœˆ",
            "prev-year": "å»å¹´",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "ä¸‹å‘¨",
            "next-month": "ä¸‹å€‹æœˆ",
            "next-year": "æ˜å¹´",
            "less-than": "æ‰€é¸æ—¥æœŸç¯„åœä¸èƒ½å¤§æ–¼%då¤©",
            "more-than": "æ‰€é¸æ—¥æœŸç¯„åœä¸èƒ½å°æ–¼%då¤©",
            "default-more": "è«‹é¸æ“‡å¤§æ–¼%då¤©ç„æ—¥æœŸç¯„åœ",
            "default-less": "è«‹é¸æ“‡å°æ–¼%då¤©ç„æ—¥æœŸç¯„åœ",
            "default-range": "è«‹é¸æ“‡%då¤©åˆ°%då¤©ç„æ—¥æœŸç¯„åœ",
            "default-single": "è«‹é¸æ“‡ä¸€å€‹æ—¥æœŸ",
            "default-default": "è«‹é¸æ“‡ä¸€å€‹æ—¥æœŸç¯„åœ",
            "time": "æ—¥æœŸ",
            "hour": "å°æ™‚",
            "minute": "åˆ†é˜"
        },
        "ja": {
            "selected": "é¸æă—ă¾ă—ăŸ:",
            "day": "æ—¥",
            "days": "æ—¥ă€…",
            "apply": "é–‰ă˜ă‚‹",
            "week-1": "æœˆ",
            "week-2": "ç«",
            "week-3": "æ°´",
            "week-4": "æœ¨",
            "week-5": "é‡‘",
            "week-6": "åœŸ",
            "week-7": "æ—¥",
            "month-name": ["1æœˆ", "2æœˆ", "3æœˆ", "4æœˆ", "5æœˆ", "6æœˆ", "7æœˆ", "8æœˆ", "9æœˆ", "10æœˆ", "11æœˆ", "12æœˆ"],
            "shortcuts": "ă‚¯ă‚¤ăƒƒă‚¯é¸æ",
            "past": "éå»",
            "following": "å°†æ¥",
            "previous": "&nbsp;&nbsp;&nbsp;",
            "prev-week": "å…ˆé€±ă€",
            "prev-month": "å…ˆæœˆ",
            "prev-year": "æ˜¨å¹´",
            "next": "&nbsp;&nbsp;&nbsp;",
            "next-week": "æ¥é€±",
            "next-month": "æ¥æœˆ",
            "next-year": "æ¥å¹´",
            "less-than": "æ—¥ä»˜ă®ç¯„å›²ă¯ ï¼…d æ—¥ä»¥ä¸ă«ă™ă¹ăă§ă¯ă‚ă‚ă¾ă›ă‚“",
            "more-than": "æ—¥ä»˜ă®ç¯„å›²ă¯ ï¼…d æ—¥ă‚’ä¸‹å›ă£ă¦ă¯ă„ă‘ă¾ă›ă‚“",
            "default-more": "ï¼…d æ—¥ă‚ˆă‚ă‚‚é•·ă„æœŸé–“ă‚’é¸æă—ă¦ăă ă•ă„",
            "default-less": "ï¼…d æ—¥æœªæº€ă®æœŸé–“ă‚’é¸æă—ă¦ăă ă•ă„",
            "default-range": "ï¼…d ă¨ï¼… dæ—¥ă®é–“ă®æ—¥ä»˜ç¯„å›²ă‚’é¸æă—ă¦ăă ă•ă„",
            "default-single": "æ—¥ä»˜ă‚’é¸æă—ă¦ăă ă•ă„",
            "default-default": "æ—¥ä»˜ç¯„å›²ă‚’é¸æă—ă¦ăă ă•ă„",
            "time": "æ™‚é–“",
            "hour": "æ™‚é–“",
            "minute": "åˆ†"
        },
        "da": {
            "selected": "Valgt:",
            "day": "Dag",
            "days": "Dage",
            "apply": "Luk",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "on",
            "week-4": "to",
            "week-5": "fr",
            "week-6": "lĂ¶",
            "week-7": "sĂ¶",
            "month-name": ["januar", "februar", "marts", "april", "maj", "juni", "juli", "august", "september", "oktober", "november", "december"],
            "shortcuts": "genveje",
            "custom-values": "Brugerdefinerede vĂ¦rdier",
            "past": "Forbi",
            "following": "FĂ¸lgende",
            "previous": "Forrige",
            "prev-week": "uge",
            "prev-month": "mĂ¥nad",
            "prev-year": "Ă¥r",
            "next": "NĂ¦ste",
            "next-week": "NĂ¦ste uge",
            "next-month": "NĂ¦ste mĂ¥ned",
            "next-year": "NĂ¦ste Ă¥r",
            "less-than": "Dato interval bĂ¸r ikke vĂ¦re med end %d dage",
            "more-than": "Dato interval bĂ¸r ikke vĂ¦re mindre end %d dage",
            "default-more": "VĂ¦lg datointerval lĂ¦ngere end %d dage",
            "default-single": "VĂ¦lg dato",
            "default-less": "VĂ¦lg datointerval mindre end %d dage",
            "default-range": "VĂ¦lg datointerval mellem %d og %d dage",
            "default-default": "VĂ¦lg datointerval",
            "time": "tid",
            "hour": "time",
            "minute": "minut"
        },
        "fi": // Finnish
        {
            "selected": "Valittu:",
            "day": "PĂ¤ivĂ¤",
            "days": "PĂ¤ivĂ¤Ă¤",
            "apply": "Sulje",
            "week-1": "ma",
            "week-2": "ti",
            "week-3": "ke",
            "week-4": "to",
            "week-5": "pe",
            "week-6": "la",
            "week-7": "su",
            "week-number": "V",
            "month-name": ["tammikuu", "helmikuu", "maaliskuu", "huhtikuu", "toukokuu", "kesĂ¤kuu", "heinĂ¤kuu", "elokuu", "syyskuu", "lokakuu", "marraskuu", "joulukuu"],
            "shortcuts": "Pikavalinnat",
            "custom-values": "Mukautetut Arvot",
            "past": "Menneet",
            "following": "Tulevat",
            "previous": "Edellinen",
            "prev-week": "Viikko",
            "prev-month": "Kuukausi",
            "prev-year": "Vuosi",
            "next": "Seuraava",
            "next-week": "Viikko",
            "next-month": "Kuukausi",
            "next-year": "Vuosi",
            "less-than": "Aikajakson tulisi olla vĂ¤hemmĂ¤n kuin %d pĂ¤ivĂ¤Ă¤",
            "more-than": "Aikajakson ei tulisi olla vĂ¤hempĂ¤Ă¤ kuin %d pĂ¤ivĂ¤Ă¤",
            "default-more": "Valitse pidempi aikajakso kuin %d pĂ¤ivĂ¤Ă¤",
            "default-single": "Valitse pĂ¤ivĂ¤",
            "default-less": "Valitse lyhyempi aikajakso kuin %d pĂ¤ivĂ¤Ă¤",
            "default-range": "Valitse aikajakso %d ja %d pĂ¤ivĂ¤n vĂ¤liltĂ¤",
            "default-default": "Valitse aikajakso",
            "time": "Aika",
            "hour": "Tunti",
            "minute": "Minuutti"
        },
        "cat": // Catala
        {
            "selected": "Seleccionats:",
            "day": "Dia",
            "days": "Dies",
            "apply": "Tanca",
            "week-1": "Dl",
            "week-2": "Dm",
            "week-3": "Dc",
            "week-4": "Dj",
            "week-5": "Dv",
            "week-6": "Ds",
            "week-7": "Dg",
            "week-number": "S",
            "month-name": ["gener", "febrer", "marĂ§", "abril", "maig", "juny", "juliol", "agost", "setembre", "octubre", "novembre", "desembre"],
            "shortcuts": "DreĂ§eres",
            "custom-values": "Valors personalitzats",
            "past": "Passat",
            "following": "Futur",
            "previous": "Anterior",
            "prev-week": "Setmana",
            "prev-month": "Mes",
            "prev-year": "Any",
            "next": "SegĂ¼ent",
            "next-week": "Setmana",
            "next-month": "Mes",
            "next-year": "Any",
            "less-than": "El perĂ­ode no hauria de ser de mĂ©s de %d dies",
            "more-than": "El perĂ­ode no hauria de ser de menys de %d dies",
            "default-more": "Perfavor selecciona un perĂ­ode mĂ©s gran de %d dies",
            "default-single": "Perfavor selecciona una data",
            "default-less": "Perfavor selecciona un perĂ­ode de menys de %d dies",
            "default-range": "Perfavor selecciona un perĂ­ode d'entre %d i %d dies",
            "default-default": "Perfavor selecciona un perĂ­ode",
            "time": "Temps",
            "hour": "Hora",
            "minute": "Minut"
        }
    };

    $.fn.dateRangePicker = function(opt) {
        if (!opt) opt = {};
        opt = $.extend(true, {
            autoClose: false,
            format: 'YYYY-MM-DD',
            separator: ' to ',
            language: 'auto',
            startOfWeek: 'sunday', // or monday
            getValue: function() {
                return $(this).val();
            },
            setValue: function(s) {
                if (!$(this).attr('readonly') && !$(this).is(':disabled') && s != $(this).val()) {
                    $(this).val(s);
                }
            },
            onSelect: null,
            startDate: false,
            endDate: false,
            time: {
                enabled: false
            },
            minDays: 0,
            maxDays: 0,
            showShortcuts: false,
            shortcuts: {
                //'prev-days': [1,3,5,7],
                // 'next-days': [3,5,7],
                //'prev' : ['week','month','year'],
                // 'next' : ['week','month','year']
            },
            customShortcuts: [],
            inline: false,
            container: 'body',
            alwaysOpen: false,
            singleDate: false,
            lookBehind: false,
            batchMode: false,
            duration: 200,
            stickyMonths: false,
            dayDivAttrs: [],
            dayTdAttrs: [],
            selectForward: false,
            selectBackward: false,
            applyBtnClass: '',
            singleMonth: 'auto',
            hoveringTooltip: function(days, startTime, hoveringTime) {
                return days > 1 ? days + ' ' + translate('days') : '';
            },
            showTopbar: true,
            swapTime: false,
            showWeekNumbers: false,
            getWeekNumber: function(date) //date will be the first day of a week
            {
                return moment(date).format('w');
            },
            customOpenAnimation: null,
            customCloseAnimation: null,
            customArrowPrevSymbol: null,
            customArrowNextSymbol: null,
            monthSelect: false,
            yearSelect: false
        }, opt);

        opt.start = false;
        opt.end = false;

        opt.startWeek = false;

        //detect a touch device
        opt.isTouchDevice = 'ontouchstart' in window || navigator.msMaxTouchPoints;

        //if it is a touch device, hide hovering tooltip
        if (opt.isTouchDevice) opt.hoveringTooltip = false;

        //show one month on mobile devices
        if (opt.singleMonth == 'auto') opt.singleMonth = $(window).width() < 480;
        if (opt.singleMonth) opt.stickyMonths = false;

        if (!opt.showTopbar) opt.autoClose = true;

        if (opt.startDate && typeof opt.startDate == 'string') opt.startDate = moment(opt.startDate, opt.format).toDate();
        if (opt.endDate && typeof opt.endDate == 'string') opt.endDate = moment(opt.endDate, opt.format).toDate();

        if (opt.yearSelect && typeof opt.yearSelect === 'boolean') {
            opt.yearSelect = function(current) { return [current - 5, current + 5]; }
        }

        var languages = getLanguages();
        var box;
        var initiated = false;
        var self = this;
        var selfDom = $(self).get(0);
        var domChangeTimer;

        $(this).unbind('.datepicker').bind('click.datepicker', function(evt) {
            var isOpen = box.is(':visible');
            if (!isOpen){
            	open(opt.duration);
            }else{
            	closeDatePicker();
            }
        }).bind('change.datepicker', function(evt) {
            checkAndSetDefaultValue();
        }).bind('keyup.datepicker', function() {
            try {
                clearTimeout(domChangeTimer);
            } catch (e) {}
            domChangeTimer = setTimeout(function() {
                checkAndSetDefaultValue();
            }, 2000);
        });

        init_datepicker.call(this);

        if (opt.alwaysOpen) {
            open(0);
        }

        // expose some api
        $(this).data('dateRangePicker', {
            setStart: function(d1) {
                if (typeof d1 == 'string') {
                    d1 = moment(d1, opt.format).toDate();
                }

                opt.end = false;
                setSingleDate(d1);

                return this;
            },
            setEnd: function(d2, silent) {
                var start = new Date();
                start.setTime(opt.start);
                if (typeof d2 == 'string') {
                    d2 = moment(d2, opt.format).toDate();
                }
                setDateRange(start, d2, silent);
                return this;
            },
            setDateRange: function(d1, d2, silent) {
                if (typeof d1 == 'string' && typeof d2 == 'string') {
                    d1 = moment(d1, opt.format).toDate();
                    d2 = moment(d2, opt.format).toDate();
                }
                setDateRange(d1, d2, silent);
            },
            clear: clearSelection,
            close: closeDatePicker,
            open: open,
            redraw: redrawDatePicker,
            getDatePicker: getDatePicker,
            resetMonthsView: resetMonthsView,
            destroy: function() {
                $(self).unbind('.datepicker');
                $(self).data('dateRangePicker', '');
                $(self).data('date-picker-opened', null);
                box.remove();
                $(window).unbind('resize.datepicker', calcPosition);
                $(document).unbind('click.datepicker', closeDatePicker);
            }
        });

        $(window).bind('resize.datepicker', calcPosition);

        return this;

        function IsOwnDatePickerClicked(evt, selfObj) {
            return (selfObj.contains(evt.target) || evt.target == selfObj || (selfObj.childNodes != undefined && $.inArray(evt.target, selfObj.childNodes) >= 0));
        }

        function init_datepicker() {
            var self = this;

            if ($(this).data('date-picker-opened')) {
                closeDatePicker();
                return;
            }
            
            $(this).data('date-picker-opened', true);


            box = createDom().hide();
            box.append('<div class="date-range-length-tip"></div>');

            $(opt.container).append(box);

            if (!opt.inline) {
                calcPosition();
            } else {
                box.addClass('inline-wrapper');
            }

            if (opt.alwaysOpen) {
                box.find('.apply-btn').hide();
            }

            var defaultTime = getDefaultTime();
            resetMonthsView(defaultTime);

            if (opt.time.enabled) {
                if ((opt.startDate && opt.endDate) || (opt.start && opt.end)) {
                    showTime(moment(opt.start || opt.startDate).toDate(), 'time1');
                    showTime(moment(opt.end || opt.endDate).toDate(), 'time2');
                } else {
                    var defaultEndTime = opt.defaultEndTime ? opt.defaultEndTime : defaultTime;
                    showTime(defaultTime, 'time1');
                    showTime(defaultEndTime, 'time2');
                }
            }

            //showSelectedInfo();


            var defaultTopText = '';
            if (opt.singleDate)
                defaultTopText = translate('default-single');
            else if (opt.minDays && opt.maxDays)
                defaultTopText = translate('default-range');
            else if (opt.minDays)
                defaultTopText = translate('default-more');
            else if (opt.maxDays)
                defaultTopText = translate('default-less');
            else
                defaultTopText = translate('default-default');

            box.find('.default-top').html(defaultTopText.replace(/\%d/, opt.minDays).replace(/\%d/, opt.maxDays));
            if (opt.singleMonth) {
                box.addClass('single-month');
            } else {
                box.addClass('two-months');
            }


            setTimeout(function() {
                updateCalendarWidth();
                initiated = true;
            }, 0);

            box.click(function(evt) {
                evt.stopPropagation();
            });

            //if user click other place of the webpage, close date range picker window
            $(document).bind('click.datepicker', function(evt) {
                if (!IsOwnDatePickerClicked(evt, self[0])) {
                    if (box.is(':visible')) closeDatePicker();
                }
            });

            box.find('.next').click(function() {
                if (!opt.stickyMonths)
                    gotoNextMonth(this);
                else
                    gotoNextMonth_stickily(this);
            });

            function gotoNextMonth(self) {
                var isMonth2 = $(self).parents('table').hasClass('month2');
                var month = isMonth2 ? opt.month2 : opt.month1;
                month = nextMonth(month);
                if (!opt.singleMonth && !opt.singleDate && !isMonth2 && compare_month(month, opt.month2) >= 0 || isMonthOutOfBounds(month)) return;
                showMonth(month, isMonth2 ? 'month2' : 'month1');
                showGap();
            }

            function gotoNextMonth_stickily(self) {
                var nextMonth1 = nextMonth(opt.month1);
                var nextMonth2 = nextMonth(opt.month2);
                if (isMonthOutOfBounds(nextMonth2)) return;
                if (!opt.singleDate && compare_month(nextMonth1, nextMonth2) >= 0) return;
                showMonth(nextMonth1, 'month1');
                showMonth(nextMonth2, 'month2');
                showSelectedDays();
            }


            box.find('.prev').click(function() {
                if (!opt.stickyMonths)
                    gotoPrevMonth(this);
                else
                    gotoPrevMonth_stickily(this);
            });

            function gotoPrevMonth(self) {
                var isMonth2 = $(self).parents('table').hasClass('month2');
                var month = isMonth2 ? opt.month2 : opt.month1;
                month = prevMonth(month);
                if (isMonth2 && compare_month(month, opt.month1) <= 0 || isMonthOutOfBounds(month)) return;
                showMonth(month, isMonth2 ? 'month2' : 'month1');
                showGap();
            }

            function gotoPrevMonth_stickily(self) {
                var prevMonth1 = prevMonth(opt.month1);
                var prevMonth2 = prevMonth(opt.month2);
                if (isMonthOutOfBounds(prevMonth1)) return;
                if (!opt.singleDate && compare_month(prevMonth2, prevMonth1) <= 0) return;
                showMonth(prevMonth2, 'month2');
                showMonth(prevMonth1, 'month1');
                showSelectedDays();
            }

            box.attr('unselectable', 'on')
                .css('user-select', 'none')
                .bind('selectstart', function(e) {
                    e.preventDefault();
                    return false;
                });

            box.find('.apply-btn').click(function() {
                closeDatePicker();
                var dateRange = getDateString(new Date(opt.start)) + opt.separator + getDateString(new Date(opt.end));
                $(self).trigger('datepicker-apply', {
                    'value': dateRange,
                    'date1': new Date(opt.start),
                    'date2': new Date(opt.end)
                });
            });

            box.find('[custom]').click(function() {
                var valueName = $(this).attr('custom');
                opt.start = false;
                opt.end = false;
                box.find('.day.checked').removeClass('checked');
                opt.setValue.call(selfDom, valueName);
                checkSelectionValid();
                showSelectedInfo(true);
                showSelectedDays();
                if (opt.autoClose) closeDatePicker();
            });

            box.find('[shortcut]').click(function() {
                var shortcut = $(this).attr('shortcut');
                var end = new Date(),
                    start = false;
                var dir;
                if (shortcut.indexOf('day') != -1) {
                    var day = parseInt(shortcut.split(',', 2)[1], 10);
                    start = new Date(new Date().getTime() + 86400000 * day);
                    end = new Date(end.getTime() + 86400000 * (day > 0 ? 1 : -1));
                } else if (shortcut.indexOf('week') != -1) {
                    dir = shortcut.indexOf('prev,') != -1 ? -1 : 1;
                    var stopDay;
                    if (dir == 1)
                        stopDay = opt.startOfWeek == 'monday' ? 1 : 0;
                    else
                        stopDay = opt.startOfWeek == 'monday' ? 0 : 6;

                    end = new Date(end.getTime() - 86400000);
                    while (end.getDay() != stopDay) end = new Date(end.getTime() + dir * 86400000);
                    start = new Date(end.getTime() + dir * 86400000 * 6);
                } else if (shortcut.indexOf('month') != -1) {
                    dir = shortcut.indexOf('prev,') != -1 ? -1 : 1;
                    if (dir == 1)
                        start = nextMonth(end);
                    else
                        start = prevMonth(end);
                    start.setDate(1);
                    end = nextMonth(start);
                    end.setDate(1);
                    end = new Date(end.getTime() - 86400000);
                } else if (shortcut.indexOf('year') != -1) {
                    dir = shortcut.indexOf('prev,') != -1 ? -1 : 1;
                    start = new Date();
                    start.setFullYear(end.getFullYear() + dir);
                    start.setMonth(0);
                    start.setDate(1);
                    end.setFullYear(end.getFullYear() + dir);
                    end.setMonth(11);
                    end.setDate(31);
                } else if (shortcut == 'custom') {
                    var name = $(this).html();
                    if (opt.customShortcuts && opt.customShortcuts.length > 0) {
                        for (var i = 0; i < opt.customShortcuts.length; i++) {
                            var sh = opt.customShortcuts[i];
                            if (sh.name == name) {
                                var data = [];
                                // try
                                // {
                                data = sh['dates'].call();
                                //}catch(e){}
                                if (data && data.length == 2) {
                                    start = data[0];
                                    end = data[1];
                                }

                                // if only one date is specified then just move calendars there
                                // move calendars to show this date's month and next months
                                if (data && data.length == 1) {
                                    var movetodate = data[0];
                                    showMonth(movetodate, 'month1');
                                    showMonth(nextMonth(movetodate), 'month2');
                                    showGap();
                                }

                                break;
                            }
                        }
                    }
                }
                if (start && end) {
                    setDateRange(start, end);
                    checkSelectionValid();
                    alert(1);
                }
            });

            box.find('.time1 input[type=range]').bind('change touchmove', function(e) {
                var target = e.target,
                    hour = target.name == 'hour' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined,
                    min = target.name == 'minute' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined;
                setTime('time1', hour, min);
            });

            box.find('.time2 input[type=range]').bind('change touchmove', function(e) {
                var target = e.target,
                    hour = target.name == 'hour' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined,
                    min = target.name == 'minute' ? $(target).val().replace(/^(\d{1})$/, '0$1') : undefined;
                setTime('time2', hour, min);
            });

        }


        function calcPosition() {
            if (!opt.inline) {
                var offset = $(self).offset();
                if ($(opt.container).css('position') == 'relative') {
                    var containerOffset = $(opt.container).offset();
                    var leftIndent = Math.max(0, offset.left + box.outerWidth() - $('body').width() + 16);
                    box.css({
                        top: offset.top - containerOffset.top + $(self).outerHeight() + 4,
                        left: offset.left - containerOffset.left - leftIndent
                    });
                } else {
                    if (offset.left < 460) //left to right
                    {
                        box.css({
                            top: offset.top + $(self).outerHeight() + parseInt($('body').css('border-top') || 0, 10),
                            left: offset.left
                        });
                    } else {
                        box.css({
                            top: offset.top + $(self).outerHeight() + parseInt($('body').css('border-top') || 0, 10),
                            left: offset.left + $(self).width() - box.width() - 16
                        });
                    }
                }
            }
        }

        // Return the date picker wrapper element
        function getDatePicker() {
            return box;
        }

        function open(animationTime) {
            redrawDatePicker();
            checkAndSetDefaultValue();
            if (opt.customOpenAnimation) {
                opt.customOpenAnimation.call(box.get(0), function() {
                    $(self).trigger('datepicker-opened', {
                        relatedTarget: box
                    });
                });
            } else {
                box.slideDown(animationTime, function() {
                    $(self).trigger('datepicker-opened', {
                        relatedTarget: box
                    });
                });
            }
            $(self).trigger('datepicker-open', {
                relatedTarget: box
            });
            showGap();
            updateCalendarWidth();
            calcPosition();
        }

        function checkAndSetDefaultValue() {
            var __default_string = opt.getValue.call(selfDom);
            var defaults = __default_string ? __default_string.split(opt.separator) : '';

            if (defaults && ((defaults.length == 1 && opt.singleDate) || defaults.length >= 2)) {
                var ___format = opt.format;
                if (___format.match(/Do/)) {

                    ___format = ___format.replace(/Do/, 'D');
                    defaults[0] = defaults[0].replace(/(\d+)(th|nd|st)/, '$1');
                    if (defaults.length >= 2) {
                        defaults[1] = defaults[1].replace(/(\d+)(th|nd|st)/, '$1');
                    }
                }
                // set initiated  to avoid triggerring datepicker-change event
                initiated = false;
                if (defaults.length >= 2) {
                    setDateRange(getValidValue(defaults[0], ___format, moment.locale(opt.language)), getValidValue(defaults[1], ___format, moment.locale(opt.language)));
                } else if (defaults.length == 1 && opt.singleDate) {
                    setSingleDate(getValidValue(defaults[0], ___format, moment.locale(opt.language)));
                }

                initiated = true;
            }
        }

        function getValidValue(date, format, locale) {
            if (moment(date, format, locale).isValid()) {
                return moment(date, format, locale).toDate();
            } else {
                return moment().toDate();
            }
        }

        function updateCalendarWidth() {
            var gapMargin = box.find('.gap').css('margin-left');
            if (gapMargin) gapMargin = parseInt(gapMargin);
            var w1 = box.find('.month1').width();
            var w2 = box.find('.gap').width() + (gapMargin ? gapMargin * 2 : 0);
            var w3 = box.find('.month2').width();
            box.find('.month-wrapper').width(w1 + w2 + w3);
        }

        function renderTime(name, date) {
            box.find('.' + name + ' input[type=range].hour-range').val(moment(date).hours());
            box.find('.' + name + ' input[type=range].minute-range').val(moment(date).minutes());
            setTime(name, moment(date).format('HH'), moment(date).format('mm'));
        }

        function changeTime(name, date) {
            opt[name] = parseInt(
                moment(parseInt(date))
                .startOf('day')
                .add(moment(opt[name + 'Time']).format('HH'), 'h')
                .add(moment(opt[name + 'Time']).format('mm'), 'm').valueOf()
            );
        }

        function swapTime() {
            renderTime('time1', opt.start);
            renderTime('time2', opt.end);
        }

        function setTime(name, hour, minute) {
            hour && (box.find('.' + name + ' .hour-val').text(hour));
            minute && (box.find('.' + name + ' .minute-val').text(minute));
            switch (name) {
                case 'time1':
                    if (opt.start) {
                        setRange('start', moment(opt.start));
                    }
                    setRange('startTime', moment(opt.startTime || moment().valueOf()));
                    break;
                case 'time2':
                    if (opt.end) {
                        setRange('end', moment(opt.end));
                    }
                    setRange('endTime', moment(opt.endTime || moment().valueOf()));
                    break;
            }

            function setRange(name, timePoint) {
                var h = timePoint.format('HH'),
                    m = timePoint.format('mm');
                opt[name] = timePoint
                    .startOf('day')
                    .add(hour || h, 'h')
                    .add(minute || m, 'm')
                    .valueOf();
            }
            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
        }

        function clearSelection() {
            opt.start = false;
            opt.end = false;
            box.find('.day.checked').removeClass('checked');
            box.find('.day.last-date-selected').removeClass('last-date-selected');
            box.find('.day.first-date-selected').removeClass('first-date-selected');
            opt.setValue.call(selfDom, '');
            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
        }

        function handleStart(time) {
            var r = time;
            if (opt.batchMode === 'week-range') {
                if (opt.startOfWeek === 'monday') {
                    r = moment(parseInt(time)).startOf('isoweek').valueOf();
                } else {
                    r = moment(parseInt(time)).startOf('week').valueOf();
                }
            } else if (opt.batchMode === 'month-range') {
                r = moment(parseInt(time)).startOf('month').valueOf();
            }
            return r;
        }

        function handleEnd(time) {
            var r = time;
            if (opt.batchMode === 'week-range') {
                if (opt.startOfWeek === 'monday') {
                    r = moment(parseInt(time)).endOf('isoweek').valueOf();
                } else {
                    r = moment(parseInt(time)).endOf('week').valueOf();
                }
            } else if (opt.batchMode === 'month-range') {
                r = moment(parseInt(time)).endOf('month').valueOf();
            }
            return r;
        }


        function dayClicked(day) {
            if (day.hasClass('invalid')) return;
            var time = day.attr('time');
            day.addClass('checked');
            if (opt.singleDate) {
                opt.start = time;
                opt.end = false;
            } else if (opt.batchMode === 'week') {
                if (opt.startOfWeek === 'monday') {
                    opt.start = moment(parseInt(time)).startOf('isoweek').valueOf();
                    opt.end = moment(parseInt(time)).endOf('isoweek').valueOf();
                } else {
                    opt.end = moment(parseInt(time)).endOf('week').valueOf();
                    opt.start = moment(parseInt(time)).startOf('week').valueOf();
                }
            } else if (opt.batchMode === 'workweek') {
                opt.start = moment(parseInt(time)).day(1).valueOf();
                opt.end = moment(parseInt(time)).day(5).valueOf();
            } else if (opt.batchMode === 'weekend') {
                opt.start = moment(parseInt(time)).day(6).valueOf();
                opt.end = moment(parseInt(time)).day(7).valueOf();
            } else if (opt.batchMode === 'month') {
                opt.start = moment(parseInt(time)).startOf('month').valueOf();
                opt.end = moment(parseInt(time)).endOf('month').valueOf();
            } else if ((opt.start && opt.end) || (!opt.start && !opt.end)) {
                opt.start = handleStart(time);
                opt.end = false;
            } else if (opt.start) {
                opt.end = handleEnd(time);
                if (opt.time.enabled) {
                    changeTime('end', opt.end);
                }
            }

            //Update time in case it is enabled and timestamps are available
            if (opt.time.enabled) {
                if (opt.start) {
                    changeTime('start', opt.start);
                }
                if (opt.end) {
                    changeTime('end', opt.end);
                }
            }

            //In case the start is after the end, swap the timestamps
            if (!opt.singleDate && opt.start && opt.end && opt.start > opt.end) {
                var tmp = opt.end;
                opt.end = handleEnd(opt.start);
                opt.start = handleStart(tmp);
                if (opt.time.enabled && opt.swapTime) {
                    swapTime();
                }
            }

            opt.start = parseInt(opt.start);
            opt.end = parseInt(opt.end);

            clearHovering();
            if (opt.start && !opt.end) {
                $(self).trigger('datepicker-first-date-selected', {
                    'date1': new Date(opt.start)
                });
                dayHovering(day);
            }
            updateSelectableRange(time);

            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
            autoclose();
            
            
            if (opt.onSelect && opt.start && opt.end){
                opt.onSelect.call(selfDom, Math.floor((new Date(opt.start)).getTime()/1000), Math.floor((new Date(opt.end)).getTime()/1000));	
            }
        }


        function weekNumberClicked(weekNumberDom) {
            var thisTime = parseInt(weekNumberDom.attr('data-start-time'), 10);
            var date1, date2;
            if (!opt.startWeek) {
                opt.startWeek = thisTime;
                weekNumberDom.addClass('week-number-selected');
                date1 = new Date(thisTime);
                opt.start = moment(date1).day(opt.startOfWeek == 'monday' ? 1 : 0).valueOf();
                opt.end = moment(date1).day(opt.startOfWeek == 'monday' ? 7 : 6).valueOf();
            } else {
                box.find('.week-number-selected').removeClass('week-number-selected');
                date1 = new Date(thisTime < opt.startWeek ? thisTime : opt.startWeek);
                date2 = new Date(thisTime < opt.startWeek ? opt.startWeek : thisTime);
                opt.startWeek = false;
                opt.start = moment(date1).day(opt.startOfWeek == 'monday' ? 1 : 0).valueOf();
                opt.end = moment(date2).day(opt.startOfWeek == 'monday' ? 7 : 6).valueOf();
            }
            updateSelectableRange();
            checkSelectionValid();
            showSelectedInfo();
            showSelectedDays();
            autoclose();
        }

        function isValidTime(time) {
            time = parseInt(time, 10);
            if (opt.startDate && compare_day(time, opt.startDate) < 0) return false;
            if (opt.endDate && compare_day(time, opt.endDate) > 0) return false;

            if (opt.start && !opt.end && !opt.singleDate) {
                //check maxDays and minDays setting
                if (opt.maxDays > 0 && countDays(time, opt.start) > opt.maxDays) return false;
                if (opt.minDays > 0 && countDays(time, opt.start) < opt.minDays) return false;

                //check selectForward and selectBackward
                if (opt.selectForward && time < opt.start) return false;
                if (opt.selectBackward && time > opt.start) return false;

                //check disabled days
                if (opt.beforeShowDay && typeof opt.beforeShowDay == 'function') {
                    var valid = true;
                    var timeTmp = time;
                    while (countDays(timeTmp, opt.start) > 1) {
                        var arr = opt.beforeShowDay(new Date(timeTmp));
                        if (!arr[0]) {
                            valid = false;
                            break;
                        }
                        if (Math.abs(timeTmp - opt.start) < 86400000) break;
                        if (timeTmp > opt.start) timeTmp -= 86400000;
                        if (timeTmp < opt.start) timeTmp += 86400000;
                    }
                    if (!valid) return false;
                }
            }
            return true;
        }


        function updateSelectableRange() {
            box.find('.day.invalid.tmp').removeClass('tmp invalid').addClass('valid');
            if (opt.start && !opt.end) {
                box.find('.day.toMonth.valid').each(function() {
                    var time = parseInt($(this).attr('time'), 10);
                    if (!isValidTime(time))
                        $(this).addClass('invalid tmp').removeClass('valid');
                    else
                        $(this).addClass('valid tmp').removeClass('invalid');
                });
            }

            return true;
        }


        function dayHovering(day) {
            var hoverTime = parseInt(day.attr('time'));
            var tooltip = '';

            if (day.hasClass('has-tooltip') && day.attr('data-tooltip')) {
                tooltip = '<span class="tooltip-content">' + day.attr('data-tooltip') + '</span>';
            } else if (!day.hasClass('invalid')) {
                if (opt.singleDate) {
                    box.find('.day.hovering').removeClass('hovering');
                    day.addClass('hovering');
                } else {
                    box.find('.day').each(function() {
                        var time = parseInt($(this).attr('time')),
                            start = opt.start,
                            end = opt.end;

                        if (time == hoverTime) {
                            $(this).addClass('hovering');
                        } else {
                            $(this).removeClass('hovering');
                        }

                        if (
                            (opt.start && !opt.end) &&
                            (
                                (opt.start < time && hoverTime >= time) ||
                                (opt.start > time && hoverTime <= time)
                            )
                        ) {
                            $(this).addClass('hovering');
                        } else {
                            $(this).removeClass('hovering');
                        }
                    });

                    if (opt.start && !opt.end) {
                        var days = countDays(hoverTime, opt.start);
                        if (opt.hoveringTooltip) {
                            if (typeof opt.hoveringTooltip == 'function') {
                                tooltip = opt.hoveringTooltip(days, opt.start, hoverTime);
                            } else if (opt.hoveringTooltip === true && days > 1) {
                                tooltip = days + ' ' + translate('days');
                            }
                        }
                    }
                }
            }

            if (tooltip) {
                var posDay = day.offset();
                var posBox = box.offset();

                var _left = posDay.left - posBox.left;
                var _top = posDay.top - posBox.top;
                _left += day.width() / 2;


                var $tip = box.find('.date-range-length-tip');
                var w = $tip.css({
                    'visibility': 'hidden',
                    'display': 'none'
                }).html(tooltip).width();
                var h = $tip.height();
                _left -= w / 2;
                _top -= h;
                setTimeout(function() {
                    $tip.css({
                        left: _left,
                        top: _top,
                        display: 'block',
                        'visibility': 'visible'
                    });
                }, 10);
            } else {
                box.find('.date-range-length-tip').hide();
            }
        }

        function clearHovering() {
            box.find('.day.hovering').removeClass('hovering');
            box.find('.date-range-length-tip').hide();
        }

        function dateChanged(date) {
            var value = date.val();
            var name = date.attr('name');
            var type = date.parents('table').hasClass('month1') ? 'month1' : 'month2';
            var oppositeType = type === 'month1' ? 'month2' : 'month1';
            var startDate = opt.startDate ? moment(opt.startDate) : false;
            var endDate = opt.endDate ? moment(opt.endDate) : false;
            var newDate = moment(opt[type])[name](value);


            if (startDate && newDate.isSameOrBefore(startDate)) {
                newDate = startDate.add(type === 'month2' ? 1 : 0, 'month');
            }

            if (endDate && newDate.isSameOrAfter(endDate)) {
                newDate = endDate.add(!opt.singleMonth && type === 'month1' ? -1 : 0, 'month');
            }

            showMonth(newDate, type);

            if (type === 'month1') {
                if (opt.stickyMonths || moment(newDate).isSameOrAfter(opt[oppositeType], 'month')) {
                    showMonth(moment(newDate).add(1, 'month'), oppositeType);
                }
            } else {
                if (opt.stickyMonths || moment(newDate).isSameOrBefore(opt[oppositeType], 'month')) {
                    showMonth(moment(newDate).add(-1, 'month'), oppositeType);
                }
            }

            showGap();
        }

        function autoclose() {
            if (opt.singleDate === true) {
                if (initiated && opt.start) {
                    if (opt.autoClose) closeDatePicker();
                }
            } else {
                if (initiated && opt.start && opt.end) {
                    if (opt.autoClose) closeDatePicker();
                }
            }
        }

        function checkSelectionValid() {
            var days = Math.ceil((opt.end - opt.start) / 86400000) + 1;
            if (opt.singleDate) { // Validate if only start is there
                if (opt.start && !opt.end)
                    box.find('.drp_top-bar').removeClass('error').addClass('normal');
                else
                    box.find('.drp_top-bar').removeClass('error').removeClass('normal');
            } else if (opt.maxDays && days > opt.maxDays) {
                opt.start = false;
                opt.end = false;
                box.find('.day').removeClass('checked');
                box.find('.drp_top-bar').removeClass('normal').addClass('error').find('.error-top').html(translate('less-than').replace('%d', opt.maxDays));
            } else if (opt.minDays && days < opt.minDays) {
                opt.start = false;
                opt.end = false;
                box.find('.day').removeClass('checked');
                box.find('.drp_top-bar').removeClass('normal').addClass('error').find('.error-top').html(translate('more-than').replace('%d', opt.minDays));
            } else {
                if (opt.start || opt.end)
                    box.find('.drp_top-bar').removeClass('error').addClass('normal');
                else
                    box.find('.drp_top-bar').removeClass('error').removeClass('normal');
            }

            if ((opt.singleDate && opt.start && !opt.end) || (!opt.singleDate && opt.start && opt.end)) {
                box.find('.apply-btn').removeClass('disabled');
            } else {
                box.find('.apply-btn').addClass('disabled');
            }

            if (opt.batchMode) {
                if (
                    (opt.start && opt.startDate && compare_day(opt.start, opt.startDate) < 0) ||
                    (opt.end && opt.endDate && compare_day(opt.end, opt.endDate) > 0)
                ) {
                    opt.start = false;
                    opt.end = false;
                    box.find('.day').removeClass('checked');
                }
            }
        }

        function showSelectedInfo(forceValid, silent) {
            box.find('.start-day').html('...');
            box.find('.end-day').html('...');
            box.find('.selected-days').hide();
            if (opt.start) {
                box.find('.start-day').html(getDateString(new Date(parseInt(opt.start))));
            }
            if (opt.end) {
                box.find('.end-day').html(getDateString(new Date(parseInt(opt.end))));
            }
            var dateRange;
            if (opt.start && opt.singleDate) {
                box.find('.apply-btn').removeClass('disabled');
                dateRange = getDateString(new Date(opt.start));
                opt.setValue.call(selfDom, dateRange, getDateString(new Date(opt.start)), getDateString(new Date(opt.end)));

                if (initiated && !silent) {
                    $(self).trigger('datepicker-change', {
                        'value': dateRange,
                        'date1': new Date(opt.start)
                    });
                }
            } else if (opt.start && opt.end) {
                box.find('.selected-days').show().find('.selected-days-num').html(countDays(opt.end, opt.start));
                box.find('.apply-btn').removeClass('disabled');
                dateRange = getDateString(new Date(opt.start)) + opt.separator + getDateString(new Date(opt.end));
                
                opt.setValue.call(selfDom, dateRange, getDateString(new Date(opt.start)), getDateString(new Date(opt.end)), Math.floor((new Date(opt.start)).getTime()/1000), Math.floor((new Date(opt.end)).getTime()/1000));
                if (initiated && !silent) {
                    $(self).trigger('datepicker-change', {
                        'value': dateRange,
                        'date1': new Date(opt.start),
                        'date2': new Date(opt.end)
                    });
                }
            } else if (forceValid) {
                box.find('.apply-btn').removeClass('disabled');
            } else {
                box.find('.apply-btn').addClass('disabled');
            }
        }

        function countDays(start, end) {
            return Math.abs(daysFrom1970(start) - daysFrom1970(end)) + 1;
        }

        function setDateRange(date1, date2, silent) {
            if (date1.getTime() > date2.getTime()) {
                var tmp = date2;
                date2 = date1;
                date1 = tmp;
                tmp = null;
            }
            var valid = true;
            if (opt.startDate && compare_day(date1, opt.startDate) < 0) valid = false;
            if (opt.endDate && compare_day(date2, opt.endDate) > 0) valid = false;
            if (!valid) {
                showMonth(opt.startDate, 'month1');
                showMonth(nextMonth(opt.startDate), 'month2');
                showGap();
                return;
            }

            opt.start = date1.getTime();
            opt.end = date2.getTime();

            if (opt.time.enabled) {
                renderTime('time1', date1);
                renderTime('time2', date2);
            }

            if (opt.stickyMonths || (compare_day(date1, date2) > 0 && compare_month(date1, date2) === 0)) {
                if (opt.lookBehind) {
                    date1 = prevMonth(date2);
                } else {
                    date2 = nextMonth(date1);
                }
            }

            if (opt.stickyMonths && opt.endDate !== false && compare_month(date2, opt.endDate) > 0) {
                date1 = prevMonth(date1);
                date2 = prevMonth(date2);
            }

            if (!opt.stickyMonths) {
                if (compare_month(date1, date2) === 0) {
                    if (opt.lookBehind) {
                        date1 = prevMonth(date2);
                    } else {
                        date2 = nextMonth(date1);
                    }
                }
            }

            showMonth(date1, 'month1');
            showMonth(date2, 'month2');
            showGap();
            checkSelectionValid();
            showSelectedInfo(false, silent);
            autoclose();
        }

        function setSingleDate(date1) {

            var valid = true;
            if (opt.startDate && compare_day(date1, opt.startDate) < 0) valid = false;
            if (opt.endDate && compare_day(date1, opt.endDate) > 0) valid = false;
            if (!valid) {
                showMonth(opt.startDate, 'month1');
                return;
            }

            opt.start = date1.getTime();


            if (opt.time.enabled) {
                renderTime('time1', date1);

            }
            showMonth(date1, 'month1');
            if (opt.singleMonth !== true) {
                var date2 = nextMonth(date1);
                showMonth(date2, 'month2');
            }
            showGap();
            showSelectedInfo();
            autoclose();
        }

        function showSelectedDays() {
            if (!opt.start && !opt.end) return;
            box.find('.day').each(function() {
                var time = parseInt($(this).attr('time')),
                    start = opt.start,
                    end = opt.end;
                if (opt.time.enabled) {
                    time = moment(time).startOf('day').valueOf();
                    start = moment(start || moment().valueOf()).startOf('day').valueOf();
                    end = moment(end || moment().valueOf()).startOf('day').valueOf();
                }
                if (
                    (opt.start && opt.end && end >= time && start <= time) ||
                    (opt.start && !opt.end && moment(start).format('YYYY-MM-DD') == moment(time).format('YYYY-MM-DD'))
                ) {
                    $(this).addClass('checked');
                } else {
                    $(this).removeClass('checked');
                }

                //add first-date-selected class name to the first date selected
                if (opt.start && moment(start).format('YYYY-MM-DD') == moment(time).format('YYYY-MM-DD')) {
                    $(this).addClass('first-date-selected');
                } else {
                    $(this).removeClass('first-date-selected');
                }
                //add last-date-selected
                if (opt.end && moment(end).format('YYYY-MM-DD') == moment(time).format('YYYY-MM-DD')) {
                    $(this).addClass('last-date-selected');
                } else {
                    $(this).removeClass('last-date-selected');
                }
            });

            box.find('.week-number').each(function() {
                if ($(this).attr('data-start-time') == opt.startWeek) {
                    $(this).addClass('week-number-selected');
                }
            });
        }

        function showMonth(date, month) {
            date = moment(date).toDate();
            var monthElement = generateMonthElement(date, month);
            var yearElement = generateYearElement(date, month);

            box.find('.' + month + ' .month-name').html(monthElement + ' ' + yearElement);
            box.find('.' + month + ' tbody').html(createMonthHTML(date));
            opt[month] = date;
            updateSelectableRange();
            bindEvents();
        }

        function generateMonthElement(date, month) {
            var range;
            var startDate = opt.startDate ? moment(opt.startDate).add(!opt.singleMonth && month === 'month2' ? 1 : 0, 'month') : false;
            var endDate = opt.endDate ? moment(opt.endDate).add(!opt.singleMonth && month === 'month1' ? -1 : 0, 'month') : false;
            date = moment(date);

            if (!opt.monthSelect ||
                startDate && endDate && startDate.isSame(endDate, 'month')) {
                return '<div class="month-element">' + nameMonth(date.get('month')) + '</div>';
            }

            range = [
                startDate && date.isSame(startDate, 'year') ? startDate.get('month') : 0,
                endDate && date.isSame(endDate, 'year') ? endDate.get('month') : 11
            ];

            if (range[0] === range[1]) {
                return '<div class="month-element">' + nameMonth(date.get('month')) + '</div>';
            }

            return generateSelect(
                'month',
                generateSelectData(
                    range,
                    date.get('month'),
                    function(value) { return nameMonth(value); }
                )
            );
        }

        function generateYearElement(date, month) {
            date = moment(date);
            var startDate = opt.startDate ? moment(opt.startDate).add(!opt.singleMonth && month === 'month2' ? 1 : 0, 'month') : false;
            var endDate = opt.endDate ? moment(opt.endDate).add(!opt.singleMonth && month === 'month1' ? -1 : 0, 'month') : false;
            var fullYear = date.get('year');
            var isYearFunction = opt.yearSelect && typeof opt.yearSelect === 'function';
            var range;

            if (!opt.yearSelect ||
                startDate && endDate && startDate.isSame(moment(endDate), 'year')) {
                return '<div class="month-element">' + fullYear + '</div>';
            }

            range = isYearFunction ? opt.yearSelect(fullYear) : opt.yearSelect.slice();

            range = [
                startDate ? Math.max(range[0], startDate.get('year')) : Math.min(range[0], fullYear),
                endDate ? Math.min(range[1], endDate.get('year')) : Math.max(range[1], fullYear)
            ];

            return generateSelect('year', generateSelectData(range, fullYear));
        }


        function generateSelectData(range, current, valueBeautifier) {
            var data = [];
            valueBeautifier = valueBeautifier || function(value) { return value; };

            for (var i = range[0]; i <= range[1]; i++) {
                data.push({
                    value: i,
                    text: valueBeautifier(i),
                    isCurrent: i === current
                });
            }

            return data;
        }

        function generateSelect(name, data) {
            var select = '<div class="select-wrapper"><select class="' + name + '" name="' + name + '">';
            var current;

            for (var i = 0, l = data.length; i < l; i++) {
                select += '<option value="' + data[i].value + '"' + (data[i].isCurrent ? ' selected' : '') + '>';
                select += data[i].text;
                select += '</option>';

                if (data[i].isCurrent) {
                    current = data[i].text;
                }
            }

            select += '</select>' + current + '</div>';

            return select;
        }

        function bindEvents() {
            box.find('.day').unbind("click").click(function(evt) {
                dayClicked($(this));
            });

            box.find('.day').unbind("mouseenter").mouseenter(function(evt) {
                dayHovering($(this));
            });

            box.find('.day').unbind("mouseleave").mouseleave(function(evt) {
                box.find('.date-range-length-tip').hide();
                if (opt.singleDate) {
                    clearHovering();
                }
            });

            box.find('.week-number').unbind("click").click(function(evt) {
                weekNumberClicked($(this));
            });

            box.find('.month').unbind("change").change(function(evt) {
                dateChanged($(this));
            });

            box.find('.year').unbind("change").change(function(evt) {
                dateChanged($(this));
            });
        }

        function showTime(date, name) {
            box.find('.' + name).append(getTimeHTML());
            renderTime(name, date);
        }

        function nameMonth(m) {
            return translate('month-name')[m];
        }

        function getDateString(d) {
            return moment(d).format(opt.format);
        }

        function showGap() {
            showSelectedDays();
            var m1 = parseInt(moment(opt.month1).format('YYYYMM'));
            var m2 = parseInt(moment(opt.month2).format('YYYYMM'));
            var p = Math.abs(m1 - m2);
            var shouldShow = (p > 1 && p != 89);
            if (shouldShow) {
                box.addClass('has-gap').removeClass('no-gap').find('.gap').css('visibility', 'visible');
            } else {
                box.removeClass('has-gap').addClass('no-gap').find('.gap').css('visibility', 'hidden');
            }
            var h1 = box.find('table.month1').height();
            var h2 = box.find('table.month2').height();
            box.find('.gap').height(Math.max(h1, h2) + 10);
        }

        function closeDatePicker() {
            if (opt.alwaysOpen) return;

            var afterAnim = function() {
                $(self).data('date-picker-opened', false);
                $(self).trigger('datepicker-closed', {
                    relatedTarget: box
                });
            };
            if (opt.customCloseAnimation) {
                opt.customCloseAnimation.call(box.get(0), afterAnim);
            } else {
                $(box).slideUp(opt.duration, afterAnim);
            }
            $(self).trigger('datepicker-close', {
                relatedTarget: box
            });
        }

        function redrawDatePicker() {
            showMonth(opt.month1, 'month1');
            showMonth(opt.month2, 'month2');
        }

        function compare_month(m1, m2) {
            var p = parseInt(moment(m1).format('YYYYMM')) - parseInt(moment(m2).format('YYYYMM'));
            if (p > 0) return 1;
            if (p === 0) return 0;
            return -1;
        }

        function compare_day(m1, m2) {
            var p = parseInt(moment(m1).format('YYYYMMDD')) - parseInt(moment(m2).format('YYYYMMDD'));
            if (p > 0) return 1;
            if (p === 0) return 0;
            return -1;
        }

        function nextMonth(month) {
            return moment(month).add(1, 'months').toDate();
        }

        function prevMonth(month) {
            return moment(month).add(-1, 'months').toDate();
        }

        function getTimeHTML() {
            return '<div>' +
                '<span>' + translate('Time') + ': <span class="hour-val">00</span>:<span class="minute-val">00</span></span>' +
                '</div>' +
                '<div class="hour">' +
                '<label>' + translate('Hour') + ': <input type="range" class="hour-range" name="hour" min="0" max="23"></label>' +
                '</div>' +
                '<div class="minute">' +
                '<label>' + translate('Minute') + ': <input type="range" class="minute-range" name="minute" min="0" max="59"></label>' +
                '</div>';
        }

        function createDom() {
            var html = '<div class="date-picker-wrapper';
            if (opt.extraClass) html += ' ' + opt.extraClass + ' ';
            if (opt.singleDate) html += ' single-date ';
            if (!opt.showShortcuts) html += ' no-shortcuts ';
            if (!opt.showTopbar) html += ' no-topbar ';
            if (opt.customTopBar) html += ' custom-topbar ';
            html += '">';

            if (opt.showTopbar) {
                html += '<div class="drp_top-bar">';

                if (opt.customTopBar) {
                    if (typeof opt.customTopBar == 'function') opt.customTopBar = opt.customTopBar();
                    html += '<div class="custom-top">' + opt.customTopBar + '</div>';
                } else {
                    html += '<div class="normal-top">' +
                        '<span class="selection-top">' + translate('selected') + ' </span> <b class="start-day">...</b>';
                    if (!opt.singleDate) {
                        html += ' <span class="separator-day">' + opt.separator + '</span> <b class="end-day">...</b> <i class="selected-days">(<span class="selected-days-num">3</span> ' + translate('days') + ')</i>';
                    }
                    html += '</div>';
                    html += '<div class="error-top">error</div>' +
                        '<div class="default-top">default</div>';
                }

                html += '<input type="button" class="apply-btn disabled' + getApplyBtnClass() + '" value="' + translate('apply') + '" />';
                html += '</div>';
            }

            var _colspan = opt.showWeekNumbers ? 6 : 5;

            var arrowPrev = '&lt;';
            if (opt.customArrowPrevSymbol) arrowPrev = opt.customArrowPrevSymbol;

            var arrowNext = '&gt;';
            if (opt.customArrowNextSymbol) arrowNext = opt.customArrowNextSymbol;

            html += '<div class="month-wrapper">' +
                '   <table class="month1" cellspacing="0" border="0" cellpadding="0">' +
                '       <thead>' +
                '           <tr class="caption">' +
                '               <th>' +
                '                   <span class="prev">' +
                arrowPrev +
                '                   </span>' +
                '               </th>' +
                '               <th colspan="' + _colspan + '" class="month-name">' +
                '               </th>' +
                '               <th>' +
                (opt.singleDate || !opt.stickyMonths ? '<span class="next">' + arrowNext + '</span>' : '') +
                '               </th>' +
                '           </tr>' +
                '           <tr class="week-name">' + getWeekHead() +
                '       </thead>' +
                '       <tbody></tbody>' +
                '   </table>';

            if (hasMonth2()) {
                html += '<div class="gap">' + getGapHTML() + '</div>' +
                    '<table class="month2" cellspacing="0" border="0" cellpadding="0">' +
                    '   <thead>' +
                    '   <tr class="caption">' +
                    '       <th>' +
                    (!opt.stickyMonths ? '<span class="prev">' + arrowPrev + '</span>' : '') +
                    '       </th>' +
                    '       <th colspan="' + _colspan + '" class="month-name">' +
                    '       </th>' +
                    '       <th>' +
                    '           <span class="next">' + arrowNext + '</span>' +
                    '       </th>' +
                    '   </tr>' +
                    '   <tr class="week-name">' + getWeekHead() +
                    '   </thead>' +
                    '   <tbody></tbody>' +
                    '</table>';

            }
            //+'</div>'
            html += '<div class="dp-clearfix"></div>' +
                '<div class="time">' +
                '<div class="time1"></div>';
            if (!opt.singleDate) {
                html += '<div class="time2"></div>';
            }
            html += '</div>' +
                '<div class="dp-clearfix"></div>' +
                '</div>';

            html += '<div class="footer">';
            if (opt.showShortcuts) {
                html += '<div class="shortcuts"><b>' + translate('shortcuts') + '</b>';

                var data = opt.shortcuts;
                if (data) {
                    var name;
                    if (data['prev-days'] && data['prev-days'].length > 0) {
                        html += '&nbsp;<span class="prev-days">' + translate('past');
                        for (var i = 0; i < data['prev-days'].length; i++) {
                            name = data['prev-days'][i];
                            name += (data['prev-days'][i] > 1) ? translate('days') : translate('day');
                            html += ' <a href="javascript:;" shortcut="day,-' + data['prev-days'][i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }

                    if (data['next-days'] && data['next-days'].length > 0) {
                        html += '&nbsp;<span class="next-days">' + translate('following');
                        for (var i = 0; i < data['next-days'].length; i++) {
                            name = data['next-days'][i];
                            name += (data['next-days'][i] > 1) ? translate('days') : translate('day');
                            html += ' <a href="javascript:;" shortcut="day,' + data['next-days'][i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }

                    if (data.prev && data.prev.length > 0) {
                        html += '&nbsp;<span class="prev-buttons">' + translate('previous');
                        for (var i = 0; i < data.prev.length; i++) {
                            name = translate('prev-' + data.prev[i]);
                            html += ' <a href="javascript:;" shortcut="prev,' + data.prev[i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }

                    if (data.next && data.next.length > 0) {
                        html += '&nbsp;<span class="next-buttons">' + translate('next');
                        for (var i = 0; i < data.next.length; i++) {
                            name = translate('next-' + data.next[i]);
                            html += ' <a href="javascript:;" shortcut="next,' + data.next[i] + '">' + name + '</a>';
                        }
                        html += '</span>';
                    }
                }

                if (opt.customShortcuts) {
                    for (var i = 0; i < opt.customShortcuts.length; i++) {
                        var sh = opt.customShortcuts[i];
                        html += '&nbsp;<span class="custom-shortcut"><a href="javascript:;" shortcut="custom">' + sh.name + '</a></span>';
                    }
                }
                html += '</div>';
            }

            // Add Custom Values Dom
            if (opt.showCustomValues) {
                html += '<div class="customValues"><b>' + (opt.customValueLabel || translate('custom-values')) + '</b>';

                if (opt.customValues) {
                    for (var i = 0; i < opt.customValues.length; i++) {
                        var val = opt.customValues[i];
                        html += '&nbsp;<span class="custom-value"><a href="javascript:;" custom="' + val.value + '">' + val.name + '</a></span>';
                    }
                }
            }

            html += '</div></div>';


            return $(html);
        }

        function getApplyBtnClass() {
            var klass = '';
            if (opt.autoClose === true) {
                klass += ' hide';
            }
            if (opt.applyBtnClass !== '') {
                klass += ' ' + opt.applyBtnClass;
            }
            return klass;
        }

        function getWeekHead() {
            var prepend = opt.showWeekNumbers ? '<th>' + translate('week-number') + '</th>' : '';
            if (opt.startOfWeek == 'monday') {
                return prepend + '<th>' + translate('week-1') + '</th>' +
                    '<th>' + translate('week-2') + '</th>' +
                    '<th>' + translate('week-3') + '</th>' +
                    '<th>' + translate('week-4') + '</th>' +
                    '<th>' + translate('week-5') + '</th>' +
                    '<th>' + translate('week-6') + '</th>' +
                    '<th>' + translate('week-7') + '</th>';
            } else {
                return prepend + '<th>' + translate('week-7') + '</th>' +
                    '<th>' + translate('week-1') + '</th>' +
                    '<th>' + translate('week-2') + '</th>' +
                    '<th>' + translate('week-3') + '</th>' +
                    '<th>' + translate('week-4') + '</th>' +
                    '<th>' + translate('week-5') + '</th>' +
                    '<th>' + translate('week-6') + '</th>';
            }
        }

        function isMonthOutOfBounds(month) {
            month = moment(month);
            if (opt.startDate && month.endOf('month').isBefore(opt.startDate)) {
                return true;
            }
            if (opt.endDate && month.startOf('month').isAfter(opt.endDate)) {
                return true;
            }
            return false;
        }

        function getGapHTML() {
            var html = ['<div class="gap-top-mask"></div><div class="gap-bottom-mask"></div><div class="gap-lines">'];
            for (var i = 0; i < 20; i++) {
                html.push('<div class="gap-line">' +
                    '<div class="gap-1"></div>' +
                    '<div class="gap-2"></div>' +
                    '<div class="gap-3"></div>' +
                    '</div>');
            }
            html.push('</div>');
            return html.join('');
        }

        function hasMonth2() {
            return (!opt.singleMonth);
        }

        function attributesCallbacks(initialObject, callbacksArray, today) {
            var resultObject = $.extend(true, {}, initialObject);

            $.each(callbacksArray, function(cbAttrIndex, cbAttr) {
                var addAttributes = cbAttr(today);
                for (var attr in addAttributes) {
                    if (resultObject.hasOwnProperty(attr)) {
                        resultObject[attr] += addAttributes[attr];
                    } else {
                        resultObject[attr] = addAttributes[attr];
                    }
                }
            });

            var attrString = '';

            for (var attr in resultObject) {
                if (resultObject.hasOwnProperty(attr)) {
                    attrString += attr + '="' + resultObject[attr] + '" ';
                }
            }

            return attrString;
        }

        function daysFrom1970(t) {
            return Math.floor(toLocalTimestamp(t) / 86400000);
        }

        function toLocalTimestamp(t) {
            if (moment.isMoment(t)) t = t.toDate().getTime();
            if (typeof t == 'object' && t.getTime) t = t.getTime();
            if (typeof t == 'string' && !t.match(/\d{13}/)) t = moment(t, opt.format).toDate().getTime();
            t = parseInt(t, 10) - new Date().getTimezoneOffset() * 60 * 1000;
            return t;
        }

        function createMonthHTML(d) {
            var days = [];
            d.setDate(1);
            var lastMonth = new Date(d.getTime() - 86400000);
            var now = new Date();

            var dayOfWeek = d.getDay();
            if ((dayOfWeek === 0) && (opt.startOfWeek === 'monday')) {
                // add one week
                dayOfWeek = 7;
            }
            var today, valid;

            if (dayOfWeek > 0) {
                for (var i = dayOfWeek; i > 0; i--) {
                    var day = new Date(d.getTime() - 86400000 * i);
                    valid = isValidTime(day.getTime());
                    if (opt.startDate && compare_day(day, opt.startDate) < 0) valid = false;
                    if (opt.endDate && compare_day(day, opt.endDate) > 0) valid = false;
                    days.push({
                        date: day,
                        type: 'lastMonth',
                        day: day.getDate(),
                        time: day.getTime(),
                        valid: valid
                    });
                }
            }
            var toMonth = d.getMonth();
            for (var i = 0; i < 40; i++) {
                today = moment(d).add(i, 'days').toDate();
                valid = isValidTime(today.getTime());
                if (opt.startDate && compare_day(today, opt.startDate) < 0) valid = false;
                if (opt.endDate && compare_day(today, opt.endDate) > 0) valid = false;
                days.push({
                    date: today,
                    type: today.getMonth() == toMonth ? 'toMonth' : 'nextMonth',
                    day: today.getDate(),
                    time: today.getTime(),
                    valid: valid
                });
            }
            var html = [];
            for (var week = 0; week < 6; week++) {
                if (days[week * 7].type == 'nextMonth') break;
                html.push('<tr>');

                for (var day = 0; day < 7; day++) {
                    var _day = (opt.startOfWeek == 'monday') ? day + 1 : day;
                    today = days[week * 7 + _day];
                    var highlightToday = moment(today.time).format('L') == moment(now).format('L');
                    today.extraClass = '';
                    today.tooltip = '';
                    if (today.valid && opt.beforeShowDay && typeof opt.beforeShowDay == 'function') {
                        var _r = opt.beforeShowDay(moment(today.time).toDate());
                        today.valid = _r[0];
                        today.extraClass = _r[1] || '';
                        today.tooltip = _r[2] || '';
                        if (today.tooltip !== '') today.extraClass += ' has-tooltip ';
                    }

                    var todayDivAttr = {
                        time: today.time,
                        'data-tooltip': today.tooltip,
                        'class': 'day ' + today.type + ' ' + today.extraClass + ' ' + (today.valid ? 'valid' : 'invalid') + ' ' + (highlightToday ? 'real-today' : '')
                    };

                    if (day === 0 && opt.showWeekNumbers) {
                        html.push('<td><div class="week-number" data-start-time="' + today.time + '">' + opt.getWeekNumber(today.date) + '</div></td>');
                    }

                    html.push('<td ' + attributesCallbacks({}, opt.dayTdAttrs, today) + '><div ' + attributesCallbacks(todayDivAttr, opt.dayDivAttrs, today) + '>' + showDayHTML(today.time, today.day) + '</div></td>');
                }
                html.push('</tr>');
            }
            return html.join('');
        }

        function showDayHTML(time, date) {
            if (opt.showDateFilter && typeof opt.showDateFilter == 'function') return opt.showDateFilter(time, date);
            return date;
        }

        function getLanguages() {
            if (opt.language == 'auto') {
                var language = navigator.language ? navigator.language : navigator.browserLanguage;
                if (!language) {
                    return $.dateRangePickerLanguages['default'];
                }
                language = language.toLowerCase();
                if(language in $.dateRangePickerLanguages){
                    return $.dateRangePickerLanguages[language];
                }

                return $.dateRangePickerLanguages['default'];
            } else if (opt.language && opt.language in $.dateRangePickerLanguages) {
                return $.dateRangePickerLanguages[opt.language];
            } else {
                return $.dateRangePickerLanguages['default'];
            }
        }

        /**
         * Translate language string, try both the provided translation key, as the lower case version
         */
        function translate(translationKey) {
            var translationKeyLowerCase = translationKey.toLowerCase();
            var result = (translationKey in languages) ? languages[translationKey] : (translationKeyLowerCase in languages) ? languages[translationKeyLowerCase] : null;
            var defaultLanguage = $.dateRangePickerLanguages['default'];
            if (result == null) result = (translationKey in defaultLanguage) ? defaultLanguage[translationKey] : (translationKeyLowerCase in defaultLanguage) ? defaultLanguage[translationKeyLowerCase] : '';

            return result;
        }

        function getDefaultTime() {
            var defaultTime = opt.defaultTime ? opt.defaultTime : new Date();

            if (opt.lookBehind) {
                if (opt.startDate && compare_month(defaultTime, opt.startDate) < 0) defaultTime = nextMonth(moment(opt.startDate).toDate());
                if (opt.endDate && compare_month(defaultTime, opt.endDate) > 0) defaultTime = moment(opt.endDate).toDate();
            } else {
                if (opt.startDate && compare_month(defaultTime, opt.startDate) < 0) defaultTime = moment(opt.startDate).toDate();
                if (opt.endDate && compare_month(nextMonth(defaultTime), opt.endDate) > 0) defaultTime = prevMonth(moment(opt.endDate).toDate());
            }

            if (opt.singleDate) {
                if (opt.startDate && compare_month(defaultTime, opt.startDate) < 0) defaultTime = moment(opt.startDate).toDate();
                if (opt.endDate && compare_month(defaultTime, opt.endDate) > 0) defaultTime = moment(opt.endDate).toDate();
            }

            return defaultTime;
        }

        function resetMonthsView(time) {
            if (!time) {
                time = getDefaultTime();
            }

            if (opt.lookBehind) {
                showMonth(prevMonth(time), 'month1');
                showMonth(time, 'month2');
            } else {
                showMonth(time, 'month1');
                showMonth(nextMonth(time), 'month2');
            }

            if (opt.singleDate) {
                showMonth(time, 'month1');
            }

            showSelectedDays();
            showGap();
        }

    };
}));/*
 Highcharts JS v7.2.1 (2019-10-31)

 (c) 2016-2019 Highsoft AS
 Authors: Jon Arild Nygard

 License: www.highcharts.com/license
*/
(function(a){"object"===typeof module&&module.exports?(a["default"]=a,module.exports=a):"function"===typeof define&&define.amd?define("highcharts/modules/wordcloud",["highcharts"],function(k){a(k);a.Highcharts=k;return a}):a("undefined"!==typeof Highcharts?Highcharts:void 0)})(function(a){function k(a,e,z,l){a.hasOwnProperty(e)||(a[e]=l.apply(null,z))}a=a?a._modules:{};k(a,"mixins/draw-point.js",[],function(){var a=function(e){var a=this,l=a.graphic,q=e.animatableAttribs,r=e.onComplete,k=e.css,x=
e.renderer;if(a.shouldDraw())l||(a.graphic=l=x[e.shapeType](e.shapeArgs).add(e.group)),l.css(k).attr(e.attribs).animate(q,e.isNew?!1:void 0,r);else if(l){var t=function(){a.graphic=l=l.destroy();"function"===typeof r&&r()};Object.keys(q).length?l.animate(q,void 0,function(){t()}):t()}};return function(e){(e.attribs=e.attribs||{})["class"]=this.getClassName();a.call(this,e)}});k(a,"mixins/polygon.js",[a["parts/Globals.js"],a["parts/Utilities.js"]],function(a,e){var q=e.isArray,l=e.isNumber,k=a.deg2rad,
r=a.find,C=function(b,c){c=l(c)?c:14;c=Math.pow(10,c);return Math.round(b*c)/c},x=function(b,c){var h=c[0]-b[0];b=c[1]-b[1];return[[-b,h],[b,-h]]},t=function(b,c){b=b.map(function(b){return b[0]*c[0]+b[1]*c[1]});return{min:Math.min.apply(this,b),max:Math.max.apply(this,b)}},D=function(b,c){var h=b[0];b=b[1];var a=k*-c;c=Math.cos(a);a=Math.sin(a);return[C(h*c-b*a),C(h*a+b*c)]},y=function(b,c,a){b=D([b[0]-c[0],b[1]-c[1]],a);return[b[0]+c[0],b[1]+c[1]]},A=function(b){var c=b.axes;if(!q(c)){c=[];var a=
a=b.concat([b[0]]);a.reduce(function(b,a){var h=x(b,a)[0];r(c,function(b){return b[0]===h[0]&&b[1]===h[1]})||c.push(h);return a});b.axes=c}return c},E=function(b,c){b=A(b);c=A(c);return b.concat(c)};return{getBoundingBoxFromPolygon:function(b){return b.reduce(function(b,a){var c=a[0];a=a[1];b.left=Math.min(c,b.left);b.right=Math.max(c,b.right);b.bottom=Math.max(a,b.bottom);b.top=Math.min(a,b.top);return b},{left:Number.MAX_VALUE,right:-Number.MAX_VALUE,bottom:-Number.MAX_VALUE,top:Number.MAX_VALUE})},
getPolygon:function(b,a,h,e,l){var c=[b,a],w=b-h/2;b+=h/2;h=a-e/2;a+=e/2;return[[w,h],[b,h],[b,a],[w,a]].map(function(b){return y(b,c,-l)})},isPolygonsColliding:function(b,a){var c=E(b,a);return!r(c,function(c){var e=t(b,c);c=t(a,c);return!!(c.min>e.max||c.max<e.min)})},movePolygon:function(b,a,e){return e.map(function(c){return[c[0]+b,c[1]+a]})},rotate2DToOrigin:D,rotate2DToPoint:y}});k(a,"modules/wordcloud.src.js",[a["parts/Globals.js"],a["parts/Utilities.js"],a["mixins/draw-point.js"],a["mixins/polygon.js"]],
function(a,e,k,l){function q(g,d){var f=!1,b=g.rect,a=g.polygon,c=g.lastCollidedWith,e=function(d){var f=d.rect;(f=!(f.left>b.right||f.right<b.left||f.top>b.bottom||f.bottom<b.top))&&(g.rotation%90||d.rotation%90)&&(f=F(a,d.polygon));return f};c&&((f=e(c))||delete g.lastCollidedWith);f||(f=!!I(d,function(d){var f=e(d);f&&(g.lastCollidedWith=d);return f}));return f}function r(g,d){d=4*g;var f=Math.ceil((Math.sqrt(d)-1)/2),b=2*f+1,a=Math.pow(b,2),c=!1;--b;1E4>=g&&("boolean"===typeof c&&d>=a-b&&(c={x:f-
(a-d),y:-f}),a-=b,"boolean"===typeof c&&d>=a-b&&(c={x:-f,y:-f+(a-d)}),a-=b,"boolean"===typeof c&&(c=d>=a-b?{x:-f+(a-d),y:f}:{x:f,y:f-(a-d-b)}),c.x*=5,c.y*=5);return c}function C(g,d,f){var b=2*Math.max(Math.abs(f.top),Math.abs(f.bottom));f=2*Math.max(Math.abs(f.left),Math.abs(f.right));return Math.min(0<f?1/f*g:1,0<b?1/b*d:1)}function x(g,d,b){b=b.reduce(function(b,g){g=g.dimensions;var d=Math.max(g.width,g.height);b.maxHeight=Math.max(b.maxHeight,g.height);b.maxWidth=Math.max(b.maxWidth,g.width);
b.area+=d*d;return b},{maxHeight:0,maxWidth:0,area:0});b=Math.max(b.maxHeight,b.maxWidth,.85*Math.sqrt(b.area));var a=g>d?g/d:1;g=d>g?d/g:1;return{width:b*a,height:b*g,ratioX:a,ratioY:g}}function t(b,d,a,c){var g=!1;h(b)&&h(d)&&h(a)&&h(c)&&0<b&&-1<d&&c>a&&(g=a+d%b*((c-a)/(b-1||1)));return g}function D(b,d){var g,a=[];for(g=1;1E4>g;g++)a.push(b(g,d));return function(b){return 1E4>=b?a[b-1]:!1}}function y(b,d){var g=d.width/2,a=-(d.height/2),c=d.height/2;return!(-(d.width/2)<b.left&&g>b.right&&a<b.top&&
c>b.bottom)}function A(g,d){var a=d.placed,c=d.field,e=d.rectangle,h=d.polygon,l=d.spiral,k=1,p={x:0,y:0},n=g.rect=b({},e);g.polygon=h;for(g.rotation=d.rotation;!1!==p&&(q(g,a)||y(n,c));)p=l(k),w(p)&&(n.left=e.left+p.x,n.right=e.right+p.x,n.top=e.top+p.y,n.bottom=e.bottom+p.y,g.polygon=L(p.x,p.y,h)),k++;return p}function E(b,a){if(w(b)&&w(a)){var g=a.bottom-a.top;var d=a.right-a.left;a=b.ratioX;var c=b.ratioY;g=d*a>g*c?d:g;b=z(b,{width:b.width+g*a*2,height:b.height+g*c*2})}return b}var b=e.extend,
c=e.isArray,h=e.isNumber,w=e.isObject,z=a.merge;e=a.noop;var I=a.find,J=l.getBoundingBoxFromPolygon,K=l.getPolygon,F=l.isPolygonsColliding,L=l.movePolygon,B=a.Series;a.seriesType("wordcloud","column",{allowExtendPlayingField:!0,animation:{duration:500},borderWidth:0,clip:!1,colorByPoint:!0,minFontSize:1,maxFontSize:25,placementStrategy:"center",rotation:{from:0,orientations:2,to:90},showInLegend:!1,spiral:"rectangular",style:{fontFamily:"sans-serif",fontWeight:"900",whiteSpace:"nowrap"},tooltip:{followPointer:!0,
pointFormat:'<span style="color:{point.color}">\u25cf</span> {series.name}: <b>{point.weight}</b><br/>'}},{animate:B.prototype.animate,animateDrilldown:e,animateDrillupFrom:e,setClip:e,bindAxes:function(){var a={endOnTick:!1,gridLineWidth:0,lineWidth:0,maxPadding:0,startOnTick:!1,title:null,tickPositions:[]};B.prototype.bindAxes.call(this);b(this.yAxis.options,a);b(this.xAxis.options,a)},pointAttribs:function(b,d){b=a.seriesTypes.column.prototype.pointAttribs.call(this,b,d);delete b.stroke;delete b["stroke-width"];
return b},deriveFontSize:function(b,a,c){b=h(b)?b:0;a=h(a)?a:1;c=h(c)?c:1;return Math.floor(Math.max(c,b*a))},drawPoints:function(){var a=this,d=a.hasRendered,c=a.xAxis,e=a.yAxis,l=a.group,k=a.options,r=k.animation,t=k.allowExtendPlayingField,p=a.chart.renderer,n=p.text().add(l),q=[],y=a.placementStrategy[k.placementStrategy],z=k.rotation,F=a.points.map(function(b){return b.weight}),B=Math.max.apply(null,F),G=a.points.sort(function(b,a){return a.weight-b.weight});G.forEach(function(c){var d=a.deriveFontSize(1/
B*c.weight,k.maxFontSize,k.minFontSize);d=b({fontSize:d+"px"},k.style);n.css(d).attr({x:0,y:0,text:c.name});d=n.getBBox(!0);c.dimensions={height:d.height,width:d.width}});var u=x(c.len,e.len,G);var H=D(a.spirals[k.spiral],{field:u});G.forEach(function(c){var g=a.deriveFontSize(1/B*c.weight,k.maxFontSize,k.minFontSize);g=b({fontSize:g+"px"},k.style);var f=y(c,{data:G,field:u,placed:q,rotation:z}),e=b(a.pointAttribs(c,c.selected&&"select"),{align:"center","alignment-baseline":"middle",x:f.x,y:f.y,text:c.name,
rotation:f.rotation}),n=K(f.x,f.y,c.dimensions.width,c.dimensions.height,f.rotation),m=J(n),v=A(c,{rectangle:m,polygon:n,field:u,placed:q,spiral:H,rotation:f.rotation});!v&&t&&(u=E(u,m),v=A(c,{rectangle:m,polygon:n,field:u,placed:q,spiral:H,rotation:f.rotation}));if(w(v)){e.x+=v.x;e.y+=v.y;m.left+=v.x;m.right+=v.x;m.top+=v.y;m.bottom+=v.y;f=u;if(!h(f.left)||f.left>m.left)f.left=m.left;if(!h(f.right)||f.right<m.right)f.right=m.right;if(!h(f.top)||f.top>m.top)f.top=m.top;if(!h(f.bottom)||f.bottom<m.bottom)f.bottom=
m.bottom;u=f;q.push(c);c.isNull=!1}else c.isNull=!0;if(r){var x={x:e.x,y:e.y};d?(delete e.x,delete e.y):(e.x=0,e.y=0)}c.draw({animatableAttribs:x,attribs:e,css:g,group:l,renderer:p,shapeArgs:void 0,shapeType:"text"})});n=n.destroy();c=C(c.len,e.len,u);a.group.attr({scaleX:c,scaleY:c})},hasData:function(){return w(this)&&!0===this.visible&&c(this.points)&&0<this.points.length},placementStrategy:{random:function(b,a){var c=a.field;a=a.rotation;return{x:Math.round(c.width*(Math.random()+.5)/2)-c.width/
2,y:Math.round(c.height*(Math.random()+.5)/2)-c.height/2,rotation:t(a.orientations,b.index,a.from,a.to)}},center:function(b,a){a=a.rotation;return{x:0,y:0,rotation:t(a.orientations,b.index,a.from,a.to)}}},pointArrayMap:["weight"],spirals:{archimedean:function(b,a){var c=a.field;a=!1;c=c.width*c.width+c.height*c.height;var d=.8*b;1E4>=b&&(a={x:d*Math.cos(d),y:d*Math.sin(d)},Math.min(Math.abs(a.x),Math.abs(a.y))<c||(a=!1));return a},rectangular:function(a,b){a=r(a,b);b=b.field;a&&(a.x*=b.ratioX,a.y*=
b.ratioY);return a},square:r},utils:{extendPlayingField:E,getRotation:t,isPolygonsColliding:F,rotate2DToOrigin:l.rotate2DToOrigin,rotate2DToPoint:l.rotate2DToPoint},getPlotBox:function(){var a=this.chart,b=a.inverted,c=this[b?"yAxis":"xAxis"];b=this[b?"xAxis":"yAxis"];return{translateX:(c?c.left:a.plotLeft)+(c?c.len:a.plotWidth)/2,translateY:(b?b.top:a.plotTop)+(b?b.len:a.plotHeight)/2,scaleX:1,scaleY:1}}},{draw:k,shouldDraw:function(){return!this.isNull},isValid:function(){return!0},weight:1})});
k(a,"masters/modules/wordcloud.src.js",[],function(){})});function setRef(ref, url){
};

var urlc_clicks=0;
var urlc_timer=null;

function urlClick_reset(){
	urlc_clicks=0;
	urlc_timer=null;
}

function urlClick(ref){
	var $this=$(ref);
	if (typeof window.analytics != 'undefined' && window.analytics.initialize) {
		url_track($this);
	}
	
	var username='';
	if ($this.data('username')){
		username=$this.data('username');
	}else if ($this.hasClass('username')){
		username=$this.text();
	}

	if (AP.data.isInt(username)){
		return UI.user.menu(ref, username);
	}
	
	if (username && username.length){
		if (username.charAt(0)=='@'){
			username=username.substr(1);
		}
		
		if ($this.data("intent")=="chat"){
			return Base.message.peer(username);
		}
		return usernameClick(username, ref);
	}

	if ($this.data('redirect')){
		var $s=$this.data('redirect');
		AP.redirect($s);
		return;
	}
	
	if ($this.data("urlparam")){
		var p=$this.data("urlparam");
		var v=$this.data("value");
		
		var px={};
		
		if (v && v!=""){
			px[p]=v;
		}else{
			px[p]=null;
		}
		
		AP.setURLParams(px, true);
	}

	
	if ($this.data('updateurl')){
		var params=$this.data('updateurl');
		AP.updateURLParams(params);
		return;
	}
	
	var url=null;
	
	if ($this.data('xurl')){
		var url=$this.data('xurl');
		if (Client.pageData.context){
			url=Client.pageData.context.path+"/"+url;
		}
	}else{
		var url=$this.data('url');
		if (url==':self'){
			return __selfcall(ref);
		}
	}
	
	if (url==":refresh"){
		AP.refresh();
		return;
	}
	
	if (url==":xrefresh" || url==':current'){
		AP.xRefresh();
		return;
	}
	
	if (AP.word.prefix(url, ":fn:")){
		var fn=url.substr(4);
		var fnx=getFunctionByName(fn);
		fnx(ref);
		return;
	}
	
	if (url==":comment"){
		var id=$(ref).data("id");
		var resolver_name=$(ref).data("resolver");
		var obj;
		
		if (resolver_name == "Comment"){
			var resolver=getFunctionByName(resolver_name);
			obj={hid: $(ref).data("hid"), token: $(ref).data("token")};
		}else{
			var resolver=getFunctionByName(resolver_name);
			obj=resolver.fromContext(id);	
		}
		
		if (!obj){
			return;
		}
		
		var $box=$($(ref).data("box"));
		
		if (!$box.length || !resolver || !id){
			return;
		}
		
		$box.toggle();
		
		if ($box.hasClass("__inited")){
			return;
		}
		
		$box.addClass("__inited").show();
		var ph=$(ref).data("placeholder");
		
		Comment.auto($box, obj, {focus: true, counter: ".js-ccount-"+obj.hid, placeholder: ph||'BĂ¬nh luáº­n vĂ  nháº¥n Enter Ä‘á»ƒ gá»­i'});
		$box.find("textarea").focus();
		return;
	}
	
	if (url==':submit'){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully ...");
			
			if ($this.data("callback")){
				var cb=$this.data("callback");
				var fn=getFunctionByName(cb);
				fn(code, $this);
			}else{
				AP.xRefresh();	
			}
		});
		
		return;
	}
	
	if (url==':submit-refresh'){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully ...");
			AP.refresh();
		});
		
		return;
	}
	
	if (url==":active"){
		$this.toggleClass("active");
		return;
	}
	
	if (url==":active:unique"){
		$this.siblings().removeClass("active");
		$this.toggleClass("active");
		return;
	}
	
	if (url==":zoom"){
		UI.previewImage($(ref).data("image"));
		return;
	}
	
	if (url==":active:parent" || url==":parent-active" || url==':parent:active'){
		var ac= $(ref).data("active-class") || 'active';
		$this.parent().toggleClass("active");
		return;
	}
	
	
	if (url==':parent:parent:active' || url==':active:parent:parent'){
		var ac= $(ref).data("active-class") || 'active';
		$this.parent().parent().toggleClass(ac);
		return;
	}
	
	if (url==':parent:parent:parent:active' || url==':active:parent:parent:parent'){
		var ac= $(ref).data("active-class") || 'active';
		$this.parent().parent().parent().toggleClass("active");
		return;
	}
	
	if (url && url.match(/^:active\/([0-9]+)/)){
		var ckey = $(ref).data("ckey") || $(ref).data("cache-key") || $(ref).data("cache");
		
		var parts = url.split("/");
		var depth = parseInt(parts[1]);
		var $p=$this;
		
		for (var i=0; i<depth; i++){
			$p=$p.parent();
		}
		
		$p.toggleClass("-active");
		if (ckey){
			if ($p.hasClass("-active")){
				Base.pref().set(ckey, 1);
			}else{
				Base.pref().set(ckey, 0);
			}
		}
		return;
	}
	
	
	if (url && url.match(/^:inactive\/([0-9]+)/)){
		var parts = url.split("/");
		var depth = parseInt(parts[1]);
		var $p=$this;
		
		for (var i=0; i<depth; i++){
			$p=$p.parent();
		}
		
		$p.removeClass("active");
		return;
	}
	
	
	if (url==":ext:parent"){
		$this.parent().toggleClass("-ext");
		return;
	}
	
	if (url==":ext:parent:parent"){
		$this.parent().parent().toggleClass("-ext");
		return;
	}
	
	if (url==":ext:parent:parent:parent"){
		$this.parent().parent().parent().toggleClass("-ext");
		return;
	}
	
	if (url==":collapse"){
		$this.toggleClass("-collapsed");
		return;
	}
	
	if (url==":collapse:parent"){
		$this.parent().toggleClass("-collapsed");
		return;
	}
	
	if (url==":collapse:parent:parent"){
		$this.parent().parent().toggleClass("-collapsed");
		return;
	}
	
	if (url && url.match(/^:collapse\/([0-9]+)/)){
		var ckey = $(ref).data("ckey") || $(ref).data("cache-key") || $(ref).data("cache");
		
		var parts = url.split("/");
		var depth = parseInt(parts[1]);
		var $p=$this;
		
		for (var i=0; i<depth; i++){
			$p=$p.parent();
		}
		
		$p.toggleClass("-collapsed");
		if (ckey){
			if ($p.hasClass("-collapsed")){
				Base.pref().set(ckey, 1);
			}else{
				Base.pref().set(ckey, 0);
			}
		}
		return;
	}
	
	
	if (url==":back"){
		AP.back();
		return;
	}
	
	if (url==":export"){
		var curl=Client.path.current;
		if (curl.indexOf("?")!=-1){
			curl+="&export=1";
		}else{
			curl+="?export=1";
		}
		
		window.open(Client.url+"/"+curl);
		return;
	}
	
	
	if (url==":embed"){
		var w=$(ref).data("width");
		if (!w){
			w=800;
		}
		
		var app=$(ref).data("app");
		var url=$(ref).data("embed");
		
		var title=$(ref).data("title");
		if (!title){
			title="App embed: "+app;
		}
		
		Base.api.embed(Base.domain(app)+"/"+url, {
			width: w,
			title: title
		});
		
		return;
	};
	
	
	if (url==":viewfile"){
		var ext_url=$(ref).closest(".fileviewer-mobile").data("url");
		if (!ext_url){
			ext_url=$(ref).data("file");
		}
		
		if (ext_url){
			window.open(ext_url);
		}
		return;
	}
	
	if (url == ":dialog-close"){
		return AP.dialog.get(ref).close();
	}
	
	
	if (url==":file"){
		var ext_url=$(ref).data("file");
		Base.file.preview(ext_url);
		return;
	}
	
	if (AP.word.prefix(url, '#')){
		var id=url.substr(1);
		var $selector=$("#"+id);
		if (!$selector.length){
			return;
		}
		
		var $s=$selector.closest(".scroll-y");
		if (!$s || !$s.length){
			$s=$selector.closest(".scroll-in")
		}
		
		if (!$s || !$s.length){
			return;
		}
		
		var etop=$selector.offset().top;
		var ptop=$s.offset().top;
		var t=etop-ptop+$s.scrollTop();
		
		$s.scrollTop(t);
		
		return;
	}
	
	if (!url){
		return;
	}
	
	if ($(ref).data("ref") && $(ref).data("ref").length){
		var ref_url=$(ref).data("ref");
		if (ref_url==":self" || ref_url=="self"){
			ref_url= AP.url().current();
		}
		setRef(url, ref_url);
	}
	
	
	var dburl=$this.data("dburl");
	
	if (dburl){	
		urlc_clicks++;
		if (urlc_clicks === 1){
			urlc_timer = setTimeout(function(){ 
				base_trueclick($this, ref, url);
				urlc_clicks = 0;
			}, 200);
		} else {
			clearTimeout(urlc_timer);
			urlc_clicks = 0;
			base_trueclick($this, ref, dburl);
		}
	}else{
		base_trueclick($this, ref, Base.contextURL(url, ($this.data("blank")==1)));	
	}
};



function usernameClick(username, ref){
	UI.user.menu(ref, username);	
};


function base_trueclick($this, ref, url){
	
	// Handle URL click
	var inspect=Base.inspect(url, ($this.data("blank")==1));
	
	if (inspect.base){
		if (inspect.local){
			if (!AP.adaptive(url, window.location.href) && !AP.rewriteCheck(url)){
				return AP.redirect(url);
			}
			
			if ($this.data("blank")=="1"){
				return window.open(Client.url+"/"+inspect.url);	
			}
			
			return AP.toURL(inspect.url, null, ref);
		}else{
			return window.open(inspect.url);
		}
	}else{
		if (!AP.adaptive(url, window.location.href)){
			// return AP.redirect(url);
			return window.open(url);
		}
		
		AP.toURL(url, null, ref);
	}
};










function getFunctionByName(functionName, context) {
	// If using Node.js, the context will be an empty object
	if(typeof(window) == "undefined") {
		context = context || global;
	}else{
		// Use the window (from browser) as context if none providen.
		context = context || window;
	}

	// Retrieve the namespaces of the function you want to execute
	// e.g Namespaces of "MyLib.UI.alerti" would be ["MyLib","UI"]
	var namespaces = functionName.split(".");
	
	// Retrieve the real name of the function i.e alerti
	var functionToExecute = namespaces.pop();
	
	// Iterate through every namespace to access the one that has the function
	// you want to execute. For example with the alert fn "MyLib.UI.SomeSub.alert"
	// Loop until context will be equal to SomeSub
	for (var i = 0; i < namespaces.length; i++) {
		context = context[namespaces[i]];
	}
	
	// If the context really exists (namespaces), return the function or property
	if(context){
		return context[functionToExecute];
	}else{
		return undefined;
	}
}var CONFIG={
    name: "Base",
    email: "contact@base.vn",
    owner: "Base",
    home_src: "base.vn",
    domain:"base.vn",
    port: "1331",
    https_port: "1331",
    api: "message",
    fileViewerAPI: "https://file.base.local.basecdn.net"
};

if (parseInt(Client.env)){
	CONFIG.fileViewerAPI= "https://file.basecdn.net";
}


if (Client.base && Client.base.port){
	CONFIG.port=Client.base.port;
	CONFIG.https_port=Client.base.port;
}var Tag=new function __Tag(){
	this.use_context=1;
	this.__log_people=null;
	
	this.context=function(flag, people){
		this.use_context=flag;
		
		this.__log_people=null;
		if (flag && people){
			this.__log_people=people;
		}
	};
	
	this.people=function(){
		if (Client.pageData.context && this.use_context){
			if (Client.pageData.context.__people){
				return Client.pageData.context.__people;
			}
			
			if (this.__log_people){
				return this.__log_people;
			}
			
			Client.pageData.context.__people=AP.array.filter(Client.people, function(p){
				return hasUser(Client.pageData.context.followers, p) || hasUser(Client.pageData.context.owners, p); 
			});

			if (!Client.pageData.context.__people.length){
				return Client.people;		
			}
			
			return Client.pageData.context.__people;
		}
		
		return Client.people;
	};
	
	
	this.line=function(input){
		if (!$(input).length){
			return;
		}
		return $(input).apcomplete('api/tag/user', true);
	};
	
	
	this.singleUser=function(input, array){
		if (!$(input).length){
			return;
		}
		
		$(input).data("single-tag", 1);
		
		this.user(input, array);
	};

	
	this.user=function(input, array, callback){
		if (!$(input).length){
			return;
		}
		
		
		$(input).attr('autocomplete', 'off');

		if (AP.data.isInt(array) || array=="auto"){
			var id=array;
			if (array=="auto"){
				id=0;
				if (Client.data.network){
					id=Client.data.network.id;
					alert(id);
				}
			}
			
			return $(input).each(function(){
				$(this).tag(Client.people, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					var str="";
					if (item && item.keywords){
						str+=item.keywords;
					}
					
					if (item && item.name){
						str+=item.name;
					}
					
					item.__keywords=str;
					
					if (AP.word.fulltextMatch(str, q) && (!id || AP.array.contain(item.networks, id))){
						if (!item.value){
							item.value="@"+item.username;
						}
						
						return true;
					}
					
//					if (item && item.name && item.name.toLowerCase().indexOf(q.toLowerCase())>-1 && (!id || AP.array.contain(item.networks, id))){
//						if (!item.value){
//							item.value="@"+item.username;
//						}
//						
//						return true;
//					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		
		if (array && array.length){
			return $(input).each(function(){
				$(this).tag(array, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					if (!item.value){
						item.value="@"+item.username;
					}
					
					var keywords=item.__keywords;
					var qf=purify(q.toLowerCase()).replace(/[\s\-]/g,'');
					
					if (!keywords){
						keywords=item.name;
						if (item.keywords){
							keywords+=item.keywords;
						}
						
						if (item.name){
							keywords+=item.name;
						}
						
						if (item.name){
							keywords+=item.title;
						}
						
						keywords=purify(keywords.toLowerCase()).replace(/[\s\-]/g,'');
						item.__keywords=keywords+' ';
					}
					
					if (keywords && keywords.indexOf(qf)!=-1){
						return true;
					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		return $(input).each(function(){
			$(this).tag('api/tag/user', function(item){
				return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
			}, function(value, q){
				if (value && value.length && value.toLowerCase().indexOf(q.toLowerCase())>-1){
					return true;
				}
				return false;
			}, function(item, q){
				return Tag.order_fn(item, q);
			});
		});
	};
	
	
	
	this.team=function(input){
		var sources=AP.select(Client.units, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this=$(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value);
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});
	};
	
	
	this.teamOptions=function(){
		var sources=AP.render(Client.units, function(e){
			if (e.metatype=="user"){
				return "";
			}
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		});
		
		sources="<option value='0'>-- Select team --</option>"+sources;
		
		return sources;
	};
	
	
	this.teamSelect=function(selector, context){
		this.team(selector);
	};
	
	
	this.teamExtend = function(input){
		var sArray = Client.units;
		if (Client.units && Client.units.length){
			for(var i = 0; i < Client.units.length; i++) {
				var test = AP.array.findObj(Client.units, Client.units[i].id);
				if(test) {
				}else{
					sArray.push(Client.units[i]);
				}
			}
		}
		
		var sources = AP.select(sArray, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this = $(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value );
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});	
	};
	
	
	this.networkValues=function(teams){
		var text="";
		for (var i=0; i<teams.length; i++){
			text+=teams[i].name+" (@"+teams[i].path+"), ";
		}
		
		return text;
	};
	
	
	
	this.order_fn=function(item, q){
		q=q.toLowerCase();
		var username=item.username.toLowerCase();
		
		if (q==username){
			return 10;
		}
		
		if (username.indexOf(q)==0){
			return 9;
		}
		

		return 1;
	};
	
	
	
	
	function hasUser(users, user){
		return AP.array.contain(users, user, function(e, f){
			return e.username==f.username;
		});
	};
};
if (Client.lang=="vn" || Client.lang=="vi"){
	AP.locale.set("lang", "vn");
	AP.locale.set("date-format", "%l, %d/%m/%Y");
	AP.locale.set("date-format-jquery", "DD, dd/mm/yy");
	
	AP.time.months=["ThĂ¡ng 1","ThĂ¡ng 2","ThĂ¡ng 3","ThĂ¡ng 4","ThĂ¡ng 5","ThĂ¡ng 6","ThĂ¡ng 7","ThĂ¡ng 8","ThĂ¡ng 9","ThĂ¡ng 10","ThĂ¡ng 11","ThĂ¡ng 12"];
	AP.time.sMonths["T1","T2","T3","T4","T5","T6","T7","T8","T9","T10","T11","T12"];
	AP.time.days=["Thá»© hai","Thá»© 3", "Thá»© 4", "Thá»© 5","Thá»© 6","Thá»© 7", "Chá»§ nháº­t"];	
	AP.time.sDays=["Mon","Tue", "Wed", "Thu","Fri","Sat","Sun"];
	
	
	
	$.datepicker.setDefaults({
		firstDay: 1,
	    closeText: 'ÄĂ³ng', // set a close button text
	    currentText: 'HĂ´m nay', // set today text
	    monthNames: ['ThĂ¡ng 1','ThĂ¡ng 2','ThĂ¡ng 3','ThĂ¡ng 4','ThĂ¡ng 5','ThĂ¡ng 6', 'ThĂ¡ng 7','ThĂ¡ng 8','ThĂ¡ng 9','ThĂ¡ng 10','ThĂ¡ng 11','ThĂ¡ng 12'], // set month names
	    monthNamesShort: ['T1','T2','T3','T3','T5','T6','T7','T8','T9','T10','T11','T12'], // set short month names
	    dayNames: ['Chá»§ nháº­t','Thá»© hai','Thá»© 3','Thá»© 4','Thá»© 5','Thá»© 6','Thá»© 7'], // set days names
	    dayNamesShort: ['CN','T2','T3','T4','T5','T6','T7'], // set short day names
	    dayNamesMin: ['CN','T2','T3','T4','T5','T6','T7'], // set more short days names
	    dateFormat: 'dd/mm/yyyy' // set format date
	});

}else{
	AP.locale.set("date-format-jquery", "dd/mm/yy");
}

AP.locale.set("date-format", "DD/MM/YYYY");var Base=new function __Base(){
	this.__active=1;
	this.__last_idle=0;
	this.__stopped=false;
	
	this.apiURL=function(){
		if (!Client.base || !Client.base.app){
			return "";
		}
		
		if (Client.base.app=="message"){
			return "";
		}
		
		return (Client.https?"https://":"http://")+"api."+Client.domain+"/ajax/";
	};
	
	this.init=function(config){
		$(window).focus(function(){
			if (Base.__stopped){
				if (Client.system && parseInt(Client.system.id)==1){
					$.log("SYSTEM_PENDING_REFRESH");
				}else{
					AP.refresh();	
				}
				
				return;
			}
			
			setTimeout(function(){
				 Clog.log("active", 1);
				 if (!Base.__active){
					 Base.__active=1;
					 AP.sys.fire("window.active");	 
				 }
				 
			 },300);
			 
			 Base.__last_idle=0;
		}).blur(function(){
			AP.sys.fire("window.blur");
			Clog.log("active", 0);
			Base.__active=0;
			Base.__last_idle=AP.time.now();
		});
		
		
//		setInterval(function(){
//			// MAX IDLE FOR 30 MINUTES, AFTER THAT WE WILL STOP THE SOCKET
//			var max_idle=30*60;
//			
//			if (Base.__last_idle && AP.time.now()-Base.__last_idle > max_idle){
//				Base.idle();
//			}
//		},1000);
		
		
		$(document.body).click(function(){
			Clog.log("active", 1);
			
			if (!Base.__active){
				 Base.__active=1;
				 AP.sys.fire("window.active");	 
			 }
		});
		
		$.log("INITIALIZING BASE ...");
		
		Base.autoRender();
		AP.sys.on(AP.EVENTS.PAGE_UNLOAD, function(){
			Base.autoRender();
		});
		
	};
	
	
	this.initURLClick=function(){
		$(document.body).on("click", ".url", function(){
			urlClick(this);
		});
		
		$(document.body).on("click", ".actionable", function(){
			var action = $(this).data('actionable');
			if (action){
				action();
			}
		});
	};
	
	
	this.initLayout = function(){
		if (!Client.viewer  || !Client.viewer.id){
			return;
		}
		
		this.applist.init();
		this.cors(true);
		this.layout.init();
		
		
		// Check timezone
		var last_log = Clog.getCookie("hc_daily");
		var today = AP.i18n.date(AP.time.now());
		
		var hc_active = false;
		if (!last_log || last_log != today){
			hc_active = true;
			Clog.setCookie('hc_daily', today);
		}
		
		
		var tz = -Math.floor((new Date().getTimezoneOffset())/60);
		if ('user_timezone' in Client){
			var utz = parseInt(Client.user_timezone);
			if (tz != utz){
				if (hc_active){
					return AP.alertError("<b class='red'>WE DETECT MISMATCHED TIMEZONE.</b><br><br>Your account's timezone setting is <b>GMT "+(utz)+"</b> but your current browser/computer's timezone is <b>GMT "+(tz)+"</b>. It might cause unpredicted error.");	
				}
			}
		}

		// custom dialog for system announcement
		var zalo_sp_notice = AP.log.getCookie("zalo_sp_notice") || AP.lc.get('zalo_sp_notice');
		if (!AP.sys.isMobile() && Client.env && (today == '01/07/2022') && (!zalo_sp_notice || zalo_sp_notice != 2207)) {
			AP.customDialogV2({
				"title": "BASE.VN THĂ”NG BĂO TRIá»‚N KHAI KĂNH ZALO OFFICIAL Há»– TRá»¢ KHĂCH HĂ€NG.",
				"html": "<div style='padding: 20px;'> <center style='padding-bottom: 15px; border-bottom: 1px solid #ccc; font-size: 17px; margin-bottom: 20px;'><h6>BASE.VN THĂ”NG BĂO TRIá»‚N KHAI KĂNH ZALO OFFICIAL Há»– TRá»¢ KHĂCH HĂ€NG</h6></center> <p><b>ThĂ¢n gá»­i QuĂ½ khĂ¡ch hĂ ng,</b></p> <p>Tá»« ngĂ y 01/07/2022, Base triá»ƒn khai kĂªnh Zalo Official <b>&#8220;Base Support Channel&#8221;</b> Ä‘á»ƒ há»— trá»£ khĂ¡ch hĂ ng. Sau khi quĂ½ khĂ¡ch nháº¥n nĂºt <b>&#8220;Quan tĂ¢m&#8221;</b> kĂªnh Base Support Channel, quĂ½ khĂ¡ch cĂ³ thá»ƒ dá»… dĂ ng nháº­n táº¥t cáº£ nhá»¯ng thĂ´ng tin cáº­p nháº­t vá» sáº£n pháº©m má»›i hay tĂ¬m kiáº¿m hÆ°á»›ng dáº«n sá»­ dá»¥ng nhanh chĂ³ng hÆ¡n. BĂªn cáº¡nh Ä‘Ă³, quĂ½ khĂ¡ch cÅ©ng cĂ³ thá»ƒ káº¿t ná»‘i trá»±c tuyáº¿n vá»›i chuyĂªn viĂªn há»— trá»£ cá»§a Base trong quĂ¡ trĂ¬nh sá»­ dá»¥ng sáº£n pháº©m.</p> <p>QuĂ½ khĂ¡ch vui lĂ²ng <b>quĂ©t mĂ£ QRcode</b> táº¡i Ä‘Ă¢y vĂ  <b>nháº¥n &#8220;Quan tĂ¢m&#8221;</b> Ä‘á»ƒ Base há»— trá»£ nhanh nháº¥t!</p> <img style='max-width: 760px; margin-bottom: 20px;' src='"+(Client.share_url)+"/sysmsg/zalo_base_support.jpg' /> <br /> <p>Viá»‡c káº¿t há»£p á»©ng dá»¥ng chat Zalo Official Ä‘á»ƒ tá»« Ä‘Ă³ Base gá»­i thĂ´ng tin Ä‘áº¿n khĂ¡ch hĂ ng vĂ  chÄƒm sĂ³c khĂ¡ch hĂ ng tá»‘t hÆ¡n sáº½ gia tÄƒng hiá»‡u quáº£ giá»¯a Base vĂ  QuĂ½ khĂ¡ch hĂ ng. Hi vá»ng vá»›i kĂªnh há»— trá»£ trĂªn Zalo Official sáº½ giĂºp quĂ½ khĂ¡ch hĂ ng cĂ³ thĂªm nhiá»u tráº£i nghiá»‡m tuyá»‡t vá»i vá»›i dá»‹ch vá»¥ há»— trá»£ cá»§a Base.</p> <p>Cáº£m Æ¡n QuĂ½ khĂ¡ch luĂ´n tin tÆ°á»Ÿng vĂ  Ä‘á»“ng hĂ nh cĂ¹ng Base!</p> </div>"
			}).data("full", 1).balance();

			AP.log.setCookie("zalo_sp_notice", 2207);
			AP.lc.set("zalo_sp_notice", 2207);
		}

	};
	
	
	this.setObjectURL = function(key, id){
		if (key===null){
			AP.setURLParams({show: null, id: null});
			return;
		}
		
		AP.setURLParams({show: key, id: id});
	};
	
	
	this.resetObjectURL = function(){
		AP.setURLParams({show: null, id: null}, true);
	};
	
	// ALIAS
	this.setObjURL = this.setObjectURL;
	this.resetObjURL = this.resetObjectURL;
	
	
	
	/**
	 * @desc Idle process
	 */
	this.idle=function(){
		if (this.__stopped){
			return;
		}
		
		this.__stopped=true;
		Live.off();
		$(document.body).append("<div id='idle' style='top:0px; left:0px; right:0px; bottom:0px; z-index:999999; position:absolute;' onclick='AP.refresh();'></div>");
	};
	
	
	/**
	 * @desc Check if an app is available
	 */
	this.appEnabled = function(appkey){
		for (var i=0; i<Client.applist.length; i++){
			if (Client.applist[i].key==appkey){
				return true;
			}
		}
		
		return false;
	};
	
	this.cors=function(flag){
		if (!Client.base || !Client.base.secureData){
			return;
		}
		AP.ajaxSetup({
			__sessionid:  Client.base.secureData.session,
			__otp:  Client.base.secureData.otp,
		});
	};
	
	
	this.__systemActive=0;
	this.systemActive=function(){
		return this.__systemActive==1;
	};
	
	
	this.console=function(){
		if (Client.system && parseInt(Client.system.id)==1){
			if (arguments.length>=1){
				console.log("---------");
			}
			for (var i=0; i<arguments.length; i++){
				console.log(arguments[i]);
			}	
		}
	};
	
	
	/**
	 * @desc Check if the current tab is active
	 */
	this.tabActive=function(){
		return (Base.__active==1);
	};
	
	
	
	this.open=function(key){
		if (!key){
			key='main';
		}
		
		var spaces=["#base-star", "#base-calendar", "#base-notis", "#base-user", "#base-chat", "#base-apps"];
		
		for (var i=0; i<spaces.length; i++){
			if (spaces[i]=="#base-"+key){
				$(spaces[i]).show();
			}else{
				$(spaces[i]).hide();
			}
		}
		
		if (key=='notis'){
			N.ui.show("#base-panel .item-notis");
		}
		
		if (key=='chat'){
			Chat.panel.toggle("#base-panel .item-chat");
		}
		
		$("#base-panel .item").removeClass("base-active");
		$("#base-panel .item-"+key).addClass("base-active");
		
		if (key=="apps" && !$("#base-apps").hasClass("js-inited")){
			$("#base-apps").addClass("js-inited");
			$("#base-apps .item .image").each(function(){
				$(this).html("<img src='"+$(this).data("image")+"'/>")
			});
		}
	};
	
	
	this.toggle=function(key){
		if (key=="notis"){
			if (!$("#base-notis").is(":visible")){
				N.ui.hide();
				N.ui.load("#base-notis-items");
			}else{
				$("#base-notis").hide();
			}
			
			return;
		}	
		
		if (key=="reminder"){
			if (!$("#base-reminders").is(":visible")){
				Reminder.load();
			}else{
				$("#base-reminders").show();
			}
		}
		
		
		if (key=="apps" && $("#base-apps").is(":visible")){
			$("#base-apps").hide();
			return;
		}
		
		return this.open(key);
	};
	
	
	this.focus=function(key){
		this.open();
		// $("#base-panel .item").setActive(".item-"+key);
		$("#base-panel .item").removeClass("base-active");
		$("#base-panel .item-"+key).addClass("base-active");
	};
	
	
	this.close=function(){
		var spaces=["#base-star", "#base-calendar", "#base-notis", "#base-user", "#base-chat", "#base-apps"];
		for (var i=0; i<spaces.length; i++){
			$(spaces[i]).hide();
		}
		
		// $("#base-panel .item").setActive(".item-main");
		$("#base-panel .item").removeClass("base-active");
		$("#base-panel .item-main").addClass("base-active");
	};
	
	
	
	this.inspect=function(url, blank_derivative){
		var parts= url.split("://");

		if (!Client.base) {
			return {	
				"base": 0,
				"app": "none",
				"url": url,
				"abs": 0
			};
		}
		
		if (parts.length==2){
			if (isBaseURL(parts[0])){
				var apps=parts[0].split("-",2);
				if (apps.length!=2){
					return errorURL();
				}
				
				var app=apps[1];
				var local=0;
				
				if (Client.base.app && app.toLowerCase()==Client.base.app.toLowerCase()){
					local=1;
				}
				
				// Exception @ baseHRM
				if (blank_derivative){
					$.log([Client.base.app, app]);
				}else{
					if (Client.base.app=="me" && app.toLowerCase()=="hrm"){
						local=1;
					}
					
					if (Client.base.app=="hrm" && app.toLowerCase()=="me"){
						local=1;
					}	
				}
				
				
				// @desc Special handling, when base link is referenced from outside
				if (!local && (app=="message" || app == "msg")){
					if (AP.rewriteCheck(parts[1])){
						return {	
							"base": 1,
							"global":0,
							"local": 1,
							"app": apps[1],
							"url": Base.domain(Client.base.app)+"/"+parts[1],
							"abs": 1,
							"raw":url
						}
					}
					
					
					return {	
						"base": 1,
						"global":1,
						"local": 0,
						"app": apps[1],
						"url": Base.domain("message")+"/"+parts[1],
						"abs": 1,
						"raw":url
					}
				}
				
				
				if (local){
					var curl=parts[1];
					if (app!="message"){
						curl=parts[1];
					}
					
					return {	
						"base": 1,
						"global":1,
						"local": local,
						"app": apps[1],
						"url": curl,
						"abs": 1,
						"raw":url
					}
				}else{
					return {	
						"base": 1,
						"global":0,
						"local": local,
						"app": apps[1],
						"url": this.domain(apps[1])+"/"+parts[1],
						"abs": 1,
						"raw":url
					}
				}
			}else{
				return {
					"base": 0,
					"app": "none",
					"url": url,
					"abs":1
				}
			}
		}else if (parts.length==1){
			return {	
				"base": 1,
				"global": ((Client.base.app.toLowerCase()=="message" || Client.base.app.toLowerCase()=="msg")?1:0),
				"local": 1,
				"app": Client.base.app.toLowerCase(),
				"url": url,
				"abs": 1,
				"raw":url
			}
		}else{
			return {	
				"base": 0,
				"app": "none",
				"url": url,
				"abs": 0
			}
		}
	};
	
	
	this.a=function(url, title){
		var link="";
		var inspect=this.inspect(url);
		
		if (inspect.base){
			if (inspect.local){
				link="<span class='a url' data-url='"+inspect.url+"'>"+title+"</span>";	
			}else{
				link="<a target='_blank' href='"+inspect.url+"'>"+title+"</a>";
			}
		}else{
			link="<a target='_blank' href='"+url+"'>"+title+"</a>";
		}
		
		return link;
	};
	

	this.url2a=function(canvas, cond){
		$(canvas).find(".url").each(function(){
			if ($(this).data("blank") == 1){
				return;
			}
			
			if ($(this).data("href") || (cond && $(this).is(cond))){
				var attrs = { };

				$.each($(this)[0].attributes, function(idx, attr) {
					attrs[attr.nodeName] = attr.nodeValue;
				});

				attrs.href=Client.url+"/"+$(this).data("url");

				$(this).replaceWith(function () {
					return $("<a />", attrs).append($(this).contents()).removeClass("url");
				});
			}
		});
		
		AP.setContinuousRequest(canvas);
	};
	
	this.urlToA = this.url2a;
	
	this.domain=function(subdomain){
		var httpbase="http";
		if (Client.https){
			httpbase="https"
		}
		
		if (!subdomain || subdomain==""){
			return httpbase+"://" + Client.domain;
		}
		
		if(subdomain == "message" || subdomain == "msg") {
			return httpbase+"://" + CONFIG.api + "." + Client.domain;
		}
		
		return httpbase+"://"+subdomain+"."+Client.domain;
	};
	
	this.logout = function() {
		AP.confirm("Báº¡n cĂ³ muá»‘n Ä‘Äƒng xuáº¥t khá»i há»‡ thá»‘ng ngay bĂ¢y giá»?", function(){
			Base.pref().destroy();
			return AP.redirect(Base.domain("account")+"/a/logout?token="+Client.logout_token);
		});
	};
	

	this.checkExpiring=function(){
		var exp=Client.expiring;
		if (!exp){
			return;
		}
		
		var html="<div id='expiring'>" +
			"<div class='box'>" +
			"	<div class='title'><span class='icon -ap icon-bookmark22'></span> &nbsp; á»¨ng dá»¥ng sáº½ háº¿t háº¡n vĂ o ngĂ y <em>"+AP.i18n.date(exp.time)+"</em>. Vui lĂ²ng liĂªn há»‡ qua sá»‘ Ä‘iá»‡n thoáº¡i <em>(024) 2244 1313</em> Ä‘á»ƒ gia háº¡n.</div>" +
			"	<div class='close' onclick='$(\"#expiring\").fadeOut(300);'><span class='-ap icon-close'></span>&nbsp; ÄĂ³ng</div>" +
			"</div>" +
		"</div>";
		
		if (parseInt(exp.time) < AP.time.now()){
			html="<div id='expiring'>" +
				"<div class='box'>" +
				"	<div class='title'><span class='icon -ap icon-bookmark22'></span> &nbsp; á»¨ng dá»¥ng Ä‘Ă£ háº¿t háº¡n vĂ o ngĂ y <em>"+AP.i18n.date(exp.time)+"</em> vĂ  sáº½ <em>khĂ´ng thá»ƒ truy cáº­p</em> tá»« ngĂ y <em>"+AP.i18n.date(parseInt(exp.time) + 7*24*3600)+"</em>. Vui lĂ²ng liĂªn há»‡ qua sá»‘ Ä‘iá»‡n thoáº¡i <em>(024) 2244 1313</em> Ä‘á»ƒ gia háº¡n.</div>" +
				"	<div class='close' onclick='$(\"#expiring\").fadeOut(300);'><span class='-ap icon-close'></span>&nbsp; ÄĂ³ng</div>" +
				"</div>" +
			"</div>";
		}
		
		$("#document").append(html);
		
	};
	
	
	/**
	 * @desc Set interval to block session fixation
	 */
	this.protectSession=function(){
		var uid=Clog.getCookie("user_id");
		var tracking=true;
		
		setInterval(function(){
			if (!tracking){
				return;
			}
			
			var cid=Clog.getCookie("user_id");
			if (uid!=cid){
				tracking=false;
				
				AP.confirm("Your session is expired or changed by another user. Please refresh the page to continue safely.", function(){
					AP.refresh();
				});
				
				Live.off();
			}
		}, 5000);
	};
	
	
	
	this.checkPrimaryPath=function(u1, u2){
		if (AP.word.prefix(u1, Client.url)){
			return true;
		}
		
		var path=getBasePath(u2);
		var bs=AP.word.split("/", u1, true);
		
		if (!path){
			return false;
		}
		
		if (bs.length>=1 && path && u1 && path!=bs[0]){
			return false;
		}
		
		return true;
	};

	
	
	this.autoRender=function(){
		UI.autoActive();
	}
	

	this.beta=function(){
		return (Client.system && Client.system.id && (parseInt(Client.system.id)==1 || parseInt(Client.system.id)==79));
	};
	
	
	this.contextURL=function(url, blank_derivative){
		if (Client.base && Client.base.app=="me" && !blank_derivative){
			if (AP.word.prefix(url, "base-hrm://")){
				return url.substr(11);
			}
		}
		
		return url;
	};
	
	
	function getBasePath(u2){
		if (!AP.word.prefix(u2, Client.url)){
			return null;
		}
		
		var strs=u2.substr(Client.url.length).split("/");
		if (strs.length<2){
			return null;
		}
		
		return strs[1];
	};
	
	
	function isBaseURL(str){
		var data=str.split("-");
		if (data.length!=2 || data[0]!="base"){
			return false;
		}
		
		return true;
	};
	
	
	
	
	function errorURL(){
		return {	
			"base": 0,
			"app": "none",
			"url": "error",
			"abs": 0,
			"error":1
		}
	};
};












Base.title=new function __BaseTitle(){
	this.__msgcount=0;
	this.__notiscount=0;
	
	if (Client.num_notis && parseInt(Client.num_notis)){
		this.__notiscount=Client.num_notis;	
	}
	
	
	
	/**
	 * @desc Set title
	 */
	this.title=function(title){
		Client.pageData.title=title;
	};
	
	
	this.set=function(count){
		if ('notis' in count){
			
		}
	};
	
	
	this.update=function(){
		var total=Channel.countUniqueUnreads();		
		this.message(total);
	};

	
	this.message=function(msgcount){
		this.__msgcount=msgcount;
		updateTitle();
	};
	
	
	this.notis=function(notiscount){
		this.__notiscount=notiscount;
		updateTitle();
	};
	
	
	function updateTitle(){
		var total=Base.title.__notiscount+Base.title.__msgcount;
		if (isNaN(total)){
			total="";
		}
		
		var title=Client.pageData.title;
	
		if (total){
			document.title="("+total+") "+title;
		}else{
			document.title=title;
		}
	};
};



Base.load = function(opts){
	if (!opts.url && opts.action){
		opts.url = opts.action;
	}
	
	function prepareFSLayout(id){
		if ($("#base-master-fs").length){
			AP.destroyDialog("#base-master-fs-fs-dialog")
		}
		
		// Init custom dialog
		AP.fsDialog("base-master-fs");
		$("#base-master-fs .fs-closable").click(function(){
			Base.load.closeFS();
		});
		
		if (!$("#"+id).length){
			var html="<div class='bfs-dx-layout js-bfs' id='"+(id)+"'></div>";
			$(html).appendTo("#base-master-fs");
		}
		
		$("#base-master-fs").show().addClass("__ontop");
	};
	
	function completeFSLayout(id){
		
	};
	
	
	function baseLoadFinalRender(opts){
		Layout.scrollable("#"+(opts.id)+" .scrollable");
		
		if (opts.fs){
			completeFSLayout(opts.id);
			return;
		}
		
		// Automatic tabbing
		$("#"+opts.id+" .sections").each(function(){
			var tabs=[];
			$(this).find(".section").each(function(){
				var ref=AP.uuid();
				var tab=$(this).data("tab");
				if (!tab){
					tab = $(this).find(".header").text();
				}
				$(this).addClass("js-"+ref);
				tabs.push({ref: ref, tab: tab});
			});
			
			$(this).wrapInner("<div class='sections-body'></div>");
			var tabs_html = AP.render(tabs, function(t){
				return "<div class='tab' data-ref='"+(t.ref)+"'>"+(t.tab)+"</div>";
			});
			
			$(this).prepend("<div class='tabs'>"+(tabs_html)+"</div>");
			$(this).find(".tabs .tab").on("click", function(){
				$(this).siblings().removeClass("active");
				$(this).addClass("active");
				$(this).closest(".sections").find(".sections-body .section").setActive(".js-"+$(this).data("ref"));
			});
			
			$(this).find('.tabs .tab:first').click();
		});
		
	};
	
	
	
	opts = $.extend({id: "base-dialog", closable: false, height: 400, width: 800, data: {}}, opts);
	var header='';
	if (opts.header){
		header = "<div class='bl-header'> <div class='bl-title inline' onclick='AP.dialog.close(this); Base.load.close();'>"+(opts.header)+"</div> <div class='bl-close' onclick='AP.dialog.close(this); Base.load.close();'><span class='-ap icon-ion-android-close'></span></div> </div>";
	}
	
	var html="<div class='base-load-wrapper' style='min-height:"+(opts.height)+"px'>"+(header)+"<div id='"+(opts.id)+"' class='base-display'></div></div>";
	
	if (opts.fs || opts.width=="fullscreen"){
		// Prepare for fullscreen layout
		prepareFSLayout(opts.id);
	}else{
		AP.customDialog(html, opts.id+"-dialog").width(opts.width).style("-full -dx-obj-v2").closable(opts.closable).show();
	}
	
	if (!opts.url){
		$("#"+opts.id).html(opts.html);
		if (opts.render){
			opts.render();
		}
		baseLoadFinalRender(opts);
		Render.finish();
		return;
	}
	
	AP.loadInlineURL(opts.url, opts.data, "#"+opts.id, {
		start: function(){
		}, end: function(){
			AP.dialog(opts.id+"-dialog").balance();
			baseLoadFinalRender(opts);
			Render.finish();
			
			if (opts.render){
				return opts.render(opts);
			}
		}, error: function(code){
			AP.dialog.close("#"+opts.id);
			Base.load.close();
			
			if (opts.render){
				return opts.render(opts);
			}
		}
	});
};


// Placeholder function
Base.load.close=function(){};

Base.load.closeFS = function(){
	AP.destroyDialog("#base-master-fs-fs-dialog");
	Base.load.close();
};

Base.color=new function __BaseColor(){
	this.change=function(index){		
		UI.ajaxShow();
		AP.post(Base.apiURL()+"api/me/color", {color: index}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Color theme updated ...");
			AP.refresh();
		});
	};
};




Base.demo=new function __BaseDemo(){
	this.on=function(){
		if (!Client.system || !Client.system.path){
			return false;
		}
		
		return Client.system.path=="demo" || Client.system.path=="okrdemo";
	};
	
	
	this.init=function(id, options){
		$("#base-sysdemo").append("<div class='close'><span class='-ap icon-ion-android-close'></span></div>" +
			"<div class='side'>" +
			"	<div class='cta js-chatnow'><span class='-ap icon-arrow-right2'></span>&nbsp; ÄÄƒng kĂ½ chĂ­nh thá»©c</div>" +
			"</div>");
			
		
		if (!options.cta){
			window.Tawk_API={};
			if (Clog.getCookie("demo_name") && Clog.getCookie("demo_email")){
				Tawk_API.visitor={
					name  : decodeURIComponent(Clog.getCookie("demo_name")),
					email : decodeURIComponent(Clog.getCookie("demo_email"))
				};

			}
			
			window.Tawk_LoadStart=new Date();
			
			var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
			s1.async=true;
			s1.src='https://embed.tawk.to/'+id+'/default';
			s1.charset='UTF-8';
			s1.setAttribute('crossorigin','*');
			s0.parentNode.insertBefore(s1,s0);
			
			Tawk_API.onLoad=function(){
				if (Clog.getCookie("demo_name") && Clog.getCookie("demo_email")){
					console.log(decodeURIComponent(Clog.getCookie("demo_email")));
					Tawk_API.setAttributes({
						name  : decodeURIComponent(Clog.getCookie("demo_name")),
						email : decodeURIComponent(Clog.getCookie("demo_email"))
					}, function(code){
						console.log(code);
					});
				}
			};
			
			$("#base-sysdemo .js-chatnow").click(function(){
				Base.demo.hide();
				Tawk_API.toggle();
			});

		}else{
			$("#base-sysdemo .js-chatnow").click(function(){
				var cta=options.cta;
				cta();
			});
		}
		
		
		$("#base-sysdemo .close").click(function(){
			Base.demo.hide();
		});
		
		setTimeout(function(){
			$("#base-sysdemo").fadeIn(1000);
		}, 1000);

				
	};
	
	this.hide=function(){
		$("#base-sysdemo").fadeOut(1000);
	};
	
	
	this.sendContact=function(){
		var data={
			name  : decodeURIComponent(Clog.getCookie("demo_name")),
			email : decodeURIComponent(Clog.getCookie("demo_email")),
			app: "okr"
		};
		
		
		UI.ajaxShow();
		AP.post(Base.domain("money")+"/ajax/api/trial/request", data, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Cáº£m Æ¡n báº¡n! Base Ä‘Ă£ nháº­n Ä‘Æ°á»£c yĂªu cáº§u tĂ i khoáº£n Trial cá»§a báº¡n.");
		});
		
	};
	
};





Base.draw = new function __Draw(){
	this.__inited=false;
	this.token="";
	this.callback=null;

	this.init=function(){
		if (this.__inited){
			return;
		}
		this.__inited=true;
		AP.postmessage.listen(function(data, origin){
			// if (data.token!=Base.draw.token){
			// 	return;
			// }
			//

			if (origin!=Base.domain("draw")){
				return;
			}
			
			AP.hideCustomDialog();
			
			if (Base.draw.callback){
				Base.draw.callback(data);
			}
				
		});
	};



	this.pick=function(options){
		options=$.extend({multi: 0, ext: 1}, options);

		this.init();
		if (options.callback){
			this.callback=options.callback;
		}

		this.token=AP.uuid();
		var extGTab = window.open(Base.domain("draw")+"?multi=1&base_token="+this.token+"&base_domain="+encodeURIComponent(Client.url), "_blank");
	};
};



Base.message=new function __BaseMessage(){
	this.peer=function(user_id){
		if (!AP.isset("Message")){
			return;
		}
		
		if (!user_id){
			return;
		}
		
		if (user_id==Client.viewer.id || user_id==Client.viewer.username){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/channel/peer.probe",{user: user_id}, function(code){
			UI.ajaxHide();
			
			
			if (Client.base.app=="message"){
				if (!code.channel){
					Channel.create.peer(user_id);	
				}else{
					Channel.open(code.channel.id, null, {intent: "panel"});	
				}
			}else{
				if (code.channel && code.messages){
					Message.create.peer(code);
				}else{
					Message.create.channel({prepend: true, users: [code.user.username]});
				}
			}
		});
	};
};



AP.sys.on("system.init", function(){
	Base.init();
	N.init();
	Base.protectSession();
});


AP.sys.on("system.start", function(){
	BC.hide();
	$("#base-star").hide();
	$("#base-calendar").hide();
});


setTimeout(function(){
	if (Client.units && Client.units.length){
		Client.units = ARR.filter(Client.units, function(e){
			if (e.metatype=="user"){
				var u = People.get(e.user_id);
				if (!u || u.error){
					return false;
				}
			}
			
			return true;
		});
	}
	
});


Rewrite.on("::base/{action}", function(qs){
	if (qs.action == "pick"){
		return Base.picker.engine.pick(this);
	}
	
	if (qs.action == "pickcontinue"){
		return Base.picker.engine.complete(this);
	}
	
	if (qs.action == "copy"){
		var cp = $(this).data("copy");
		if (cp){
			return AP.UI.copyTextToClipboard(cp);
		}
		return;
	}
	
	if (qs.action=="comment"){
		var $ip = $(this).closest(".box.comments").find("textarea[name=comment]").last();
		var username = $(this).data("reply_to");
		
		var val=$ip.val();
		
		if (val && val.length){
			$ip.val(val+" @"+username+" ").focus();
		}else{
			$ip.val("@"+username+" ").focus();
		}
	}
	
	if (qs.action == "chat"){
		return Base.message.peer(qs.user||qs.username);
	}
	
	if (qs.action == "customform"){
		return Base.cf.handler.on($(this).data("action"), this);
	}
	
	
	if (qs.action == "activate"){
		$(this).siblings().removeClass("active");
		$(this).addClass("active");
		
		var elem = $(this).data("activate");
		$(elem).addClass("active");
		$(elem).siblings().removeClass("active");
		
		$(this).parent().trigger("activated");
	}
	
	if (qs.action=="user"){
		if (qs.username){
			return usernameClick(qs.username, this);	
		}
	}
	
	if (qs.action == "todo"){
		return AP.alertError("THIS FEATURE IS SCHEDULED TO LAUNCH SOON");
	}
	
	if (qs.action == "emoji" || qs.action == "emoji-picker"){
		var that = this;
		return Base.emoji.init({
			icon: this,
			autohide: 1,
			yahoo: false
		}, function(emoji){
			$(that).parent().find("input").val(emoji.code);
			$(that).html("  " +Render.render('emoji', {code:emoji.code}, '')+ '');
		});
	}
	
	if (qs.action == "iconbox"){
		var that = this;
		
		return Base.icon.boxPicker({
			icon: this,
			autohide: 1,
			ready: function(box){
				$(that).html("  " +Render.render('iconbox', {iconbox:box.value, square:1}, '')+ '');
				$(that).closest(".inline-icon-picker").find("input").val(box.value);
			},
		}, function(box){
			$(that).html("  " +Render.render('iconbox', {iconbox:box.value, square:1}, '')+ '');
			$(that).closest(".inline-icon-picker").find("input").val(box.value);
		});
	}
	
	if (qs.action == "goto"){
		$(this).addClass("active");
		$(this).siblings().removeClass("active");
		
		var id=qs.to;
		var $elem=$("#"+id);
		if (!$elem.length){
			return;
		}
		var offset = parseInt(qs.offset)||0;
		
		var $box=$elem.closest(".scroll-y");
		if (!$box.length){
			return;
		}
		
		$box.animate({scrollTop: $elem.offset().top-offset}, 200);
	}
	
	if (qs.action == "file"){
		if (qs.list){
			var images = $(this).closest("."+qs.container).data("images");
			return FileX.previewList(images, Base64.safeDecode(qs.file));
		}
		
		return FileX.quickPreview(Base64.safeDecode(qs.file));
	}
});



Base.applist = new function __BaseAppList(){
	
	this.init= function(){
		if (!Client.applist){
			return;
		}
		
		var colors = '';
		
		for (var i=1; i<=9; i++){
			var active=(parseInt(Client.viewer.color)==i)?"active":"";
			colors+= "<div title='Change color theme' class='color -bg-alt"+(i)+" "+(active)+"' onclick='Base.color.change("+(i)+")'><span class='r'></span></div>";
		}
		
		var html = "<div class='-canvas full-mask' onclick='Base.close();'></div> <div class='arrow'></div> <div class='box'> <div class='top'> <div class='user'> <div class='image'><img src='"+(AP.xthumb(Client.viewer.gavatar))+"'></div> <div class='name'> <b>"+(Client.viewer.name)+"</b> &middot; @"+(Client.viewer.username)+" </div> <div class='info'> "+(Client.applist.length)+" apps installed &middot; <a target='_blank' href='//account."+(Client.domain)+"'>TĂ i khoáº£n</a> &middot; <a href='https://base.vn' target='_blank'>"+(Client.domain)+"</a> &middot; <a href='#' onclick='Base.logout(); return false;'>ÄÄƒng xuáº¥t</a> </div> </div> <div class='search'> <div class='input'><input type='text' name='q' id='js-app-search' placeholder='Filter apps'/></div> </div> </div> <div class='sb scrollable' data-autohide='1' data-autoscroll='1'> <div class='inner clear-fix'>"+(getApps())+"</div> </div> <div class='footer'> <div class='prefs clear-fix'> <div class='pref -conf' onclick='Base.notis_opt.settings();'>Email notifications</div> <div class='pref -dd -cmenuw js-lang'>Language: <em></em> <div class='-cmenu -no-icon -padding'> <div class='-item' data-lang='en'>English</div> <div class='-item' data-lang='vi'>Tiáº¿ng Viá»‡t</div> </div> </div> </div> <div class='colors'>"+(colors)+"</div> </div> </div>";
		
		
		$("#base-apps").html(html);
		Layout.scrollable("#base-apps .scrollable");
		
		$("#js-app-search").quickFilter("#base-apps .item", function($e, q){
			return AP.word.fulltextMatch($e.text(), q);
		});
		
		$("#base-apps .prefs .pref.js-lang").each(function(){
			var $box=$(this);
			var lang=Client.applang;
			
			$box.find(".-item").each(function(){
				if ($(this).data("lang")==lang){
					$(this).addClass("active");
					$box.find("em").html($(this).text());
				}else{
					$(this).removeClass("active");
				}
				
				$(this).click(function(){
					var v=$(this).data("lang");
					setLang(v);
				});
			});
		});
	};
	
	
	function getGroups(){
		var groups = {
			platform: {
				title: "Base Platform",
				desc: "Standard platform apps",
				apps: [],
				order: 9,
			},
			
			work: {
				title: "Base Work+",
				desc: "Work Management &amp; Collaboration",
				apps: [],
				order: 10,
				explore: 1
			},
			
			hrm: {
				title: "Base HRM+",
				desc: "People Management &amp; Development",
				apps: [],
				order: 10,
				explore: 1
			},
			
			info: {
				title: "Base Info+",
				desc: "Communication &amp; Information Management",
				apps: [],
				order: 2,
				explore: 1
			},
			
			finance: {
				title: "Base Finance+",
				desc: "Finance &amp; Assets Management",
				apps: [],
				order: 2,
				explore: 1
			},
			
			ext: {
				title: "Extra apps",
				desc: "External Apps &amp; Marketplace",
				apps: [],
				order: 2,
				extra: 1
			},

			fpt: {
				title: "FPT",
				desc: "External Apps from FPT",
				apps: [],
				order: 1
			}
		}
		
		ARR.loop(Client.applist, function(g, index){
			var parts = AP.word.safeSplit(",", g.group);
			
			if (parts.length && ARR.contain(['platform', 'work', 'hrm', 'info', 'crm', 'finance', 'ext', 'fpt'], parts[0])){
				groups[parts[0]].apps.push(g);
				
				if (isCurrent(g)){
					groups[parts[0]].order+=100;
				}
			}
			
			if (parts.length>=2 && ARR.contain(['platform', 'work', 'hrm', 'info', 'crm', 'finance', 'ext', 'fpt'], parts[1])){
				groups[parts[1]].apps.push(g);
				
				if (isCurrent(g)){
					groups[parts[1]].order+=50;
				}
			}
		});

		if (Client.extapps && Client.extapps.length > 0) {
			ARR.loop(Client.extapps, function(e) {
				if (e.group.length && ARR.contain(['platform', 'work', 'hrm', 'info', 'crm', 'finance', 'ext', 'fpt'], e.group[0])){
					groups[e.group[0]].apps.push(e);
				}
				
				if (e.group.length >= 2 && ARR.contain(['platform', 'work', 'hrm', 'info', 'crm', 'finance', 'ext', 'fpt'], e.group[1])){
					groups[e.group[1]].apps.push(e);
				}
			});
		}

		for (var key in groups){
			groups[key].apps.sort(function(e, f){
				if (isCurrent(e)){
					return -1;
				}
				
				if (isCurrent(f)){
					return 1;
				}
				
				return 0;
			});
		}
		
		var gs = ARR.selectObj(groups, function(obj, index, key){
			obj.key = key;
			return obj;
		});
		
		gs.sort(function(e, f){
			return f.order - e.order;
		});
		
		
		return gs;
	};
	
	
	function getApps(){
		var groups = getGroups();
		
		return AP.render(groups, function(e, index){
			return getGroup(e, index);
		});
	};
	
	
	function getGroup(g, index){
		if (!g.apps || !g.apps.length){
			if (g.explore){
				return "<div class='app-group'> <div class='g-header'> <div class='g-title url' data-url=':collapse/2'><em>"+(g.title)+"</em></div> <div class='g-info'>"+(g.desc)+"</div> </div> <div class='g-body'> <div class='g-explore'> <a class='g-link url' href='https://"+(Client.domain)+"/platform/"+(g.key)+"' target='_blank'>Explore and sign up for more apps</a> </div> </div> </div>";
			}
			
			return '';
		}

		var apps = '';
		if (typeof g.extra != 'undefined' && g.extra == 1) {
			apps = AP.render(g.apps, function(app) {
				return getExtApp(app);
			});

			return "<div class='app-group'> <div class='g-header'> <div class='g-title url' data-url=':collapse/2'><em>"+(g.title)+"</em></div> <div class='g-info'>"+(g.desc)+"</div> </div> <div class='g-body'> "+(apps)+" </div> </div>";
		} else {
			apps = AP.render(g.apps, function(app){
				var active = 0;
				if (index == 0 && isCurrent(app)){
					active=1;
				}

				if (typeof app.extra != 'undefined' && app.extra == 1) {
					return getExtApp(app);
				}

				return getApp(app, active);
			});

			return "<div class='app-group'> <div class='g-header'> <div class='g-title url' data-url=':collapse/2'><em>"+(g.title)+"</em></div> <div class='g-info'>"+(g.desc)+"</div> </div> <div class='g-body'> "+(apps)+" </div> </div>";
		}

	};
	
	
	function getApp(app, active){
		var url=app.path+"."+Client.domain;
		if (!app.path){
			url=Client.domain;
		}
					
		return "<a class='item "+(active?'active':'')+"' title='"+(app.title)+"' target='_blank' href='https://"+(url)+"'> <span class='image' data-image='"+(Client.share_url)+"/apps/"+(app.icon)+"'></span> <span class='text ap-xdot'>"+(app.name)+"<em class='ap-xdot'>"+(app.title)+"</em></span> </a>";
	};


	function getExtApp(app){
		if (!app || !app.extapp_export){
			return "";
		}
		
		var url = app.redirect_url;
		if (!app.redirect_url){
			url = Client.domain;
		}

		return "<a class='item target='_blank' href='"+(url)+"'> <span class='image' data-image='"+(Client.share_url)+"/apps/ext/"+(app.extapp_export.appkey)+".png'></span> <span class='text ap-xdot'>"+(app.extapp_export.name)+"<em class='ap-xdot'>"+(app.extapp_export.name)+"</em></span> </a>";
	};
	
	function isCurrent(app){
		if (Client.base && Client.base.app){
			if (Client.base.app == app.path){
				return true;
			}
		}
		
		return false;
	};
	
	
	function setLang(lang){
		UI.ajaxShow();
		AP.post(Base.domain("account")+"/ajax/api/me/edit.language",{lang: lang}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully ...");
			AP.refresh();
		});
	};
	
	
	
};


Base.layout = new function __BaseLayout(){
	this.init = function(){
		$("#base-notis").html("<div class='full-mask' onclick='Base.open()'></div> <div class='close'></div> <div class='list list-notis'> <div class='-arrow'></div> <div class='-title'>ThĂ´ng bĂ¡o</div> <div id='notis-items-w' class='notis-items-w'> <div id='base-notis-scroll' class='notis-scroll'> <div id='base-notis-items'></div> <div class='sep-20'></div> <div class='sep-20'></div> <div class='sep-10'></div> </div> </div> <div class='-more std' onclick='N.ui.loadMore();'>View more notifications</div> </div>");
	
		var appname = "Base platform";
		if (Client.base && Client.base.app){
			appname = Client.base.app;
		}
		
		appname = appname.toUpperCase();
		
		$("#base-xs").after("<div id='ajax-load' class='hidden'><div></div></div> <div id='ajax-load-2'><div> <div class='spinner'> <div class='rect1'></div> <div class='rect2'></div> <div class='rect3'></div> </div> </div> </div> <div id='fb-root'></div> <div id='broot'></div> <div id='droot'></div> <div id='context-menu'> <div id='context-menu-close' onclick='Context.close();'></div> <div id='context-menu-main'> <div class='header hidden'></div> <div class='menu'></div> <div class='footer'></div> </div> </div> <div id='context-general'> <div class='context-close' onclick='Context.gen.close();'></div> <div id='context-items'> <div class='context-close' onclick='Context.gen.close();'></div> </div> <div class='context-main'> </div> </div> <div id='context-tag-canvas'> <div id='context-tag' class='context-tag'></div> <div id='context-tag-bottom' class='context-tag'></div> </div> <div id='canvas-special'><div class='full-mask mask'></div><div class='main'></div></div> <div id='fallback-notis'><div class='wrap'> <div class='image'></div> <div class='title'>--</div> <div class='content'>--</div> <div class='footer'>------</div> </div></div> <div id='audios' style='display:none;'> <audio id='audio1' src='"+(Client.share_url)+"/sounds/1.mp3' preload='auto'></audio> <audio id='audio2' src='"+(Client.share_url)+"/sounds/2.mp3' preload='auto'></audio> <audio id='audio3' src='"+(Client.share_url)+"/sounds/3.mp3' preload='auto'></audio> <audio id='audio4' src='"+(Client.share_url)+"/sounds/4.mp3' preload='auto'></audio> <audio id='audio5' src='"+(Client.share_url)+"/sounds/5.mp3' preload='auto'></audio> <audio id='audio6' src='"+(Client.share_url)+"/sounds/6.mp3' preload='auto'></audio> <audio id='audioringing' src='"+(Client.share_url)+"/sounds/ringing.mp3' preload='auto'></audio> </div> <div id='flash-msg' class='flash-msg ap-xdot'></div> <div id='notification-request' class='hidden'> <div class='main'> <div class='text'> <div class='in'><b>Base Platform</b> cáº§n sá»± cho phĂ©p cá»§a báº¡n Ä‘á»ƒ kĂ­ch hoáº¡t há»‡ thá»‘ng thĂ´ng bĂ¡o thá»i gian thá»±c (Desktop notification) cho á»©ng dá»¥ng <b>"+(appname)+"</b></div> </div> <div class='ok'>Tiáº¿p tá»¥c</div> </div> </div> <div id='ob'> <div class='fullmask' onclick='OB.quickClose();'></div> <div class='__canvas'> <div id='obmain'></div> </div> </div> <div id='bcanvas' class='bcanvas'> <div class='eclose' onclick='BC.unextend();' title='Close preview'><span class='-ap icon-close'></span></div> <div class='-in'> <div class='close' onclick='BC.hide();'><span class='-ap icon-close'></span></div> <div class='__main'> <div class='__titlew'> <div class='__title with-image'></div> </div> <div class='__full full'></div> <div class='__content'> <div class='__canvas canvas'></div> </div> </div> <div class='side __sidew'> <div id='bside' data-autoscroll='1'> <div class='sideapp __side'> </div> </div> </div> </div> </div>");
	};
	
};


Base.file=new function __BaseFileAPI(){
	this.preview=function(id){
		return FileX.quickPreview(id);
	};
	this.previewNoDownload = function(id) {
		return FileX.quickPreviewNoDownload(id);
	};	
	/**
	 * @desc Preview a list of file, whereas first_id is the first ID to be shown
	 */
	this.previewList=function(files, first){
		FileX.previewList(files, first);
	};
	
	
	this.previewMultiples=function(parent, selector){
		var list=[];
		
		$(parent).on("click", selector, function(){
			FileX.quickPreview($(this).data("file"), {filter: selector, container: parent});
		});
		
		
	};
	
	
	this.download=function(name, fid, download_url){
		if (typeof(fid) == 'undefined' && typeof(download_url) != 'undefined') {
			return download_url;
		}
		return Base.domain("api")+"/files/download?fid="+fid+"&name="+name
	};
		
	
	
	/**
	 * @desc Embed file preview within a canvas
	 */
	this.embed=function(url, canvas){
		$(canvas).html(this.inline(url));
	};
	
	this.inline=function(url){
		var is_image=0;
		var ext = AP.fileExt(url);
		if (ext=="jpg" || ext=="png" || ext=="bmp"){
			is_image=1;
		}
		
		var file={name: url, src: url, image: is_image};
		return FileX.ui.getMain(file)
	};
	
	this.getHTML=function(url){
		var is_image=0;
		var ext = AP.fileExt(url);
		if (ext=="jpg" || ext=="png" || ext=="bmp"){
			is_image=1;
		}
		
		var file={name: url, src: url, image: is_image};
		return FileX.ui.getMain(file);
	};

	this.getHTMLNoDownload = function(fid) {
		return FileX.ui.getMainNoDownload(fid);
	};};


Base.api=new function __BaseAPI(){
	this.embed=function(url, options){
		options=$.extend({}, {title: "Embed Base app api"}, options);
		
		var token=AP.uuid();
		if (url.indexOf("?")==-1){
			url=url+"?__local_apitoken="+token;
		}else{
			url=url+"&__local_apitoken="+token;
		}
		
		// var cors_params ="base_domain="+(Client.url)+"&base_token="+(AP.postmessage.token())+"";
		// url=url+"&"+cors_params
		
		if (url.indexOf("exchange_token")==-1){
			var ext=Base64.encodeURI(JSON.stringify({
				ts: AP.time.now(),
				base_domain:Client.url,
				base_token:AP.postmessage.token()
			}));
			
			url=url+"&exchange_token="+ext;
		}
		
		var h=$(window).height()-150;
		if (h<200){
			h=200;
		}
		
		var html="<div class='embed-title'> <span>"+(options.title)+"</span> <div class='embed-close' onclick='Base.api.embedClose(this);'><span class='-ap icon-ion-android-close'></span></div> </div> <div id='js-internal-embed' style='height:"+(h)+"px'><iframe style='width:100%; height:100%' frameborder='none' src='"+(url)+"'></iframe></div>";
		
		// if (mobile()){
		// 	return AP.redirect(url);
		// }
		
		AP.customDialog(html,"api-embed")
		.width(options.width)
		.closable(false)
		.style("-full")
		.show();
	};
	
	
	this.embedClose=function(){
		$("#js-internal-embed").remove();
		AP.dialog("api-embed").hide();
	};
	
	this.closeDialog = this.embedClose;
	this.close = this.embedClose;
};



Base.api.msg=new function __BaseAPIMsg(){
	this.events={};
	
	this.pushToFrame=function(event_id, data){
		
	};
	
	this.on=function(event_id, fn){
		this.events[event_id]=fn;
	};
};




// WRAP FOR v2: Base.exchange
Base.exchange = new function __BaseExchange(){
	this.on=function(event, callback){
		return AP.postmessage.register(event, callback);
	};
	
	
	/**
	 * @desc Get URL component
	 * @example <div class='url' ${Base.exchange(opts)}></div>
	 */
	this.url=function(opts){
		opts=$.extend({width: 400, title: "Base exchange", data:{}, params: {}}, opts);
		
		var data={
			__data: opts.data,
			event: opts.event,
			base_domain: Client.url,
			base_token: AP.postmessage.token()
		};
		
		var url=Base64.encodeURI(JSON.stringify(data));
		for (var key in opts.params){
			url+="&"+key+"="+encodeURIComponent(opts.params[key]);
		}
		
		return "data-url=':embed' data-width='"+(opts.width)+"' data-title='"+(opts.title)+"' data-app='"+(opts.app)+"' data-event='"+(opts.event)+"' data-embed='"+(opts.endpoint)+"?exchange_token="+(url)+"'";
	};
	
	
	this.embedURL = function(opts){
		var data={
			__data: opts.data,
			event: opts.event,
			base_domain: Client.url,
			base_token: AP.postmessage.token(),
		};
		
		var url=Base64.encodeURI(JSON.stringify(data));
		for (var key in opts.params){
			url+="&"+key+"="+encodeURIComponent(opts.params[key]);
		}
		
		if (opts.endpoint && opts.endpoint.indexOf("?")!=-1){
			return Base.domain(opts.app)+"/"+opts.endpoint+"&exchange_token="+url
		}else{
			return Base.domain(opts.app)+"/"+opts.endpoint+"?exchange_token="+url	
		}
		
		
	};

	
	/**
	 * @desc Direct request
	 */
	this.request = function(opts){
		opts=$.extend({width: 400, title: "Base exchange", data:{}, params: {}, endpoint: ""}, opts);
		
		var data={
			__data: opts.data,
			event: opts.event,
			base_domain: Client.url,
			base_token: AP.postmessage.token(),
		};
		
		var url=Base64.encodeURI(JSON.stringify(data));
		for (var key in opts.params){
			url+="&"+key+"="+encodeURIComponent(opts.params[key]);
		}
		
		if (opts.postback){
			url+= ('&postback='+opts.postback);
		}
		
		
		Base.api.embed(Base.domain(opts.app)+"/"+opts.endpoint+"?exchange_token="+url, {
			width: opts.width,
			title: opts.title
		});
	};
	
	
	/**
	 * @desc Sending back data, with exchange token, passing data will be sent back too (but not params)
	 */
	this.sendBack=function(data, exchange_token){
		if (!parent){
			return;
		}
		
		if (!exchange_token){
			exchange_token = Query.get("exchange_token");
		}
		
		var pass_obj = this.decode(exchange_token);
		
		if (!pass_obj || !AP.data.isObject(pass_obj)){
			return;
		}
		
		pass_obj.data=$.extend({}, {data: pass_obj.__data}, data);
		
		if (!pass_obj.event){
			pass_obj.event = Query.get("event");	
		}
		
		pass_obj.__exchange=1;
		parent.postMessage(pass_obj, pass_obj.base_domain);
	};
	
	
	
	/**
	 * @desc Decode object
	 */
	this.decode=function(exchange_token){
		var raw = Base64.decode(exchange_token);
		if (!raw){
			return;
		}
		
		try{
			var data=JSON.parse(raw);
			if (!data){
				return null;
			}
			
			return data;
		}catch(e){
			$.log("PARSE_ERROR");
		}
		
	};
	
	
	
	/**
	 * @desc Construct the postback exchange URL
	 */
	this.postback = function(opts){
		if (!opts.app){
			opts.app = Client.base.app;
		}
		
		return Base64.encodeURI(JSON.stringify(opts));
	},
	
	
	this.picker = function(opts){
		opts = $.extend({title: "Base Exchange Picker", data: {}, app: "platform"}, opts);
		opts.params = $.extend({}, {__page_mode: "picker"}, opts.params)
		if ('multi' in opts){
			opts.params.multi = opts.multi;
		}
		
		Base.exchange.request({
			event: "exchange.picker",
			app: opts.app,
			endpoint: opts.action,
			params: opts.params,
			width: opts.width || 900,
			title: opts.title,
			data: opts.data
		});
		
		Base.exchange.on("exchange.picker", function(data){
			opts.callback(data);
		});
	};
	
	
};


Base.picker = new function __BasePicker(){
	
	this.template = function(opts){
		Base.exchange.picker({
			app: "platform",
			action: "picker/template/"+(opts.app)+"/"+(opts.feature)+"",
			callback: opts.callback,
			title: opts.title,
			multi: opts.multi
		});
	};
};


Base.picker.engine = new function __BasePickerHelper(){
	this.picked = [];
	this.opts = [];
	this.exchange_token='';
	this.multi=0;
	
	this.beforeComplete = null;
	
	this.init=function(opts){
		if (!opts){
			opts = {};
		}
		
		this.picked = [];
		this.multi = Query.getInt("multi");
		this.exchange_token = Query.get("exchange_token");
		if (opts.beforeComplete){
			this.beforeComplete = opts.beforeComplete
		}
	};
	
	
	/**
	 * @desc Complete the action
	 */
	this.complete = function(){
		if (this.beforeComplete){
			return this.beforeComplete(this);
		}
		
		return Base.picker.engine.defaultPostBack();
	};
	
	
	/**
	 * @des Send data back to client
	 */
	this.postBack = function(items){
		Base.exchange.sendBack({
			code: 1,
			items: items,
			ts: AP.time.now()
		}, this.exchange_token);
	};
	
	
	this.defaultPostBack = function(){
		return this.postBack(this.picked);
	};
	
	
	this.options = function(opts){
		this.opts = opts;
		showPicked();
		setTimeout(function(){
			$("#picker-main .item").each(function(){
				var id = $(this).find(".cta").data("id");
				if (id && ARR.findObj(Base.picker.engine.picked, id)){
					$(this).addClass("-picked");
				}
			});
		},100);
	};
	
	
	/**
	 * @desc Process picking
	 */
	this.pick = function(ref){
		var $box = $(ref).closest(".item");
		var id = $(ref).data("id");
		
		var contained = ARR.findObj(this.picked, id);
		
		if (contained){
			this.picked = ARR.removeByID(this.picked, id);
			showPicked();
			$box.removeClass("-picked");
			return;
		}
		
		var obj = ARR.findObj(this.opts, id);
		if (!obj){
			return;
		}
		
		if (!this.multi){
			$box.siblings().removeClass("-picked");
			$box.addClass("-picked");
			this.picked = [obj];
			showPicked();
			return;
		}
		
		$box.addClass("-picked");
		this.picked = ARR.insertByID(this.picked, obj);
		showPicked();
		
	};
	
	
	
	function showPicked(){
		var items = Base.picker.engine.picked;
		if (!items.length){
			$("#picker").removeClass("has-items");
			$("#picker-picked").hide();
			return;
		}else{
			$("#picker").addClass("has-items");
			$("#picker-picked").html("<div class='header'> <div class='title'>"+(items.length)+" item(s) selected</div> <div class='cta url' data-url='::base/pickcontinue'>Tiáº¿p tá»¥c</div> </div>").show();
		}
	};
	
};


Base.connect=new function __BaseRequest(){
	this.defs={};
	
	this.def=function(app, type, endpoint, postback){
		if (!postback){
			postback="none";
		}
		
		this.defs[type]={app: app, type: type, endpoint: endpoint, postback: postback};
	};
	
	
	this.dialog=function(types, data){
		var actions=[];
		for (var i=0; i<types.length; i++){
			actions.push({label: types[i], type: types[i], url: this.getURL(types[i], data), icon: "uniF143"})	
		}
		
		AP.actionMenu(actions, {
			title: "Select one connect type"
		});
	};
	
	
	this.getURL=function(type, data){
		if (!this.defs[type]){
			return;
		}
		
		var req=this.defs[type];
		var endpoint=safe(req.endpoint);
		var postback=safe(req.postback);
		endpoint=urlRematch(endpoint, data);
		postback=urlRematch(postback, data);
		
		data=JSON.stringify(data);
		data=Base64.encodeURI(data);
		
		var sig=""+(type)+"."+(endpoint)+"."+(postback)+"."+(data)+"."+(Client.viewer.id)+"";
		sig=md5(sig);
		
		return Base.domain(req.app)+"/home?custom_form=1&app="+Client.base.app+"&type="+safe(type)+"&endpoint="+safe(endpoint)+"&postback="+safe(postback)+"&data="+data+"&signature="+sig;
	};
	
	
	/**
	 * @desc Context-aware data get
	 */
	this.getData=function(callback){
		var app=safe(Query.get("app"));
		var type=Query.get("type");
		var endpoint=Query.get("endpoint");
		var postback=Query.get("postback");
		var data=Query.get("data");
		var id=Client.viewer.id;
		
		var sig=Query.get("signature");
		var test_sign=""+(type)+"."+(endpoint)+"."+(postback)+"."+(data)+"."+(id)+"";
		
		if (sig!=md5(test_sign)){
			return AP.alertError("INVALID SIGNATURE. CANNOT INVOKE BASE CONNECT API");
		}
		
		if (!hasApp(app)){
			return AP.alertError("The app "+app+" is not registered by your system");
		}
		
		var real_data={};
		try{
			real_data=JSON.parse(Base64.decode(data));
		}catch(e){
			
		}
		
		UI.ajaxShow();
		AP.post(Base.domain(app)+"/ajax/"+endpoint, real_data, function(code){
			UI.ajaxHide();
			if (!code.good() || !code.form){
				return AP.alertError(code.message);
			}
			
			callback(code.form);
		});
	};
	
	
	function urlRematch(url, data){
		var str=url;
		for (var key in data){
			str=AP.word.replaceAll('$'+key, data[key], str);
		}
		
		return str;
	};
	
	
	function hasApp(key){
		for (var i=0; i<Client.applist.length; i++){
			if (Client.applist[i].key==key){
				return true;
			}
		}
		
		return false;
	};
};



var Follow=new function __Follow(){
	this.v2=function(opts){
		if (!parseInt(Client.env)){
			$.log("Follow.v2(opts) API:")
			$.log(JSON.stringify({
				origin: "[REQUIRED] object with {hid, token}",
				endpoint: "[REQUIRED] string, ajax endpoint",
				followers: "[OPTIONAL], array of usernames or user ids"
			}));
		}
		
		if (!opts.style && opts.layout){
			opts.style = opts.layout;
		}
		
		return this.auto(opts.canvas, opts);
	};
	
	this.auto=function(canvas, opts){
		if (!$(canvas).length){
			return;
		}
		
		build(canvas, opts);
	};
	
	
	this.html = function(opts){
		return getFollowers(opts);
	};
	
	
	this.embed=function(canvas, opts){
		return this.auto(canvas, opts);
	};
	
	
	this.request=function(username, flag, ref){
		var opts=$(ref).closest(".jsapi-follow").data("opts");
		
		var data=shallowClone(opts.data);
		if (!data){
			data = {};
		}
		
		data.flag=flag;
		data.username=username;
		
		UI.ajaxShow();
		AP.post(opts.endpoint, data, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			opts.followers=code.followers;
			build($(ref).closest(".jsapi-follow"), opts);
		});
	};
	
	
	this.setFollow=function(user, ref){
		var username=user;
		if (AP.data.isObject(user)){
			username=user.username;
		}
		
		if (user=="me"){
			username=Client.viewer.username;
		}
		
		this.request(username, 1, ref);
	};
	
	
	this.setUnfollow=function(user, ref){
		var username=user;
		if (AP.data.isObject(user)){
			username=user.username;
		}
		
		if (user=="me"){
			username=Client.viewer.username;
		}
		
		this.request(username, 0, ref);
	};
	
	
	this.addFollower=function(ref){
		var opts=$(ref).closest(".jsapi-follow").data("opts");
		
		Form.inlineTagger(ref, {
			title: "ThĂªm ngÆ°á»i theo dĂµi",
			search: true,
			users: opts.users,
			select: function(user){
				Follow.setFollow(user, ref);
			},
			position:{
				left:1,
			},
			width: 250,
			click: true
		});
	};
	
	
	
	function build(canvas, opts){
		$(canvas).data("opts", opts).addClass("jsapi-follow");
		opts=$.extend({}, {style:"standard", max_display: 20, followers: [], owners: [], tag: Client.people, data: {}}, opts);
		if (opts.owners && opts.owners.length){
			if (Me.isOwner(opts)){
				opts.admin=1;
			}
		}
		
		if (opts.style){
			$(canvas).addClass("fe-"+opts.style);
		}
		
		if (opts.style=="compact" && opts.max_display > 10){
			opts.max_display=10;
		}
		
		$(canvas).html(getFollowers(opts));
		

		if (opts.admin){
			// follow="<div class='action url' data-url='topic/action/unfollow'>Unfollow</div>";
			$(canvas).find(".js-user").each(function(){
				$(this).data("context.items", [{label: "Remove follower", icon:"blocked", username: $(this).data("username"), action: function(opt, ref){
					Follow.setUnfollow(opt.username, this);
				}}]);
			});
		}
	};
	
	
	function getFollowers(opts){
		var users=AP.render(opts.followers, function(e, index){
			var u=e;
			if (AP.data.isString(u) || AP.data.isInt(u)){
				u=People.get(u);
			}else{
				u=People.get(u.username);
			}
			
			if (opts.style=='list'){
				return "<div class='js-user fe-user url' data-username='"+(u.username)+"'> <div class='image avatar avatar-32 -circled'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='uname'>"+(u.name)+"</div> <div class='uinfo ap-xdot'>"+(u.title||'ChÆ°a cĂ³ vá»‹ trĂ­')+"</div> </div>";
			}else if (opts.style=='inline'){
				return "<span class='js-user fe-user url' data-username='"+(u.username)+"'><span class='uname'>"+(u.name)+"</span></span>, ";
			}
			
			return "<div class='js-user fe-avatar avatar avatar-32 -circled url' data-username='"+(u.username)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> </div>";
		});
		
		if (opts.style=="inline"){
			if (users.length){
				users="Followed by "+(users)+"";
			}else{
				users="No followers &middot; ";
			}
		}
		
		var follow="<div class='fe-action url is-follow' onclick='Follow.setFollow(\"me\",this);'>Theo dĂµi</div>";
		if (opts.style=="inline"){
			follow="<div class='fe-action url is-follow' onclick='Follow.setFollow(\"me\",this);'>Theo dĂµi</div>";
		}
		
		if (Me.isFollower(opts)){  
			follow="<div class='fe-action url is-unfollow' onclick='Follow.setUnfollow(\"me\",this);'>Bá» theo dĂµi</div>";
		}
		var actions=follow;
		
		if (opts.admin){
			actions="<div class='fe-action is-add-follower url' onclick='Follow.addFollower(this);'>ThĂªm ngÆ°á»i theo dĂµi</div>" + follow;
		}
		
		if (opts.style=="standard"){
			return "<div class='fe-title'> <div class='fe-label'>"+(opts.followers.length)+" people followed</div> <div class='fe-side'>"+(actions)+"</div> </div> <div class='fe-users'>"+(users)+"</div>";
		}else if (opts.style=='inline'){
			var _icon = '';
			if (opts.icon){
				_icon = "  " +Render.render('icon', {icon:opts.icon, icon_color:opts.icon_color||''}, '')+ '';
			}
			
			return ""+(_icon)+"<div class='fe-users inline'>"+(users)+" <div class='fe-actions inline'>"+(actions)+"</div></div>";
		}else{
			return "<div class='fe-users clear-fix'> <div class='fe-label hidden'>"+(opts.followers.length)+" people followed</div> "+(users)+" <div class='fe-actions'>"+(actions)+"</div> </div>";
		}
		
		
	};
};


Base.notis_opt=new function __BaseNotisOpt(){
	this.settings=function(){
		var url=Base.domain("account")+"/ajax/api/me/email.notis";
		
		var ui=UI.setting("Tuá»³ chá»‰nh email thĂ´ng bĂ¡o");
		for (var key in Client.email_options){
			var opt=Client.email_options[key];
			ui.add({
				title: opt.name,
				options: {"yes": "CĂ³", "no": "KhĂ´ng"},
				value: opt.value,
				name: opt.key,
				url: url
			});	
		};
		
		ui.callback(function(code, key, value){
			Client.email_options[key].value=value;
		})
		.show();
		
		// Base.toggle("apps");
	};
};


function BaseTree(opts){
	this.nodes=null;
	this.fnodes=null;
	this.root=null;
	this.raw_nodes=[];
	this.opts = opts;
	
	var rnodes={};
	
	
	
	this.init=function(nodes){
		rnodes={};
		this.raw_nodes=nodes;
		
		if (this.root){
			return this.root;
		}
		
		this.build();
		
		var root={name: "The company"};
		root.level=0;
		root.metatype="root";
		root.id=0;
		root.nodes=this.nodes;
		this.root=root;
		
		setLevel(root, 0);
		// this.fnodes.unshift(root);
	};
	
	
	this.build=function(){
		var objs=this.raw_nodes; 
		
		if (!objs){
			return;
		}
		
		for (var i=0; i<objs.length; i++){
			objs[i].nodes=[];
//			objs[i].objs=AP.array.filter(Client.nodes, function(e){
//				return e.node_id==objs[i].id;
//			});
			
			if (!objs[i].parent_id){
				objs[i].parent_id=0;	
			}else{
				objs[i].parent_id=parseInt(objs[i].parent_id);
			}
			
			objs[i].id=parseInt(objs[i].id);
			objs[i].__used=0;
			objs[i].level=1;
			
			if (this.opts && this.opts.type && this.opts.type!=objs[i].type){
				
			}else{
				rnodes["r-"+objs[i].id]=objs[i];
			}
		}
		

		for (var i=0; i<objs.length; i++){
			for (j=0; j<objs.length; j++){
				if (parseInt(objs[j].parent_id)==parseInt(objs[i].id)){
					if (this.opts && this.opts.type && this.opts.type!=objs[i].type){
						
					}else{
						objs[i].nodes.push(objs[j]);
						objs[j].__used=1;
						
						objs[j].parent = objs[i]; 
					}
				}
			}
		}
		
		
		var r=[];
		for (var i=0; i<objs.length; i++){
			if (objs[i].__used){
				
			}else{
				r.push(objs[i]);
			}
		}
		
		this.nodes=r;
		this.flatten();
	};
	
	
	/**
	 * @desc Flatten tree to array, sorted consecutively
	 */
	this.flatten=function(fn){
		r=[];
		for (var i=0; i<this.nodes.length; i++){
			flattenNode(r, this.nodes[i], fn);
		}
		
		
		this.fnodes=r;
		for (var i=0; i<this.fnodes.length; i++){
			// this.fnodes[i].parent=getNodeByID(this.fnodes[i].parent_id);
		}
		
		for (var i=0; i<this.fnodes.length; i++){
			this.fnodes[i].tree_name="---".repeat(this.fnodes[i].level-1)+" "+this.fnodes[i].name;
		}
		
		return this.fnodes;
	};
	
	
	/**
	 * @desc Apply a function for all notes, from left to root
	 */
	this.fn = function(_fn){
		applyAll(this.root, _fn);
	};
	
	
	this.getTraces = function(node){
		var r = [node];
		var temp = node;
		
		while (true){
			if (r.length>=10){
				return r;
			}
			
			if (!temp.parent){
				break;
			}else{
				temp = temp.parent;
				r.push(temp);
			}
		}
		
		return r.reverse();
	};
	
	
	this.fqn = function(node, sep){
		if (!node.traces){
			return node.name;
		}
		
		if (!sep){
			sep = " â€º ";
		}
		
		var _fqn = '';
		for (var i=0; i<node.traces.length; i++){
			_fqn+=node.traces[i].name;
			if (i<node.traces.length-1){
				_fqn+= " "+(sep)+" ";
			}
		}
		
		return _fqn;
	};
	
	
	function flattenNode(collector, node, fn){
		collector.push(node);
		for (var i=0; i<node.nodes.length; i++){
			flattenNode(collector, node.nodes[i], fn);
		}
		
		if (fn){
			fn(node, collector);
		}
	};
	
	
	function applyAll(node, _fn){
		if (node.nodes && node.nodes.length){
			for (var i=0; i<node.nodes.length; i++){
				applyAll(node.nodes[i], _fn);
			}
		}
		
		_fn(node);
	};
	
	
	
	function getNodeByID(id){
		if (rnodes["r-"+id]){
			return rnodes["r-"+id];
		}
		
		return null;
	};
	
	
	function setLevel(node, level){
		node.level=level;
		if (!node.nodes || !node.nodes.length){
			return;
		}
		
		for (var i=0; i<node.nodes.length; i++){
			setLevel(node.nodes[i], level+1);
		}
	};
};



var Viewer = new function _Viewer(){
	
	inherits(this, APViewer);
	
	
	this.hasNetwork=function(network){
		if (AP.data.isArray(network)){
			for (var i=0; i<network.length; i++){
				if (viewerHasNetwork(network[i])){
					return true;
				}
			}
			
			return false;
		}else{
			return viewerHasNetwork(network);
		}
		
	};
	
	
	function viewerHasNetwork(network){
		return AP.array.contain(Client.viewer.networks, network, function(e, f){
			if (AP.data.isInt(e) && AP.data.isInt(f)){
				return parseInt(e)==parseInt(f);
			}
			
			return parseInt(e.id)==parseInt(f.id);
		});
	};
	

};


var TagManager=new function __TagManager(){
	this.endpoint="api/tagmanager";
	this.callback=null;
	
	this.init=function(origin, endpoint){
		this.origin=origin;
		this.tags=origin.tags;
		if (endpoint){
			this.endpoint=endpoint;
		}else{
			this.endpoint="api/tagmanager";
		}
		
		this.callback=null;
	};
	
	
	/**
	 * @desc Show TagManager on dialog
	 */
	this.dialog=function(callback){
		if (callback){
			this.callback=callback;
		}else{
			this.callback=null;
		}
		
		prepareCanvas();
		var canvas="#tagmanager";
		$(canvas).html("<div class='-close' onclick='AP.closeDialog(this);'><span class='-ap icon-close'></span></div> <div class='title'>Manage tags</div> <div class='body' id='js-edit-tags'> <div class='list tags'></div> <div class='tag-add'> <form method='POST' action='#'> <div class='square'><em class='-bg-alt0'></em></div> <input type='hidden' name='color' value='0'> <input type='hidden' name='id' value='"+(TagManager.origin.id)+"'> <div class='ip'> <input type='text' autocomplete='off' name='name' placeholder='ThĂªm nhĂ£n má»›i'/> </div> <div class='submit'>Cáº­p nháº­t</div> </form> </div> </div>");
		
		var context=this.origin;
		buildList();
		
		$(canvas).find("form").attr("action", TagManager.endpoint+"/edit");
		Form.inlineColorTagger($(canvas).find(".tag-add .square"),function(color){
			$(this).closest("form").find("input[name=color]").val(color);
			$(this).closest("form").find("input[name=name]").focus();
			$(this).closest(".square").find("em").removeClass().addClass("-bg-alt"+color);
		},{
			width: 200,
			left: 0
		}); 
		
		$(canvas).find(".tag-add .square em").click(function(){
			$(this).parent().find(".ap-inline-colors").toggle();
		});
		
		
		$(canvas).find(".ip input").click(function(){
			$(this).closest(".tag-add").addClass("active");
		}).enter(function(){
			updateTag(this);
		});
		
		$(canvas).find(".submit").click(function(){
			updateTag(this);
		});
		
		AP.dialog("#custom-tagmanager").balance();
	};
	
	
	this.remove=function(tag){
		AP.confirm("Remove this tag from the list?", function(){
			UI.ajaxShow();
			AP.post(TagManager.endpoint+"/remove",{name: tag, id: TagManager.origin.id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				TagManager.tags=code.tags;
				TagManager.origin.tags=code.tags;
				
				buildList();
				setForm("", "auto");
				
				if (TagManager.callback){
					TagManager.callback(code.tags);
				}
			});
		});
	};
	
	
	this.list=function(tags){
		var html= AP.render(tags, function(t){
			var obj=AP.array.single(TagManager.tags, function(e){
				return purifyStrict(t)==purifyStrict(e.name);
			});
			
			var color=0;
			if (obj){
				color=obj.color;
			}
			
			return "<div class='ui-tag tag-alt"+(color)+"-more' title='"+(t)+"'>"+(t)+"</div>";
		});
		
		return "<div class='ui-tags'>"+(html)+"</div>";
	};
	
	
	this.taggable=function(input, tags, values){
		var $this=$(input);
		var $p=$this.parent();
		var tags_html=AP.render(tags, function(e){
			return "<div class='fi-tag' data-value='"+(e.name)+"' data-color='"+(e.color)+"'> <span class='square -bg-alt"+(e.color)+"'></span> "+(e.name)+" </div>";
		});
		
		if (tags_html && tags_html.length){
			tags_html="<div class='tags_box scroll-y forced-scroll'>"+(tags_html)+"</div>";
		}
		
		$p.find(".fi-tags").remove();
		$p.find(".selected-tags").unbind();
		
		
		tags_html+="<div class='fi-tag js-add-tag'> <span class='add-icon'></span> Add more tag ... </div>";
		
		var cta_html="<div class='none'>Please select tags</div>";
		
		$p.find(".selected-tags").click(function(){
			$(this).closest(".selected-tags-wrapper").addClass("taglist-activated");
			$(this).closest(".__dialogwrapper").addClass("xo");
		});
		
		$p.append("<div class='fi-tags unselectable'> <div class='r' onclick='TagManager.cancel(this);'></div> "+(tags_html)+" </div>");
		
		$this.parent().find(".fi-tag").click(function(){
			if ($(this).hasClass("js-add-tag")){
				TagManager.dialog(function(tags){
					TagManager.taggable(input, tags, value);
				});
				return;
			}
			
			var value=$(this).data(value);
			var color=$(this).data(color);
			if ($(this).hasClass("selected")){
				$(this).removeClass("selected");
			}else{
				$(this).addClass("selected");
			}
			
			syncInputValues($p);
		});
		
		if (values && AP.data.isArray(values) && values.length){
			for (var i=0; i<values.length; i++){
				var v=purifyStrict(values[i]);
				$this.parent().find(".fi-tag").each(function(){
					if (v==purifyStrict($(this).data("value"))){
						$(this).addClass("selected");
					}
				})
			}
			
			syncInputValues($p);
		}
	};
	
	
	this.cancel=function(ref){
		$(ref).closest(".selected-tags-wrapper").removeClass("taglist-activated");
		$(ref).closest(".__dialogwrapper").removeClass("xo");
	};
	
	
	function updateTag(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			TagManager.tags=code.tags;
			TagManager.origin.tags=code.tags;
			
			buildList();
			setForm("", "auto");
			
			if (TagManager.callback){
				TagManager.callback(code.tags);
			}
		});
	};
	
	
	function buildList(){
		var html=AP.render(TagManager.tags, function(e){
			return getTag(e);
		});
		
		if (!TagManager.tags.length){
			html="<div class='no-tag'>No tags here &middot; Enter the tag name in the below form to add</div>";
		}
		
		$("#js-edit-tags").find(".list").html(html);
		
		$("#js-edit-tags").find(".list .remove").click(function(){
			var key=$(this).closest(".tag").data("key");
			TagManager.remove(key);
		});
		
		$("#js-edit-tags").find(".list .js-name").click(function(){
			var key=$(this).closest(".tag").data("key");
			var name=$(this).closest(".tag").data("name");
			var color=$(this).closest(".tag").data("color");
			setForm(name, color);
		});
	};
	
	
	function setForm(name, color){
		if (color && AP.data.isInt(color)){
			$("#js-edit-tags .tag-add input[name=color]").val(color);
			Form.inlineColorTagger("#js-edit-tags .tag-add .square", "set", color);
			$("#js-edit-tags .tag-add .square em").removeClass().addClass("-bg-alt"+color);
		}
		
		$("#js-edit-tags .tag-add input[name=name]").val(name).click();
		setTimeout(function(){
			$("#js-edit-tags .tag-add input[name=name]").focus();
		}, 200);
		
	};
	
	
	function getTag(e){
		return "<div class='tag -bg-alt"+(e.color)+"-less text-alt"+(e.color)+" ap-xdot' data-key='"+(e.key)+"' data-name='"+(e.name)+"' data-color='"+(e.color)+"'> <div class='square -bg-alt"+(e.color)+"'></div> <span title='"+(e.name)+"' class='js-name name pointer'>"+(e.name)+"</span> <div class='remove' title='Remove this tag'><span class='-ap icon-close'></span></div> </div>";
	};
	
	
	function prepareCanvas(){
		AP.customDialog("<div id='tagmanager' class='tagmanager-dialog'></div>", "custom-tagmanager").addClass("-full").width(420).show();
	};
	
	
	
	function syncInputValues($p){
		var html='';
		var values='';
		
		$p.find(".fi-tag.selected").each(function(){
			var value=$(this).data("value");
			var color=$(this).data("color");
			html+="<span title='"+(value)+"' class='value ap-xdot tag-alt"+(color)+"'><span class='square -bg-alt"+(color)+"'></span>"+(value)+"</span>";
			values+=value+",";
		});
		
		if (!html || !html.length){
			html="<div class='none'>Please select tags</div>";
		}
		
		$p.find(".selected-tags").html(html);
		$p.find("input").val(values);
	};
	
};



Base.tagManager=TagManager;


Base.webhook = new function __BaseWebhook() {

	this.manage = function(opts, callback) {
		opts=$.extend({title: "Manage webhooks", webhooks: {}, transformers: []}, opts);
		
		var obj=opts.origin;
		var st="";
		
		if (!obj.webhooks){
			obj.webhooks={};
		}
		
		if (obj.webhooks.server_token){
			st=obj.webhooks.server_token;
		}
		
		var data={id: obj.id, hid: obj.hid, token: obj.token, events: opts.events.join(",")};
		
		var form=Form.create('fly-webhook-fx',{'action': "api/webhook/update"})
		.row(
			Form.label({label: "Linked to",sublabel: ""}),
			Form.input({name: 'job_name', type: "fake"}).value(obj.name)
		);
		
		for (var i=0; i<opts.events.length; i++){
			var ev=opts.events[i];
			
			var v=[];
			if (obj.webhooks.events && obj.webhooks.events[ev]){
				v=obj.webhooks.events[ev];
				// v=v.join("<br><br>");
			}
			
			form.row(
				Form.label({label: "Webhook <code>"+ev+"</code>",sublabel: ""}),
				Form.input({name: "event-"+(ev)+"", type:"lines", placeholder:"Enter webhook URL and press Enter", role:"simple"}).css({height: 110}).value(v)
			);
		}
		
		form.rowSep();
		var current_max=2;
		if (obj.webhooks && obj.webhooks.transformers && obj.webhooks.transformers.length){
			current_max=obj.webhooks.transformers.length;
			
			for (var i=0; i<obj.webhooks.transformers.length; i++){
				var t=obj.webhooks.transformers[i];
				form.row(
					Form.label({label: "Transformer <code>"+(i+1)+"</code>",sublabel: ""}),
					Form.inputGroup([
						Form.input({name: "transform-"+(i)+"", type:"text", placeholder:"Final key"}).value(t.key),
						Form.input({name: "transform-org-"+(i)+"", type:"text", placeholder:"Original key"}).value(t.value)
					])
				).addClass("js-transformer");
			}	
		}else{
			form.custom("<div class='link center a std normal js-ts-link'>Add webhook transformers</div>");
			
			for (var i=0; i<current_max; i++){
				form.rowHidden(
					Form.label({label: "Transformer <code>"+(i+1)+"</code>",sublabel: ""}),
					Form.inputGroup([
						Form.input({name: "transform-"+(i)+"", type:"text", placeholder:"Final key"}),
						Form.input({name: "transform-org-"+(i)+"", type:"text", placeholder:"Original key"})
					])
				).addClass("js-transformer js-initial");
			}	
		}
		
		
		for (var i=current_max; i<50; i++){
			form.rowHidden(
				Form.label({label: "Transformer <code>"+(i+1)+"</code>",sublabel: ""}),
				Form.inputGroup([
					Form.input({name: "transform-"+(i)+"", type:"text", placeholder:"Final key"}),
					Form.input({name: "transform-org-"+(i)+"", type:"text", placeholder:"Original key"})
				])
			).addClass("js-transformer");
		}
		
		
		form.rowSep()
		.row(
			Form.label({label: "Shared URL secret",sublabel: "The shared server_token"}),
			Form.input({name: 'server_token', type: "text", placeholder: "webhook shared server_token"}).value(st)
		);
		
		if (opts.create){
			var create_url=Base.domain(Client.base.app)+"/webhook/"+opts.create;
			
			form.rowSep()
			.row(
				Form.label({label: "Create API endpoint",sublabel: "URL endpoint for creating action"}),
				Form.input({name: 'create_api_endpoint', type: "textarea"}).value(create_url).css({height: 100}).readOnly()
			);
		}else if (opts.endpoints){
			for (var key in opts.endpoints){
				var ep = opts.endpoints[key];
				var url = Base.domain(Client.base.app)+"/webhook/"+ (ep.url||ep.action);
				
				form.rowSep()
				.row(
					Form.label({label: ep.name, sublabel: ep.content||ep.name}),
					Form.input({name: purifyStrict(ep.name), type: "textarea"}).value(url).css({height: 100}).readOnly()
				);	
			}
		}	
		
		form.buttons([
			 {label: "Save", action: function(){
				 Form.submit("#fly-webhook-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }

					 if (callback) callback(code);
					 
					 if (opts.refresh){
						 AP.refresh();	 
					 }else{
						 AP.xRefresh();
					 }
					 
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y bá»", action: function(){
				 Form.hide("fly-webhook-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.render(function(f){
			$("#fly-webhook-fx .js-ts-link").click(function(){
				$(this).parent().hide();
				$("#fly-webhook-fx .js-initial").show();
			});
			
			$("#fly-webhook-fx .js-transformer input").click(function(){
				var $row=$(this).closest(".row");
				var $next=$row.next();
				if ($next.length && $next.hasClass("js-transformer")){
					$next.show();
				}
			});
		})
		.hiddens(data);
	
		Form.pop({width: 720, label: opts.title}).setForm(form).show();
	};
	
	
	this.list = function(obj, canvas) {
		
	};


	this.showLogs = function(obj) {

		var hid = obj.hid;
		var source_object_id = obj.id;
		var source_object_type = obj.type;
		var source_appkey = Client.base.app;

		Base.webhook.loadLogs(hid, source_object_id, source_object_type, source_appkey, function(logs) {

			var form = Form.create('fly-webhook-log-fx', {'action': "api/job/log.detail"})
			.rowHTML("<div class='log-info'><em>Webhook tá»«: "+ obj.name + "</em> " + "</div>");

			if (logs.length) {
				for (var i = 0; i < logs.length; i++) {
					form
					.row(
		                Form.noLabel(),
		                Form.input({name: 'new', type: 'fake'}).value(getHTMLLog(logs[i]))
		            );
				}
			} else {
				form
	        	.rowHTML("<div class='row-subtitle error'>KhĂ´ng cĂ³ logs</div>");
			}

			form
			.render(function() {
				$("#fly-webhook-log-fx").addClass("list-webhook-logs");
				$("#fly-webhook-log-fx .input .input-fake").addClass("noafter").removeClass("ap-xdot").css('overflow','hidden');
			});
		
			Form.pop({width: 600, label: 'Lá»‹ch sá»­ webhook', layout:'flat'}).setForm(form).show();
		});
	};


	this.loadLogs = function(hid, source_object_id, source_object_type, source_appkey, callback, error_handler) {

		AP.post("api/webhooklog/load", {'hid': hid, 'source_object_id': source_object_id, 'source_object_type': source_object_type, 'source_appkey': source_appkey}, function(code) {

			if (!code.good()) {
				if (error_handler) {
					error_handler(code);
				}
				return;
			}

			callback(code.logs);
		});
	};


	function getHTMLLog(log) {

		if (parseInt(log.status)) {
			var icon = "<div class='icon -good'><span class='-ap icon-done'></span></div>";

			var open_object_link = "data-url='"+(log.data.webhook_object_link)+"'";
			var open_container_link = "data-url='"+(log.data.webhook_container_link)+"'";

			if (log.webhook_appkey == Client.base.app) {

				var array_webhook_object_link = AP.word.split(":/", log.data.webhook_object_link);
				if (array_webhook_object_link.length) {
					open_object_link = "onclick='Base.webhook.openNewTab(\""+(array_webhook_object_link[1])+"\")'";
				}

				var array_webhook_container_link = AP.word.split(":/", log.data.webhook_container_link);
				if (array_webhook_container_link.length) {
					open_container_link = "onclick='Base.webhook.openNewTab(\""+(array_webhook_container_link[1])+"\")'";
				}
			}

			return "<div class='li' id='js-kr-"+(log.id)+"'> <div class='time'> <span class='d'>"+(AP.time.time('%M %d', log.since))+"</span> <span class='h'>"+(AP.time.time('%H:%i', log.since))+"</span> </div> "+(icon)+" <div class='name url' "+(open_object_link)+"><b>"+(log.data.webhook_object_name)+"</b></div> <div class='info url' "+(open_container_link)+"><b>["+(AP.word.upper(log.webhook_appkey))+"] "+(log.data.webhook_container_name)+"</b></div> </div>";
		} else {

			var icon = "<div class='icon -bad'><span class='-ap icon-close'></span></div>";

			if (log.webhook_container_id) {

				var open_container_link = "data-url='"+(log.data.webhook_container_link)+"'";

				if (log.webhook_appkey == Client.base.app) {

					var array_webhook_container_link = AP.word.split(":/", log.data.webhook_container_link);
					if (array_webhook_container_link.length) {
						open_container_link = "onclick='Base.webhook.openNewTab(\""+(array_webhook_container_link[1])+"\")'";
					}
				}

				return "<div class='li' id='js-kr-"+(log.id)+"'> <div class='time'> <span class='d'>"+(AP.time.time('%M %d', log.since))+"</span> <span class='h'>"+(AP.time.time('%H:%i', log.since))+"</span> </div> "+(icon)+" <div class='name'><b>LĂ½ do tháº¥t báº¡i: "+(log.data.webhook_failed_reason)+"</b></div> <div class='info url' "+(open_container_link)+"><b>["+(AP.word.upper(log.webhook_appkey))+"] "+(log.data.webhook_container_name)+"</b></div> </div>";
			} else {
				return "<div class='li' id='js-kr-"+(log.id)+"'> <div class='time'> <span class='d'>"+(AP.time.time('%M %d', log.since))+"</span> <span class='h'>"+(AP.time.time('%H:%i', log.since))+"</span> </div> "+(icon)+" <div class='name'><b>LĂ½ do tháº¥t báº¡i: "+(log.data.webhook_failed_reason)+"</b></div> <div class='info'><b>["+(AP.word.upper(log.webhook_appkey))+"] INVALID CONTAINER</b></div> </div>";
			}
		}
	};


	this.openNewTab = function(path) {
		window.open(Client.url + path, '_blank');
    };
};


Base.filter = function(opts) {

	opts = $.extend({}, {canvas: "#page", handler: "#js-filter-button"}, opts);
	
	$("#js-master-filters .js-close").click(function() {
		$("#js-master-filters").hide("slide", {direction:"right"}, 200);
	});
	
	$("#js-master-filters .js-submit").click(function() {
		updateFilters(this);
	});
	
	setTimeout(function() {
		setValues();
	},100);
	
	$(opts.handler).click(function() {
		$("#js-master-filters").show("slide", {direction:"right"}, 200);
	});
	
	
	function updateFilters(ref) {
		var data = assoc($("#js-master-filters :input").serializeArray());
		for (var key in data) {
			if (data[key] === "") {
				data[key] = null;
			}
		}

		data["page"] = null;
		
		AP.setURLParams(data, true);
	};
	
	
	function setValues() {

		// Setting current value
		var active = 0;
		$("#js-master-filters :input").each(function() {
			var name = $(this).attr("name");
			var v = Query.get(name);
			if (v === null || v === "") {
				return;
			}
			
			active++;
			$(this).val(v);
		});
		
		if (active) {
			$(opts.handler).addClass("active").html("Filters ("+active+")");
		}
		
		Form.render("#js-master-filters");
	};
};


var Me=new function __Me(){
	this.isManagerOf=function(user){
		if (!user.manager || !user.manager.length){
			return false;
		}
		
		return AP.array.exist(user.manager, Client.viewer.username);
	};
	
	this.isManagedBy=function(user){
		var username=user;
		if (AP.data.isObject(user)){
			username=user.username;
		}
		
		if (!Client.viewer.manager || !Client.viewer.manager.length){
			return false;
		}
		
		return AP.array.exist(Client.viewer.manager, username);
	};
	
	this.shareManager=function(user){
		if (!user.manager || !user.manager.length){
			return false;
		}
		
		if (!Client.viewer.manager || !Client.viewer.manager.length){
			return false;
		}
		
		for (var i=0; i<user.manager.length; i++){
			if (Me.isManagedBy(user.manager[i])){
				return true;
			}
		}
		
		return false;
	};
	
	
	this.sameManager=this.shareManager;
	
	
	this.isSystemOwner=function(){
		if (!Client.system || !Client.system.id){
			return false;
		}
		
		return parseInt(Client.viewer.role) == 13;
	};
	
	this.isSystemAdmin=function(){
		var obj=Network.get(Client.system.root_network_id);
		return (obj && (parseInt(obj.role)==Role.ADMIN || parseInt(obj.role)==Role.OWNER));
	};
	
	this.isNetworkOwner=function(network){
		var obj=null;
		
		if (AP.data.isString(network)){
			obj=Network.getByPath(network);
		}else{
			obj=Network.get(network.id);	
		}
		return (obj && parseInt(obj.role)==Role.OWNER);
	};
	
	this.isNetworkAdmin=function(network){
		if (!network){
			if (Client.pageData.network){
				network=Client.pageData.network;
			}else{
				network=Company.getRootNetwork();	
			}
		}
		
		if (!network){
			return false;
		}
		
		var obj=network;
		if (AP.data.isInt(network)){
			obj=Network.get(network);	
		}
		
		
		return (obj && (parseInt(obj.role)==Role.ADMIN || parseInt(obj.role)==Role.OWNER));
	};
	
	
	
	this.isFollower=function(obj){
		if (!obj){
			return false;
		}
		
		for (var i=0; i<obj.followers.length; i++){
			if (AP.data.isString(obj.followers[i])){
				if (obj.followers[i]==Client.viewer.username){
					return true;
				}
			}else{
				if (obj.followers[i].username==Client.viewer.username){
					return true;
				}	
			}
		}
		
		return false;
	};
	
	
	this.isOwner=function(obj){
		if (!obj || !obj.owners){
			return false;
		}
		
		for (var i=0; i<obj.owners.length; i++){
			if (AP.data.isString(obj.owners[i]) && obj.owners[i]==Client.viewer.username){
				return true;
			}
			
			if (obj.owners[i].username==Client.viewer.username){
				return true;
			}
		}
		
		return false;
	};
	
	
	this.isWatcher=function(obj){
		if (!obj || !obj.watchers){
			return false;
		}
		
		for (var i=0; i<obj.watchers.length; i++){
			if (AP.data.isString(obj.watchers[i]) && obj.watchers[i]==Client.viewer.username){
				return true;
			}
			
			if (obj.watchers[i].username==Client.viewer.username){
				return true;
			}
		}
		
		return false;
	};
	
	
	/**
	 * @desc Check if me is among a team owner of obj
	 */
	this.isTeamOwner=function(obj){
		if (!obj){
			return false;
		}
		
		for (var i=0; i<obj.teams.length; i++){
			if (AP.array.contain(Client.viewer.networks, obj.teams[i])){
				return true;
			}
		}
		
		return false;
	};
	
	
	this.isAppAdmin=function(appkey){
		if (!appkey && Client.base){
			appkey=Client.base.app;
		}
		
		if (Me.isSystemOwner()){
			return true;
		}
		
		if (AP.array.single(Client.viewer.sas, function(app){
			return app==appkey || app==appkey+".admin";
		})){
			return true;
		}
		
		return false;
	};
	
	
	this.isAssigned=function(obj){
		return (parseInt(Client.viewer.id)==parseInt(obj.assign_to));
	}
	
	
	this.isCreator=function(obj){
		if (!obj || !obj.user_id){
			return;
		}
		return (parseInt(Client.viewer.id)==parseInt(obj.user_id));
	}
	
	this.findObject=function(objs){
		for (var i=0; i<objs.length; i++){
			if (AP.data.isString(objs[i])){
				if (objs[i]==Client.viewer.username){
					return objs[i];
				}
			}else{
				if (objs[i].username==Client.viewer.username){
					return objs[i];
				}	
			}
		}
		
		return null;
	};
	
	
	this.getDirectReports=function(user){
		return AP.array.filter(Client.people, function(e){
			return AP.array.contain(e.manager, user.username);
		});
	};
	
	
	this.getManagers=function(){
		return People.collect(Client.viewer.manager);
	};
	
	
	this.join=function(hid, token){
		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n tham gia nhĂ³m nĂ y?", function(){
			AP.post("api/network/member/join",{hid: hid, token: token}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("Báº¡n Ä‘Ă£ tham gia nhĂ³m!", function(){
					AP.refresh();
				});
			});
		});
	};
	
	
	this.favor=function(obj){
		return AP.array.contain(Client.favors, obj, function(elem, xobj){
			if (AP.data.isInt(elem)){
				return elem && elem==xobj.id;
			}
			return (elem && elem.hid && elem.hid==xobj.hid);
		});
	};
	
	
	this.setFavorite=function(id, callback){
		var data={};
		var identify=id;
		if (AP.data.isObject(id)){
			identify=id.hid;
			data={'id': id.id, hid: id.hid, token: id.token, object: 1};
		}else{
			data={id: id};
		}
		
		UI.ajaxShow();
		AP.post("api/me/favorite", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.favors=code.favors;
			if (AP.data.isObject(id)){
				Menu.buildFavorLists();
			}
			
			AP.fire("favor-"+identify);
			
			if (callback){
				callback(code.favors);	
			}
		});
	};
	

	
	this.getFavorites=function(){
		var r=[];
		for (var i=Client.favors.length-1; i>=0; i--){
			var id=Client.favors[i];
			if (AP.data.isObject(id)){
				r.push(id);
			}else{
				var team=Network.get(id);
				if (team){
					r.push(team);
				}	
			}
		};
		return r;
	};
	
	
	
	this.arrangeFavorites=function(id, callback){
		var teams=this.getFavorites();
				
		var options=[];
		for (var i=0; i<teams.length; i++){
			if (teams[i].ref && teams[i].ref==1){
				options.push({id: teams[i].hid, "label": teams[i].name, sublabel: teams[i].type+"", data: teams[i]});
			}else{
				options.push({id: teams[i].id, "label": teams[i].name, "sublabel": "/"+teams[i].path+"", data: teams[i]});
			}
		}
		
		
		UI.reorder(options, "api/me/favorite.reorder").callback(function(id, ord, code){
			Client.favors=code.favors;	
			Menu.buildFavorLists();
		},{"title":"Sáº¯p xáº¿p láº¡i má»¥c Æ°a thĂ­ch"});
	
	};
	
	
	this.removeFavorite=function(id, callback){
		var identify=id;
		if (AP.data.isObject(id)){
			identify=id.hid;
			data={hid: id.hid, token: id.token, object: 1};
		}else{
			data={id: id};
		}
		
		AP.post("api/me/favorite", {id: id, 'remove': 1}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.favors);
			AP.fire("unfavor-"+identify);
		});
	};
	
	
	this.logout=function(){
		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n Ä‘Äƒng xuáº¥t ngay bĂ¢y giá»?", function(){
			Base.pref().destroy();
			return AP.redirect("a/logout?token="+Client.viewer.token);
		});
	};
	
	this.chooseColor=function(){
		var form=Form.create('color-fx',{'action':'api/me/color'})
		.row(
			Form.label({label: "HĂ£y lá»±a chá»n má»™t mĂ u cĂ¡ nhĂ¢n hĂ³a cho riĂªng báº¡n<br><br>"}),
			Form.input({name: 'color', type:"colors", options:[
				{value:"1", label: "<div class='square box-alt1'><div class='square-in'></div></div>"},
				{value:"2", label: "<div class='square box-alt2'><div class='square-in'></div></div>"},
				{value:"3", label: "<div class='square box-alt3'><div class='square-in'></div></div>"},
				{value:"4", label: "<div class='square box-alt4'><div class='square-in'></div></div>"},
				{value:"5", label: "<div class='square box-alt5'><div class='square-in'></div></div>"},
				{value:"6", label: "<div class='square box-alt6'><div class='square-in'></div></div>"},
				{value:"7", label: "<div class='square box-alt7'><div class='square-in'></div></div>"},
				{value:"8", label: "<div class='square box-alt8'><div class='square-in'></div></div>"}
            ]}).value(Client.viewer.color)
		)
		.buttons([
		     {label: "LÆ°u láº¡i", action: function(){
		    	 Form.submit("color-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 if (Client.native){
		    			 Cache.set("color", code.color);
		    		 }
		    		 
		    		 Form.hide("color-fx");
		    		 UI.flash("Color set ...");
		    		 AP.refresh();
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Bá» qua", action: function(){
		    	 Form.hide("color-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings({block: true});
	
		Form.pop({id:'color-fx-dx', width: 600, label: 'Chá»n mĂ u hiá»ƒn thá»‹'}).setForm(form).show();
	};
	
	
	this.arrangeTeams=function(){
		var options=[];
		for (var i=0; i<Client.networks.length; i++){
			var net=Client.networks[i];
			if (!AP.array.contain(Client.favors, net.id)){
				options.push({id: net.id, "label": net.name, "sublabel": "/"+net.path+""});	
			}
		}
		
		UI.reorder(options, "api/me/network/reorder").callback(function(id, ord){
			var $elem=$("#team-"+id);
			
			if (ord==-1){
				var $base=$elem.prev('.-team');
				
				if ($base && $base.length){
					$elem.insertBefore($base);
				}
			}else{
				var $base=$elem.next('.-team');
				if ($base && $base.length){
					$elem.insertAfter($base);
				}
			}
		});
	};
	
	
	this.chatWith=function(username){
		Chat.peer(username, "", true);
    	Context.hide();
	}
	
	this.addPost=function(){
		var form=Form.create('peer-post-fx',{'action':'api/update/post'})
		.warning("You are creating a <b>How to work with me</b> post. This will be shared to everyone.")
		.row(
			Form.label({label: "How to work with me"}),
			Form.input({name: 'name', "placeholder":"Enter a short title", role: "tag"})
		)
		.row(
			Form.label({label: "Full description"}),
			Form.input({name: 'content', type:'textarea', "placeholder":"The full description"}).css({height: '200px'})
		)
		.hiddens({
			"self":1
		})
		.buttons([
		     {label: "Save post", action: function(){
		    	 Form.submit("peer-post-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 Form.hide("peer-post-fx");
		    		 UI.flash("Message sent");
		    		 
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("peer-mail-fx");
		     }, style:'cancel -rounded -passive-2'}
		]).settings({
			"block": true
		});
	
		
		Form.pop({id:'peer-post-fx-dx', width: 600, label: 'Add How-to-work-with-me'}).setForm(form).show().focus('name');
	};
	
	
	
	this.editOptions=function(){
		
		var options=[];
		
		if(Me.isSystemAdmin() && (Client.system.path == 'daily' || Client.system.path == 'uni')) {
		    options.push({
	            "label":"Edit title and unit info",
	            "icon":"v-card",
	            "action": function(){
	                Me.info.editUnit();
	            }
	        });
		}
		
		options.push({
			"label":"Edit primary account infos",
			"icon":"gear",
			"action": function(){
				Me.info.edit();
			}
		});
		
		
		options.push({
			"label":"Edit about me and other personal infos",
			"icon":"lightbulb",
			"action": function(){
				Me.info.editAdvanced();
			}
		});
		
		options.push({
			"label":"Edit social links (Facebook, Twitter, ...)",
			"icon":"feed",
			"action": function(){
				Me.info.editSocial();
			}
		});
		
		
		AP.actionMenu(options);
	};
	
	
	this.editUnitOptions=function(){
        var options=[];
        
        if(Me.isSystemAdmin() && (Client.system.path == 'daily' || Client.system.path == 'uni')) {
            options.push({
                "label":"Edit title and unit info",
                "icon":"v-card",
                "action": function(){
                    Me.info.editUnit();
                }
            });
        }
        AP.actionMenu(options);
    };
	
	this.profileInit=function(){
		if (Client.pageData.user && Client.pageData.user.username==Client.viewer.username){
			W.uploadable("#profile-bg-upload","api/me/bgupload", {}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Background updated ...");
				AP.xRefresh();
			});
		}
		
		changeBackground();
//		AP.rtimeout(function(){
//			changeBackground();
//		},10000);
		
	};
	
	this.canPostAnnouncement = function(network) {
	    var settings = "";
	    settings = Client.pageData.settings_team;
        if (settings) {
            var ann_extra = " " + settings.announcement_extra + " ";
            if (ann_extra.indexOf(" " + Client.viewer.username+" ")>= 0){
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
	};
	
	
	this.teamOptions=function(add_none){
		var opts= AP.select(Client.networks, function(e){
			return {label: e.name, value: e.id}
		});
		
		if (add_none){
			opts.unshift({label: "Please select a team", value:0});
		}
		
		return opts;
	};
	
	
	this.delegate=function(){
		var user=Client.viewer;
		var delegate=user.delegate;
		if (!delegate || !delegate.username){
			delegate={username:""};
		}
		
		var form=Form.create('edit-profile-fx',{'action':'api/me/delegate'})
		.row(
			Form.label({label: "Uá»· quyá»n cho",sublabel: ""}),
			Form.input({name: 'username', "placeholder":"GĂµ @ Ä‘á»ƒ tag", role:"tag"}).value("@"+delegate.username)
		)
		.row(
			Form.label({label: "Tá»« ngĂ y",sublabel: ""}),
			Form.input({name: 'sdate', role:"date", placeholder:"Tá»« ngĂ y"}).value(delegate.sdate)
		)
		.row(
			Form.label({label: "Äáº¿n ngĂ y",sublabel: ""}),
			Form.input({name: 'edate', role:"date", placeholder:"Äáº¿n ngĂ y"}).value(delegate.edate)
		)
		.buttons([
			 {label: "Save setting", action: function(){
				 Form.submit("edit-profile-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
				
					 Form.hide("edit-profile-fx");
					 AP.alertSuccess(code.message, function(){
						 AP.refresh();
					 });
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("edit-profile-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id:'edit-fx-dx', width: 450, label: 'Uá»· quyá»n táº¡m thá»i'}).setForm(form).show();
		
	};

	
	
	this.isMemberOf=function(network){
		var obj=null;
		
		if (AP.data.isString(network)){
			obj=Network.getByPath(network);
		}else{
			obj=Network.get(network.id);	
		}
		return (obj!=null);
	};

	
	
	
	
	this.cimg=0;
	
	function changeBackground(){
		if (!Client.pageData.user.bg || !Client.pageData.user.bg.length){
			var image= Client.share_url+"/bg/"+(parseInt(Client.pageData.user.color)%4)+".jpg";
			$("#profile-bg").html("<img src='"+image+"'/>");
			return;
		}
		
		var image=getBackgroundImage();
		$("#profile-bg").html("<img src='"+image+"'/>");
	};
	
	
	function getBackgroundImage(){
		// Me.cimg++;
		if (!Client.pageData.user.bg || !Client.pageData.user.bg.length){
			return Client.share_url+"/bg/"+(parseInt(Client.pageData.user.color)%4)+".jpg";
		}
		
		// Me.cimg=Me.cimg%(Client.pageData.user.bg.length);
		var index=Client.pageData.user.bg.length-1;
		return Client.pageData.user.bg[index];
	};
};


Me.pref=function(key){
	return new PersonalPreference();
};

Base.pref=Me.pref;


function PersonalPreference(){
	/**
	 * @desc Get a preference by its key
	 */
	this.get=function(key, df){
		if (!df){
			df=null;
		}
		
		var obj=AP.log.getObject("_pref");
		if (!obj || obj.id!=parseInt(Client.viewer.id)){
			this.destroy();
			return df;
		}
		
		var rkey="k"+trueKey(key);
		if (rkey in obj){
			return obj[rkey];
		}
		
		return df;
	};
	
	
	/**
	 * @desc Set a preference by its key and value
	 */
	this.set=function(key, value){
		var obj=AP.log.getObject("_pref");
		if (!obj || obj.id!=parseInt(Client.viewer.id)){
			this.destroy();
			obj={id: Client.viewer.id};
		}
		
		obj["k"+trueKey(key)]=value;
		AP.log.setObject("_pref", obj);
		return true;
	};
	
	
	/**
	 * @desc Clear a particular key
	 */
	this.clear = function(key){
		var obj=AP.log.getObject("_pref");
		if (!obj || obj.id!=parseInt(Client.viewer.id)){
			this.destroy();
			obj={id: Client.viewer.id};
			
			return;
		}
		
		if (obj["k"+trueKey(key)]){
			delete obj["k"+trueKey(key)];
		}
		
		AP.log.setObject("_pref", obj);
		return true;
	};
	
	
	/**
	 * @desc Destroy the preference
	 */
	this.destroy=function(){
		if (localStorage){
			localStorage.removeItem("_pref");
		}
	};
	
	
	/**
	 * @desc Get all preferences
	 */
	this.all=function(){
		return obj=AP.log.getObject("_pref");
	};
	
	
	this.flip = function(key){
		var v = this.get(key, null);
		if (v === null || !v || !parseInt(v)){
			this.set(key, 1);
			return 1;
		}else{
			this.set(key, 0);
			return 0;
		}
	};
	
	
	function trueKey(key){
		if (AP.data.isArray(key)){
			return key.join("_");
		}
		
		return key;
	};
	
};


var ACL=new function __ACL(){
	this.getClass=function(acl, key){
		if (acl[key] && parseInt(acl[key])){
			return " enabled";
		}
		
		return " forced-hidden";
	};
};


Base.label = new function __BaseLabel(){
	
	this.user = function(uid){
		var u= People.get(uid);
		return "<span class='url' data-username='"+(uid)+"'>"+(u.name)+"</span>";
	};
	
};


var SVG=new function __SVG(){
	this._edge_icons = {};
	this._groups = {};
	
	this.extends=function(obj){
		for (var key in obj){
			this[key]=obj[key];
		}
	};
	
	
	this.edges = function(obj){
		for (var key in obj){
			this._edge_icons[key] = obj[key];
		}
	};
	
	
	this.group = function(group_name, objs){
		this.extends(objs);
		
		for (var key in objs){
			if (!this._groups[group_name]){
				this._groups[group_name] = [];
			}
			
			this._groups[group_name].push(key);	
		}
	};
	
	
	this.getGroups = function(){
		var __used = {};
		var r = [
			{name: "Default", items: []}
		];
		
		for (var key in this._groups){
			for (var i=0; i< this._groups[key].length; i++){
				__used[this._groups[key][i]] = 1;	
			}
			
			r.push({
				name: key,
				items: this._groups[key]
			});
		}
		
		
		for (var key in this){
			if (this[key] && AP.data.isString(this[key])){
				if (!__used[key]){
					r[0].items.push(key);
				}
			}
		}
		
		if (this._edge_icons){
			r.push({
				name: "Edges",
				items: Object.keys(this._edge_icons),
				edge: 1
			});	
		}
	
		
		return r;
	};
	
	
	this.add=function(obj){
		for (var key in obj){
			this[key]=obj[key];
		}
	};
	
	this.alias = function(main, alias){
		this[alias] = this[main];
	}
	
	this.fa=function(icon){
		return "<span class='ficon-"+(icon)+" ap-f14'></span>";
	};
	
	this.ap=function(icon){
		return "<span class='-ap icon-"+(icon)+" ap-f16'></span>";
	};
	
	
	/**
	 * @desc Get dynamic circular or dognut, directly render as HTML 
	 */
	this.percent = function(opts){
		if (!opts){
			opts = {};
		}
		
		if (AP.data.isInt(opts) || AP.data.isNumber(opts)){
			opts= {percent: opts};
		}
		
		if (!opts.color){
			opts.color = Color.percent(parseFloat(opts.percent));
		}

		opts= $.extend({color: "#FF6200", thickness: 4}, opts);
		
		var percent = parseFloat(opts.percent);
		var dash =""+(percent)+" "+(100-percent)+"";
		
		return "<svg width='100%' height='100%' viewBox='0 0 40 40' class='donut'> <circle class='donut-hole' cx='20' cy='20' r='15.91549430918954' fill='transparent'></circle> <circle class='donut-ring' cx='20' cy='20' r='15.91549430918954' fill='transparent' stroke-width='"+(opts.thickness)+"' stroke='rgba(0,0,0,0.15)'></circle> <circle class='donut-segment' cx='20' cy='20' r='15.91549430918954' fill='transparent' stroke-width='"+(opts.thickness)+"' stroke-dasharray='"+(dash)+"' stroke-dashoffset='-60' stroke='"+(opts.color)+"'></circle> <g class='donut-text'></g> </svg>";
	};
	
	
	this.allIcons = function(prefix){
		
	};
};


SVG.group("base", {
		// LIST OF ICONS
	align_right: "<svg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'><rect width='12' height='1' rx='0.5' transform='matrix(-1 0 0 1 12 3)'/><rect width='12' height='1' rx='0.5' transform='matrix(-1 0 0 1 12 7)'/><rect width='7' height='1' rx='0.5' transform='matrix(-1 0 0 1 12 11)'/></svg>",
	align_left: "<svg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'><rect width='12' height='1' rx='0.5' x='2' y='3'/><rect x='2' y='7' width='12' height='1' rx='0.5'/><rect x='2' y='11' width='8' height='1' rx='0.5'/></svg>",

	arrow_right: "<svg width='5' height='10' viewBox='0 0 5 10' xmlns='http://www.w3.org/2000/svg'><path d='M0.499999 1.20711L4.29289 5L0.499999 8.79289L0.499999 1.20711Z'/></svg>",
	arrow_down: "<svg width='10' height='5' viewBox='0 0 10 5' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' clip-rule='evenodd' d='M5 5L0 0L10 8.74228e-07L5 5ZM7.58579 1L2.41421 1L5 3.58579L7.58579 1Z'/></svg>",
	tag_left: "<svg enable-background='new 0 0 512 512' height='512' viewBox='0 0 512 512' width='512' xmlns='http://www.w3.org/2000/svg'><path d='m367.528 257.61 106.442-144.057c4.787-6.48-.005-15.943-8.043-15.943h-267.126c-2.68 0-5.248 1.076-7.127 2.986l-150 152.417c-3.82 3.881-3.77 10.324.114 14.142l150 147.582c1.87 1.841 4.389 2.872 7.013 2.872h267.127c8.038 0 12.83-9.463 8.043-15.942zm-164.632 140-139.953-137.696 140.047-142.304h243.116l-99.054 134.057c-2.609 3.532-2.609 8.354 0 11.886l99.054 134.058h-243.21z'/></svg>",
	arrow_up: "<svg enable-background='new 0 0 512 512' height='512' viewBox='0 0 512 512' width='512' xmlns='http://www.w3.org/2000/svg'><path d='m462.745 359.117c-.706-1.221 7.473 9.309-184.413-232.698-11.435-18.649-38.623-18.633-49.999.087-183.867 242.355-176.004 231.933-176.351 232.535-11.192 19.387 2.553 43.73 25.381 43.73h360c22.809 0 36.564-24.287 25.382-43.654zm-25.382 23.654h-360c-7.16 0-11.363-7.244-8.312-13.193 183.325-241.705 175.643-231.41 176.251-232.465 3.575-6.193 12.535-6.231 16.123-.014.609 1.054-7.533-9.383 184.292 232.483 2.964 5.906-1.145 13.189-8.354 13.189z'/></svg>",
	send: "<svg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 448.011 448.011' style='enable-background:new 0 0 448.011 448.011;' xml:space='preserve'><g><g><path d='M438.731,209.463l-416-192c-6.624-3.008-14.528-1.216-19.136,4.48c-4.64,5.696-4.8,13.792-0.384,19.648l136.8,182.4 l-136.8,182.4c-4.416,5.856-4.256,13.984,0.352,19.648c3.104,3.872,7.744,5.952,12.448,5.952c2.272,0,4.544-0.48,6.688-1.472 l416-192c5.696-2.624,9.312-8.288,9.312-14.528S444.395,212.087,438.731,209.463z'/></g></g></svg>",
	
	
	base_comment: "<svg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 512 512' style='enable-background:new 0 0 512 512;' xml:space='preserve'><g><g><path d='M448,0H64C28.704,0,0,28.704,0,64v288c0,35.296,28.704,64,64,64h104.512l75.2,90.24c3.008,3.616,7.456,5.728,12.128,5.76 c0.064,0,0.128,0,0.16,0c4.64,0,9.056-2.016,12.096-5.504L346.528,416H448c35.296,0,64-28.704,64-64V64 C512,28.704,483.296,0,448,0z M480,352c0,17.632-14.368,32-32,32H339.2c-4.64,0-9.056,2.016-12.096,5.504l-70.88,81.792 l-67.936-81.536c-3.04-3.648-7.552-5.76-12.288-5.76H64c-17.632,0-32-14.368-32-32V64c0-17.632,14.368-32,32-32h384 c17.632,0,32,14.368,32,32V352z'/></g></g><g><g><path d='M272,224H144c-8.832,0-16,7.168-16,16c0,8.832,7.168,16,16,16h128c8.832,0,16-7.168,16-16 C288,231.168,280.832,224,272,224z'/></g></g><g><g><path d='M368,128H144c-8.832,0-16,7.168-16,16c0,8.832,7.168,16,16,16h224c8.832,0,16-7.168,16-16 C384,135.168,376.832,128,368,128z'/></g></g></svg>",
	base_file: "<svg height='512pt' viewBox='-96 0 512 512' width='512pt' xmlns='http://www.w3.org/2000/svg'><path d='m160 512c-88.234375 0-160-71.765625-160-160v-229.332031c0-8.832031 7.167969-16 16-16s16 7.167969 16 16v229.332031c0 70.59375 57.40625 128 128 128s128-57.40625 128-128v-234.667969c0-47.058593-38.273438-85.332031-85.332031-85.332031-47.0625 0-85.335938 38.273438-85.335938 85.332031v213.335938c0 23.53125 19.136719 42.664062 42.667969 42.664062s42.667969-19.132812 42.667969-42.664062v-208c0-8.832031 7.167969-16 16-16s16 7.167969 16 16v208c0 41.171875-33.496094 74.664062-74.667969 74.664062s-74.667969-33.492187-74.667969-74.664062v-213.335938c0-64.679687 52.628907-117.332031 117.335938-117.332031 64.703125 0 117.332031 52.652344 117.332031 117.332031v234.667969c0 88.234375-71.765625 160-160 160zm0 0'/></svg>",
	base_money: "<svg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 512 512' style='enable-background:new 0 0 512 512;' xml:space='preserve'><g><g><path d='M336,16c-85.312,0-176,28.032-176,80v64c0,8.832,7.168,16,16,16c8.832,0,16-7.168,16-16v-16.672 C225.952,164.736,282.016,176,336,176s110.048-11.264,144-32.672V160c0,15.648-39.36,40.608-113.344,46.784 c-8.768,0.704-15.328,8.48-14.592,17.28c0.672,8.352,7.68,14.656,15.904,14.656c0.48,0,0.896-0.032,1.376-0.064 c41.664-3.488,83.168-14.272,110.656-31.776V224c0,13.664-28.992,33.312-82.784,42.816c-8.672,1.536-14.496,9.856-12.96,18.528 c1.376,7.744,8.128,13.216,15.712,13.216c0.928,0,1.888-0.064,2.816-0.256c32.544-5.728,58.592-15.104,77.216-27.008V288 c0,13.664-28.992,33.312-82.784,42.816c-8.672,1.536-14.496,9.856-12.96,18.528c1.376,7.744,8.128,13.216,15.712,13.216 c0.928,0,1.888-0.064,2.816-0.256c32.544-5.728,58.592-15.136,77.216-27.008V352c0,13.664-28.992,33.312-82.784,42.816 c-8.672,1.536-14.496,9.856-12.96,18.528c1.376,7.744,8.128,13.216,15.712,13.216c0.928,0,1.888-0.064,2.816-0.256 c32.544-5.728,58.592-15.136,77.216-27.008V416c0,15.648-39.36,40.608-113.344,46.784c-8.768,0.704-15.328,8.48-14.592,17.28 c0.672,8.352,7.68,14.656,15.904,14.656c0.48,0,0.896-0.032,1.376-0.064C440.352,488.704,512,462.112,512,416V96 C512,44.032,421.312,16,336,16z M336,144c-87.904,0-144-28.448-144-48s56.096-48,144-48s144,28.448,144,48S423.904,144,336,144z' /></g></g><g><g><path d='M176,208C90.688,208,0,236.032,0,288v128c0,51.968,90.688,80,176,80s176-28.032,176-80V288 C352,236.032,261.312,208,176,208z M320,416c0,19.552-56.096,48-144,48S32,435.552,32,416v-16.672 C65.952,420.736,122.016,432,176,432s110.048-11.264,144-32.672V416z M320,352c0,19.552-56.096,48-144,48S32,371.552,32,352 v-16.672C65.952,356.736,122.016,368,176,368s110.048-11.264,144-32.672V352z M176,336c-87.904,0-144-28.448-144-48 s56.096-48,144-48s144,28.448,144,48S263.904,336,176,336z'/></g></g></svg>",
	base_email: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M0 4a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H2a2 2 0 01-2-2V4zm2-1a1 1 0 00-1 1v.217l7 4.2 7-4.2V4a1 1 0 00-1-1H2zm13 2.383l-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 002 13h12a1 1 0 00.966-.739zM1 11.114l4.758-2.876L1 5.383v5.73z'></path></svg>",
	base_phone: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M3.925 1.745a.636.636 0 00-.951-.059l-.97.97c-.453.453-.62 1.095-.421 1.658A16.47 16.47 0 005.49 10.51a16.47 16.47 0 006.196 3.907c.563.198 1.205.032 1.658-.421l.97-.97a.636.636 0 00-.06-.951l-2.162-1.682a.636.636 0 00-.544-.115l-2.052.513a1.636 1.636 0 01-1.554-.43L5.64 8.058a1.636 1.636 0 01-.43-1.554l.513-2.052a.636.636 0 00-.115-.544L3.925 1.745zM2.267.98a1.636 1.636 0 012.448.153l1.681 2.162c.309.396.418.913.296 1.4l-.513 2.053a.636.636 0 00.167.604L8.65 9.654a.636.636 0 00.604.167l2.052-.513a1.636 1.636 0 011.401.296l2.162 1.681c.777.604.849 1.753.153 2.448l-.97.97c-.693.693-1.73.998-2.697.658a17.471 17.471 0 01-6.571-4.144A17.47 17.47 0 01.639 4.646c-.34-.967-.035-2.004.658-2.698l.97-.969zM11 .5a.5.5 0 01.5-.5h4a.5.5 0 01.5.5v4a.5.5 0 01-1 0V1.707l-4.146 4.147a.5.5 0 01-.708-.708L14.293 1H11.5a.5.5 0 01-.5-.5z'></path></svg>",
	base_plus: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M8 3.5a.5.5 0 01.5.5v4a.5.5 0 01-.5.5H4a.5.5 0 010-1h3.5V4a.5.5 0 01.5-.5z'></path><path fill-rule='evenodd' d='M7.5 8a.5.5 0 01.5-.5h4a.5.5 0 010 1H8.5V12a.5.5 0 01-1 0V8z'></path><path fill-rule='evenodd' d='M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z'></path></svg>",
	base_question: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z'></path><path d='M5.25 6.033h1.32c0-.781.458-1.384 1.36-1.384.685 0 1.313.343 1.313 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.007.463h1.307v-.355c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.326 0-2.786.647-2.754 2.533zm1.562 5.516c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z'></path></svg>",
	base_certified: "<svg focusable='false' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69L23 12zm-12.91 4.72l-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48-7.33 7.35z'></path></svg>",
	
	base_run: "<svg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='487.811px' height='487.81px' viewBox='0 0 487.811 487.81' style='enable-background:new 0 0 487.811 487.81;' xml:space='preserve'><g><g id='_x33_6_24_'><g><path d='M150.463,109.521h150.512c3.955,0,7.16-3.206,7.16-7.161c0-3.955-3.205-7.161-7.16-7.161H150.463 c-3.955,0-7.161,3.206-7.161,7.161C143.302,106.315,146.508,109.521,150.463,109.521z'/><path d='M15.853,179.537h150.511c3.955,0,7.161-3.206,7.161-7.161s-3.206-7.16-7.161-7.16H15.853 c-3.955,0-7.161,3.205-7.161,7.16S11.898,179.537,15.853,179.537z'/><path d='M56.258,253.214c0,3.955,3.206,7.162,7.161,7.162H213.93c3.955,0,7.161-3.207,7.161-7.162s-3.206-7.16-7.161-7.16H63.419 C59.464,246.054,56.258,249.259,56.258,253.214z'/><path d='M142.396,336.44H7.161C3.206,336.44,0,339.645,0,343.6s3.206,7.161,7.161,7.161h135.235c3.955,0,7.161-3.206,7.161-7.161 S146.351,336.44,142.396,336.44z'/><path d='M385.729,154.418c21.6,0,39.111-17.513,39.111-39.114s-17.512-39.113-39.111-39.113 c-21.605,0-39.119,17.513-39.119,39.113C346.609,136.905,364.123,154.418,385.729,154.418z'/><path d='M450.066,143.155c-22.459,31.459-52.533,35.102-84.895,15.89c-2.203-1.306-11.977-6.691-14.141-7.977 c-52.061-30.906-104.061-18.786-138.934,30.05c-14.819,20.771,19.455,40.459,34.108,19.93 c18.018-25.232,40.929-32.533,65.986-24.541c-12.83,22.27-24.047,44.405-39.875,75.853 c-15.832,31.448-50.787,56.562-84.374,36.92c-24.235-14.165-46.09,20.651-21.928,34.772 c45.854,26.799,99.619,10.343,127.066-24.493c0.952,0.509,1.958,0.968,3.062,1.354c22.422,7.812,51.814,28.61,60.77,35.981 c8.953,7.371,24.336,44.921,33.471,63.788c11.082,22.893,46.871,6.219,35.748-16.771c-10.355-21.406-27.736-64.129-41.293-74.938 c-10.875-8.669-31.988-24.803-49.895-33.956c12.115-23.466,24.729-46.679,38.008-69.491 c42.328,12.969,82.561-2.308,111.215-42.446C498.996,142.312,464.73,122.624,450.066,143.155z'/></g></g></g></svg>",
	base_info: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' width='48px' height='48px'><path d='M 24 4 C 12.972066 4 4 12.972074 4 24 C 4 35.027926 12.972066 44 24 44 C 35.027934 44 44 35.027926 44 24 C 44 12.972074 35.027934 4 24 4 z M 24 7 C 33.406615 7 41 14.593391 41 24 C 41 33.406609 33.406615 41 24 41 C 14.593385 41 7 33.406609 7 24 C 7 14.593391 14.593385 7 24 7 z M 24 14 A 2 2 0 0 0 24 18 A 2 2 0 0 0 24 14 z M 23.976562 20.978516 A 1.50015 1.50015 0 0 0 22.5 22.5 L 22.5 33.5 A 1.50015 1.50015 0 1 0 25.5 33.5 L 25.5 22.5 A 1.50015 1.50015 0 0 0 23.976562 20.978516 z'/></svg>",
	base_follow: "<svg viewBox='0 0 24 24' ><g><path d='M23.77 15.67c-.292-.293-.767-.293-1.06 0l-2.22 2.22V7.65c0-2.068-1.683-3.75-3.75-3.75h-5.85c-.414 0-.75.336-.75.75s.336.75.75.75h5.85c1.24 0 2.25 1.01 2.25 2.25v10.24l-2.22-2.22c-.293-.293-.768-.293-1.06 0s-.294.768 0 1.06l3.5 3.5c.145.147.337.22.53.22s.383-.072.53-.22l3.5-3.5c.294-.292.294-.767 0-1.06zm-10.66 3.28H7.26c-1.24 0-2.25-1.01-2.25-2.25V6.46l2.22 2.22c.148.147.34.22.532.22s.384-.073.53-.22c.293-.293.293-.768 0-1.06l-3.5-3.5c-.293-.294-.768-.294-1.06 0l-3.5 3.5c-.294.292-.294.767 0 1.06s.767.293 1.06 0l2.22-2.22V16.7c0 2.068 1.683 3.75 3.75 3.75h5.85c.414 0 .75-.336.75-.75s-.337-.75-.75-.75z'></path></g></svg>",
	base_tick: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 19.28125 5.28125 L 9 15.5625 L 4.71875 11.28125 L 3.28125 12.71875 L 8.28125 17.71875 L 9 18.40625 L 9.71875 17.71875 L 20.71875 6.71875 Z'/></svg>",
	base_like: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M6.956 1.745C7.021.81 7.908.087 8.864.325l.261.066c.463.116.874.456 1.012.965.22.816.533 2.511.062 4.51a9.84 9.84 0 01.443-.051c.713-.065 1.669-.072 2.516.21.518.173.994.681 1.2 1.273.184.532.16 1.162-.234 1.733.058.119.103.242.138.363.077.27.113.567.113.856 0 .289-.036.586-.113.856-.039.135-.09.273-.16.404.169.387.107.819-.003 1.148a3.163 3.163 0 01-.488.901c.054.152.076.312.076.465 0 .305-.089.625-.253.912C13.1 15.522 12.437 16 11.5 16v-1c.563 0 .901-.272 1.066-.56a.865.865 0 00.121-.416c0-.12-.035-.165-.04-.17l-.354-.354.353-.354c.202-.201.407-.511.505-.804.104-.312.043-.441-.005-.488l-.353-.354.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581 0-.211-.027-.414-.075-.581-.05-.174-.111-.273-.154-.315L12.793 9l.353-.354c.353-.352.373-.713.267-1.02-.122-.35-.396-.593-.571-.652-.653-.217-1.447-.224-2.11-.164a8.907 8.907 0 00-1.094.171l-.014.003-.003.001a.5.5 0 01-.595-.643 8.34 8.34 0 00.145-4.726c-.03-.111-.128-.215-.288-.255l-.262-.065c-.306-.077-.642.156-.667.518-.075 1.082-.239 2.15-.482 2.85-.174.502-.603 1.268-1.238 1.977-.637.712-1.519 1.41-2.614 1.708-.394.108-.62.396-.62.65v4.002c0 .26.22.515.553.55 1.293.137 1.936.53 2.491.868l.04.025c.27.164.495.296.776.393.277.095.63.163 1.14.163h3.5v1H8c-.605 0-1.07-.081-1.466-.218a4.82 4.82 0 01-.97-.484l-.048-.03c-.504-.307-.999-.609-2.068-.722C2.682 14.464 2 13.846 2 13V9c0-.85.685-1.432 1.357-1.615.849-.232 1.574-.787 2.132-1.41.56-.627.914-1.28 1.039-1.639.199-.575.356-1.539.428-2.59z'></path></svg>",
	base_image: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 2.5 2 C 1.675781 2 1 2.675781 1 3.5 L 1 12.5 C 1 13.324219 1.675781 14 2.5 14 L 13.5 14 C 14.324219 14 15 13.324219 15 12.5 L 15 3.5 C 15 2.675781 14.324219 2 13.5 2 Z M 2.5 3 L 13.5 3 C 13.78125 3 14 3.21875 14 3.5 L 14 10.765625 L 10.496094 7.066406 L 8.542969 9.265625 L 5.53125 6.089844 L 2 10.066406 L 2 3.5 C 2 3.21875 2.21875 3 2.5 3 Z M 11 4 C 10.449219 4 10 4.449219 10 5 C 10 5.550781 10.449219 6 11 6 C 11.550781 6 12 5.550781 12 5 C 12 4.449219 11.550781 4 11 4 Z M 5.554688 7.566406 L 10.707031 13 L 2.5 13 C 2.21875 13 2 12.78125 2 12.5 L 2 11.574219 Z M 10.515625 8.546875 L 14 12.21875 L 14 12.5 C 14 12.78125 13.78125 13 13.5 13 L 12.082031 13 L 9.234375 9.992188 Z'/></svg>",
	
	base_users: "<svg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' clip-rule='evenodd' d='M5.62802 10.5C3.61765 10.5 1.86167 11.6051 0.921528 13.2504C0.78494 13.4894 0.4828 13.5711 0.24668 13.4328C0.0105595 13.2945 -0.0701272 12.9887 0.066461 12.7496C1.17591 10.8081 3.25078 9.5 5.62802 9.5C8.00527 9.5 10.0801 10.8081 11.1896 12.7496C11.3262 12.9887 11.2455 13.2945 11.0094 13.4328C10.7732 13.5711 10.4711 13.4894 10.3345 13.2504C9.39437 11.6051 7.63839 10.5 5.62802 10.5Z' /><path fill-rule='evenodd' clip-rule='evenodd' d='M11.5547 9.5C10.9119 9.5 10.3064 9.62836 9.76905 9.85512C9.51727 9.96137 9.22808 9.84088 9.12312 9.586C9.01816 9.33112 9.13718 9.03836 9.38896 8.93211C10.0471 8.65434 10.7819 8.5 11.5547 8.5C13.3937 8.5 15.0286 9.37613 15.9167 10.7223C16.0682 10.952 16.0071 11.2624 15.7802 11.4158C15.5534 11.5692 15.2467 11.5073 15.0952 11.2777C14.4058 10.2327 13.0924 9.5 11.5547 9.5Z' /><path fill-rule='evenodd' clip-rule='evenodd' d='M5.62778 8C6.7189 8 7.60343 7.10457 7.60343 6C7.60343 4.89543 6.7189 4 5.62778 4C4.53666 4 3.65213 4.89543 3.65213 6C3.65213 7.10457 4.53666 8 5.62778 8ZM5.62778 9C7.26446 9 8.59126 7.65685 8.59126 6C8.59126 4.34315 7.26446 3 5.62778 3C3.9911 3 2.66431 4.34315 2.66431 6C2.66431 7.65685 3.9911 9 5.62778 9Z' /><path fill-rule='evenodd' clip-rule='evenodd' d='M11.5548 7C12.1003 7 12.5426 6.55228 12.5426 6C12.5426 5.44772 12.1003 5 11.5548 5C11.0092 5 10.5669 5.44772 10.5669 6C10.5669 6.55228 11.0092 7 11.5548 7ZM11.5548 8C12.6459 8 13.5304 7.10457 13.5304 6C13.5304 4.89543 12.6459 4 11.5548 4C10.4636 4 9.5791 4.89543 9.5791 6C9.5791 7.10457 10.4636 8 11.5548 8Z'/></svg>",
	base_user: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 7.5 1 C 3.917969 1 1 3.917969 1 7.5 C 1 11.082031 3.917969 14 7.5 14 C 11.082031 14 14 11.082031 14 7.5 C 14 3.917969 11.082031 1 7.5 1 Z M 7.5 2 C 10.542969 2 13 4.457031 13 7.5 C 13 8.839844 12.523438 10.0625 11.734375 11.015625 C 11.304688 9.796875 10.375 8.816406 9.1875 8.332031 C 9.683594 7.875 10 7.222656 10 6.5 C 10 5.125 8.875 4 7.5 4 C 6.125 4 5 5.125 5 6.5 C 5 7.222656 5.316406 7.875 5.8125 8.332031 C 4.625 8.816406 3.699219 9.796875 3.269531 11.015625 C 2.476563 10.0625 2 8.839844 2 7.5 C 2 4.457031 4.457031 2 7.5 2 Z M 7.5 5 C 8.335938 5 9 5.664063 9 6.5 C 9 7.335938 8.335938 8 7.5 8 C 6.664063 8 6 7.335938 6 6.5 C 6 5.664063 6.664063 5 7.5 5 Z M 7.5 9 C 9.199219 9 10.59375 10.207031 10.917969 11.808594 C 9.976563 12.554688 8.792969 13 7.5 13 C 6.207031 13 5.023438 12.554688 4.085938 11.808594 C 4.40625 10.207031 5.800781 9 7.5 9 Z'/></svg>",
	base_company: "<svg width='16' height='16' viewBox='0 0 16 16' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' clip-rule='evenodd' d='M2 1H14V15H2V1ZM1 1C1 0.447715 1.44772 0 2 0H14C14.5523 0 15 0.447715 15 1V15C15 15.5523 14.5523 16 14 16H2C1.44772 16 1 15.5523 1 15V1ZM6 3H4V5H6V3ZM6 7H4V9H6V7ZM4 11H6V13H4V11ZM12 3H10V5H12V3ZM10 7H12V9H10V7ZM12 11H10V13H12V11Z'/></svg>",
	base_code: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M5.854 4.146a.5.5 0 010 .708L2.707 8l3.147 3.146a.5.5 0 01-.708.708l-3.5-3.5a.5.5 0 010-.708l3.5-3.5a.5.5 0 01.708 0zm4.292 0a.5.5 0 000 .708L13.293 8l-3.147 3.146a.5.5 0 00.708.708l3.5-3.5a.5.5 0 000-.708l-3.5-3.5a.5.5 0 00-.708 0z'></path></svg>",
	base_sheet: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 2.5 1 C 1.675781 1 1 1.675781 1 2.5 L 1 12.5 C 1 13.324219 1.675781 14 2.5 14 L 12.5 14 C 13.324219 14 14 13.324219 14 12.5 L 14 2.5 C 14 1.675781 13.324219 1 12.5 1 Z M 2.5 2 L 5 2 L 5 5 L 2 5 L 2 2.5 C 2 2.21875 2.21875 2 2.5 2 Z M 6 2 L 9 2 L 9 5 L 6 5 Z M 10 2 L 12.5 2 C 12.78125 2 13 2.21875 13 2.5 L 13 5 L 10 5 Z M 2 6 L 5 6 L 5 9 L 2 9 Z M 6 6 L 9 6 L 9 9 L 6 9 Z M 10 6 L 13 6 L 13 9 L 10 9 Z M 2 10 L 5 10 L 5 13 L 2.5 13 C 2.21875 13 2 12.78125 2 12.5 Z M 6 10 L 9 10 L 9 13 L 6 13 Z M 10 10 L 13 10 L 13 12.5 C 13 12.78125 12.78125 13 12.5 13 L 10 13 Z'/></svg>",
	base_fx: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 50 50' width='50px' height='50px'><path d='M 28.25 3 C 24.304 3 21.52675 5.9357969 19.59375 9.0917969 C 17.896791 11.861754 16.704915 14.88138 15.779297 18 L 10 18 L 9 20 L 15.220703 20 C 14.711601 21.964316 14.283698 23.954055 13.900391 25.939453 C 13.182391 29.659453 12.573781 33.404891 11.675781 37.087891 C 11.053781 39.639891 10.248875 44.928312 7.171875 45.820312 C 5.462875 46.316313 4.3498125 45.367391 4.7578125 44.650391 C 5.4158125 44.264391 5.8757031 43.591828 5.9707031 42.798828 C 6.0027031 42.683828 6.021 42.578 6 42.5 C 6 41.119 4.881 40 3.5 40 C 2.12 40 1 41.119 1 42.5 C 1 42.5 0.89 47 5.75 47 C 12.284 47 15.248687 39.800719 16.804688 34.511719 C 18.202108 29.761066 18.926354 24.844521 19.953125 20 L 26 20 L 27 18 L 20.398438 18 C 20.941859 15.687351 21.582505 13.394929 22.433594 11.175781 C 23.196594 9.1857812 24.518078 4.8506875 26.830078 4.1796875 C 28.539078 3.6836875 29.652141 4.6335625 29.244141 5.3515625 C 28.582141 5.7395625 28.120297 6.4177969 28.029297 7.2167969 C 27.997297 7.3257969 27.981 7.427 28 7.5 C 28 8.881 29.119 10 30.5 10 C 31.881 10 33 8.881 33 7.5 C 33 7.5 33.11 3 28.25 3 z M 34.544922 18 C 31.631922 18 29.386 21.310234 28 24.490234 L 29.994141 24.789062 C 30.682141 22.929063 31.811578 21 33.267578 21 C 34.843578 21 35.361703 22.410938 35.720703 24.210938 L 36.480469 28 L 36.470703 28 C 36.500555 28.130265 36.5773 28.461596 36.611328 28.609375 L 31.328125 34.515625 C 30.974125 34.198625 30.512 34 30 34 C 28.895 34 28 34.895 28 36 C 28 37.105 28.895 38 30 38 C 30.617 38 31.162297 37.715391 31.529297 37.275391 L 31.535156 37.28125 L 37.162109 30.992188 C 37.291838 31.551135 37.346266 31.786186 37.509766 32.490234 C 38.239766 35.590234 39.279453 38 42.439453 38 C 45.359453 38 47.61 34.689766 49 31.509766 L 47 31.210938 C 46.31 33.070937 45.180703 35 43.720703 35 C 42.140703 35 41.619766 33.589063 41.259766 31.789062 L 40.5 28 C 40.471428 27.874755 40.397691 27.555478 40.365234 27.414062 L 45.669922 21.484375 C 46.023922 21.801375 46.487 22 47 22 C 48.105 22 49 21.105 49 20 C 49 18.895 48.105 18 47 18 C 46.399 18 45.867 18.270453 45.5 18.689453 L 45.492188 18.683594 L 39.814453 25.03125 C 39.6834 24.465779 39.628588 24.224739 39.462891 23.509766 C 38.734891 20.409766 37.696922 18 34.544922 18 z'/></svg>",
	base_marker: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 8 1 C 5.246094 1 3 3.246094 3 6 C 3 6.773438 3.316406 7.621094 3.753906 8.515625 C 4.191406 9.414063 4.761719 10.351563 5.335938 11.207031 C 6.476563 12.921875 7.613281 14.316406 7.613281 14.316406 L 8 14.792969 L 8.386719 14.316406 C 8.386719 14.316406 9.523438 12.921875 10.667969 11.207031 C 11.238281 10.351563 11.808594 9.414063 12.246094 8.515625 C 12.683594 7.621094 13 6.773438 13 6 C 13 3.246094 10.753906 1 8 1 Z M 8 2 C 10.214844 2 12 3.785156 12 6 C 12 6.46875 11.753906 7.246094 11.347656 8.078125 C 10.941406 8.914063 10.386719 9.820313 9.835938 10.65625 C 8.917969 12.03125 8.292969 12.789063 8 13.15625 C 7.707031 12.789063 7.082031 12.03125 6.164063 10.65625 C 5.613281 9.820313 5.058594 8.914063 4.652344 8.078125 C 4.246094 7.246094 4 6.46875 4 6 C 4 3.785156 5.785156 2 8 2 Z M 8 5 C 7.449219 5 7 5.449219 7 6 C 7 6.550781 7.449219 7 8 7 C 8.550781 7 9 6.550781 9 6 C 9 5.449219 8.550781 5 8 5 Z'/></svg>",
	base_lock: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 8 1 C 5.796875 1 4 2.796875 4 5 L 4 6 L 3.5 6 C 2.675781 6 2 6.675781 2 7.5 L 2 12.5 C 2 13.324219 2.675781 14 3.5 14 L 12.5 14 C 13.324219 14 14 13.324219 14 12.5 L 14 7.5 C 14 6.675781 13.324219 6 12.5 6 L 12 6 L 12 5 C 12 2.796875 10.203125 1 8 1 Z M 8 2 C 9.664063 2 11 3.335938 11 5 L 11 6 L 5 6 L 5 5 C 5 3.335938 6.335938 2 8 2 Z M 3.5 7 L 12.5 7 C 12.78125 7 13 7.21875 13 7.5 L 13 12.5 C 13 12.78125 12.78125 13 12.5 13 L 3.5 13 C 3.21875 13 3 12.78125 3 12.5 L 3 7.5 C 3 7.21875 3.21875 7 3.5 7 Z'/></svg>",
	base_mention: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 7.5 1 C 3.914063 1 1 3.914063 1 7.5 C 1 11.085938 3.914063 14 7.5 14 C 8.71875 14 9.863281 13.664063 10.839844 13.078125 L 10.324219 12.21875 C 9.5 12.714844 8.535156 13 7.5 13 C 4.457031 13 2 10.542969 2 7.5 C 2 4.457031 4.457031 2 7.5 2 C 10.542969 2 13 4.457031 13 7.5 L 13 8.601563 C 13 9.375 12.375 10 11.605469 10 L 11.398438 10 C 10.628906 10 10 9.375 10 8.601563 L 10 6.398438 C 10 5.082031 8.917969 4 7.601563 4 L 7.398438 4 C 6.082031 4 5 5.082031 5 6.398438 L 5 8.601563 C 5 9.917969 6.082031 11 7.398438 11 L 7.601563 11 C 8.375 11 9.0625 10.621094 9.5 10.046875 C 9.941406 10.621094 10.625 11 11.398438 11 L 11.605469 11 C 12.917969 11 14 9.921875 14 8.601563 L 14 7.5 C 14 3.914063 11.085938 1 7.5 1 Z M 7.398438 5 L 7.601563 5 C 8.371094 5 9 5.625 9 6.398438 L 9 8.601563 C 9 9.375 8.371094 10 7.601563 10 L 7.398438 10 C 6.625 10 6 9.375 6 8.601563 L 6 6.398438 C 6 5.625 6.625 5 7.398438 5 Z'/></svg>",
	base_marker: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' width='48px' height='48px'><path d='M 24 4 C 16.285455 4 10 10.285455 10 18 C 10 21.46372 11.272608 24.643548 13.359375 27.085938 L 13.359375 27.087891 L 13.361328 27.087891 C 13.361328 27.087891 19.149094 33.866566 21.298828 35.917969 C 22.798087 37.348278 25.199464 37.347492 26.699219 35.917969 C 29.129083 33.600994 34.636721 27.090553 34.640625 27.085938 L 34.642578 27.082031 C 36.728766 24.639939 38 21.462159 38 18 C 38 10.285455 31.714545 4 24 4 z M 24 7 C 30.093455 7 35 11.906545 35 18 C 35 20.73228 34.005417 23.211194 32.359375 25.136719 L 32.359375 25.138672 L 32.357422 25.138672 C 32.357422 25.138672 26.632181 31.83589 24.628906 33.746094 C 24.258577 34.099392 23.73947 34.099392 23.369141 33.746094 C 21.715477 32.16807 15.643092 25.141834 15.638672 25.136719 L 15.636719 25.132812 C 13.99327 23.20762 13 20.730712 13 18 C 13 11.906545 17.906545 7 24 7 z M 24 12 C 22.125 12 20.528815 12.757133 19.503906 13.910156 C 18.478997 15.063179 18 16.541667 18 18 C 18 19.458333 18.478997 20.936821 19.503906 22.089844 C 20.528815 23.242867 22.125 24 24 24 C 25.875 24 27.471185 23.242867 28.496094 22.089844 C 29.521003 20.936821 30 19.458333 30 18 C 30 16.541667 29.521003 15.063179 28.496094 13.910156 C 27.471185 12.757133 25.875 12 24 12 z M 24 15 C 25.124999 15 25.778816 15.367867 26.253906 15.902344 C 26.728997 16.436821 27 17.208333 27 18 C 27 18.791667 26.728997 19.563179 26.253906 20.097656 C 25.778816 20.632133 25.124999 21 24 21 C 22.875001 21 22.221184 20.632133 21.746094 20.097656 C 21.271003 19.563179 21 18.791667 21 18 C 21 17.208333 21.271003 16.436821 21.746094 15.902344 C 22.221184 15.367867 22.875001 15 24 15 z M 12.771484 29.441406 C 8.2264844 30.754406 5 32.953 5 36 C 5 41.252 14.558 44 24 44 C 33.442 44 43 41.252 43 36 C 43 32.954 39.775422 30.757359 35.232422 29.443359 C 34.654422 30.099359 33.863187 30.993844 32.992188 31.964844 C 37.418188 33.005844 40 34.691 40 36 C 40 38.039 33.767 41 24 41 C 14.233 41 8 38.039 8 36 C 8 34.69 10.586531 33.001938 15.019531 31.960938 C 14.152531 30.995938 13.355484 30.100406 12.771484 29.441406 z'/></svg>",
	base_filter: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path d='M6 12h4v-2H6v2zM2 4v2h12V4H2zm2 5h8V7H4v2z'></path></svg>",
});



SVG.group("form 24x24", {
	
	form_base: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 2.5 1 C 1.675781 1 1 1.675781 1 2.5 L 1 12.5 C 1 13.324219 1.675781 14 2.5 14 L 12.5 14 C 13.324219 14 14 13.324219 14 12.5 L 14 2.5 C 14 1.675781 13.324219 1 12.5 1 Z M 2.5 2 L 12.5 2 C 12.78125 2 13 2.21875 13 2.5 L 13 12.5 C 13 12.78125 12.78125 13 12.5 13 L 2.5 13 C 2.21875 13 2 12.78125 2 12.5 L 2 2.5 C 2 2.21875 2.21875 2 2.5 2 Z M 7 4 L 7 7 L 11 7 L 11 4 Z M 4 5 L 4 6 L 6 6 L 6 5 Z M 8 5 L 10 5 L 10 6 L 8 6 Z M 7 8 L 7 11 L 11 11 L 11 8 Z M 4 9 L 4 10 L 6 10 L 6 9 Z M 8 9 L 10 9 L 10 10 L 8 10 Z'/></svg>",
	form_text: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 20.455078 7.9882812 C 19.718078 7.9882813 19.072625 8.1609063 18.515625 8.5039062 C 17.959625 8.8459062 17.532422 9.3375156 17.232422 9.9785156 C 16.933422 10.619516 16.783203 11.360172 16.783203 12.201172 L 16.783203 12.736328 C 16.783203 14.054328 17.108812 15.092656 17.757812 15.847656 C 18.406813 16.602656 19.298641 16.980469 20.431641 16.980469 C 21.467641 16.980469 22.302547 16.710922 22.935547 16.169922 C 23.568547 15.628922 23.919281 14.887313 23.988281 13.945312 L 23.988281 13.943359 L 22.169922 13.943359 C 22.128922 14.476359 21.968406 14.869047 21.691406 15.123047 C 21.414406 15.378047 20.994641 15.505859 20.431641 15.505859 C 19.808641 15.505859 19.3515 15.288562 19.0625 14.851562 C 18.7735 14.415562 18.628906 13.723344 18.628906 12.777344 L 18.628906 12.117188 C 18.636906 11.212188 18.79175 10.544281 19.09375 10.113281 C 19.39575 9.6822812 19.848078 9.4667969 20.455078 9.4667969 C 21.014078 9.4667969 21.430125 9.5956094 21.703125 9.8496094 C 21.977125 10.103609 22.136641 10.513125 22.181641 11.078125 L 24.001953 11.078125 C 23.904953 10.100125 23.544875 9.3417813 22.921875 8.8007812 C 22.298875 8.2597813 21.475078 7.9882812 20.455078 7.9882812 z M 3.2910156 8.109375 L 0 16.859375 L 1.9375 16.859375 L 2.5449219 15.056641 L 5.7363281 15.056641 L 6.3515625 16.859375 L 8.2871094 16.859375 L 4.9785156 8.109375 L 3.2910156 8.109375 z M 9.1132812 8.109375 L 9.1132812 16.859375 L 12.550781 16.859375 C 13.554781 16.851375 14.327141 16.630266 14.869141 16.197266 C 15.412141 15.764266 15.683594 15.128109 15.683594 14.287109 C 15.683594 13.794109 15.552016 13.377109 15.291016 13.037109 C 15.030016 12.697109 14.67175 12.469422 14.21875 12.357422 C 14.61575 12.205422 14.925437 11.967625 15.148438 11.640625 C 15.371437 11.313625 15.482422 10.936813 15.482422 10.507812 C 15.482422 9.7228125 15.205391 9.12575 14.650391 8.71875 C 14.095391 8.31175 13.281984 8.109375 12.208984 8.109375 L 9.1132812 8.109375 z M 10.933594 9.5703125 L 12.208984 9.5703125 C 12.710984 9.5703125 13.077547 9.6560781 13.310547 9.8300781 C 13.543547 10.004078 13.660156 10.2905 13.660156 10.6875 C 13.660156 11.3965 13.20025 11.759391 12.28125 11.775391 L 10.933594 11.775391 L 10.933594 9.5703125 z M 4.1347656 10.320312 L 5.2460938 13.595703 L 3.0351562 13.595703 L 4.1347656 10.320312 z M 10.933594 13.050781 L 12.603516 13.050781 C 13.441516 13.062781 13.859375 13.468531 13.859375 14.269531 C 13.859375 14.625531 13.739047 14.905422 13.498047 15.107422 C 13.257047 15.309422 12.923141 15.410156 12.494141 15.410156 L 10.933594 15.410156 L 10.933594 13.050781 z'/></svg>",
	form_radio: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 2 C 6.486 2 2 6.486 2 12 C 2 17.514 6.486 22 12 22 C 17.514 22 22 17.514 22 12 C 22 6.486 17.514 2 12 2 z M 12 4 C 16.411 4 20 7.589 20 12 C 20 16.411 16.411 20 12 20 C 7.589 20 4 16.411 4 12 C 4 7.589 7.589 4 12 4 z M 12 9 A 3 3 0 0 0 9 12 A 3 3 0 0 0 12 15 A 3 3 0 0 0 15 12 A 3 3 0 0 0 12 9 z'/></svg>",
	form_select: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M3 14H21V16H3zM3 10H21V12H3zM3 6H21V8H3zM15 18L12 21 9 18z'/></svg>",
	form_select_m: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 5 2 C 3.895 2 3 2.895 3 4 L 3 6 C 3 7.105 3.895 8 5 8 L 7 8 C 8.105 8 9 7.105 9 6 L 9 4 C 9 2.895 8.105 2 7 2 L 5 2 z M 12 4 A 1.0001 1.0001 0 1 0 12 6 L 20 6 A 1.0001 1.0001 0 1 0 20 4 L 12 4 z M 5 9 C 3.9069372 9 3 9.9069372 3 11 L 3 13 C 3 14.093063 3.9069372 15 5 15 L 7 15 C 8.0930628 15 9 14.093063 9 13 L 9 11 C 9 9.9069372 8.0930628 9 7 9 L 5 9 z M 5 11 L 7 11 L 7 13 L 5 13 L 5 11 z M 12 11 A 1.0001 1.0001 0 1 0 12 13 L 20 13 A 1.0001 1.0001 0 1 0 20 11 L 12 11 z M 5 16 C 3.895 16 3 16.895 3 18 L 3 20 C 3 21.105 3.895 22 5 22 L 7 22 C 8.105 22 9 21.105 9 20 L 9 18 C 9 16.895 8.105 16 7 16 L 5 16 z M 12 18 A 1.0001 1.0001 0 1 0 12 20 L 20 20 A 1.0001 1.0001 0 1 0 20 18 L 12 18 z'/></svg>",
	form_number: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 6 3 C 4.3550302 3 3 4.3550302 3 6 L 3 18 C 3 19.64497 4.3550302 21 6 21 L 18 21 C 19.64497 21 21 19.64497 21 18 L 21 6 C 21 4.3550302 19.64497 3 18 3 L 6 3 z M 6 5 L 18 5 C 18.56503 5 19 5.4349698 19 6 L 19 18 C 19 18.56503 18.56503 19 18 19 L 6 19 C 5.4349698 19 5 18.56503 5 18 L 5 6 C 5 5.4349698 5.4349698 5 6 5 z M 11.984375 6.9863281 A 1.0001 1.0001 0 0 0 11 8 L 11 9 L 10 9 A 1.0001 1.0001 0 1 0 10 11 L 11 11 L 11 12 A 1.0001 1.0001 0 1 0 13 12 L 13 11 L 14 11 A 1.0001 1.0001 0 1 0 14 9 L 13 9 L 13 8 A 1.0001 1.0001 0 0 0 11.984375 6.9863281 z M 10 15 A 1.0001 1.0001 0 1 0 10 17 L 14 17 A 1.0001 1.0001 0 1 0 14 15 L 10 15 z'/></svg>",
	form_decimal: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 6 3 C 4.3550302 3 3 4.3550302 3 6 L 3 18 C 3 19.64497 4.3550302 21 6 21 L 18 21 C 19.64497 21 21 19.64497 21 18 L 21 6 C 21 4.3550302 19.64497 3 18 3 L 6 3 z M 6 5 L 18 5 C 18.56503 5 19 5.4349698 19 6 L 19 18 C 19 18.56503 18.56503 19 18 19 L 6 19 C 5.4349698 19 5 18.56503 5 18 L 5 6 C 5 5.4349698 5.4349698 5 6 5 z M 15.980469 6.9902344 A 1.0001 1.0001 0 0 0 15.292969 7.2929688 L 7.2929688 15.292969 A 1.0001 1.0001 0 1 0 8.7070312 16.707031 L 16.707031 8.7070312 A 1.0001 1.0001 0 0 0 15.980469 6.9902344 z M 8.5 7 A 1.5 1.5 0 0 0 7 8.5 A 1.5 1.5 0 0 0 8.5 10 A 1.5 1.5 0 0 0 10 8.5 A 1.5 1.5 0 0 0 8.5 7 z M 15.5 14 A 1.5 1.5 0 0 0 14 15.5 A 1.5 1.5 0 0 0 15.5 17 A 1.5 1.5 0 0 0 17 15.5 A 1.5 1.5 0 0 0 15.5 14 z'/></svg>",
	form_textarea: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 3 3 L 3 5 L 21 5 L 21 3 L 3 3 z M 3 7 L 3 9 L 16 9 L 16 7 L 3 7 z M 3 11 L 3 13 L 21 13 L 21 11 L 3 11 z M 3 15 L 3 17 L 16 17 L 16 15 L 3 15 z M 3 19 L 3 21 L 21 21 L 21 19 L 3 19 z'/></svg>",
	form_date: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 6 1 L 6 3 L 5 3 C 3.9 3 3 3.9 3 5 L 3 19 C 3 20.1 3.9 21 5 21 L 19 21 C 20.1 21 21 20.1 21 19 L 21 5 C 21 3.9 20.1 3 19 3 L 18 3 L 18 1 L 16 1 L 16 3 L 8 3 L 8 1 L 6 1 z M 5 5 L 6 5 L 8 5 L 16 5 L 18 5 L 19 5 L 19 7 L 5 7 L 5 5 z M 5 9 L 19 9 L 19 19 L 5 19 L 5 9 z'/></svg>",
	form_title: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M16 3L16 10 8 10 8 3 5 3 5 21 8 21 8 13 16 13 16 21 19 21 19 3z'/></svg>",
	form_dropdown: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M3 14H21V16H3zM3 10H21V12H3zM3 6H21V8H3zM15 18L12 21 9 18z'/></svg>",
	form_checkbox: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 5 3 C 3.9069372 3 3 3.9069372 3 5 L 3 19 C 3 20.093063 3.9069372 21 5 21 L 19 21 C 20.093063 21 21 20.093063 21 19 L 21 5 C 21 3.9069372 20.093063 3 19 3 L 5 3 z M 5 5 L 19 5 L 19 19 L 5 19 L 5 5 z M 16.292969 8.2929688 L 10 14.585938 L 7.7070312 12.292969 L 6.2929688 13.707031 L 10 17.414062 L 17.707031 9.7070312 L 16.292969 8.2929688 z'/></svg>",
	form_check_fill: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M16 8A8 8 0 110 8a8 8 0 0116 0zm-3.97-3.03a.75.75 0 00-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 00-1.06 1.06L6.97 11.03a.75.75 0 001.079-.02l3.992-4.99a.75.75 0 00-.01-1.05z'></path></svg>",
	form_editor: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 5 3 C 3.9069372 3 3 3.9069372 3 5 L 3 19 C 3 20.093063 3.9069372 21 5 21 L 19 21 C 20.093063 21 21 20.093063 21 19 L 21 5 C 21 3.9069372 20.093063 3 19 3 L 5 3 z M 5 5 L 19 5 L 19 19 L 5 19 L 5 5 z M 7 7 L 7 9 L 17 9 L 17 7 L 7 7 z M 7 11 L 7 13 L 13 13 L 13 11 L 7 11 z M 7 15 L 7 17 L 17 17 L 17 15 L 7 15 z'/></svg>",
	form_undo: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' width='48px' height='48px'><path d='M 17.470703 2.9863281 A 1.50015 1.50015 0 0 0 16.439453 3.4394531 L 6.4394531 13.439453 A 1.50015 1.50015 0 0 0 6.4394531 15.560547 L 16.439453 25.560547 A 1.50015 1.50015 0 1 0 18.560547 23.439453 L 11.121094 16 L 34.5 16 C 37.003499 16 39 17.996501 39 20.5 L 39 43.5 A 1.50015 1.50015 0 1 0 42 43.5 L 42 20.5 C 42 16.375499 38.624501 13 34.5 13 L 11.121094 13 L 18.560547 5.5605469 A 1.50015 1.50015 0 0 0 17.470703 2.9863281 z'/></svg>",

	form_lock: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 1 C 8.6761905 1 6 3.6761905 6 7 L 6 8 C 4.9 8 4 8.9 4 10 L 4 20 C 4 21.1 4.9 22 6 22 L 18 22 C 19.1 22 20 21.1 20 20 L 20 10 C 20 8.9 19.1 8 18 8 L 18 7 C 18 3.6761905 15.32381 1 12 1 z M 12 3 C 14.27619 3 16 4.7238095 16 7 L 16 8 L 8 8 L 8 7 C 8 4.7238095 9.7238095 3 12 3 z M 12 13 C 13.1 13 14 13.9 14 15 C 14 16.1 13.1 17 12 17 C 10.9 17 10 16.1 10 15 C 10 13.9 10.9 13 12 13 z'/></svg>",
	form_edit: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 18 2 L 15.585938 4.4140625 L 19.585938 8.4140625 L 22 6 L 18 2 z M 14.076172 5.9238281 L 3 17 L 3 21 L 7 21 L 18.076172 9.9238281 L 14.076172 5.9238281 z'/></svg>",
	form_move: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 8 3 C 7.449219 3 7 3.449219 7 4 C 7 4.550781 7.449219 5 8 5 C 8.550781 5 9 4.550781 9 4 C 9 3.449219 8.550781 3 8 3 Z M 8 7 C 7.449219 7 7 7.449219 7 8 C 7 8.550781 7.449219 9 8 9 C 8.550781 9 9 8.550781 9 8 C 9 7.449219 8.550781 7 8 7 Z M 8 11 C 7.449219 11 7 11.449219 7 12 C 7 12.550781 7.449219 13 8 13 C 8.550781 13 9 12.550781 9 12 C 9 11.449219 8.550781 11 8 11 Z'/></svg>",
	form_shield: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M12,1L3,5c0,0,0,4,0,6c0,7.83,6.439,11.486,9,12c2.561-0.514,9-4.17,9-12c0-2,0-6,0-6L12,1z M11,16.414l-4.185-4.185 l1.414-1.414L11,13.586l5.792-5.792l1.414,1.414L11,16.414z'/></svg>",
	form_custom: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 5 3 C 3.9069372 3 3 3.9069372 3 5 L 3 19 C 3 20.093063 3.9069372 21 5 21 L 19 21 C 20.093063 21 21 20.093063 21 19 L 21 5 C 21 3.9069372 20.093063 3 19 3 L 5 3 z M 5 5 L 19 5 L 19 19 L 5 19 L 5 5 z M 8.4960938 7.1308594 L 7.5039062 8.8691406 L 12.982422 12 L 7.5039062 15.130859 L 8.4960938 16.869141 L 17.015625 12 L 8.4960938 7.1308594 z'/></svg>",
	form_color: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 7.8886719 2.0898438 A 1.0001 1.0001 0 0 0 7.1933594 3.8066406 L 9.5761719 6.1894531 L 3.7988281 11.787109 L 3.7929688 11.792969 C 2.6394154 12.946522 2.6394154 14.854259 3.7929688 16.007812 L 8.8925781 21.107422 C 10.046132 22.260975 11.903752 22.311091 13.007812 21.207031 L 18.107422 16.107422 C 19.260975 14.953868 19.260975 13.046132 18.107422 11.892578 L 16.164062 9.9511719 A 1.0001 1.0001 0 0 0 16.107422 9.8925781 L 8.6074219 2.3925781 A 1.0001 1.0001 0 0 0 7.8886719 2.0898438 z M 10.988281 7.6035156 L 14.693359 11.306641 L 16.693359 13.306641 C 16.916583 13.529864 17.027344 13.764932 17.027344 14 L 4.8964844 14 C 4.8603635 13.731888 4.9521709 13.461892 5.2070312 13.207031 L 10.988281 7.6035156 z M 20 16.400391 C 19.8415 16.400391 19.682938 16.476906 19.585938 16.628906 C 18.999938 17.544906 18 19.222 18 20 C 18 21.1 18.9 22 20 22 C 21.1 22 22 21.1 22 20 C 22 19.222 21.000063 17.544906 20.414062 16.628906 C 20.317062 16.476906 20.1585 16.400391 20 16.400391 z'/></svg>",
	
	form_upload: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 8 2 C 6.167969 2 4.574219 3.273438 4.132813 5.023438 C 3.054688 5.183594 2.199219 6.042969 2.03125 7.160156 C 0.835938 7.566406 0 8.707031 0 10 C 0 11.652344 1.347656 13 3 13 L 6 13 L 6 12 L 3 12 C 1.898438 12 1 11.101563 1 10 C 1 9.050781 1.675781 8.226563 2.601563 8.039063 L 3.011719 7.921875 L 3 7.5 C 3 6.671875 3.671875 6 4.449219 5.996094 L 4.550781 6.007813 L 4.984375 6.007813 L 5.046875 5.574219 C 5.253906 4.105469 6.523438 3 8 3 C 9.207031 3 10.292969 3.71875 10.765625 4.828125 L 10.941406 5.257813 L 11.378906 5.109375 C 11.605469 5.035156 11.808594 5 12 5 C 13.101563 5 14 5.898438 14 7 C 14 7.234375 13.953125 7.472656 13.859375 7.710938 L 13.71875 8.09375 L 14.0625 8.3125 C 14.648438 8.683594 15 9.3125 15 10 C 15 11.101563 14.101563 12 13 12 L 9 12 L 9 13 L 13 13 C 14.652344 13 16 11.652344 16 10 C 16 9.101563 15.601563 8.261719 14.914063 7.695313 C 14.972656 7.464844 15 7.230469 15 7 C 15 5.179688 13.390625 3.695313 11.492188 4.046875 C 10.789063 2.792969 9.464844 2 8 2 Z M 7.5 8 L 5 11 L 7 11 L 7 15 L 8 15 L 8 11 L 10 11 Z'/></svg>",
});


var Currency=new function __Currency(){
	this.unit="Ä‘";

	this.format=function(val){
		return ""+(this.unit)+" "+(this.simple(val))+"";
		// return AP.currency.formatVND(val);
		// return "<span class='cvalue'>"+(AP.data.numberFormat(val))+"</span><span class='cunit'>"+(this.unit)+"</span>";
	};
	
	this.full=function(val){
		if (val===null){
			return "<div class='cur'>--</div>";
		}
		return "<div class='cur'><b>"+(AP.data.numberFormat(parseInt(val)))+"</b> <span class='unit'>"+(this.unit)+"</span></div>";
	};
	
	this.compact=function(val){
		return "<div class='cur2'><b>"+(AP.data.numberFormat(parseInt(val)))+"</b> <span class='unit'>"+(this.unit)+"</span></div>";
	};
	
	this.get=function(val){
		return this.format(val);
	};
	
	this.simple = function(number){
		if (!AP.data.isNumber(number)){
			return "0";
		}
		
		var n=parseInt(number);
		var txt=AP.data.numberFormat(n);
		
		if (n>1000000*1000){
			txt="<b>"+(n/1000000000).toFixed(2)+"</b>B";
		}else if (n>1000000){
			txt="<b>"+(n/1000000).toFixed(2)+"</b>M";
		}else if (n>100000){
			txt="<b>"+(n/1000).toFixed(2)+"</b>K";
		}
		
		return txt;
	};
	
};


Base.icon = new function __BaseIcon(){
	var selected_color = '';
	var selected_icon = '';
	var __ready = null;
	var __callback = null;
	
	var icons = [
		"emoji_object", "base_code", "form_title", "form_number", "form_text", "emoji_smile_16", "emoji_flag", "emoji_leaf", 
		"base_fx", "base_users", "base_tick", "form_checkbox", "form_editor", "base_sheet", "emoji_buzz", "base_image",
		"icon_grid", "icon_grid2", "icon_enum", "icon_list", "icon_list_star", "base_comment", "base_file", "base_email", "base_question", "base_marker",
		"icon_stack", "icon_trophy", "icon_shield", "icon_moon", "icon_book", "icon_layer", "icon_ok",
		"icon_fill_donut", "icon_pie", "icon_pentagon", "icon_gem", "icon_close", "icon_bookmark",
		"icon_fill_light", "icon_fill_bulb", "icon_fill_mask", "icon_fill_moon", "icon_fill_pin", "base_certified", "form_lock",
		"icon_fill_record", "icon_fill_shield", "icon_fill_pentagon", "icon_fill_star", "icon_fill_sun", "icon_fill_stack", "form_check_fill", "icon_fill_bell",
		"icon_fill_bookmark", "icon_fill_edu", "icon_fill_gift", "icon_fill_alert", "icon_fill_heart", "icon_fill_geo", "icon_fill_check", "icon_fill_cursor"
	];
	
	
	/**
	 * @desc Select more icon
	 */
	this.add = function(list){
		if (AP.data.string(list)){
			var parts = AP.word.safeSplit(" ",list);
			for (var i=0; i<parts.length; i++){
				icons.push(parts[i]);	
			}
		}else if (AP.data.isArray(list)){
			for (var i=0; i<list.length; i++){
				this.add(list[i]);
			}
		}
	};
	
	
	this.all = function(){
		return icons;
	};
	
	/**
	 * @desc On box picker
	 */
	this.boxPicker = function(opts, callback){
		__init(opts);
		
		if (callback){
			__callback = callback;
		}
	};
	
	
	this.hide = function(){
		$("#js-base-iconbox-picker").hide();
	};
	
	
	
	this.onIconBoxPicked = function(){
		if (__callback){
			__callback({color: selected_color, icon: selected_icon, value: selected_icon+" "+selected_color});
			this.hide();
		}
	};
	
	
	function __init(opts){
		if (opts.ready){
			__ready = opts.ready;
		}
		
		if (opts.icon){
			detectPosition(opts);
		}
		
		selected_color = '';
		selected_icon = '';
		
		__ready = null;
		__callback = null;
		
		if ($("#js-base-iconbox-picker").length){
			$("#js-base-iconbox-picker").show().css(Render.position.get(opts)).removeClass("-ready");
			feedback();
			return;
		}
		
		var list = range(1, 9);
		var bgs = AP.render(list, function(e){
			return "<div class='bg-item -bg-alt"+(e)+"' data-value='"+(Color.alt(e))+"'></div>";
		});
		
		var xbgs = AP.render(list, function(e){
			var c= Color.adjust(Color.alt(e), -35, -90);
			return "<div class='bg-item -light' style='background-color:"+(c)+"' data-value='"+(c)+"'></div>";
		});
		
		
		var html_icons='';
		if (opts.all){
			for (var key in SVG){
				var v = SVG[key];
				if (AP.data.isString(v) && v.length>=10){
					html_icons += "<div class='icon-opt' title='"+(key)+"' data-value='"+(key)+"'> <div class='-bg'></div> <div class='svg'>"+(v)+"</div> </div>";
				}
			}

		}else{
			for (var i=0; i < icons.length; i++){
				var key = icons[i];
				var v = SVG[key];
				if (AP.data.isString(v) && v.length>=10){
					html_icons += "<div class='icon-opt' title='"+(key)+"' data-value='"+(key)+"'> <div class='-bg'></div> <div class='svg'>"+(v)+"</div> </div>";
				}	
			}
			
		}
	
		var darkmode = Client.darkmode?"-dark":"";
		var html = "<div class='base-icon-picker-canvas "+(darkmode)+"' style='"+(Render.position.getText(opts))+"' id='js-base-iconbox-picker'> <div class='bip-header'> " +Render.render('title', {}, "Pick an icon and a color")+ "<div class='close' onclick='Base.icon.hide()'><span class='ap icon-ion-android-close'></span></div> <div class='ready'> <div class='js-icon'></div> " +Render.render('button', {title: "OK" , onclick: "Base.icon.onIconBoxPicked(this)" , sm:1}, '')+ "</div> </div> <div class='bip-bg-picker'>"+(bgs)+""+(xbgs)+"</div> <div class='bip-more-color'> " +Render.render('button', {_class: "js-more-color" }, "More color")+ "</div> <div class='bip-body' data-autohide='1'> <div class='bip-icons'>"+(html_icons)+"</div> </div> </div>";
		
		$(document.body).append(html);
		Layout.scrollable("#js-base-iconbox-picker .bip-body");
		
		
		$("#js-base-iconbox-picker .bg-item").each(function(){
			$(this).click(function(){
				$(this).addClass("active");
				$(this).siblings().removeClass("active");
				selected_color = $(this).data("value");
				
				feedback();
			});
		});
		
		$("#js-base-iconbox-picker .icon-opt").each(function(){
			$(this).click(function(){
				$(this).addClass("active");
				$(this).siblings().removeClass("active");
				selected_icon = $(this).data("value");
				
				feedback();
			});
		});
		
		
		$("#js-base-iconbox-picker .js-more-color").spectrum({
//			color: params.value||null,
			type: "flat",
			hideAfterPaletteSelect: false,
			showInitial: true,
			showAlpha: false,
			allowEmpty: "false",
			change: function(val){
				if (val){
					selected_color = val.toHexString();
					feedback();
				}
			}
		});
		
		// Auto hide
		$("#js-base-iconbox-picker").clickOut(function(){
			if ($("#js-base-iconbox-picker").is(":visible")){
				// Base.icon.hide();	
			}
		});
	};
	
	
	function feedback(){
		if (selected_color){
			$("#js-base-iconbox-picker .-bg").css("background-color", selected_color);
			if (Color.isDark(selected_color)){
				$("#js-base-iconbox-picker .icon-opt").addClass("-dark");
			}else{
				$("#js-base-iconbox-picker .icon-opt").removeClass("-dark");
			}
		}else{
			$("#js-base-iconbox-picker .-bg").css("background-color", 'transparent');
			$("#js-base-iconbox-picker .bg-item").removeClass("active");
		}
		
		if (!selected_icon){
			$("#js-base-iconbox-picker .icon-opt").removeClass("active");
		}
		
		if (selected_color && selected_icon){
			return ready();
		}
	};
	
	
	/**
	 * @desc When icon and color is selected
	 */
	function ready(){
		$("#js-base-iconbox-picker").addClass("-ready");
		$("#js-base-iconbox-picker .js-icon").html("  " +Render.render('iconbox', {iconbox: ""+(selected_icon)+" "+(selected_color)+"" , el:1, square:1}, '')+ '');
		if (__ready){
			__ready(selected_icon, selected_color);
		}
	};
	
	
	function detectPosition(opts){
		var offset = $(opts.icon).offset();
		opts.left = offset.left-250;
		var _top = offset.top-330;
		
		if (_top<0){
			opts.top = offset.top+30;
		}else{
			opts.top = _top;
		}
	};
};

SVG.group("for picker", {
	icon_pie: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 8 2 C 4.6922138 2 2 4.6922138 2 8 C 2 11.307786 4.6922138 14 8 14 C 11.307786 14 14 11.307786 14 8 C 14 4.6922138 11.307786 2 8 2 z M 8 3 L 8 8 L 3 8 C 3 5.2326539 5.2326539 3 8 3 z'/></svg>",
	icon_grid: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 2.5 1 C 1.675781 1 1 1.675781 1 2.5 L 1 12.5 C 1 13.324219 1.675781 14 2.5 14 L 12.5 14 C 13.324219 14 14 13.324219 14 12.5 L 14 2.5 C 14 1.675781 13.324219 1 12.5 1 Z M 5 2 L 7 2 L 7 4 L 5 4 Z M 8 2 L 10 2 L 10 4 L 8 4 Z M 11 2 L 12.5 2 C 12.78125 2 13 2.21875 13 2.5 L 13 4 L 11 4 Z M 2 5 L 4 5 L 4 7 L 2 7 Z M 8 5 L 10 5 L 10 7 L 8 7 Z M 11 5 L 13 5 L 13 7 L 11 7 Z M 2 8 L 4 8 L 4 10 L 2 10 Z M 5 8 L 7 8 L 7 10 L 5 10 Z M 11 8 L 13 8 L 13 10 L 11 10 Z M 2 11 L 4 11 L 4 13 L 2.5 13 C 2.21875 13 2 12.78125 2 12.5 Z M 5 11 L 7 11 L 7 13 L 5 13 Z M 8 11 L 10 11 L 10 13 L 8 13 Z'/></svg>",
	icon_grid2: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M3.5 15a2.5 2.5 0 100-5 2.5 2.5 0 000 5zm9-9a2.5 2.5 0 100-5 2.5 2.5 0 000 5zm0 9a2.5 2.5 0 110-5 2.5 2.5 0 010 5zM16 3.5a3.5 3.5 0 11-7 0 3.5 3.5 0 017 0zm-9 9a3.5 3.5 0 11-7 0 3.5 3.5 0 017 0zm5.5 3.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zm-9-11a1.5 1.5 0 110-3 1.5 1.5 0 010 3zm0 2a3.5 3.5 0 100-7 3.5 3.5 0 000 7z'></path></svg>",
	icon_enum: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 3 1 C 3 1.5625 2.6875 2 2 2 L 2 3 C 2.378906 3 2.710938 2.894531 3 2.726563 L 3 6 L 4 6 L 4 1 Z M 7 3 L 7 4 L 14 4 L 14 3 Z M 3 8 C 2.359375 8 1.824219 8.277344 1.492188 8.664063 C 1.15625 9.054688 1 9.539063 1 10 L 2 10 C 2 9.773438 2.085938 9.503906 2.25 9.316406 C 2.410156 9.128906 2.625 9 3 9 C 3.417969 9 4 9.351563 4 10 C 4 10.023438 3.921875 10.222656 3.683594 10.453125 C 3.445313 10.683594 3.09375 10.933594 2.738281 11.15625 C 2.023438 11.59375 1.296875 11.917969 1.296875 11.917969 L 1 12.046875 L 1 13 L 5 13 L 5 12 L 3.269531 12 C 3.660156 11.757813 4.058594 11.484375 4.378906 11.171875 C 4.703125 10.859375 5 10.5 5 10 C 5 8.773438 3.960938 8 3 8 Z M 7 10 L 7 11 L 14 11 L 14 10 Z'/></svg>",
	icon_list: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M2.5 12a.5.5 0 01.5-.5h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5zm0-4a.5.5 0 01.5-.5h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5zm0-4a.5.5 0 01.5-.5h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5z'></path></svg>",
	icon_list_star: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 3 3 L 3 5 L 21 5 L 21 3 L 3 3 z M 3 9 L 3 11 L 21 11 L 21 9 L 3 9 z M 17.5 13 L 15.941406 16.453125 L 12 16.818359 L 14.933594 19.273438 L 14.107422 23 L 17.5 21 L 20.982422 23 L 19.974609 19.273438 L 23 16.818359 L 19.058594 16.455078 L 17.5 13 z M 3 15 L 3 17 L 10.025391 17 C 10.071391 16.302 10.211547 15.633 10.435547 15 L 3 15 z'/></svg>",
	icon_stack: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M3 0h10a2 2 0 012 2v3a2 2 0 01-2 2H3a2 2 0 01-2-2V2a2 2 0 012-2zm0 1a1 1 0 00-1 1v3a1 1 0 001 1h10a1 1 0 001-1V2a1 1 0 00-1-1H3zm0 8h10a2 2 0 012 2v3a2 2 0 01-2 2H3a2 2 0 01-2-2v-3a2 2 0 012-2zm0 1a1 1 0 00-1 1v3a1 1 0 001 1h10a1 1 0 001-1v-3a1 1 0 00-1-1H3z'></path></svg>",
	icon_trophy: "<svg xmlns='http://www.w3.org/2000/svg' fill='currentColor' class='bi bi-trophy' viewBox='0 0 16 16' id='trophy'><path d='M2.5.5A.5.5 0 013 0h10a.5.5 0 01.5.5c0 .538-.012 1.05-.034 1.536a3 3 0 11-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.194.048.377.135.537.255L13.3 15.1a.5.5 0 01-.3.9H3a.5.5 0 01-.3-.9l1.838-1.379c.16-.12.343-.207.537-.255L6.5 13.11v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 11-1.132-5.89A33.076 33.076 0 012.5.5zm.099 2.54a2 2 0 00.72 3.935c-.333-1.05-.588-2.346-.72-3.935zm10.083 3.935a2 2 0 00.72-3.935c-.133 1.59-.388 2.885-.72 3.935zM3.504 1c.007.517.026 1.006.056 1.469.13 2.028.457 3.546.87 4.667C5.294 9.48 6.484 10 7 10a.5.5 0 01.5.5v2.61a1 1 0 01-.757.97l-1.426.356a.5.5 0 00-.179.085L4.5 15h7l-.638-.479a.501.501 0 00-.18-.085l-1.425-.356a1 1 0 01-.757-.97V10.5A.5.5 0 019 10c.516 0 1.706-.52 2.57-2.864.413-1.12.74-2.64.87-4.667.03-.463.049-.952.056-1.469H3.504z'></path></svg>",
	icon_shield: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M5.338 1.59a61.44 61.44 0 00-2.837.856.481.481 0 00-.328.39c-.554 4.157.726 7.19 2.253 9.188a10.725 10.725 0 002.287 2.233c.346.244.652.42.893.533.12.057.218.095.293.118a.55.55 0 00.101.025.615.615 0 00.1-.025c.076-.023.174-.061.294-.118.24-.113.547-.29.893-.533a10.726 10.726 0 002.287-2.233c1.527-1.997 2.807-5.031 2.253-9.188a.48.48 0 00-.328-.39c-.651-.213-1.75-.56-2.837-.855C9.552 1.29 8.531 1.067 8 1.067c-.53 0-1.552.223-2.662.524zM5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 011.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 01-2.517 2.453 7.159 7.159 0 01-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 01-1.048-.625 11.777 11.777 0 01-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 012.185 1.43 62.456 62.456 0 015.072.56z'></path></svg>",
	icon_contrast: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z'></path></svg>",
	icon_edit: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M15.502 1.94a.5.5 0 010 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 01.707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 00-.121.196l-.805 2.414a.25.25 0 00.316.316l2.414-.805a.5.5 0 00.196-.12l6.813-6.814z'></path><path fill-rule='evenodd' d='M1 13.5A1.5 1.5 0 002.5 15h11a1.5 1.5 0 001.5-1.5v-6a.5.5 0 00-1 0v6a.5.5 0 01-.5.5h-11a.5.5 0 01-.5-.5v-11a.5.5 0 01.5-.5H9a.5.5 0 000-1H2.5A1.5 1.5 0 001 2.5v11z'></path></svg>",
	icon_pentagon: "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><path d='m8 1.288 6.842 5.56L12.267 15H8V1.288zM16 6.5 8 0 0 6.5 3 16h10l3-9.5z'></path></svg>",
	icon_moon: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M6 .278a.768.768 0 01.08.858 7.208 7.208 0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 01.81.316.733.733 0 01-.031.893A8.349 8.349 0 018.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 016 .278zM4.858 1.311A7.269 7.269 0 001.025 7.71c0 4.02 3.279 7.276 7.319 7.276a7.316 7.316 0 005.205-2.162c-.337.042-.68.063-1.029.063-4.61 0-8.343-3.714-8.343-8.29 0-1.167.242-2.278.681-3.286z'></path></svg>",
	icon_book: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M0 3a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H2a2 2 0 01-2-2V3zm8.5-1v12H14a1 1 0 001-1V3a1 1 0 00-1-1H8.5zm-1 0H2a1 1 0 00-1 1v10a1 1 0 001 1h5.5V2z'></path></svg>",
	icon_layer: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M8.235 1.559a.5.5 0 00-.47 0l-7.5 4a.5.5 0 000 .882L3.188 8 .264 9.559a.5.5 0 000 .882l7.5 4a.5.5 0 00.47 0l7.5-4a.5.5 0 000-.882L12.813 8l2.922-1.559a.5.5 0 000-.882l-7.5-4zm3.515 7.008L14.438 10 8 13.433 1.562 10 4.25 8.567l3.515 1.874a.5.5 0 00.47 0l3.515-1.874zM8 9.433L1.562 6 8 2.567 14.438 6 8 9.433z'></path></svg>",
	icon_gem: "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><path d='M3.1.7a.5.5 0 0 1 .4-.2h9a.5.5 0 0 1 .4.2l2.976 3.974c.149.185.156.45.01.644L8.4 15.3a.5.5 0 0 1-.8 0L.1 5.3a.5.5 0 0 1 0-.6l3-4zm11.386 3.785-1.806-2.41-.776 2.413 2.582-.003zm-3.633.004.961-2.989H4.186l.963 2.995 5.704-.006zM5.47 5.495 8 13.366l2.532-7.876-5.062.005zm-1.371-.999-.78-2.422-1.818 2.425 2.598-.003zM1.499 5.5l5.113 6.817-2.192-6.82L1.5 5.5zm7.889 6.817 5.123-6.83-2.928.002-2.195 6.828z'></path></svg>",
	icon_close: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 4.7070312 3.2929688 L 3.2929688 4.7070312 L 10.585938 12 L 3.2929688 19.292969 L 4.7070312 20.707031 L 12 13.414062 L 19.292969 20.707031 L 20.707031 19.292969 L 13.414062 12 L 20.707031 4.7070312 L 19.292969 3.2929688 L 12 10.585938 L 4.7070312 3.2929688 z'/></svg>",
	icon_ok: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64' width='64px' height='64px'><path d='M27 55L6 33 9 29 26 41 55 12 59 16z'/></svg>",
	icon_bookmark: "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><path d='M7.84 4.1a.178.178 0 0 1 .32 0l.634 1.285a.178.178 0 0 0 .134.098l1.42.206c.145.021.204.2.098.303L9.42 6.993a.178.178 0 0 0-.051.158l.242 1.414a.178.178 0 0 1-.258.187l-1.27-.668a.178.178 0 0 0-.165 0l-1.27.668a.178.178 0 0 1-.257-.187l.242-1.414a.178.178 0 0 0-.05-.158l-1.03-1.001a.178.178 0 0 1 .098-.303l1.42-.206a.178.178 0 0 0 .134-.098L7.84 4.1z'></path><path d='M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z'></path></svg>",
	
	icon_fill_light: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path d='M11.251.068a.5.5 0 01.227.58L9.677 6.5H13a.5.5 0 01.364.843l-8 8.5a.5.5 0 01-.842-.49L6.323 9.5H3a.5.5 0 01-.364-.843l8-8.5a.5.5 0 01.615-.09z'></path></svg>",
	icon_fill_bulb: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M2 6a6 6 0 1110.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0110.5 13h-5a.5.5 0 01-.46-.302l-.761-1.77a1.964 1.964 0 00-.453-.618A5.984 5.984 0 012 6zm3 8.5a.5.5 0 01.5-.5h5a.5.5 0 010 1l-.224.447a1 1 0 01-.894.553H6.618a1 1 0 01-.894-.553L5.5 15a.5.5 0 01-.5-.5z'></path></svg>",
	icon_fill_mask: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M6.225 1.227A7.5 7.5 0 0110.5 8a7.5 7.5 0 01-4.275 6.773 7 7 0 100-13.546zM4.187.966a8 8 0 117.627 14.069A8 8 0 014.186.964z'></path></svg>",
	icon_fill_moon: "<svg xmlns='http://www.w3.org/2000/svg' fill='currentColor' class='bi bi-moon-stars-fill' viewBox='0 0 16 16' id='moon-stars-fill'><path d='M6 .278a.768.768 0 01.08.858 7.208 7.208 0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 01.81.316.733.733 0 01-.031.893A8.349 8.349 0 018.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 016 .278z'></path><path d='M10.794 3.148a.217.217 0 01.412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 010 .412l-1.162.387a1.734 1.734 0 00-1.097 1.097l-.387 1.162a.217.217 0 01-.412 0l-.387-1.162A1.734 1.734 0 009.31 6.593l-1.162-.387a.217.217 0 010-.412l1.162-.387a1.734 1.734 0 001.097-1.097l.387-1.162zM13.863.099a.145.145 0 01.274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 010 .274l-.774.258a1.156 1.156 0 00-.732.732l-.258.774a.145.145 0 01-.274 0l-.258-.774a1.156 1.156 0 00-.732-.732l-.774-.258a.145.145 0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z'></path></svg>",
	icon_fill_pin: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M9.828.722a.5.5 0 01.354.146l4.95 4.95a.5.5 0 010 .707c-.48.48-1.072.588-1.503.588-.177 0-.335-.018-.46-.039l-3.134 3.134a5.927 5.927 0 01.16 1.013c.046.702-.032 1.687-.72 2.375a.5.5 0 01-.707 0l-2.829-2.828-3.182 3.182c-.195.195-1.219.902-1.414.707-.195-.195.512-1.22.707-1.414l3.182-3.182-2.828-2.829a.5.5 0 010-.707c.688-.688 1.673-.767 2.375-.72a5.922 5.922 0 011.013.16l3.134-3.133a2.772 2.772 0 01-.04-.461c0-.43.108-1.022.589-1.503a.5.5 0 01.353-.146z'></path></svg>",
	icon_fill_record: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M16 8A8 8 0 110 8a8 8 0 0116 0zm-8 3a3 3 0 100-6 3 3 0 000 6z'></path></svg>",
	icon_fill_shield: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M5.072.56C6.157.265 7.31 0 8 0s1.843.265 2.928.56c1.11.3 2.229.655 2.887.87a1.54 1.54 0 011.044 1.262c.596 4.477-.787 7.795-2.465 9.99a11.775 11.775 0 01-2.517 2.453 7.159 7.159 0 01-1.048.625c-.28.132-.581.24-.829.24s-.548-.108-.829-.24a7.158 7.158 0 01-1.048-.625 11.777 11.777 0 01-2.517-2.453C1.928 10.487.545 7.169 1.141 2.692A1.54 1.54 0 012.185 1.43 62.456 62.456 0 015.072.56z'></path></svg>",
	icon_fill_pentagon: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M8 0l8 6.5-3 9.5H3L0 6.5 8 0z'></path></svg>",
	icon_fill_star: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z'></path></svg>",
	icon_fill_sun: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5 0 01.5.5v2a.5.5 0 01-1 0v-2A.5.5 0 018 0zm0 13a.5.5 0 01.5.5v2a.5.5 0 01-1 0v-2A.5.5 0 018 13zm8-5a.5.5 0 01-.5.5h-2a.5.5 0 010-1h2a.5.5 0 01.5.5zM3 8a.5.5 0 01-.5.5h-2a.5.5 0 010-1h2A.5.5 0 013 8zm10.657-5.657a.5.5 0 010 .707l-1.414 1.415a.5.5 0 11-.707-.708l1.414-1.414a.5.5 0 01.707 0zm-9.193 9.193a.5.5 0 010 .707L3.05 13.657a.5.5 0 01-.707-.707l1.414-1.414a.5.5 0 01.707 0zm9.193 2.121a.5.5 0 01-.707 0l-1.414-1.414a.5.5 0 01.707-.707l1.414 1.414a.5.5 0 010 .707zM4.464 4.465a.5.5 0 01-.707 0L2.343 3.05a.5.5 0 11.707-.707l1.414 1.414a.5.5 0 010 .708z'></path></svg>",
	icon_fill_stack: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M14.12 10.163l1.715.858c.22.11.22.424 0 .534L8.267 15.34a.598.598 0 01-.534 0L.165 11.555a.299.299 0 010-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.598.598 0 01.534 0l7.568 3.784a.3.3 0 010 .535L8.267 8.165a.598.598 0 01-.534 0L.165 4.382a.299.299 0 010-.535L7.733.063z'></path><path d='M14.12 6.576l1.715.858c.22.11.22.424 0 .534l-7.568 3.784a.598.598 0 01-.534 0L.165 7.968a.299.299 0 010-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.659z'></path></svg>",
	icon_fill_bell: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 8 1 C 7.453125 1 7 1.453125 7 2 L 7 3.140625 C 5.28125 3.589844 4 5.140625 4 7 L 4 10.984375 C 3.996094 11.089844 3.945313 12 3 12 L 3 13 L 13 13 L 13 12 C 12.074219 12 12 11.234375 12 11 L 12 7 C 12 5.140625 10.71875 3.589844 9 3.140625 L 9 2 C 9 1.453125 8.546875 1 8 1 Z M 8 13 C 7.449219 13 7 13.449219 7 14 C 7 14.550781 7.449219 15 8 15 C 8.550781 15 9 14.550781 9 14 C 9 13.449219 8.550781 13 8 13 Z'/></svg>",
	icon_fill_bookmark: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 6 2 C 5.861875 2 5.7278809 2.0143848 5.5976562 2.0410156 C 4.686084 2.2274316 4 3.033125 4 4 L 4 22 L 12 19 L 20 22 L 20 4 C 20 3.8625 19.985742 3.7275391 19.958984 3.5976562 C 19.799199 2.8163086 19.183691 2.2008008 18.402344 2.0410156 C 18.272119 2.0143848 18.138125 2 18 2 L 6 2 z'/></svg>",
	icon_fill_edu: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 5.9199219 L 0 11 L 4 13.539062 L 4 18 L 20 18 L 20 13.539062 L 22 12.269531 L 22 18 L 24 18 L 24 11 L 12 5.9199219 z'/></svg>",
	icon_fill_gift: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 9.09375 2 L 8 3.59375 L 12 6 L 16 3.59375 L 14.90625 2 L 12 4 Z M 5 7 C 3.894531 7 3 7.894531 3 9 L 3 10 L 11 10 L 11 7 Z M 13 7 L 13 10 L 21 10 L 21 9 C 21 7.894531 20.105469 7 19 7 Z M 4 11 L 4 20 C 4 21.105469 4.894531 22 6 22 L 11 22 L 11 11 Z M 13 11 L 13 22 L 18 22 C 19.105469 22 20 21.105469 20 20 L 20 11 Z'/></svg>",
	icon_fill_alert: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M22.239,18.451L13.442,3.816C13.135,3.305,12.596,3,12,3s-1.135,0.305-1.441,0.815L1.761,18.451 c-0.312,0.519-0.32,1.168-0.022,1.695C2.036,20.673,2.597,21,3.203,21h17.595c0.605,0,1.167-0.327,1.464-0.854 C22.56,19.619,22.551,18.97,22.239,18.451z M13,18h-2v-2h2V18z M13,14h-2V9h2V14z'/></svg>",
	icon_fill_exclaim: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M16 8A8 8 0 110 8a8 8 0 0116 0zM8 4a.905.905 0 00-.9.995l.35 3.507a.552.552 0 001.1 0l.35-3.507A.905.905 0 008 4zm.002 6a1 1 0 100 2 1 1 0 000-2z'></path></svg>",
	icon_fill_donut: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 11 2.0507812 C 5.947 2.5527813 2 6.815 2 12 C 2 17.523 6.477 22 12 22 C 15.803 22 19.109781 19.876 20.800781 16.75 L 18.003906 15.585938 C 16.781906 17.628937 14.554 19 12 19 C 8.134 19 5 15.866 5 12 C 5 8.474 7.609 5.5660781 11 5.0800781 L 11 2.0507812 z M 13 2.0507812 L 13 5.0800781 C 16.391 5.5660781 19 8.475 19 12 C 19 12.602 18.916437 13.181281 18.773438 13.738281 L 21.568359 14.904297 C 21.847359 13.984297 22 13.01 22 12 C 22 6.815 18.053 2.5527813 13 2.0507812 z'/></svg>",
	icon_fill_heart: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path fill-rule='evenodd' d='M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314z'></path></svg>",
	icon_fill_geo: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M8 16s6-5.686 6-10A6 6 0 002 6c0 4.314 6 10 6 10zm0-7a3 3 0 110-6 3 3 0 010 6z'></path></svg>",
	icon_fill_check: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M11,16.4l-4.7-4.7l1.4-1.4l3.3,3.3l8.4-8.4C17.5,3.3,14.9,2,12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10 c0-1.9-0.5-3.6-1.4-5.1L11,16.4z'/></svg>",
	icon_fill_cursor: "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><path d='M14.082 2.182a.5.5 0 0 1 .103.557L8.528 15.467a.5.5 0 0 1-.917-.007L5.57 10.694.803 8.652a.5.5 0 0 1-.006-.916l12.728-5.657a.5.5 0 0 1 .556.103z'></path></svg>",
});






Base.importer=new function __BaseImporter(){
	
	this.dialog=function(opts){
		opts=$.extend({hiddens: {}, rows:[], data: [], preview: 1, grouping: 0}, opts);
		
		var form=Form.create('dialog-excel-fx',{action: opts.action});
		
		for (var i=0; i<opts.data.length; i++){
			var row=opts.data[i];
			if (AP.data.isArray(row)){
				form.row(
					Form.label({label: row[0].label}),
					Form.inputGroup([
						Form.input(getInput(row[0])),
						Form.input(getInput(row[1]))
					])
				);
			}else{
				form.row(
					Form.label({label: row.label}),
					Form.input(getInput(row))
				);	
			}
		}
		
		form.rowHidden(	
			Form.label({label: "File"}),
			Form.input({name: 'file', type: "file"})
		)
		
		form.row(	
			Form.label({label: "Chá»n file Excel"}),
			Form.input({name: 'file', type: "placeholder", id: "internal-excel"})
		).addClass("-active");
		

		for (var i=0; i<opts.rows.length; i++){
			form.row(	
				Form.label({label: opts.rows[i].label||''}),
				Form.input({name: opts.rows[i].name, placeholder: opts.rows[i].placeholder, type: opts.rows[i].type, options: opts.rows[i].options||null, html: opts.rows[i].html||''}).value(opts.rows[i].value)
			);
		}

		var btn_label="Nháº­p";
		if (opts.preview){
			btn_label="Tiáº¿p tá»¥c";
			opts.hiddens.preview=1;
		}
		
		form.hiddens(opts.hiddens);
		
		form.render(function (f) {
			var html=getHTML(opts.columns, opts);
			$("#internal-excel").html(html).data("grouping", opts.grouping);
			
			AP.dialog("dialog-excel-dx").balance();
			
			$("#internal-excel .excel-cols").sortable({
				items: ".ui-col",
				handle: ".sicon",
				helper: "clone",
				axis: "y",
				stop: function(event, ui){
					var names=[];
					$("#internal-excel .ui-col").each(function(index){
						$(this).find(".sicon").html(AP.data.zeroPrefix(index+1));
						names.push($(this).data("name"));
					});
					
					$("#internal-excel input[name=__excel_orders]").val(names.join(","));
				}
			});
			
			$("#internal-excel").closest(".row").addClass("-active");
			
			if (opts.preview){
				f.find("file").on("change", function(){
					if ($("#internal-excel .excel-table").length){
						$("#internal-excel .excel-live-preview").empty();
						f.find("preview").val(1);
						f.selector(".button.ok").html("Tiáº¿p tá»¥c");
					}
				});
			}
			
			$("#internal-excel .js-download").click(function(){
				downloadTemplatedFile(opts.columns);
			});

			if (opts.render) {
				opts.render(f);
			}
		});
		
		form.buttons([
			{label: btn_label, action: function(){
				Form.submit("#dialog-excel-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
			
					if (code.message=="FILE_PREVIEW"){
						previewRows(code.rows);
						return;
					}
					
					Form.hide("dialog-excel-fx");
					
					if (opts.callback){
						opts.callback(code);	
					}else{
						AP.alertSuccess(code.message, function(){
							AP.refresh();
						});
					}
					
				});
			}, style: 'ok -success -rounded -bold'},
			{label: "Há»§y", action: function(){
				Form.hide("dialog-excel-dx");
			}, style:'cancel -passive-2 -rounded'}
		]);
	
		Form.pop({id: 'dialog-excel-dx', width: 600, label: opts.title, layout: "flat", closable: false}).setForm(form).show();
	};
	
	/**
	 * @desc Preview the role
	 */
	function previewRows(rows){
		UI.flash("Please preview before uploading");
		
		var cols={};
		$("#internal-excel .excel-cols .ui-col").each(function(){
			cols[$(this).data("name")]={
				label: $(this).find(".col-label").text(),
				width: $(this).data("width")
			}
		});
		
		$("#internal-excel .excel-live-preview").html(getRows(cols, rows));
		var ch=$("#internal-excel .excel-live-preview .excel-table").height()+10;
		
		if (ch>200){
			ch=200;
		}
		
		if (ch<100){
			ch=100;
		}
		
		$("#internal-excel .excel-table-canvas").css({height: ch});
		
		$("#internal-excel").closest("form").find("input[name=preview]").val(0);
		$("#internal-excel").closest("form").find(".button.ok").html("Nháº­p");
		
		AP.dialog("dialog-excel-dx").balance();
	};
	
	
	function downloadTemplatedFile(cols){
		var headers = ARR.select(cols, function(c){
			return ""+(c.label)+""; 
		});
		
		var rows = [];
		
		Base.io.exp({
			headers: headers,
			rows: rows,
			title: "templated.file"
		});
	};
	
	
	/**
	 * @desc Get columns HTML and support drag/drop
	 */
	function getHTML(cols, opts){
		var names=[];
		
		var html=AP.render(cols, function(c, index){
			var w=1;
			names.push(c.name);
			if (c.width){
				w=parseFloat(c.width);
			}
			
			var info = "";
			if (c.info){
				info = "<div class='col-info'>"+(c.info)+"</div>";
			}
			
			return "<div class='ui-col' data-name='"+(c.name)+"' data-width='"+(w)+"'> <div class='sicon'>"+(AP.data.zeroPrefix(index+1))+".</div> <div class='col-label'>"+(c.label)+"</div> "+(info)+" <div class='col-key'>"+(c.name)+"</div> </div>";
		});
		
		var values=names.join(",");
		
		var sample_preview='';
		if (opts.sample){
			sample_preview = Base.file.inline(opts.sample);
		}
		
		if (!cols || !cols.length){
			html='';
		}
		
		return "<div class='input data'> <input type='file' name='file'/> </div> <div class='hidden'><input type='hidden' name='__excel_orders' value='"+(values)+"'/></div> <div class='col-note'>Vui lĂ²ng chá»n má»™t file Excel vá»›i thá»© tá»± cĂ¡c cá»™t theo Ä‘Ăºng vá»›i danh sĂ¡ch dÆ°á»›i Ä‘Ă¢y. <em class='js-download url'>Download</em>?</div> <div class='excel-inline-wrapper scroll-y'> "+(sample_preview)+" <div class='excel-cols'> "+(html)+" </div> </div> <div class='excel-live-preview'></div>";
	};
	
	
	function getRows(cols, rows){
		var grouping=$("#internal-excel").data("grouping");
		
		var header = '';
		var tw=48;
		
		for (var key in cols){
			var c=cols[key];
			var w=parseFloat(c.width)*200;
			
			header+= "<div class='th' style='width: "+(w)+"px'>"+(c.label)+"</div>";
			tw+=w;
		};
		
		var real_index=0;
		var html = AP.render(rows, function(r, index){
			if (index==0){
				return '';
			}
			
			var temp='';
			if (grouping){
				if (!r.name){
					return '';
				}
				
				if (AP.word.suffix(r.name, ":")){
					return "<div class='tr-group'><div class='tdg'>"+(r.name)+"</div></div>";
				}
			}
			
			real_index++;
			
			for (var k in cols){
				var w=cols[k].width * 200;
				
				if (r[k]){
					temp+= "<div class='td' style='width: "+(w)+"px'>"+(r[k])+"</div>";
				}else{
					temp+="<div class='td' style='width: "+(w)+"px'></div>";
				}
			}
			
			return "<div class='tr'><div class='td index' style='width:48px'>"+(real_index)+"</div>"+(temp)+"</div>";
		});
		
		
		return "<div class='excel-table-title'>Xem trÆ°á»›c dá»¯ liá»‡u</div> <div class='excel-table-canvas'> <div class='excel-canvas scroll-x scroll-y forced-scroll'> <div class='excel-table' style='width: "+(tw)+"px'> <div class='thead'> <div class='th index' style='width:48px'>#</div> "+(header)+" </div> <div class='tbody'> <div class='td index' style='width:48px'></div> "+(html)+" </div> </div> </div> </div>";
	};
	
	
	
	function getInput(row){
		return {name: row.name, type: row.type, role: row.role?row.role:"", "placeholder": row.placeholder?row.placeholder:row.label, options: row.options||null}
	};
};


Base.io = new function __BaseIO(){
	
	this.imp = function(opts){
		return Base.importer.dialog(opts);
	};
	
	
	/**
	 * @desc Export should come from user-action, otherwise the browser should block it
	 */
	this.exp = function(opts){
		if (!opts.title){
			opts.title = "Excel export";
		}else{
			opts.title = safe(opts.title);
		}

		if (!opts.end_column) {
			opts.end_column = "DZ";
		} else {
			opts.end_column = safe(opts.end_column);
		}
		
		var data = {
			headers: Base64.encode(JSON.stringify(opts.headers)),
			rows: Base64.encode(JSON.stringify(opts.rows)),
			__is_binary: 1
		};
		
		
		// Create fake form
		var uuid = AP.uuid();
		var form = "<form id='"+(uuid)+"' method='POST' action='"+(Base.domain('api'))+"/ajax/fileservice/excel' target='__blank'> <input type='hidden' name='__code' value='"+(Client.code)+"'/> <input type='hidden' name='__sessionid' value='"+(Client.base.secureData.session)+"'/> <input type='hidden' name='__otp' value='"+(Client.base.secureData.otp)+"'/> <input type='hidden' name='title' value='"+(opts.title)+"'/> <input type='hidden' name='headers' value='"+(data.headers)+"'/> <input type='hidden' name='end_column' value='"+(opts.end_column)+"'/> <input type='hidden' name='rows' value='"+(data.rows)+"'/> </form>";
		
		$(form).appendTo("#ap-invs").submit();
		
		setTimeout(function(){
			$("#"+uuid).remove();
		}, 500);
	};
	
	
	/**
	 * @desc Pick data from gsheet
	 */
	this.gsheet = function(callback){
		Base.exchange.request({
			event: "pick.ggdrive", // custom event
			app: "drive", // APP KEY
			endpoint: "v2/google",
			width: 1200,
			title: "File picker",
			data: {},
			params: {
				test_param: 1,
			}
		});
		
		// Getting the file ID
		Base.exchange.on("pick.ggdrive", function(response){
	        callback(response);
		});
		
	};
	
};



Base.cf = new function __BaseCustomForm(){
	this.opts = {};
	
	this.init = function(opts){
		opts = $.extend({width: 1000, closable: false, data: {}, attributes: [], fixed_rows: [], title: "Chá»‰nh sá»­a"}, opts);
		if (opts.single_type){
			opts.types= [opts.single_type];
		}
		
		if (opts.types){
			var list = ARR.filter(Base.cf.defs.types, function(e){
				return ARR.find(opts.types, function(type){
					return type === e.id;
				});
			});
			
			opts.types = ARR.clone(list);
		}else{
			opts.types = ARR.clone(Base.cf.defs.types);
		}
		
		if (opts.custom_types){
			for (var i=0; i< opts.custom_types.length; i++){
				var e = opts.custom_types[i];
				opts.types.push(
					{id: e.type, icon: "form_custom", name: e.name, desc: e.content}
				);
			}	
		}
		
		this.opts = opts;
		
		var template_picker='';
		if (opts.template){
			if (parseInt(Client.system.id)==1){
				template_picker="<div class='tab url' data-url='::base/customform' data-action='export.json'>Export template</div> <div class='tab url' data-url='::base/customform' data-action='import.template'>Import template</div> <div class='tab url hidden' data-url='::base/customform' data-action='save'>LÆ°u</div>";
			}else{
				template_picker='';
			}
		}
		
		var scta='';
		
		if (opts.single_type){
			scta="<div class='cta url' data-url='::base/customform' data-action='add' data-type='"+(opts.single_type)+"'>ThĂªm trÆ°á»ng má»›i</div>";
		}else{
			var added_opts = AP.render(opts.types, function(e){
				return "<div class='-item url' data-url='::base/customform' data-action='add' data-type='"+(e.id)+"'>"+(e.name)+"</div>";
			});
			
			scta="<div class='cta url -dd -cmenuw'>ThĂªm trÆ°á»ng má»›i " +Render.render('cmenu', {}, ""+(added_opts)+"")+ "</div>";
		}
		
		var mh = Base.cf.opts.types.length*60+100;
		
		var html = "<div id='base-master-dialog'> <div class='header "+(opts.single_type?'-st':'')+"'> <div class='title'>"+(this.opts.title)+"</div> <div class='tabs clear-fix'> <div class='tab active'>Chá»‰nh sá»­a</div> <div class='tab url' data-url='::base/customform' data-action='preview'>Xem trÆ°á»›c</div> <div class='tab url' data-url='::base/customform' data-action='export'>Xuáº¥t</div> <div class='tab url' data-url='::base/customform' data-action='import'>Nháº­p</div> "+(template_picker)+" </div> <div class='side'> <div class='close' onclick='Base.cf.close();'><span class='-ap icon-close'></span></div> </div> "+(scta)+" </div> <div class='body "+(opts.single_type?'-st':'')+"'> <div class='fields-preview'> <div class='box' style='min-height:"+(mh)+"px'>"+(getFields())+"</div> </div> <div class='fields-sidebar'> <div class='sidebar-header'> <div class='title'>Field types</div> <div class='info'>Drag and drop fields to build form</div> </div> <div class='row-lists'> "+(getSupportedTypes())+" </div> </div> </div> </div>";
		
		AP.customDialog(html, "cf-dialog").width(opts.width).style("-full").closable(opts.closable).show();
		AP.dialog("cf-dialog").balance();
		initDragInitializer();
		
		UI.ajaxShow();
		setTimeout(function(){
			UI.ajaxHide()
		},200);
		
		if (opts.refresh){
			$("#base-master-dialog").addClass("-refreshable");
		}
	};
	
	
	this.close = function(ref){
		if ($("#base-master-dialog").hasClass("-should-refresh") && $("#base-master-dialog").hasClass("-refreshable")){
			return AP.refresh();
		}
		
		AP.dialog("cf-dialog").hide();
	};
	
	
	this.update = function(){
		$("#base-master-dialog .fields-preview .box").html("<div class='js-fields relative xo'>"+(getFields())+"</div>");
		initFieldHandlers();
		Base.cf.onUpdated(this.opts.rows);
		
		$("#base-master-dialog").addClass("-should-refresh");
	};
	
	
	this.onUpdated = function(rows){
		
	};
	
	
	this.data = function(data){
		var obj = shallowClone(this.opts.data);
		var attributes = AP.select(this.opts.attributes, function(e){
			if (e.name){
				return e.name;
			}
			
			return null;
		});
		
		if (this.opts.groups){
			attributes.push("group_id");
		}
		
		obj.attributes = attributes.join(",");

		obj.groups = AP.array.select(this.opts.groups, function (group) {
			return group.value;
		}).join(",");

		obj.types = AP.array.select(this.opts.types, function (type) {
			return type.id;
		}).join(",");

		return $.extend(data, obj);
	};
	
	
	
	this.previewHTML = function(rows){
		return AP.render(rows, getField);
	};
	
	function getFields(){
		var fields = "";
		
		if (Base.cf.opts.groups){
			ARR.buckets(Base.cf.opts.rows, Base.cf.opts.groups, function(row, g){
				return row.group_id == g.value;
			});
			
			fields = AP.render(Base.cf.opts.groups, function(g){
				var fields= AP.render(g.items, getField);
				var fixed_rows = AP.render(Base.cf.opts.fixed_rows, function(fr){
					if (fr.group_id == g.value){
						return "<div class='field -locked'> <div class='icon'>"+(SVG.form_lock)+"</div> <div class='name'>"+(fr.label||fr.name)+"</div> </div>";
					}
					
					return "";
				});
				
				
				return "<div class='fields-group'> <div class='fg-header url' data-url=':collapse:parent'>"+(g.label)+"<code>"+(g.value)+"</code></div> <div class='fg-body'> "+(fixed_rows)+" <div class='js-fields relative xo'> "+(fields)+" </div> </div> </div>";
			});
			
		}else{
			fields = AP.render(Base.cf.opts.rows, function(e){
				return getField(e);
			});
			
			fields = "<div class='js-fields relative xo'>"+(fields)+"</div>";
		}
		
		
		
		if (!Base.cf.opts.rows || !Base.cf.opts.rows.length){
			return "<div class='js-fields'><div class='empty-state'> "+(SVG.base_tick)+" <div class='add url' data-url='::base/customform' data-action='add' data-type='text'>ThĂªm trÆ°á»ng má»›i</div> </div></div>";
		}
		
		return fields;
	};
	
	function getField(e){
		var extra = '';
		var icon = SVG["form_"+e.type];
		var ftype="<span>"+(e.type)+"</span>";
		
		if (e.type=="int"){
			icon = SVG["form_number"];
		}
		
		if (e.type=="select-m"){
			icon = SVG["form_select_m"];
		}
		
		if (e.type=="float"){
			icon = SVG["form_decimal"];
		}
		
		if (!icon){
			icon = SVG["form_custom"];
		}
		
		if (e.type == 'select' || e.type == 'select-m'){
			extra = AP.render(e.options, function(opt){
				return "<div class='opt'> <div class='move'>"+(SVG.form_move)+"</div> <div class='cb'></div> "+(opt)+" </div>";
			});
			
			extra = "<div class='opts -"+(e.type)+"'>"+(extra)+"</div>";
		}
		
		var ph="<div class='-ph inline'>ChÆ°a cĂ³ miĂªu táº£</div>";
		if (e.placeholder && e.placeholder.length){
			ph="<div class='-ph inline'>"+(e.placeholder)+"</div>";
		}
		
		if (e.type == "input-table"){
			ph="<div class='-ph inline'>Äá»‹nh nghÄ©a báº£ng dá»¯ liá»‡u</div>";
		}
		
		var group_name="";
		if (Base.cf.opts && Base.cf.opts.groups){
			var g = ARR.find(Base.cf.opts.groups, function(gr){
				return gr.value == e.group_id;
			});
			
			if (g){
				group_name="<div class='group-name hidden'>"+(g.label)+"</div>";
			}
		}
		
		return "<div class='field -"+(e.type)+"' data-id='"+(e.id)+"'> <div class='display'> <div class='side'> <div class='action url' data-url='::base/customform' data-action='field.edit' data-id='"+(e.id)+"'>Chá»‰nh sá»­a</div> <div class='action url' data-url='::base/customform' data-action='field.remove' data-id='"+(e.id)+"'>XĂ³a</div> </div> <div class='icon'>"+(icon)+"</div> <div class='status js-sicon'><div class='micon'><div></div></div></div> <div class='drag-handler'></div> <div class='name'>"+(e.name)+"</div> "+(group_name)+" <div class='field-key'> <div class='key'><code class='url' data-url='::base/customform' data-action='field.set_key' data-id='"+(e.id)+"'>"+(e.id)+"</code> &mdash; "+(ph)+" <span class='-ftype'>"+(ftype)+"</span> </div> </div> <div class='field-attrs'>"+(getAttributes(e))+"</div> <div class='extra'>"+(extra)+"</div> </div> </div>";
		
	};
	
	
	
	/**
	 * @desc Get all supported types
	 */
	function getSupportedTypes(){
		var types = Base.cf.opts.types;
		
		return AP.render(types, function(e){
			return "<div class='li url' data-url='::base/customform' data-action='add' data-type='"+(e.id)+"'> <div class='micon'><div></div></div> <div class='icon'>"+(SVG[e.icon])+"</div> <div class='name'>"+(e.name)+"</div> <div class='info'>"+(e.desc)+"</div> </div>";
		});
	};
	
	
	/**
	 * @desc Initialize drag
	 */
	function initDragInitializer(){
		initFieldHandlers();
		
		$("#base-master-dialog .row-lists .li").draggable({
			helper: "clone",
			connectToSortable: "#base-master-dialog .js-fields",
		});
	};
	
	
	
	function initFieldHandlers(){
		$("#base-master-dialog .js-fields").sortable({
			handle: ".drag-handler",
			axis: "y",
			stop: function(event, ui){
				if ($(ui.item).hasClass("li")){
					var position = $(ui.item).index();
					var type = $(ui.item).data("type");
					$(ui.item).remove();
					
					Base.cf.form.add({position: position, type: type});	
				}else{
					var id=$(ui.item).data("id");
					var order=$(ui.item).index();
					
					UI.ajaxShow();
					
					AP.post(Base.cf.opts.action+"/sortable", Base.cf.data({
						row_id: id, index: order
					}), function(code){
						UI.ajaxHide();
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						Base.cf.opts.rows = code.rows;
						Base.cf.update();
						
						UI.flash("Successfully updated");
						AP.requireReset();
					});
				}
			}
		});
		
		$("#base-master-dialog .js-fields").droppable({
			drop: function(event, ui){
				var index = $(ui.helper).index();
			},
			drop: function(event, ui){
			},
			accept: ".js-field-btn",
			hoverClass: "cf-active-droppable"
		});
		
		$("#base-master-dialog .js-fields .field .opts").each(function(){
			$(this).sortable({
				axis: "y",
				stop: function(event, ui){
					$.log(ui);
				}
			});
		});
	};
	
	
	
	function getAttributes(e){
		var atts = Base.cf.opts.attributes;
		if (!atts){
			return '';
		}
		
		var html = '';
		for (var i=0; i<atts.length; i++){
			var att= atts[i];
			if (e[att.name]){
				var v = e[att.name];
				var dv = v;
				if (att.options && att.options.length){
					for (var j=0; j< att.options.length; j++){
						if (att.options[j].value == v){
							dv = att.options[j].label;
						}
					}
				}
				
				html+="<div class='attr'> <em>"+(att.label)+":</em> <span class='url' data-url='::base/customform' data-action='field.edit' data-id='"+(e.id)+"'>"+(dv)+"</span> </div>";
			}
		}
		
		if (html && html.length){
			return "<div class='attrs'>"+(html)+"</div>";	
		}
		
		
		return '';
	};
	
};


Base.cf.form = new function __BaseCFForm(){
	/**
	 * @desc Add a new custom field
	 */
	this.add=function(opts){
		opts = $.extend({type: "text", position: -1, data: {}}, opts);
		
		var rows=[
			{label: "TĂªn trÆ°á»ng", name: "name", style:"-big"},
			{label: "Loáº¡i dá»¯ liá»‡u", name: "metatype", options: fieldTypes(), value: opts.type},
			{label: "CĂ¡c lá»±a chá»n, cĂ¡ch nhau báº±ng má»™t dáº¥u pháº©y *", name:"options", type:"textarea"},
			{label: "Äá»‹nh nghÄ©a báº£ng dá»¯ liá»‡u", type: "input-objects", name: "table_defs", options: [
				{label: "TĂªn cá»™t *", width: 20, name: "name"},
				{label: "Type *", width: 13, name: "type", type: "select", options: ["text", "number", "select"]},
				{label: "Äá»™ rá»™ng", placeholder: "Width", width: 10, name: "width"},
				{label: "CĂ¡c lá»±a chá»n (options)", width: 20, name: "options"},
			]},
			{type: 'hidden', value: opts.position, name: 'position'}
		];
		
		if (Base.cf.opts.attributes){
			for (var i=0; i < Base.cf.opts.attributes.length; i++){
				rows.push(Base.cf.opts.attributes[i]);
			}
		}

		if (Base.cf.opts.groups){
			rows.push({label: "NhĂ³m", name: "group_id", options: Base.cf.opts.groups});
		}
		
		rows.push({label: "MiĂªu táº£ ngáº¯n", name: "content", type:"textarea"});
		
		Form.v2({
			width: 600,
			rows: rows,
			title: "ThĂªm trÆ°á»ng má»›i",
			action: Base.cf.opts.action+"/add",
			data: Base.cf.data({}),
			buttons: Form.button(":submit", function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Base.cf.opts.rows = code.rows;
				Base.cf.update();
				
			}).button(":cancel"),
			render: function(){
				render(this);
			}
		});
	};
	
	
	
	/**
	 * @desc Edit a row
	 */
	this.edit=function(row, callback){
		var opts = "";
		if (row.options){
			opts = row.options.join(", ");
		}
		
		var value = [];
		if (row.type == "input-table"){
			value = AP.json.parse(Base64.decode(row.placeholder));
			$.log(value);
		}
		
		
		var rows=[
			{label: "TĂªn trÆ°á»ng", name: "name", style:"-big", value: row.name},
			{label: "Loáº¡i dá»¯ liá»‡u", name: "metatype", options: fieldTypes(), value: row.type},
			{label: "CĂ¡c lá»±a chá»n, cĂ¡ch nhau báº±ng má»™t dáº¥u pháº©y *", name:"options", type:"textarea", value: opts},
			
			{label: "Äá»‹nh nghÄ©a báº£ng dá»¯ liá»‡u", type: "input-objects", name: "table_defs", value: value, options: [
				{label: "TĂªn cá»™t *", width: 20, name: "name"},
				{label: "Type *", width: 13, name: "type", type: "select", options: ["text", "number", "select"]},
				{label: "Äá»™ rá»™ng", placeholder: "Width", width: 10, name: "width"},
				{label: "CĂ¡c lá»±a chá»n (options)", placeholder: "CĂ¡ch nhau báº±ng dáº¥u pháº£y", width: 20, name: "options"},
			]},
		];
		
		if (Base.cf.opts.attributes){
			for (var i=0; i<Base.cf.opts.attributes.length; i++){
				var t=shallowClone(Base.cf.opts.attributes[i]);
				t.value=row[t.name]
				rows.push(t);
			}
		}
		
		if (Base.cf.opts.groups){
			rows.push({label: "NhĂ³m", name: "group_id", options: Base.cf.opts.groups, value: row.group_id||null});
		}
		
		var ph = '';
		if (row.placeholder){
			ph = row.placeholder.replace(/\-\-br\-\-/g,"<br>");
		}
		rows.push({label: "MiĂªu táº£ ngáº¯n", name: "content", type:"textarea", value: ph});
		
		Form.v2({
			width: 600,
			data: Base.cf.data({row_id: row.id}),
			rows: rows,
			title: "Chá»‰nh sá»­a má»™t trÆ°á»ng tĂ¹y chá»‰nh",
			action: Base.cf.opts.action+"/edit",
			buttons: Form.button(":submit", function(code){
				if (code.rows){
					Base.cf.opts.rows = code.rows;
					Base.cf.update();	
				}else if (code.row){
					Base.cf.opts.rows = ARR.insertByID(Base.cf.opts.rows, code.row);
					Base.cf.update();	
				}
			}).button(":cancel"),
			render: function(){
				render(this);
			}
		});
		
	};


	/**
	 * @desc Edit field key
	 */
	this.editKey=function(row, callback){
		var rows=[
			{label: "TĂªn trÆ°á»ng", type: "fake", value: row.name},
			{label: "Field API ID", name: "row_key", value: row.id}
		];
		
		Form.v2({
			data: Base.cf.data({row_id: row.id}),
			rows: rows,
			title: "Edit field key (API key)",
			action: Base.cf.opts.action+"/edit.key",
			buttons: Form.button(":submit", function(code){
				if (code.rows){
					Base.cf.opts.rows = code.rows;
					Base.cf.update();
				}
			}).button(":cancel"),
			render: function(){
				render(this);
			}
		});
	};
	
	
	/**
	 * @desc Remove arow
	 */
	this.remove = function(row){
		Form.confirm({
			message: "Please confirm to remove this field",
			action: Base.cf.opts.action+"/remove",
			data: Base.cf.data({row_id: row.id}),
			success: function(code){
				Base.cf.opts.rows = ARR.removeByID(Base.cf.opts.rows, row.id);
				Base.cf.update();
			}
		});
	};
	
	
	/**
	 * @desc Save all current rows (Base.cf.opts.rows) into database
	 */
	this.saveAll = function(){
		UI.ajaxShow();
		AP.post(Base.cf.opts.action+"/saveall", Base.cf.data({json: Base64.encode(JSON.stringify(Base.cf.opts.rows))}), function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (code.rows){
				Base.cf.opts.rows = code.rows;
				Base.cf.update();
			}
			
			UI.flash("Save successfully");
			
		});
	};
	
	
	
	/**
	 * @desc After-rendering callback
	 */
	function render(f){
		f.find("metatype").on("change", function(){
			var val=$(this).val();
			if (val=="select" || val=="select-m"){
				f.findRow("options").show();
			}else{
				f.findRow("options").hide();
			}
			
			if (val == "input-table"){
				f.findRow("table_defs").show();
				f.findRow("content").hide();
			}else{
				f.findRow("table_defs").hide();
				f.findRow("content").show();
			}
			
		}).change();
	};
	
	
	/**
	 * @desc Return a list of types of questions
	 */
	function fieldTypes(){
		return ARR.select(Base.cf.opts.types, function(e){
			return {value: e.id, label: e.name};
		});
	};
	
	
	function requiredOptions(){
		return [{value: "0", label: "No / Optional input"}, {value: 1, label: "Yes / Required input"}];
	};
	
};


Base.cf.handler = new function __BaseCFHandler(){
	
	this.on = function(event, ref){
		if (event == "add"){
			return Base.cf.form.add({
				type: $(ref).data("type")
			});
		}
		
		if (event == "field.edit"){
			var row = ARR.findObj(Base.cf.opts.rows, $(ref).data("id"));
			if (!row){
				return;
			}
			
			return Base.cf.form.edit(row);
		}
		
		if (event == "field.set_key"){
			var row = ARR.findObj(Base.cf.opts.rows, $(ref).data("id"));
			if (!row){
				return;
			}
			
			return Base.cf.form.editKey(row);
		}
		
		
		if (event == "field.remove"){
			var row = ARR.findObj(Base.cf.opts.rows, $(ref).data("id"));
			if (!row){
				return;
			}
			
			return Base.cf.form.remove(row);
		}
		
		if (event == "preview"){
			return this.preview();
		}
		
		if (event == "export"){
			return this.exp();
		}

		if (event == "import"){
			return this.import();
		}
		
		if (event == "export.json" || event == "export.template"){
			return this.expJSON();
		}
		
		if (event == "import.template"){
			return this.importTemplate();
		}
		
		if (event == "save"){
			return Base.cf.form.saveAll();	
		}
	};
	
	
	/**
	 * @desc Preview a form
	 */
	this.preview = function(){
		var rows = [
			{type: "custom_form", rows: Base.cf.opts.rows}
		];
		
		Form.v2({
			rows: rows,
			buttons: Form.button(":continue", function(){
				AP.alertSuccess("You've seeen custom fields in regular form");
			}).button(":cancel"),
			title: "Custom form preview",
			width: 640
		});
	};
	
	
	this.exp = function(){
		var headers = ["Field", "Key", "Type", "Description", "Available Options"];

		if (Base.cf.opts.groups) {
			headers.push("Group");
		}

		if (Base.cf.opts.attributes){
			for (var i=0; i < Base.cf.opts.attributes.length; i++){
				headers.push(Base.cf.opts.attributes[i].label);
			}
		}

		var rows = [];
		for (var i=0; i<Base.cf.opts.rows.length; i++){
			var row = Base.cf.opts.rows[i];
			var data = [row.name, row.id, row.type, row.placeholder, (row.options && row.options.length)?row.options.join(","):""];

			if (Base.cf.opts.groups) {
				data.push(row.group_id);
			}

			if (Base.cf.opts.attributes){
				for (var j=0; j < Base.cf.opts.attributes.length; j++){
					data.push(row[Base.cf.opts.attributes[j].name]);
				}
			}

			rows.push(data);
		}
		
		Base.io.exp({
			headers: headers,
			rows: rows,
			title: "Export custom fields"
		});
		
	};


	this.import = function(){
		var columns = [
			{label: "TĂªn trÆ°á»ng", name: "name"},
			{label: "Loáº¡i dá»¯ liá»‡u", name: "type"},
			{label: "MiĂªu táº£ ngáº¯n", name: "placeholder"},
			{label: "CĂ¡c lá»±a chá»n", name:"options"}
		];

		if (Base.cf.opts.attributes){
			columns = columns.concat(Base.cf.opts.attributes);
		}

		if (Base.cf.opts.groups){
			columns.push({label: "NhĂ³m", name: "group_id"});
		}

		Base.importer.dialog({
			action: Base.cf.opts.action+"/import",
			columns: columns,
			rows: [{label: "Import from row", name: "from_row", value: 2}],
			hiddens: Base.cf.data({}),
			title: "Import custom fields"
		});

	};
	
	
	this.expJSON = function(){
		var data = JSON.stringify({rows: Base.cf.opts.rows, type: "custom.form"}, null, 2);
		
		var rows = [
			[
				{label: "Application", type: "fake", value: Client.base.app},
				{label: "Feature", type: "fake", value: Base.cf.opts.template.feature}
			],
			{label: "JSON data", value: data, type: "textarea", height:300, verbatim: 1}
		];
		
		Form.v2({
			rows: rows,
			title: "Export to structured template",
			buttons: Form.button(":ok").button(":cancel")
		});
	};
	
	
	this.importTemplate = function(){
		Base.picker.template({
			app: Client.base.app,
			feature: Base.cf.opts.template.feature,
			multi: 0,
			title: "Select a form",
			callback: function(templates){
				if (templates.items && templates.items.length){
					return Base.cf.handler.applyTemplate(Base64.decode(templates.items[0].data));
				}
			}
		});
	};
	
	
	this.applyTemplate = function(template){
		var obj = JSON.parse(template);
		if (!obj || !AP.data.isObject(obj)){
			return;
		}
		
		var rows = obj.rows;
		for (var i=0; i<rows.length; i++){
			Base.cf.opts.rows.push(rows[i]);	
		}
		
		Base.cf.opts.rows = ARR.uniqueObjects(Base.cf.opts.rows);
		Base.cf.update();
		
		Base.cf.form.saveAll();
	};
	
};


Base.cf.filler = new function __BaseCFFiller(){
	this.init = function(opts){
		var rows = AP.render(opts.rows, function(e, index){
			return getRow(e, index, opts);
		});
		
		var footer = '';
		if (opts.footer){
			footer = "<div class='cf-fillter-footer'>"+(opts.footer.apply(opts))+"</div>";
		}
		
		$(opts.canvas).html("<div class='cf-filler-canvas'> <div class='js-fields'>"+(rows)+"</div> "+(footer)+" </div>");
		
		Form.render(opts.canvas);
		bindEvents(opts.canvas);
		initForm(opts);
	};
	
	
	function getRow(e, index, opts){
		var name = getName(e, opts);
		
		var extra = '';		
		var value='';
		
		var ph='';
		if (e.placeholder && e.placeholder.length){
			ph="<div class='ph'>"+(e.placeholder)+"</div>";
		}
		
		if ("value" in e && e.value!== null){
			value=e.value;
		}
		
		if (e.type == 'select' || e.type == 'select-m'){
			var is_compact = true;
			extra = AP.render(e.options, function(opt){
				if (opt && opt.length>=24){
					is_compact = false;
				}
				
				return "<div class='opt' data-value='"+(opt)+"'> <div class='cb'></div> "+(opt)+" </div>";
			});
			
			extra = "<div class='opts -"+(e.type)+" "+(is_compact?'-compact':'')+" clear-fix' data-value='"+(value)+"'>"+(extra)+"</div>";
		}else if (e.type=="text"){
			extra = "<div class='input'><input class='js-input' type='text' placeholder='Enter your answer' value='"+(value)+"'/></div>";
		}else if (e.type=="date"){
			extra = "<div class='input'><input class='js-input' type='text' placeholder='Enter your answer' data-role='date' value='"+(value)+"'/></div>";
		}else if (e.type=="int" || e.type=="float"){
			extra = "<div class='input'><input class='js-input' type='text' placeholder='Enter your answer' data-role='int' value='"+(value)+"'/></div>";
		}else if (e.type=="int" || e.type=="textarea"){
			extra = "<div class='input'><textarea class='js-input' placeholder='Enter your answer'>"+(value)+"</textarea></div>";
		}else if (e.type=="checkbox"){
			extra = "<div class='opts -is-checkbox' data-value='"+(value)+"'> <div class='opt' data-value='1'><div class='cb'></div> Yes</div> <div class='opt' data-value='0'><div class='cb'></div> No</div> </div>";
		}else if (e.type=="input-editor" || AP.word.prefix(e.type, "input-")){
			extra = "<div class='input'> " +Render.render('form_input', {type:e.type, _name:e.id, placeholder:e.placeholder, value:value}, '')+ "</div>";
			
			ph = '';
		}
		
		
		
		var required='';
		var hcounter = "<span class='hidden hidden-counter'>"+(AP.data.zeroPrefix(index+1))+". </span>";
		
		if (parseInt(e.required)){
			required="<div class='status js-sicon'><b>*</b> <span>Required</span></div>";
			hcounter = "<span class='hidden hidden-counter'>"+(AP.data.zeroPrefix(index+1))+". </span>";
		}
		
		return "<div class='field -is-"+(e.type)+"' data-id='"+(e.id)+"' data-type='"+(e.type)+"'> <div class='display'> <div class='counter'>"+(AP.data.zeroPrefix(index+1))+".</div> "+(required)+" <div class='name'> "+(hcounter)+" "+(name)+" </div> "+(ph)+" <div class='extra'>"+(extra)+"</div> </div> </div>";
		
		
		
	};
	
	
	function bindEvents(canvas){
		$(canvas).bind("filler/react", function(){
			var answers = collectAnswers(this);
			
			var done=0;
			var total=0;
			
			for (var key in answers){
				total++;
				if (answers[key].length>=1){
					done++;
				}
			}
			
			$(canvas).trigger("filler/updated", {
				answers: answers,
				done: done,
				total: total,
			});
		});
		
		
		$(canvas).find(".opts").each(function(){
			$(this).find(".opt").on("click", function(){
				$(this).toggleClass("selected");
				var $box=$(this).closest(".opts");
				if ($box.hasClass("-select-m")){
				}else{
					$(this).siblings().removeClass("selected");
				}
				
				$(canvas).trigger("filler/react");
			});
			
			var value = $(this).data("value");
			if (typeof value!=undefined && value!==null){
				var values = (""+value).split(",");
				
				$(this).find(".opt").each(function(){
					if (isSelected($(this).data("value"), values)){
						$(this).addClass("selected");
					}
				});
			}
			
		});
		
		$(canvas).find(".js-input").each(function(){
			$(this).on("input change", function(){
				$(this).closest(".js-filler-canvas").trigger("filler/react");
			});
		});
	};
	
	
	function initForm(opts){
		$(opts.canvas).addClass("js-filler-canvas").bind("filler/submit", function(){
			var answers = collectAnswers(this);
			var data = $.extend({}, opts.data);
			for (var key in answers){
				data[key] = answers[key].join(", ");
			}
			
			var extra = $(this).find(".cf-fillter-footer").find(":input").serializeArray();
			extra = assoc(extra);
			for (var key in extra){
				data[key] = extra[key];
			}
			
			UI.ajaxShow();
			AP.post(opts.action, data, function(code){
				UI.ajaxHide();

				if (opts.success) {
					opts.success(code);
				} else {
					if (!code.good()){
						return AP.alertError(code.message);
					}
				}
			});

		});
		
		
		if (opts.button){
			$(opts.button).on("click", function(){
				$(opts.canvas).trigger("filler/submit");
			});
		}
		
		if (opts.update){
			$(opts.canvas).on("filler/updated", function(e, data){
				var fn = opts.update;
				fn.apply(this, [data]);
			});
		}
		
	};
	
	
	function collectAnswers(canvas){
		var r = {};
		$(canvas).find(".field").each(function(){
			var id = $(this).data("id");
			var type = $(this).data("type");
			
			if (type == "checkbox" || type == "select" || type == "select-m"){
				r[id] = collectSelectedOpts(this);
			}else{
				var v =$(this).find(".js-input").val();
				
				if (v && v.length){
					r[id] = [v];	
				}else{
					r[id] = [];
				}
				
			}
		});
		
		return r;
	};
	
	
	function collectSelectedOpts(row){
		var v = [];
		$(row).find(".opt.selected").each(function(){
			v.push($(this).data("value"));
		});
		
		return v;
	};
	
	
	function isSelected(value, accepted){
		value=""+value;
		
		for (var i=0; i<accepted.length; i++){
			if ($.trim(accepted[i]) == $.trim(value)){
				return true;
			}
		}
		
		return false;
	};
	
	
	function getName(e, opts){
		if ('translation' in opts){
			return opts.translation(e.name);
		}
		
		return e.name;
	};
	
};


Base.cf.defs = new function __BaseCFDefs(){

	this.types = [
		{id: "text", icon: "form_text", name: "Text", desc: "Single line of text"},
		{id: "int", icon: "form_number", name: "Number (integer)", desc: "Number, integer value"},
		{id: "float", icon: "form_decimal", name: "Number, decimal-point", desc: "Number, with decimals"},
		{id: "textarea", icon: "form_textarea", name: "VÄƒn báº£n Ä‘oáº¡n", desc: "Text with multiple lines"},
		{id: "select", icon: "form_select", name: "Dropdown, single", desc: "Select a single choice"},
		{id: "select-m", icon: "form_select_m", name: "Dropdown, multiple", desc: "Select multiple choices"},
		{id: "date", icon: "form_date", name: "NgĂ y", desc: "Date type, select a date"},
		{id: "datetime", icon: "form_date", name: "NgĂ y giá»", desc: "Datetime type, select date and time"},
		{id: "checkbox", icon: "form_checkbox", name: "Checkbox", desc: "Single checkbox"}
	];
	
	
	this.html = function(){
		return '';
	};
	
};


Base.cf.preview = function(opts){
	if (opts.onUpdated){
		Base.cf.onUpdated = opts.onUpdated;
	}
	
	if (!opts.rows || !opts.rows.length){
		$(opts.canvas).html("<div class='base-cf-preview'> " +Render.render('empty', {icon: "ap file" , title: "KhĂ´ng cĂ³ trÆ°á»ng dá»¯ liá»‡u" , sm:1}, "KhĂ´ng cĂ³ trÆ°á»ng tĂ¹y chá»‰nh nĂ o Ä‘Æ°á»£c cĂ i Ä‘áº·t")+ "</div>");
		return;
	}

	var html = Base.cf.previewHTML(opts.rows);
	if (opts.url){
		$(opts.canvas).html("<div class='base-cf-preview url' data-url='"+(opts.url)+"'>"+(html)+"</div>");
	}else{
		$(opts.canvas).html("<div class='base-cf-preview'>"+(html)+"</div>");	
	}
	
};







var Render = new function __Render(){
	this._uis={};
	this._events={};
	this._event_queues = [];
	
	this._debug = 0;
	
	this.__cache_data = {};
	
	this.__custom_uis = {};
	
	this.__tpls = {};
	this.__tpl_callbacks = {};
	
	var __ignores = {};
	
	this.on = function(ui, render, events){
		if (AP.data.isArray(ui)){
			for (var i=0; i<ui.length; i++){
				this.on(ui[i], render, events);
			}
			return;
		}
		
		var __evs = events;
		if (AP.data.isFunction(events)){
			__evs = {done: events};
		}
		
		if (!__evs){
			__evs = {};
		}
		
		this._uis[ui.replace(/-/g,'_')] = render;
		this._events[ui.replace(/-/g,'_')] = __evs;
		
	};
	
	this.uis = function(filter){
		if (!filter){
			return this._uis;	
		}
		
		filter = filter.replace(/-/g,'_');
		
		var obj = {};
		for (var key in this._uis){
			if (key.indexOf(filter)!=-1){
				obj[key] = this._uis[key];
			}
		}
		
		return obj;
	};
	
	this.render = function(ui, attrs, content){
		if (!attrs.id){
			attrs.id = AP.uuid();
		}
		
		if (!this._uis[ui]){
			if (attrs.render_directive){
				this.detectRenderClass(ui);
			}else{
				this.detectRenderClass(ui);	
			}
		}
		
		if (!this._uis[ui]){
			if (!parseInt(Client.env)){
				console.warn("NO UI render for "+ui);	
			}
			
			var obj = new BaseComponent(attrs);
			var ec = ui.replace(/_/g,'-');
			if (ec.indexOf("-")==-1){
				ec='';
			}
			
			if (attrs.url){
				obj.addClass("url");
			}
			
			if ('acl' in attrs && !Render.helper.acl(attrs.acl)){
				return '';
			}
			
			if (attrs.fit){
				obj.addClass('ap-xdot');
			}
			
			if (attrs.inline){
				obj.addClass('inline');
			}
			
			if (attrs.upper){
				obj.css("text-transform", "uppercase");
			}
			
			if (attrs.fs){
				obj.css("font-size", attrs.fs+"px");
			}
			
			if ('color' in attrs){
				obj.addStatusColor(attrs.color);
				obj.css("color", Color.get(obj.color));
			}
			
			return "<div class='base-"+(ui)+" "+(ec)+" "+(obj.get('class'))+"' "+(obj.show('id'))+" "+(obj.css())+" "+(obj.show('url'))+" "+(obj.showAllHTMLEvents())+" "+(obj.showAllData())+">"+(content)+"</div>";
		}
		
		var fn = this._uis[ui];
		var obj = new BaseComponent(attrs);
		
		obj.name=ui;
		obj.content=content;
		
		attrs.name = ui;
		
		if (this._events[ui] && this._events[ui]["done"]){
			var done = this._events[ui]["done"];
			this._event_queues.push({fn: done, attrs: safeClone(attrs), obj: obj});
			
			if (this._debug){
				$.log(["EVENT REGISTERED", ui, obj.id, done]);
			}
		}
		
		if (attrs.react && attrs[attrs.react]){
			AP.watcher.register(obj, attrs);
		}
		
		return fn.apply(obj);
	};
	
	
	this.template = function(key, obj, render){
		if (AP.data.isFunction(obj)){
			this.__tpls[key] = obj;
			if (render && AP.data.isFunction(render)){
				this.__tpl_callbacks[key] = render;
			}
				
			return;
		}

		var fn = this.__tpls[key];
		if (!fn){
			return '';
		}
		
		var cb = this.__tpl_callbacks[key] || null;
		
		if (cb){
			this._event_queues.push({fn: cb, attrs: safeClone(obj._params), obj: obj});
		}
		
		return fn.apply(obj).replace(/\{content\}/g, render);
	};
	
	
	/**
	 * @desc Update based on selecotr
	 */
	this.update = function(selector, event, data){
		if (!$(selector).length){
			$.log("RENDER.update failed for event "+event+" ~ no selector found");
			return;
		}
		
		$(selector).each(function(){
			var ui = $(this).data("ui");
			if (!ui || !Render._events[ui]){
				return;
			}
			
			var ev_def = Render._events[ui];
			if (!ev_def || !ev_def[event]){
				return;
			}
			
			var cb = ev_def[event];
			
			if (AP.data.isArray(data)){
				cb.apply(this, data);	
			}else{
				cb.apply(this, [data]);
			}
			
		});
	};
	
	
	this.finish = function(){
		if (!this._event_queues.length){
			return;
		}
		
		while (true){
			if (!this._event_queues.length){
				return;
			}
			
			var ex = this._event_queues.shift();
			
			var $selector = $("#"+ex.attrs.id);
			if (!$selector.length){
				if (this._debug){
					$.log("COMPONENT DEBUG: ELEMENT NOT FOUND - "+ex.attrs.id);
				}
				continue;
			}
			
			ex.fn.apply($selector[0], [ex.attrs, ex.obj]);
		}
	};
	
	
	this.debug = function(){
		this._debug = 1;
		$.log(this._event_queues);
	};
	
	
	/**
	 * @desc Checking acl of a component
	 */
	this.acl = function(comp){
		if ('require' in comp && !Render.helper.acl(comp.require)){
			return false;
		}
		
		if ('acl' in comp && !Render.helper.acl(comp.acl)){
			return false;
		}
		
		return true;
	};
	
	
	this.remove = function(id){
		this._event_queues = ARR.select(this._event_queues, function(e){
			return !e.attrs || e.attrs.id!= id; 
		});
	};
	
	
	this.interval = function(elem_id, callback, timer){
		timer = timer || 1000;
		var _ix = null;
		
		_ix = setInterval(function(){
			var $elem = $(elem_id);
			
			if (!$elem.length){
				if (_ix){
					clearInterval(_ix);	
				}
			}
			
			callback.apply($elem, [elem_id, timer]);
		}, timer);
		
	};
	
	
	/**
	 * @desc Define custom render, useful for later
	 */
	this.def = function(key, fn){
		if (!key || typeof key == "undefined"){
			return null;
		}
		
		if (!fn || typeof fn == "undefined"){
			if (this.__custom_uis[key]){
				return this.__custom_uis[key];
			}
			
			return null;
		}else{
			this.__custom_uis[key] = fn;
		}
		
	};
	
	
	this.matchURL = function(url, obj){
		return url.replace(/:([\w\-\_]+)/g, function(m, p){
			if (obj[p]){
				return obj[p];
			}
		});
	};
	
	
	this.detectRenderClass = function(ui){
		if (__ignores[ui]){
			return;
		}
		
		var render_directive = "";
		var cui = ui;
		
		if (ui.indexOf(":")!=-1){
			var parts = ui.split(":");
			if (parts.length == 2){
				render_directive = parts[1];
				cui = parts[0];
			}
		}
		
		var normalized = cui.replace(/[\-\_]\w/g, function(m){
			return m.substr(1).toUpperCase();
		});
		
		normalized = normalized.charAt(0).toUpperCase() + normalized.slice(1)+"Render";
		
		var __fn = window[normalized];
		if (!__fn){
			__ignores[ui] = 1;
			return null;
		}
		
		var r = new __fn();
		
		if (r.update || r.done){

			if (r.done){
				Render.on(ui, function(){
					return r.render.apply(this);
				}, function(params, obj){
					r.done.apply(this, [params, obj]);
				});
			}else{
				Render.on(ui, function(){
					return r.render.apply(this);
				}, function(params, obj){
					// r.update.apply(this, [params, obj]);
					
					var _r = new __fn();
					for (var key in obj){
						if (!AP.data.isFunction(obj[key])){
							_r[key] = obj[key];
						}
						_r.$elem=$(this);
					}
				
					_r.update.apply(_r, [this]);
				});	
			}
		}else if (r.render){
			if (render_directive){
				var rd = r[render_directive];
				
				return Render.on(ui, function(){
					return rd.apply(this);
				});
			}
			
			Render.on(ui, function(){
				return r.render.apply(this);
			});
		}else{
			Render.on(ui, function(){
				__fn.apply(this);
			});
		}
		
		
		return;
	};
	
	
	/**
	 * @desc Safely clone objects, only with number of string, to prevent memonry leak
	 */
	function safeClone(obj){
		var r={};
		for (var key in obj){
			if (AP.data.isObject(obj[key]) || AP.data.isArray(obj[key]) || AP.data.isFunction(obj[key])){
				
			}else{
				r[key] = obj[key];
			}
		}
		
		return r;
	};
	
};


Render.ui = {};

function uis(key){
	return Render.uis(key);
};


// SPECIAL

(function(){
	jquery_domChanged = function(){
		Render.finish();
	};
})();



function BaseComponent(opts){
	this._params = {};
	
	this.addClass = function(_class){
		if (!this._class){
			this._class="";
		}
		
		this._class+= " "+_class;
	};
	
	
	if (opts){
		this._params = opts;
		
		for (var key in opts){
			if (key == "class"){
				this["_class"] = opts[key];
			}else{
				this[key] = opts[key];	
			}
			
		}
		
		if (this.thick){
			this.addClass("thick");
		}else if (this.bold){
			this.addClass("bold");
		}
		
		
		if (opts.size && opts.size == 'sm'){
			opts.sm = 1;
		}else if (opts.size && opts.size == 'lg'){
			opts.lg = 1;
		}
		
		if (this.in_context && 'url' in this){
			if (Client.pageData.context){
				if (this.url){
					this.url = Client.pageData.context.path+'/'+this.url;	
				}else{
					this.url = Client.pageData.context.path;
				}
			}
		}
	}
	
	
	
	this._css={};
	this._gcss={};
	
	
	this.get = function(key){
		if (key == "class"){
			key = "_class";
		}
		
		if (this[key]){
			return this[key];
		}
		
		return "";
	};
	
	this.show = function(key){
		if (key == "class"){
			key = "_class";
		}
		
		if (key in this){
			if (key == "url"){
				var extra='';
				if (this.blank || this.target=='blank' || this.target=='_blank'){
					extra=" data-blank='1'";
				}
				
				if ('cache_key' in this){
					extra+= " data-cache-key='"+(this.cache_key)+"'"; 
				}else if ('ckey' in this){
					extra+= " data-ckey='"+(this.cache_key)+"'"; 
				}
				
				if (this.context_url && Client.pageData.context){
					var url = ""+(Client.pageData.context.path)+"/"+(this[key])+"";
					if (!this[key]){
						url = Client.pageData.context.path;
					}
					
					return "data-url='"+(url)+"'"+(extra)+"";	
				}
				
				var up = getURLParam(this[key]);
				if (up){
					return "data-urlparam='"+(up.param)+"' data-value='"+(up.value)+"'"+(extra)+"";	
				}
				
				return "data-url='"+(this[key])+"'"+(extra)+"";
			}
			
			return ""+(key)+"='"+(this[key])+"'";
		}
		
		return '';
	};
	
	
	this.setData = function(key, val){
		this["data_"+key] = val;
	};
	
	this.showData = function(key){
		var v = this.get(key);
		
		if (v === "" || AP.data.isObject(v) || AP.data.isArray(v)){
			return "";
		}
		
		return "data-"+(key)+"='"+(v)+"'";
	};
	
	
	this.showAllData = function(){
		var html='';
		
		for (var key in this){
			if (AP.data.isString(key) && AP.word.prefix(key, "data_")){
				var v= this[key];
				if (v === "" || AP.data.isObject(v) || AP.data.isArray(v)){
				}else{
					html+=" data-"+(key.substr(5))+"='"+(v)+"'";
				}
			}
		}
		
		return html;
		
	};
	
	
	this.showAllHTMLEvents = function(){
		var html = '';
		if (this.onclick){
			html +="onclick='"+(this.onclick)+"'";
		}
		
		return html;
	};
	
	
	// Extra support
	
	this.has = function(key){
		if (key in this){
			return true;
		}
		
		return false;
	};
	
	
	this.setParam = function(key, val){
		this[key]=val;
	};
	
	
	this.params = function(){
		return this._params;
	};
	
	
	/**
	 * @desc Check if a color is hex
	 */
	this.isHexColor = function(color){
		return /^#[0-9A-F]{6}$/i.test(color);
	};
	
	
	this.getColor = function(color, df){
		var r = "#aaaaaa";
		if (this.isHexColor(this[color])){
			r = this[color];
		}else{
			r = Color.get(this[color]);
		}
		
		if (!r){
			return df;
		}
		
		return r;
	};
	
	
	this.css = function(){
		if (!arguments.length){
			var styles = this.get("style");
			
			for (var key in this._css){
				styles+="; "+(key)+":"+(this._css[key])+"";
			}
			
			if (AP.word.prefix(styles, ";")){
				styles = styles.substr(2);
			}
			
			return "style='"+(styles)+"'";
		}else{
			
			this._css[arguments[0]] = arguments[1];
			
		}
	};
	
	
	this.gcss = function(){
		if (arguments.length==1){
			var css = this._gcss[arguments[0]];
			if (!css){
				return;
			}
			
			var style = '';
			for (var key in css){
				style+=""+(key)+":"+(css[key])+"; ";
			}
			
			return "style='"+(style)+"'"; 
		}else if (arguments.length==3){
			if (!this._gcss[arguments[0]]){
				this._gcss[arguments[0]] = {};
			}
			
			this._gcss[arguments[0]][arguments[1]] = arguments[2];
			
		}
	};
	
	
	
	/**
	 * @desc Set CSS variable
	 */
	this.gvar = function(group, key, val){
		return this.gcss(group, "--"+key, val);
	};
	
	
	/**
	 * @desc Repositioning a block-display elem
	 */
	this.reposition = function(){
		var left='';
		if (this.left){
			this.css('padding-left', ""+(this.left)+"px");
		}
	
		if (this.top){
			if (this.top<0){
				this.css('margin-top', ""+(this.top)+"px");
			}else{
				this.css('padding-top', ""+(this.top)+"px");
			}
		}
	};
	
	
	this.addSizingClass = function(){
		if (this.md){
			this.addClass("-md");
		}
		
		if (this.el){ // Enlarged, 20px
			this.addClass("-el");
		}
		
		if (this.lg || this.size === "lg"){
			this.addClass("-lg");
		}
		
		if (this.sm || this.size === "sm"){
			this.addClass("-sm");
		}
		
		if (this.xs){
			this.addClass("-xs");
		}
		
		if (this.xl){
			this.addClass("-xl");
		}
		
		if (this.xxl){
			this.addClass("-xxl");
		}
		
		if (this.xxxl){
			this.addClass("-xxxl");
		}
		
		if (!this.md && !this.lg && !this.xl && !this.sm && !this.el){
			this.addClass("-size-df");
		}
	};
	
	
	this.addStatusColor=function(){
		if (this.success){
			this.color="success";
		}
		
		if (this.warning || this.orange){
			this.color="orange";
		}
		
		if (this.danger || this.error){
			this.color="error";
		}
		
		if (this.notice){
			this.color="notice";
		}
		
		if (this.gray){
			this.color= "gray";
		}
		
		if (this.yellow){
			this.color= "yellow";
		}
	};
	
	
	this.addStandardTextLayout = function(){
		this.addStatusColor();
		this.addSizingClass();
		this.addClass("-base-text");
		
		if (this.color){
			this.css("color", this.getColor(this.color));
		}
	};

	this.addStateClass = function(){
		if (this.focus){
			this.addClass("-focus");
		}
		
		if (this.highlight){
			this.addClass("-highlight");
		}
		
		if (this.success){
			this.addClass("-success");
		}
		
		if (this.danger){
			this.addClass("-danger");
		}
		
		if (this.warning){
			this.addClass("-warning");
		}
		
	};
	
	
	this.showHTMLSemantics = function(){
		var html='';
		if (this.html_title){
			html+=" title='"+(this.html_title)+"' ";
		}
		
		return html;
	};
	
	this.showHTMLAttrs = this.showHTMLSemantics;
	
	this.showURL = function(){
		if (this.url){
			this.addClass("url");
			return " data-url='"+(this.url)+"'"; 
		}
		
		return '';
	};
	
	this.showHTMLEvents = function(){
		var events = '';
		if (this.onclick){
			events+=" onclick='"+(this.onclick)+"'";
		}
		
		return events;
	};
	
	
	this.convertTo = function(comp){
		return Render.render(comp.replace(/-/g,'_'), this._params, this.content);
	};
	
	
	this.templateHTML = function(tpl, html){
		this.templated_name = this.name.replace(/_/g,'-');
		return Render.template("layout", this, html);
	};
	
	
	function getURLParam(str){
		if (!str){
			return null;
		}
		
		if (str.match(/^([a-zA-Z0-9]+)\|([a-zA-Z0-9\_\-]*)$/)){
			var parts = str.split("|");
			if (parts.length!=2){
				return null;
			}
			
			return {param: $.trim(parts[0]), value: $.trim(parts[1])};
		}
		
		return null;
	};
	
};


BaseComponent.encode = function(str){
	return Base64.encode(JSON.stringify(str));
};

BaseComponent.decode = function(str){
	return JSON.parse(Base64.decode(str));
};



function useUIKit(){
	return 'helper' in Render;
}





Render.position = new function __RenderPosition(){
	
	this.get = function(opts){
		if (!opts){
			opts = {};
		}
		
		var r = {};
		if ('top' in opts){
			r.top=opts.top;
		}else{
			r.top="auto";
		}
		
		if ('left' in opts){
			r.left=opts.left;
		}else{
			r.left="auto";
		}
		
		if ('right' in opts){
			r.right=opts.right;
		}else{
			r.right="auto";
		}
		
		if ('bottom' in opts){
			r.bottom=opts.bottom;
		}else{
			r.bottom="auto";
		}
		
		return r;
	};
	
	
	/**
	 * @desc Get the position, in text
	 */
	this.getText = function(opts){
		var r = this.get(opts);
		var str = "";
		for (var key in r){
			if (key != 'top' && key != 'left' && key != 'bottom' && key != 'right'){
				continue;
			}
			
			if (AP.data.isNumber(r[key])){
				str+=""+(key)+":"+(r[key])+"px; ";
			}else{
				str+=""+(key)+": "+(r[key])+"; ";
			}
		}
		 
		return str;
	};
	
};



var Company=new function __Company(){
	
	this.getRootNetwork=function(){
		for (var i=0; i<Client.units.length; i++){
			if (Network.root(Client.units[i])){
				return Client.units[i];
			}
		}
		
		return null;
	};
	
	
	
	this.createSystem=function(){
		var form=Form.create('create-team-fx',{action: 'api/company/system/create'})
		.row(
			Form.label({label: "System name",sublabel: "The name of the system"}),
			Form.input({name: 'name', "placeholder":"System name"})
		)
		.row(
			Form.label({label: "Administrator email",sublabel: "We will send a link to setup the new system via this email"}),
			Form.input({name: 'email', "placeholder":"The administrator email"})
		)
		.rowHidden(
			Form.label({label: "Directory",sublabel: "The relative directory from your domain <i>"+Client.system.domain+"</i>"}),
			Form.input({name: 'path', "placeholder":"Team directory", render:"<div class='input-render'>http://"+Client.system.domain+"/</div>"})
		)
		.rowHidden(
			Form.label({label: "Description",sublabel: "Short description about the team"}),
			Form.input({name: 'about', 'type':'textarea', "placeholder":"Short description"})
				.css({height: '80px'})
		)
		.buttons([
		     {label: "Create a new system", action: function(){
		    	 Form.submit("#create-team-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("create-team-fx");
		    		 AP.alertSuccess("An email was sent to the system administrator to initialize the setup process.", function(){
		    			 AP.toURL(code.network.path);
		    		 });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-team-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 600, label: 'Create a new team'}).setForm(form).show();
		
	};
	
	
	
	this.createNetwork = function(){
		var form=Form.create('create-team-fx',{action: 'api/company/team/create'})
		.row(
			Form.label({label: "Name",sublabel: "The name of the team. Just remember that people can work on multiple teams."}),
			Form.input({name: 'name', "placeholder":"Team name"})
		)
		.row(
			Form.label({label: "Directory",sublabel: "The relative directory from your domain <i>"+Client.system.domain+"</i>"}),
			Form.input({name: 'path', "placeholder":"Team directory", render:"<div class='input-render'>http://"+Client.system.domain+"/</div>"})
		)
		.rowHidden(
			Form.label({label: "Description",sublabel: "Short description about the team"}),
			Form.input({name: 'about', 'type':'textarea', "placeholder":"Short description"})
				.css({height: '80px'})
		)
		.row(
			Form.label({label: "Membership", sublabel: "How people can view and join the team?"}),
			Form.input({name: 'type', 'type':'list', options: [
			    {value: 1, "label":"Public membership", "sublabel":"Everyone can see the team and join"},
			    {value: 3, "label":"Restricted membership", "sublabel":"The team is invisible to everyone and people outside can join by invitation only"}
			]}).value(1)
		)
		.row(
			Form.label({label: "Is this team official?", sublabel: "Official team will be visible to everyone in the organization chart (but only its members can view and read contents)"}),
			Form.input({name: 'official', 'type':'list', options: [
			    {value: 0, "label":"Not official", "sublabel":"This is a private team and will not be linked to the organization chart"},
			    {value: 1, "label":"It's an official team", "sublabel":"This is an official team and it will be linked to the organization chart"}
			]}).value(0)
		)
		.rowHidden(
			Form.label({label: "Set parent team", sublabel: "Select a parent unit of this team in the organization chart"}),
			Form.input({name: 'parent', 'type':'select', options: Company.chart.asOptions()})
		)
		.render(function(fobj){
			this.find('official').change(function(){
				var val=parseInt($(this).val());
				if (val==1){
					fobj.findRow('parent').show();
					fobj.findRow('leader').show();
				}else{
					fobj.findRow('leader').hide();
					fobj.findRow('parent').hide();
				}
			});
		})
		.hiddens(
			{
				token:Client.system.token
			}
		)
		.buttons([
		     {label: "Create a new team", action: function(){
		    	 Form.submit("#create-team-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("create-team-fx");
		    		 AP.alertSuccess("A new team was just created", function(){
		    			 AP.toURL(code.network.path, function() {
		    			     AP.refresh();
		    			 });
		    		 });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-team-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 600, label: 'Create a new team'}).setForm(form).show();
		
	};
	
	
	
	this.searchNetwork=function(){
		var options=[];
		for (var i=0; i<Client.networks.length; i++){
			options.push({label: Client.networks[i].name, data: Client.networks[i]});
		}
		
		AP.selectAction(options, function(e){
			AP.toURL(e.data.path);
		},{filter: true, label:"Search for a team"});
	};
	
	
	
	this.editNetwork = function(network){
		var form=Form.create('create-team-fx',{action: 'api/company/team/edit'})
		.row(
			Form.label({label: "Name",sublabel: "The name of the team. Just remember that people can work on multiple teams."}),
			Form.input({name: 'name', "placeholder":"Team name"}).value(network.name)
		)
		.row(
			Form.label({label: "Directory",sublabel: "The relative directory from your domain <i>"+Client.system.domain+"</i>"}),
			Form.input({type: 'fake', name: 'path', "placeholder":"Team directory", render:"<div class='input-render'>http://"+Client.system.domain+"/</div>"}).value("/"+network.path)
		)
//		.row(
//			Form.label({label: "Description",sublabel: "Short description about the team"}),
//			Form.input({name: 'about', 'type':'textarea', "placeholder":"Short description"})
//				.css({height: '80px'})
//		)
		.rowHidden(
			Form.label({label: "Membership", sublabel: "How people can view and join the team?"}),
			Form.input({name: 'type', 'type':'list', options: [
			    {value: 1, "label":"Public membership", "sublabel":"Everyone can see the team and join"},
			    {value: 3, "label":"Restricted membership", "sublabel":"The team is invisible to everyone and people outside can join by invitation only"}
			]}).value(network.type),
			!Network.root(network)
		)
		.rowHidden(
			Form.label({label: "Is this team official?", sublabel: "Official team will be visible to everyone in the organization chart (but only its members can view and read contents)"}),
			Form.input({name: 'official', 'type':'list', options: [
			    {value: 0, "label":"Not official", "sublabel":"This is a private team and will not be linked to the organization chart"},
			    {value: 1, "label":"It's an official team", "sublabel":"This is an official team and it will be linked to the organization chart"}
			]}).value(network.official)
		)
		.rowHidden(
			Form.label({label: "Set team leader", sublabel: "Please set the team leader"}),
			Form.input({name: 'leader', 'type':'text', "role":"user", placeholder: "Please set the team leader"}).value("@"+network.leader.username)
		)
		.rowHidden(
			Form.label({label: "Set parent team", sublabel: "Select a parent unit of this team in the organization chart"}),
			Form.input({name: 'parent', 'type':'select', options: Company.chart.asOptions()}).value(network.parent_id)
		)
		.render(function(fobj){
//			this.find('official').change(function(){
//				var val=parseInt($(this).val());
//				if (val==1){
//					fobj.findRow('parent').show();
//					fobj.findRow('leader').show();
//				}else{
//					fobj.findRow('parent').hide();
//					fobj.findRow('leader').hide();
//				}
//			}).change();
		})
		.hiddens({
			hid:network.hid,
			token: network.token
		})
		.buttons([
		     {label: "Edit team", action: function(){
		    	 Form.submit("#create-team-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("create-team-fx");
		    		 AP.alertSuccess("The user group info was just changed", function(){
		    			 AP.refresh();
		    		 });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-team-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 400, label: 'Edit user group'}).setForm(form).show();
		
	};
	
	
	
	this.closeNetwork=function(network){
		AP.confirm("Are you sure that you want to close this team?", function(){
			AP.hideAlert();
			AP.ajaxShow();
			
			AP.post("api/company/team/close",{hid: network.hid, token: network.token}, function(code){
				AP.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Team just closed!");
				AP.refresh();
			});
		});
	};
	
	
	

	this.openNetwork=function(network){
		AP.confirm("Are you sure that you want to open this team?", function(){
			AP.hideAlert();
			AP.ajaxShow();
			
			AP.post("api/company/team/open",{hid: network.hid, token: network.token}, function(code){
				AP.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Team just reopened!");
				AP.refresh();
			});
		});
	};
	
	
	this.invite=function(){
		Company.member.inviteDialog();
	};
	
	
	this.inviteList=function(content, callback, error){
		AP.post("api/company/invite",{list: 1, emails: content}, function(code){
			if (!code.good()){
				if (error){
					error(code.message);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.emails);
		});
	};
	
	
	this.showPublicTeams=function(){
		AP.ajaxShow();
		AP.post("api/company/team/public", {}, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			var actions=AP.select(code.teams, function(e){
				if (AP.array.findObj(Client.networks, e.id)){
					return {label: e.name, sublabel: "/"+e.path+" &middot; <i class='opt-80'>You joined this team</i>", "icon":"unlocked", path: e.path}
				}else{
					return {label: e.name, sublabel: "/"+e.path, "icon":"unlocked", path: e.path}	
				}
			});
			
			
			AP.selectAction(actions, function(act){
				AP.toURL(act.path);
			},{title: "Public teams @ "+Client.system.name, filter: true})
			
			
		});
	};
	
	
	
	this.showAllTeams=function(){
		AP.ajaxShow();
		AP.post("api/company/team/all", {}, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			var actions=AP.select(code.teams, function(e){
				e.label=e.name;
				e.sublabel="/"+e.path;
				return e;
			});
			
			
			AP.selectAction(actions, function(act){
				
				var menu=[];
				menu.push({label: "Edit this team", "icon":"pencil", action: function(){
					Company.editNetwork(act);
				}});
				
				
				if (act.status==-1 || act.status=="-1"){
					menu.push({label: "Open this team", "icon":"open_in_browser", action: function(){
						Company.openNetwork(act);
					}});
				}else{
					menu.push({label: "Close this team", "icon":"close", action: function(){
						Company.closeNetwork(act);
					}});
				}
				
				
				AP.actionMenu(menu);
				
			},{title: "Manage teams", filter: true})
			
			
		});
	};
	
	
	
	this.settings=function(){
		var admin=Me.isSystemAdmin();
		if (!admin){
			return AP.toURL("home");
		}
		
		var options=[];
		
		options.push({"label":"Má»i thĂªm thĂ nh viĂªn", "icon":"add2", action: function(){
			Company.invite();
		}});
		
		options.push({"label":"TĂ¹y chá»n há»‡ thá»‘ng", "icon":"cog3", action: function(){
			Company.preference();
		}});
		
		options.push({"label":"TĂ¹y chá»n há»‡ thá»‘ng email notification", "icon":"envelope3", action: function(){
			Company.emailPreference();
		}});
		
		options.push({"label":"Äiá»u khoáº£n sá»­ dá»¥ng WorkTime ná»™i bá»™", "icon":"file-text", action: function(){
            Company.tos();
        }});
		
		AP.actionMenu(options);
	
	};
	
	
	
	this.preference=function(){
		UI.setting("System settings")
		.add({
			title: "Hiá»ƒn thá»‹ tĂªn Ä‘áº§y Ä‘á»§ hay username?", 
			options: {"username":"Username","fullname":"Fullname"}, 
			value: Client.system.settings.name,
			name:"name",
			url: "api/company/setting/"+Client.system.hid
		})
		.add({
			title: "Cho phĂ©p thĂ nh viĂªn chá»‰nh sá»­a title (chá»©c vá»¥)?", 
			options: {"yes":"Yes","no":"No"}, 
			value: Client.system.settings.title,
			name:"title",
			url: "api/company/setting/"+Client.system.hid
		})
		.show();
	};

	
	
	this.getTeam=function(id){
		return AP.array.findObj(Client.units, id);
	};
	
};
 

Company.chart=new function __CompanyChart(){
	this.__built=false;
	this.inverses={};
	this.xcounter=0;
	this.root={fake: 1, level: 0, nodes: [], name: "Root"};
	this.extendedRoot={fake: 1, level: 0, nodes: [], name: "ExtRoot"};
	this.roots=[];
	
	this.getRoot=function(){
		if (!this.built()){
			this.buildChart();
		}
		if (!this.roots.length){
			return [];
		}
		
		return this.roots[0];
	};
	
	this.buildChart=function(){
		var networks=Client.units;
		
		networks=removePersonalBus(networks);
		initNodesArray(networks);
		
		this.roots=getRoots(networks);
		for (var i=0; i<this.roots.length; i++){
			setChildren(this.roots[i]);
		}
		
		this.root.nodes=this.roots;
		this.extendNetwork();
		this.__built=true;
	};
	
	
	this.extendNetwork=function(){
		this.extendedRoot={fake: 1, level: 0, nodes: [], name: "Extended Root"};
		this.extendedRoot.nodes=this.root.nodes.slice(0);
		
		
		for (var i=0; i<Client.units.length; i++){
			var test=AP.array.findObj(Client.units, Client.units[i].id);
			if (test){
			}else{
				Client.units[i].level=0;
				Client.units[i].parent_id=0;
				this.extendedRoot.nodes.push(Client.units[i]);
			}
		}
	};
	
	
	
	this.asOptions=function(node){
		if (!this.built()){
			this.buildChart();
		}
		
		if (!node){
			node=this.root;
		}
		
		var arr=[];
		getSelectArray(node, arr);
		
		return arr;
	};
	
	
	this.asExtendedOptions=function(){
		if (!this.built()){
			this.buildChart();
		}
		return this.asOptions(this.extendedRoot);
	}
	
	
	this.built=function(){
		return this.__built;
	};
	
	
	function removePersonalBus(teams){
		return AP.array.filter(teams, function(e){
			if (e.metatype=="user"){
				return null;
			}
			return e;
		})
	};
	
	
	function initNodesArray(teams){
		Company.chart.inverses={};
		Company.chart.xcounter=0;
		
		for (var i=0; i<teams.length; i++){
			if (parseInt(teams[i].parent_id)){
				if (!Company.chart.inverses["n"+teams[i].parent_id]){
					Company.chart.inverses["n"+teams[i].parent_id]=[teams[i]];
				}else{
					Company.chart.inverses["n"+teams[i].parent_id].push(teams[i]);	
				} 
			}
		}
	};
	
	
	function getRoots(teams){
		var r=[];
		for (var i=0; i<teams.length; i++){
			if (!parseInt(teams[i].parent_id)){
				teams[i].level=0;
				r.push(teams[i]);
			}
		}
		
		return r;
	};
	
	function setChildren(root){
		Company.chart.xcounter++;
		if (Company.chart.xcounter>1000){
			return; // Not too much loop please
		}
		
		var nodes=Company.chart.inverses["n"+root.id];
		if (!nodes){
			nodes=[];
		}
		
		root.nodes=nodes;
		
		if (!root.nodes || !root.nodes.length){
			return;
		}
		
		for (var i=0; i<root.nodes.length; i++){
			root.nodes[i].level=root.level+1;
			setChildren(root.nodes[i]);
		}
	};
	
	
	function getSelectArray(node, arr){
		if (!node.fake){
			arr.push({label: "--".repeat(node.level)+" "+node.name, value: node.id});
		}
		
		if (!node.nodes || !node.nodes.length){
			return;
		}
		
		for (var i=0; i<node.nodes.length; i++){
			getSelectArray(node.nodes[i], arr)
		}
		
		return;
	};
	
	
	function getSelectOptions(node){
		var opt="<option value='"+node.id+"'>"+node.name+"</option>";
		if (node.fake){
			opt="";
		}
		
		if (!node.nodes || !node.nodes.length){
			return opt;
		}
		
		return opt+AP.render(node.nodes, function(e){
			return getSelectOptions(e);
		});
	}
};


Company.member=new function __WCompanyMember(){
	
	this.inviteDialog=function(){
		AP.alertError("We are sorry. Invitation by email is currently disabled. Please add account directly!");
		return;
		
		var form=Form.create('invite-fx',{'action':'api/company/invite'})
			.row(
				Form.label({label: "",sublabel: "Enter emails of people to be invited (line by line or separated by a commas). A secret link will be sent to those emails to help people sign up."}),
				Form.input({name: 'emails', type:"textarea", "placeholder":"List of emails to send invitation, seperated by spaces or new-lines"})
					.css({height: '80px'})
			)
			.hiddens({
				"list":1
			})
			.buttons([
			     {label: "Invite to join "+Client.system.name, action: function(){
			    	 Form.submit("#invite-fx", function(code){
			    		 if (!code.good()){
			    			 return AP.alertError(code.message);
			    		 }
			    		 Form.hide("invite-fx");
			    		 AP.alertSuccess("Invitations successfully sent to: <ul>"+AP.render(code.emails, function(e){
			    			 return "<li><b>"+e+"</b></li>";
			    		 })+"</ul>");
			    	 });
			     }, style: 'ok -success -rounded bold'},
			     {label: "Cancel", action: function(){
			    	 Form.hide("invite-fx");
			     }, style:'cancel -passive-2 -rounded'}
			]).settings({block: true});
		
		Form.pop({id:'invite-fx-dx', width: 600, label: 'Invite people to '+Client.system.name}).setForm(form).show();
		
	};
	
	
	this.inviteDialogTeamUp = function(){
        var form=Form.create('invite-fx',{'action':'api/company/invite'})
            .row(
                Form.label({label: "",sublabel: "Má»i tá»‘i thiá»ƒu 03 thĂ nh viĂªn cĂ¹ng báº¡n tham gia vĂ o há»‡ thá»‘ng Ä‘á»ƒ lĂ m viá»‡c trĂªn cĂ¡c dá»± Ă¡n. Má»™t Ä‘Æ°á»ng link bĂ­ máº­t sáº½ Ä‘Æ°á»£c gá»­i tá»›i email thĂ nh viĂªn Ä‘Æ°á»£c má»i há»— trá»£ thĂ nh viĂªn Ä‘Ă³ Ä‘Äƒng kĂ½ tham gia há»‡ thá»‘ng."}),
                Form.input({name: 'emails', type:"textarea", "placeholder":"Danh sĂ¡ch email gá»­i thÆ° má»i tham gia há»‡ thá»‘ng. Má»—i email má»™t dĂ²ng hoáº·c cĂ¡ch nhau bá»Ÿi dáº¥u pháº©y"})
                    .css({height: '80px'})
            )
            .hiddens({
                "list":1
            })
            .buttons([
                 {label: "Má»i tham gia "+Client.system.name, action: function(){
                     Form.submit("#invite-fx", function(code){
                         if (!code.good()){
                             return AP.alertError(code.message);
                         }
                         Form.hide("invite-fx");
                         AP.alertSuccess("ThÆ° má»i Ä‘Ă£ Ä‘Æ°á»£c gá»­i thĂ nh cĂ´ng tá»›i: <ul>"+AP.render(code.emails, function(e){
                             return "<li><b>"+e+"</b></li>";
                         })+"</ul>");
                     });
                 }, style: 'ok -success -rounded bold'},
                 {label: "Bá» qua", action: function(){
                     Form.hide("invite-fx");
                 }, style:'cancel -passive-2 -rounded'}
            ]).settings({block: true});
        
        Form.pop({id:'invite-fx-dx', width: 600, label: 'Má»i thĂ nh viĂªn tham gia '+Client.system.name}).setForm(form).show();
        
    };
    
    this.inviteDialogTeamUpOnBoard = function(){
        var form=Form.create('invite-fx',{'action':'api/company/invite'})
            .row(
                Form.label({label: "",sublabel: "Má»i tá»‘i thiá»ƒu 03 thĂ nh viĂªn cĂ¹ng báº¡n tham gia vĂ o há»‡ thá»‘ng Ä‘á»ƒ lĂ m viá»‡c trĂªn cĂ¡c dá»± Ă¡n. Má»™t Ä‘Æ°á»ng link bĂ­ máº­t sáº½ Ä‘Æ°á»£c gá»­i tá»›i email thĂ nh viĂªn Ä‘Æ°á»£c má»i há»— trá»£ thĂ nh viĂªn Ä‘Ă³ Ä‘Äƒng kĂ½ tham gia há»‡ thá»‘ng."}),
                Form.input({name: 'emails', type:"textarea", "placeholder":"Danh sĂ¡ch email gá»­i thÆ° má»i tham gia há»‡ thá»‘ng. Má»—i email má»™t dĂ²ng hoáº·c cĂ¡ch nhau bá»Ÿi dáº¥u pháº©y"})
                    .css({height: '80px'})
            )
            .hiddens({
                "list":1
            })
            .buttons([
                 {label: "Má»i tham gia "+Client.system.name, action: function(){
                     Form.submit("#invite-fx", function(code){
                         if (!code.good()){
                             return AP.alertError(code.message);
                         }
                         Form.hide("invite-fx");
                         AP.alertSuccess("ThÆ° má»i Ä‘Ă£ Ä‘Æ°á»£c gá»­i thĂ nh cĂ´ng tá»›i: <ul>"+AP.render(code.emails, function(e){
                             return "<li><b>"+e+"</b></li>";
                         })+"</ul>");
                     });
                 }, style: 'ok -success -rounded bold'},
                 {label: "Bá» qua vĂ  xem dá»± Ă¡n máº«u", action: function(){
                     return AP.redirect('demo');
                 }, style:'cancel -passive-2 -rounded'}
            ]).settings({block: true});
        
        Form.pop({id:'invite-fx-dx', width: 800, label: 'Má»i thĂ nh viĂªn tham gia '+Client.system.name}).setForm(form).show();
        
    };
	
	this.inviteInline=function(ref){
		UI.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
   		 	}
			AP.alertSuccess("Invitation sent.");
		});
	};
	
	
	this.earlyInvite = function(ref) {
	    $('#onboard .board .users .user .input').each(function() {
	        $(this).removeClass("-alert");
	    });
	    $('#err_msg').html("").hide();
	    
	    Form.submit("#earlyinvite-form", function(code){
            if (!code.good()){
                if(!code.data) {
                    return AP.alertError(code.message);
                } else {
                    var test = code.data.split('|');
                    var field_alert = "user_" + test[1] + "_" + test[0];
                    
                    $('input[name="' + field_alert + '"]').parent().addClass("-alert");
                    
                    $('#err_msg').html(code.message).show();
                    
                    Layout.scrollTo('#onboard');
                    return;
                }
                
            } else {
                AP.toURL("projects", function() {
                    AP.refresh();
                });
            }
        });
	};
};


var People=new function ___People(){
	this.__ids=null;
	this.uids=null;
	
	this.get=function(username){
		if (AP.data.isInt(username)){
			return this.getID(username);
		}
		
		var temp=username;
		if (AP.data.isString(username) && username[0]=="@"){
			temp=$.trim(temp.substr(1));
		}
		
		var user=__getUserByUsername(temp);
		if (!user){
			return {id:0, error: 1, uid:0, __invalid: 1, username: username, name: username, error:1, title:"No title", "gavatar": Client.data_url+"/image/noavatar.png"}
		}
		
		return user;
	};
	
	
	this.getID=function(id){
		var user=__getUserByID(id);
		if (!user){
			return {id: id, error: 1, uid:0, __invalid: 1, name: (parseInt(id)?"Deactivated":"none"), username:"none", title:"No title", "gavatar": Client.data_url+"/image/noavatar.png"}
		}
		
		return user;
	};
	
	
	this.getUID=function(uid){
		var user=__getUserByUID(uid);
		if (!user){
			return {id: 0, error: 1, uid: uid, __invalid: 1, name: "none", username:"none", title:"No title"}
		}
		
		return user;
	};
	
	
	this.sysowners=function(){
		return AP.array.filter(Client.people, function(e){
			return parseInt(e.role)==13;
		});
	};
	
	
	this.collect=function(){
		var users=[];
		var list=flatten(arguments);
		
		for (var i=0; i<list.length; i++){
			if (!list[i]){
				continue;
			}
			
			var u=null;
			if (AP.data.isObject(list[i])){
				u=People.get(list[i].username);
			}else{
				u=People.get(list[i]);
			}
			
			if (u){
				users.push(u);
			}
		}
		
		users = ARR.filter(users, function(e){
			if (e.error){
				return false;
			}
			
			return true;
		});
		
		for (var i=0; i<users.length; i++){
			users[i].keywords=users[i].username+" "+users[i].name+" "+users[i].title;
		}
		
		
		return AP.array.unique(users, function(e1, e2){
			return e1.username==e2.username;
		});
	};
	
	
	this.getList=this.collect;
	
	
	this.merge=function(a1, a2){
		var obj=[];
		obj=obj.concat(a1);
		obj=obj.concat(a2);
		
		return AP.array.unique(obj, function(e1, e2){
			return e1.username==e2.username;
		});
	};
	
	this.getPeople=function(usernames){
		return this.collect(usernames);
	};
	
	this.getPeopleInTeam = function(team_id){
		var d=[];
		for (var i=0; i<Client.people.length; i++){
			if (AP.array.contain(Client.people[i].networks, team_id)){
				d.push(Client.people[i]);
			}
		}
		
		return d;
	};
	
	this.getPeopleInNetworks=function(networks){
		var r=[];
		for (var i=0; i<Client.people.length; i++){
			if (inNetworks(Client.people[i], networks)){
				r.push(Client.people[i]);
			}
		}
		
		return r;
	};
	
	this.isMemberOf=function(network){
		var obj= AP.array.find(Client.units, function(e){
			if (AP.data.isObject(network)){
				return e.id==network.id;	
			}
			
			return e.id==network;
		});
		
		return obj;
	};
	
	
	this.isDeactivated=function(user){
		if (!parseInt(user.uid)){
			return true;
		}
		
		return false;
	};
	
	
	/**
	 * @desc Export a list of users or usernames to id
	 */
	this.ids=function(users){
		var ids=[];
		for (var i=0; i<users.length; i++){
			var u=users[i];
			if (AP.data.isObject(u)){
				ids.push(u.id);
			}else if (AP.data.isString(u)){
				var temp=People.get(u);
				if (temp && !temp.error){
					ids.push(temp.id);
				}
			}else{
				ids.push(u);
			}
		}
		
		return ids;
	};
	
	
	function flatten(params){
		var u=[];
		for (var i=0; i<params.length; i++){
			if (AP.data.isArray(params[i])){
				u=u.concat(params[i]);
			}else{
				u.push(params[i]);
			}
		}
		return u;
	};
	
	
	
	function __getUserByID(id){
		if (!People.__ids){
			People.__ids=[];
			
			for (var i=0; i<Client.people.length; i++){
				People.__ids["uid-"+Client.people[i].id]=Client.people[i];
			}
		}
		
		if (!People.__ids["uid-"+id]){
			return null;
		}
		
		return People.__ids["uid-"+id];
	};
	
	
	
	function __getUserByUID(id){
		if (!People.uids){
			People.uids=[];
			
			for (var i=0; i<Client.people.length; i++){
				People.uids["uid-"+Client.people[i].uid]=Client.people[i];
			}
		}
		
		if (!People.uids["uid-"+id]){
			return null;
		}
		
		return People.uids["uid-"+id];
	};
	
	
	function inNetworks(person, networks){
		var mine=person.networks;
		for (var i=0; i<mine.length; i++){
			if (networks.indexOf(mine[i])!=-1){				
				return true;
			}
		}
		
		return false;
	};
};



var Guest = new function __Guest(){
	this.addAccount=function(context, app){
		var data = {id: context.id, app: app};
        
        var form = Form.create('fly-proj-addmember-fx',{'action': "api/guest/add"})
        .row(
            Form.label({label: "Há» vĂ  tĂªn *"}),
            Form.input({name: 'name', "placeholder":"Há» vĂ  tĂªn khĂ¡ch hĂ ng"})
        )
        .row(
            Form.label({label: "Äá»‹a chá»‰ email *"}),
            Form.input({name: 'email', "placeholder":"Email cá»§a khĂ¡ch hĂ ng"})
        )
         .row(
            Form.label({label: "Username *"}),
            Form.input({name: 'username', "placeholder":"Username cá»§a khĂ¡ch hĂ ng (dĂ¹ng Ä‘á»ƒ @tag nhanh)"})
        )
        .buttons([
             {label: "ThĂªm tĂ i khoáº£n khĂ¡ch hĂ ng", action: function(){
                 Form.submit("#fly-proj-addmember-fx", function(code){
                     if (!code.good()){
                         return AP.alertError(code.message);
                     }
                     
                     Form.hide("fly-proj-addmember-fx");
                     
                     UI.flash("ÄĂ£ thĂªm tĂ i khoáº£n ...");
                     
                     AP.xRefresh();
                 })
             }, style: 'ok -success -rounded bold'},
             {label: "Há»§y", action: function(){
                 Form.hide("fly-proj-addmember-fx");
             }, style:'cancel -passive-2 -rounded'}
        ]).hiddens(data);
        
        Form.pop({width: 420, label: 'ThĂªm tĂ i khoáº£n khĂ¡ch hĂ ng', layout: 'flat'}).setForm(form).show().focus('followers');
	}
}



var UserGroup=new function __UserGroup(){
	this.__built=false;
	this.__ids={};
	this.__uds={};
	
	
	this.build=function(){
		this.__built=true;
		for (var i=0; i<Client.units.length; i++){
			this.__ids["i_"+Client.units[i].id]=Client.units[i];
			this.__uds["u_"+Client.units[i].path]=Client.units[i];
		}
	};
	
	this.get=function(id){
		if (!this.__built){
			this.build();
		}
		
		
		if (AP.data.isObject(id) && id.id){
			return this.get(id.id);
		}
		
		if (AP.data.isInt(id)){
			if (this.__ids["i_"+id]){
				return this.__ids["i_"+id];
			}
			
			return null;
			
			// return AP.array.findObj(Client.units, id);	
		}
		
		if (this.__uds["u_"+id]){
			return this.__uds["u_"+id];
		}
		
		return null;
		
//		return AP.array.single(Client.units, function(e){
//			return e.path==id;
//		});
	};
	
	
	this.fromContext = this.get;
	
};



// BACKWARD COMPATIBLE
var UserTeam=UserGroup;
 

var Clog=new function __WLog(){
	this.log=function(key, value){
		$.cookie(key, value,{expires: 7*24*3600, path:'/', domain: Client.domain});
	};
	
	
	this.getLog=function(key){
		return $.cookie(key);
	};
	
	
	this.removeLog=function(key){
		return $.cookie(key, null);
	};
	
	this.setCookie=this.log;
	this.getCookie=this.getLog;
	this.removeCookie=this.removeLog;
	
	this.setAppCookie=function(key, value){
		if (Client.viewer && Client.viewer.id){
			$.cookie(key, value,{expires: 7*24*3600, path:'/', domain: Client.base.app+"."+Client.domain});	
		}
	};
	
	
	this.getAppCookie=this.getLog;
	this.clearAppCookie=this.removeLog;
	
	
	/**
	 * @desc Set a val to local storage (array)
	 * @example set("prefs", 1); // prefs -> [1]
	 * set("prefs", 2); // prefs -> [1, 2]
	 * set("prefs", 3); // prefs -> [1, 2, 3]
	 */
	this.set=function(key, val){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		var found=false;
		for (i=0; i<item.length; i++){
			if (AP.data.equal(item[i],val)){
				item.splice(i,1);
				item.unshift(val);
				found=true;
				break;
			}
		}
		
		if (!found){
			item.unshift(val);	
		}
		
		localStorage.setItem(key,JSON.stringify(item));
		
	};
	
	
	this.setAdv=function(key, obj){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		var found=false;
		for (i=0; i<item.length; i++){
			if (AP.data.equal(item[i].id,obj.id)){
				item.splice(i,1);
				item.unshift(obj);
				found=true;
				break;
			}
		}
		
		if (!found){
			item.unshift(obj);	
		}
		
		localStorage.setItem(key,JSON.stringify(item));
	};
	
	
	this.get=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		return item;
	};
	
	
	this.setObject=function(key, obj){
		localStorage.setItem(key, JSON.stringify(obj));
	};
	
	
	this.getObject=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item={};
		}else{
			item=JSON.parse(item);
		}
		
		return item;
	};
	
	
	this.setValue=function(key, value){
		localStorage.setItem(key, value);
	};
	
	
	this.getValue=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item="";
		}
		
		return item;
	};
	
	
	
	this.setArray=function(key, obj){
		localStorage.setItem(key, JSON.stringify(obj));
	};
	
	
	this.getArray=function(key){
		var item=localStorage.getItem(key);
		if (!item){
			item=[];
		}else{
			item=JSON.parse(item);
		}
		
		if (!AP.data.isArray(item)){
			return [];
		}
		return item;
	};
	
	
	this.clear = function(key){
		localStorage.removeItem(key);
	};
	
};


AP.log = Clog;
 

var WTAjaxDialogEngine=new function __WTAjaxDialogEngine(){
	
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__wtajaxdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitle'>"+"&nbsp;</div>"+
							"<div class='__dialogcontent'><span style='font-size:32px' class='ficon-spinner ficon-spin'></span> <p>Processing</p></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-45;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
		}
		
		if (l<0){
			l=0;
		}
		
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
	};
};





var WTDialogEngine=new function __DialogEngine(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__wtdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitle unselectable' onclick=\"AP.dialog('"+dialog.id()+"').balance();\">"+"&nbsp;</div>"+
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><span class='-ap icon-close'></span> </div>"+
							"<div class='__dialogcontent'></div>" +
							"<div class='__dialogbuttons unselectable'></div>"+
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
		}
		
		if (Client.mobile){
			l=0;
		}
		
		
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
		$(wid+' .__dialogwrapper .__buttons .button:last').focus();
	};
};









var FormDialogEngine=new function __FormDialogEngine(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("<div class='__fdialog' id='"+(dialog.w(true))+"'> <div class='__fdialogwrapper scroll-y forced-scroll'> <div class='__dialogwrapper'> <div class='__dialogwrapper-inner'> <div class='__dialogmain'> <div class='__dialogtitlewrap'> <div class='left relative'> <div class='__dialogtitle unselectable ap-xdot' onclick='AP.dialog(\""+(dialog.id())+"\").balance();'> &nbsp; </div> <div class='__dialogtitlerender tx-fill'></div> </div> <div class='clear'></div> </div> <div class='__dialogclose' onclick='AP.dialog(\""+(dialog.id())+"\").close();'> <span class='-ap icon-close'></span> </div> <div class='__dialogcontent'></div> </div> </div> </div> </div> </div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
			
			if (Client.mobile){
				t=0;
			}
		}
		
		if (l<0 || mobile()){
			l=0;
		}
		
		$(wid).css("right", $.sbWidth());
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
		$(wid+' .__dialogwrapper .__buttons .button:last').focus();
	};
};






var FormDialogEngine2=new function __FormDialogEngine(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__fdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitlewrap nd'><div class='__dialogtitle unselectable' onclick=\"AP.dialog('"+dialog.id()+"').balance();\"></div></div>"+
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><span class='-ap icon-close'></span> </div>"+
							"<div class='__dialogcontent'></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-30;
		var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
		if (t<50){
			t=50;
		}
		
		$(wid+' .__dialogwrapper').css('top', t).css('left', l);
		$(wid+' .__dialogwrapper .__buttons .button:last').focus();
	};
	
	
	
};







var FormDialogMobile=new function __FormDialogMobile(){
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		$(dialog.canvas()).append("" +
			"<div class='__mobiledialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogclose' onclick=\"AP.dialog('"+dialog.id()+"').hide();\"><span class='-ap icon-close'></span> </div>"+
							"<div class='__dialogtitle unselectable ap-xdot'>"+"</div>" +
							"<div class='__dialogcontent'></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		return this;
	};
	
	
	this.width=function(w){
		return;
	};
};
 

var UploadDialogEngine=new function __UploadDialogEngine(){
	inherits(this, WTDialogEngine);
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){		
		$(dialog.canvas()).append("" +
			"<div class='__uploaddialog unselectable' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogtitle'>"+"&nbsp;</div>"+
							"<div class='__dialogclose' onclick=\"$('#"+dialog.data('form')+"').multiUpload('close');\"><div class='entypo ticon-cancel'></div> </div>"+
							"<div class='__dialogcontent'></div>" +
							"<div class='__dialogbuttons unselectable'></div>"+
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
};
 


var Lang=new function _Lang(){	
	this.data={};
	this.set=function(data){
		this.data=data;
	}
	
	this.message=function(msg){
		if (this.data[msg]){
			return this.data[msg];
		}
		return "?"+msg+"";
	};
};



function lang(key, flag){
	return key;
	
	if (!flag){
		flag=null;
	}
	var msg=Lang.message(key);
	if (flag=='ucf'){
		return AP.W.ucf(msg);
	}
	if (flag=='ucw'){
		return AP.W.ucw(msg);
	}
	if (flag=='upper'){
		return AP.W.upper(msg);
	}
	return msg;
};

function L(key){
	var lang=parseInt(Client.lang);
	if (lang==2){
		return Lang.message(key);
	}else{
		return key;
	}
};

 

var Context=new function __Context(){
	this.closeCallback=null;
	
	this._inited=false;
	this.init=function(){
		if (this._inited){
			return;
		}
		
		this._inited=true;
		$("#context-menu-close").on("contextmenu", function(e){
			e.preventDefault();
			Context.close();
		});
		
		$("#context-menu").css("right", -$.sbWidth());
		$("#context-menu-main").wrap("<div class='context-canvas-slider'></div>");
		
		$(document.body).delegate("input","blur", function(){
			setTimeout(function(){
				$("#context-tag > .tags").hide();
			},200);
		}).on("click", function(){
			setTimeout(function(){
				$("#context-tag > .tags").hide();
			},200);
		});
	}
	
	this.close=function(){
		$("#context-menu").hide();
		if (Context.closeCallback){
			Context.closeCallback();
		}
	};
	
	this.menu=function(ref, options){
		this.init();
		return new ContextMenu(ref, options);
	};
	
	
	/**
	 * @desc Binding a context-menu on-click action
	 */
	this.bind=function(ref, menu, options){
		
	};
	
	this.direct=function(x, y, options){
		this.init();
		return new ContextMenu({'x': x, 'y': y, type: 'click'}, {menu: options});
	}
	
	this.hide=function(){
		return this.close();
	};
	
	this.gen=new function __ContextGen(){
		this.close=function(){
			$("#context-general").hide();
		};
		
		this.hide=function(){
			return this.close();
		};
		
		this.show=function(elem){
			var $after=$("#context-general .context-main").next();
			if ($after && $after.length){
				$after.remove();
			}
			$(elem).insertAfter("#context-general .context-main").addClass('context-real');
			$("#context-general").show();
			$("#context-items").hide();
		};
		
		
		this.showID=function(id){
			var $obj=$("#context-items").find(id);
			if (!$obj.length){
				$(id).appendTo("#context-items").addClass('top').show();	
			}else{
				$("#context-items").children().removeClass('top').hide();
				$(id).addClass('top').show();
			}
			
			$("#context-general .context-real").hide();
			$("#context-items").show();
			$("#context-general").show();
		};
	};
	
	
	

	this.v2=function(opts){
		opts=$.extend({
			menu: [],
			width: 300
		}, opts);
		
		if (AP.data.isObject(opts) && !AP.data.isArray(opts)){
			opts.menu = opts.menu.context();
		}
		
		Context.direct(opts.left, opts.top, opts.menu);
		
		$("#context-menu-main").width(opts.width);
	};
	
	
};


function ContextMenu(ref, options){
	this.opts=$.extend({}, {top:30, left:20, menu:[]}, options);
	
	if (this.opts.close){
		Context.closeCallback=this.opts.close;
	}else{
		Context.closeCallback=null;
	}
	
	
	var top=0;
	var left=0;
	if (ref && ref.x && ref.y && ref.type && ref.type=="click"){
		top=ref.y;
		left=ref.x;
	}else if (options.x && options.y && options.type && options.type=="click"){
		top=options.y;
		left=options.x;
	}else{
		var offset=$(ref).offset();
		top=offset.top+this.opts.top;
		left=offset.left+this.opts.left;	
	}
	
	if (mobile() && $(".mobile-master").length){
		top = $(document.body).scrollTop()+top;
	}
	
	$.log([top, left]);
	
	if (options.event){
		$(ref).on(options.event, function(){
			$("#context-menu").show();	
		});
	}else{
		$("#context-menu").show();
	}
	
	
	$("#context-menu-main").removeClass().css({'top': top, 'left': left});
	if (this.opts.layout){
		$("#context-menu-main").addClass(this.opts.layout);
	}
	
	if (options.width){
		$("#context-menu-main").width(options.width);
	}else{
		$("#context-menu-main").css("width", "300");
	}
	
	$("#context-menu-main .menu").cleanUp().html("<div class='items'></div>");
	
	var $menu=$("#context-menu-main .menu .items");
	
	for (var i=0; i<options.menu.length; i++){
		addMenuItem(options.menu[i], $menu, ref);
	};
	
	$menu.click(function(){
		Context.close();
	});
	
	var ch=$("#context-menu-main").height();
	var maxh=$(window).height();
	
	
	var cw=$("#context-menu-main").width();
	var maxw=$(window).width();
	var minh=$("#context-menu").height();
	
	
	if (top+ch+50>maxh){
		// top=top-ch-this.opts.top;
		// $("#context-menu-main").css("top", top);
		
		$("#contex-menu .context-menu-slider").css({height: top+ch+50})
	}
	

	
	if (left+cw>maxw){
		left=left-cw-this.opts.left+13;
		$("#context-menu-main").css("left", left);
	}
	
	
	function addMenuItem(opt, $menu, ref){
		if (!opt){
			return;
		}
		
		if (AP.data.isString(opt)){
			if (opt=='---0'){
				return;
			}
			
			var $last=$menu.children().last();
			if ($last && $last.hasClass("item-sep")){
				return;
			}
			
			if (opt=="|" || opt=="sep" || opt=="---" || /^(\-+)/.test(opt) || /^(\-+)([0-9]+)/.test(opt)){
				return $("<div class='item-sep'></div>").appendTo($menu);
			}
			
			$menu.append(opt);
			return;
		}
		
		if ('enabled' in opt){
			if (!opt.enabled){
				return;
			}
		}
		
		if (opt.type){
			if (opt.type=='sep'){
				return $("<div class='item-sep'></div>").appendTo($menu);	
			}
			
			if (opt.type=='html'){
				return $("<div class='item-html'>"+opt.html+"</div>").appendTo($menu);	
			}
		}
		
		if (!opt.css){
			opt.css='';
		}
		
		var icon='';
		if (opt.icon){
			if (opt.icon.substr(0,5)=="icon-"){
				icon="<span class='icon'><span class='-ap "+opt.icon+"'></span></span>";	
			}else if (AP.word.prefix(opt.icon, "ficon-")){
				icon="<span class='icon'><span class='"+opt.icon+" ap-f14'></span></span>";
			}else{
				icon="<span class='icon'><span class='-ap icon-"+opt.icon+"'></span></span>";
			}
		}else{
			opt.css+=" -no-icon";
		}
		
		if (opt.url){
			var eid=AP.uuid();
			var target='';
			if (opt.target && (opt.target=='_blank' || opt.target=='blank')){
				target="data-blank='1'";
			}
			
			if (opt.blank){
				target="data-blank='1'";
			}
			
			$menu.append("<div title='"+(opt.label)+"' class='ap-xdot item url "+(opt.css)+"' id='"+(eid)+"' data-url='"+(opt.url)+"' "+(target)+">"+(icon)+" "+(opt.label)+"</div>");
			
			if (opt.data && opt.data!=undefined){
				for (var key in opt.data){
					$("#"+eid).data(key, opt.data[key]);
				}
			}
			
			return;
		}
		
		var html= "<div class='item "+opt.css+"'>"+icon+opt.label+"</div>";
		return $(html).appendTo($menu).data('opt', opt).click(function(){
			Context.hide();

			var opt=$(this).data('opt');
			var action=opt.action;
			
			if (AP.data.isString(action)){
				return AP.toURL(action);
			}else{
				action.apply(ref, [opt, this]);
			}
		});
	};
};


(function($) {
    $.fn.setContextMenu = function(actions){
    	$(this).on("contextmenu", function(e){
    		var pos=$(this).offset();
    		var obj={x: e.clientX, y: e.clientY, type: 'click'};
    		e.preventDefault();
    		
    		Context.menu(obj, {
    			top: e.pageX-pos.top,
    			left: e.pageY-pos.left,
        		menu: actions
        	});	
    	});
    	
    };
 
}(jQuery));
 

var BC=new function __BC(){
	this.title=function(title){
		$("#bcanvas .__title").html(title);
	};
	
	this.side=function(side){
		$("#bcanvas .__side").html(side);
	};
	
	
	this.main=function(content){
		$("#bcanvas .__canvas").html(content);
	};
	
	this.show=function(){
		if (mobile()){
			$(document.body).addClass("xo");
			$("#document").hide();
		}
		
		$("#bcanvas").show().removeClass("__simple").addClass("__ontop");
		this.normal();
		
		if (!$("#bcanvas").hasClass('__init')){
			$("#bcanvas").addClass('__init');
			Layout.scrollable("#bside");
		}else{
			$("#bside").find(".scrollin").height("100%").css("width", $("#bside").width()+$.sbWidth());
		}
		
	};
	
	
	this.noSide=function(){
		$("#bcanvas").show().addClass("__simple");
	};
	
	this.hide=function(){
		$("#bcanvas").find(".__canvas").html("");
		$("#bcanvas").find(".__side").html("");
		$("#bcanvas").find(".__postbottom").html("");
		$("#bcanvas").fadeOut(200);
		
		if (mobile()){
			$(document.body).removeClass("xo");
			$("#document").show();
		}
	};
	
	
	
	this.extend=function(){
		$("#bcanvas").addClass("extended");
	};
	
	this.unextend=function(){
		$("#bcanvas").removeClass("extended");
	};
	
	this.normal=function(){
		$("#bcanvas").removeClass("extended");
	};
};




BC.ui=new function __BCUIx(){
	this.followers=function(obj){
		if (obj.followers.length<=6){
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}else{
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}
	};
	
	
	
	
	function followerHTML(user){
		return "<div class='li url' data-username='"+user.username+"'><div class='avatar avatar-40 rounded xo'>" +
				"<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
			"</div></div>";
	}
};


var LiveChat=new function __LiveChat(){
	this.lc=null;
	
	this.init=function(room, canvas){
		if (!room || !room.room){
			console.error("Component error: On the component obj, please have obj.room = livechat Room::getRoom($this) on the server");
			return AP.alertError("LIVE_CHAT_SETUP_ERROR");
		}
		
		this.lc=new LiveChatInstance(room, canvas);
		this.lc.build();
	};
	
	
	
	/**
	 * @desc Listen to message
	 */
	this.listen=function(){
		if (!Live){
			return;
		}
		
		Live.on("livechat.msg", function(data){
			if (!LiveChat.lc || !LiveChat.lc.room || LiveChat.lc.room.hid!=data.room.hid){
				return LiveChat.notis(data);
			}
			
			var room=data.room;
			var msg=data.message;
			
			var $box=$("#js-livechat-"+room.hid);
			if ($box.length){
				LiveChat.lc.prepend(msg);
			}else{
				console.error("CANNOT_FIND_ROOM", room.hid);
			}
		});
		
		AP.sys.on("page.pre.transition", function(){
			if (LiveChat.lc){
				LiveChat.lc=null;
				Live.emit("custom.room", {leave: 1});	
			}
		});
	};
	
	/**
	 * @desc Notification on data
	 */
	this.notis=function(data){
		if (!data.onlines || !data.message || !data.room){
			return;
		}
		
		
		var u=People.get(data.message.user_id);
		
		if (AP.array.contain(data.onlines, Client.viewer, function(e, f){
			return parseInt(e)==parseInt(f);
		})){
			return;
		}
		
		DN.show({
			title: data.room.name,
			icon: AP.thumb(u.gavatar),
			body: u.name+": "+data.message.content,
			tag: data.room.hid+"-"+data.message.id,
		});
	};
};


setTimeout(function(){
	LiveChat.listen();
}, 1000);


function LiveChatInstance(room, canvas){
	this.canvas=canvas;
	this.room=room;
	
	/**
	 * @desc Build livechat
	 */
	this.build=function(){
		var room=this.room;
		Live.emit("custom.room", room);
		
		$(this.canvas).data("livechat", this).data("room", this.room);
		initCanvas(this.canvas, room);
		
		UI.ajaxHide();
		var that=this;
		
		var $c=$(this.canvas);
		$c.data("livechat", that);
		
		AP.post("api/livechat/load", {hid: this.room.hid, token: this.room.token}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			for (var i=0; i< code.messages.length; i++){
				that.insert(code.messages[i]);
			}
		});
		
		
		$(this.canvas).find(".js-chat-input").enter(function(){
			var v=$.trim($(this).val());
			if (v && v.length){
				sendMessage(v, this);
			}
		});
		
		AP.uploadable($(this.canvas).find(".action.-file"), {
			action: "api/livechat/send",
			data: {hid: this.room.hid, token: this.room.token}
		}, function(code){
			if (!code.good()){
				$.log("ERROR_MSG");
			}
			
			that.prepend(code.msg);
		});
	};
	
	
	this.insert=function(msg){
		var html=getHTML(msg);
		
		var $c=$(this.canvas);
		var $last=$c.find(".messages .js-message").last();
		var compact=false;
		
		if (!$last || !$last.length){
			compact=false;
		}else{
			var uid=parseInt($last.data("uid"));
			var time=parseInt($last.data("time"));
			
			if (uid==parseInt(msg.user_id) && parseInt(msg.since)-time<300){
				compact=true;
			}
		}
		
		if (compact){
			$(html).appendTo($c.find(".messages")).addClass("-compact");
		}else{
			$(html).appendTo($c.find(".messages"));
		}
	};
	
	
	
	this.prepend=function(msg){
		var html=getHTML(msg);
		
		var $c=$(this.canvas);
		var $last=$c.find(".messages .js-message").first();
		var compact=false;
		
		if (!$last || !$last.length){
			compact=false;
		}else{
			var uid=parseInt($last.data("uid"));
			var time=parseInt($last.data("time"));
			
			if (uid==parseInt(msg.user_id) && parseInt(msg.since)-time<300){
				compact=true;
			}
		}
		
		$(html).prependTo($c.find(".messages"));
		
		if (compact){
			$last.addClass("-compact");
		}
	};
	
	
	
	
	/**
	 * @desc Init a livechat canvas
	 */
	function initCanvas(canvas, room){
		$(canvas).html("<div class='mt-canvas' id='js-livechat-"+(room.hid)+"'> <div class='mt-messages scrollable' data-autoscroll='1' data-autohide='1'> <div class='messages'></div> </div> <div class='mt-form'> <div class='actions'> <div class='action -file'><span class='-ap icon-uniF10A'></span> </div> <div class='action -submit'><span class='txt'>Send</span></div> </div> <div class='textarea'> <textarea name='msg' placeholder='Send message' class='js-chat-input'></textarea> </div> </div> </div>");
		
		$(canvas).addClass("js-livechat-wrapper");
		Layout.scrollable(canvas+" .scrollable");
		
		Tag.user($(canvas).find(".js-chat-input"), Client.people);
	};
	
	
	/**
	 * @desc sendMessage
	 */
	function sendMessage(msg, ref){
		var $canvas=$(ref).closest(".js-livechat-wrapper");
		var room=$canvas.data("room");
		
		UI.ajaxShow();
		AP.post("api/livechat/send", {content:msg, hid: room.hid, token: room.token}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// Clean up
			cleanupForm(ref);
			// $canvas.data("livechat").prepend(code.msg);
			
			broadcast(code.msg, room, code.origin.followers);
		});
	};
	
	
	function broadcast(message, room, users){
		Live.emit("livechat.msg", {message:message, room: room, users: People.ids(users), metatype:"users"});
	};
	
	
	function getHTML(msg){
		var u=People.get(msg.user_id);
		
		var is_me='';
		if (parseInt(msg.user_id)==parseInt(Client.viewer.id)){
			is_me=' -me';
		}
		
		var content=msg.content;
		if (msg.metatype=="upload" && msg.attachment){
			content=getFile(msg);
		}else{
			content=UI.parse(content);
		}
		
		var html="<div class='message js-message"+(is_me)+"' data-id='"+(msg.id)+"' data-time='"+(msg.since)+"' data-uid='"+(msg.user_id)+"'> <div class='avatar '><div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div></div> <div class='text'> <div class='user'> <b class='url' data-username='"+(u.username)+"'>"+(u.name)+"</b> &middot; <span class='time'>"+(AP.time.ago(msg.since))+"</span> </div> <div class='content'>"+(content)+"</div> </div> </div>";
		
		return html;
	};
	
	
	function getFile(msg){
		var att=msg.attachment;
		var f=UI.file.icon(att.name);
		
		return "<div class='msg-file'> <div class='ficon'><img src='"+(Client.share_url)+"/m2/"+(f)+".svg'/></div> <div class='fname'> <span class='url' data-url=':file' data-file='"+(att.src)+"'>"+(att.name)+"</span> </div> <div class='finfo'>"+(UI.file.kb(att.size))+" &middot; "+(AP.time.ago(att.since))+"</div> </div>";
	};
	
	
	/**
	 * @desc Cleanup a form
	 */
	function cleanupForm(ref){
		var $f=$(ref).closest(".mt-form");
		$f.find("textarea").val("");
	};
};




var Block = new function __Block(){
	
	/**
	 * @desc Render an encoded block
	 */
	this.render = function(encoded_block){
		var block=Block.decode.obj(encoded_block);
		if (!block){
			return "";
		}
		
		return Block.html(block);
	};
	
	
	
	/**
	 * @desc Render a HTML
	 */
	this.html=function(block){
		var icon='';
		if (!block.icon_type && block.color){
			block.icon_type = 'color';
			block.icon = block.color;
		}
		
		if (block.icon_type=='color'){
			if (block.icon){
				icon="<div class='block-icon-bar' style='background-color:"+(block.icon)+"'></div>";
			}else{
				icon="<div class='block-icon-bar'></div>";
			}
		}
		
		var title='';
		if (block.title){
			title="<div class='block-title'>"+(block.title)+"</div>";
			if (block.title_url){
				title="<div class='block-title'><span class='url' data-url='"+(block.title_url)+"'>"+(block.title)+"</span></div>";	
			}
		}
		
		var content='';
		if (block.content){
			content="<div class='block-content'>"+(Block.decode.text(block.content))+"</div>";
		}
		
		return "<div class='block-wrapper'> <div class='block -"+(block.icon_type)+"'> <div class='block-icon'>"+(icon)+"</div> "+(title)+" "+(content)+" <div class='block-fields'>"+(AP.render(block.fields, getField))+"</div> </div> </div>";
	};
	
	
	this.list = function(blocks){
		return AP.render(blocks, this.html);
	};
	
	
	/**
	 * @desc Get block field
	 */
	function getField(f){
		return "<div class='block-row'> <div class='block-row-label'>"+(f.label)+"</div> <div class='block-row-value'>"+(Block.decode.text(f.value))+"</div> </div>";
	};
	
};



Block.decode = new function __BlockDecode(){
	/**
	 * @desc Decode an object
	 */
	this.obj=function(obj){
		var temp = Base64.decode(obj.block);
		if (!temp || !AP.word.prefix(temp, "{")){
			return null;
		}
		
		var temp_obj = JSON.parse(temp);
		if (!temp_obj || !temp_obj.type){
			return null;
		}
		
		return temp_obj;
	};
	
	
	this.text=function(val){
		str=val.replace(/\*\*([^\*\>\<]+)\*\*/g, function(str, ms){
			return "<b>"+(ms)+"</b>";
		});
		
		str = str.replace(/\*([^\*\>\<]+)\*/g, function(str, ms){
			return "<i>"+(ms)+"</i>";
		});
		
		str = str.replace(/__([^\*\>\<]+)__/g, function(str, ms){
			return "<u>"+(ms)+"</u>";
		});
		
		str = str.replace(/\-\-([^\*\>\<]+)\-\-/g, function(str, ms){
			return "<strike>"+(ms)+"</strike>";
		});
		
		str = str.replace(/\[([^\]]+)\]/g, function(str, ms){
			return getSubStruct(ms);
		});
		
		return str;
	};
	
	
	function getSubStruct(ms){
		var parts = safeSplit(ms);
		if (parts.length<2){
			return ms;
		}
		
		return "<span class='url' data-url='"+(parts[0])+"'>"+(parts[1])+"</span>";
	};
	
	
	function safeSplit(str){
		var parts = str.split("|");
		if (parts.length<=2){
			return parts;
		}
		
		return [parts[0], parts[1]];
	};
	
};


Block.builder = new function __BlockBuilder(){
	
	/**
	 * @des Special block
	 */
	this.special = function(block){
		return block;
	};
	
	
	/**
	 * @desc Create a block
	 */
	this.normal = function(block){
		var b=$.extend({verbatim: 1, image: "", color: ""}, block);
		return b;
	};
	
	
	/**
	 * @desc Encode a list of block
	 */
	this.encode=function(){
		return JSON.stringify(arguments);
	};
	
	
	this.list=function(blocks){
		return "<div class='blocks'>"+(AP.render(blocks, this.html))+"</div>";
	};
	
	
};

 

Block.decode = new function __BlockDecode(){
	/**
	 * @desc Decode an object
	 */
	this.obj=function(obj){
		var temp = Base64.decode(obj.block);
		if (!temp || !AP.word.prefix(temp, "{")){
			return null;
		}
		
		var temp_obj = JSON.parse(temp);
		if (!temp_obj || !temp_obj.type){
			return null;
		}
		
		return temp_obj;
	};
	
	
	this.text=function(val){
		str=val.replace(/\*\*([^\*\>\<]+)\*\*/g, function(str, ms){
			return "<b>"+(ms)+"</b>";
		});
		
		str = str.replace(/\*([^\*\>\<]+)\*/g, function(str, ms){
			return "<i>"+(ms)+"</i>";
		});
		
		str = str.replace(/__([^\*\>\<]+)__/g, function(str, ms){
			return "<u>"+(ms)+"</u>";
		});
		
		str = str.replace(/\-\-([^\*\>\<]+)\-\-/g, function(str, ms){
			return "<strike>"+(ms)+"</strike>";
		});
		
		str = str.replace(/\[([^\]]+)\]/g, function(str, ms){
			return getSubStruct(ms);
		});
		
		return str;
	};
	
	
	function getSubStruct(ms){
		var parts = safeSplit(ms);
		if (parts.length<2){
			return ms;
		}
		
		return "<span class='url' data-url='"+(parts[0])+"'>"+(parts[1])+"</span>";
	};
	
	
	function safeSplit(str){
		var parts = str.split("|");
		if (parts.length<=2){
			return parts;
		}
		
		return [parts[0], parts[1]];
	};
	
};
var App = new function __App(){
	
	this.admin = function(){
		return Me.isAppAdmin();
	};
	
	this.sysowner = this.sysOwner = function(){
		return Me.isSysowner();
	};
	
	this.admins = function(){
		return this.sub.admins();
	};
	
};



App.role = new function __AppRole(){
	
	this.prefs = function(opts){
		var html=AP.render(opts.roles, function(e){
			return getPref(e, opts.values);
		});
		
		$(opts.canvas).html("<div class='app-prefs'>"+(html)+"</div>");
		
		$(opts.canvas).find(".pref").each(function(){
			var api=$(this).data("api");
			var key=$(this).data("key");
			
			setPrefValue(this, key);
			$(this).find(".pref-value").click(function(){
				
			});
		});
	};
	
	
	/**
	 * @desc Config for users
	 */
	this.users = function(opts){
		var html=AP.render(opts.users, function(e){
			if (AP.data.isObject(e)){
				return getUserRoles(e, opts);	
			}else{
				var u=People.get(e);
				if (!u.error){
					return getUserRoles(u, opts);	
				}
			}
		});
		
		$("#js-user-roles").html("<div class='user-roles-wrapper'><div class='user-roles'>"+(html)+"</div></div>");
		Form.render("#js-user-roles");
		bindEvents();
	};
	
	
	/**
	 * @desc We use table to make sure that editting is easy
	 */
	this.table = function(opts){
		var models = [];
		
		models.push({
			id: 'role-user',
			name: 'Granted user',
			render: function(row){
				return "  " +Render.render('super_cell', {avatar:row.gavatar, url: "::base/user?username="+(row.username)+"" , thick:1}, ""+(row.name)+"")+ '';
			},
			locked: 1,
			width: 200
		});
		
		for (var i=0; i<opts.users.length; i++){
			var r = ARR.find(opts.roles, function(r){
				return parseInt(r.user_id) == parseInt(opts.users[i].id);
			});

			if (r){
				opts.users[i]._roles = r.roles;
			}
		}
		
		
		for (var i=0; i < opts.models.length; i++){
			var r = opts.models[i];
			
			models.push({
				id: 'role-'+r.key,
				name: r.key,
				role: r,
				explain: "<p class='thick'><em>"+(r.name)+"</em></p><p>"+(r.desc)+"</p>",
				options: ARR.select(r.options, function(e){
					return {id: e.value, name: e.label};
				}),
				render: function(user){
					var cf = null;
					
					if (user._roles && user._roles[this.role.key]){
						var ur = user._roles[this.role.key];
						
						cf = ARR.single(this.options, function(e){
							return parseInt(e.id) == parseInt(ur);
						});
					}
					
					if (!cf){
						return "  " +Render.render('super_cell', {icon_color: "#aaa" , icon: "fa circle-o" }, '' +Render.render('text', {style: "color:#999" }, "Not granted")+ '')+ '';	
					}
					
					if (cf.id>0){
						return "  " +Render.render('super_cell', {icon_color: "success" , icon: "fa check" }, "<b style='color:"+(Color.get('success more'))+"'>"+(cf.name)+"</b>")+ '';	
					}
					
					return "  " +Render.render('super_cell', {icon_color: "#aaa" , icon: "fa circle-o" }, '' +Render.render('text', {style: "color:#999" }, ""+(cf.name)+"")+ '')+ '';
					
				},
				editable: function(user){
					return cellEditable(user, this);
				},
				width: 135
			});
			
		}
		
		var mx = new SuperTable.model({
			models: models
		});
		
		$("#js-user-roles").addClass("-abs-fit").css({backgroundColor: 'white'}).html("  " +Render.render('super_table', {selection: "#js-selected-button" , _class: "role-tables" , row_class: "ur" , data:opts.users, model:mx, ipp: "10000" , sticky_header:1}, '')+ '');
	};
	
	
	function getPref(e, values){
		var val=0;
		if ("value" in e){
			val=e.value;
		}else if (typeof(values[e.key]) != "undefined"){
			val=values[e.key];
		}
		
		val=parseInt(val);
		var icon='';
		if (e.icon){
			icon="<span class='pref-icon'>"+(e.icon)+"</span>";
		}
		
		return "<div class='pref "+(icon?' -p32':'')+"'> "+(icon)+" <div class='pref-name'>"+(e.label)+"</div> <div class='pref-info'>"+(e.label)+"</div> <div class='hidden'><input type='hidden' name'"+(e.key)+"' value='val'/></div> <div class='pref-value'> <div class='onoff "+(val?'-on':'-off')+" -small'></div> </div> </div>";
	};
	
	
	function bindEvents(){
		$("#js-user-roles .js-re").each(function(){
			$(this).on("change", function(){
				var v=$(this).val();
				var username=$(this).data("user");
				var key=$(this).data("key");
				UI.ajaxShow();
				AP.post("api/approle/set", {username: username, key: key, value: v}, function(code){
					UI.ajaxHide();
					
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng");
					AP.refresh();
				});
			});
		});
	};
	
	
	function cellEditable(user, hd){
		var cf = null;
		if (user._roles && user._roles[hd.role.key]){
			var ur = user._roles[hd.role.key];
			
			cf = ARR.single(hd.options, function(e){
				return parseInt(e.id) == parseInt(ur);
			});
		}
		
		return {
			acl: Me.isSystemOwner(),
			type: "select",
			action: "api/approle/set",
			data: {username: user.username, key: hd.role.key},
			value: cf?cf.id:0,
			success: function(header, cell, collection){
				AP.xRefresh();
			}
		}
	};
	
	
	function setPrefValue(){
		
	};
	
	
	
	function getUserRoles(u, opts){
		var r = ARR.find(opts.roles, function(r){
			return parseInt(r.user_id) == parseInt(u.id);
		});
		
		if (r){
			u.roles = r.roles;
		}
		
		var html=AP.render(opts.models, function(r){
			return "<div class='uri' data-key='"+(r.key)+"'> <div class='uri-name'>"+(r.name)+"</div> <div class='uri-key'>"+(r.key)+"</div> <div class='uri-info'>"+(r.desc)+"</div> <div class='uri-value'>"+(getValue(u, r, opts))+"</div> </div>";
		});
		
		return "<div class='ur'> <div class='ur-header url' data-url=':collapse:parent'> <div class='ur-image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='ur-title'>"+(u.name)+"</div> <div class='ur-info'>"+(u.title)+"&nbsp;</div> </div> <div class='ur-body'>"+(html)+"</div> </div>";
	};
	
	
	function getValue(u, r, opts){
		var v = 0;
		if (u.roles && u.roles[r.key]){
			v=u.roles[r.key];
		}
		
		var html=AP.render(r.options, function(e){
			return "<option value='"+(e.value)+"'>"+(e.label)+"</option>";
		});
		
		return "<select class='js-re' name='ur-"+(u.username)+"' data-user='"+(u.username)+"'  data-value='"+(v)+"' data-key='"+(r.key)+"'>"+(html)+"</select>"
	};
};


App.sub = new function __AppSub(){
	
	this.admins = function(with_owners){
		return ARR.filter(Client.people, function(e){
			if (with_owners && parseInt(e.role)==13){
				return true;
			}
			
			return isAppAdmin(e);
		});
	};
	
	
	function isAppAdmin(e){
		var appkey = Client.base.app;
		
		if (AP.array.single(e.sas, function(app){
			return app==appkey || app==appkey+".admin";
		})){
			return true;
		}
	};
	
};
if (!Client.networks){
	Client.networks = Client.units;
}

var Network=new  function __Network(){
	this.favorMe=function(){
		if (!Client.data.network){
			return;
		}
		
		if (Me.favor(Client.data.network)){
			var id=Client.data.network.id;
			Me.removeFavorite(id, function(fs){
				Client.favors=fs;
				UI.flash("Team removed to from favourite!");
				
				$("#team-"+id).removeClass("-favour").slideUp(150, function(){
					$(this).prependTo("#teams").slideDown(400);
				});
			});
		}else{
			var id=Client.data.network.id;
			Me.setFavorite(id, function(fs){
				UI.ajaxHide();
				Client.favors=code.favors;
				UI.flash("Team set to favourite!");
				$("#team-"+id).addClass("-favour").slideUp(150, function(){
					$(this).insertAfter("#menu .section.-favorite .last").slideDown(400);
				});
			});
		}
	};
	
	this.leave=function(){
		if (!Client.data.network){
			return;
		}
		
		if (this.root()){
			return AP.alertError("You can not leave the company.");
		}
		
		AP.confirm("Are you sure that you want to leave the team <b>"+Client.data.network.name+"</b> now? This action cannot be undone.", function(){
			AP.ajaxShow();
			AP.post("api/network/member/leave",{hid: Client.data.network.hid, token: Client.data.network.token}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("You've just left the team!", function(){
					AP.redirect("home");
				});
			});
		});
		
	};
	
	this.root=function(network){
		if (network){
			return AP.data.equal(network.type, this.type.types.root)
		}
		
		return Client.data.network && AP.data.equal(Client.data.network.type, this.type.types.root);
	};
	
	
	this.select=function(title, callback){
		if (!callback){
			callback=null;
		}
		
		var actions=[];
		for (var i=0; i<Client.networks.length; i++){
			var e=Client.networks[i];
			actions.push({id:e.id, hid: e.hid, token: e.token, label: e.name, name:e.name, sublabel: Client.system.domain+"/"+e.path+" &middot; "+e.num_people+" people", value: 1});
		}
		
		AP.selectAction(actions, function(action){
			if (callback){
				callback(action);
			}
		},{title: title});
	};
	
	
	this.invite=function(){
		if (this.root() || !Client.data.network){
			return Company.member.inviteDialog();
		}else{
			return this.member.inviteDialog();
		}
	};
	
	
	this.inviteList=function(content, callback, error){
		AP.post("api/network/member/invite",{list: 1, network: Client.data.network.id, token: Client.data.network.token, usernames: content}, function(code){
			if (!code.good()){
				if (error){
					error(code.message);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.usernames);
		});
	};
	
	
	
	this.get=function(id){
		if (AP.data.isInt(id)){
			return AP.array.findObj(Client.networks, id);	
		}
		
		
		for (var i=0; i<Client.networks.length; i++){
			if (Client.networks[i].path==id){
				return Client.networks[i];
			}
		}
		
		return null;
	};
	
	
	this.getByPath=function(path){
		for (var i=0; i<Client.networks.length; i++){
			if (Client.networks[i].path==path){
				return Client.networks[i];
			}
		}
		
		return null;
	};
	
	
	
	this.appVal=function(key){
		var id=Client.pageData.network_apps.indexOf(key);
		if (id==-1){
			return 0;
		}
		return 1;
	};
	
	
	this.settings=function(){
		var admin=false;
		if (Client.data.network && Me.isNetworkAdmin(Client.data.network)){
			admin=true;
		}
		
		
		if (admin){
			var options=[];
			options.push({"label":"Edit team name &amp; privacy", "icon":"cog", action: function(){
				Network.editSelf();
			}});
			
			options.push({"label":"Invite more people", "icon":"person_add", action: function(){
				Network.invite();
			}});
			
			options.push({"label":"Team preferences &amp; settings", "icon":"lock_outline", action: function(){
				Network.preference();
			}});
			
			
			options.push({"label":"My personal preferences", "icon":"favorite_outline", action: function(){
				Network.personalPreference();
			}});
			
			if (!Network.root()){
				if (Client.data.network && Client.pageData.settings_team.leave=="yes"){
					options.push({"label":"Leave the team now", "icon":"power_settings_new", action: function(){
						Network.leave();
					}});	
				}	
			}
			
			AP.actionMenu(options);
			return;
		}else{
			var options=[];
			options.push({"label":"My personal preferences", "icon":"favorite_outline", action: function(){
				Network.personalPreference();
			}});
			
			if (Client.data.network && Client.pageData.settings_team.leave=="yes"){
				options.push({"label":"Leave the team now", "icon":"power_settings_new", action: function(){
					Network.leave();
				}});
			}
			
			AP.actionMenu(options);
			return;
		};	
	};
	
	
	
	this.preference=function(){
		UI.setting("Team preferences &amp; settings")
		.add({
			title: "Who can create regular posts?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.update,
			name:"update",
			url: "api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Who can create new topics?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.topic,
			name:"topic",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Who can post announcements?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.announcement,
			name:"announcement",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Grant posting announcements permission to some extra users? <small><i>Note.</i> This is an exception.</small>", 
			options: ":custom:users", 
			value: Client.pageData.settings_team.announcement_extra,
			name:"announcement_extra",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Who can use tag <b>@all</b> to tag everyone?", 
			options: {"everyone":"Everyone","admin":"Team admins and owners", "owner":"Only team owners"}, 
			value: Client.pageData.settings_team.tagall,
			name:"tagall",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Share posts of this team to its members' home feeds? <small><i>Note.</i> Each member can also have his/her own preference.</small>", 
			options: {"yes":"Yes","no":"No"}, 
			value: Client.pageData.settings_team.share,
			name:"share",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Allow team members to delete their own posts?", 
			options: {"yes":"Yes","no":"No"},
			value: Client.pageData.settings_team.delete_post,
			name:"delete_post",
			url:"api/network/setting/"+Client.data.network.hid
		})
		.add({
			title: "Allow team members to leave? <small><i>Note.</i> If allowed, team members can leave the team by themselves. In any cases, team owners can remove members.</small>", 
			options: {"yes":"Yes","no":"No"}, 
			value: Client.pageData.settings_team.leave,
			name:"leave",
			url:"api/network/setting/"+Client.data.network.hid,
		})
		.show();
	};
	
	
	this.editSelf=function(){
		Company.editNetwork(Client.data.network);
	};
};Network.type=new function __NetworkType(){
	this.types={
		'head':13,
		'root':13,
		'office_public':1,
		'office_private':2,
		'office_restriced':3
	};
	
	this.typeName=function(type){
		if (AP.data.equal(type, this.types.head)){
			return "Head office";
		}
		
		if (AP.data.equal(type, this.types.office_public)){
			return "Public office";
		}
		
		if (AP.data.equal(type, this.types.office_private)){
			return "Private office";
		}
		
		return "Restricted office";
	};
};Network.member=new  function __WnetworkMember(){
	this.invite=function(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
   			 return AP.alertError(code.message);
   		 }
   		 
   		 AP.alertSuccess(code.message);
		});
	};
	
	
	this.inviteDialog=function(){
		var form=Form.create('d-invite-fx',{'action':'api/network/member/invite'})
		.row(
			Form.noLabel(),
			Form.input({name: 'usernames', "type":"text", "placeholder":"Type @ to tag all people you want to invite"})
		)
		.hiddens({
			network: Client.data.network.id,
			'token': Client.data.network.token
		})
		.buttons([
		     {label: "Invite to "+Client.data.network.name, action: function(){
		    	 Form.submit("d-invite-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("d-invite-fx");
		    		 return AP.alertSuccess("Invite people successfully", function(){
		    			 AP.refresh();
		    		 });
		    	 });
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("d-invite-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings({"block": true});
	
		Form.pop({id:'d-invite-fx-dx', width: 600, 
			label: "Invite people to "+Client.data.network.name
		}).setForm(form).show().focus('usernames');
		
		Tag.user(form.find('usernames'), Client.people);
	};
	
};var Role=new function __Role(){
	
	this.OWNER=13;
	this.ADMIN = 10;
	this.REGULAR=1;
	this.BLOCKED=-1; 
	
	this.lists=
		[
		 	{id: 13, key:'owner', name:'Team Owner'},
		 	{id: 10, key:'admin', name:'Admin'},
		 	{id: 1, key:'member', name:'Member'},
		 	{id: -1, key:'blocked', name:'Blocked Member'},
		];
};





Role.collection=new function __RoleCollection(){
	this.get=function(id){
		id=parseInt(id);
		for (var i=0; i<Role.lists.length; i++){
			if (Role.lists[i].id==id){
				return Role.lists[i]; 
			}
		}
		
		return {id: 0, key:'unknown', name:'Unknown Role'};
	};
};var UI = new function __UI(){
	this.str2int = function(str){
		var r = 3;
		for (var i = 0; i < str.length; i++){
			r += str.charCodeAt(i) * str.charCodeAt(i);
		}

		return r % 8 + 1;
	};


	this.clean = function(content){
		return AP.purify(content.replace(/\{\{\@[a-zA-Z0-9 ]+\}\}/g, function(match){
			var key = match.substr(3, match.length - 5);
			return "@" + key + "";
		}));
	};


	this.parse = function(content){
		return content.replace(/\{\{\@[a-zA-Z0-9\_]+\}\}/g, function(match){
			var key = match.substr(3, match.length - 5);
			if (key == "all"){
				return "<em class='url pointer inline-tag' title='Tag @all'>all</em>";
			}
			
			var u=People.get(key);
			if (u && parseInt(u.uid)){
				return "<em class='url pointer username inline-tag' data-username='"+(u.username)+"'>"+(u.name)+"</em>";
			}
			
			return "<em class='url pointer username inline-tag'>" + key + "</em>";
		});
	};
	
	
	this.textParse = function(content){
		content = content.replace(/<\*([\w\s\{\}]+)\*>/g, '<code>$1</code>').replace(/\*\*([\w\s\{\}]+)\*\*/g, '<b>$1</b>').replace(/\*([\w\s\{\}]+)\*/g, '<i>$1</i>');
		return content;
	};
	

	this.fakeLoading = function(fn){
		this.ajaxShow();
		setTimeout(function(){
			UI.ajaxHide();
			fn();
		}, 300);
	};

	this.ajaxShow = function(){
		$("#ajax-load-2").show();
	};

	this.ajaxHide = function(){
		$("#ajax-load-2").hide();
	};

	this.sortable = function(opts){
		if (!parseInt(Client.env)){
			$.log("UI.sortable({canvas: string|jQuery, items: string, action: url, data: object optional, handle: string|optional})");
		}
		
		opts = $.extend({axis: 'y', forcePlaceholderSize: false}, opts);
		
		$(opts.canvas).sortable({
			handle: opts.handle,
			items: opts.items,
			placeholder: 'tr-placeholder',
			helper:'clone',
			axis: opts.axis,
			forcePlaceholderSize: opts.forcePlaceholderSize,
			beforeStop: function(event, ui){
				// a();
				if (opts.debug){
					a();
				}
			},
			stop: function(event, ui){
				var id=$(ui.item).data("id");
				var order=$(ui.item).index();
				
				UI.ajaxShow();
				var ords=[];
				$(opts.canvas).find(opts.items).each(function(){
					ords.push($(this).data("id"));
				});
				
				var data=$.extend({orders: ords.join(",")}, opts.data);
				
				AP.post(opts.action, data, function(code){
					UI.ajaxHide();
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					if (opts.callback){
						opts.callback();
					}
				});
			}
		});
	};

	this.picker=function(objs, callback, opts){
		if (!callback && !opts){
			return this.pickerv2(objs);
		}
		
		if (!opts){
			opts={};
		}
		
		opts=$.extend({},{title: "Please select one", filter: true, search: true}, opts);
		
		var actions=[];
		for (var i=0; i<objs.length; i++){
			var obj={label: objs[i].name, name: objs[i].name, id: objs[i].id, value: objs[i].id, data: objs[i]};
			if (opts.render){
				obj._html=opts.render(objs[i]);
			}
			actions.push(obj);
		}
		
		AP.selectAction(actions, function(e){
			callback(e.data);
		}, opts);
	};
	
	
	this.pickerv2=function(opts){
		if (!opts.callback){
			console.error("PICKER_CALLBACK_EMPTY");
			return;
		}
		
		opts=$.extend({},{title: "Please select one", filter: true, search: true, render: null}, opts);
		this.picker(opts.items, opts.callback, opts);
	};
	
	
	this.autoActive=function(){
		$(".auto-active-url").each(function(){
			var fb="home";
			if ($(this).data("default")){
				fb=$(this).data("default");
			}else if ($(this).data("fallback")){
				fb=$(this).data("fallback");
			}
			
			if ($(this).data("urlparam")){
				$(this).children(".url").setActiveURLParam($(this).data("urlparam"), 0);
			}else{
				$(this).children(".url").setActiveURL({fallback: fb});	
			}
		});
		
		$(".auto-url2a").each(function(){
			Base.url2a(this, ".url");
		});
	};
	
	this.tabView = function(tabs, sections, callback){
		$(tabs).each(function(){
			$(this).click(function(){
				$(this).siblings().removeClass("active");
				$(this).addClass("active");
				var $this = $(this);
				var tab = $(this).data("tab");

				$(sections).each(function(){
					if ($(this).data("tab") == tab){
						var status = false;

						if ($(this).hasClass("active")){
						} else{
							status = true;
						}

						$(this).addClass("active");

						if (callback){
							callback(tab, status, $this);
						}
					} else{
						$(this).removeClass("active");
					}
				});
			});

			if ($(this).hasClass("active")){
				var tab = $(this).data("tab");
				var $this = $(this);
				$(sections).each(function(){
					if ($(this).data("tab") == tab){
						$(this).addClass("active");
						if (callback){
							callback(tab, true, $this);
						}
					} else{
						$(this).removeClass("active");
					}
				});
			}
		});
	};

	
	this.rangePicker=function(callback){
		var data={};
		var start=null, end=null;
		if (Client.pageData.range){
			start=Client.pageData.range.start;
			end=Client.pageData.range.end;
		}
		
		var form=Form.create('fly-rp-fx',{'action': "about:blank"})
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u *"}),
			Form.input({name: 'start', placeholder: "NgĂ y báº¯t Ä‘áº§u", role:"date"}).value(start)
		)
		.row(
			Form.label({label: "NgĂ y káº¿t thĂºc *"}),
			Form.input({name: 'end', placeholder: "NgĂ y káº¿t thĂºc", role:"date"}).value(end)
		)
		.buttons([
			{label: "OK", action: function(){
				 var start=$("#fly-rp-fx *[name=start]").val();
				 var end=$("#fly-rp-fx *[name=end]").val();
				 if (start && end){
					 callback(safe(start), safe(end));
					 Form.hide("fly-rp-fx");	 
				 }else{
					 AP.alertError("PLEASE SELECT ALL DATES");
				 }
				 
			 }, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function(){
				 Form.hide("fly-rp-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
		});

		Form.pop({id:'fly-rp-dx', width: 480, label: "Chá»n khoáº£ng thá»i gian", layout: 'flat', closable: false}).setForm(form).show();
	};

	
	
	this.time = function(ts){
		return AP.time.time("%h:%i %M %d", ts);
	};


	this.simpleTime = function(time){
		var today = AP.time.time("%M %d", AP.time.now());
		var yesterday = AP.time.time("%M %d", AP.time.now() - 24 * 3600);
		var test = AP.time.time("%M %d", time);

		if (today == test){
			return AP.time.time("%H:%i today", time);
		} else if (today == yesterday){
			return AP.time.time("%H:%i yesterday", time);
		}

		return AP.time.time("%H:%i %M %d, %Y", time);
	};


	this.inputTime = function(time){
		return AP.time.time(AP.i18n.dateFormat(), time);
	};


	this.inputDate = function(time){
		return AP.time.time(AP.i18n.dateFormat(), time);
	};

	this.simpleDate = function(time){
		return AP.time.time("%M %d, %Y", time);
	};


	this.progression = function(object, canvas, opts){
		return this.graph.progression(object, canvas, opts);
	};


	this.dayOptions = function(selector){
		var html = AP.render(range(1, 31), function(e){
			return "<option value='" + e + "'>" + AP.data.zeroPrefix(e) + "</option>";
		});
		html = "<option value='0'>-- Select date --</option>" + html;

		$(selector).html(html);
	};


	this.monthOptions = function(selector){
		var html = AP.render(range(1, 12), function(e){
			return "<option value='" + e + "'>" + AP.data.zeroPrefix(e) + "</option>";
		});
		html = "<option value='0'>-- Select month --</option>" + html;

		$(selector).html(html);
	};


	this.yearOptions = function(selector){
		var html = AP.render(range(1950, 2017), function(e){
			return "<option value='" + e + "'>" + AP.data.zeroPrefix(e) + "</option>";
		});
		html = "<option value='0'>-- Select year --</option>" + html;

		$(selector).html(html);
	};


	this.searchable=function(ip){
		$(ip).enter(function(){
			var q=$(this).val();
			if (!q || !q.length){
				q=null;
			}
			AP.setURLParams({q: q}, true);
		});
		
		var q=Query.get("q");
		if (q){
			$(ip).val(q);
		}
	};
	
	
	this.previewImage = function(url){
		function resizeImgBox(ref){
			var h = $(ref).data("h");
			var w = $(ref).data("w");
			var mh = $("#image-dialog-previewer .image-wrap").height();

			if (!h || !mh){
				return;
			}

			if (h > mh){
				$(ref).css("height", mh).css("width", w * mh / h);
			}

			$(ref).dblclick(function(){
				var h = $(this).data("h");
				var w = $(this).data("w");
				var mh = $("#image-dialog-previewer .image-wrap").height();
				var s = $(this).data("s");

				if (s == 0){
					s = 1;
				} else{
					s = 0;
				}

				$(this).data("s", s);

				if (s == 1){
					$(ref).css({width: w, height: h});
				} else{
					$(ref).css("height", mh).css("width", w * mh / h);
				}
			});
		};


		$("#image-dialog-previewer").remove();

		$("<div id='image-dialog-previewer'></div>").appendTo(document.body);
		$("#image-dialog-previewer").html("" +
			"<div class='image-wrap'><div class='img'><img src='" + url + "'/></div></div>" +
			"<div class='image-actions'>" +
			"	<div class='action image-close'><span class='-ap icon-close'></span></div>" +
			"	<a class='action url' href='" + url + "' target='_blank'><span class='-ap icon-forward2'></span></a>" +
			"</div>");

		$("#image-dialog-previewer .image-close").click(function(){
			$("#image-dialog-previewer").remove();
		});

		// Draggable
		$("#image-dialog-previewer .image-wrap .img").draggable({
			// containment: 'parent'
		});

		$("#image-dialog-previewer .img img").load(function(){
			var h = $(this).height();
			var w = $(this).width();

			$(this).data("h", h);
			$(this).data("w", w);
			$(this).data("s", 0);

			resizeImgBox(this);
		});
		
		Context.close();
	};


	this.paginate = function(canvas, url){
		if (!url){
			url=Client.path.base;
			if (!url){
				url="";
			}
			
			var cqs="";
			
			var qs=Query.all();
			for (var key in qs){
				if (key=="env" || key=="page" || !key){
					continue;
				}
				cqs+=key+"="+qs[key]+"&";
			}
			
			if (cqs.length){
				cqs=cqs.substr(0, cqs.length-1);
			}
			
			if (cqs){
				if (Client.path.current.indexOf("?")==-1 || cqs){
					url=url+"?"+cqs;
				}else{
					url=url+"&"+cqs;
				}
			}
		}
		
		var page = Query.getInt("page");
		if (!page){
			page = 1;
		}

		var next_url = url + "?page=" + (page + 1);
		var prev_url = url + "?page=" + (page - 1);

		if (url.indexOf("?") != -1){
			next_url = url + "&page=" + (page + 1);
			prev_url = url + "&page=" + (page - 1);
		}

		var counter='';
		if (Client.pageData.result_counts){
			counter = " &nbsp; (of total "+(Client.pageData.result_counts)+" records) ";
		}
		
		var html = "<div class='icons'>" +
			"<div class='prev url' data-url='" + prev_url + "'><span class='-ap icon-arrow-left2'></span></div>" +
			"<div class='label'>Page " + page + counter + "</div>" +
			"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
			"</div>";

		if (page == 1){
			html = "<div class='icons'>" +
				"<div class='prev disabled'><span class='-ap icon-arrow-left2'></span></div>" +
				"<div class='label'>Page " + page + counter + "</div>" +
				"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
				"</div>";
		}

		$(canvas).addClass("apppages").html(html);
	};


	this.paginateEx = function(canvas, url, total_pages){
		var page = Query.getInt("page");
		if (!page){
			page = 1;
		}

		var next_url = url + "?page=" + (page + 1);
		var prev_url = url + "?page=" + (page - 1);

		if (url.indexOf("?") != -1){
			next_url = url + "&page=" + (page + 1);
			prev_url = url + "&page=" + (page - 1);
		}


		var html = "<div class='icons'>" +
			"<div class='prev url' data-url='" + prev_url + "'><span class='-ap icon-arrow-left2'></span></div>" +
			"<div class='label'>Page " + page + "/" + total_pages + "</div>" +
			"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
			"</div>";


		if (page == 1){
			html = "<div class='icons'>" +
				"<div class='prev disabled'><span class='-ap icon-arrow-left2'></span></div>" +
				"<div class='label'>Page " + page + "/" + total_pages + "</div>" +
				"<div class='next url' data-url='" + next_url + "'><span class='-ap icon-arrow-right2'></span></div>" +
				"</div>";
		}

		$(canvas).addClass("apppages").html(html);
	};
	
	
	/**
	 * @desc Make sure that the elem is fully visible
	 */
	this.scrollVisible = function(elem, offset){
		var $box = $(elem).closest(".__apscrollbar_target, .scroll-y");
		if (!$box || !$box.length){
			return;
		}
		
		var top = $(elem).position().top;
		var height = $(elem).height();
		var mheight = $box.height();
		
		if (top + height > mheight){
			$box.scrollTop(top + 2*height - mheight);
		}
	};


	this.editor = function(selector, action, them){
		if (!action && AP.data.isObject(selector)){
			return this._editor(selector);
		}
		
		if (Client.native){
			if (action == 'empty'){
				$(selector).val("");
				return;
			}
			return;
		}

		if (action == 'empty'){
			$(selector).trumbowyg('empty');
			return;
		}

		if (action == 'focus'){
			$(selector).closest(".trumbowyg-box").find(".trumbowyg-editor").focus();
			return;
		}

		
		var mh=$(selector).data("minheight");
		if (!mh){
			$(selector).data("minHeight");
		}
		
		if (!mh && AP.data.isObject(action)){
			mh=action.minHeight;
		}
		
		if (!mh){
			mh=300;
		}
		
		if (mh<10){
			mh=20;
		}
		
		if (AP.config && AP.config.editor=="summernote"){	
			var compact=$(selector).data("compact");
			var tb=[
				['style', ['style','bold', 'italic', 'underline', 'clear']],
//				['font', ['strikethrough', 'superscript', 'subscript']],
				['fontsize', ['fontsize']],
				['color', ['color']],
				['para', ['ul', 'ol', 'paragraph']],
				['insert', ['picture', 'link', 'table', 'hr']]
			];
			
			if (action && action.code){
				tb.push("custom", ["codeblock"]);
			}
			
			if (compact && parseInt(compact)){
				tb=[
					['style', ['bold', 'italic', 'underline', 'clear']],
//					['font', ['strikethrough', 'superscript', 'subscript']],
					['para', ['ul', 'ol', 'paragraph']]
				];
				
				if (parseInt(compact)==2){
					tb=[
//						['style', ['bold', 'italic', 'underline', 'clear']],
//						['font', ['strikethrough', 'superscript', 'subscript']],
					];
				}
			}
			
			
			var fs=parseInt($(selector).css("font-size"), 10);

			$(selector).summernote({
				tabsize: 2,
				minHeight: mh,
				toolbar: tb,
				placeholder: $(selector).attr("placeholder"),
				callbacks:{
					onPaste: function(e){
					},
					onImageUpload: function(files, editor, welEditable){
						for (var i = files.length - 1; i >= 0; i--){
							editor_sendFile(files[i], this);
						}
					}
				},
				fontSize: fs,
				buttons:{
					codeblock:summernote_codeblock
				}
			});
			
			$(selector).parent().find(".note-editable").css("font-size", fs+"px");
			if ($(selector).data("dir")=="bottom"){
				$(selector).parent().find(".note-editor").addClass("editor-bottom")
			}
			
			if (AP.data.isObject(action) && action.value){
				$(selector).summernote("code", action.value);
			}
		}else if (AP.config && AP.config.editor=="quill"){
			var opts={};
			if (AP.data.isObject(action)){
				opts=action;
			}
			
			var compact=$(selector).data("compact");
			if (!compact){
				compact=opts.compact;
			}
			
			var toolbarOptions = [
				['bold', 'italic', 'underline', 'strike'], // toggled buttons
				['blockquote', 'code-block',{"align": ['', 'center', 'right','justify']}],

				[{ 'header': 1 },{ 'header': 2 }],  // custom button values
				[{ 'list': 'ordered'},{ 'list': 'bullet' }],
				[{ 'script': 'sub'},{ 'script': 'super' }], // superscript/subscript
//				[{ 'indent': '-1'},{ 'indent': '+1' }], // outdent/indent
				["link", "image"],

				[{ 'color': [] },{ 'background': [] }], // dropdown with defaults from theme
				['clean'] // remove formatting button
			];
			
			if (compact==1 || compact=="compact"){
				toolbarOptions = [
					['bold', 'italic', 'underline', 'strike'], // toggled buttons
					[
						{'header': 1 },{ 'header': 2 }, 
						{ 'list': 'ordered'},{ 'list': 'bullet' }
					],
						
					[
						{"align": ['', 'center', 'right','justify']},
						'blockquote', 'code-block', "link", "image",
					],
					
					[{ 'color': [] },{ 'background': [] }, // dropdown with defaults from theme
					'clean'] // remove formatting button
				];
			}else if (compact==2){
				toolbarOptions = [
					['bold', 'italic', 'underline',  'strike'], [{'header': 1 },{ 'header': 2 }], // toggled buttons
					[{ 'list': 'ordered'},{ 'list': 'bullet' }], 
					['clean'],
				];
			}
			
			var id=AP.uuid();
			var mh=300;
			if (opts.height){
				mh=opts.height;
			}else if (opts.minHeight){
				mh=opts.minHeight;
			}
			
			if (mh!="auto"){
				$(selector).hide().after("<div id='"+(id)+"' class='quill-wrapper' style='height:"+(mh)+"px'></div>");	
			}else{
				$(selector).hide().after("<div id='"+(id)+"' class='quill-wrapper'></div>");
			}
			
			var theme = 'snow';
			if (action.theme){
				theme = action.theme;
			}else if (action.bubble){
				theme = 'bubble';
			}
			
			var q=new Quill('#'+id,{
				modules:{
					toolbar: toolbarOptions
				},
				theme: theme,
				placeholder:$(selector).attr("placeholder"),
			});
			
			
			var toolbar = q.getModule('toolbar');
			toolbar.addHandler('image', function(){
				var last_index=q.getSelection()?q.getSelection().index:0;
				quill_imageUpload(function(url){
					var s=q.getSelection();
					if (s){
						last_index=s.index;
					}

					// skip base64 img
					if (url.substring(0, 4) == "http"){
						q.insertEmbed(last_index, 'image', url);
					}
				});
			});
			
			q.root.setAttribute('spellcheck', false);
			
			var $canvas=$("#"+id);
			$canvas.data("editor", q);
			$(selector).data("editor", q);
			
			if (opts.fit || action.autogrow){
				$canvas.addClass("-editor-fit");
			}
			
			if (mh!="auto"){
				$canvas.find(".ql-editor").css({minHeight: mh});
				$canvas.data("mh", mh);
				
				if (action.autogrow){
					$canvas.data("autogrow", 1);
				}
			}
			
			// Screenshot paste
			$canvas.screencopy(Base.domain("api")+"/ajax/api/file/upload", function(code, $_this){
				if (code.fid && code.image){
					var $q=$_this.data("editor");
					var s=$q.getSelection();
					var last_index=0;
					if (s){
						last_index=s.index;
					}

					// skip base64 img
					$_this.find('img[src^="data:"]').remove();
					if (code.image.substring(0, 4) == "http"){
						$q.insertEmbed(last_index, 'image', code.image);
					}
					
					$(q.root).closest("form").trigger("change_base");
				}
			},{});
			
			
			
			
			q.on("text-change", function(delta, oldDelta, source){
				var $qc=$(q.root).clone();
//				$qc.find('.ql-indent-2').not('.ql-indent-2+.ql-indent-2').each(function(){
//					$(this).nextUntil(':not(.ql-indent-2)').addBack().wrapAll("<li class='ql-temp-2'><ol></ol></li>");
//				});
//				
//				$qc.find('.ql-indent-1').not('.ql-indent-1+.ql-indent-1').each(function(){
//					$(this).nextUntil(':not(.ql-indent-1)').addBack().wrapAll("<li class='ql-temp-1'><ol></ol></li>");
//				});
//				
//				$qc.find('.ql-temp-1').each(function(){
//					var $prev=$(this).prev("li");
//					if (!$prev.length){
//						return;
//					}
//					
//					$(this).find("ol").appendTo($prev);
//					$(this).remove();
//				});
//				
//				$qc.find('.ql-temp-2').each(function(){
//					var $prev=$(this).prev("li");
//					if (!$prev.length){
//						return;
//					}
//					
//					$(this).find("ol").appendTo($prev.find("li").last());
//					$(this).remove();
//				});
//				
//				
//				$qc.find('.ql-indent-1').removeClass("ql-indent-1");
//				$qc.find('.ql-indent-2').removeClass("ql-indent-2");
				
				var txt=(' '+$qc[0].innerHTML).slice(1);
				$qc.remove();
				
				$(selector).val(txt);
				
				if (mh!="auto"){
					quill_setHeight($canvas, q);
				}
				
				if (!q.__initialized){
					q.__initialized = 1;
				}else{
					$(q.root).closest("form").trigger("change_base");
				}
			});
			
			if (opts.value){
				UI.editorValue(selector, opts.value);
				
				if (mh!="auto"){
					quill_setHeight($canvas, q);
				}
			}
			
			$(q.root).on("focus", function(){
				$canvas.parent().addClass("-x-focus");
				
				$(".-x-focus").each(function(){
					if ($(this).attr("id") != $canvas.parent().attr("id")){
						$(this).removeClass("-x-focus");
					}
				});
			});
		}else if (AP.config && AP.config.editor=="trumbowyg"){
			  $.trumbowyg.svgPath = Client.share_url + "/plugins/editor.svg";
			  $.trumbowyg.hideButtonTexts = true;

			  var val = $(selector).val();
			  if (val == "" && !$(selector).attr("placeholder")){
				  $(selector).val("<p></p>");
			  }
			  
			  $(selector).css("border", "none").addClass("js-editor").trumbowyg({
				  resetCss: false,
				  fullscreenable: false,
				  removeformatPasted: true,
				  autogrow: true,
				  btnsDef:{
					  // Customizables dropdowns
					  image:{
						  dropdown: ['insertImage', 'upload'],
						  ico: 'insertImage'
					  }
				  },
				  btns: [
					  ['formatting'], ['bold', 'italic', 'underline', 'strikethrough'], ['unorderedList', 'orderedList'], ['foreColor'],
					  ['link'],
					  ['image'],
					  'preformatted',
					  'removeformat',
					  ['viewHTML'],
				  ],
				  plugins:{
					  upload:{
						  serverPath: '/ajax/api/image/upload',
						  fileFieldName: 'image',
						  data: [{name: "__code", value: Client.code},{name: "hid", value: Client.viewer.hid}],
						  success: function(data, trumbowyg, modal, values){
							  var image = data.img;
							  if (image.status === 1){
								  trumbowyg.execCmd('insertImage', image.url);
								  $('img[src="' + image.url + '"]:not([alt])', trumbowyg.$box).attr('alt', image.name);
								  setTimeout(function(){
									  trumbowyg.closeModal();
								  }, 250);
							  } else{
								  trumbowyg.addErrorOnModalField(
									  $('input[type=file]', modal),
									  trumbowyg.lang.uploadError || image.message
								  );
							  }
						  }
					  }
				  }
			  });

			 if (AP.isObject(action)){
				var $cs = $(selector).closest(".trumbowyg-box");
				if (action.panel){
					$cs.addClass("fix-panel-" + action.panel);
				}

				if (action.minHeight){
					$cs.find(".trumbowyg-editor").css({minHeight: action.minHeight})
					$cs.css({minHeight: action.minHeight})
				}

				if (action.fit){
					$cs.addClass("box-fit");
				}
			  }	
		}
	};

	
	function quill_setHeight($canvas, q){
		if ($canvas.hasClass("-editor-fit")){
			var rh=$canvas.find(".ql-editor").height();
			$canvas.height(rh);
			return;
		}
		
		var mh=$canvas.data("mh");
		if (!mh){
			mh=200;
		}
		
		var ih=0;
		$canvas.find(".ql-editor").first().children().each(function(){
			ih+=$(this).height();
		});
		
		if (ih + 50 < $canvas.height() && ih > mh){
			$canvas.css({height: ih+50});
		}
		
		var sh=$canvas.find(".ql-editor")[0].scrollHeight;
		var oh=$canvas.find(".ql-editor")[0].offsetHeight;
		
		
		if ((sh>oh+1) && !$canvas.hasClass("js-extended")){
			$canvas.css({height: sh+1});
		}
		
		if ((sh>mh*3+100 || sh>mh+400) && !$canvas.hasClass("js-extended")){
			$canvas.css({height: sh+5}).addClass("js-extended");
		}
	};
	

	
	function quill_imageUpload(callback){
		var rows=[{label: "Select image", type: "file", name: "file"}];
		
		Form.v2({
			id: "js-quill-imgupload",
			rows: rows,
			title: "Upload an image",
			buttons: Form.button({
				label: "Upload",
				style: "ok",
				action: function(){
					Form.submit("#js-quill-imgupload", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						Form.hide('js-quill-imgupload');
						callback(code.image);
					});
				}
			}).button(":cancel"),
			action: Base.domain("api")+"/ajax/api/file/upload",
		});
		
		return;
		$.log(file);
		
		var form_data = new FormData();
		form_data.append('file', file);
		form_data.append('__code', Client.code);
		form_data.append('__otp', Client.base.secureData.otp);
		form_data.append('__sessionid', Client.base.secureData.session);
		
		UI.ajaxShow();
		$.ajax({
			data: form_data,
			type: "POST",
			url: Base.domain("api")+"/ajax/api/file/upload",
			cache: false,
			contentType: false,
			processData: false,
			success: function(code){
				UI.ajaxHide();
				
				var c=new Code(code);
				if (!c.good()){
					return AP.alertError(code.message);
				}
				
				// $(el).summernote('editor.insertImage', code.image);
				callback(code.image);
			}
		});
	};
	
	
	function editor_sendFile(file, el){
		var form_data = new FormData();
		form_data.append('file', file);
		form_data.append('__code', Client.code);
		form_data.append('__otp', Client.base.secureData.otp);
		form_data.append('__sessionid', Client.base.secureData.session);
		
		UI.ajaxShow();
		$.ajax({
			data: form_data,
			type: "POST",
			url: Base.domain("api")+"/ajax/api/file/upload",
			cache: false,
			contentType: false,
			processData: false,
			success: function(code){
				UI.ajaxHide();
				
				var c=new Code(code);
				if (!c.good()){
					return AP.alertError(code.message);
				}
				
				$(el).summernote('editor.insertImage', code.image);
			}
		});
	};
	
	

	this.editorValue = function(selector, value){
		$.log(value);
		
		if (AP.config && AP.config.editor=="quill"){
			var $edx=$(selector).parent().find(".quill-wrapper");
			var content=value.replace(/\&amp;/g,'&').replace(/&#9290;/g, '&#92;');
			var q=$edx.data("editor");
			
			q.root.innerHTML = content;

//			// NEED REFORMAT
//			$edx.find("ul > li > ol ol").each(function(){
//				var $li=$(this).parent();
//				
//				$(this).children().addClass("ql-indent-2").clone().insertAfter($li);
//				$(this).remove();
//			});
//			
//			$edx.find("ol > li > ol ol").each(function(){
//				var $li=$(this).parent();
//				$(this).children().addClass("ql-indent-2").clone().insertAfter($li);
//				$(this).remove();
//			});
//			
//			
//			// NEED REFORMAT
//			$edx.find("ul > li > ol").each(function(){
//				var $li=$(this).parent();
//				$(this).children().addClass("ql-indent-1").clone().insertAfter($li);
//				$(this).remove();
//			});
//			
//
//			$edx.find("ol > li > ol").each(function(){
//				var $li=$(this).parent();
//				$(this).children().addClass("ql-indent-1").clone().insertAfter($li);
//				$(this).remove();
//			});
//			
//			$edx.find(".ql-indent-2").each(function(){
//				if ($(this).hasClass("ql-indent-1")){
//					if ($(this).html()==""){
//						$(this).remove();
//					}else{
//						$(this).removeClass("ql-indent-1");	
//					}
//				}
//			});

			$(selector).val(content);
			$(selector).parent().find(".quill-wrapper pre").addClass("ql-syntax");
			
			$(selector).parent().find(".quill-wrapper pre").each(function(){
			})
			
			return;
		}
		
		$(selector).trumbowyg('html', value);
	};


	this.mobileEditor = function(selector, action){
		if (action == 'empty'){
			$(selector).trumbowyg('empty');
			return;
		}

		$(selector).css("border", "none").trumbowyg({
			resetCss: true,
			btns: [
				'bold', 'italic', 'underline',
				'|', 'link', 'insertImage',
				'|', 'formatting',
				'removeformat'
			],
			fullscreenable: false,
			removeformatPasted: true,
			autogrow: true
		});
	};


	this.flash = function(msg){
		$("#flash-msg").show().html(msg).css({top: -80}).animate({top: 90}, 300).delay(1300).animate({top: -80}, 300, function(){
			$(this).hide();
		});
	};


	this.pickDeadline = function(input, callback){
		$(input).data('callback', callback);

		$(input).on('click focus', function(){
			var html = buildDeadlinePicker();
			AP.customDialog(html, "#custom-deadline").addClass('-full').show();
			$("#deadline-picker").data("callback", $(this).data('callback'));
			$("#deadline-picker .custom .__date").selectDate();

			var val = $(this).val();

			if (val == "today" || val == "asap" || val == "tomorrow" || val == "weekend"){
				deadlinepicker_pick(val, true);
			}

			if (!val){
				deadlinepicker_pick("custom", true);
			}
		});
	};

	
	/**
	 * @desc Click to show
	 */
	this.clickToShow=function(elem, opts){
		if (elem==="close"){
			$(opts).hide();
			$(opts).closest(".ui-overflow-fixed").toggleClass("extended");
			return;
		}
		
		opts=$.extend({},{height: 100, bg:"#ffffff"}, opts);
		var gradient = ""+(Color.rgba(opts.bg, 0.2))+", "+(opts.bg)+", "+(opts.bg)+"";
		
		if (opts.dark){
			opts.bg = opts.dark_color||"#000000";
			gradient = ""+(Color.rgba(opts.bg, 0.2))+", "+(Color.rgba(opts.bg,0.6))+", "+(Color.rgba(opts.bg,0.8))+"";
		}
		
		var h=$(elem).height();
		if (h<opts.height){
			$(elem).removeClass("ui-overflow-fixed").addClass("ui-overflow-none");
			return;
		}
		
		var sm="<div class='overflow-btn' onclick=\"UI.clickToShow('close', this)\" style='background-image: linear-gradient("+(gradient)+");'>Xem thĂªm</div>";
		$(elem).removeClass("ui-overflow-none").addClass("ui-overflow-fixed").css({maxHeight: opts.height+"px"}).append(""+(sm)+"");
	};
	

	this.avatars = function(users){
		if (!users || !users.length){
			return "";
		}
		return AP.render(users, function(u){
			return "<div class='url user username' data-username='" + u.username + "'><img src='" + AP.xthumb(u.gavatar) + "'/></div>";
		});
	};


	this.textAvatar = function(str, size, color, len){
		if (!len){
			len = 1;
		}

		if (!size){
			size = 32;
		}

		if (!color){
			color = UI.str2int(str);
		}

		var paths = str.split(" ");
		var txt = str.substr(0, len);

		if (paths.length >= 2){
			txt = paths[0].charAt(0) + paths[1].charAt(0);
		}

		if (len == 1){
			txt = str[0];
		}


		return "<div class='-tavatar -bg-alt" + color + "' style='line-height: " + size + "px; width: " + size + "px; height: " + size + "px'><span class='-txt'>" + txt + "</span></div>";
	};
};


UI.special = function(title, content, buttons){
	var html = "<div class='title'>" + title + "</div><div class='content'>" + content + "</div><div class='buttons'></div>";

	$("#canvas-special .main").css({top: -500});
	$("#canvas-special").show();

	$("#canvas-special .main").html(html).animate({top: 100}, 500);
	for (var i = 0; i < buttons.length; i++){
		var button = buttons[i];
		$("<div class='button button-" + i + " " + button.classes + "'>" + button.label + "<div class='sublabel'>" + button.sublabel + "</div></div>").click(button.action).appendTo("#canvas-special .buttons");
	}
	$("#canvas-special").show();
};

UI.hideSpecial = function(){
	$("#canvas-special .main").animate({top: -500}, 300, function(){
		$("#canvas-special").hide();
	});
};


UI.range = function(start, end, label){
	var d = [{value: 0, "label": label}];
	if (start < end){
		for (var i = start; i <= end; i++){
			d.push({value: i, "label": i});
		}
	} else{
		for (var i = start; i >= end; i--){
			d.push({value: i, "label": i});
		}
	}
	return d;
};


function icon(icm, size){
	if (typeof size == 'undefined'){
		size = 16;
	}
	if (icm.indexOf(" ") != -1){
		return "<span class='ap-f" + size + " normal " + icm + "'></span> &nbsp;";
	} else{
		return "<span class='ap-f" + size + " normal -ap icon-" + icm + "'></span> &nbsp;";
	}
};


function buildDeadlinePicker(){
	var selections = "<div class='tab active' onclick=\"deadlinepicker_pick('asap');\">Due ASAP</div> <div class='tab' onclick=\"deadlinepicker_pick('today');\">Due today</div> <div class='tab' onclick=\"deadlinepicker_pick('tomorrow');\">Due tomorrow</div> <div class='tab' onclick=\"deadlinepicker_pick('weekend');\">Due this weekend</div> <div class='tab' onclick=\"deadlinepicker_pick('custom');\">Choose a custom date and time</div>";


	var hours = [];
	for (var i = 0; i < 12; i++){
		hours.push({label: i + "am", value: i});
	}

	for (var i = 1; i < 12; i++){
		hours.push({label: i + "pm", value: i + 12});
	}

	var hour_opts = AP.render(hours, function(e){
		return "<option value='" + e.value + "'>" + e.label + "</option>";
	});

	var min_opts = AP.render(["00", "05", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55"], function(e){
		return "<option value='" + e + "'>" + e + "</option>";
	});

	var html = "<div id='deadline-picker'>" +
		"<div class='tabs'><h3>Select deadline</h3>" + selections + "</div> <div class='canvas'></div>" +
		"<div class='custom hidden'><div class='box'>" +
		"	<h1>Choose a specific deadline date/time</h1>" +
		"	<div class='input'><input type='text' class='__date' name='custom-date' value='" + UI.inputTime(AP.time.now()) + "' placeholder='Select date'/></div>" +
		"	<div class='select'>" +
		"		<select name='custom-hour' class='std' style='float:left; width: 100px; margin-right:20px'>" + hour_opts + "</select>" +
		"		<select name='custom-min'  class='std' style='float:left; width: 100px;'>" + min_opts + "</select>" +
		"	</div>" +
		"</div></div>" +
		"<div class='footer'><div class='button -success -circled' onclick='deadlinepicker_callback(this);'>Continue</div></div>" +
		"</div>";


	return html;
};


function deadlinepicker_pick(type, initiate){
	$("#deadline-picker").data("val", type);

	if (type == "asap"){
		$("#deadline-picker .tabs .tab").setActive(0);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>today, asap</em></div></div>");
	} else if (type == "today"){
		$("#deadline-picker .tabs .tab").setActive(1);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>today, 11:59pm</em></div></div>");
	} else if (type == "tomorrow"){
		$("#deadline-picker .tabs .tab").setActive(2);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>tomorrow, 11:59pm</em></div></div>");
	} else if (type == "weekend"){
		$("#deadline-picker .tabs .tab").setActive(3);
		$("#deadline-picker .canvas").html("<div class='ft'>due <em>this sunday, 11:59pm</em></div></div>");
	} else if (type == "custom"){
		$("#deadline-picker .tabs .tab").setActive(4);
		$("#deadline-picker .custom").show();
	}

	if (initiate || type == "custom"){

	} else{
		deadlinepicker_callback("#deadline-picker");
	}
};


function deadlinepicker_callback(ref){
	var type = $("#deadline-picker").data("val");
	var date = 0;
	var time = 0;
	if (type == "custom"){
		// AP.alertError("Please pick a custom date and time.");
		var date = $("#deadline-picker input[name=custom-date]").val();
		var hour = $("#deadline-picker select[name=custom-hour]").val();
		var min = $("#deadline-picker select[name=custom-min]").val();

		date = date;
		time = hour + ":" + min;
	} else{

	}

	var fn = $("#deadline-picker").data("callback");
	fn(type, date, time);
	AP.closeDialog(ref);
};


function fiximg(url){
	if (parseInt(Client.https)){
		var check = Client.image_url.replace('https://', 'http://');
		if (url && url.indexOf(check) >= 0){
			url = url.replace('https://', 'http://');
		}

		check = Client.data_url.replace('https://', 'http://');
		if (url && url.indexOf(check) >= 0){
			url = url.replace('http://', 'https://');
		}
	}

	return url;
};


var summernote_codeblock=function(context){
	var ui = $.summernote.ui;
	
	var button = ui.button({
		contents: "<i class='ficon-code'/>",
		tooltip: 'Insert code block',
		click: function(){
			context.invoke('editor.pasteHTML', '<pre><code>Place your code here</code></pre>');
		}
	});
	
	return button.render();
};





UI.fav=new function __UIFav(){
	this.update=function(url, opts, callback){
		UI.ajaxShow();
		AP.post(url, {id: opts.target.id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			if (parseInt(code.added)){
				opts.list.push(code.id);
				opts.list=AP.array.unique(opts.list, function(e, f){
					return parseInt(e)==parseInt(f);
				});
			}else{
				opts.list=AP.array.filter(opts.list, function(e){
					return parseInt(e)!=parseInt(code.id);
				});
			}
			
			callback(parseInt(code.added), opts.list, code);
		})
	};
	
	this.isFav=function(id, list){
		return AP.array.contain(list, id, function(e, f){
			return parseInt(e) == parseInt(f);
		});
	};
};


UI.profile=function(profile){
	return new UIProfile(profile);
};


function UIProfile(profile){
	this.__profile=null;
	if (profile){
		this.__profile=profile;	
	}
	
	this.__body=[];
	this.__buttons=[];
	this.__layout={};
	
	this.body=function(rows){
		this.__body=rows;
		return this;
	};
	
	this.buttons=function(bts){
		this.__buttons=bts;
		return this;
	};
	
	
	this.show=function(opts){
		if (!opts){
			opts={};
		}
		
		opts=$.extend({}, {width: 640, id: AP.uuid()}, opts);
		
		AP.customDialog("<div id='"+opts.id+"' class='js-profile' style='width:"+opts.width+"px; min-height:600px;'><div class='ui-profile'>"+render(this)+"</div></div>").addClass("-full-canvas -full-blank").closable(false).show();
		$("#"+opts.id).data("profile", this);
		
		$("#"+opts.id+" .uip-buttons .btn").click(function(){
			var index=$(this).index();
			var $this=$(this).closest(".js-profile").data("profile");
			if (!$this || !$this.__buttons || $this.__buttons.length<=index){
				return;
			}
			
			var fn=$this.__buttons[index].action;
			fn.apply($this, [this]);
		});
		
		$("#"+opts.id+" .uip-close").click(function(){
			UI.profile().close(this);
		});
	};
	
	
	this.close=function(ref){
		AP.hideCustomDialog();
	};
	
	function render(obj){
		return getHeader(obj)+getBody(obj)+getButtons(obj);
	};
	
	
	function getHeader(obj){
		return "<div class='uip-close'><span class='-ap icon-close'></span></div>" +
		"<div class='uip-header'>" +
			"<div class='uip-image'><img src='"+obj.__profile.image+"'/></div>" +
			"<div class='uip-main'>" +
			"	<div class='uip-name'>"+obj.__profile.name+"</div>" +
			"	<div class='uip-subtitle'>"+obj.__profile.subtitle+"</div>" +
			"	<div class='uip-rows'>"+AP.render(obj.__profile.rows, function(e){
				return getRow(e);
			})+"</div>" +
			"</div>" +
		"</div>";
	};
	
	
	function getBody(obj){
		return "<div class='uip-body'>"+AP.render(obj.__body, function(e){
			return getRow(e);
		})+"</div>";
	};
	
	
	function getButtons(obj){
		return "<div class='uip-buttons'>"+AP.render(obj.__buttons, function(e){
			return "<div class='btn is-"+e.type+"'>"+e.name+"</div>";
		})+"</div>";
	};
	
	
	function getRow(e){
		return "<div class='uip-row'>" +
		"	<div class='uip-icon'><span class='ficon-"+e.icon+"'></span></div>" +
		"	<div class='uip-rn'>"+e.name+"</div>" +
		"	<div class='uip-rc'>"+e.value+"</div>" +
		"</div>";
	};
};


UI.icon=new function __UIIcon(){
	this.picker=function(input, options){
		var tagname=$(input).tagName();
		if (tagname=="div" || tagname=="span"){
			var ic=$(input).data("icon");
			if (!ic && options.value){
				ic=options.value;
			}
			
			renderIcon(input, ic, options.set);
		}
		
		$(input).click(function(){
			var $this=this;
			dialog(options.set, options.range, function(icon){
				if (options.endpoint){
					UI.ajaxShow();
					AP.post(options.endpoint, {icon_icon: icon.index, icon_type: 'icon', icon_set: icon.set}, function(code){
						UI.ajaxHide();
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						UI.flash("Update successfully");
						renderIcon($this, icon.index, icon.set);
					});
				}
			});
		});
	};

	
	/**
	 * @desc Render an icon within a set
	 */
	function renderIcon(ref, index, set){
		if (index===0 || index==="0"){
			index=1;
		}
		
		var image="<img src='"+(set)+"/"+(index)+".svg'/>";
		$(ref).html(image);
	};
	
	function dialog(base_url, limit, callback, opts){
		opts=$.extend({title: "Please pick an icon"}, opts);
		
		var title="";
		if (opts.title && opts.title.length){
			title="<div class='title'>"+opts.title+"</div>"; 
		}
		
		AP.customDialog(title+"<div class='list list-icons -border'></div>","custom-selection").style("-full icon-picker-list").width(620).show();
		
		
		for (var i=1; i<=limit; i++){
			var e={type: "icon", index: i, set: base_url};
			
			var icon="<div class='-icon'><img src='"+base_url+"/"+i+".svg'/></div>";			
			var html="<div class='li js-item unselectable' onclick='__selfaction(this);'>"+icon+"</div>";
			$(html).appendTo("#custom-selection .list-icons").data("action", callback).data("__params", e);
		}
		
		AP.dialog("#custom-selection").balance();
	};

};


var BaseTable=new function __BaseTable(){
	this.opts={};
	
	this.init=function(canvas, opts){
		opts=$.extend({}, {
			height: "auto",
			header: "fixed",
			footer: "normal",
			fixed_left: ".js-fl",
			fixed_right: ".js-fr",
			sorter: false,
			padding: 10,
			layout: 'table',
			max_rows: 100,
			events: true 
		}, opts);
		
		if (opts.layout=='table'){
			opts.selector={
				header: 'thead',
				body: 'tbody',
				cell: 'td',
				row: 'tr',
				header_cell: 'thead th',
			};
		}else{
			opts.selector={
				header: '.thead',
				body: '.tbody',
				cell: '.td',
				row: '.tr',
				header_cell: '.th',
			};
		}
		
		this.opts=opts;
		
		var $this=$(canvas);
		$this.addClass("js-basetable");
		
		if (opts.layout=="table"){
			$this.addClass("basetable");	
		}
		
		var $p=$this.parent();
		
		if (opts.events){
			$p.addClass("basetable-wrapper scroll-x scroll-y")
		}else{
			$p.addClass("basetable-wrapper")	
		}
		
		
		this.$fls=$this.find(".-fl");
		this.$frs=$this.find(".-fr");
		this.$fhs=null;
		
		var num_cols=$this.find(opts.selector.row).length;
		var auto_position=1;
		if (num_cols>opts.max_rows){
			auto_position=0;
		}
		
		if (mobile() || !opts.events){
			auto_position=false;
		}
		
		if (!auto_position){
			
		}else{
			$p.on("scroll", function(){
				if (mobile()){
					return;
				}
				
				BaseTable.$fhs=$this.find(opts.selector.header);
				
				var t=$p.scrollTop();
				var l=$p.scrollLeft();
				var cw=$p.width();
				
				BaseTable.$fhs.css("top", t);
				
				BaseTable.$fls.each(function(){
					$(this).css("left", l);
					if (l>10){
						$(this).addClass("-fls");
					}else{
						$(this).removeClass("-fls");
					}
				});
				
				BaseTable.$frs.each(function(){
					var ch=$(this).closest(opts.selector.row).height();
					var ew=$(this).width();				
					
					if (opts.layout=="table"){
						$(this).css({"left": cw-ew+l-11-opts.padding*2, height: ch});
					}else{
						$(this).css({"left": cw-ew+l-11-opts.padding*2, height: ch});	
					}
					
				});
			});
		}
		
		
		fixSize($p, opts);
		
		AP.html.resize(function(){
			fixSize($p, opts);
		});
		

		var ws=[];
		$this.find(opts.selector.header_cell).each(function(){
			var hw=$(this).data("width");
			$(this).css("width", hw).css("minWidth", hw).css("maxWidth", hw);
			
			if ($(this).data("search")){
				$(this).append("<div class='bth-wrapper'><div class='bth-search'><input type='text' placeholder='Filter'/></div></div>")
			}
			
			ws.push(hw);
		});
		
		$this.find(opts.selector.header_cell+".-fr").each(function(){
			$(this).css("height", $(this).closest(opts.selector.row).height()).css("marginTop", "1px");
		});
		
		
		var t;
		$this.find(""+(opts.selector.body)+" "+(opts.selector.row)+"").each(function(){
			$(this).addClass("__basetable_done");
			
			t=0;
			$(this).find(opts.selector.cell).each(function(){
				$(this).data("fl", t);
				t+=$(this).data("width");
			});
			
			$(this).find(opts.selector.cell).each(function(){
				var index=$(this).index();
				var width=ws[index];
				
				var flag=$(this).data("width");
				if (flag=="disabled"){
					return;
				}else if (flag!=undefined && AP.data.isInt(flag)){
					$(this).data("width", flag).css("width", flag).css("minWidth", flag).css("maxWidth", flag);
				}else{
					$(this).data("width", width).css("width", width).css("minWidth", width).css("maxWidth", width);	
				}
			});
		});
		
		if (opts.width=="auto"){
		}else{
		}
		
		resetTotalWidth($this);
		
		if (auto_position){
			setTimeout(function(){
				var cw=$p.width();
				BaseTable.$frs.each(function(){
					var ew=$(this).width();
					$(this).css({"left": cw-ew+$p.scrollLeft()-11-opts.padding*2});
				});
			},100);
		}else{
			setTimeout(function(){
				$p.trigger("scroll");
				
				BaseTable.$frs.each(function(){
					$(this).css({right: 0});
				});
			}, 100);
		}
		
		// $p.trigger("scroll");
		
		if (opts.sorter){
			$this.tablesorter({
				sortInitialOrder: "desc"
			});
		}
	};
	
	
	this.balance=function(){
		$(window).resize();
		
		setTimeout(function(){
			$(window).resize();	
		},200);
		
		setTimeout(function(){
			$(window).resize();	
		},500);
	};
	
	
	/**
	 * @desc Set column width
	 */
	this.setColWidth=function($col, width){
		var index=$col.index();
		$col.css({width: width, minWidth: width, maxWidth: width}).data("width", width);
		
		var $table=$col.closest(".js-basetable");
		$table.find(BaseTable.opts.selector.body+" "+BaseTable.opts.selector.row).each(function(){
			$(this).find(BaseTable.opts.selector.cell+":nth-child("+(index+1)+")").data("width", width).css({width: width, minWidth: width, maxWidth: width});
		});
		
		
		resetTotalWidth($col.closest(".js-basetable"));
	};
	
	
	/**
	 * @desc Update a collection of rows (when data changed)
	 */
	this.onUpdate=function(row){
		var t;
		var $p=$(row).closest(".basetable-wrapper");
		var $canvas=$(row).closest(".js-basetable");
		
		
		this.$fls=$canvas.find(".-fl");
		this.$frs=$canvas.find(".-fr");
		
		
		$(row).each(function(){
			if ($(this).hasClass("__basetable_done")){
				return;
			}
			
			$(this).find(BaseTable.opts.selector.cell).each(function(){
				var index=$(this).index();
				var width=$canvas.find(BaseTable.opts.selector.header_cell+":eq("+index+")").data("width");
				$(this).data("width", width).css("width", width).css("minWidth", width);
			});
			
			
			t=$p.scrollTop();
			var l=$p.scrollLeft();
			
			$(this).find(BaseTable.opts.selector.header).css("top", t);
			
			$(this).find(".-fl").each(function(){
				$(this).css("left", l);
				if (l>10){
					$(this).addClass("-fls");
				}else{
					$(this).removeClass("-fls");
				}
			});
			
			$(this).find(".-fr").each(function(){
				$(this).css("left", $p.width()-$(this).width()+l-11-BaseTable.opts.padding*2);
			});
		});
	};
	
	
	/**
	 * @desc Alias
	 */
	this.update=this.onUpdate;
	
	
	function fixSize($p, opts){
		if (opts.width && opts.width=="auto"){
			
		}else{
			$p.css("width", $p.parent().width());	
		}
		
		if (opts.height && opts.height=="auto"){
		}else{
			if (opts.height && AP.data.isFunction(opts.height)){
				$p.css("height", opts.height($p));
			}else{
				$p.css("height", $(window).height()-90);	
			}	
		}
	};
	
	
	
	function resetTotalWidth($this){
		var total_width=0;
		$this.find(BaseTable.opts.selector.header_cell).each(function(){
			total_width+=$(this).data("width");
		});
		
		if (BaseTable.opts.selector.layout!="table"){
			$this.css("width", total_width+1);
		}else{
			$this.css("width", t).addClass("xo");	
		}
	};
};


var UIPag = new function __UIPagination() {
	this.callback_fn = null;
	this.contPaginate = function (canvas, url, last_id, per_page, loaded_items, callback) {
		this.callback_fn = callback;

		if (!url) {
			url = Client.path.current;
			var cpath = Client.path.full.join("/");
			var cqs = "";

			var qs = Query.all();
			for (var key in qs) {
				if (key == "env" || key == "last_id") {
					continue;
				}
				cqs += key + "=" + qs[key] + "&";
			}

			if (cqs.length) {
				cqs = cqs.substr(0, cqs.length - 1);
			}

			if (cpath.indexOf("?") == -1) {
				url = cpath + "?" + cqs;
			} else {
				url = cpath + "&" + cqs;
			}
		}
		
		$.log(url);

		var load_more_url = url;

		var more_class = "-more";
		if (loaded_items < per_page) {
			more_class = "";
			return;
		}


		var html = "<div class='icons pointer "+(more_class)+"' data-url='"+(load_more_url)+"' data-last_id='"+(last_id)+"' data-per_page='"+(per_page)+"'><div class='label box-main-edge'>Load more</div></div>";

		$(canvas).addClass("apppages").html(html);

		$(canvas).find('.-more').click(function() {
			AP.post($(this).data('url'), {last_id: $(this).data('last_id'), per_page: $(this).data('per_page')}, function(code) {
				if (!code.good()) {
					return AP.alertError(code.message);
				}

				if (UIPag.callback_fn) {
					return UIPag.callback_fn(code.data);
				};
			}, function (err) {
				$.log(err);
			});
		});
	};
};


UI._editor = function(opts){
	opts=$.extend({}, {action:"init", toolbar: 1, position: "top", value: "", height: null}, opts);
	
	if (!opts.elem){
		console.error("opts.elem NOT SET");
		return;
	}
	
	if (opts.action=="init"){
		UI.editor(opts.elem, {
			position: opts.position,
			value: opts.value,
			toolbar: opts.toolbar,
			height: opts.height,
			maxHeight: opts.maxHeight
		});
	}
};


function ActionManager(opts){
	if (!opts){
		opts={};
	}
	this.opts=$.extend({icon: true}, opts);
	this.actions=[];
	
	this.add=function(action, extra){
		if (extra && AP.data.isString(action)){
			return this.add({label: action, url: extra});
		}
		
		if (AP.data.isObject(action)){
			if (action instanceof ActionManager){
				this.add("---");
				for (var i=0; i<action.actions.length; i++){
					this.add(action.actions[i]);
				}
				
				return this;
			}
			
			if ('acl' in action && !action.acl){
				return this;
			}
		}
		
		if (AP.data.isObject(action) && 'am' in action){
			action.type = 'am';
		}
		
		var last = null;
		if (this.actions.length){
			last = this.actions[this.actions.length-1];
		}
			
		if (!last || last=="sep" || last=="---"){
			if (action=="sep" || action=="---"){
				return this;
			}	
		}
		
		
		this.actions.push(action);
		
		return this;
	};
	
	this.exclude = function(action){
		this.actions = ARR.filter(this.actions, function(e){
			if (!e.url || e.url.indexOf(action)!=-1){
				return false;
			}
			
			return true;
		});
		
		return this;
	};
	
	this.inline=function(){
		return AP.render(this.actions, function(action){
			if (action=="sep" || action=="---"){
				return "<div class='-item-sep'></div>";
			}
			
			if (action.type && action.type == 'am' && action.am){
				var align = 'left';
				if ('align' in action){
					align = action.align;
				}else if ('align' in action.am.opts){
					align = action.am.opts.align;
				}
				
				return "<div class='-item -submenu -"+(align)+"'> "+(action.label)+" <div class='submenu'> "+(action.am.inline())+" </div> </div>";
			}

			var ec="";
			if (action.style){
				ec=" "+action.style;
			}
			
			var blank = '';
			if (action.blank || action.target=='blank'){
				blank=" data-blank='1' ";
			}

			var extra_data='';
			if (action.data){
				for (var key in action.data){
					if (AP.data.isString(action.data[key]) || AP.data.isInt(action.data[key])){
						extra_data+=" data-"+(key)+"='"+(action.data[key])+"'";	
					}
				}
			}

			var icon = '';
			if (action.icon){
				icon = "  " +Render.render('icon', {_class: "-cmenu-icon" , icon:action.icon}, '')+ '';
				ec+=' -with-icon';
			}
			
			if (action.embed) {
				return "<div class='-item url"+(ec)+"' "+(blank)+" "+(extra_data)+" title='"+(action.label)+"' "+(action.url)+">"+(icon)+""+(action.label)+"</div>";
			}
			
			return "<div class='-item url"+(ec)+" ap-xdot' data-url='"+(action.url)+"' "+(blank)+" "+(extra_data)+" title='"+(action.label)+"'>"+(icon)+""+(action.label)+"</div>";
		});
	};
	
	this.context=function(){
		return this.actions;
	};
	
	this.length=function(){
		return this.actions.length;
	};
	
	this.getURL = function(key){
		for (var i=0; i<this.actions.length; i++){
			var action=this.actions[i];
			if (action.url && action.url.indexOf(key)!=-1){
				return action.url;
			}
		}
		
		return "";
	};
	
	this.getAction = function(key){
		for (var i=0; i<this.actions.length; i++){
			var action=this.actions[i];
			if (action.url && action.url.indexOf(key)!=-1){
				return "<div class='-item url' data-url='"+(action.url)+"'>"+(action.label)+"</div>";
			}
		}
		
		return "";
	};
	
	
	this.release = function(){
		return this.actions;
	};
	
	
	/**
	 * @desc Show in dialog
	 */
	this.dialog = function(opts){
		var actions = AP.select(ARR.deepClone(this.actions), function(e){
			if (e == "---"){
				return null;
			}
			
			e.icon = $.trim("  " +Render.render('icon', {icon:e.icon}, '')+ '');
			return e;
		});
		
		AP.actionMenu(actions);
	};
	
	this.text=this.inline;
};


ActionManager.init = function(){
	return new ActionManager();
};
UI.file=new function __UIFile(){
	this.ext=function(file){
		var ext="unknown";
		
		if (!file){
			return ext;
		}
		
		data=file.split(".");
		
		if (!data.length){
			return ext;
		}
		
		// return data[data.length-1].toLowerCase();
		return AP.fileExt(file);
	}
	
	this.icon=function(file){
		var ext="text2";
		
		if (!file){
			return ext;
		}
		
		data=file.split(".");
		var fext="";
		
		if (!data.length){
			return ext;
		}
		fext=data[data.length-1]; 
		fext=fext.toLowerCase();
		if (fext=="jpeg"){
			fext="jpg";
		}

		if (fext == "xls" || fext == "xlsx" || fext == "gsheet" || fext == "xlsm") {
			ext = "excel";
		} else if (fext == "gif" || fext == "png" || fext == "jpg" || fext == "ai" || fext == "svg" || fext == "psd" || fext == "jpeg") {
			ext = fext;
		} else if (fext == "doc" || fext == "docx" || fext == "gdoc") {
			ext = "word";
		} else if (fext == "ppt" || fext == "pptx" || fext == "gslides") {
			ext = "ppt";
		} else if (fext == "pdf") {
			ext = "pdf";
		} else if (fext == "zip") {
			ext = "zip";
		}
		

		/*
		if (["mp4","avi", "css", "csv", "fla", "svg", "eps", "js", "xml", "html", "json"].indexOf(fext)!=-1){
			return fext;
		}
		*/
		return ext;
	};
	
	
	
	this.fontIcon=function(file){
		var ext="libreoffice";
		
		if (!file){
			return ext;
		}
		
		data=file.split(".");
		var fext="";
		
		if (!data.length){
			return ext;
		}
		fext=data[data.length-1]; 
		fext=fext.toLowerCase();
		if (fext=="jpeg"){
			fext="jpg";
		}
		
		if (fext=="xls" || fext=="xlsx" || fext=="gsheet"){
			ext="file-excel";
		}else if (fext=="gif" || fext=="png" || fext=="jpg" || fext=="psd" || fext=="svg" || fext=="ai" || fext=="jpeg"){
			ext="file-picture";
		}else if (fext=="doc" || fext=="docx" || fext=="gdoc"){
			ext="file-word";
		}else if (fext=="ppt" || fext=="pptx" || fext=="gslides"){
			ext="file-play";
		}else if (fext=="pdf"){
			ext="file-pdf";
		}else if (fext=="zip"){
			ext="file-zip";
		}
		
		return ext;
	};
	
	this.ficon=this.fontIcon;
	
	this.color=function(ext){
		if (ext=='excel'){
			return "3";
		}
		
		if (ext=='ppt'){
			return "2";
		}
		
		if (ext=='word'){
			return "8";
		}
		
		if (ext=='pdf' || ext=='pdfx'){
			return "5";
		}
		
		if (ext=='gif' || ext=='png' || ext=='jpg' || ext=="picture" || ext=="jpeg"){
			return "7";
		}
		
		return 2;
	};
	
	this.kb=function(size){
		var kb=Math.floor(size/1024);
		if (kb==0){
			return size+" B";
		}
		
		if (kb<1000){
			return kb+" KB";
		}
		
		return (kb/1024).toFixed(2)+" MB";
	};
	
	
	this.iconColor=function(icon){		
		if (icon=="pdf" || icon=="file-pdf"){
			return "#e73035";
		}
		
		if (icon=="xls" || icon=="xlsx" || icon=="file-xls" || icon=="file-xlsx" || icon=="file-excel"){
			return "#41b433";
		}
		
		if (icon=="ppt" || icon=="pptx" || icon=="file-ppt" || icon=="file-pptx" || icon=="file-play"){
			return "#d45a18";
		}
		
		
		if (icon=="doc" || icon=="docx" || icon=="file-doc" || icon=="file-docx" || icon=="file-word" || icon=="file-office"){
			return "#0662b0";
		}
		
		if (icon=="png" || icon=="jpg" || icon=="jpeg" || icon=="file-png" || icon=="file-jpg"){
			return "#f49402";
		}
		
		return "#666";
	};
	
	
	
	/**
	 * @desc Get HTML of a list of files
	 */
	this.list=function(files, opts){
		return AP.render(files, function(e){
			var icon=UI.file.icon(e.fid);
			
			var actions="<span class='file-actions'> <span class='file-action js-file-preview url' title='Xem trÆ°á»›c' data-fid='"+(e.id)+"' data-url=':file' data-file='"+(e.url)+"'>Preview</span> <a class='file-action' title='Download file' target='_blank' href='"+(Base.file.download(e.name, e.fid))+"'>Download</a> <span class='file-action js-file-remove' title='Delete' data-fid='"+(e.id)+"'>Remove</span> </span>";
			
			return "<div class='file -file pointer'> <span class='file-icon'><img src='"+(Client.share_url)+"/mimex/"+(icon)+".png'/></span> <span class='file-name' data-file='"+(e.url)+"'>"+(e.name)+"</span> <span class='file-info'>"+(UI.file.kb(e.size))+" &middot; Uploaded "+(AP.time.ago(e.since))+" by @"+(e.username)+"</span> "+(actions)+" </div>";
		})
	};
	
	
	/**
	 * @desc Get HTML of a list of files
	 */
	this.listCompact=function(files, opts){
		return AP.render(files, function(e){
			var icon=UI.file.ext(e.fid);
			
			return "<div class='file -file pointer url' data-fid='"+(e.id)+"' data-url=':file' data-file='"+(e.url)+"'> <span class='file-icon'><img src='"+(Client.share_url)+"/m4/"+(icon)+".svg'/></span> <span class='file-name ap-xdot'>"+(e.name)+"</span> </div>";
		})
	};
};UI.reorder=function(data, endpoint){
	return (new UIFloatRearrangements(data, endpoint)).show();
};



UI.selection=function(data, endpoint){
	return (new UIFloatSelections(data, endpoint)).show();
};




function UIFloatSelections(data, endpoint){
	this.canvas="#float-opts";
	this.box="#float-box";
	
	
	this.show=function(){
		build_html(data);
		return this;
	};
	
	this.callback=function(callback){
		$(this.canvas).data("callback", callback);
	};
	
	function build_html(data){
		var options=data;		
		var html=get_options_html(options);
		var mh=$(window).height()-250;
		if (mh<500){
			mh=500;
		}
		html="<div style='max-height:"+mh+"px; overflow-y:auto;'>"+html+"</div>";
		
		html+="<div class='back pointer' onclick='ui_options_hide(this);'><span class='icon -ap icon-arrow-left2'></span> OK</div>";
		
		html="<div id='float-box'>"+html+"</div>";
		
		var dx=AP.dialog("#float-opts")
		.engine(FormDialogEngine)
		.closable()
		.style("float-opts")
		.width(600)
		.title("Please select")
		.content(html)
		.show()
		;
		
		$("#float-opts").data('endpoint', endpoint);
		
		return dx;
	};
	
	
	function get_options_html(options){
		var html="";
		for (var i=0; i<options.length; i++){
			var opt=options[i];
			
			var icon="<span class='-ap icon-square-uncheck ap-f24 text-9'></span>";
			if (parseInt(opt.selected)){
				icon="<span class='-ap icon-square-check ap-f24 text-success selected'></span>";
			}
			html+="<div class='opt with-icon' data-value='"+opt.id+"'>" +
				"<div class='updown pointer' style='top:15px;' onclick='ui_options_pick(this)'>"+icon+"</div>"+
				"<div class='label'>"+opt.label+"</div>" +
				(opt.sublabel?"<div class='sublabel'>"+opt.sublabel+"</div>":"") +
			"</div>";
		};
		
		return html;
	};
	
	
};



function UIFloatRearrangements(data, endpoint){
	this.canvas="#float-opts";
	this.box="#float-box";
	
	
	this.show=function(){
		build_html(data);
		return this;
	};
	
	this.callback=function(callback){
		$(this.canvas).data("callback", callback);
	};
	
	function build_html(data){
		var options=data;		
		var html=get_options_html(options);
		var mh=$(window).height()-250;
		if (mh<500){
			mh=500;
		}
		html="<div style='max-height:"+mh+"px; overflow-y:auto;'>"+html+"</div>";
		
		html+="<div class='back pointer' onclick='ui_options_hide(this);'><span class='icon -ap icon-arrow-left2'></span> OK</div>";
		
		html="<div id='float-box'>"+html+"</div>";
		
		var dx=AP.dialog("#float-opts")
		.engine(FormDialogEngine)
		.closable()
		.style("float-opts")
		.width(600)
		.title("Please select")
		.content(html)
		.show()
		;
		
		$("#float-opts").data('endpoint', endpoint);
		
		return dx;
	};
	
	
	function get_options_html(options){
		var html="";
		for (var i=0; i<options.length; i++){
			var opt=options[i];
			
			html+="<div class='opt with-icon' data-value='"+opt.id+"'>" +
				"<div class='updown'><div class='up' onclick='ui_arrange_move(this, -1);'><span class='ficon-caret-up'></span></div> <div class='down' onclick='ui_arrange_move(this, 1);'><span class='ficon-caret-down'></span></div> </div>"+
				"<div class='label'>"+opt.label+"</div>" +
				(opt.sublabel?"<div class='sublabel'>"+opt.sublabel+"</div>":"") +
			"</div>";
		};
		
		return html;
	};
	
	
};



function ui_arrange_move(ref, order){
	var $elem=$(ref).closest('.opt');
	if (!$elem.length){
		return;
	}
	
	var val=$elem.data("value");
	var url=$("#float-opts").data("endpoint");
	var callback=$("#float-opts").data("callback");
	
	if (order==-1){
		var $prev=$elem.prev('.opt');
		if (!$prev.length){
			return;
		}
		
		$elem.slideUp(400, function(){
			$(this).insertBefore($prev).slideDown(400);
		});
		
		ui_arrange_save(url, val, -1, callback);
	}else if (order==1){
		var $next=$elem.next('.opt');
		if (!$next.length){
			return;
		}
		
		$elem.slideUp(400, function(){
			$(this).insertAfter($next).slideDown(400);
		});
		
		ui_arrange_save(url, val, 1, callback);
	};
};


function ui_arrange_save(url, val, ord, callback){
	UI.ajaxShow();
	AP.post(url, {id: val, order: ord}, function(code){
		UI.ajaxHide();
		if (!code.good()){
			return AP.alertError("Oops .. something wrong. The last action was not saved.");
		}
		
		callback(val, ord, code);
	});
};


function ui_options_pick(ref, order){
	var $elem=$(ref).closest('.opt');
	if (!$elem.length){
		return;
	}
	
	var selected=$elem.find(".selected").length;
	var value=0;
	
	if (selected){
		value=0;
	}else{
		value=1;
	}
	
	
	var url=$("#float-opts").data("endpoint");
	var name=$elem.data("value");
	var callback=$("#float-opts").data("callback");
	
	UI.ajaxShow();
	AP.post(url, {id: name, value: value}, function(code){
		UI.ajaxHide();
		if (!code.good()){
			return AP.alertError("Oops .. something wrong. The last action was not saved.");
		}
		
		if (value==0){
			$elem.find(".updown").html("<span class='-ap icon-square-uncheck ap-f24 text-9'></span>");
		}else{
			$elem.find(".updown").html("<span class='-ap icon-square-check ap-f24 text-success'></span>");
		}
		
		callback(name, value, code);
	});
}UI.percent=new function __UIPercent(){
	this.colors=["FF6666","D57766","AA8866","55AA66","2BBB66","00CC66"];
	
	this.text=function(percent){
		var p=parseInt(percent);
		var c=getColor(p);
		return "<span style='color:#"+c+"'>"+percent+"%</span>";
	};
	
	
	this.box=function(percent){
		var p=parseInt(percent);
		var c=getColor(p);		
		return "<div class='-pbox' style='background-color:#"+c+"'><em>"+percent+"<span class='symbol'>%</span></em></div>";
	};
	
	this.color=function(p){
		return getColor(parseInt(p));
	};
	
	function getColor(p){
		var c=UI.percent.colors[0];
		
		if (p>=100){
			c=UI.percent.colors[6];
		}else if (p>=80){
			c=UI.percent.colors[5];
		}else if (p>=60){
			c=UI.percent.colors[4];
		}else if (p>=40){
			c=UI.percent.colors[3];
		}else if (p>=20){
			c=UI.percent.colors[2];
		}else if (p>=10){
			c=UI.percent.colors[1];
		}else{
			c=UI.percent.colors[0];
		}
		
		return c;
	};
};



UI.countdown=function(canvas){
	setInterval(function(){
		var collection=[];
		$(canvas).each(function(){
			var timer=$(this).data("timer");
			var alarm=$(this).data("alarm");
			if (!alarm){
				alarm=3600;
			}
			
			collection.push({timer: parseInt(timer), elem: $(this), alarm: parseInt(alarm)})
		});
		
		var time=AP.time.now();
		for (var i=0; i<collection.length; i++){
			var item=collection[i];
			var rem=item.timer-time;
			if (rem<0){
				item.elem.html("00:00:00").addClass('red');
			}else{
				var s=rem%60;
				var m=((rem-s)/60)%60;
				var h=Math.floor(rem/3600);
				var d=Math.floor(h/24);
				h=h%24;
				
				if (d==0){
					if (rem < item.alarm){
						item.elem.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s)).addClass("red").addClass("anim-showhide-inf");
					}else{
						item.elem.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
					}
						
				}else{
					item.elem.html(AP.data.zeroPrefix(d)+"d "+AP.data.zeroPrefix(h)+"h");
				}
			}
		}
	},500);
};




UI.liveCountdown=function(selector_string, show_full, format){
	function getFormatedString(format, d, h, m, s){
		return format.replace("%d", d).replace("%h", h).replace("%m", m).replace("%s", s);
	};
	
	AP.rtimeout(function(){
		var time=AP.time.now();
		$(selector_string).each(function(){
			var $item=$(this);
			var is_smart=$item.data("smart");
			var timer=parseInt($item.data('timer'));
			var ended=$item.data("ended");
			if (!ended){
				ended="00:00:00";
			}
			
			var rem=timer-time;
			
			if (rem<0){
				$item.html(ended).addClass('red').addClass("-ended");
			}else{
				var s=rem%60;
				var m=((rem-s)/60)%60;
				var h=Math.floor(rem/3600);
				var d=Math.floor(h/24);
				h=h%24;
				
				if (is_smart){
					if (d==0 || d==1){
						if (h==0 && d==0){
							$item.html("00:"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
							if (!$item.hasClass("red")){
								$item.addClass("red").addClass("anim-showhide-inf");
							}
						}else{
							h=h+d*24;
							$item.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
						}
					}else{
						$item.html(AP.time.time("%M %d", timer));
					}
				}else{
					if (d==0){
						if (h==0){
							$item.html("00:"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
							if (!$item.hasClass("red")){
								$item.addClass("red").addClass("anim-showhide-inf");
							}
						}else{
							$item.html(AP.data.zeroPrefix(h)+":"+AP.data.zeroPrefix(m)+":"+AP.data.zeroPrefix(s));
						}
					}else{
						if (show_full){
							if (format){
								$item.html(getFormatedString(format, AP.data.zeroPrefix(d), AP.data.zeroPrefix(h), AP.data.zeroPrefix(m), AP.data.zeroPrefix(s)));
							}else{
								$item.html(AP.data.zeroPrefix(d)+"d "+AP.data.zeroPrefix(h)+"h"+" "+AP.data.zeroPrefix(m)+"m "+AP.data.zeroPrefix(s)+"s");	
							}
						}else{
							$item.html(AP.data.zeroPrefix(d)+"d "+AP.data.zeroPrefix(h)+"h");	
						}
					}
				}
			}
		});
	},1000);
};


UI.pageCountdown=function(selector_string, show_full){
	return UI.liveCountdown(selector_string, show_full);
};


UI.listToUsernames=function(users){
	if (!users.length){
		return "";
	}
	return AP.render(users, function(u, index, total){
		if (total<=1){
			return "@<b class='url username'>"+u.username+"</b>";
		}else{
			if (index==total-1){
				return "and @<b>"+u.username+"</b>";
			}else if (index<total-2){
				return "@<b class='url username'>"+u.username+"</b>, ";
			}else{
				return "@<b class='url username'>"+u.username+"</b> ";
			}
		}
	});
};


UI.objectsToUsernames=function(users, pattern){
	if (!users || !users.length){
		return "";
	}
	
	return AP.word.join(users, " ",function(u){
		if (AP.data.isString(u)){
			if (!pattern){
				return "@"+u;	
			}else{
				return pattern.replace("$",u);
			}
		}else{
			if (!pattern){
				return "@"+u.username;
			}else{
				return pattern.replace("$",u.username);
			}
		}
	});
};



UI.prettyNames=function(users){
	if (!users.length){
		return "";
	}
	return AP.render(users, function(u, index, total){
		if (total<=1){
			return "@<b class='url username'>"+u+"</b>";
		}else{
			if (index==total-1){
				return "and @<b>"+u+"</b>";
			}else if (index<total-2){
				return "@<b class='url username'>"+u+"</b>, ";
			}else{
				return "@<b class='url username'>"+u+"</b> ";
			}
		}
	});
};


UI.users=function(users, size){
	if (!size){
		size=32;
	}
	return AP.render(users, function(u){
		return "<div data-username='"+u.username+"' class='url avatar avatar-"+size+" rounded'><div class='image'><img src='"+u.gavatar+"'/></div></div>";
	});
};








UI.popUsers=function(url){
	return new PUsers(url);
};



function PUsers(url){
	this.__url=url;
	this.__data={};
	this.__render=null;
	this.__title="";
	this.__title2="";
	
	this.title=function(t1, t2){
		this.__title=t1;
		this.__title2=t2;
		return this;
	}
	
	this.data=function(data){
		this.__data=data;
		return this;
	};
	
	this.render=function(render){
		this.__render=render;
		return this;
	};
	
	this.show=function(){
		var $this=this;
		AP.post(this.__url,this.__data, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			var html=AP.render(code.users, function(u){
				return $this.__render(u);
			});
			
			html="<div class='list users-list'>"+html+"</div>";
			
			// Float dialog
			
			AP.dialog("users-dialog")
			.engine(FormDialogEngine2)
			.width(600)
			.title("<div class='title-1'>"+$this.__title+"</div><div class='title-2'>"+$this.__title2+"</div>")
			.content(html)
			.style("fs")
			.show();
			
			
		});
	};
};














UI.optionscb=null;

UI.options=function(data, callback){
	UI.optionscb=callback;
	return (new UIFloatOptions(data, callback));
};


function UIFloatOptions(data, callback){
	this.canvas="#float-opts";
	this.box="#float-box";
	$(this.canvas).data('callback', callback);
	
	this.show=function(){
		build_html(data);
		$(this.box+" .other .input-type-date").selectDate();
		$(this.box+" .other .input-type-time").selectTime({align: 'bottom'});
		return this;
	};
	
	
	function build_html(data){
		var options=data.options;
		var other=data.other;
		
		var html=get_options_html(options);
		if (other){
			html+=get_other_html(other);
		}
		
		if (data.back){
			html+="<div class='back pointer' onclick='ui_options_hide(this);'><span class='icon ficon-angle-left'></span> Back</div>";
		}
		
		html="<div id='float-box'>"+html+"</div>";
		
		var dx=AP.dialog("#float-opts")
		.engine(FormDialogEngine)
		.style("float-opts")
		.width(data.width)
		.title("Please select")
		.content(html)
		.show();
		
		$("#float-opts").data("options", options);
		
		return dx;
	};
	
	
	function get_options_html(options){
		var html="";
		for (var i=0; i<options.length; i++){
			var opt=options[i];
			
			html+="<div class='opt pointer"+(opt.icon?" with-icon":"")+"' onclick='ui_options_select(this);' data-value='"+opt.value+"'>" +
				(opt.icon?"<div class='icon'><div class='"+opt.icon+"'></div></div>":"") +
				"<div class='label'>"+opt.label+"</div>" +
				"<div class='ir'><span class='ficon-angle-right'></span></div>"+
				(opt.sublabel?"<div class='sublabel'>"+opt.sublabel+"</div>":"") +
			"</div>";
		};
		
		return html;
	};
	
	function get_other_html(other){
		var inputs="";
		for (var i=0; i<other.inputs.length; i++){
			var input=other.inputs[i];
			var w=Math.floor(80/other.inputs.length);
			inputs+="<div class='input left relative' style='width:"+w+"%'><div class='inputw'><input type='text' name='"+input.name+"' class='std input-type-"+input.type+"' placeholder='"+input.placeholder+"'/></div></div>";
		}
		
		inputs="<div class='inputs'>"+inputs+" <div class='ok right button button-edge success' onclick='ui_options_select_extra(this);'>OK</div> <div class='clear'></div></div>";
		
		var html="<div class='other opt'>" +
			"<div class='label'>"+other.label+"</div>" +
			inputs+
		"</div>";
		
		return html;
	};
};

function ui_options_hide(ref){
	AP.dialog("#float-opts").hide();
};

function ui_options_select(ref){
	var val=$(ref).data("value");
	var options=$("#float-opts").data("options");
	AP.dialog("#float-opts").hide();
	
	for (var i=0; i<options.length; i++){
		if (options[i].value==val){
			ui_options_callback(options[i], null);
			return;
		}
	}
};


function ui_options_select_extra(ref){
	var data={};
	AP.dialog("#float-opts").hide();
	$("#float-opts .other input").each(function(){
		var name=$(this).attr('name');
		var val=$(this).val();
		data[name]=val;
	});
	
	ui_options_callback({value: "other", "label":"Other", data: data});
};


function ui_options_callback(data){
	var callback=UI.optionscb;

	if (callback){
		callback(data);
	};
};







UI.user=new function __UIUser(){
	this.list=function(title, users){
		var html=AP.render(users, function(u){
			return simple(u);
		});
		
		var mh=$(window).height()-200;
		if (mh<200){
			mh=200;
		}
		
		html="<div class='title'>"+title+"<div class='-close' onclick='AP.closeDialog(this);'></div></div>" +
				"<div class='rh' style='max-height:"+mh+"px; overflow-y:auto;'><div class='list list-actions with-image -border'>"+html+"</div></div>";
		
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();
		$("#custom-selection").addClass("__canvas");
	};
	
	
	this.listCompact=function(users, opts){
		opts=$.extend({}, {limit: 0}, opts);
		
		var html=AP.render(users, function(uid, index){
			if (opts.limit && index>=opts.limit){
				return "";
			}
			
			var u;
			
			if (AP.data.isObject(uid)){
				u=People.get(uid.username);
				if (!u.id || u.error){
					return "";
				}	
			}else{
				u=People.get(uid);
			}
			
			
			return "<div class='user url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <div class='avatar avatar-32'><img src='"+(AP.thumb(u.gavatar))+"'></div> <div class='name'>"+(u.name)+"</div> <div class='info'>"+(u.title)+"&nbsp;</div> </div>";
		});
		
		if (opts.limit && users.length>opts.limit){
			html+="<div class='more'>+"+(users.length-opts.limit)+"</div>";
		}
		
		return html;
	};
	
	
	
	this.listAvatars=function(users, opts){
		opts=$.extend({}, {limit: 0}, opts);
		
		var html=AP.render(users, function(uid, index){
			if (opts.limit && index>=opts.limit){
				return "";
			}
			
			var u;
			
			if (AP.data.isObject(uid)){
				u=People.get(uid.username);
				if (!u.id || u.error){
					return "";
				}	
			}else{
				u=People.get(uid);
			}
			
			
			return "<div class='user url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <div class='avatar avatar-32'><img src='"+(AP.thumb(u.gavatar))+"'></div> </div>";
		});
		
		if (opts.limit && users.length>opts.limit){
			html+="<div class='more'>+"+(users.length-opts.limit)+"</div>";
		}
		
		return html;
	};
	
	
	
	/**
	 * @desc User pickers, from dialogs
	 */
	this.picker=function(opts){
		opts=$.extend({multi: 1, ignore_me: 0}, opts);
		if (!opts.multi){
			opts.multi=0;
		}else{
			opts.multi=1;
		}
		
		Online.reorder(Client.people);
		var html=AP.render(Client.people, function(u){
			if (opts.ignore_me && parseInt(u.id)==parseInt(Client.viewer.id)){
				return "";
			}
			return render(u, opts.multi);
		});
		
		var mh=$(window).height()-270;
		if (mh<200){
			mh=200;
		}
		
		html="<div class='title'>"+(opts.title)+" <div class='-close' onclick='AP.closeDialog(this);'></div> </div> <div class='isearch'><input type='text' id='float-people-filter-ip' placeholder='Nháº­p vĂ o Ä‘Ă¢y Ä‘á»ƒ lá»c nhanh ngÆ°á»i Ä‘Æ°á»£c giao'/></div> <div class='rh' style='max-height:"+(mh)+"px; min-height:150px; overflow-y:auto;'> <div class='list list-actions with-image -border'>"+(html)+"</div> </div>";
		
		if (opts.multi){
			html+="<div class='buttons -two'> <div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this);'>Cancel</div> <div class='button -second -success -rounded' onclick='__pickUserCallback(this); AP.closeDialog(this);'>OK</div> </div>";	
		}
		
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();
		
		$("#custom-selection").data("callback", opts.callback).addClass("__canvas");
		
		$("#float-people-filter-ip").autofocus().on("input", function(){
			var q=$(this).val();
			UI.user.filter(q);
		});
	};
	
	
	this.pick=function(title, callback, ignore_me){
		Online.reorder(Client.people);
		var html=AP.render(Client.people, function(u){
			if (ignore_me && parseInt(u.id)==parseInt(Client.viewer.id)){
				return "";
			}
			return render(u);
		});
		
		var mh=$(window).height()-270;
		if (mh<200){
			mh=200;
		}
		
		html="<div class='title'>"+title+"<div class='-close' onclick='AP.closeDialog(this);'></div></div>" +
				"<div class='isearch'><input type='text' id='float-people-filter-ip' placeholder='Nháº­p vĂ o Ä‘Ă¢y Ä‘á»ƒ lá»c nhanh ngÆ°á»i Ä‘Æ°á»£c giao'/></div>" +
				"<div class='rh' style='max-height:"+mh+"px; min-height:150px; overflow-y:auto;'><div class='list list-actions with-image -border'>"+html+"</div></div>";
		
		html+="<div class='buttons -two'> <div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this);'>Há»§y</div> <div class='button -second -success -rounded' onclick='__pickUserCallback(this); AP.closeDialog(this);'>OK</div> </div>";
		
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();
		
		$("#custom-selection").data("callback", callback).addClass("__canvas");
		
		$("#float-people-filter-ip").autofocus().on("input", function(){
			var q=$(this).val();
			UI.user.filter(q);
		});
	};
	
	
	
	
	this.menu=function(ref, username){
		var user=People.get(username);
		if (AP.data.isInt(username)){
			user=People.getID(username);
		}
		
		var profile=null;
		
		if (user){
			profile={type: 'html', html:"<div class='-profile -with-image' data-uid='"+user.id+"'><div class='avatar avatar-40 -rounded'><div class='image url' data-url=':zoom' data-image='"+user.gavatar+"'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div>" +
				"<div class='-text'>" +
					"<p class='-big'>"+user.name+"</p>" +
					"<p class='ap-xdot'>@"+user.username+" &middot; "+___(user.title, "<i>No official title</i>")+"</p>" +
					"<p>"+___(user.phone, "<i>Phone number was not provided</i>")+"</p>" +
				"</div>"+
			"</div>"};	
		}else{
			return "";
		}
		
		var menu_items=[
			profile,
			{label: 'View profile', 'icon': 'icon-forward icm', action: function(){
				if (Client.local_profile){
					AP.toURL("~"+username);
				}else{
					AP.toURL(Base.domain("account")+"/user/"+username)	
				}
   				
   			}},
			{label: 'Chat with <b>'+user.name+'</b>', 'icon': 'icon-comment icm', action: function(){
				Base.message.peer(user.id, {'from': 'context'});
				Context.hide();
			}}
		];	
		
		if (username==Client.viewer.username){
			menu_items= [
				profile,
				{label: 'View my profile', 'icon': 'icon-forward icm', action: function(){
					if (Client.local_profile){
						AP.toURL("profile");
					}else{
						AP.toURL(Base.domain("account")+"/account")	
					}
				}},
			];
		}
		
		var data=$(ref).data("context.items");
		if (data && data.length){
			for (var i=0; i<data.length; i++){
				if (!data[i].icon){
					data[i].icon="icon-triangle-right";
				}
				menu_items.push(data[i]);
			}
		}
		
		return Context.menu(ref, {top: 24, left:20, menu: menu_items});
	};
	
	
	this.filter=function(q){
		if (q==":online"){
			$("#custom-selection  .li").each(function(){
				if ($(this).find(".avatar.-online").length){
					$(this).show();
				}else{
					$(this).hide();
				}
			});
		}else{
			$("#custom-selection  .li").each(function(){
				var matched=false;
				if (!q || !q.length){
					matched=true;
				}else{
					q=q.toLowerCase();
					var username="@"+$(this).find(".sub").text().toLowerCase();
					var name=$(this).find("b").text().toLowerCase();
					
					if (username.indexOf(q)>=0 || name.indexOf(q)>=0){
						matched=true;
					}
				}
				
				if (matched){
					$(this).show();
				}else{
					$(this).hide();
				}
			});
		}
	};
	
	
	this.avatars=function(usernames){
		return AP.render(usernames, function(e){
			var u=People.get(e);
			if (!u.id || u.error){
				return "";
			}
			
			return "<div class='user url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <div class='avatar avatar-32'><img src='"+(AP.thumb(u.gavatar))+"'></div> </div>";
		});
	};
	
	
	this.names=function(usernames){
		var names = ARR.select(usernames, function(e){
			var u=People.get(e);
			if (!u.id || u.error){
				return null;
			}
			
			return "<div class='user-name url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <span class='uname'>"+(u.name)+"</span> </div>";
		});
		
		return AP.word.join(names, ", ");
	};
	
	
	this.show=function(users){
		return AP.render(users, function(e){
			var u=People.get(e);
			if (!u.id || !parseInt(u.uid)){
				return "";
			}
			
			return "<div class='user url' title='"+(u.name)+"' data-username='"+(u.username)+"'> <div class='avatar avatar-32'><img src='"+(AP.thumb(u.gavatar))+"'></div> <div class='name'>"+(u.name)+"</div> <div class='info'>"+(u.title)+"&nbsp;</div> </div>";
		});
	}
	
	
	
	function render(user, is_multi){
		return "<div class='li item unselectable' data-multi='"+is_multi+"' data-user-id='"+user.id+"' onclick='__selectUser(this);'>" +
			"<div class='image'><div class='avatar "+(user.online?" -online":"")+"'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div> <b>"+user.name+"</b><div class='sub'>@"+user.username+"</div>" +
			"<div class='-ricon'><span class='-select'></span></div>"+
		"</div>";
	}
	
	
	function simple(user){
		var sub=user.title;
		if (!user.title){
			sub="No job title";
		}
		return "<div class='li item unselectable url"+(sub.length?'':' -no-info')+"' data-username='@"+(user.username)+"'> <div class='image'><div class='avatar "+(user.online?' -online':'')+"'> <img src='"+(AP.xthumb(user.gavatar))+"'/> </div></div> <b>"+(user.name)+"</b> <div class='sub'>@"+(user.username)+" &middot; "+(sub)+"</div> <div class='-ricon'><span class='ficon-angle-right'></span></div> </div>";
	}
};
	

function __selectUser(ref){
	var id=$(ref).data("user_id");
	$(ref).toggleClass("selected");
	
	if ($(ref).data("multi")==0 && $(ref).hasClass("selected")){
		__pickUserCallback(ref);
	}
};



function __pickUserCallback(ref){
	var $canvas=$(ref).closest(".__canvas");
	var selected=[];
	
	$canvas.find(".li.item").each(function(){
		var id=$(this).data("user-id");
		if ($(this).hasClass("selected")){
			selected.push(id);
		}
	});
	
	AP.closeDialog(ref);	
	var fn=$canvas.data("callback");
	return fn(selected);
};



function ticon(name, size, color){
	name=name.toUpperCase();
	if (!size){
		size=32;
	}
	
	if (!color || color=="auto"){
		color=UI.str2int(name+"ab");
	};
	
	var txt=name.substr(0,2).toUpperCase();
	
	return "<div class='tavatar tavatar-"+size+" -bg-alt"+color+"'>"+txt+"</div>";
};UI.link=new function __UILink(){
	
	this.domain=function(url){
		 var domain;
	    //find & remove protocol (http, ftp, etc.) and get domain
	    if (url.indexOf("://") > -1) {
	        domain = url.split('/')[2];
	    }
	    else {
	        domain = url.split('/')[0];
	    }

	    //find & remove port number
	    domain = domain.split(':')[0];

	    return domain;
	};
	
};UI.setting=function __UISetting(title){
	return new UISetting(title);
};


function UISetting(title){
	this.options=[];
	this.title=title;
	this.__callback=null;
	
	this.add=function(opts){
		this.options.push(new UISettingOption(opts));
		return this;
	};
	
	this.callback=function(cb){
		for (var i=0; i<this.options.length; i++){
			this.options[i].callback=cb;
		}
		
		this.__callback=cb;
		return this;
	};
	
	this.show=function(canvas, callback){
		if (!callback) {
			callback = null;
		}
		
		if (canvas && canvas.length){
			return this.showInline(canvas, this.options);
		}else{
			if (!callback && this.__callback){
				callback=this.__callback;
			}
		}
		
		var html="<div class='title'>"+this.title+" <div class='close -close' onclick='AP.closeDialog(this)'></div></div>";
		html+="<div class='list -settings'>"+AP.render(this.options, function(e){
			return e.html();
		})+"</div>";
		
		
		AP.customDialog(html, "custom-settings").addClass("-full").width(640).show();
		Tag.user("#custom-settings input", Client.people);
		$("#custom-settings input").enter(function(){
			var val=$(this).val();
			var name=$(this).attr('name');
			var api=$(this).data("api");
			
			AP.ajaxShow("Updating ...");
			AP.post(api,{name: name, value: val}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}

				UI.flash("Preference saved!");
				if (callback) {
					callback(code, name, val);
				}
			});
		});
		
		
		$("#custom-settings select").change(function(){
			var val=$(this).val();
			var name=$(this).attr('name');
			var api=$(this).data("api");
			
			AP.ajaxShow("Updating ...");
			AP.post(api,{name: name, value: val}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Preference saved!");
				if (callback) {
					callback(code, name, val);
				}
			});
		});
		
		return this;
	};
	
	
	this.showYesNo=function(canvas){
		$(canvas).html("<div class='setting-box'><div class='title'>"+this.title+"</div> <div class='js-setting-body values'></div></div>");

		for (var i=0; i<this.options.length; i++){
			addYesNoOption(canvas, this.options[i]);
		}
	};
	
	
	this.showInline=function(canvas, options){
		for (var i=0; i<options.length; i++){
			addInlineOption(canvas, options[i]);
		}
	};
	
	
	/**
	 * @desc Insert option
	 */
	function addInlineOption(canvas, option){
		option.appendTo(canvas);
	};
	
	
	function addYesNoOption(canvas, option){
		option.appendYesNo($(canvas).find(".js-setting-body"));
	};
	
};






function UISettingOption(opts){
	this.opts=$.extend({}, {value:''}, opts);
	
	this.html=function(){
		return "<div class='li'><div class='title'>"+this.opts.title+"</div> <div class='value'>"+showValue(this.opts)+"</div></div>";
	};
	
	
	this.appendTo=function(canvas){
		var id=AP.uuid();
		var html="<div class='setting-box is-checkbox' id='"+id+"'><div class='title'>"+this.opts.title+"</div> <div class='values'>"+showCheckbox(this.opts)+"</div></div>";
		$(html).appendTo(canvas);
		$(canvas).data("object", this).addClass("__sts");
		
		$("#"+id+" .st-opt").click(function(){
			var name=$(this).data("name");
			var value=$(this).data("value");
			var url=$(this).data("url");
			
			$(this).siblings().removeClass("selected");
			$(this).addClass("selected");
			
			
			UI.ajaxShow();
			AP.post(url, {name: name, value: value}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				var obj=$(this).closest(".__sts");
				if (obj && obj.callback){
					obj.callback(name, value);
				}
			});
		});
	};
	
	
	this.appendYesNo=function($box){
		var selected="";
		if (this.opts.value=="yes"){
			selected=" selected";
		}
		
		var id=AP.uuid();
		$box.append("<div class='st-opt-wrapper' id='"+id+"'><div class='st-opt"+selected+"' data-url='"+this.opts.url+"' data-cvalue='"+this.opts.value+"' data-name='"+this.opts.name+"'>"+this.opts.title+"</div></div>");
		
		$("#"+id+" .st-opt").click(function(){
			var name=$(this).data("name");
			var value=$(this).data("value");
			var url=$(this).data("url");
			
			var next_val="yes";
			if ($(this).hasClass("selected")){
				next_val="no";
			}
			
			if (next_val=="no"){
				$(this).removeClass("selected");	
			}else{
				$(this).addClass("selected");
			}
			
			
			UI.ajaxShow();
			AP.post(url, {name: name, value: next_val}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				var obj=$(this).closest(".__sts")
				if (obj && obj.callback){
					obj.callback(name, value);
				}
			});
		});
	};
	
	
	
	function showValue(opts){
		var html="";
		if (opts.options==":custom:users"){
			return "<div class='input'><input data-api='"+opts.url+"' class='std __select-users' name='"+opts.name+"' value='"+opts.value+"' placeholder='Type @ to tag - press Enter to save'/> <div class='hint'>Press Enter after selecting users to save</div></div>";
		}
		
		
		for (var opt in opts.options){
			if (opts.value && opts.value==opt){
				html+="<option value='"+opt+"' selected>"+opts.options[opt]+"</option>";	
			}else{
				html+="<option value='"+opt+"'>"+opts.options[opt]+"</option>";	
			}
		}
		
		return "<div class='select'><select class='std' name='"+opts.name+"' data-api='"+opts.url+"'>"+html+"</select></div>";
	};
	
	
	
	function showCheckbox(opts){
		var html="<div class='hidden'><input type='hidden' name='"+opts.name+"'/></div>";
		
		for (var opt in opts.options){
			if (opts.value && opts.value==opt){
				html+="<div class='st-opt selected' data-url='"+opts.url+"' data-name='"+opts.name+"' data-value='"+opt+"'>"+opts.options[opt]+"</div>";	
			}else{
				html+="<div class='st-opt' data-url='"+opts.url+"' data-name='"+opts.name+"' data-value='"+opt+"'>"+opts.options[opt]+"</div>";	
			}
		}
		
		return html;
	};
	
};
UI.tree=new function __UITree(){
	this.html=function(node, fn){
		return printTree(node, fn);
	};
	
	this.getTrace=function(root, node){
		var traces=[];
		buildTrace(root, node, traces);
		return traces.reverse();
	};
	
	
	this.findNode=function(root, nid){
		nid=parseInt(nid);
		if (parseInt(root.id)==nid){
			return root;
		}
		
		for (var i=0; i<root.nodes.length; i++){
			node=this.findNode(root.nodes[i], nid);
			if (node){
				return node;
			}
		}
		
		return null;
	};
	
	
	this.options=function(node, fn){
		var root=null;
		if (AP.data.isArray(node)){
			var root={id:0, nodes: node, name: "Root", level: 0, 'root': 1};
		}else{
			root=node;
		}
		
		return printTree(root, function(e, level){
			if (e.root && e.root==1){
				return "";
			}
			return "<option value='"+e.id+"'>"+("--").repeat(level-1)+" "+e.name+"</option>";
		});
		
	};
	
	
	function buildTrace(root, node, traces){
		if (parseInt(root.id)==parseInt(node.id)){
			return true;
		}
		
		for (var i=0; i<root.nodes.length; i++){
			if (buildTrace(root.nodes[i], node, traces)){
				traces.push(root.nodes[i]);
				return true;
			}
		}
		
		return false;
	};

	
	
	function printTree(node, render){
		return printNode(node, node.level, render);
	};
	
	

	function printNode(node, level, render){	
		var html=render(node, level);
		
		if (!node.nodes || !node.nodes.length){
			return html;
		}
		
		html+="<div class='box box-"+level+"' id='node-"+node.gid+"' data-level='"+level+"' data-id='"+node.id+"' data-hid='"+node.hid+"' data-token='"+node.token+"' data-name='"+node.name+"'>";
		for (var i=0; i<node.nodes.length; i++){
			html+=printNode(node.nodes[i], level+1, render);
		}
		html+="</div>";
		
		return html;
	};
};var Emoji=new function __Emoji(){
	this.icons=["angel","angry","anguished","beer","biglike","blushing","cat_grinning","cat_kissing","cat_lovely","cat_pouting","cat_sad", "cat_tear_joy","cat_wry_smile","cat_wth",
				"cheer","chicken","chicken_egg","cold_sweat","confounded","confused","cool","crying","cup", "delicious", "disappointed", "donkey", "evil", "expressionless",
				"fearful","flu", "frowning", "grinning", "grinning_evil", "happy_cry", "heart", "heart_gift", "hix", "huh", "hushed", "kissing", "lovely_evil", "meow", 
				"neutral","nospeaking", "olala", "omg", "pensive", "pouting", "relieved", "sad", "screaming", "sleeping", "sleepy", "sleepy_face", "smiling", "smiling_closed_eye",
				"smiling_eye","smiling_face", "smirking","surprised", "tears", "tired", "tongue", "tongue_closed_eyes", "unamused", "weary", "what_the_heck", "whistle",
				"whistle_heart", "wink",
				"tuzki_5ting", "tuzki_angry", "tuzki_ballet", "tuzki_bed", "tuzki_birthday", "tuzki_bored", "tuzki_bye", "tuzki_charmingly_refuse", "tuzki_chilling", "tuzki_chilling2", "tuzki_chilling3", "tuzki_crying", "tuzki_dancing", "tuzki_dancing2", "tuzki_daydreaming", "tuzki_depressed", "tuzki_disappointed", "tuzki_dispirited", "tuzki_droop", "tuzki_eating", "tuzki_feel_the_beat", "tuzki_giggling", "tuzki_headspin", "tuzki_heart", "tuzki_heroic", "tuzki_high_kick", "tuzki_hyperactive", "tuzki_idk", "tuzki_in_jail", "tuzki_killing", "tuzki_kissing", "tuzki_milk", "tuzki_mr_bean", "tuzki_out_of_my_way", "tuzki_panic", "tuzki_shocked", "tuzki_sleepy", "tuzki_star_reaching", "tuzki_superman", "tuzki_swag_buddy", "tuzki_swag2", "tuzki_swag3", "tuzki_swagging", "tuzki_sweating", "tuzki_taichi", "tuzki_wake_up"];
	
	this.pick=function(callback){	
		var html="";
		for (var i=0; i< this.icons.length; i++){
			var key=this.icons[i];
			var img=Client.share_url+"/emojis/"+key+".png";
			if(key.substr(0, 6) == "tuzki_") {
				img = Client.share_url + "/tuzki/" + key + ".gif";
			}
			html+="<div class='item' style='width:10%' title=':"+key+":' data-val=':"+key+":' onclick='__pickEmoji(this)'><div class='inner -full'><img src='"+img+"'/></div></div>";
		}
		
		html="<div class='list-emotions' style='width:500px' id='__pickemo'>"+html+"</div>";
		AP.selectOne("Click to select an emotion you like",html);
		$("#__pickemo").data("callback", callback);
	};
	
	
	this.match=function(r){
		r=r.replace(/\:\w+\:/gi, function(match){
			var test=match.substr(1, match.length-2);
			for (var i=0; i<Emoji.icons.length; i++){
				if (Emoji.icons[i]==test){
					if(test.substr(0, 6) == "tuzki_") {
						return "<img src='" + Client.share_url + "/tuzki/" + test + ".gif'/>";
					}
					return "<img src='"+Client.share_url+"/emojis/"+test+".png'/>";
				}
			}
			
			return match;
		});
		
		return r;
	};
	
};UI.orgchart=new function __UIORGChart(){
	this.zoom=1;
	this.tree=null;
	
	this.display=function(tree, canvas, render, opts){
		if (!tree.id || !parseInt(tree.id)){
			tree.id=0;
		}
		
		opts=$.extend({}, {width: 150, height: 100, space: 100}, opts);
		opts.base={width: opts.width + opts.space, height: opts.height+60};
		
		tree.level=1;
		tree.height=1;
		tree.offset=0;
		tree.root=1;
		initOrgchart(tree);
		
		if (tree.nodes && opts.collapsed){
			for (var i=0; i<tree.nodes.length; i++){
				tree.nodes[i].orgchart.show=0;
			}
		}
		
		displayChart(tree, canvas, render, opts);
		
		if (opts.mousewheel){
			$(canvas).on("mousewheel", function(event){
				var factor=event.originalEvent;
				if (!factor){
					return;
				}
				
				if (factor.deltaY<0){
					UI.orgchart.zoomIn($(this).find(".orgchart-canvas"));
				}else if (factor.deltaY>0){
					UI.orgchart.zoomOut($(this).find(".orgchart-canvas"));
				}
			});
		}
		
		this.zoom=1;
		this.tree=tree;
		this.tree.__options=opts;
		this.tree.__canvas=canvas;
	};
	
	this.zoomIn=function(ref){
		this.zoom+=0.15;
		$(ref).closest(".orgchart").find('.orgchart-canvas').css("zoom",this.zoom);
	};
	
	
	this.zoomOut=function(ref){
		this.zoom-=0.15;
		if (this.zoom<0.4){
			this.zoom=0.4;
		}
		$(ref).closest(".orgchart").find('.orgchart-canvas').css("zoom",this.zoom);
	};
	
	
	this.collapse=function(ref){
		var id=$(ref).data("id");
		var $wrap=$(ref).closest(".wrap");
		var collapsed=1;
		
		if ($wrap.hasClass("-collapsed")){
			collapsed=0;
			$wrap.removeClass("-collapsed").children(".nodes").show();
		}else{
			$wrap.addClass("-collapsed").children(".nodes").hide();	
		}
		
		var $pwrap=$wrap.closest(".nodes");
		updateTreeData(this.tree, function(e){
			if (collapsed){
				if (parseInt(e.id)==parseInt(id)){
					e.orgchart.show=0;
				}
			}else{
				if (parseInt(e.id)==parseInt(id)){
					e.orgchart.show=1;
				}
			}
		});
		
		var opts=this.tree.__options;
		computeWidth(this.tree, opts);		
		
		var $canvas=$(this.tree.__canvas);
		
		updateTreeData(this.tree, function(node){
			if (!node.orgchart.offset){
				$canvas.find(".js-wrap-"+node.id).css("width", node.orgchart.width);	
			}else{
				$canvas.find(".js-wrap-"+node.id).css("left", node.orgchart.offset).css("width", node.orgchart.width);
			}
			
			if (node.nodes.length){
				var ll=node.nodes[0].orgchart.width/2+opts.space/2;
				var lr=node.nodes[node.nodes.length-1].orgchart.width/2 - opts.space/2;
				
				$canvas.find(".js-wrap-"+node.id+" > .nodes > .-line").css({left: ll, right: lr});
			}
			
			var left=(node.orgchart.width-opts.width+opts.space)*0.5;
			$canvas.find(".js-wrap-"+node.id+" > .nodew").css("left", left);
		});
		
	};
	
	
	function displayChart(tree, canvas, render, opts){
		$(canvas).html("<div class='orgchart'>" +
			"<div class='zoom'>" +
			"	<span class='-first' onclick='UI.orgchart.zoomIn(this);'><span class='-ap icon-plus4'></span></span>" +
			"	<span class='-second' onclick='UI.orgchart.zoomOut(this);'><span class='-ap icon-minus2'></span></span>" +
			"</div>" +
			"<div class='orgchart-outer-canvas'><div class='orgchart-canvas'></div></div>" +
		"</div>");
		
		show(tree, canvas, render, opts);
	};
	
	
	function show(tree, canvas, render, opts){
		computeWidth(tree, opts);
		testWidth(tree);
		var html=getGraphicDisplay(tree, render, opts);
		
		
		var $canvas=$(canvas);
		$canvas.find(".orgchart-canvas").html(html).css("width", tree.width+100).css("height",tree.height*opts.base.height);
		var l=(tree.width-$canvas.width())/2;
		$canvas.find(".orgchart-outer-canvas").css("width", tree.width+100).css("height",tree.height*opts.base.height).css("position","absolute").css("left", -l).css("top",30);
		$canvas.find(".orgchart-outer-canvas").draggable({cursor: "move"});
	};
	
	
	function balance(canvas){
		$(canvas).find('.orgchart-outer-canvas').css("width", Client.pageData.tree.width+100).css("height",Client.pageData.tree.height*opts.base.height).css("position","absolute").css("left", -l).css("top",30);
	};
	
	
	function getGraphicDisplay(node, render, opts){
		if (!node.nodes || !node.nodes.length){
			return "<div class='wrap js-wrap-"+node.id+"' style='z-index:"+((100-node.level)*5+100)+"; top:0px; left:"+node.orgchart.offset+"px; width:"+(node.orgchart.width)+"px'>"+showSingleNode(node, render, opts)+"</div>";
		}else{
			var ll=node.nodes[0].orgchart.width/2+opts.space/2;
			var lr=node.nodes[node.nodes.length-1].orgchart.width/2 - opts.space/2;
			
			var line="<div class='-line' style='left:"+ll+"px; right:"+lr+"px'></div>";
			return "<div class='wrap js-wrap-"+node.id+" "+((node.orgchart.show)?"":"-collapsed")+"' style='z-index:"+((100-node.level)*5+100)+"; top:0px; left:"+node.orgchart.offset+"px; width:"+(node.orgchart.width)+"px; height:"+(node.orgchart.height*opts.base.height)+"px'>"+
				showSingleNode(node, render, opts)+
				"<div class='nodes -nodes "+((node.orgchart.show)?"":"hidden")+"' style='top:"+opts.base.height+"px'>"+line + AP.render(node.nodes, function(e){
					return getGraphicDisplay(e, render, opts);
				})+"</div>" +
			"</div>";
		}
	};
	
	
	
	function showSingleNode(node, render, opts){
		var w=node.width;
		var level=node.level;
		var left=(node.orgchart.width-opts.width+opts.space)*0.5;
		var eclass="";
		if (!node.nodes || !node.nodes.length){
			eclass=" -leaf";
		}
		
		if (node.metatype && parseInt(node.metatype)){
			eclass+=" -exe";
		}
		var id=node.id;
		if (node.root){
			id=0;
		}
		
		var collapse_button="<div class='cbt' onclick='UI.orgchart.collapse(this);' data-id='"+node.id+"'><span></span></div>";
		if (!node.nodes || !node.nodes.length){
			collapse_button="";
		}
		
		return "<div class='nodew"+eclass+"' style='left:"+left+"px; width:"+opts.width+"px; height:"+opts.height+"px' data-cwidth='"+node.orgchart.width+"' data-cheight='"+node.orgchart.height+"'>" +
			"<div class='node' style='width:"+opts.width+"px; height:"+opts.height+"px'> " +
				render(node)+
				collapse_button +
			"</div>" +
		"</div>";
		
	};
	
	
	
	function initOrgchart(node){
		node.orgchart={show: 1};
		
		if (!node.nodes || !node.nodes.length){
		}else{
			for (var i=0; i<node.nodes.length; i++){
				initOrgchart(node.nodes[i]);
			}
		}
	};
	
	
	function updateTreeData(node, fx){
		fx(node);
		
		if (!node.nodes || !node.nodes.length){
		}else{
			for (var i=0; i<node.nodes.length; i++){
				updateTreeData(node.nodes[i], fx)
			}
		}
	};
	
	
	function testWidth(tree){
		updateTreeData(tree, function(e){
			$.log([e.name, e.orgchart.show, e.orgchart.width, e.orgchart.offset]);
		})
	};
	

	
	function computeWidth(node, opts){
		if (!node.nodes || !node.nodes.length){
			node.orgchart.width=opts.width + opts.space;
			node.orgchart.offset=opts.space/2;
			node.orgchart.height=1;
			return opts.base.width;
		}else if (!node.orgchart.show){
			node.orgchart.width=opts.width + opts.space;
			node.orgchart.offset=opts.space/2;
			node.orgchart.height=1;
			return opts.base.width;
		}else{
			var w=0;
			for (var i=0; i<node.nodes.length; i++){
				node.nodes[i].level=node.level+1
				w+=computeWidth(node.nodes[i], opts);
			}

			
			var offset=0;
			var max_height=1;
			for (var i=0; i<node.nodes.length; i++){
				node.nodes[i].orgchart.offset=offset;
				offset+=node.nodes[i].orgchart.width;
				if (node.nodes[i].orgchart.height>max_height){
					node.nodes[i].orgchart.height=max_height;
				}
			}
			
			node.orgchart.width=w;
			node.orgchart.height=max_height+1;
			return w;
		}
	};

};function getMainColor(){
	if (!Client.viewer || !Client.viewer.color){
		return "#000";
	}
	
	var c=parseInt(Client.viewer.color);
	if (c==0){
		c=1;
	}
	var list=["#267cde", "#7c32a1", "#0bba88", "#4CAF50", "#473db8", "#dbaa07", "#FF6F22", "#CF5555", "#ee5997"];
	return list[c-1];
	
}

UI.color=new function __UIColor(){
	var colors=["#EB6450","#F7CF2D","#CEED5F","#A5E33B","#49E33B"];
	var alts=[getMainColor(),"#2a91d6", "#00BCD4", "#26A69A", "#4CAF50", "#5969c5", "#FFC107", "#FF6F22", "#CF5555", "#ee59ba"];
	
	this.regs={};
	
	this.main=getMainColor();
	
	this.get=function(id){
		id = $.trim(id);
		
		if (id=="success"){
			return "#14cc3f";
		}
		
		if (id=="error"){
			return "#c34343";
		}
		
		if (id=="danger"){
			return "#de5954";
		}
		
		if (id == "main"){
			return this.main;
		}
		
		if (id == "orange" || id=="warning"){
			return "#ED6334";
		}
		
		if (id == "blue" || id=="active"){
			return "#267cde";
		}
		
		if (id == "yellow" || id=="notice"){
			return "#FFD000";
		}
		
		if (id=='gray'){
			return '#999999';
		}
		
		if (AP.data.isString(id) && isHexColor(id)){
			return id;
		}
		
		if (AP.data.isString(id) && AP.word.prefix(id, "rgb")){
			return id;
		}
		
		if (AP.data.isString(id) && AP.word.suffix(id, "-")){
			return Color.adjust(this.get(id.substr(0, id.length-1)), -15, -15);
		}
		
		if (AP.data.isString(id) && AP.word.suffix(id, "+")){
			return Color.adjust(this.get(id.substr(0, id.length-1)), 15, 15);
		}
		
		if (AP.data.isString(id) && AP.word.suffix(id, " less")){
			return Color.adjust(this.get(id.substr(0, id.length-5)), -15, -15);
		}
		
		if (AP.data.isString(id) && AP.word.suffix(id, " more")){
			return Color.adjust(this.get(id.substr(0, id.length-5)), 15, 15);
		}
		
		if (AP.data.isString(id) && AP.word.suffix(id, " inverse")){
			return Color.adjust(this.get(id.substr(0, id.length-8)), -10, -90);
		}
		
		
		if (id=='gray less'){
			return '#bbb';
		}
		
		if (AP.data.isString(id) && this.regs[id]){
			return this.regs[id];
		}
		
		if (AP.data.isString(id) && AP.word.prefix(id, "alt")){
			return alts[parseInt(id.substr(3))];
		}
		
		id=parseInt(id);
		if (id>=4){
			id=4;
		}
		
		return colors[id];
	};
	
	
	this.alt = function(id){
		id=parseInt(id);
		if (id>=9){
			id=(id % 9)+1;
		}
		
		return alts[id];
	}
	
	this.fromText = function(text){
		return this.alt(UI.str2int(text));
	};
	
	this.register=function(key, val){
		this.regs[key]=val;
	};
	
	this.getRandom=function(){
		return this.get(AP.data.randomInteger(0,5));
	};
	
	this.rgba=function(hexcolor, a){
		if (hexcolor=="transparent"){
			return "transparent";
		}
		
		var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hexcolor);
		var rgb= result ? {
			r: parseInt(result[1], 16),
			g: parseInt(result[2], 16),
			b: parseInt(result[3], 16)
		} : null;
		
		if (rgb){
			return "rgba("+rgb.r+", "+rgb.g+", "+rgb.b+", "+a+")"
		}
		
		return "#000";
	};
	
	
	/**
	 * @desc Check to make sure a color is dark. If light, return false
	 */
	this.isDark = function(hexcolor){
		if (!hexcolor){
			return false;
		}
		
		var hsl=rgbToHsl(hexcolor);
		
		if (hsl.l >= 80){
			return false;
		}
		
		return true;
	};
	
	
	this.darken=function(hexcolor, point){
		return shadeColor(hexcolor, point);
	};
	
	this.adjust=function(hexcolor, x, y){
		if (typeof hexcolor == "undefined" || hexcolor==null){
			return "#ffffff";
		}
		
		if (hexcolor=="transparent"){
			return "transparent";
		}
		
		var hsl=rgbToHsl(hexcolor);
		
		y=-y;
		
		if (x>=0){
			hsl.s=(1-hsl.s/100.0)*x+hsl.s;	
		}else{
			hsl.s=(hsl.s/100.0)*x+hsl.s;
		}
		
		if (y>0){
			hsl.l=(1-hsl.l/100.0)*y+hsl.l;	
		}else{
			hsl.l=(hsl.l/100.0)*y+hsl.l;
		}
		
		return hsl2rgb(hsl);
	};
	
	/**
	 * @desc Mixing two color
	 * @param from Hex color
	 * @param to Hext color
	 * @param scale Number in [0,1]
	 */
	this.mix = function(from, to, scale){
		var from_rgb = getRGB(from);
		var to_rgb = getRGB(to);
		
		var r = from_rgb.r*(1-scale) + to_rgb.r*scale;
		var g = from_rgb.g*(1-scale) + to_rgb.g*scale;
		var b = from_rgb.b*(1-scale) + to_rgb.b*scale;
		
		return this.rgbToHex(r,g,b);
	};
	
	
	this.complete=function(percent){
		var x=parseFloat(percent);
		
		if (x<60){
			return colors[0];
		}
		
		if (x>=60 && x<80){
			return colors[1];
		}
		
		if (x>=80 && x<95){
			return colors[2];
		}
		
		if (x>=95 && x<100){
			return colors[3];
		}
		
		if (x>=100){
			return colors[4];
		}
	};
	
	
	this.incomplete=function(color){
		if (color>100){
			color=100;
		}
		
		return this.complete(100-color);
	};
	
	
	this.progress=function(obj){
		var x=0;
		var etime=parseInt(obj.etime);
		var stime=parseInt(obj.stime);
		var time=AP.time.now();
		
		if (obj.percent){
			var p=parseFloat(obj.percent);
			var target=100;
			var base=0;
			
			if (time> etime){
				x=parseInt(p);
			}else if (time > stime){
				var speed = (p - base)/(time-stime);
				var expected=(target-base)/(etime-stime);
				x=parseInt(speed*100.0/expected); // Expected speed
			}
		}else{
			var complete=parseInt(obj.complete);
			var target=100;
			var base=0;
			
			if (time> etime){
				x=parseInt(complete*100.0/target);
			}else if (time > stime){
				var speed = (complete - base)*1000.0/(time-stime);
				var expected=(target-base)*1000.0/(etime-stime);
				x=parseInt(speed*100.0/expected); // Expected speed
			}	
		}
		
		if (x<60){
			return colors[0];
		}
		
		if (x>=60 && x<80){
			return colors[1];
		}
		
		if (x>=80 && x<95){
			return colors[2];
		}
		
		if (x>=95 && x<100){
			return colors[3];
		}
		
		if (x>=100){
			return colors[4];
		}
		
	};
	
	
	this.speed = function(percent, start, end){
		var x=0;
		var etime=parseInt(end);
		var stime=parseInt(start);
		var time=AP.time.now();
		
		var p=parseFloat(percent);
		var target=100;
		var base=0;
		
		if (time> etime){
			x=parseInt(p);
		}else if (time > stime){
			var speed = (p - base)/(time-stime);
			var expected=(target-base)/(etime-stime);
			x=parseInt(speed*100.0/expected); // Expected speed
		}
		
		return x;
	};
	
	
	this.percent=function(p){
		return this.complete(p);
	};
	
	
	this.picker=function(selector){
		$(selector).each(function(){
			if ($(this).hasClass("__jscolorpicker")){
				return;
			}
			
			$(this).addClass("__jscolorpicker");
			$(this)[0].autocomplete="off";
			
			$(this).on('click', function () {
				var obj = $(this)[0];
				if (!obj.hasPicker) {
					var picker = new jscolor(obj, {});  //
					obj.hasPicker = true;
					picker.show();
				}
			}); 
		});   
	};


	this.rgbToHex = function(r, g, b) {
		return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
	};
	
	
	/**
	 * @desc Getting the palletes
	 */
	this.pallete = function(){
		var c1 = ["#2a91d6", "#00BCD4", "#26A69A", "#4CAF50", "#5969c5", "#FFC107", "#FF6F22", "#CF5555", "#ee59ba"];
		var c2 = ARR.clone(c1);
		
		var p = [];
		
		for (var i=3; i>0; i--){
			var c = ARR.select(c1, function(e){
				return Color.adjust(e, 20*i, 20*i);
			});
			
			p.push(ARR.clone(c));
		}
		
		p.push(ARR.clone(c1));
		
		for (var i=1; i<5; i++){
			var c = ARR.select(c2, function(e){
				return Color.adjust(e, -10*i, -19*i);
			});
			
			p.push(ARR.clone(c));
		}
		
		return p;
	};
	
	
	function shadeColor(hex, lum){
		// validate hex string
		hex = String(hex).replace(/[^0-9a-f]/gi, '');
		if (hex.length < 6) {
			hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
		}
		lum = lum || 0;

		// convert to decimal and change luminosity
		var rgb = "#", c, i;
		for (i = 0; i < 3; i++) {
			c = parseInt(hex.substr(i*2,2), 16);
			c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
			rgb += ("00"+c).substr(c.length);
		}

		return rgb;
	};
	
	
	function rgbToHsl(rgb){
		var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
		var hex = rgb.replace(shorthandRegex, function(m, r, g, b) {
			return r + r + g + g + b + b;
		});
		
		var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
		
		var color= result ? {
			r: parseInt(result[1], 16),
			g: parseInt(result[2], 16),
			b: parseInt(result[3], 16)
		} : null;
		
		var r=color.r/255.0;
		var g=color.g/255.0;
		var b=color.b/255.0;
		
		
		var max = Math.max(r, g, b), min = Math.min(r, g, b);
		var h, s, l = (max + min) / 2;

		if(max == min){
			h = s = 0; // achromatic
		}else{
			var d = max - min;
			s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
			switch(max){
				case r: h = (g - b) / d + (g < b ? 6 : 0); break;
				case g: h = (b - r) / d + 2; break;
				case b: h = (r - g) / d + 4; break;
			}
			h /= 6;
		}

		return {h: Math.floor(h * 360), s: Math.floor(s * 100), l: Math.floor(l * 100)};
	};
	
	
	function hsl2rgb(hsl){
		var r, g, b;
		
		var h=hsl.h/360.0;
		var s=hsl.s/100.0;
		var l=hsl.l/100.0;
		

		if (s == 0) {
			r = g = b = l; // achromatic
		} else {
			var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
			var p = 2 * l - q;

			r = hue2rgb(p, q, h + 1/3);
			g = hue2rgb(p, q, h);
			b = hue2rgb(p, q, h - 1/3);
		}

		return "#" + componentToHex(r*255) + componentToHex(g*255) + componentToHex(b*255);
	};
	
	
	function hue2rgb(p, q, t) {
		if (t < 0) t += 1;
		if (t > 1) t -= 1;
		if (t < 1/6) return p + (q - p) * 6 * t;
		if (t < 1/2) return q;
		if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
		return p;
	};
	
	function componentToHex(c) {
		c=parseInt(c);
		var hex = c.toString(16);
		return hex.length == 1 ? "0" + hex : hex;
	};
	
	
	function getRGB(color_code){
		
		var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
		var hex = color_code.replace(shorthandRegex, function(m, r, g, b) {
			return r + r + g + g + b + b;
		});
		
		var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
		
		var rgb= result ? {
			r: parseInt(result[1], 16),
			g: parseInt(result[2], 16),
			b: parseInt(result[3], 16)
		} : null;

		return rgb;
	}
	
	
	/**
	 * @desc Check if a color is hex
	 */
	function isHexColor(color){
		return /^#[0-9A-F]{6}$/i.test(color) || /^#[0-9A-F]{3}$/i.test(color);
	};
};


var Color=UI.color;UI.emoticons={
	':-)': 'smile.gif',	
	':))': 'laughing.gif',
	':)': 'smile.gif',
	'::smile::' : 'smile.gif',
	';)': 'wink.gif',
	'::wink::' : 'wink.gif',
	':d': 'big.grin.gif',
	':-d': 'big.grin.gif',
	':-|': 'smile.gif',
	':|': 'straight.gif',
	':-s': 'worried.gif',
	':x': 'love.gif',
	':*': 'kiss.gif',
	':p': 'tounge.gif',
	':((': 'cry.gif',
	':(': 'sad.gif',
	':-o': 'suprised.gif',
	'=))': 'rolling.gif',
	'::devil::': 'devil.gif',
	'::shocked::': 'shocked.gif',
	'::angry::': 'angry.gif',
	'::embarrassed::': 'embarrassed.gif',
	'::huh::':'huh.gif',
	'(y)':'biglike.png',
	':v':'pacman.png',
	':3':'colonthree.png',
	'b-)':'sunglasses.gif'
};

for (var key in UI.emoticons){
	UI.emoticons[key] = Client.share_url+"/emotions/" + UI.emoticons[key]; 
}

if (Client.emojis){
	for (var i=0; i<Client.emojis.length; i++){
		if (Client.emojis[i].emoji) {
			UI.emoticons[":"+Client.emojis[i].shortcode+":"] = Client.emojis[i].emoji;
		}
	}
}

UI.emotion=function(_text){
	var text = " "+_text+" "; 
	var emoticons = UI.emoticons;
	
	var icons = {
		'(y)' : 'thumbs-up2',
	},
	 
	patterns = [], ipatterns=[],
	prefix = '(\.|\,|\s|>)',
	suffix = '(\\.|\,|\;|\\s)',
	metachars = /[[\]{}()*+?.\\|^$\-,&#\s]/g;

	for (var emo in emoticons) {
		patterns.push('('+emo.replace(metachars, "\\$&")+suffix+')');
	}

	var r = text;
	
	r= r.replace(new RegExp(patterns.join('|'),'ig'), function (match){
		var key = match.substr(0, match.length-1).toLowerCase();
		if (UI.emoticons[key]){
			var emoticon = UI.emoticons[key];
			emotion = '<img class="emo" src="'+emoticon+'"/>';
			return emotion + match.substr(match.length-1, 1); 
		}
		
		return match;
	});
	
	return $.trim(r);
};



UI.pickEmotion=function(callback){
	var html="";
	for (var key in UI.emoticons){
		var img=Client.share_url+"/emotions/"+UI.emoticons[key];
		html+="<div class='item' style='width:10%' title='"+key+"' data-val='"+key+"' onclick='__pickEmo(this)'><div class='inner'><img src='"+img+"'/></div></div>";
	}
	
	html="<div class='list-emotions' style='width:500px' id='__pickemo'>"+html+"</div>";
	AP.selectOne("Click to select an emotion you like",html);
	$("#__pickemo").data("callback", callback);
};


function __pickEmo(ref){
	var val=$(ref).data('val');
	var fn=$("#__pickemo").data("callback");
	
	AP.closeDialog(ref);
	fn(val+" ");
};


function __pickEmoji(ref){
	var val=$(ref).data('val');
	var fn=$("#__pickemo").data("callback");
	
	AP.closeDialog(ref);
	fn(val);
}UI.graph=new function __UIGraph(){
	this.getSpeed=function(obj){
		var x=0;
		var etime=parseInt(obj.etime);
		var stime=parseInt(obj.stime);
		var time=AP.time.now();
		
		var complete=parseInt(obj.complete);
		var target=100;
		var base=0;
		
		if (time> etime){
			x=parseInt(complete*100.0/target);
		}else if (time > stime){
			var speed = (complete - base)*1000.0/(time-stime);
			var expected=(target-base)*1000.0/(etime-stime);
			x=parseInt(speed*100.0/expected); // Expected speed
		}
		
		return x;
	};
	
	
	this.sector=function(selector, options){
		options=$.extend({thickness: 4, fontSize:10, color: "#888888", bgColor:"#eee"}, options);
		
		$(selector).css({"width": options.size, "height": options.size}).addClass("js-sector-chart").html("<div class='js-sector -circled' style='position:absolute; width:"+options.size+"px; height:"+options.size+"px; background-color:"+options.bgColor+"'></div>");
		
		var data = {
			size: options.size,
			sectors: [
				{
					percentage: options.percent/100,
					label: 'Thing 1',
					color: options.color
				}
			]
		};	

		sectors = calculateSectors(data);
		var newSVG = document.createElementNS("http://www.w3.org/2000/svg","svg" );
		newSVG.setAttributeNS(null, 'style', "width: "+data.size+"px; height: " + data.size+ "px");
		
		var $box=$(selector).find(".js-sector");
		$box[0].appendChild(newSVG)


		sectors.map(function(sector){
			var newSector = document.createElementNS("http://www.w3.org/2000/svg","path" );
			newSector.setAttributeNS(null, 'fill', sector.color);
			newSector.setAttributeNS(null, 'd', 'M' + sector.L + ',' + sector.L + ' L' + sector.L + ',0 A' + sector.L + ',' + sector.L + ' 0 ' + sector.arcSweep + ',1 ' + sector.X + ', ' + sector.Y + ' z');
			newSector.setAttributeNS(null, 'transform', 'rotate(' + sector.R + ', '+ sector.L+', '+ sector.L+')');

			newSVG.appendChild(newSector);
		});

		
		if (options.cutout){
			var midCircle = document.createElementNS( "http://www.w3.org/2000/svg","circle" );
			midCircle.setAttributeNS(null, 'cx', data.size * 0.5 );
			midCircle.setAttributeNS(null, 'cy', data.size * 0.5);
			midCircle.setAttributeNS(null, 'r', data.size * options.cutout/200 );
			midCircle.setAttributeNS(null, 'fill', options.bgColor );
			newSVG.appendChild(midCircle);	
		};
	};
	
	
	this.percent=function(selector, opts){
		opts=$.extend({thickness: 4, fontSize:10, color: "#888888", bgcolor:"#bbb"}, opts); 
		
		if (opts.text && opts.text.length){
			$(selector).data("text", opts.text);
		}
		
		if (opts.color && opts.color.length){
			$(selector).data("color", opts.color);
		}
		
		if (opts.percent && AP.data.isNumber(opts.percent)){
			$(selector).data("percent", opts.percent);
		}
		
		if (opts.size && AP.data.isInt(opts.size)){
			$(selector).data("size", opts.size);
		}
		
		
		$(selector).each(function(){
			$(this).data('fgcolor', $(this).data('color'));
			$(this).data('bgcolor', opts.bgcolor);
			$(this).attr('title', $(this).data('percent')+"%");
			
			$(this).circliful({
				dimension: $(this).data('size'), width: opts.thickness, fontsize: opts.fontSize, fillColor: '#333',  animationStep: 10, backgroundBorderWidth: 32
			});
		});
	};
	
	
	this.progression=function(object, canvas, opts, callback){
		opts=$.extend({}, {title: true, prediction: true, label: true}, opts);
		var title="<div class='title'>Tiáº¿n Ä‘á»™ trong 30 ngĂ y gáº§n Ä‘Ă¢y</div>";
		if (!opts.title){
			title="";
		}
		
		$(canvas).html("<div class='objbox -graph'> "+title+" <div class='graph'></div> <div class='none'></div> </div>  <div class='objbox -prediction'></div>");
		showProgressionGraph(object, $(canvas), opts, callback);
		
	};
	
	
	/**
	 * @desc Linear regression model
	 */
	this.learn=function(data){		
		var xavg=0;
		var yavg=0;
		
		for (var i=0; i<data.length; i++){
			var temp=parseFloat(data[i]);
			if (!temp){
				temp=0;
			}
			data[i]=temp;
			
			xavg=xavg+i;
			yavg=yavg+data[i];
		}
		
		xavg=xavg*1.0/data.length;
		yavg=yavg*1.0/data.length;
		
		var upper=0;
		var lower=0;
		
		for (var i=0; i<data.length; i++){
			upper+=(i-xavg)*(data[i]-yavg);
			lower+=(i-xavg)*(i-xavg); 
		}
		
		if (lower==0){
			return [0,0];
		}
		
		var a=upper*1.0/lower;
		var b=yavg - a*xavg;
		
		// Function is now: y(n)= a * x(n) + b for all n
		
		return [a,b];
	};
	
	
	
	
	function showProgressionGraph(objective, $outer_canvas, options, callback){
		var data=prepareProgressions(objective);
		var projection=prepareProjections(objective);
		
		if (data && !data.error){
			$outer_canvas.find(".objbox.-graph .none").hide();
			$outer_canvas.find(".objbox.-graph .graph").show();
			if (projection && !projection.error){
				intellichart(objective, $outer_canvas.find(".objbox.-graph .graph"), data, projection, options);
			}else{
				stdchart($outer_canvas.find(".objbox.-graph .graph"), data.labels, data.values, data.color, options);
			}
		}else{
			$outer_canvas.find(".objbox.-graph .none").show().html("<center style='color: #888;'>KhĂ´ng cĂ³ dá»¯ liá»‡u Ä‘á»ƒ hiá»ƒn thá»‹</center>");	
		}
	};
	
	
	
	
	function prepareProgressions(objective){
		var time=objective.progressions.last;
		var data=objective.progressions.data;
		var labels=[];
		var values=[];
		
		if (!data || !data.length){
			return {error: 1};
		}
		
		var max_displays = 10;
		
		for (var i=0; i<data.length; i++){
			var num=parseFloat(data[i]);
			if (!num){
				num=0;
			}
			
			var text="";
			var displayed=true;
			
			if (displayed){
				labels.push(AP.time.time("%d/%m", AP.time.now()- (data.length-i-1)*24*3600));
			}else{
				labels.push("");
			}
			
			
			values.push(num.toFixed(2));
		}
		
		return {
			color: UI.color.progress({stime: objective.stime, etime: objective.etime, complete: objective.complete}),
			labels: labels,
			values: values,
			error: 0
		};
		
		// Log this up
		
	};
	
	
	
	
	function prepareProjections(objective){
		var data=objective.progressions.data;
		if (!data || !data.length || data.length<=1){
			return {error: 1};
		}
		
		var last=parseInt(objective.progressions.last);
		
		var xavg=0;
		var yavg=0;
		
		for (var i=0; i<data.length; i++){
			var temp=parseFloat(data[i]);
			if (!temp){
				temp=0;
			}
			data[i]=temp;
			
			xavg=xavg+i;
			yavg=yavg+data[i];
		}
		
		xavg=xavg*1.0/data.length;
		yavg=yavg*1.0/data.length;
		
		var upper=0;
		var lower=0;
		
		for (var i=0; i<data.length; i++){
			upper+=(i-xavg)*(data[i]-yavg);
			lower+=(i-xavg)*(i-xavg); 
		}
		
		var a=upper*1.0/lower;
		var b=yavg - a*xavg;
		
		// Function is now: y(n)= a * x(n) + b for all n
		
		var start=b;
		var end= a* (data.length-1)+b;
		var expected=end;
		
		if (parseInt(objective.etime) < last){
			expected=data[data.length-1];
		}
		
		if (a>0 && parseInt(objective.etime) >= last){
			var diff=Math.floor((parseInt(objective.etime)-last)/(24*3600))+data.length-1;
			expected = a * diff + b;
			
			if (expected < 0){
				expected = 0;
			}
		}
		
		
		
		var values=[];
		for (var i=0; i<data.length; i++){
			var temp=(a *i +b).toFixed(2);
			if (temp < 0){
				temp=0;
			}
			values.push(temp);
		}
		
		var last07=0;
		if (data.length>=7){
			last07=data[data.length-7];
		}
		
		return {'expected': expected.toFixed(2), 'start': start, 'end': end, 'length': data.length, 'a': a, 'b': b, 'values': values, 'color': "#2583E8", "last07":last07};
	};
	


	
	
	
	function stdchart(canvas, labels, values, color){
		var data = {
			labels: labels,
			datasets: [
				{
					label: "Current Progression",
					fillColor: UI.color.rgba(color, 0.3),
					strokeColor: color,
					pointColor: color,
					pointStrokeColor: "transparent",
					pointHighlightFill: "#fff",
					pointHighlightStroke: color,
					data: values
				}
			]
		};
		
		
		$(canvas).chartjs(data,{
			pointHitDetectionRadius : 5,
			bezierCurve : false,
			scaleShowVerticalLines: false,
			scaleShowHorizontalLines: true,
			pointDot : true,
			pointDotRadius : 1,
			pointDotStrokeWidth : 1,
			scaleGridLineWidth : 1,
			
			// datasetStrokeWidth : 2,
			// scaleOverride : true,
			// scaleSteps : 5,
			// scaleStepWidth : 100,
			// scaleStartValue : 0,
			// scaleShowGridLines: false,
			// scaleShowLabels: true,
			responsive: true
		});
	};
	
	
	
	function intellichart(objective, canvas, data, projection, options){
		var options=$.extend({}, {compact: false, compare: true, labels: true}, options);
		var labels=data.labels;
		
		if (options.labels==false){
			var ls=[];
			for (var i=0; i<labels.length; i++){
				ls.push("");
			}
			
			labels=ls;
		}
		
		
		var graphs = {
				labels: labels,
				
				datasets: [
					{
						label: "Current Progression",
						fillColor: UI.color.rgba(data.color, 0.3),
						strokeColor: data.color,
						pointColor: data.color,
						pointStrokeColor: "transparent",
						pointHighlightFill: "#fff",
						pointHighlightStroke: data.color,
						data: data.values,
						borderDashOffset: 0.0,
					},
					
					{
						label: "Preditected progression",
						fillColor: 'transparent',
						strokeColor: projection.color,
						pointColor: projection.color,
						pointStrokeColor: "transparent",
						pointHighlightFill: "#fff",
						pointHighlightStroke: projection.color,
						data: projection.values,
						borderDashOffset: 0.0,
						borderDash: [1,2],
					}
				]
			};
		
		if (options.compare){
			graphs.datasets.push({
				label: "Last 07 day progression",
				fillColor: "rgba(0,0,0,0.3)", // UI.color.rgba(data.color, 0.2),
				strokeColor: "rgba(0,0,0,0.3)",
				pointColor: "rgba(0,0,0,0.3)",
				pointStrokeColor: "transparent",
				pointHighlightFill: "#fff",
				pointHighlightStroke: "rgba(0,0,0,0.6)", // UI.color.rgba(data.color, 0.6),
				data: previousData(data.values, 7),
				borderDashOffset: 0.0,
			});
		}
		
		
		$(canvas).chartjs(graphs,{
			legend:{
				display: false,
			},
			height: (options.compact?100:150),
			 scales: {
				xAxes: [{
					display: false
				}],
				yAxes: [{
					display: false
				}]
			},
			legend: false,
			responsive: true
		});
		
		$.log(graphs);
		
		var html=getPrediction(objective, data, projection);
		$(canvas).closest('.side').find(".objbox.-prediction").html(html);
	};
	
	
	
	
	
	function getPrediction(objective, data, prediction){
		var expected=prediction.expected+"%";
		if (objective.plan && objective.plan.metatype=="kpi"){
			expected=AP.data.numberFormat(parseInt(prediction.expected))+objective.base.unit;
		}
		
		return "" +
				"<div class='infos'>" +
				"	<div class='row'>" +
				"		<span class='square top-left' style='background-color:"+data.color+"'></span> Tiáº¿n Ä‘á»™ thá»±c táº¿" +
				"	</div>" +
				"	<div class='row'>" +
				"		<span class='square top-left' style='background-color:#999'></span> Tiáº¿n Ä‘á»™ 07 ngĂ y trÆ°á»›c" +
				"	</div>" +
				"	<div class='row'>" +
				"		<span class='square top-left' style='background-color:"+prediction.color+"'></span> Tiáº¿n Ä‘á»™ dá»± bĂ¡o" +
				"	</div>" +
				"</div>" +
				"<div class='prediction'>" +
				"	<div class='title ap-xdot'>Dá»± bĂ¡o káº¿t quáº£ ("+AP.time.time("%d/%m/%Y", objective.deadline)+")</div>" +
				"	<div class='result' style='background-color:"+data.color+"'>"+expected+"</span>" +
				"</div>" +
			"";
	};
	
	
	
	
	function previousData(data, minus){
		var r=[];
		for (var i=0; i<minus; i++){
			r.push(null);
		}
		for (var i=minus; i<data.length; i++){
			r.push(data[i-minus]);
		}
		
		return r;
	};
	
	
	function calculateSectors(data) {
		var sectors = [];
		var l = data.size / 2
		var a = 0 // Angle
		var aRad = 0 // Angle in Rad
		var z = 0 // Size z
		var x = 0 // Side x
		var y = 0 // Side y
		var X = 0 // SVG X coordinate
		var Y = 0 // SVG Y coordinate
		var R = 0 // Rotation

		data.sectors.map(function(item, key) {
			a = 360 * item.percentage;
			aCalc = ( a > 180 ) ? 360 - a : a;
			aRad = aCalc * Math.PI / 180;
			z = Math.sqrt( 2*l*l - ( 2*l*l*Math.cos(aRad) ) );
			if( aCalc <= 90 ) {
				x = l*Math.sin(aRad);
			}
			else {
				x = l*Math.sin((180 - aCalc) * Math.PI/180 );
			}
			
			y = Math.sqrt( z*z - x*x );
			Y = y;

			if( a <= 180 ) {
				X = l + x;
				arcSweep = 0;
			}
			else {
				X = l - x;
				arcSweep = 1;
			}

			sectors.push({
				percentage: item.percentage,
				label: item.label,
				arcSweep: arcSweep,
				L: l,
				X: X,
				Y: Y,
				R: R,
				color: item.color
			});

			R = R + a;
		})


		return sectors
	};
};UI.table = new function __UITable(){
	this.sortable =function(table, options){
		$(table).find(options.header+" th").click(function(){
			var index=$(this).index();
		});
	};
};var Filter=new function __UIFilter(){
	this.opts={};
	this.name="";
	this.filters=[];
	this.id=null;
	
	this.init=function(opts){
		this.id=null;
		this.opts={};
		this.filters=[];
		opts=$.extend({}, {display: "dialog", color: 0}, opts);
		this.opts=opts;
		this.name="Bá»™ lá»c tĂ¹y chá»‰nh";
		this.color=opts.color;
		if (!parseInt(this.color)){
			this.color=AP.data.randomNumber(1,9);
		}
	};
	
	this.create=function(url){
		if (url && url.length){
			this.filters=loadFilterFromURL(url);
		}
		$(".js-custom-filter").remove();
		this.display();
	};
	
	this.edit=function(id, name, url, color){
		if (!color){
			color=0;
		}
		
		this.create(url);
		this.update({
			id: id,
			color: color,
			name: name,
			url: url
		});
	};
	
	
	this.editCurrent=function(){
		var id=Query.getInt("filter");
		if (id){
			var filter=AP.array.findObj(Client.pageData.filters, id);
			if (filter){
				this.edit(filter.id, filter.name, filter.url, filter.color);
			}
		}
	};
	
	
	this.display=function(){
		this.id=AP.uuid();
		
		if (this.opts.display=="dialog"){
			$("<div id='"+this.id+"' class='js-custom-filter ui-custom-filter'><div class='wrap'>"+this.getHTML()+"</div></div>").appendTo("#document");
		}
		
		initHandlers(this.id);
	};
	
	
	this.getHTML=function(){
		return this.getHeader() + this.getBody() + this.getFooter();
	};
	
	
	this.getHeader=function(){
		return "<div class='header'>" +
			"<div class='hidden'><input type='hidden' name='id' value='0'/></div>" +
			"<div class='hidden'><input type='hidden' name='color' value='"+this.color+"'/></div>" +
			"<div class='txt'><input type='text' name='name' placeholder='Chá»‰nh sá»­a bá»™ lá»c' value='Bá»™ lá»c tĂ¹y chá»‰nh'/></div>" +
			"<div class='edit-icon' onclick='Filter.focusEdit(this);'><span class='-ap icon-mode_edit'></span></div>" +
			"<div class='color'><div class='s -bg-alt"+this.color+"'></div></div>" +
			"<div class='close' onclick='Filter.close(this);'><span class='-ap icon-close'></span></div>" +
		"</div>";
	};
	
	
	this.getBody=function(){
		return "<div class='body'>" +
			"<div class='js-select-form'>"+getForm(this.opts)+"</div>" +
			"<div class='js-query'></div>"+
			"<div class='js-display'></div>"+
		"</div>";
	};
	
	
	this.getFooter=function(){
		return "<div class='footer'>" +
			"<div class='save'>LÆ°u</div>" +
		"</div>";
	};
	
	
	this.getQuery=function(){
		var html="";
		for (var i=0; i<this.filters.length; i++){
			html+="&"+buildQuery(this.filters[i]);
		}
		
		return html;
	};
	
	
	/**
	 * @desc Add a filter
	 */
	this.addFilter=function(ref){
		var $box=$(ref).closest(".js-select-form");
		var key=$box.find("select[name=select-custom]").val();
		var opt=$box.find("select[name=operator]").val();
		var val=safe($box.find("*[name=val]").val());
		
		var found=false;
		for (var i=0; i<this.filters.length; i++){
			if (this.filters[i].key==key && this.filters[i].operator==opt){
				found=true;
				this.filters[i].value=val;
			}
		}
		
		if (!found){
			this.filters.push({key: key, operator: opt, value: val});
		}
		
		this.render();
		
	};
	
	
	/**
	 * @desc Render a filter
	 */
	this.render=function(){
		$("#"+this.id+" .js-query").html("<div class='query'>"+this.getQuery()+"</div>");
		$("#"+this.id+" .js-display").html("<div class='display'>"+AP.render(this.filters, function(e){return getItem(e);})+"</div>");
	};
	
	this.hide=function(){
		$(".js-custom-filter").remove();
	};
	
	
	/**
	 * @desc Close a filter
	 */
	this.close=function(ref){
		$(ref).closest(".js-custom-filter").remove();
	};
	
	
	this.save=function(url, callback, extra_data){
		if (!extra_data){
			extra_data={};
		}
		
		extra_data.id=$("#"+this.id+" input[name=id]").val();
		extra_data.color=$("#"+this.id+" input[name=color]").val();
		
		UI.ajaxShow();
		var data= $.extend({}, extra_data, {filter_name: $("#"+this.id+" .txt input[name=name]").val(), filter_url: this.getQuery()}, getAssoc(this.filters));
		
		AP.post(url, data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code, data);
		});
	};
	
	
	this.remove=function(url, callback, extra_data){
		this.save(url, callback, extra_data);
	};
	
	
	this.update=function(opts){
		$("#"+this.id+" .header input[name=name]").val(opts.name);
		$("#"+this.id+" .header input[name=id]").val(opts.id);
		
		if (opts.color){
			this.color=opts.color;
			$("#"+this.id+" .header input[name=color]").val(this.color);
			$("#"+this.id+" .header .color .s").replaceWith("<div class='s -bg-alt"+this.color+"'></div>");
		}
		
		
		this.render();
		
		if (opts.id && !$("#"+this.id+" .footer .remove").length && this.opts.remove){
			$("#"+this.id+" .footer").append("<div class='cancel'>XĂ³a</div>");
			$("#"+this.id+" .footer .cancel").click(function(){
				AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n xĂ³a bá»™ lá»c nĂ y?", function(){
					Filter.opts.remove();
				});
			});
		}
	};
	
	
	this.focusEdit=function(ref){
		$(ref).closest(".header").find("input[name=name]").focus();
	};
	
	
	this.removeFilterItem=function(key, ref){
		this.filters=AP.array.filter(this.filters, function(e){
			return e.key!=key;
		});
		
		this.render();
	};
	
	
	function initHandlers(id){
		$("#"+id+" input[name=name]").on("focus", function(){
			$(this).closest(".header").addClass("active")
		}).on("blur", function(){
			$(this).closest(".header").removeClass("active")
		});
		
		$("#"+id+" select[name=select-custom]").on("change", function(){
			var val=$(this).val();
			if (!val || !val.length){
				$(this).closest(".select-fx").find(".js-select-create").empty();
			}else{
				var $box=$(this).closest(".select-fx").find(".js-select-create");
				
				var filter=AP.array.find(Filter.opts.filters, function(e){
					return e.key==val;
				});
				
				if (!filter){
					return;
				}
				
				var operators="<option value='equal'>Báº±ng</option>";
				
				if (filter.type=="number"){
					operators="<option value='equal'>Báº±ng</option>" +
					"<option value='not'>KhĂ´ng báº±ng</option>" +
					"<option value='min'>Lá»›n hÆ¡n</option>" +
					"<option value='max'>Nhá» hÆ¡n</option>";
				}
				
				if (filter.type=="match"){
					operators="<option value='match'>PhĂ¹ há»£p</option>";
				}
				
				if (filter.type=="equal"){
					operators="<option value='equal'>Báº±ng</option><option value='not'>Báº±ng</option>";
				}
				
				var val="<input type='text' name='val' placeholder='Nháº­p giĂ¡ trá»‹'/>";
				if (filter.role=="date"){
					val="<input type='text' name='val' placeholder='Nháº­p giĂ¡ trá»‹' data-role='date'/>"
				}
				
				if (filter.role=="user"){
					val="<input type='text' name='val' placeholder='Nháº­p giĂ¡ trá»‹' data-role='tag'/>"
				}
				
				if (filter.options){
					var opts_html="";
					if (AP.data.isArray(filter.options)){
						opts_html = AP.render(filter.options, function(e){
							return "<option value='"+e.value+"'>"+e.label+"</option>";
						});
					}else{
						$.each(filter.options, function(key, val){
							opts_html+="<option value='"+key+"'>"+val+"</option>";
						});
					}
					val="<select name='val'>"+opts_html+"</select>";
				}
				
				$box.html("<div class='select'>" +
					"	<select name='operator'>" + operators +"</select>" +
					"</div>" +
					"	<div class='input -val'>" + val + "</div>" +
					"	<div class='button' onclick='Filter.addFilter(this);'>ThĂªm</div>");
				
				Form.render($box);
			}
		});
		
		$("#"+id+" .footer .apply").click(function(){
			Filter.opts.search(Filter.filters, Filter.getQuery(), Filter);
		});
		
		$("#"+id+" .footer .save").click(function(){
			// Filter.opts.save(Filter.filters, Filter.getQuery(), Filter);
			Filter.opts.save();
		});
		
		Form.inlineColorTagger("#"+id+" .color", function(color){
			$("#"+id+" .color .s").removeClass().addClass("s -bg-alt"+color);
			$("#"+id+" input[name=color]").val(color);
		},{
			auto: true,
			left: -5
		});
	};
	
	
	function getForm(opts){
		return "<div class='select-fx'>" +
			"<div class='select-top'><select name='select-custom'>" +
				"<option value=''>--- Chá»n bá»™ lá»c ---</option>" +
				AP.render(opts.filters, function(e){
					return "<option value='"+e.key+"'>"+e.name+"</option>";
				})+
			"</select></div>" +
			"<div class='select-create clear-fix js-select-create'></div>" +
		"</div>";
	};
	
	
	function buildQuery(q){
		if (q.operator=="min"){
			return q.key+"_min="+q.value;	
		}
		
		if (q.operator=="max"){
			return q.key+"_max="+q.value;	
		}
		
		if (q.operator=="not"){
			return q.key+"_not="+q.value;	
		}
		
		return q.key+"="+q.value;
	};
	
	
	function getItem(q){
		var txt="";
		if (q.operator=="min"){
			txt= "<b>"+q.key+"</b> <em>lá»›n hÆ¡n</em> <span class='val'>"+q.value+"</span>";	
		}else if (q.operator=="max"){
			txt= "<b>"+q.key+"</b> <em>nhá» hÆ¡n</em> <span class='val'>"+q.value+"</span>";	
		}else if (q.operator=="match"){
			txt= "<b>"+q.key+"</b> <em>phĂ¹ há»£p</em> <span class='val'>"+q.value+"</span>";
		}else if (q.operator=="not"){
			txt= "<b>"+q.key+"</b> <em>khĂ´ng báº±ng</em> <span class='val'>"+q.value+"</span>";
		}else{
			txt= "<b>"+q.key+"</b> <em>báº±ng</em> <span class='val'>"+q.value+"</span>";
		}
		
		
		return "<div class='item' onclick=\"Filter.removeFilterItem('"+q.key+"');\">"+txt+" <div class='remove' title='XĂ³a bá»™ lá»c nĂ y'><span class='-ap icon-close'></span></div></div>";
	};
	
	
	function getAssoc(arr){
		var r={};
		for (var i=0; i<arr.length; i++){
			r[arr[i].key]=arr[i].value;
		};
		
		return r;
	};
	
	
	function loadFilterFromURL(url){
		var r=[];
		var parts=AP.word.split("&",url);
		for (var i=0; i<parts.length; i++){
			var ps=AP.word.split("=", parts[i]);
			if (ps.length!=2){
				continue;
			}
			
			var key=ps[0];
			var val=ps[1];
			
			if (AP.word.suffix(key,"_min")){
				$.log([key, val]);	
			}
			
			if (AP.word.suffix(key,"_min")){
				key=key.substr(0, key.length-4);
				r.push({
					key: key,
					operator: "min",
					value: val
				});
			}else if (AP.word.suffix(key,"_max")){
				key=key.substr(0, key.length-4);
				r.push({
					key: key,
					operator: "max",
					value: val
				});
			}else{
				r.push({
					key: key,
					operator: "match",
					value: val
				});
			}
		}
		
		return r;
	};
	
};var CONFIG={
    name: "Base",
    email: "contact@base.vn",
    owner: "Base",
    home_src: "base.vn",
    domain:"base.vn",
    port: "1331",
    https_port: "1331",
    api: "message",
    fileViewerAPI: "https://file.base.local.basecdn.net"
};

if (parseInt(Client.env)){
	CONFIG.fileViewerAPI= "https://file.basecdn.net";
}


if (Client.base && Client.base.port){
	CONFIG.port=Client.base.port;
	CONFIG.https_port=Client.base.port;
}Array.prototype.remove = function() {
	var what, a = arguments, L = a.length-1, ax;
	var fn=a[L];
	while (L && this.length) {
		what = a[--L];
		while ((ax = AP.array.indexOf(this,what, fn)) !== -1) {
			this.splice(ax, 1);
		}
	}
	
	return this;
};	


if (!Array.prototype.map){
	Array.prototype.map=function(mapper){
		var a=[];
		var len=this.length;
		
		for (var i=0; i<len; i++){
			a.push(mapper(this[i], i, len));
		}
		
		return a;
	};
};

String.prototype.repeat = function(count) {
	if (count < 1) return '';
	var result = '', pattern = this.valueOf();
	while (count > 1) {
		if (count & 1) result += pattern;
		count >>= 1, pattern += pattern;
	}
	return result + pattern;
};


String.prototype.contains = function(q) {
	return (this.toLowerCase().indexOf(q.toLowerCase())!==-1);
};



String.prototype.isAlphaNumeric = function() {
  var regExp = /^[A-Za-z0-9]+$/;
  return (this.match(regExp));
};


String.prototype.br2nl=function(){
	return this.replace(/(\r\n|\n\r|\r|\n)/g,'').replace(/<br>/g, "\r\n").replace(/<br\s*\/*>/g, "\r\n");
};

String.prototype.nl2br=function(){
	return this.replace(/(\r\n|\n\r|\r|\n)/g,"\n").replace(/\n/g, "<br>");
};


String.prototype.toTextarea=function(){
	return this.replace(/&#8220;|&#8221;|&#8216;|&#8217;/g,"'").replace("&#8217;","'").replace("&#8216;","'").br2nl();
};


function copyObject(obj, keys){
	var r={};
	var vars=AP.word.split(",", keys);
	for (var i=0; i<vars.length; i++){
		var index=$.trim(vars[i]);
		if (index && index in obj){
			r[index]=obj[index];
		}
	}
	return r;
};


function name(username){
	if (AP.data.isObject(username)){
		if (Client.system && Client.system.settings && Client.system.settings.name=="username"){
			return username.name;
		}
		
		return "@"+username.username;
	}
	
	var user=__getUserByUsername(username);
	if (!user){
		return "@"+username;
	}else{
		return user.name+"";
	}
};

function fullname(username){
	var user=People.get(username);
	if (!user){
		return "@<b class='url username' data-username='"+username+"'>"+username+"</b>";
	}
	
	return "<b class='url username' data-username='"+username+"'>"+user.name+"</b> <b class='url username' data-username='"+username+"'>@"+username+"</b> ("+user.title+")";
};


function fullnames(list){
	var html="";
	for (var i=0; i<list.length; i++){
		var username=list[i];
		if (AP.data.isObject(list[i])){
			username=list[i].username;
		}
		
		html+="<li>"+fullname(username)+"</li>";
	}
	
	return "<ul>"+html+"</ul>";
}


function __getUserByUsername(username){
	if (!Client.usernames){
		Client.usernames={};
		for (var i=0; i<Client.people.length; i++){
			Client.usernames[Client.people[i].username]=Client.people[i];
		}
	}
	
	if (Client.usernames[username]){
		return Client.usernames[username];
	}
	
	return null;
};


var cd_temp_timer=null;

AP.confirmDelete=function(msg, callback, opts){
	if (!opts){
		opts = {};
	}
	
	function doCount(){
		cd_temp_timer=setTimeout(function(){
			var $b=$("#confirm-delete-box .button.danger span");
			if (!$b.length){
				return;
			}
			
			var v=$b.data("count");
			if (!v){
				$b.hide();
				$b.parent().addClass("ready");
			}else{
				v=parseInt(v);
				$b.html(" ("+v+")");
				$b.data("count", v-1);
			}
			
			doCount();
		}, 1000);
	};
	
	var title = opts.title || "If you decide and confirm to delete, the data (and several linked data) WILL BE REMOVED AND WILL NOT be <u>recoverable</u>";
	var header = opts.header || "Dangerous Action";
	var html="<div id='confirm-delete-box'> <div class='icon'><img src='"+(Client.share_url)+"/svgs/alert.svg'/></div> <div class='cd-title'>"+(header)+"</div> <div class='cd-explain'>"+(title)+"</div> <div class='cd-explain-more'>"+(msg)+"</div> <div class='buttons'> <div class='button cancel left' onclick='AP.hideCustomDialog(\"#confirm-delete\")'>Cancel</div> <div class='button danger right'>"+(opts.button||'Confirm to delete')+"<span data-count='6'> (6)</span><div> </div> </div>";
	
	if (cd_temp_timer){
		clearTimeout(cd_temp_timer);
		temp_timer=null;
	}
	
	
	AP.customDialog(html, "confirm-delete").style("-full -strong-alert").closable(false).width(600).show();
	$("#confirm-delete-box .button.danger").data("action", callback).on("click", function(){
		if (!$(this).hasClass("ready")){
			return;
		}
		
		var fn=$(this).data("action");
		if (!fn){
			return;
		}
		
		AP.hideCustomDialog("#confirm-delete");
		fn();
	});
	
	doCount();
};





AP.critical=function(opts, callback){
	function doCount(){
		cd_temp_timer=setTimeout(function(){
			var $b=$("#confirm-delete-box .button.danger span");
			if (!$b.length){
				return;
			}
			
			var v=$b.data("count");
			if (!v){
				$b.hide();
				$b.parent().addClass("ready");
			}else{
				v=parseInt(v);
				$b.html(" ("+v+")");
				$b.data("count", v-1);
			}
			
			doCount();
		}, 1000);
	};
	
	var icon = opts.icon || "<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M16.143 2l5.857 5.858v8.284l-5.857 5.858h-8.286l-5.857-5.858v-8.284l5.857-5.858h8.286zm.828-2h-9.942l-7.029 7.029v9.941l7.029 7.03h9.941l7.03-7.029v-9.942l-7.029-7.029zm-6.471 6h3l-1 8h-1l-1-8zm1.5 12.25c-.69 0-1.25-.56-1.25-1.25s.56-1.25 1.25-1.25 1.25.56 1.25 1.25-.56 1.25-1.25 1.25z'/></svg>";
	var html="<div id='confirm-delete-box' class='-critical' style='background-color:"+(Color.get(opts.color))+"'> <div class='icon'> " +Render.render('icon', {icon:icon}, '')+ "</div> <div class='cd-title'>Critical Action</div> <div class='cd-explain'>"+(opts.title)+"</div> <div class='cd-explain-more'>"+(opts.message)+"</div> <div class='buttons'> <div class='button cancel left' onclick='AP.hideCustomDialog(\"#confirm-delete\")' style='color: "+(Color.get(opts.color))+"'>Cancel</div> <div class='button danger right'>"+(opts.button||'Confirm')+"<span data-count='6'> (6)</span><div> </div> </div>";
	
	if (cd_temp_timer){
		clearTimeout(cd_temp_timer);
		temp_timer=null;
	}
	
	
	AP.customDialog(html, "confirm-delete").style("-full -strong-alert -strong-critical").closable(false).width(600).show();
	$("#confirm-delete-box .button.danger").data("action", callback).on("click", function(){
		if (!$(this).hasClass("ready")){
			return;
		}
		
		var fn=$(this).data("action");
		if (!fn){
			return;
		}
		
		AP.hideCustomDialog("#confirm-delete");
		fn();
	});
	
	doCount();
};



AP.bindSearch=function(input){
	var qname=$(input).data("query");
	if (!qname){
		qname="q";
	}
	
	
	$(input).enter(function(){
		var val=$(this).val();
		var qname=$(this).data("query");
		if (!qname){
			qname="q";
		}
		
		var params = {page: null};
		
		
		if (val=="" || !val.length){
			params[qname] = null;
		}else{
			params[qname] = val;
		}
		
		
		AP.setURLParams(params, true);
	}).val(Query.get(qname)); 
	
	return $(input);
};



AP.bindAdvancedSearch = function(input, opts){
	opts = $.extend({offset: 5, width: 250}, opts);
	
	var $box=$(input).parent();
	var pos = $(input).position();
	var top = pos.top+$(input).height()+10+opts.offset;
	
	$(input).attr("autocomplete", "off");
	
	var list_opts = AP.render(opts.options, function(opt){
		if (opt.type == "sep"){
			return "<div class='adv-opt-sep'><em>"+(opt.label)+"</em></div>";
		}
		
		var icon = opt.icon;
		if (!icon || icon.length<24){
			icon = Render.helper.getIconByName(icon);
		}
		
		return "<div class='adv-opt -picon' data-action='"+(opt.url)+"'> <div class='adv-opt-icon'>"+(icon)+"</div> <div class='adv-opt-title'>"+(opt.label)+"</div> <div class='adv-opt-info'>"+(opt.sublabel)+"</div> </div>";
	});
	
	var uuid=AP.uuid();
	var html="<div class='adv-search-opts' style='left:"+(pos.left)+"px; top:"+(top)+"px; width:"+(opts.width)+"px' id='"+(uuid)+"'> <div class='adv-opts'>"+(list_opts)+"</div> </div>";
	
	$box.append(html);
	
	var $fbox=$("#"+uuid);
	$fbox.hide();
	
	$(input).on("input focus", function(){
		var val=$(this).val();
		
		if (val && val.length){
			$fbox.show();
		}else{
			$fbox.hide();
		}
		
	}).on("blur", function(){
		setTimeout(function(){
			$fbox.hide();
		}, 200);
	}).updown("#"+(uuid)+" .adv-opt", function(elem, index){
		$fbox.hide();
		var val=$(this).val();
		if (!val){
			return;
		}
		
		var action=$(elem).data("action");
		$(this).val("");
		return AP.toURL(""+(action)+"?q="+(val)+"");
	});

};



AP.xpost=function(url, data, callback){
	UI.ajaxShow();
	AP.post(Client.pageData.context.path+"/"+url, data, function(code){
		UI.ajaxHide();
		callback(code);
	})
};


AP.balanceDialog=function(id){
	AP.dialog(id).balance();
};

AP.customDialog=function(text, options){
	if (AP.data.isObject(text) && !options){
		return AP.customDialogV2(text);
	}
	
	var id="";
	if (!options){
		options={};
		id="custom-dialog";
	}else if (AP.data.isString(options)){
		id=options;
		options={};
	}
	
	if (id[0]=="#"){
		id=id.substr(1);
	}
	
	var opts=$.extend({}, {id: id, padding: true, close_button: false, closable: true}, options);
	
	var dialog= AP.dialog(opts.id)
	.engine(CustomDialogEngine)
	.closeButton(opts.close_button)
	.closable(opts.closable)
	.content(text);
	
	// if (!dialog.padding){
	// 	dialog.addClass("-full");
	// }
	
	if (options.fs){
		dialog.data("full", 1);
	}
	
	return dialog;
};


AP.customDialogV2=function(opts){
	opts=$.extend({
		id: "custom-dialog",
		width: 800,
		height: "auto",
		html: "",
		closable: false,
		close_button:true,
		title: "Custom dialog",
		padding: false
	}, opts);
	
	var dialog= AP.dialog(opts.id)
	.engine(CustomDialogEngine)
	.closeButton(opts.close_button)
	.closable(opts.closable)
	.width(opts.width)
	.title(opts.title)
	.content(opts.html);
	
	 if (!dialog.padding){
	 	dialog.addClass("-full");
	 }
	
	dialog.show();
	return dialog;
};



AP.hideCustomDialog=function(id, destroy_instance){
	if (!id){
		id="#custom-dialog";
	}
	
	if ($(id).closest(".__dialog").data("refresh")){
		return AP.xRefresh();
	}
	
	AP.dialog(id).hide();
	if (destroy_instance){
		$(id).closest(".__dialog").remove();
	}
};

AP.customCanvas=function(html, sticky){
	var closable=true;
	if (sticky){
		closable=false;
	}
	
	if (closable){
		return AP.customDialog(html).addClass("-full-canvas").closable(closable);	
	}else{
		return AP.customDialog(html).addClass("-full-canvas").closable(false); 
	}
};


AP.blankDialog=function(id){
	return AP.customDialog("<div id='"+id+"'></div>", {id: id+"-dx"}).addClass("-full-canvas -full-blank").closable(false).show();
};



AP.fsDialog=function(id){
	var opts=$.extend({}, {id: id+"-fs-dialog", padding: true, close_button: false}, opts);
	
	var dialog= AP.dialog(opts.id)
	.engine(FullscreenDialogEngine)
	.closeButton(false)
	.closable(true)
	.content("<div id='"+(id)+"'></div>");
	
	dialog.addClass("-full-canvas -full-blank").closable(false).show().balance();
	return dialog;
};


AP.emptyDialog=function(html, opts){
	var opts=$.extend({}, {id: "custom-dialog", padding: true, close_button: false}, opts);
	
	var dialog= AP.dialog(opts.id)
	.engine(EmptyDialogEngine)
	.closeButton(false)
	.closable(true)
	.content(html);
	
	dialog.addClass("-full-canvas -full-blank").closable(false).show().balance();
	return dialog;
};


AP.selectOne=function(title, html){
	AP.customDialog("<div class='title'>"+title+"<div class='-dx-close' onclick='AP.closeDialog(this);''></div></div>"+html,"custom-selection").style("-full").width(520).show();
};


AP.selectAction=function(actions, callback, opts){
	if (!opts){
		opts={};
	}
	
	var html=AP.render(actions, function(arr){
		if (arr._html){
			return "<div class='js-li li item unselectable' onclick='__selectItem(this);'>"+(arr._html)+"</div>";
		}
		
		if (arr.data && arr.data.type == "__sep"){
			return "<div class='js-li li-sep'>"+(arr.label)+"</div>";
		}
		
		var label="";
		if (arr.label){
			label="<div class='ap-xdot -name'>"+arr.label+"</div>";
		}
		if (arr.label_full){
			label="<div class='-name'>"+arr.label+"</div>";
		}
		
		var sub="";
		if (arr.sublabel){
			sub="<div class='sub'>"+arr.sublabel+"</div>";
		}
		return "<div class='js-li li item unselectable' onclick='__selectItem(this);'>"+label+sub+" <div class='-ricon'><span class='ficon-angle-right'></span></div></div>";
	});
	
	
	var mh=$(window).height()-200;
	if (mh<200){
		mh=200;
	}
	
	html="<div class='rh' style='max-height:"+mh+"px; overflow-y:auto;'><div class='list list-actions no-icon -border'>"+html+"</div></div>";
	
	if (opts.filter || opts.search){
		html="<div class='isearch'><input type='text' id='selection-filter-ip' placeholder='TĂ¬m nhanh'/></div>" +html;
	}
	
	if (opts && opts.title){
		html="<div class='title'>"+opts.title+" <div class='-dx-close' onclick='AP.closeDialog(this);'></div></div>"+html;
	}
	
	if (!Client.mobile){
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();	
	}else{
		AP.customDialog(html,"custom-selection").style("-full").show();
	}
	
	$("#custom-selection").data("object", actions).data("callback", callback).addClass("__canvas");
	if (opts.filter){
		$("#selection-filter-ip").on("input", function(){
			local_filter($(this).val());
		});
		if (!Client.native){
			$("#selection-filter-ip").autofocus();
		}
	}
	
	
	function local_filter(q){
		$("#custom-selection .li").each(function(){
			var matched=false;
			if (!q || !q.length){
				matched=true;
			}else{
				var str=$(this).text();
				matched= AP.word.fulltextMatch(str, q);
			}
			
			if (matched){
				$(this).show();
			}else{
				$(this).hide();
			}
		});
	};
};



AP.selectActions=function(actions, callback, opts){
	opts=$.extend({width: 600}, opts);
	
	var html=AP.render(actions, function(arr){
		var sub="";
		if (arr.sublabel){
			sub="<div class='sub'>"+arr.sublabel+"</div>";
		}
		var selected="";
		if (arr.selected){
			selected=" selected";
		}
		return "<div data-value='"+arr.value+"' class='li item unselectable"+selected+"' onclick='__selectItems(this);'> <div class='ap-xdot'>"+arr.label+"</div>"+sub+" <div class='-ricon'><span class='-select'></span></div></div>";
	});
	
	html="<div class='list list-actions no-icon -border -mlist'>"+html+"</div>";
	html+="<div class='buttons -two' style='border-top:2px solid #eee; margin:0; padding:20px; background-color:#f8f8f8;'> <div class='button -first -passive -rounded' onclick='AP.closeDialog(this);'>Cancel</div> <div class='button -second -success -rounded' onclick='__final_select_items(this);'>OK</div> </div>";
	
	if (opts && opts.title){
		html="<div class='title'>"+opts.title+"</div>"+html;
	}
	
	AP.customDialog(html,"custom-selection").style("-full selection-list").width(opts.width).show();
	$("#custom-selection").data("options", actions);
	$("#custom-selection").data("callback", callback);
	
	if (opts.selected){
		$("#custom-selection .li.item").each(function(){
			if (AP.array.contain(opts.selected, $(this).data("value"))){
				__selectItems(this);
			}
		});
	}
	
	if (opts.select_all){
		$("#custom-selection .li.item").each(function(){
			__selectItems(this);
		});
	}
	
	return;
};



AP.actionMenu=function(actions, opts){
	opts=$.extend({title: ""}, opts);
	
	var title="";
	if (opts.title && opts.title.length){
		title="<div class='title'>"+opts.title+"</div>"; 
	}
	
	AP.customDialog(title+"<div class='list list-actions -border'></div>","custom-selection").style("-full selection-list").width(400).show();
	
	AP.render(actions, function(e){
		var sublabel="";
		if (e.sublabel){
			sublabel="<small>"+e.sublabel+"</small>";
		}
		
		var icon="<span class='-ap icon-"+(e.icon)+"'></span>";
		if (AP.word.prefix(e.icon, "ficon-")){
			icon="<span class='ap-f14 "+(e.icon)+"'></span>";
		}else{
			
		}
		
		icon = "<span class='-icon'>"+(icon)+"</span>";
		
		if (AP.word.prefix(e.icon, "<") || AP.word.prefix(e.icon, " <")){
			icon = "<span class='-icon'>"+(e.icon)+"</span>";
		}
		

		var extra_data='';
		if (e.data){
			for (var key in e.data){
				if (AP.data.isString(e.data[key]) || AP.data.isInt(e.data[key])){
					extra_data+=" data-"+(key)+"='"+(e.data[key])+"'";	
				}
			}
		}
		
		var html="<div class='li item unselectable' "+(extra_data)+" onclick='__selfaction(this);'><span class='-icon'>"+(icon)+"</span> "+(e.label)+""+(sublabel)+" <div class='-ricon'><span class='ficon-angle-right'></span></div></div>";
		var id=AP.uuid();
		
		if (e.role=="url" || e.url){
			if (!AP.word.prefix(e.url,"http")){
				if (e.target && e.target=="blank"){
					html="<div class='li item unselectable url' "+(extra_data)+" onclick=\"AP.dialog('#custom-selection').hide()\" data-url='"+(e.url)+"' data-blank='1'>"+(icon)+" "+(e.label)+""+(sublabel)+" <span class='-ricon'><span class='ficon-angle-right'></span></span></div>";
				}else{
					html="<div class='li item unselectable url' "+(extra_data)+" onclick=\"AP.dialog('#custom-selection').hide()\" data-url='"+(e.url)+"'>"+(icon)+" "+(e.label)+""+(sublabel)+" <span class='-ricon'><span class='ficon-angle-right'></span></span></div>";	
				}
			}else{
				html="<a class='li item unselectable' "+extra_data+" target='_blank' href='"+e.url+"'><span class='-icon'><span class='-ap icon-"+e.icon+"'></span></span> "+e.label+sublabel+" <span class='-ricon'><span class='ficon-angle-right'></span></span></a>";	
			}
		}else if (e.role=="upload"){
			html="<div class='li item unselectable' id='"+id+"'><span class='-icon'><span class='-ap icon-"+e.icon+"'></span></span> "+e.label+sublabel+" <span class='-ricon'><span class='ficon-angle-right'></span></span></div>";
		}
		
		
		if (e.role=="upload"){
			$(html).appendTo("#custom-selection .list-actions").data("action", e.action).data("__params", e);
			AP.uploadable("#"+id, e.data, function(code){
				AP.dialog("#custom-selection").hide();
				e.callback(code);
			});
		}else{
			$(html).appendTo("#custom-selection .list-actions").data("action", e.action).data("__params", e);
		}
	});
	
	AP.dialog("#custom-selection").balance();
};



AP.boxMenu=function(actions, opts){
	opts=$.extend({title: ""}, opts);
	
	var title="";
	if (opts.title && opts.title.length){
		title="<div class='title'>"+opts.title+"</div>"; 
	}
	
	AP.customDialog(title+"<div class='list list-action-boxes -border'></div>","custom-selection").style("-full selection-list").width(602).show();
	
	AP.render(actions, function(e){
		var sublabel="";
		if (e.sublabel){
			sublabel="<small>"+e.sublabel+"</small>";
		}
		
		var icon="<div class='-icon'><img src='"+e.icon+"'/></div>";
		var label="<div class='label'>"+e.label+"</div>";
		
		var html="<div class='li js-item unselectable' onclick='__selfaction(this);'>"+icon + label+sublabel+"</div>";
		var id=AP.uuid();
		
		if (e.role=="url" || e.url){
			if (!AP.word.prefix(e.url,"http")){
				html="<div class='li js-item unselectable url' data-url='"+e.url+"'>"+icon+label+sublabel+"</div>";
			}else{
				html="<a class='li js-item unselectable' target='_blank' href='"+e.url+"'>"+icon+label+sublabel+"</a>";	
			}
		}else if (e.role=="upload"){
			html="<div class='li item unselectable' id='"+id+"'>"+icon+e.label+sublabel+"</div>";
		}
		
		
		if (e.role=="upload"){
			$(html).appendTo("#custom-selection .list-actions").data("action", e.action).data("__params", e);
			AP.uploadable("#"+id, e.data, function(code){
				AP.dialog("#custom-selection").hide();
				e.callback(code);
			});
		}else{
			$(html).appendTo("#custom-selection .list-action-boxes").data("action", e.action).data("__params", e);
		}
	});
	
	AP.dialog("#custom-selection").balance();
};




AP.pickable=function(canvas, options){
	if (!options){
		options={};
	}
	
	options=$.extend({}, {name: "file"}, options);
	
	options=$.extend({}, {name: options.name, format: 0, preview: 0, 'data': {}, multi: false}, options);
	var id=AP.uuid();
	var fid=AP.uuid();
	
	if (options.drive){
		$(canvas).click(function(){
			Base.drive.pick({multi: (options.multi?1:0), ext: 0, callback: function(files){
				options.callback.apply(this, [files]);
			}});
		});
		
		return;
	}
	
	if (!$(canvas).find(".upload-form").length){
		var html="<div class='upload-form'> <input type='file' name='"+(options.name)+"' id='"+(fid)+"' multiple/> </div>";
		$(canvas).append(html);	
	}else{
		$(canvas).find('.upload-form').empty().html("<input type='file' name='"+(options.name)+"' id='"+(fid)+"'/>");
	}
	
	$(canvas).find('.upload-form input').change(function(){
		var fn=getUploadFN($(this).val());
		options.callback.apply(this, [fn, this]); // YOU MUST REMOVE this
		AP.pickable(canvas, options);
	});
};


AP.uploadable=function(canvas, data, callback, $this){
	if (!data){
		data={};
	}
	
	data=$.extend({}, {name: 'file', format: 0, preview: 0, 'data': {}, multi: false}, data);
	
	if ($(canvas).hasClass('uploadable')){
		return;
	}
	
	if (data.drive){
		$(canvas).click(function(){
			var ext_val = 0;
			if (Client.system) {
				ext_val = 1;
			}
			Base.drive.pick({multi: (data.multi?1:0), ext: ext_val, callback: function(files){
				var temp=shallowClone(data.data);
				Base.drive.append(temp, files);
				
				UI.ajaxShow();
				AP.post(data.action, temp, function(code){
					UI.ajaxHide();
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					callback(code);
					
//					if ($this){
//						callback.apply($this, [code]);
//					}else{
//						callback(code);	
//					}
				});
			}
		})});
		
		return;
	}
	
	
	
	
	$(canvas).addClass('uploadable');
	var id=AP.uuid();
	var fid=AP.uuid();
	var upload_icon="";
	
	if ($(canvas).data('format')){
		upload_icon="<span class='upload-icon icm icon-upload2'></span>"
	}
	
	var name=$(canvas).data("name");
	if (!name){
		name=data.name;
	}
	
	if (!name){
		name="file";
	}

	var show_preview=0;
	
	var action=$(canvas).data('action');
	if (!action){
		action=data.action;
	}
	
	var image_required=0;
	if ($(canvas).data('image')==1 || $(canvas).data('image')=='1' || data.image == 1){
		image_required=1;
	}
	
	if ($(canvas).data('preview')==1 || $(canvas).data('preview')=='1' || data.preview==1){
		show_preview=1;
	}
	
	var placeholder="";
	if (data.placeholder){
		placeholder="<div class='upload-placeholder'>"+data.placeholder+"</div>";
	}
	
	
	
	if (!action || !action.length){
		var preview_image="<div class='upload-preview'></div>";
		if (data.preview_image && data.preview_image.length){
			preview_image="<div class='upload-preview'><img src='"+data.preview_image+"'/></div>";
		}
		
		$("<div class='upload-form'>" +
			placeholder +
			upload_icon +
			preview_image+
			"<input type='file' name='"+name+"' id='"+fid+"'/>" +
		"</div><div class='upload-fn'></div>").appendTo(canvas);
		
		
		$("#"+fid).change(function(){
			if ('FileReader' in window && this.files.length && image_required){
				
				if (!this.files[0].type.match('image.*')) {
					return AP.alertError("Please select an image");
				}
			}
			
			var fname=getUploadFN($(this).val());
			$(canvas).addClass("-selected").find(".upload-fn").html("<span class='ap-xdot'>"+AP.purify(fname)+"</span>");
			
			if (show_preview){
				if ('FileReader' in window && this.files.length){
					if (!this.files[0].type.match('image.*')) {
						return;
					}
					
					var reader=new FileReader;
					reader.onload=function(e){
						$(canvas).find(".upload-preview").html("<img src=''/>");
						$(canvas).find(".upload-preview img")[0].src=e.target.result;
					};
					reader.readAsDataURL(this.files[0]);
				}
			}
			
		});
		return;
	}
	
	
	var multi="";
	if (data.multi){
		multi=" multiple";
		$("<div class='upload-form'><form method='post' id='"+id+"' action='"+action+"'>" +
			"<input type='hidden' name='__multi' value='1'/>" +
			upload_icon+
			placeholder+
			"<input type='file' name='"+name+"[]' id='"+fid+"'"+multi+"/>" +
		"</form></div>").appendTo(canvas);
	}else{
		$("<div class='upload-form'><form method='post' id='"+id+"' action='"+action+"'>" +
			upload_icon+
			placeholder+
			"<input type='file' name='"+name+"' id='"+fid+"'/>" +
		"</form></div>").appendTo(canvas);
	}
	
	
	$("#"+fid).change(function(){
		var cid=$(this).closest('form').attr('id');
		$.log("FILE_CHANGED ...");
		
		AP.ajaxShow();
		AP.submit("#"+cid, function(code){
			AP.ajaxHide();
			
			$("#"+fid).val('');
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if ($this){
				callback.apply($this, [code]);
			}else{
				callback(code);	
			}
			
		}, data.data);
	});
};


AP.dnd_lock=false;
AP.dnd=function(canvas, url, data, callback, options){
	options=$.extend({}, {name: 'file', layout: 'white', image: 0, max_files: 5, multi: true}, options);
	
	var $canvas=$(canvas);
	if ($canvas.hasClass("js-dndcanvas")){
		return;
	}
	
	var id=AP.uuid();
	$canvas.addClass("js-dndcanvas").append("<div class='js-dndicanvas' id='"+id+"'></div>");
	var $cx=$("#"+id);
	
	if (!$canvas.length){
		$.log("DND failed. Cannot find the canvas");
		$.log([canvas, url, data]);
		return;
	}
	
	if ($canvas.find(".dnd-mask").length){
		return;
	}
	
	this.dnd_lock=false;
	
	id=AP.uuid();
	$("<div id='"+id+"' class='dnd-mask'>" +
		"<div style='display:none'>" +
		"	<form name='dnd-form' id='"+id+"-form' action='"+url+"'></form>" +
		"</div>" +
		"<div class='mask full-mask'></div>" +
		"<div class='cancel' onclick='dnd_cancel(this);'>" +
		"	<span class='-ap icon-uniF109'></span>" +
		"	<div class='text'>Cancel</div>" +
		"</div>" +
		"<div class='dnd-main'><div class='inner'>" +
		"	<div class='dnd-image'><img src='"+Client.share_url+"/messages/uploadbg.png'/></div>" +
		"	<div class='dnd-title'>Drop the file to start uploading ...</div>" +
		"</div></div>" +
	"</div>").appendTo($cx);
	
	var $box=$("#"+id);
	if (options.layout=='dark'){
		$box.addClass('-dark');
	}
	
	var supported = function() {
		  var div = $box[0];
		  return (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 'FormData' in window && 'FileReader' in window;
	}();
	
	if (!supported){
		$.log("FILE DRAG AND DROP DISABLED");
		return;
	}
	
	$canvas.on("dragstart dragover", function(e){
		var dt = e.originalEvent.dataTransfer;
		if (dt && dt.types && (dt.types.indexOf ? dt.types.indexOf('Files') != -1 : dt.types.contains('Files'))) {
			$cx.addClass('-dragover');
		}
	});
	
	$cx.on('drag dragstart dragend dragover dragenter dragleave drop', function(e) {
		e.preventDefault();
		e.stopPropagation();
	}).on("dragstart", function(e){
		$cx.addClass('-dragover');
	})
	.on('dragover dragenter', function(){
		$cx.addClass('-dragover');
	})
	.on('dragleave dragend', function(){
		$cx.removeClass("-dragover");
	})
	.on('drop', function(e) {
		$cx.removeClass('-dragover');
		var droppedFiles = e.originalEvent.dataTransfer.files;
		if (AP.dnd_lock || !droppedFiles.length){
			return;
		}
		
		if (options.confirm){
			return AP.confirm(options.confirm, function(){
				AP.dnd_lock=true;
				dnd_upload("#"+id+"-form", droppedFiles, function(code){
					AP.dnd_lock=false;
					callback(code);
				},data, options);
			});
		}
		
		
		AP.dnd_lock=true;
		dnd_upload("#"+id+"-form", droppedFiles, function(code){
			AP.dnd_lock=false;
			callback(code);
		},data, options);
	});
};


AP.fileExt = function(fname) {
	if (!fname) {
		return "";
	}
	var _fname = fname;
	if (fname.indexOf("?X-Goog-Algorithm") > 0) {
		_fname = fname.substring(0, fname.indexOf("?X-Goog-Algorithm"));
	}
	if (fname.indexOf("name=") > 0) {
		_fname = fname.substring(fname.indexOf("name="));
	}
	var regEx = /(?:\.([^.]+))?$/;
	return regEx.exec(_fname)[1];
};

function dnd_cancel(ref){
	$(ref).closest(".dnd-mask").parent().removeClass("-dragover");
};

function dnd_upload(form, files, callback, data, options){
	var $form=$(form);
	var formData=new FormData($form.get(0));
	
	for (var key in data){
		formData.set(key, data[key]);
	}
	
	for (var key in AP.ajax_data){
		formData.set(key, AP.ajax_data[key]);
	}
	
	
	formData.set("dnd", 1);
	formData.set("__code", Client.code);
	
	
	var nf=0;
	$.each(files, function(i, file) {
		if (nf > options.max_files){
			return;
		}
		
		
		if (options.image){
			var name=options.name+"-"+nf;
			if (!options.multi){
				name=options.name;
			}
			
			var imageType = /image.*/;
			if (file.type.match(imageType)) {
				formData.append(name, file, file.name);
				nf++;
			}else{
				
			}
		}else{
			var name=options.name+"-"+nf;
			if (!options.multi){
				name=options.name;
			}
			
			formData.append(name, file, file.name);
			nf++;
		}
	});
	
	formData.set("nf", nf);
	
	UI.ajaxShow();
	var url=$form.attr("action");
	if (!AP.word.isURL(url)){
		url=Client.ajax_url+"/"+url;
	}
	
	$.ajax({
		url: url,
		type: "POST",
		dataType: 'json',
		data: formData,
		processData: false,  // tell jQuery not to process the data
		contentType: false,   // tell jQuery not to set contentType,
		complete: function(){
			
		},
		success: function(data){
			UI.ajaxHide();
			var code = new Code(data);
			callback(code);
		},
		error: function(e){
			console.log(e);
			
			UI.ajaxHide();
			callback(new Code({code: 0, message: "Something wrong, or the file was too big"}));
		}
	});
	
};



function __selfaction(ref){
	var action=$(ref).data("action");
	if (action){
		AP.closeDialog(ref);
		var params=$(ref).data("__params");
		action(params);
	}else{
		AP.closeDialog(ref);
	}
};

function __selectItems(ref){
	$(ref).toggleClass('selected');
	var value=parseInt($(ref).data("value"));
	var saved=$(ref).hasClass("selected");
	
	var data=$("#custom-selection").data("options");
	
	data=AP.select(data, function(e){
		if (e.value && parseInt(e.value)==value){
			if (saved){
				e.selected=1;
			}else{
				e.selected=0;
			}
		}
		return e;
	});
	
	$("#custom-selection").data("options", data)
};



function __selectItem(ref){
	var index=$(ref).parent().find(".js-li").index(ref);
	
	var $canvas=$(ref).closest(".__canvas");
	var $fn=$canvas.data("callback");
	AP.closeDialog(ref);
	
	return $fn($canvas.data("object")[index]); 
};




function __final_select_items(ref){
	var $canvas=$(ref).closest(".__canvas");
	var data=$("#custom-selection").data("options");
	var $fn=$("#custom-selection").data("callback");
	
	data=AP.select(data, function(e){
		if (e.selected){
			return e;
		}
		return null;
	});
	
	$fn(data);
	AP.closeDialog(ref);
};




var CustomDialogEngine=new function __CustomDialogEngine(){
	
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		var close_button="";
		if (dialog._close_button){
			close_button="<div class='__close_button' onclick='AP.closeDialog(this);'><span class='-ap icon-close'></span></div>";
		}
		
		
		var closable="<div class='full-mask' onclick='AP.closeDialog(this);'></div>";
		if (!dialog._closable){
			closable="<div class='full-mask'></div>";
		}
		
		
		$(dialog.canvas()).append("" +
			"<div class='__customdialog' id='"+dialog.w(true)+"'>" +
				"<div class='__dialogwrapperscroller scroll-y forced-scroll'>"+
					closable +
					"<div class='__dialogwrapper'>" +
						"<div class='__dialogwrapper-inner'>" +
							"<div class='__dialogmain'>" +
								"<div class='__dialogtitle ap-xdot'>"+"&nbsp;</div>"+
								close_button+
								"<div class='__dialogcontent simple-form'></div>" +
							"</div>"+
						"</div>"+
					"</div>" +
					"<div class='clear'></div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		$(wid).css("right", $.sbWidth());
		
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').height()/2-45;
		
		if (!Client.native && !Client.mobile){
			var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
			$(wid+' .__dialogwrapper').css('left', l);
			
			if (t<50){
				t=50;
			}
		}else{
			if ($(wid).hasClass('-baseui-fit') || (dialog._data && dialog._data.full)){
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '100%'}).css({margin: 'auto'});
				t=0;
			}else{
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '90%'}).css({margin: 'auto'});
				
				if (t<50){
					t=0;
				}
				
			}
		}
		
		
		if (dialog._data && dialog._data.full){
			$(wid+' .__dialogwrapper').css('top', 0).css('bottom', 0);
		}else{
			$(wid+' .__dialogwrapper').css('top', t);	
		}
	};
};






var EmptyDialogEngine=new function __EmptyDialogEngine(){
	
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		var closable="<div class='full-mask' onclick='AP.closeDialog(this);'></div>";
		if (!dialog._closable){
			closable="<div class='full-mask'></div>";
		}
		
		$(dialog.canvas()).append("" +
			"<div class='__customdialog __emptydialog' id='"+dialog.w(true)+"'>" +
				closable +
				"<div class='__dialogwrapper'>" +
					"<div class='__dialogwrapper-inner'>" +
						"<div class='__dialogmain'>" +
							"<div class='__dialogcontent'></div>" +
						"</div>"+
					"</div>"+
				"</div>"+
			"</div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		var t=$(window).height()/2- $(wid+' .__dialogwrapper').outerHeight(true)/2-45;
		if (!Client.native && !Client.mobile){
			var l=$(window).width()/2- $(wid+' .__dialogwrapper').outerWidth(true)/2;
			$(wid+' .__dialogwrapper').css('left', l);
		}else{
			if (dialog._data && dialog._data.full){
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '100%'}).css({margin: 'auto'});				
			}else{
				$(wid+' .__dialogwrapper').css({float: 'none'}).css({width: '90%'}).css({margin: 'auto'});
			}

		}
		
		if (t<50){
			t=50;
		}
		
		
		if (dialog._data && dialog._data.full){
			$(wid+' .__dialogwrapper').css('top', 0).css('bottom', 0);
		}else{
			$(wid+' .__dialogwrapper').css('top', t);	
		}
	};
};




var FullscreenDialogEngine=new function __FSDialogEngine(){
	
	this.canvas=function(){
		return $("#apdialogs");
	};
	
	/**
	 * @desc Render the dialog.
	 */
	this.render=function(dialog){	
		var closable="<div class='full-mask' onclick='AP.closeDialog(this);'></div>";
		if (!dialog._closable){
			closable="<div class='full-mask'></div>";
		}
		
		$(dialog.canvas()).append("<div class='__fsdialog' id='"+(dialog.w(true))+"'> "+(closable)+" <div class='__dialogwrapper'><div class='__dialogcontent'></div></div> </div>");
	};
	
	
	/**
	 * @desc Balancing the dialog.
	 */
	this.balance=function(dialog){
		var wid=dialog.w();
		$(wid+" .__apdialog").css("right", $.sbWidth());
		return;
	};
};




function ife(cond, r, other){
	if (cond){
		return r;
	}
	
	if (other !== undefined){
		return other;
	}
	
	return '';
};












var styles = [
 'color: #2a91d6', 'display: block', 'margin: 5px 0', 'line-height: 40px', 'text-align: center', 
 'font-size: 22px', , 'font-weight: bold'
].join(';');

//http://baseinc.talent.vn/
console.log('%c Wow, you find us! Join Base.vn now >>> https://baseinc.talent.vn ', styles);
var Tag=new function __Tag(){
	this.use_context=1;
	this.__log_people=null;
	
	this.context=function(flag, people){
		this.use_context=flag;
		
		this.__log_people=null;
		if (flag && people){
			this.__log_people=people;
		}
	};
	
	this.people=function(){
		if (Client.pageData.context && this.use_context){
			if (Client.pageData.context.__people){
				return Client.pageData.context.__people;
			}
			
			if (this.__log_people){
				return this.__log_people;
			}
			
			Client.pageData.context.__people=AP.array.filter(Client.people, function(p){
				return hasUser(Client.pageData.context.followers, p) || hasUser(Client.pageData.context.owners, p); 
			});

			if (!Client.pageData.context.__people.length){
				return Client.people;		
			}
			
			return Client.pageData.context.__people;
		}
		
		return Client.people;
	};
	
	
	this.line=function(input){
		if (!$(input).length){
			return;
		}
		return $(input).apcomplete('api/tag/user', true);
	};
	
	
	this.singleUser=function(input, array){
		if (!$(input).length){
			return;
		}
		
		$(input).data("single-tag", 1);
		
		this.user(input, array);
	};

	
	this.user=function(input, array, callback){
		if (!$(input).length){
			return;
		}
		
		
		$(input).attr('autocomplete', 'off');

		if (AP.data.isInt(array) || array=="auto"){
			var id=array;
			if (array=="auto"){
				id=0;
				if (Client.data.network){
					id=Client.data.network.id;
					alert(id);
				}
			}
			
			return $(input).each(function(){
				$(this).tag(Client.people, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					var str="";
					if (item && item.keywords){
						str+=item.keywords;
					}
					
					if (item && item.name){
						str+=item.name;
					}
					
					item.__keywords=str;
					
					if (AP.word.fulltextMatch(str, q) && (!id || AP.array.contain(item.networks, id))){
						if (!item.value){
							item.value="@"+item.username;
						}
						
						return true;
					}
					
//					if (item && item.name && item.name.toLowerCase().indexOf(q.toLowerCase())>-1 && (!id || AP.array.contain(item.networks, id))){
//						if (!item.value){
//							item.value="@"+item.username;
//						}
//						
//						return true;
//					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		
		if (array && array.length){
			return $(input).each(function(){
				$(this).tag(array, function(item){
					return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
				}, function(item, q){
					if (!item.value){
						item.value="@"+item.username;
					}
					
					var keywords=item.__keywords;
					var qf=purify(q.toLowerCase()).replace(/[\s\-]/g,'');
					
					if (!keywords){
						keywords=item.name;
						if (item.keywords){
							keywords+=item.keywords;
						}
						
						if (item.name){
							keywords+=item.name;
						}
						
						if (item.name){
							keywords+=item.title;
						}
						
						keywords=purify(keywords.toLowerCase()).replace(/[\s\-]/g,'');
						item.__keywords=keywords+' ';
					}
					
					if (keywords && keywords.indexOf(qf)!=-1){
						return true;
					}
					
					return false;
				}, function(item, q){
					return Tag.order_fn(item, q);
				}, callback);
			});
		}
		
		
		return $(input).each(function(){
			$(this).tag('api/tag/user', function(item){
				return "<span class='image'><img src='"+AP.xthumb(item.gavatar)+"'></span> <span class='block ap-xdot'><span class='bold'>"+item.value+"</span> &middot; <span class='sub'>"+item.name+" &middot; "+___(item.title,"<em>No official title</em>")+"</span></span>";
			}, function(value, q){
				if (value && value.length && value.toLowerCase().indexOf(q.toLowerCase())>-1){
					return true;
				}
				return false;
			}, function(item, q){
				return Tag.order_fn(item, q);
			});
		});
	};
	
	
	
	this.team=function(input){
		var sources=AP.select(Client.units, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this=$(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value);
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});
	};
	
	
	this.teamOptions=function(){
		var sources=AP.render(Client.units, function(e){
			if (e.metatype=="user"){
				return "";
			}
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		});
		
		sources="<option value='0'>-- Select team --</option>"+sources;
		
		return sources;
	};
	
	
	this.teamSelect=function(selector, context){
		this.team(selector);
	};
	
	
	this.teamExtend = function(input){
		var sArray = Client.units;
		if (Client.units && Client.units.length){
			for(var i = 0; i < Client.units.length; i++) {
				var test = AP.array.findObj(Client.units, Client.units[i].id);
				if(test) {
				}else{
					sArray.push(Client.units[i]);
				}
			}
		}
		
		var sources = AP.select(sArray, function(e){
			return {id: e.id, path: e.path, label: "<b>"+e.name+"</b> /"+e.path, value: e.name+" (@"+e.path+")"}
		});
		
		return $(input).each(function(){
			var $this = $(this);
			return $(this).autocomplete({
				source: function(request,response){
					// delegate back to autocomplete, but extract the last term
					var q=ap_extractLast(request.term);
					if (q && q.length && q[0]=="@"){
						q=q.substr(1);
					}
					response($.ui.autocomplete.filter(sources, q));
				},
				focus: function() {
					// prevent value inserted on focus
					return false;
				},select: function( event, ui ) {
					var terms = $(this).val().split(/,\s*/);
					terms.pop();
					terms.push(ui.item.value );
					terms.push("");
					this.value=terms.join(", ");
					return false;
				}
			}).data("ui-autocomplete")._renderItem = function(ul, item) {
				return $("<li>").data("item.autocomplete", item).append("<a>" + item.label + "</a>").appendTo(ul);
			};
		});	
	};
	
	
	this.networkValues=function(teams){
		var text="";
		for (var i=0; i<teams.length; i++){
			text+=teams[i].name+" (@"+teams[i].path+"), ";
		}
		
		return text;
	};
	
	
	
	this.order_fn=function(item, q){
		q=q.toLowerCase();
		var username=item.username.toLowerCase();
		
		if (q==username){
			return 10;
		}
		
		if (username.indexOf(q)==0){
			return 9;
		}
		

		return 1;
	};
	
	
	
	
	function hasUser(users, user){
		return AP.array.contain(users, user, function(e, f){
			return e.username==f.username;
		});
	};
};
var Form = new function __Form(){
	this.render=function(canvas, options){
		if (!options){
			options={};
		}
		
		var $c=$(canvas);
		if ($c.data("role")=="material" || $c.data("role")=="flat" || options.role=="flat"){
			$c.materialForm();
		}
		
		$c.find(".select-m").each(function(){
			var $this=$(this);
			$this.find(".option").each(function(){
				setMState(this);
				
				$(this).click(function(){
					updateMState(this);
				});
			});
		});
		
		$c.find("input, select, textarea").each(function(){
			var tagname=$(this)[0].nodeName.toLowerCase();
			if (tagname=="select"){
				var val=$(this).data("value");
				if (val===null || typeof val=="undefined" || val===""){
				}else{
					$(this).val(val);
				}
			}
			
			if ($(this).is(':checkbox')){
				var val=$(this).data("value");
				if (val==1 || parseInt(val)==1){
					$(this).prop("checked", true);
				}else{
					$(this).prop("checked", false);
				}
				
				return;
			}
			
			if ($(this).data("cid")){
				if (tagname=="input" || tagname=="textarea"){
					var val=$(this).data("value");
					if (val===null || typeof val=="undefined"){
					}else{
						$(this).val(val);
					}
				}
			}
			
			if (tagname=="textarea"){
				if ($(this).data("autoexpand") || $(this).data("autoextend")){
					$(this).autoExpand();
				}
			}
			
			if ($(this).data("unit")){
				var unit=$(this).data('unit');
				var icon="<span class='unit-text' style='position: absolute; right:10px; top:9px; color:#aaa; font-size:12px; text-transform:uppercase'>"+(unit)+"</span>";
				$(this).parent().append(icon);
			}
			
			if ($(this).data("label") && tagname=="input"){
				var label=$(this).data('label');
				var icon="<span style='position: absolute; display:none; right:10px; top:9px; color:#aaa; font-size:12px;' class='unit-text js-input-xlabel'>"+(label)+"</span>";
				$(this).parent().append(icon);
				$(this).on("input focus", function(){
					var v=$(this).val();
					if (v && v.length){
						$(this).parent().find(".js-input-xlabel").show();
					}else{
						$(this).parent().find(".js-input-xlabel").hide();
					}
				}).trigger("input");
			}
			
			var role=$(this).data("role");
			if (!role || !role.length){
				return;
			}
			
			if (role=="markdown"){
				return $(this).markdownEditor();
			}
			
			if (role=="date"){
				var val=$(this).data("value");
				if (val){
					$(this).data("ts", val);
				}else{
					val=$(this).val();
					if (val && val.length && AP.data.isInt(val)){
						$(this).data("ts", val);	
					}	
				}
				
				$(this).attr("autocomplete", "off");
				return $(this).selectDate();
			}
			
			if (role=="drive"){
				Base.drive.init(this, $(this).data("multi"));
			}
			
			if (role=="editor"){
				var height=$(this).data("height");
				if (!height){
					height=200;
				}
				
				return UI.editor(this,{
					minHeight: height
				});
			}
			
			if (role=="day" && tagname=="select"){
				var opts="<option> -- Chá»n ngĂ y --</option>";
				for (var i=1; i<=31; i++){
					opts+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
				}
				$(this).html(opts);
			}
			
			
			if (role=="month" && tagname=="select"){
				var opts="<option> -- Chá»n thĂ¡ng --</option>";
				for (var i=1; i<=12; i++){
					opts+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
				}
				$(this).html(opts);
			}
			
			
			if (role=="year" && tagname=="select"){
				var opts="<option> -- Chá»n nÄƒm --</option>";
				for (var i=2015; i>1960; i--){
					opts+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
				}
				$(this).html(opts);
			}
			
			if (role=="time"){
				return $(this).selectTime();
			}
			
			if (role=="teams"){
				return Tag.team(this, $(this).data("context"));
			}
			
			if (role=="team"){
				return Tag.teamSelect(this, $(this).data("context"));
			}

			if (role=="users" || role=="tag"){
				var context=$(this).data("context");
				if (context && context=="global"){
					return Tag.user(this, Client.people);
				}
				
				if (context){
					return Tag.user(this);
				}else{
					return Tag.user(this, Tag.people());
				}
			}
			
			if (role=="user"){
				Tag.singleUser(this, Tag.people());
			}
			
			
			if (role=="int"){
				return better_int_enter($(this));
			}

		});
		
		$c.find("input, select, textarea").each(function(){
			var tagname=$(this).tagName();
			if ($(this).data("display")==1){
				var v=$(this).val();
				if (tagname=="select"){
					v=$(this).find("option:selected").text();
				}
				
				if (v===null || v==""){
					v="--- &nbsp;";
				}
				
				if (tagname=="textarea"){
					v=v.nl2br();
				}
				
				if ($(this).attr("type")=="hidden"){
					return;
				}
				
				$(this).hide().after("<div class='vd' data-name='"+$(this).attr('name')+"' title='"+tagname+"'>"+v+"</div>");
			}
		});
		
		$c.find(".js-select-tags").each(function(){
			
		});
		
	};
	
	this.edit=function(options, callback){
		options=$.extend({},{type: "input","name":"input", "button":"Edit now","placeholder":"content", data:{}, editor: 0}, options);
		options.callback=callback;
		
		var id=AP.uuid();
		var style='';
		if (options.height){
			style='height: '+options.height+"px;";
		}
		
		var title='<br>';
		if (options.title){
			title="<div class='bold ap-f18 center'>"+options.title+"</div><br>";
		}
		
		if (!options.content){
			options.content='';
		}
		
		if (!options.editor){
			options.content=safe(options.content);
			options.content=options.content.replace(/\{\{\@([a-zA-Z0-9]+)\}\}/g,'@$1');
		}else{
			
		}		
		
		
		var html="<form id='"+id+"' action='"+options.action+"'>" +title+
				"<textarea class='__input' name='"+options.name+"' placeholder='"+options.placeholder+"' style='"+style+"'>"+options.content+"</textarea>" +
				"<div class='buttons -two'>" +
				"	<div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this)'>Cancel</div>" +
				"	<div class='button -second -success -rounded' onclick='Form.editNow(this);'>"+options.button+"</div>" +
				"</div>" +
			"</form>";
		
		AP.customDialog(html).width(500).show();
		$("#"+id).data("object", options).find(".__input").autofocus();
		
		if (options.editor){
			UI.editor("#"+id+" textarea");
			$("#"+id+" textarea").closest('.trumbowyg-box').css("border","1px solid #ddd");
		}
	};
	
	
	this.editNow=function(ref){
		var $form=$(ref).closest("form");
		var obj=$form.data("object");
		AP.ajaxShow();
		
		AP.submit($form, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.closeDialog(ref);
			obj.callback(code);
		},obj.data);
	};
	
	
	this.convert=function(data, filter){
		if (filter){
			var f=AP.array.filter(data, filter);
			
			return AP.array.select(f, function(e){
				if ("id" in e){
					return {label: e.name, value: e.id};
				}
				
				return {label: e.value, value: e.key};
			});
		}
		
		return AP.array.select(data, function(e){
			if ("id" in e){
				return {label: e.name, value: e.id};
			}
			
			return {label: e.value, value: e.key};
		});
	};
	
	this.create= function(id, options){
		return new UIForm(id, options);
	};
	
	
	this.pop=function(options){
		return new UIPopForm(options);
	};
	
	this.embed = function(form, opts){
		var html = "<div class='form form-inline> <form method='post' id='"+(form.__id)+"' action='"+(form.__options.action)+"'> <div class='form-main'>"+(form.html())+"</div> <div class='form-buttons'></div> </form> </div>";
		
		$(opts.embed).html(html);
		
		form.update();
		if (opts.render){
			opts.render.apply(form, [form]);
		}
	};
	
	
	this.hide=function(ref){
		if (AP.data.isString(ref) && ref.charAt(0)!="#"){
			ref="#"+ref;
		}
		
		if (Client.native){
			var dx=$(ref).closest(".page");
			if (dx && dx.length){
				return Page.back();
			}
		}
		
		var dx=$(ref).closest(".__apdialog");
		if (dx && dx.length){
			AP.dialog("#"+dx.attr('id')).hide();	
		}
	};
	
	
	this.balance=function(ref){
		if (AP.data.isString(ref) && ref.charAt(0)!="#"){
			ref="#"+ref;
		}
		
		var dx=$(ref).closest(".__apdialog");
		if (dx && dx.length){
			AP.dialog("#"+dx.attr('id')).balance();	
		}
	};
	
	
	this.submit=function(ref, callback, data){
		if (!data){
			data={};
		}
		
		if (ref.charAt(0)!="#"){
			ref="#"+ref;
		}
		
		UI.ajaxShow();
		AP.submit(ref, function(code){
			UI.ajaxHide();
			callback(code);
		}, data);
	};
	
	
	this.submitFrom= function(ref, callback, data){
		if (!data){
			data={};
		}
		
		var form=$(ref).closest('form');
		if (!form || !form.length){
			$.log("No form can be founed.");
			return;
		}
		
		var id;
		
		if (!form.attr('id') || !form.attr('id').length){
			var tid=AP.uuid();
			form.attr('id',tid);
			id=tid;
		}else{
			id=form.attr('id');
		}
		
		id='#'+id;
		
		AP.ajaxShow();
		AP.submit(id, function(code){
			AP.ajaxHide();
			callback(code);
		}, data);
	};
	
	
	this.val=function(form, data){
		$("input, textarea, select", form).each(function(){
			var name=$(this).attr('name');
			if (name && name.length){
				if (!data[name]){
					data[name]="Not provided";
				}
				$(this).val(data[name]);
			}
		});
	};
	
	
	this.radioVal=function(canvas, name, preset_val){
		$(canvas).find(".li").each(function(){
			var name=$(this).data('name');
			var val=$(this).data('value');
			if (name.length){
				if (AP.data.equal(val, preset_val)){
					$(this).find(".radio-button").addClass('active');
				}
			}
		});
	};

	

	this.match=function(form, data){
		$("input, textarea", form).each(function(){
			var name=$(this).attr('name');
			if (name && name.length){
				if (!data[name]){
					data[name]="Not provided";
				}
				$(this).val(data[name]);
				$(this).hide();
				$(this).parent().addClass("real-display");
				$(this).after("<div class='real'>"+data[name]+"</div>")
			}
		});
	};
	

	
	this.objSelection=function(arr){
		return AP.array.select(arr, function(e){
			return {label: e.name, value:e.id};
		})
	};
	
	
	this.label= function(data){
		return new UILabel(data);
	};
	
	
	this.noLabel = function(){
		return new UILabel(null);
	};
	

	this.row=function(label, input){
		return new UIRow(label, input);
	};
	
	this.placeholder=function(id, raw_html, label){
		if (!raw_html){
			raw_html='';
		}
		
		return new UIRow(id, {raw_html: raw_html, __label: label||''}, "placeholder");
	};
	
	this.rowHidden=function(label, input){
		input.hidden=true;
		return new UIRow(label, input);
	};
	
	this.rowNone=function(label, input){}
	
	this.noRow=function(label){
		return new UIRow(label, null);
	};

	
	this.rowCustom=function(html, opts){
		return new UIRow(html, opts, "custom-html");
	};
	
	
	this.note=function(note, type){
		return (new UIRow(note, type,"note")).setType("note");
	};
	
	
	this.input=function(data){
		return new UIInput(data);
	};
	
	this.inputHTML=function(html){
		return new UIInputHTML(html);
	};
	
	this.inputGroup=function(data){
		return new UIInputGroup(data);
	};
	
	this.wrapper=function(label, id){
		return new UIRow(label, id, "wrapper");
	};

	
	this.inlineCleaner=function(canvas){
		$(canvas).click(function(e){
			$(canvas).find(".activated").each(function(){
				if ($.contains(this, e.target) || this==e.target || $(e.target).closest(".ui-datepicker-header").length){
				}else{
					$(this).removeClass("activated");
				}
			});
		});
	};
	
	
	this.inlineDatePicker=function(selector, callback, options){
		options=$.extend({
			clickOut: false,
			click: false,
			auto: true
		}, options);
		
		var id=AP.uuid();
		
		if ($(selector).hasClass("ap-inline-datepicker-wrap")){
			return;
		}else{
			$(selector).addClass("ap-inline-datepicker-wrap unselectable");
			$(selector).append("<div class='ap-inline-datepicker'><div class='ap-datepicker' id='"+id+"'></div></div>");
		}
		
		if (options.position){
			if (options.position.top){
				$(selector).find(".ap-inline-datepicker").css("top", options.position.top);
			}
			
			if (options.position.left){
				$(selector).find(".ap-inline-datepicker").css("left", options.position.left);
			}
			
			if (options.position.right){
				$(selector).find(".ap-inline-datepicker").css({"left": "auto", "right": options.position.right});
			}
		}
		
		
		var dd=0;
		if (options.value){
			dd=new Date(parseInt(options.value) * 1000);
		}
		
		$("#"+id).datepicker({
			firstDay: 1,
			defaultDate: dd,
			onSelect: function(dateText, inst){
				var day=new Date(dateText);
				var ms = day.valueOf();
				var s = Math.floor(ms / 1000);
				callback.call($(this).closest(".ap-inline-datepicker-wrap")[0], s);
				$("#"+id).closest(".ap-inline-datepicker-wrap").removeClass("activated");
			}
		});
	
		if (options.clickOut){
			$(selector).click(function(){
				$(this).toggleClass("activated");
			}).clickOut(function(){
				$(this).removeClass("activated");
			});
		}else{
			$(selector).data("__jsoptions", options);
			$(selector).click(function(e){
				if ($(e.target).closest(".ui-datepicker-header").length){
				}else{
					if (options.click){
						$(this).addClass("activated");
					}else if (options.auto){
						$(this).toggleClass("activated");
					}
				}
				
				if (!$(this).hasClass("activated")){
					var $box=$(this).closest(".ap-inline-datepicker-wrap");
					var opts=$box.data("__jsoptions");
					if (opts.hide){
						opts.hide.apply($box, []);
					}
				}
			});
		}
		
		if (options.click){
			$(selector).click();
			return;
		}
	};
	
	
	/**
	 * @desc Inline color selector
	 */
	this.inlineColorTagger=function(selector, callback, options){
		if (callback=="set"){
			
			$(selector).find(".ap-color").each(function(){
				var val=$(this).data("color");
				if (parseInt(val)==parseInt(options)){
					$(this).addClass("selected");
					$(this).siblings().removeClass("selected");	
				}
			});
			
			return;
		}
		
		
		if ($(selector).hasClass("ap-inline-colors-wrap")){
			
		}else{
			var colors=AP.render(range(0,9), function(e){
				return "<div class='ap-color -bg-alt"+e+"' data-color='"+e+"'></div>";
			});
			
			$(selector).addClass("ap-inline-colors-wrap unselectable").append("<div class='ap-inline-colors'>" +
				"<div class='apir'></div>" +
				"<div class='ap-inline-title'>Select color</div>" +
				"<div class='ap-inline-box'>"+colors+"</div>" +
			"</div>");
			
			$(selector).find(".ap-color").click(function(){
				var color=$(this).data("color");
				$(this).addClass("selected");
				$(this).siblings().removeClass("selected");
				
				if (callback){
					$(this).closest(".ap-inline-colors").hide();
					callback.call(this, color);
				}
			});
			
			if (options.auto){
				$(selector).click(function(e){
					if (!$(e.target).hasClass("ap-color")){
						$(this).find(".ap-inline-colors").toggle();	
					}
				});
				
			}
			
			if (options.left){
				$(selector).find(".ap-inline-colors").css({left: options.left}).find(".apir").css({left: -options.left+10});
			}
			
			if (options.click && !$(selector).hasClass("__inited")){
				$(selector).addClass("__inited").find(".ap-inline-colors").show();
			}
		}
	};
	
	
	this.inlineTagger=function(selector, options){
		if ($(selector).hasClass("ap-inline-tagger-wrap unselectable")){
			if (options.click){
				// $(selector).find(".-close").click();
				// $(selector).addClass("activated");
			}
			
			return;
		}
		
		options=$.extend({}, {label: "Nháº­p Ä‘á»ƒ tĂ¬m kiáº¿m", multi: false, users: Client.people}, options);
		var multi="multi";
		if (!options.multi){
			multi="single";
		}
		
		var users=AP.render(options.users, function(e){
			if (options.filter && !options.filter(e)){
				return "";
			}
			
			return "<div class='api-user' data-username='"+e.username+"' data-kw='"+e.name+" "+e.username+" "+e.title+"'>" +
				"<div class='avatar avatar-24 -circled'><div class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></div></div>" +
				"<div class='api-context'><div class='api-name'>"+e.name+"</div> <div class='api-info ap-xdot'>"+e.title+"</div></div>" +
			"</div>";
		});
		
		if (options.remove){
			users+="<div class='api-user' data-kw='' data-cancel='1'>" +
				"<div class='avatar avatar-24 -circled'><div class='c'><div class='-ap icon-close' style='padding-top:2px;'></div></div></div>" +
				"<div class='api-context'><div class='api-name'><div class='red normal' style='padding-top:4px'>XĂ³a</div></div></div>" +
			"</div>";
		}
		
		
		var id=AP.uuid();
		$(selector).addClass("ap-inline-tagger-wrap unselectable");
		
		var title="";
		if (options.title){
			title="<div class='api-title'>"+options.title+"</div>";
		}
		
		var footer="";
		if (options.footer){
			footer="<div class='api-footer'>"+(options.footer)+"</div>";
		}
		
		$(selector).append("<div class='-close full-mask'></div> <div class='ap-inline-tagger'><div id='"+id+"' class='ap-tagger is"+multi+"'>" +
			title +
			"<div class='api-sb'><input type='text' placeholder='"+options.label+"'/></div>" +
			"<div class='api-users'>"+users+"</div>" +
			footer+
		"</div></div>");
		
		
		
		
		if (options.width){
			$(selector).find(".ap-inline-tagger").css("width", options.width);
		}
		
		if (options.position){
			if (options.position.top){
				$(selector).find(".ap-inline-tagger").css("top", options.position.top);	
			}
			
			if (options.position.left){
				$(selector).find(".ap-inline-tagger").css("left", options.position.left);	
			}
			
			if (options.position.right){
				$(selector).find(".ap-inline-tagger").css({"right": options.position.right, left: "auto"});	
			}
		}
		
		$(selector).data("__jsoptions", options);
		$(selector).find(".-close").click(function(){
			$(this).parent().toggleClass("activated");
			
			if (!$(this).parent().hasClass("activated")){
				var $box=$(this).closest(".ap-inline-tagger-wrap");
				var opts=$box.data("__jsoptions");
				if (opts.hide){
					opts.hide.apply($box, []);
				}
			}
		});			
		
		
		$(selector).find(".api-user").on("click", function(){
			var cancel=$(this).data("cancel");
			if (cancel){
				var $box=$(this).closest(".ap-inline-tagger-wrap");
				var opts=$box.data("__jsoptions");
				opts.remove.apply($box, []);
				$(this).closest(".ap-inline-tagger-wrap").removeClass("activated");
				return;
			}
			
			var username=$(this).data("username");
			var user=People.get(username);
			if (user){
				options.select.apply($(this).closest(".ap-inline-tagger-wrap"), [user, $(this).closest(".ap-inline-tagger-wrap")]);
				$(this).closest(".ap-inline-tagger-wrap").removeClass("activated");
			}
		});
		
		
		if (options.search || $(selector).find(".api-sb").length){
			$(selector).find(".api-sb input").quickFilter($(selector).find(".api-users .api-user"),function($e, q){
				var kw=$e.data("kw").toLowerCase();
				return AP.word.fulltextMatch(kw, q);
			});
		}
		
		
		if (options.click){
			$(selector).find(".-close").click();
		}
	};
	
	
	

	this.inlineLabelTagger=function(selector, callback, options){
		options=$.extend({}, {label: "Type to search", multi: false, search: false, click: false, fill: false, multi: false}, options);
		
		if ($(selector).hasClass("ap-inline-tagger-wrap")){
			if (options.click){
				// $(selector).find(".-close").click();
			}
			return;
		}
		
		var multi="multi";
		if (!options.multi){
			multi="single";
		}
		
		var tags=AP.render(options.labels, function(e){
			if (options.filter && !options.filter(e)){
				return "";
			}
			
			if (options.render){
				return "<div class='js-tagitem' data-color='"+(e.color)+"' data-name='"+(e.name)+"' data-id='"+(e.id)+"' data-key='"+(e.key)+"'> "+(options.render(e))+" </div>";
			}
			
			return "<div class='api-tag js-tagitem' data-color='"+(e.color)+"' data-name='"+(e.name)+"' data-id='"+(e.id)+"' data-key='"+(e.key)+"'> <div class='square -bg-alt"+(e.color)+"'></div> <div class='api-context'><div class='api-txt'>"+(e.name)+"</div></div> </div>";
		});
		
		
		var id=AP.uuid();
		$(selector).addClass("ap-inline-tagger-wrap unselectable");
		
		
		var title="";
		if (options.title){
			title="<div class='api-title'>"+options.title+"</div>";
		}
		
		$(selector).append("<div class='-close full-mask'></div> <div class='ap-inline-tagger -compact'><div id='"+id+"' class='ap-tagger is"+multi+"'>" +
			title +
			(options.search?("<div class='api-sb'><input type='text' placeholder='"+options.label+"'/></div>"):"") +
			"<div class='api-tags'>"+tags+"</div>" +
		"</div></div>");
		
		if (options.width){
			$(selector).find(".ap-inline-tagger").css("width", options.width);
		}
		
		if (options.position){
			if (options.position.top){
				$(selector).find(".ap-inline-tagger").css("top", options.position.top);	
			}
			
			if (options.position.left){
				$(selector).find(".ap-inline-tagger").css("left", options.position.left);	
			}
			
			if (options.position.right){
				$(selector).find(".ap-inline-tagger").css({"right": options.position.right, left: "auto"});	
			}
		}
		
		if (!options.search) {
			if (!options.click){
				$(selector).find(".-close").click(function(){
					$(this).parent().toggleClass("activated");
				});	
			}else{
				$(selector).click(function(){
					$(this).toggleClass("activated");
				});
			}
		}
		
		$(selector).find(".js-tagitem").on("click", function(){
			// var item=$(this).closest(".ap-tag");
			
			if (!options.multi){
				$(this).closest(".ap-inline-tagger-wrap").removeClass("activated");	
			}else{
				$(this).toggleClass("selected");
			}
			
			callback.apply($(this).closest(".ap-inline-tagger-wrap"), [this]);
		});
		
		
		if (options.search){
			$(selector).find(".api-sb input").quickFilter($(selector).find(".api-tags .api-tag"),function($e, q){
				var kw=$e.data("name").toLowerCase();
				if (kw.indexOf(q.toLowerCase())!=-1){
					return true;
				}
				
				return false;
			});
		}
		
		if (options.selected && options.selected.length){
			$(selector).find(".js-tagitem").each(function(){
				var id=$(this).data("id");
				if (AP.data.isInt(id)){
					id=parseInt(id);
				}
				
				if (AP.array.contain(options.selected, id)){
					$(this).addClass("-selected");
				}
			});
		}
		
		if (options.click){
			$(selector).addClass("activated");
		}
	};
	
	
	
	this.editorEscape=function(content){
		content=AP.word.replaceAll('&#8221;', '\"', content);
		content=AP.word.replaceAll('&#8220;', '\"', content);
		content=AP.word.replaceAll('&#8216;', "'", content);
		
		content=AP.word.replaceAll('<br>', "\n", content);
		content=AP.word.replaceAll('"', '\"', content);
		
		return content;
	};
	
	
	
	function setMState(ref){
		var val=$(ref).data("value");
		var $input=$(ref).closest(".select-m").find("input");
		var vals=AP.word.split(",", $input.val());
		if (vals.indexOf(val)!=-1){
			active=1;
		}else{
			active=0;
		}
		
		$input.val(vals.join(","));
		
		if (active){
			$(ref).addClass("active");
		}else{
			$(ref).removeClass("active");
		}
	};
	
	
	function updateMState(ref){
		var val=$(ref).data("value");
		var $input=$(ref).closest(".select-m").find("input");
		var vals=AP.word.split(",", $input.val());
		var active=0;
		
		if (vals.indexOf(val)!=-1){
			vals=AP.array.remove(vals, val);
			active=0;
		}else{
			vals.push(val);
			active=1;
		}
		
		
		$input.val(vals.join(","));
		
		if (active){
			$(ref).addClass("active");
		}else{
			$(ref).removeClass("active");
		}
	};
};












function UIPopForm(options){
	options=$.extend({}, {id: 'popform','width': 800, label: 'Form dialog', closable: true}, options);
	this.options=options;
	this.formobj=null;
	this.html="";

	
	this.setForm=function(formObj){
		var inline="form-inline";
		if (formObj.__settings.block || Client.native || options.layout=="flat" ||  options.layout=="block" || Client.mobile){
			inline="";
		}
		
		if (Client.native){
			this.html="<div class='form form-dialog "+inline+"'><form method='post' id='"+formObj.__id+"' action='"+formObj.__options.action+"'><div class='form-main'><div class='form-scroll'>"+formObj.html()+"</div></div><div class='form-buttons'></div></form></div>";	
		}else{
			this.html="<div class='form form-dialog "+inline+"'><form method='post' id='"+formObj.__id+"' action='"+formObj.__options.action+"'>"+formObj.html()+"<div class='form-buttons'></div></form></div>";
		}
		
		
		this.formObj=formObj;
		return this;
	};
	
	this.show=function(){
		if (Client.mobile){
			this.options.width='100%';
		}
		
		if (Client.native){
			this.options.engine=FormDialogMobile;
			AP.dialog(this.options.id, FormDialogMobile)
			.title("<div class='title-1 ap-xdot'>"+this.options.label+"</div>")
			.content(this.html)
			.show();
		}else{
			if (this.options.sublabel){
				this.options.engine=FormDialogEngine2;
				AP.dialog(this.options.id)
				.engine(FormDialogEngine2)
				.width(this.options.width, AP.mobile)
				.title("<div class='title-1'>"+this.options.label+"</div><div class='title-2'>"+this.options.sublabel+"</div>")
				.content(this.html)
				.closable(this.options.closable)
				.show();
			}else{
				this.options.engine=FormDialogEngine;
				AP.dialog(this.options.id)
				.engine(FormDialogEngine)
				.width(this.options.width, AP.mobile)
				.title(this.options.label)
				.content(this.html)
				.closable(this.options.closable)
				.show();	
			}
		}
		
		

		
		this.placeButtons(this.formObj);
		this.update();
		if (this.formObj.__callback){
			(this.formObj.__callback).apply(this.formObj, [this.formObj]);
		};
		
		$("input, textarea","#"+this.formObj.__id).each(function(){
			var role=$(this).data("role");
			if (role=="date"){
				$(this).selectDate();
			}
			
			if (role=="time"){
				$(this).selectTime();
			}
			
			
			if (role=="teams"){
				Tag.teamExtend(this);
			}
			
			
			if (role=="int"){
				better_int_enter($(this));
			}
			
			if (role=="editor"){
				
			}
		});
		
		
		$(document).on("keypress", "#"+this.formObj.__id+" input", function(event){
			if (event.keyCode == 13) {
		        event.preventDefault();
		    }
		});
		
		if (this.options.layout=="flat"){
			$("#"+this.formObj.__id).parent().addClass("-flat");
			$("#"+this.formObj.__id).find(".input-fake, select").closest(".row").addClass("-active");
			$("#"+this.formObj.__id).find("input[type=file]").closest(".row").addClass("-active");
			$("#"+this.formObj.__id).find(".input.xflat").closest(".row").addClass("-active noflat");
			
			$("#"+this.formObj.__id).find("input, textarea").each(function(){
				if ($(this)[0].type=="file"){
					return;
				}
						
				var $temp=$(this).closest(".row");
				var phv=$(this).attr('placeholder');
				if (!phv || !phv.length){
					phv=false;
				}else{
					phv=true;
				}
				
				if ($temp.hasClass("noflat") || phv){
					$temp.addClass("-active");
					return;
				}
				
				$(this).focus(function(){
					$(this).closest(".row").addClass("-active");
				}).blur(function(){
					var val=$(this).val();
					if (!val || !val.length){
						$(this).closest(".row").removeClass("-active");	
					}
				});
				
				var val=$(this).val();
				if (val && val.length){
					$(this).closest(".row").addClass("-active");
				}
			})
		}
		
		return this;
	};
	
	
	
	this.closable=function(opt){
		AP.dialog(this.options.id).closable(opt)
		
		return this;
	};
	
	
	
	this.placeButtons=function(form){
		var html=form.renderButtons();
		var count="";
		var bcount=form.__buttons.length;
		if (bcount==1){
			count="-one";
		}
		if (bcount==2){
			count="-two";
		}
		if (bcount==3){
			count="-three";
		}
		$(".form-buttons", "#"+this.options.id).html(html).addClass(count);
		
		
		$(".form-buttons .button", "#"+this.options.id).each(function(index){
			var btn = form.getButton(index);
			
			$(this).data("action", btn.action);
			$(this).click(function(){
				var action=$(this).data("action");
				action(this);
			});
			
			if (btn.segment){
				$(this).addClass("url").data("feature", btn.segment);
			}
		});
	};
	
	this.update=function(){
		this.formObj.update();
		AP.dialog(this.options.id, this.options.engine).balance();
	};
	
	this.focus=function(name){
		this.formObj.focus(name);
		return this;
	};
	
	this.addClass=function(name){
		$("#"+this.options.id).closest(".__dialog").addClass(name);
		return this;
	};
	
	
};


function inputIntegerFormat(input){
	better_int_enter($(input));
};

function better_int_enter($input){
	$input.on("input", function(){
		var val=$(this).val();
		if (val.length && val.charAt(val.length-1)=="."){
			return;
		}
		
		var org_length = val.length;
		val=val.replace(/,/g,"");
		
		
		var caret = plugin_get_caret_position(this);

		if (AP.data.isNumber(val)){
			var decimal = $(this).data("decimal")||2;
			val=AP.data.numberFormat(val, decimal);
			var cur_length = val.length;
			
			$input.val(val);
			$input.setCursorPosition(caret + cur_length - org_length);
		}
	});
	
	// Directly set current value
	var val=$input.val();
	if (!val){
		return;
	}
	if (val.length && val.charAt(val.length-1)=="."){
		return;
	}
	
	val=val.replace(/,/g,"");
	
	if (AP.data.isNumber(val)){
		var decimal = $input.data("decimal")||2;
		val=AP.data.numberFormat(val, decimal);
		$input.val(val);
	}
};




Form.icon=new function __FormIcon(){
	// this.icons={"heartbeat":, "idea", "grow", "star",  "box", "book", "office", "paper", "health", "report", "alarm", "chart", "time", "connect", "todo", "contact", "folder", "pin", "tag","cart", "heart"};
	
	this.icons={"heartbeat": "Health", "h-square":"House", "heart":"Heart", "gittip": "Heart 2", "wpforms": "Note form", "delicious":"Square", "adn": "A label", "bandcamp": "Trepeziod", "google-wallet": "Wallet", "pie-chart": "Pie chart", "dot-circle-o": "Dot circle", "plane":"Plane", "sun-o":"Sunny", "adjust": "Contrast", "automobile": "Automobile", "bicycle": "Bicycle", "briefcase": "Briefcase", "bug": "Bug", "bus": "Bus", "cab": "Cab", "bullseye": "Bullseye", "cutlery": "Cutlery", "birthday-cake":"Birthday Cake", "fax":"Phone & Fax", "mortar-board": "Education", "plug": "Plug", "print": "Print", "recycle":"Recycle", "shopping-bag":"Shopping Bag", "support":"Life buoy", "tv":"Television", "truck": "Truck", "tree":"Tree", "video-camera":"Camrea", "train":"Train", "credit-card":"Credit card", "ticket":"Ticket"};
	this.fav_icons=range(1,60);
	
	
	this.render=function(options){
		return "<div class='input data pointer' onclick=\"$(this).toggleClass('active')\"'> <input id='"+options.id+"' type='text' name='"+options.name+"' placeholder='Click to select icon' readonly/> <div class='icon-display' style='position:absolute; font-size:14px; color:#aaa; right:0px; bottom:9px;'></div><div class='form-icons'>"+getIcons(this.icons)+"</div></div>";
	};
	
	
	this.renderFav=function(options){
		return "<div class='input data pointer' onclick=\"$(this).toggleClass('active')\"'> <input id='"+options.id+"' type='text' name='"+options.name+"' placeholder='Click to select icon' readonly/> <div class='icon-display' style='position:absolute; font-size:14px; color:#aaa; right:0px; bottom:9px;'></div><div class='form-icons'>"+getFavIcons(this.fav_icons)+"</div></div>";
	};
	
	
	this.inlinePicker=function(){
		var html="";
		for (var i=0; i<this.fav_icons.length; i++){
			var key = this.fav_icons[i];
			html+= "<div class='sx-icon' data-value='"+(key)+"' onclick='Form.icon.selectInline(this);'> <img style='width:16px; height:16px;' src='"+(Client.share_url)+"/fav_icons/"+(key)+".png'/> </div>";
		}
		
		return "<div class='sx-icons'>"+(html)+"</div>";
	};
	
	
	
	this.select=function(ref){
		var $canvas=$(ref).closest(".input");
		var v=$(ref).data("value");
		
		$canvas.find("input").val(v);
		$canvas.find(".icon-display").html("<span class='ficon-"+v+"'></span>");
	};
	
	
	this.selectInline=function(ref){
		var $this=$(ref);
		var v=$this.data("value");
		$this.closest(".inline-icon-picker").find(".icon-display").html("<img src='"+(Client.share_url)+"/fav_icons/"+(v)+".png'/>");
		$this.closest(".inline-icon-picker").removeClass("active");
		$this.closest(".inline-icon-picker").find("*[name=icon]").val(v);
	};
	
	
	/**
	 * @desc Icon +color + fill picker, v2
	 */
	this.v2 = function(opts){
		return "<div class='form-v2-icon-wrapper'><div id='"+(opts.id)+"' class='form-v2-icon'> <div class='hidden'> <input name='icon-icon' value='1'/> <input name='icon-fill'/> </div> <div class='form-v2-icon-display url' data-url=':active:parent'></div> <div class='form-v2-icon-canvas'> <div class='fic-body'> <div class='fic-icons'>"+(getIconsV2())+"</div> <div class='fic-side'> <div class='fic-subtitle'>Color</div> <div class='fic-color'><input class='color-picker' name='icon-color'/></div> <div class='sep-20'></div> <div class='fic-subtitle'>Content Fill</div> <div class='fic-fill'> <ul> <li data-value='solid' onclick='Form.icon.v2SetFill(this)'><div class='c -solid'></div> Solid</li> <li data-value='subtle' onclick='Form.icon.v2SetFill(this)'><div class='c -subtle'></div> Subtle</li> <li data-value='none' onclick='Form.icon.v2SetFill(this)'><div class='c -none'></div> No fill</li> </ul> </div> </div> </div> <div class='fic-footer'> <div class='fic-continue' onclick='$(this).parent().parent().parent().removeClass(\"active\")'>Okay</div> </div> </div> </div></div>";
	};
	
	
	this.v2SetValue = function(id, config){
		var color, icon, fill;
		if (!config){
			config={fill: 'solid', icon: '', color: '#999999'};
		}
		
		if (AP.data.isArray(config)){
			var icon = config[0] || '';
			var color = config[1] || '';
			var fill = config[2] || 'solid';
		}else{
			var color = config.color || '';
			var icon = config.icon || '';
			var fill = config.fill || 'solid';
		}
		
		$("#"+id+" *[name=icon-fill]").val(fill);
		$("#"+id+" *[name=icon-icon]").val(icon);
		
		$("#"+id+" *[name=icon-color]").val(color).spectrum({
			type: "component",
			togglePaletteOnly: true,
			hideAfterPaletteSelect: true,
			showInitial: true,
			showAlpha: false,
			allowEmpty: false,
			change: function(){
				v2IconUpdate($("#"+id));
			}
		});
		
		$("#"+id+" .fic-fill ul li").setActiveData("value", fill);
		
		v2IconUpdate($("#"+id));
	};
	
	
	this.v2SetFill = function(ref){
		var value=$(ref).data("value");
		$(ref).addClass("active");
		$(ref).siblings().removeClass("active");
		
		var $canvas = $(ref).closest(".form-v2-icon");
		$canvas.find("input[name=icon-fill]").val(value);
		v2IconUpdate($canvas);
	};
	
	
	this.v2SetIcon = function(ref){
		var value=$(ref).data("value");
		$(ref).addClass("active");
		$(ref).siblings().removeClass("active");
		
		var $canvas = $(ref).closest(".form-v2-icon");
		$canvas.find("input[name=icon-icon]").val(value);
		v2IconUpdate($canvas);
	};
	
	
	this.colorPickerHTML = function(id, color){		
		var css='';
		var ec = "-empty";
		if (color){
			css="style='background-color: "+(Render.helper.getColor(color))+"'";
			ec = "";
		}
		
		var icon = "  " +Render.render('icon', {icon: "form_color" }, '')+ '';
		
		var html="<div class='form-v2-color-wrapper'> <div class='selected-color url "+(ec)+"' "+(css)+">"+(icon)+"</div> <div class='form-v2-color-board'> <input name='color' value='"+(color||'')+"' id='"+(id)+"-cp' class='js-ignored'/> </div> </div>";
		
		return html;
	};
	
	
	this.colorPickerInit = function(id){
		var $input=$("#"+id+"-cp");
		if (!$input.length){
			return;
		}
		
		$input.closest(".form-v2-color-wrapper").find(".selected-color").click(function(){
			var now = (new Date()).getTime();
			$(this).parent().toggleClass("active").data("ls", now);
		});
		
		$input.spectrum({
			type: "flat",
			hideAfterPaletteSelect: false,
			showInitial: true,
			showAlpha: false,
			allowEmpty: "false",
			change: function(){
				var $box = $input.closest(".form-v2-color-wrapper");
				
				var last_selected = $box.data("ls");
				var now = (new Date()).getTime();
				
				if (last_selected && now < last_selected+200){
					return;
				}else{
					$box.data("ls", now);
					$box.removeClass("active");	
				}
				
				var color = $box.find("*[name=color]").val();
				$box.find(".selected-color").css("background-color", color);
				
				if (color){
					$box.find(".selected-color").removeClass("-empty");
				}else{
					$box.find(".selected-color").addClass("-empty");
				}
			}
		});
	};
	
	
	
	function v2IconUpdate($canvas){
		var color = $canvas.find("*[name=icon-color]").val()||'#cccccc';
		var icon = $canvas.find("*[name=icon-icon]").val()||'';
		var fill = $canvas.find("*[name=icon-fill]").val()||'none';
		
		$canvas.find(".icon-opt").css("background-color", "").css("color", "");
		
		$canvas.find(".icon-opt.active").each(function(){
			if (fill=="solid"){
				$(this).css("background-color", color).css("color", "#fff");
			}else if (fill=="subtle"){
				$(this).css("background-color", color).css("color", Color.adjust(color, 20, 40));
			}else{
				$(this).css("background-color", color);
			}
		});
		
		var svg='';
		if (icon && SVG[icon]){
			svg=SVG[icon];
		}
		
		var bg_color=color;
		
		var text_color='#fff';
		if (fill=='subtle'){
			text_color=Color.adjust(color, 20, 40);
		}else if (fill=='none'){
			text_color="#000000";
		}
		
		var html="<div class='icon-picked' title='"+(icon)+"' style='background-color:"+(bg_color)+"; color:"+(text_color)+"'>"+(svg)+"</div>";
		$canvas.find(".form-v2-icon-display").html(html);
	};
	
	
	function getIcons(icons){
		var html="";
		for (var key in icons){
			html+= "<div class='form-icon' data-value='"+key+"' onclick='Form.icon.select(this);'><span class='inline ap-f14' style='width: 20px;'><span class='ficon-"+key+"'></span></span> "+icons[key]+"</div>";
		}
		return html;
	};
	
	
	function getIconsV2(){
		var html='';
		for (var key in SVG){
			var v = SVG[key];
			if (AP.data.isString(v) && v.length>=10){
				html+="<div class='icon-opt' data-value='"+(key)+"' onclick='Form.icon.v2SetIcon(this)'>"+(v)+"</div>";
			}
		}
		
		return html;
	};
	
	
	function getFavIcons(icons){
		var html="";
		for (var i=0; i<icons.length; i++){
			var key = icons[i];
			html+= "<div class='form-icon' data-value='"+key+"' onclick='Form.icon.select(this);'><span class='inline ap-f14' style='width: 20px;'><img style='width:16px; height:16px;' src='"+Client.share_url+"/fav_icons/"+key+".png'/></span></div>";
		}
		return html;
	};
	
};


function __FormTouch(url, data){
	this.url=url;
	this.data={};
	
	if (url){
		this.url=url;
	}
	
	if (data){
		this.data=data;
	}
	
	this.msg_confirm=null;
	this.msg_success=null;
	
	this.success=function(msg, fn){
		this.msg_success=msg;
		this.success_fn=fn;
		return this;
	};
	
	this.confirm=function(msg){
		this.msg_confirm=msg;
		return this;
	};
	
	this.run=function(){
		if (this.msg_confirm){
			var $this=this;
			AP.confirm(this.msg_confirm, function(){
				$this.execute();
			});
			
			return;
		}else{
			this.execute();
		}
	};
	
	
	this.execute=function(){
		UI.ajaxShow();
		
		var $this=this;
		AP.post(this.url, this.data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash($this.msg_success);
			if ($this.success_fn){
				$this.success_fn(code);	
			}else{
				UI.flash("Successfully updated");
				AP.xRefresh();
			}
		});
	};
};

Form.touch=function(url, data){
	return new __FormTouch(url, data);
};


Form.list=new function __FormList(){
	this.init=function(input, options){
		options=$.extend({}, {url: "", data: {}, placeholder:"Type the next line here"}, options);
		if (options.__data){
			options.data=$.extend(options.data, options.__data);
		}
		
		options.name=$(input).attr("name");
		
		$(input).each(function(){
			var $input=$(this);
			var simple=($input.data("role")=="simple");
			
			var id=AP.uuid();
			$input.addClass("-js-value").wrap("<div class='line-inputs' id='"+id+"'></div>");
			$input.wrap("<div class='hidden'></div>");
			$("#"+id+"").data("options", options).append("<div class='js-lines'></div>");
			
			var value="";
			if (options.value){
				value=options.value;
			}
			
			if (!value && $input.val() && $input.val().length){
				value=$input.val();
			}
			
			initRow($input[0], value);
		});
	};
	
	
	/**
	 * @desc Directly set values
	 */
	this.setValue=function(input, value){
		$(input).each(function(){
			initRow(this, value);
			$(this).closest(".line-inputs").find(".hidden .-js-value").val(value);
		});
	};
	
	
	/**
	 * @desc Remove the line containing ref, update JS/textarea content
	 */
	this.removeLine=function(ref){
		var $last=$(ref).closest(".js-lines").find(".line-input.last");
		$(ref).closest(".line-input").remove();
		
		updateContent($last[0]);
	};
	
	
	function initRow(ref, value){
		var $c=$(ref).closest(".line-inputs");
		var id=$c.attr("id");
		var options=$c.data("options");
		var html="";
		var attrs="";
		if (options.data.taggable){
			attrs+=" data-role='tag'";
		}
		
		if (AP.data.isArray(value)){
			var rv="";
			html=AP.render(value, function(line){
				var lx=line;
				
				if (AP.data.isObject(line)){
					lx=line;
				}else{
					lx={key: AP.random.word(32), value: lx};
				}
				
				rv+=""+(lx.key)+":"+(lx.value)+"\n";
				return "<div class='line-input -real'> <textarea name='line-"+(lx.key)+"' "+(attrs)+" data-rid='"+(lx.key)+"'>"+(lx.value)+"</textarea> <div class='line-actions'> <div class='-action red' onclick='Form.list.removeLine(this)'>Remove</div> </div> </div>";
			});
			
			$(ref).val(rv);
		}else{
			var lines=value.split("\n");
			html=AP.render(lines, function(line){
				var p=safeSplit(line, ":", 2);
				if (p.length!=2){
					return "";
				}
				
				return "<div class='line-input -real'> <textarea name='line-"+(p[0])+"' "+(attrs)+" data-rid='"+(p[0])+"'>"+(p[1])+"</textarea> <div class='line-actions'> <div class='-action red' onclick='Form.list.removeLine(this)'>Remove</div> </div> </div>";
			});	
		}
		
		if (options){
			html+="<div class='line-input focus last'><textarea name='temp' "+(attrs)+" placeholder='"+(options.placeholder)+"'></textarea></div>";	
		}
		
		
		$("#"+id+" .js-lines").empty().html(html);
		Form.render("#"+id+" .js-lines");
		bindEvents("#"+id, options);
	};
	
	
	function bindEvents(canvas, options){
		$(canvas).find(".line-input textarea").each(function(){
			$(this).enter(function(){
				updateContent(this);
				saveContent(this);
			}).on("input change", function(){
				silentSync(this);
			});
		});
	};
	
	
	function updateContent(ref){
		var $c= $(ref).closest(".line-inputs");
		var html="";
		$c.find(".line-input textarea").each(function(){
			var rid=$(this).data("rid");
			var content=safe($(this).val());
			if (!content || !content.length){
				return;
			}
			
			if (!rid){
				rid=AP.random.word(32);
			}
			
			html+=rid+":"+content+"\n";
		});
		
		$c.find("textarea.-js-value").val(html);
	};
	
	
	function syncBackContent(ref){
		var $c= $(ref).closest(".line-inputs");
		var val=$c.find("textarea.-js-value").val();
		initRow(ref, val);
		$c.find(".line-input.last textarea").focus();
	};
	
	function silentSync(ref){
		var $cs= $(ref).closest(".line-inputs");
		var val="";
		
		$cs.find(".line-input textarea").each(function(){
			var rid=$(this).data("rid");
			var content=safe($(this).val());
			if (!content || !content.length){
				return;
			}
			
			if (!rid){
				rid=AP.random.word(32);
			}
			
			val+=rid+":"+content+"\n";
		});
		
		$cs.find("textarea.-js-value").val(val)
	};
	
	
	function saveContent(ref){
		var $c=$(ref).closest(".line-inputs");
		var opts=$c.data("options");
		var name=opts.name;
		
		var rid=$(ref).data("rid");
		
		if (!opts.url || !opts.url.length){
			syncBackContent(ref);
			return;
		}
		
		var data=shallowClone(opts.data);
		data[name]=$c.find("textarea.-js-value").val();
		
		UI.ajaxShow();
		AP.post(opts.url, data, function(code){
			UI.ajaxHide();
			if (code.good()){
				syncBackContent(ref);
			}
		});
	};
	
	
	
	function safeSplit(line, splitter, limit){
		var p=line.split(splitter);
		if (p.length<limit){
			return p;
		}
		
		// p.length >= limit
		
		var s=[];
		for (var i=0; i<limit-1; i++){
			s.push(p[i]);
		}
		
		var tail="";
		for (var i=limit-1; i<p.length; i++){
			tail+=p[i];
			if (i<p.length-1){
				tail+=splitter;
			}
		}
		
		s.push(tail);
		return s;
	};
};


Form.select=new function(){
	this.improve=function(selector, opts){
		$(selector).each(function(){
			Form.improveSelect(this, opts);
		});
	}
};

Form.improveSelect=function(selector, opts){
	if (!$(selector).length){
		return;
	}
	
	$(selector).hide();
	var placeholder=$(selector)[0].placeholder;
	if (!placeholder){
		placeholder='-- Vui lĂ²ng chá»n --';
	}
	
	var items=[];
	var emp=null;
	var cv=$(selector).val();
	
	opts=$.extend({search: true, with_empty: 1}, opts);
	
	if (opts.multi || opts.multiple){
		if ($(selector).data("__value")){
			opts.value=$(selector).data("__value");
			cv=opts.value;
		}
	}
	
	$(selector).find("optgroup").each(function(){
		items.push({label: $(this).attr("label"), type: "optgroup"});
		
		$(this).find("option").each(function(){
			if (AP.data.equal(this.value, opts.empty)){
				emp="<em>"+$(this).text()+"</em>";
			}else{
				items.push({label: $(this).text(), value: this.value, selected: this.selected?1:0});	
			}
		});
	});
	
	if (!items.length){
		$(selector).find("option").each(function(){
			if (AP.data.equal(this.value, opts.empty)){
				emp="<em>"+$(this).text()+"</em>";
			}else{
				items.push({label: $(this).text(), value: this.value, selected: this.selected?1:0});	
			}
		});	
	}
	
	
	if (opts.items && !items.lenth){
		items=AP.select(opts.items, function(e){
			return {label: e.name, value: e.id};
		});
		
		if (opts.empty){
			items.unshift({label:(opts.empty === true)?"-- Vui lĂ²ng chá»n --":opts.empty, value: ""});
		}
		
		$(selector).html(AP.render(items, function(e){
			return "<option value='"+(e.value)+"'>"+(e.label)+"</option>";
		}));
	}else{
		if (opts.with_empty){
			// items.unshift({label:"---", value: ""});
		}
		
		if ('value' in opts){
			$(selector).val(opts.value);
		}
		
		cv=$(selector).val();
	}
	
	if (placeholder=="-- Vui lĂ²ng chá»n --" && emp){
		placeholder=emp;
	}
	
	
	var $p=$(selector).parent();
	var items_html=AP.render(items, function(e){
		if (e.type && e.type=="optgroup"){
			return "<div class='is-label'>"+(e.label)+"</div>";
		}
		
		var label=e.label;
		if (opts.render){
			var fn=opts.render;
			label=fn(e.value, label);
		}
		
		return "<div class='is-item' onclick='Form.improveSelectHelper.pickup(this);' data-value='"+(e.value)+"'>"+(label)+"</div>";
	});
	
	var name=AP.uuid();
	var search="<div class='is-search'><input type='text' name='"+(name)+"' placeholder='Lá»c nhanh'/></div>";
	if (!opts.search){
		search='';
	}
	
	var _close = '';
	if (opts.multiple || opts.multi){
		_close = "<div class='is-close'>HoĂ n thĂ nh</div>";
	}
	
	var html="<div class='improve-select unselectable'> <div class='is-display url' data-url=':active:parent'><div class='ap-xdot'>"+(placeholder)+"</div></div> <div class='is-box'> "+(search)+" <div class='is-scroll scroll-y url'> <div class='is-items'>"+(items_html)+"</div> </div> "+(_close)+" </div> </div>";
	
	$p.append(html).addClass("js-improved-select");
	$p.find(".is-scroll").on("click", function(){
		if ($(this).closest(".js-improved-select").data("multiple")){
			$(this).parent().parent().addClass("active");
		}else{
			$(this).parent().parent().removeClass("active");
		}
	});
	
	
	var tname=$p.find("select").attr("name");
	
	if (opts.multiple || opts.multi){
		$p.find("select").hide().attr("name", AP.uuid()).after("<input type='hidden' class='js-select' name='"+(tname)+"'/>");
		$p.data("multiple", 1);
	}else{
		// $p.find("select").hide().attr("name", AP.uuid()).after("<input type='hidden' class='js-select' name='"+(tname)+"'/>");
	}
	
	$p.find("input[name="+name+"]").on("input keypress", function(){
		var v=$(this).val();
		if (!v || !v.length){
			$p.find(".is-scroll").find(".is-item").show();
			return;
		}
		
		$p.find(".is-scroll").find(".is-item").each(function(){
			var txt=$(this).text();
			if (AP.word.fulltextMatch(txt, v)){
				$(this).show();
			}else{
				$(this).hide();
			}
		});
	});
	
	if (opts.multi || opts.multiple){
		if (opts.value && opts.value.length){
			$p.find(".is-item").each(function(){
				if (AP.array.contain(cv, $(this).data("value"))){
					$(this).click();
					$p.find(".improve-select").removeClass("active");
				}
			});	
		}
		
		$p.find(".is-close").click(function(){
			$p.find(".improve-select").removeClass("active");
		});
		
		return;
	}
	
	
	// Set current value
	if (!cv && "value" in opts){
		cv=opts.value;
	}
	
	
	$p.find(".is-item").each(function(){
		if (AP.data.equal(cv, $(this).data("value"))){
			$(this).click();
			$p.find(".improve-select").removeClass("active");
		}
	});
};



Form.improveSelectHelper=new function __FormIMPHelper(){
	this.pickup=function(ref){
		var $p=$(ref).closest(".js-improved-select");
		
		if ($p.data("multiple")){
			return this.pickupMulti(ref);
		}
		
		
		var label=$(ref).text();
		
		$(ref).siblings().removeClass("active");
		$(ref).toggleClass("active");
		
		var value=$(ref).data("value");
		if (!$(ref).hasClass("active")){
			value="";
			$p.find(".is-display div").html("---");
		}else{
			$p.find(".is-display div").html(safe(label));
		}
		
		$p.find("select").val(value).trigger("change");	
		
	};
	
	
	this.pickupMulti=function(ref){
		$(ref).toggleClass("active");
		var $p=$(ref).closest(".js-improved-select");
		
		var value=[];
		var label=[];
		
		$p.find(".is-item.active").each(function(){
			var lab=safe($(this).text());
			label.push("<span class='is-itag'>"+(lab)+"</span>");
			value.push($(this).data("value"));
		});
		
		value=AP.array.unique(value, function(e, f) {
			return e === f;
		});
		
		$p.find(".is-display div").html(label.join(" ")+"&nbsp;").removeClass("ap-xdot");
		$p.find(".js-select").val(value.join(", ")).trigger("change");

		// $p.find("select").trigger("change");
	};
};


Form.v2=function(opts){

	opts=$.extend({}, {width: 450, layout:"flat", protection: true}, opts);
	if (!opts.id){
		opts.id = 'form-v2-fx';
	}
	
	var form = Form.create(opts.id, {'action': opts.action});
	form.version = 2;
	
	var focus= 'name';
	
	var hiddens = {};
	if (opts.hiddens){
		hiddens=opts.hiddens;
	}
	
	if (opts.data){
		hiddens=opts.data;
	}
	
	var rows = [];
	for (var i=0; i< opts.rows.length; i++){
		var r = opts.rows[i];
		if (r == null || r == false){
			continue;
		}
		
		if (AP.data.isObject(r) && ('acl' in r) && !Render.helper.acl(r.acl)){
			continue;
		}
		
		if (AP.data.isObject(r) && r.type == "import"){
			for (var j=0; j<r.rows.length; j++){
				rows.push(r.rows[j]);
			}
		}else{
			if (AP.data.isArray(r)){
				r = ARR.filter(r, function(re){
					if (AP.data.isObject(re) && 'acl' in re && !Render.helper.acl(re.acl)){
						return false;
					}
					
					if (re){
						return true;
					}
					
					return false;
				});	
			}
			
			if (AP.data.isArray(r) && r.length==1){
				rows.push(r[0]);
			}else{
				rows.push(r);
			}
		}
	}
	
	
	for (var i=0; i< rows.length; i++){
		var r= rows[i];
		if (AP.data.isString(r)){
			r={type:"html", html: rows[i]};
			
			if (rows[i] == "---" || rows[i] == "----" || rows[i] == "-----"){
				r = {type:"sep"};
			}
		}
		
		
		if (AP.data.isArray(r)){
			if (r.length==3){
				var gs=[Form.v2.getIPData(r[0]), Form.v2.getIPData(r[1]), Form.v2.getIPData(r[2])];
				var lefts = getLefts([r[0], r[1], r[2]]);
				
				form.row(
					Form.label({label: r[0].label, extra_label: r[1].label, extra_left: lefts[1], extra_label_2: r[2].label, extra_left_2: lefts[2]}),
					Form.inputGroup(gs)
				).addClass("-active");
			}else{
				var gs=[Form.v2.getIPData(r[0]), Form.v2.getIPData(r[1])];
				var lefts = getLefts([r[0], r[1]]);
				
				form.row(
					Form.label({label: r[0].label, extra_label: r[1].label, extra_left: lefts[1]}),
					Form.inputGroup(gs)
				).addClass("-active");	
			}
		}else{
			if (r.type == "custom_form" || r.type == "customform"){
				if (!r.rows || !r.rows.length){
					continue;
				}
				
				Form.v2.initCustomForm(form, r.rows, r.values);
				continue;
			}
			
			var ip= Form.v2.getIPData(r);
			if (r.auto_submit || r.autosubmit){
				ip.autoSubmit();
			}
			
			if (r.type=="placeholder"){
				form.row(
					Form.label({label: r.label}),
					Form.input({name: r.name, type: "placeholder", id: r.id})
				).addClass("-active");
			}else if (r.type=="html"){
				var id=AP.uuid();
				form.placeholder(id, r.html, r.label||'');
			}else{
				var cx=(r.classes?r.classes:"");
				if (!cx){
					if (r.size == "xl" || r.size == "lg"){
						cx="-big";
					}
				}
				
				if (!cx && r.style){
					cx=r.style;
				}
				
				if (!r.label){
					cx+=" -upper";
				}
				
				if (r.hidden){
					form.rowHidden(
						Form.label({label: r.label}),
						ip
					);
				}else{
					form.row(
						Form.label({label: r.label}),
						ip
					).addClass("-active "+cx);
				}
				
				if (r.focus){
					focus=r.name;
				}
			}	
		}
	}
	
	if (opts.embed){
		Form.embed(form, opts);
		return;
	}
	
	if (opts.buttons){
		if (AP.data.isArray(opts.buttons)){
			form.buttons(opts.buttons);
		}else{
			var fn = opts.buttons.release();
			fn.validator = opts.validator || null;
			form.buttons(fn);
		}
	}
	
	form.hiddens(hiddens).render(function(f){
		if (opts.render){
			opts.render.apply(f);	
		}
		
		if (opts.validator){
			$("#"+f.__id).data("validator", opts.validator);
		}
	});

	Form.pop({id: opts.id+"-dx", width: opts.width, label: opts.title, layout: opts.layout}).setForm(form).show().focus(focus);
	$("#"+opts.id+"").closest(".__dialog").removeClass("__xesc");
	$("#"+opts.id+" :input").on("focus click", function(){
		$(this).closest(".__dialog").addClass("__xesc");
	});
	
	// Protect unsave form
	if (opts.protection){
		Form.protection.init("#"+opts.id, true);
	}
	
	
	function getLefts(ips){
		var tw = 0;
		for (var i=0; i<ips.length; i++){
			if (ips[i].width){
				tw+= ips[i].width;
			}else{
				tw+=1;
			}
		}
		
		var w=100.0/tw; 
		var left = 0;
		var r = [];
		for (var i=0; i<ips.length; i++){
			var ew = 1;
			if (ips[i].width){
				ew= ips[i].width;
			}
			r.push(left);
			
			left+=w*ew;
		}
		
		return r;
	}
};



Form.v2.getIPData=function(r){
	if (!r.label){
		r.label="";
	}
	
	if ('eg' in r){
		r.placeholder = "Eg: "+r.eg;
	}
	
	var ip_data={name: r.name, type: r.type, placeholder: r.placeholder?r.placeholder:inline(r.label), multiple: r.multiple||0, __original: r};
	
	if ('value' in r){
		ip_data.value = r.value;
	}
	
	if (r.type == "date"){
		ip_data.type = "text";
		ip_data.role = "date";
		
		ip_data.options = null;
		delete ip_data.options;

	}
	
	if (r.type == "editor"){
		ip_data.type = "textarea";
		ip_data.role = "editor";
		
		ip_data.options = null;
		delete ip_data.options;
	}
	
	if (r.role){
		ip_data.role=r.role;
	}
	
	if (r.data){
		ip_data.data=r.data;
	}else{
		ip_data.data={};
	}
	
	if (r.color_picker){
		ip_data.color_picker=r.color_picker;
	}
	
	if (r.color){
		ip_data.color=r.color;
	}
	
	if (r.icon_picker){
		ip_data.icon_picker=r.icon_picker;
	}
	
	if (r.emoji_picker){
		ip_data.emoji_picker=r.emoji_picker;
	}
	
	if (r.emoji){
		ip_data.emoji = r.emoji;
	}
	
	if (r.autocomplete){
		ip_data.autocomplete = r.autocomplete;
		ip_data.type="input-autocomplete";
	}else if (r.options && r.nested){
		var nx = [];
		Form.v2GetNested(nx, r.options, 0);
		ip_data.options = nx;
		ip_data.type="select";
	}else if (r.options && r.type!="orgchart"){
		var opts = r.options;
		if (!AP.data.isArray(opts)){
			opts=[];
			for (var key in r.options){
				opts.push({value: key, label: r.options[key]});
			}
		}
		
		ip_data.options = opts;
		
		if (!ip_data.type || ip_data.type=="text"){
			ip_data.type="select";	
		}
		
		if (r.multiple || (r.data && r.data.multiple)){
			ip_data.multiple=1;
		}
	};
	
	if (r.type=="orgchart"){
		ip_data.options = r.options;
	}
	
	if (r.groups){
		ip_data.optgroups = r.groups;
		ip_data.type="select";
	}
	
	if (!ip_data.type){
		ip_data.type="text";
	}
	
	
	if (r.empty && ip_data.type=="select"){
		ip_data.empty={label:"-- Vui lĂ²ng chá»n --", value: 0};
		if (AP.data.isString(r.empty)){
			ip_data.empty={label: r.empty, value: 0};
		}
	}
	
	if (r.minHeight){
		ip_data.height=r.minHeight;
	}else if (r.height){
		ip_data.height=r.height;
	}
	
	if (r.unit){
		ip_data.unit=r.unit;
	}
	
	if (r.role=="editor"){
		if (!r.type){
			ip_data.type="textarea";
		}
		if ("editor" in r){
			ip_data.data.compact=r.editor;
			if (r.editor == "compact"){
				ip_data.data.compact = 2;
			}
		}else{
			ip_data.data.compact=1;
		}
	}
	
	if (r.role=="markdown"){
		if (!r.type){
			ip_data.type="textarea";
		}
	}
	
	if (r.readOnly || r.read_only){
		ip_data.readOnly=1;
	}
	
	if (r.verbatim){
		ip_data.verbatim=1;
	}
	
	if (r.inline_add){
		ip_data.inline_add = r.inline_add;
	}
	
	if (r.html){
		ip_data.html=r.html;
	}
	
	if (r.icon){
		ip_data.icon = r.icon;
	}
	
	if (ip_data.size){
		if (ip_data.size == "lg" || ip_data.size == "xl"){
			ip_data.classes = "-big";
		}
	}
	
	if (r.quick_tag && (r.type=="textarea" || r.type=="text" || r.type=="input" || !r.type)){
		r.extra="&rsaquo; <span class='url' onclick='Form.v2.quickTag(this)'>ThĂªm nhanh thĂ nh viĂªn theo nhĂ³m</span>";
	}
	
	var ip=Form.input(ip_data).valueIf(r.value, "value" in r);
	if (r.css){
		ip.css(r.css);
	}
	
	if (r.height && r.role!="editor"){
		ip.css({minHeight: r.height+"px"});
	}
	
	if (r.extra){
		ip.extra(r.extra);
	}
	
	return ip;
};



Form.v2.quickTag = function(ref){
	var rows = [
		{label: "Chá»n nhĂ³m", name: "user_groups", placeholder: "GĂµ @ Ä‘á»ƒ tag", type: "textarea", role: "teams", focus: 1}
	];
	
	Form.v2({
		id: "js-quicktag",
		rows: rows,
		title: "Chá»n thĂ nh viĂªn theo nhĂ³m",
		buttons: Form.button(":continue", function(data){
			var teams=[];
			data.user_groups.replace(/\(@([a-zA-Z0-9]+)\)/g, function(ms, content){
				teams.push(content);
			});
			
			// List of all team paths
			var units = ARR.filter(Client.units, function(e){
				return ARR.contain(teams, e.path);
			});
			
			units = ARR.select(units, function(e){
				return ""+e.id;
			});
			
			var users = People.getPeopleInNetworks(units);
			Form.v2.hide("#js-quicktag");
			
			var $ip;
			
			if ($(ref).closest(".input-group").length){
				$ip = $(ref).closest(".gi").find("input");
			}else{
				$ip = $(ref).closest(".row").find("textarea");
				if (!$ip.length){
					$ip = $(ref).closest(".row").find("input");
				}
			}
			
			
			var prefix=$ip.val();
			if (prefix){
				prefix=prefix+" ";
			}
			$ip.val(prefix+AP.word.join(users, " ", function(e){
				return "@"+e.username;
			}));
			
		}).button(":cancel")
	});
};


Form.v2.initCustomForm = function(form, rows, values){
	
	for (var i=0; i<rows.length; i++){
		var r = shallowClone(rows[i]);
		
		r.label = r.name;
		r.name = r.id;
		r.unit = "<em>"+(r.type)+"</em>";
		
		if (r.required && parseInt(r.required)){
			r.label = r.label+ " <em class='red -required'>* Báº¯t buá»™c</em>";
		}
		
		if (r.type == "text"){
			r.options = null;
		}else if (r.type == "int"){
			r.type="text";
			r.role="int";
			r.options = null;
		}else if (r.type == "date"){
			r.type="date";
			r.role="date";
			r.options = null;
		}else if (r.type == "float"){
			r.type="text";
			r.role="int";
			r.options = null;
		}else if (r.type == "select" && r.options){
			if (!r.options.length || !r.options[0]) {
				r.options.unshift('');
			}
		}else if (r.type == "select-m"){
			r.type="select";
			r.multiple=1;
		}
		
		
		if (values && AP.data.isArray(values)){
			var v = ARR.findObj(values, r.id);
			if (v){
				if (v.type == "select-m"){
					r.value = AP.word.split(",", v.value).map(function(e){
						return $.trim(e);
					});
				}else{
					r.value = v.value;	
				}
			}
		}
		
		
		var ip= Form.v2.getIPData(r);
		
		form.row(
			Form.label({label: r.label}),
			ip
		).addClass("-active");
	}
	
};


Form.v2.hide=function(id){
	if (!id){
		id='form-v2-fx';
	}
	return Form.hide(id);
};

Form.v2.submit=function(callback, ref){
	var form_id = '#form-v2-fx';
	
	if (ref){
		form_id = "#"+$(ref).closest("form").attr("id");
		if (!form_id){
			form_id = '#form-v2-fx';
		}
	}
	
	var v = $(form_id).data("validator");
	if (v && AP.data.isFunction(v)){
		var data = assoc($(form_id).find(":input").serializeArray());
		var r = v(data);
		if (r && r instanceof Code){
			return AP.alertError(r.message);
		}
	}
			
	return Form.submit(form_id, callback);
};

Form.v2.balance=function(ref){
	var id;
	
	if (!ref){
		id = "form-v2-fx-dx";
	}else{
		id = $(ref).closest(".__apdialog").attr("id");
	}
	
	return AP.dialog(id).balance();
};

Form.button=function(btn, cb, lb){
	return new FormButtonV2(btn, cb, lb);
};

Form.button.submit = function(btn){
	var btn={
		label: btn.label, 
		style: "ok -success -rounded bold", 
		action: function(){
			Form.v2.submit(function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Form.v2.hide();
				
				if (btn.xRefresh){
					UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng");
					AP.xRefresh();
				}else if (btn.refresh){
					AP.refresh();
				}else{
					if (btn.callback){
						btn.callback(code);
					}
				}
			});
		}
	};
	
	var btm = new FormButtonV2();
	btm.btns.push(btn);
	return btm;
};


Form.toggle = function(url){
	UI.ajaxShow();
	AP.post(url, {}, function(code){
		UI.ajaxHide();
		if (!code.good()){
			return AP.alertError(code.message);
		}
		
		AP.refresh();
	});
};

Form.remove=function(opts){
	opts=$.extend({}, {message: "Confirm to remove", data: {}}, opts);
	if (opts.callback && !opts.success){
		opts.success=opts.callback;
	}
	
	if (opts.critical_removal){
		AP.confirmDelete(opts.message, function(){
			UI.ajaxShow();
			AP.post(opts.action, opts.data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng");
				if (opts.success){
					opts.success(code);	
				}else{
					AP.refresh();
				}
			});
		}, opts);
		
		return;
	}
	
	AP.confirm(opts.message, function(){
		UI.ajaxShow();
		AP.post(opts.action, opts.data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng");
			if (opts.success){
				opts.success(code);	
			}else{
				AP.refresh();
			}
		});
	});
	
};

Form.v2.remove = Form.remove;
Form.confirm=Form.remove;


Form.v2Files = function(opts){
	Form.v2Files.handler.opts=opts;
	
	
	function __getFiles(files, opts){
		return AP.render(opts.files, function(e){
			var pr = 120;
			var remove="<div class='action' onclick='Form.v2Files.handler.remove(this)'>XĂ³a</div>";
			if (!opts.admin){
				remove='';
				pr = 60;
			}
			
			return "<div class='li js-file' data-fid='"+(e.id)+"' data-name='"+(e.name)+"' data-action='"+(opts.action)+"' data-data='"+(JSON.stringify(opts.data))+"'> <div class='icon'><span class='ap-f16 -ap icon-file-text2'></span></div> <div class='ap-xdot' style='padding-right:"+(pr)+"px' title='"+(e.name)+"'><span class='url' data-url=':file' data-file='"+(e.url)+"'>"+(e.name)+"</span></div> <div class='sub'>"+(UI.file.kb(e.size))+" KB &middot; ÄĂ£ upload "+(AP.i18n.date(e.since))+"</div> <div class='actions'> <div class='action url' data-url='"+(e.download)+"'>Download</div> "+(remove)+" </div> </div>";
		});
		
	};
	
	
	if (!opts.files){
		opts.files=[];
	}
	
	var files = __getFiles(opts.files, opts);
	var cta = "<div class='filev2-add'><span class='ap-f14'><span class='fa ficon-cloud-upload'></span></span> &nbsp; <span class='-url'>ThĂªm files</span></div>";
	if (!opts.admin){
		cta = '';
	}
	
	var html="<div class='-close' style='top:6px; border:1px solid transparent' onclick='AP.dialog.close(this);'><span class='-ap icon-cancel'></span></div> <div class='title'>"+(opts.title)+"</div> <div class='filev2-actions'> <div class='filev2-info'>"+(opts.files.length)+" files</div> "+(cta)+" </div> <div class='list list-actions -border'>"+(files)+"</div>";
	
	AP.customDialog(html,"custom-selection").style("-full").width(600).show();
	
	$("#custom-selection .filev2-add").on("click", function(){
		var rows=[
			{label: "Chá»n files", name: "file", type: "files"}
		];
		
		Form.v2({
			action: opts.action,
			rows: rows,
			data: opts.data,
			title: "ThĂªm files",
			buttons: Form.button(":submit", function(code){
				Form.v2Files.handler.update(code);
			}).button(":cancel")
		});
	});
};


Form.v2Files.handler = new function __FormV2FileHandler(){
	this.opts = null;
	
	this.update = function(code){
		if (this.opts && this.opts.update){
			this.opts.update(code);
		}else{
			return AP.xRefresh();
		}
	};
	
	this.remove=function(ref){
		var $file=$(ref).closest(".js-file");
		var fid = $file.data("fid");
		var name = $file.data("name");
		var data= $file.data("data");
		data= $.extend({}, data, {action: "remove.file", fid: fid});
		
		Form.confirm({
			message: "Please confirm to remove the file "+(name)+"",
			data: data,
			action: $file.data("action"),
			callback: function(code){
				Form.v2Files.handler.update(code);	
			}
		});
	};
};



function FormButtonV2(btn, cb, lb){
	this.btns=[];
	this.button=function(btn){
		if (btn==":cancel"){
			btn={label: "Há»§y", action: function(ref){
				Form.v2.hide(ref);
			}};
		}else if (btn==":submit"){
			var label = "LÆ°u";
			if (cb && AP.data.isString(cb)){
				label = cb;
			}else if (lb && AP.data.isString(lb)){
				label = lb;
			}
			
			btn={
				label: label, style: "ok", action: function(ref){
					Form.v2.submit(function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						if (!cb || !AP.data.isFunction(cb)){
							UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng");
							AP.xRefresh();	
						}else if (AP.data.isFunction(cb)){
							cb(code);
							Form.v2.hide(ref);
						}
					}, ref);
				}
			};
		}else if (btn==":submit-refresh"){
			btn={
					label: "LÆ°u", style: "ok", action: function(ref){
						Form.v2.submit(function(code){
							if (!code.good()){
								return AP.alertError(code.message);
							}
							
							UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng");
							AP.refresh();
						}, ref);
					}
				};
		}else if (btn==":submit-alert"){
			btn={
					label: "LÆ°u", style: "ok", action: function(ref){
						Form.v2.submit(function(code){
							if (!code.good()){
								return AP.alertError(code.message);
							}
							
							AP.alertSuccess("Cáº­p nháº­t thĂ nh cĂ´ng", function(){
								AP.refresh();
							});
						}, ref);
					}
				};
		}else if (btn==":continue"){
			var uuid = AP.uuid();
			btn={
				label: "Tiáº¿p tá»¥c", style: "ok", id: uuid, action: function(){
					var real_form=$("#"+uuid).closest("form");
					var arr = $(real_form).serializeArray();
					var data=assoc2(arr);
					
					var v = real_form.data("validator");
					if (v && AP.data.isFunction(v)){
						var _r = v(data);
						
						if (_r && _r instanceof Code){
							return AP.alertError(_r.message);
						}
					}
					
					
					var r = cb(data);
					if (AP.data.isObject(r) && r instanceof Code){
						if (!r.good()){
							return AP.alertError(r.message);
						}
					}
					
					if ($("#"+uuid).length){
						Form.v2.hide("#"+uuid);	
					}
				}
			};
		}else if (btn==":ok"){
			btn={
				label: "OK", style: "ok", id: uuid, action: function(){
					Form.v2.hide();	
				}
			};
		}else if (btn && AP.data.isObject(btn) && (!btn.btn) && btn.type){
			var _cb = btn.success||btn.callback;
			var _type = btn.type;
			
			btn={
				label: btn.label||"LÆ°u", 
				style: "ok", 
				action: function(ref){
					Form.v2.submit(function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}
						
						if (!_cb || !AP.data.isFunction(_cb)){
							UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng");
							if (_type == ":submit-refresh"){
								AP.refresh();	
							}else if (_type == ":silent"){
								Form.v2.hide(ref);
							}else{
								AP.xRefresh();
							}
								
						}else if (AP.data.isFunction(_cb)){
							_cb(code);
							Form.v2.hide(ref);
						}
					}, ref);
				},
				segment: btn.segment||null
			};
			
		} 
		
		
		if (btn.type=="good" || btn.style=="good" || btn.type=="ok" || btn.style=="ok"){
			btn.style="ok -success -rounded bold";
		}else{
			btn.style="cancel -passive-2 -rounded";
		}
		
		btn.btn = 1;
		this.btns.push(btn);
		
		return this;
	};
	
	if (btn){
		this.button(btn);	
	}
	
	this.release=function(){
		return this.btns;
	}
};


Form.v2GetNested = function(r, obj, level){
	if (obj.disabled){
		return;
	}
	
	if (obj.is_root){
		r.push({label: "- Vui lĂ²ng chá»n -", value: 0});
	}else{
		r.push({label: "-- ".repeat(level)+" "+ obj.display_name||obj.name, value: obj.id});	
	}
	
	if (!obj.items){
		return;
	}
	
	for (var i=0; i<obj.items.length; i++){
		Form.v2GetNested(r, obj.items[i], level+1);
	}
};



Form.on = function(key, render, update){
	Form.customElem.defs[key] = {
		render: render,
		update: update
	}
};


Form.ui = {};

Form.customElem = new  function __FormCustomElem(){
	this.defs = {};
	
	this.defined = function(type){
		return type && this.defs[type];
	};
	
	this.render = function(options){
		var type = options.type;
		if (this.defs[type]){
			var render = this.defs[type].render;
			return render.apply(options, [options]);
		}
		
		return "<input type='hidden' name='"+(options.name)+"' id='"+(options.id)+"'/>";
	};
	
	this.update = function(type, canvas, elem, org){
		if (this.defs[type]){
			var update = this.defs[type].update;
			if (update){
				update.apply(elem, [canvas, elem.__value, org]);	
			}
			// return update(options);
		}
	};
};


Form.protection = new function __FormProtection(){
	this.enable = function(){
		$.log("ENABLED");
		
		window.onbeforeunload = function(e){
			setTimeout(function(){
				Form.protection.disable();
			},100);
			return true;
		}
	};
	
	/**
	 * @desc Disabling protection
	 */
	this.disable = function(){
		$.log("DISABLE");
		$(document.body).find("form.__base_protected").removeClass("__protected_enabled");
		window.onbeforeunload = null;
	};
	
	
	/**
	 * @desc On-submit form
	 */
	this.onSubmit = function(){
		this.disable();
	};
	
	
	this.init = function(form_id, flag){
		var $f = $(form_id);
		if (!$f.length){
			return;
		}
		
		var tn = $f.tagName();
		var $form = null;
		
		if (tn != 'form'){
			$form = $f.find("form");
		}else{
			$form = $f;
		}
		
		if (!$form.length){
			return;
		}
		
		if ($form.hasClass("__base_protected")){
			return;
		}
		
		$form.each(function(){
			if (!$(this).attr("id")){
				var uid = AP.uuid();
				$(this).attr("id", uid);
			}
			
			
			$(this).addClass("__base_protected");
		});
		
		
		
		if (flag){
			$f.each(function(){
				$(this).find(":input").on("keyup change", function(e){
					if ($(this).hasClass("js-ignored")){
						return;
					}
					
					$(this).closest("form").addClass("__protected_enabled");
					Form.protection.enable();
				});
			});
			
			$f.on("change_base", function(){
				if ($(this).hasClass("__protected_enabled")){
					return;
				}
				
				$(this).addClass("__protected_enabled");
				Form.protection.enable();
			});
		}
		
	};
	
	
	/**
	 * @desc Reset transition
	 */
	this.reset = function(canvas){
		if (!canvas){
			canvas = document.body;
		}
		
		$(canvas).find("form.__base_protected").removeClass("__protected_enabled");
		this.disable();
	};
	
	
	/**
	 * @desc Protection on run-time
	 */
	this.runtime = function(canvas){
		if (!canvas){
			canvas = document.body;
		}
		
		var test = $(canvas).find("form.__base_protected.__protected_enabled").length;
		
		if (test){
			return this.confirm(canvas);
		};
		
		this.disable();
		return true;
	};
	
	
	/**
	 * @desc Protection un-saved on transition
	 */
	this.transition = function(){
		return this.runtime();
	};
	
	
	
	/**
	 * @desc Show native confirm, return true if the user accept to continue; false to stay on the page
	 */
	this.confirm = function(canvas){
		if (confirm("Changes you made may not be saved. Do you want to continue?")){
			Form.protection.reset(canvas);
			Form.protection.disable();
			return true;
		}
		
		this.disable();
		return false;
	};
	
};



Form.on("input-autocomplete", function(options){
	var extra='';
	if (options.__extra){
		extra = "<div class='fi-extra'>"+(options.__extra)+"</div>";
	}
	
	return "<div class='input-autocomplete-wrapper'> <div class='hidden'><input data-text='"+(options.__original.text||'')+"' type='hidden' name='"+(options.name)+"' data-autocomplete='"+(options.autocomplete)+"' value='"+(options.value||'')+"' id='"+(options.id)+"'/></div> </div> "+(extra)+"";
}, function(input, value){
	var $canvas = $(input).closest(".input-autocomplete-wrapper");
	var name = AP.uuid();
	var autocomplete = $(input).data("autocomplete");
	$canvas.append("  " +Render.render('search', {autocomplete:this.options.autocomplete, _name:name, _class: "__input_autocomplete" }, '')+ '');
	
	var text = $(input).data("text");
	if (text){
		$canvas.find(".base-search input").val(text);
	}
	
	Render.finish();
});



Form.critical = AP.critical;function UIForm(id, options){
	if (typeof id=='undefined'){
		id=null;
	}
	
	if (typeof options=='undefined'){
		options={};
	}
	
	if (id && id.charAt(0)=='#'){
		id=id.substr(1);
	}
	
	this.__id=id;
	this.__rows=[];
	this.__hiddens={'__code': Client.code};
	this.__buttons=[];
	this.__settings={};
	this.__options=$.extend({},{action: '', method: 'POST'}, options);
	this.__warning=null;
	
	this.find=function(name){
		return $("*[name='"+name+"']", "#"+this.__id);
	};
	
	
	this.findRow=function(name){
		return $("*[name='"+name+"']", "#"+this.__id).closest(".row");
	};
	
	
	this.matchRow=function(selector){
		return $("*[name^="+name+"]", "#"+this.__id).closest(".row");
	};
	
	
	this.elem=function(name){
		return $(name, "#"+this.__id);
	};
	
	this.selector=function(name){
		return this.elem(name);
	};
	
	this.row=function(label, input){
		this.__rows.push(Form.row(label, input));
		return this;
	};
	
	this.placeholder=function(id, raw_html, label){
		this.__rows.push(Form.placeholder(id, raw_html, label));
		return this;
	};
	
	this.inline=function(html){
		this.__rows[this.__rows.length-1].inline(html);
		return this;
	};
	
	
	this.css=function(css){
		this.__rows[this.__rows.length-1].css(css);
		return this;
	};
	
	this.addClass=function(classname){
		this.__rows[this.__rows.length-1].addClass(classname);
		return this;
	};
	
	
	this.option=function(opts){
		this.__rows[this.__rows.length-1].setOptions(opts);
		return this;
	};
	
	
	this.rowIf=function(label, input, cond){
		if (!cond){
			return this;
		}
		this.__rows.push(Form.row(label, input));
		return this;
	};
	
	this.rowHidden=function(label, input){
		this.__rows.push(Form.rowHidden(label, input));
		return this;
	};
	
	this.rowNone=function(label, input){
		return this;
	};
	
	this.customForm=function(cform, values){
		cForm.attach(this, cform, values);
		return this;
	};
	
	
	this.custom=function(html, opts){
		opts = $.extend({}, {display: 'block', id: AP.uuid()}, opts);
		this.__rows.push(Form.rowCustom(html, opts));
		return this;
	};
	
	
	this.wrap=function(title, id){
		this.__rows.push(Form.wrapper(title, id));
		return this;
	};
	
	this.noRow=function(label){
		this.__rows.push(Form.noRow(label, null));
		return this;
	};
	
	
	this.note=function(label, type){
		this.__rows.push(Form.note(label, "note", type));
		return this;
	};
	
	
	this.plain=function(label, type){
		this.__rows.push(Form.note(label, "plain", type));
		return this;
	};
	
	
	this.rowHTML=function(html){
		this.__rows.push(Form.note(html, "html"));
		return this;
	};

	
	this.rowSep=function(str){
		if (str && str.length){
			return this.rowHTML("<div class='row-hr'><span class='hr-label'>"+str+"</span></div>");	
		}
		
		return this.rowHTML("<div class='row-hr -dotted'></div>");
	};
	
	this.hiddens=function(hiddens){
		for (var key in hiddens){
			this.__hiddens[key]=hiddens[key];
		};
		
		return this;
	};
	
	
	this.buttons=function(buttons){
		for (var i=0; i<buttons.length; i++){
			this.__buttons.push(buttons[i]);
		};
		
		return this;
	};
	
	
	
	this.settings=function(settings){
		for (var key in settings){
			this.__settings[key]=settings[key];
		};
		
		return this;
	};
	
	
	this.__callback=null;
	
	this.render=function(callback){
		this.__callback=callback;
		return this;
	};
	
	
	this.html=function(){
		var html="";
		
		if (this.__warning){
			html+="<div class='warning'>"+this.__warning+"</div>";
		}
		
		for (var i=0; i<this.__rows.length; i++){
			html+=this.__rows[i].html();
		}
		
		var hidden="";
		for (key in this.__hiddens){
			hidden+="<input type='hidden' name='"+key+"' value='"+this.__hiddens[key]+"'/>";
		}
		
		
		return "<div class='form-rows'> "+(html)+" <div style='display:none'>"+(hidden)+"</div> </div>";
	};
	
	
	this.update=function(){
		for (var i=0; i<this.__rows.length; i++){
			if (this.__rows[i].good){
				this.__rows[i].input.update();
				this.__rows[i].update(this.__rows[i]);
			}
		}
	};
	
	
	this.getButton=function(index){
		return this.__buttons[index];
	};
	
	
	
	this.renderButtons=function(){
		var html="";
		for (var i=0; i<this.__buttons.length; i++){
			html+=this.renderButton(this.__buttons[i]);
		}
		return html;
	};
	
	
	this.renderButton=function(button){
		var id='';
		if ('id' in button){
			id=" id='"+(button.id)+"'";
		}
		return "<div class='button "+(button.style)+"'"+(id)+">"+(button.label)+"</div>";
	};
	
	this.placeTo=function(id){
		var html=this.html();
		$(id).html(html);
		this.update();
	};
	
	this.focus=function(name){
		$("*[name="+name+"]", "#"+this.__id).autofocus();
	};
	
	this.warning=function(w){
		this.__warning=w;
		return this;
	};
	
	this.balance=function(){
		AP.dialog(this.id).balance();
	};
};function UILabel(data){
	this.real=true;
	this.options="";
	
	if (data===null){
		this.real=false;
	}else{
		if (AP.data.isObject(data)){
			this.options=$.extend({}, {label:"Label", sublabel:"", role:"", extra_label:"", extra_left: null, extra_left_2: null}, data);
		}else{
			this.options=$.extend({}, {label:data, sublabel:"", role:"", extra_label:""});
		}
	}
	
	this.isEmpty = function(){
		if (this.options.label && this.options.label.length){
			return false;
		}
		
		return true;
	};
	
	this.html=function(){
		if (!this.real){
			return '';
		}
		var sublabel="";
		if (this.options.sublabel && this.options.sublabel.length){
			sublabel="<div class='sublabel'>"+this.options.sublabel+"</div>";
		}
		
		var extra_label='';
		
		if (this.options.extra_label && this.options.extra_label.length){
			if (this.options.extra_label_2 && this.options.extra_label_2.length){
				extra_label="<div class='absolute' style='left:"+(this.options.extra_left||33.3)+"%; padding-left:15px;'>"+(this.options.extra_label)+"</div> <div class='absolute' style='left:"+(this.options.extra_left_2||66.6)+"%; right:0px; padding-left:15px;' title='"+(this.options.extra_label_2)+"'> <div class='ap-xdot'>"+(this.options.extra_label_2)+"</div> </div>";
			}else{
				extra_label="<div class='absolute' style='left:"+(this.options.extra_left||50)+"%; padding-left:15px;'>"+(this.options.extra_label)+"</div>";	
			}
			
		}
		
		return "<div class='label "+(this.options.label && this.options.label.length?"":"-empty")+"'>"+extra_label + this.options.label+sublabel+"</div>";
	};
	
	
	
};


function UIInputGroup(data){
	this.length=data.length;
	this.data=[];
	for (var i=0; i<data.length; i++){
		this.data.push(data[i]);
	}
	
	this.html=function(){
		var html="";
		var tw = 0;
		for (var i=0; i<this.data.length; i++){
			if (this.data[i].options && this.data[i].options.__original && this.data[i].options.__original.width){
				tw+= this.data[i].options.__original.width;
			}else{
				tw+=1;
			}
		}
		
		var w=100.0/tw; 
		for (var i=0; i<this.data.length; i++){
			var ew = 1;
			if (this.data[i].options && this.data[i].options.__original && this.data[i].options.__original.width){
				ew= this.data[i].options.__original.width;
			}
			
			html+="<div class='gi' style='width: "+(w*ew)+"%'> "+(this.data[i].html())+" </div>";
		}
		return "<div class='input-group -count-"+this.data.length+"'>"+html+"<div class='clear'></div></div>";
	};
	
	this.update=function(){
		for (var i=0; i<this.data.length; i++){
			this.data[i].update();
		}
	};
};



function UIInputHTML(html){
	this.__html=html;
	
	this.html=function(){
		return "<div class='input data'>"+html+"</div>";
	}
	
	this.update=function(){
		return;
	}
};	


function UIInput(data){
	if (data.type && data.type=="colors" && !data.options){
		data.options=[{value:"1", label: "<div class='square box-alt1'><div class='square-in'></div></div>"},
			{value:"2", label: "<div class='square box-alt2'><div class='square-in'></div></div>"},
			{value:"3", label: "<div class='square box-alt3'><div class='square-in'></div></div>"},
			{value:"4", label: "<div class='square box-alt4'><div class='square-in'></div></div>"},
			{value:"5", label: "<div class='square box-alt5'><div class='square-in'></div></div>"},
			{value:"6", label: "<div class='square box-alt6'><div class='square-in'></div></div>"},
			{value:"7", label: "<div class='square box-alt7'><div class='square-in'></div></div>"},
			{value:"8", label: "<div class='square box-alt8'><div class='square-in'></div></div>"},
			{value:"9", label: "<div class='square box-alt9'><div class='square-in'></div></div>"}
		];
		
		if (data.role=="heatmap"){
			data.options=[
				{value:"1", label: "<div class='square' style='background-color:#f44242'><div class='square-in'></div></div>"},
	  			{value:"2", label: "<div class='square' style='background-color:#f4a341'><div class='square-in'></div></div>"},
	  			{value:"3", label: "<div class='square' style='background-color:#f7e411'><div class='square-in'></div></div>"},
	  			{value:"4", label: "<div class='square' style='background-color:#96e530'><div class='square-in'></div></div>"},
	  			{value:"5", label: "<div class='square' style='background-color:#2cd64c'><div class='square-in'></div></div>"}
			  ];
		}
	};
	
	this.__value = null;
	this.__data = null;
	this.__css = {};
	this.options = $.extend({}, {type:"text", name:"input", "placeholder":"", css:"", id: AP.uuid(), 'class':'', readOnly: false, role: "", extra: {}, verbatim: 0, inline_add: null, __original: null}, data);
	this.__fx = null;
	this.__extra = "";
	
	if (data.data){
		this.__data=data.data;
	}
	
	this.value=function(value){
		if (value === null || value === undefined){
			return this;
		}
		
		if (this.options && this.options.type && (this.options.type=="textarea"|| this.options.type=="text")){
			if (this.options.role!="editor" && !this.options.verbatim){
				value=cleanText(value);
			}
		}
		
		if ($.isFunction(value)){
			this.__value=value();
		}else{
			this.__value=value;	
		}
		return this;
	};
	
	
	/**
	 * @desc Set extra HTML below the row
	 */
	this.extra=function(extra_html){
		this.options.__extra=extra_html;
		return this;
	};
	
	this.valueIf=function(value, cond){
		if (!cond){
			return this;
		}
		
		return this.value(value);
	};
	
	
	this.data=function(data){
		this.__data=data;
		return this;
	};
	
	
	this.autoSubmit=function(){
		this.__autos=1;
		return this;
	};
	
	
	this.readOnly=function(){
		this.options.readOnly=true;
		this.options.v1_readOnly = true;
		return this;
	}
	
	this.css=function(css){
		this.__css=css;
		return this;
	};
	
	this.fx=function(fx){
		this.__fx=fx;
		return this;
	};
	
	this.on=function(cond, fx){
		if (cond){
			fx.apply(this);
		}
		
		return this;
	};
	
	this.html=function(){
		if (this.options.type=='placeholder'){
			return UIInputRender.placeholder(this.options);
		}
		
		if (this.options.type=='text'){
			return UIInputRender.text(this.options);
		}
		
		if (this.options.type=='textarea'){
			return UIInputRender.textarea(this.options);
		}
		
		if (this.options.type=='icons'){
			return Form.icon.render(this.options);
		}
		
		if (this.options.type=='fav'){
			return Form.icon.renderFav(this.options);
		}
		
		if (this.options.type=='select'){
			return UIInputRender.select(this.options);
		}
		
		if (this.options.type=='fake'){
			return UIInputRender.fake(this.options, this.__value);
		}
		
		if (this.options.type=='file'){
			return UIInputRender.file(this.options, this.__value);
		}
		
		if (this.options.type=='files' || this.options.type=='filelist'){
			return UIInputRender.files(this.options, this.__value);
		}
		
		if (this.options.type=='password'){
			return UIInputRender.password(this.options);
		}
		
		if (this.options.type=='checkbox'){
			return UIInputRender.checkbox(this.options);
		}
		
		if (this.options.type=='checkboxes'){
			return UIInputRender.checkboxes(this.options);
		}
		
		if (this.options.type=='checkbox-list' || this.options.type=='checkboxlist'){
			return UIInputRender.checkboxList(this.options);
		}
		
		if (this.options.type=='colors'){
			return UIInputRender.pickColors(this.options);
		}
		
		if (this.options.type=='orgchart' || this.options.type=='usergroup'){
			return UIInputRender.pickOrgchart(this.options);
		}
		
		if (this.options.type=='datetime'){
			return UIInputRender.datetime(this.options);
		}
		
		if (this.options.type=='tags'){
			return UIInputRender.tags(this.options);
		}
		
		if (this.options.type=='dob'){
			return UIInputRender.dob(this.options);
		}
		
		if (this.options.type=='list'){
			return UIInputRender.list(this.options);
		}
		
		if (this.options.type=='lines'){
			return UIInputRender.lines(this.options);
		}
		
		if (this.options.type == "icon"){
			return Form.icon.v2(this.options, this.__value);
		}
		
		if (this.options.type=='html'){
			return UIInputRender.customHTML(this.options);
		}
		
		if (this.options.type=='hidden'){
			return "<div class='hidden hidden-row'><input type='hidden' name='"+(this.options.name)+"' value='"+(this.__value)+"'/></div>";
			// return UIInputRender.customHTML(this.options);
		}
		
		if (this.options.type == "container-open" || this.options.type == "open"){
			
			var title ='';
			if (this.options.placeholder){
				title= "<div class='-cb-title'><span class='url' data-url=':active:parent:parent' data-active-class='activated'>"+(this.options.placeholder)+"</span></div>";
			}
			
			var show = false;
			if (this.options.__original && this.options.__original.show){
				show = true;
			}

			if (this.options.__original && this.options.__original.open){
				show = true;
			}
			
			var _id = AP.uuid();
			if (this.options.__original && this.options.__original.id){
				_id = this.options.__original.id;
			}
			
			return "<div class='fx-container-box js-row row "+(show?' activated':'')+"' id='"+(_id)+"'> "+(title)+" <div class='-cb-body'>";
		}
		
		
		if (this.options.type == "container-close" || this.options.type == "close"){
			return "</div></div>";
		}
		
		if (this.options.type == "filebox"){
			return "<div class='js-filebox input-filebox-wrapper' id='"+(this.options.id)+"'></div>";
		}

		if (this.options.type == "cover"){
			return "<div class='js-cover input-cover-wrapper' id='"+(this.options.id)+"'></div>";
		}
		
		if (this.options.type == "switch"){
			return "<div class='js-switch input-switch-wrapper' id='"+(this.options.id)+"'></div>";
		}
		
		if (this.options.type == "label"){
			return "<div class='js-label input-label-wrapper' id='"+(this.options.id)+"'></div>";
		}
		
		if (this.options.type == "box-select"){
			return "<div class='js-box-select input-box-select' id='"+(this.options.id)+"'></div>";
		}
		
		if (this.options.type == "color"){
			return "<div class='js-cpicker input-cpicker-wrapper' id='"+(this.options.id)+"'></div>";
		}

		if (this.options.type == "full-icon" || this.options.type == "icon-full"){
			return "<div class='js-full-icon input-full-icon' id='"+(this.options.id)+"'></div>";
		}
		
		
		if (this.options.type){
			return Form.customElem.render(this.options);
		}
		
		return "";
	};
	
	this.update=function(canvas){
		if (this.__data!==null){
			for (var key in this.__data){
				$("#"+this.options.id).data(key, this.__data[key]);
			}
		}
		
		if (this.options.type == "icon"){
			return Form.icon.v2SetValue(this.options.id, this.__value);
		}
		
		if (this.options.type == "text" && this.options.icon_picker == "full"){
			Form.icon.v2SetValue(this.options.id+"-ip", this.options.icon);
		}
		
		if (this.options.type == "text" && this.options.color_picker == "full"){
			Form.icon.colorPickerInit(this.options.id);
		}
		
		if (Form.customElem.defined(this.options.type)){
			return Form.customElem.update(this.options.type, "#"+this.options.id, this, this.options.__original);
		}
		
		if (this.options.type == "filebox"){
			$("#"+this.options.id).html("  " +Render.render('input_filebox', {_name:this.options.name, value:this.__value||[]}, '')+ '');
			Render.finish(); 
			return;
		}
		
		if (this.options.type == "cover"){
			$("#"+this.options.id).html("  " +Render.render('input_cover', {_name:this.options.name, value:this.__value||'', ratio:this.options.__original.ratio||'16:9', template:this.options.__original.template||''}, '')+ '');
			Render.finish();
			return;
		}
		
		if (this.options.type == "box-select"){
			$("#"+this.options.id).html("  " +Render.render('input_box_select', {_name:this.options.name, value:this.__value||'', options:this.options.__original.options||''}, '')+ '');
			Render.finish();
			return;
		}
		
		if (this.options.type == "full-icon"){
			$("#"+this.options.id).html("  " +Render.render('input_full_icon', {_name:this.options.name, value:this.__value||'', icon:this.options.__original.icon||'', color:this.options.__original.color||''}, '')+ '');
			Render.finish();
			return;
		}
		
		if (this.options.type == "color"){
			var presets = this.options.__original?this.options.__original.presets:0;
			$("#"+this.options.id).html("  " +Render.render('input_color', {_name:this.options.name, value:this.__value||'', presets:presets}, '')+ '');
			Render.finish();
			return;
		}
		
		if (this.options.type == "switch"){
			$("#"+this.options.id).html("  " +Render.render('input_switch', {_name:this.options.name, value:this.__value||'', placeholder:this.options.placeholder||''}, '')+ '');
			Render.finish();
			return;
		}
		
		if (this.options.type == "label"){
			$("#"+this.options.id).html("<div class='js-picked url' data-name='"+(this.options.name)+"' data-url=':active/1'> " +Render.render('picked_labels', {options:this.options.options, value:this.__value||'', _name:this.options.name, placeholder:this.options.placeholder}, '')+ "</div> " +Render.render('pick_labels', {options:this.options.options, multiple:this.options.__original.multiple||0, add:this.options.__original.add||null, inline:1}, '')+ "");
			
			var _opts = this.options;
			$("#"+this.options.id+" .pick-labels").on("picked pick-change", function(event, data){
				if (event.type == "picked"){
					$(this).closest(".input-label-wrapper").removeClass("-active");
				}
				
				$(this).closest(".input-label-wrapper").find(".js-picked").html("  " +Render.render('picked_labels', {options:_opts.options, value:data, _name:_opts.name, url: ":active/1" }, '')+ '');
			});
			
			return;
		}
		
		if (this.options.type == "text"){
			var $prefix = $("#"+this.options.id).parent().find(".-ip-prefix");
			if ($prefix.length){
				$("#"+this.options.id).css("padding-left", $prefix.width()+38);
			}
		}
		
		if (this.options.type == "textarea" && !this.role && !this.editor){
			$("#"+this.options.id).autoExpand();
		}
		
		if (this.__value!==null){
			if (this.options.type=='checkbox'){
				if (parseInt(this.__value)){
					$("#"+this.options.id).prop("checked", true);
				}else{
					$("#"+this.options.id).prop("checked", false);
				}
			}else if (this.options.type=='colors'){
				uiinput_pick_by_id(this.options.id, this.__value);
			}else if (this.options.type=='datetime'){
				if (this.__value && parseInt(this.__value)){
					$("#"+this.options.id+"-date").val(UI.inputDate(this.__value));
					$("#"+this.options.id+"-time").val(AP.time.time("%H:%i", this.__value));	
				}
			}else if (this.options.role=='time'){
				if (AP.data.isInt(this.__value)){
					$("#"+this.options.id+"").val(AP.time.time("%H:%i", this.__value));
				}else{
					$("#"+this.options.id+"").val(this.__value);
				}
				
			}else if (this.options.role=='date'){
				var val=this.__value;
				if (AP.data.isInt(val) && val!="0"){
					val=UI.inputDate(val);
				}
				$("#"+this.options.id+"").val(val);
			}else if (this.options.role=='tag' || this.options.role=='user'){
				var val=this.__value;
				if (AP.data.isArray(val)){
					val=AP.word.join(val, " ",function(e){
						if (AP.data.isObject(e)){
							return "@"+e.username;
						}else if (AP.data.isInt(e)){
							var u = People.get(e);
							if (u && !u.error){
								return "@"+u.username;
							}
						}
						
						return "@"+e;
					});
				}else if (val && AP.data.isString(val)){
					if (!AP.word.prefix(val, "@")){
						val="@"+val;	
					}
				}else if (val && AP.data.isInt(val)){
					var p=People.get(val);
					if (p && !p.error){
						val="@"+p.username;
					}else{
						val="";
					}
				}
				$("#"+this.options.id+"").val(val);
			}else if (this.options.role=='teams'){
				var val=this.__value;
				var e_val="";
				if (AP.data.isArray(val)){
					e_val=AP.word.join(val, " ",function(e){
						if (AP.data.isString(e)){
							var ts=UserGroup.get(e);
							
							if (ts){
								return ts.name+" (@"+ts.path+"), ";
							}
						}else if (AP.data.isInt(e)){
							var ts=UserGroup.get(e);
							if (ts){
								return ts.name+" (@"+ts.path+"), ";
							}
						}
						
						return e.name+" (@"+e.path+"), ";
					});
				}
				
				$("#"+this.options.id+"").val(e_val);
			}else if (this.options.type=='checkbox-list'){
				uiinput_check_setval($("#"+this.options.id).closest('.list-checkbox'), null, this.__value);
			}else if (this.options.type=='checkboxes'){
				if (this.__value && this.__value.length){
					var __value=this.__value;
					$("#"+this.options.id+" input[type=checkbox]").each(function(){
						var value=$(this).data("dvalue");
						if (__value==":all" || __value=="@all" || AP.array.contain(__value, value)){
							$(this).prop("checked", true);
						}
					});
				}
			}else if (this.options.type=='list'){
				// uiinput_pick($("#"+this.options.id).closest('.list-checkbox'), null, this.__value);
				uiinput_pick_by_id(this.options.id, this.__value);
			}else if (this.options.type!='fake' && this.options.type!='file'){
				if (this.options.type=='textarea'){
					if (this.options.verbatim){
						$("#"+this.options.id).val(this.__value);
					}else{
						$("#"+this.options.id).val(Textarea.raw(this.__value));	
					}
						
				}else{
					if (AP.data.isArray(this.__value) && this.__value.length){
						$("#"+this.options.id).data("__value",this.__value);	
					}
					$("#"+this.options.id).val(this.__value);	
				}
			}else if (this.options.type=='lines'){
				$.log([$("#"+this.options.id)]);
			}
		};
		
		
		// Handling tag
		
		var role = this.options.role;
		var ip = "#"+this.options.id;
		var _context = [];
		
		if (role=="tag" || role == "user"){
			if ((this.options.__original && this.options.__original.context=="global") || (this.options.data && this.options.data.context=="global")){
				_context = Client.people;
			}else if ((this.options.__original && this.options.__original.context=="local") || (this.options.data && this.options.data.context=="local")){
				_context = Tag.people();
			}else if (this.options.__original && this.options.__original.context && AP.data.isArray(this.options.__original.context)){
				_context = this.options.__original.context;
			}else{
				_context = Client.people;	
			}
		
			if (role=="user"){
				Tag.singleUser(ip, _context);
			}else{
				Tag.user(ip, _context);	
			}
		}
		
		
		
		
		
		$("#"+this.options.id).css(this.__css);
		if (this.__fx){
			this.__fx.apply($("#"+this.options.id));
		}
		
		
		if (this.__autos){
			$("#"+this.options.id).enter(function(){
				$(this).closest("form").find(".form-buttons .button.ok").click();
			});
		}
		
		if (this.options.role=="editor"){
			var mh=200;
			if (this.options.minHeight){
				mh=this.options.minHeight;
			}else if (this.options.height){
				mh=this.options.height;
			}
			
			$("#"+this.options.id).css("min-height", mh);
			
			UI.editor("#"+this.options.id, {
				panel: "bottom",
				minHeight: mh,
				bubble: (this.options && this.options.__original && this.options.__original.bubble)?1:0,
				compact: (this.options && this.options.__original && this.options.__original.bubble)?1:0
			});
			
			if (this.__value && AP.config && AP.config.editor=="quill"){
				UI.editorValue("#"+this.options.id, this.__value);
			}
			
			return;
		}
		

		if (this.options.role=="markdown"){
			$('#'+this.options.id).addClass("js-markdown-ip").hide().after("<div class='js-toast-ui-wrapper toast-ui-wrapper' id='"+(this.options.id)+"-markdown'></div>");
			
			var _viewer = new toastui.Editor({
				el: document.querySelector('#'+this.options.id+'-markdown'),
				height: '500px',
				previewStyle: 'tab',
				initialValue: this.__value||'',
				placeholder: this.options.placeholder||'Write down your content',
				events: {
					change: function(event){
						var content = _viewer.getMarkdown();
						$(_viewer.layout.el).closest(".input").find(".js-markdown-ip").val(content);
					}
				},
				hooks: {
					addImageBlobHook: Form.__toastImageHook
				}
			});
			
			
			
			return;
		}
		
		
		if (this.options.type=="lines" || this.options.role=="lines"){
			Form.list.init("#"+this.options.id,{
				value: this.__value,
				placeholder:this.options.placeholder,
				__data: this.options.data
			});
		}
		
		if (this.options.type=="select" && !this.options.multiple && this.options.__original && this.options.__original.improved){
			Form.improveSelect("#"+this.options.id, {
				value: this.__value||null
			});
		}
		
		if (this.options.type=="select" && this.options.multiple){
			Form.improveSelect("#"+this.options.id, {
				multi: this.options.multiple,
				value: this.__value||null
			});
		}
	};
	
	
	function cleanText(str){
		if (str && AP.data.isString(str)){
			return str.toTextarea();
		}
		
		return str;
	};
};




Form.__toastImageHook = function(blob, callback){
	var form_data = new FormData();
	
	form_data.append('file', blob);
	form_data.append('__code', Client.code);
	form_data.append('__otp', Client.base.secureData.otp);
	form_data.append('__sessionid', Client.base.secureData.session);
	
	UI.ajaxShow();
	$.ajax({
		data: form_data,
		type: "POST",
		url: Base.domain("api")+"/ajax/api/file/upload",
		cache: false,
		contentType: false,
		processData: false,
		success: function(code){
			UI.ajaxHide();
			
			var c=new Code(code);
			if (!c.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.image);
		}
	});
}

var UIInputRender=new function __UIInputRender(){
	
	this.placeholder=function(options){
		return "<div class='ui-placeholder' id='"+(options.id)+"'></div>";
	};
	
	this.text=function(options){
		var note="";
		if (options.note){
			note="<div class='note'>"+options.note+"</div>";
		}
		
		var icon_picker='';
		
		if (options.icon_picker == 'full'){
			var temp_opts={id: options.id+"-ip"};
			icon_picker="<div class='icon-picker-v2'>"+(Form.icon.v2(temp_opts))+"</div>";
		}else if (options.icon_picker == 'iconbox'){
			var icx="  " +Render.render('icon', {icon: "icon_edit" , color: "main" }, '')+ '';
			if (options.icon){
				icx="  " +Render.render('iconbox', {iconbox:options.icon, square:1}, '')+ '';
			}
			
			icon_picker="<div class='inline-icon-picker -no-bg'> <input type='hidden' name='icon' value='"+(options.icon||'')+"'/> <span class='icon-display url' data-url='::base/iconbox'>"+(icx)+"</span> </div>";
		}else if (options.icon_picker){
			var icx="";
			if (AP.data.isInt(options.icon_picker)){
				icx="<img src='"+(Client.share_url)+"/fav_icons/"+(options.icon_picker)+".png'/>";
			}
			
			icon_picker="<span class='inline-icon-picker'> <input type='hidden' name='icon'/> <span class='icon-display url' data-url=':active:parent'>"+(icx)+"</span> "+(Form.icon.inlinePicker())+" </span>";
		}else if (options.emoji_picker){
			var icx="  " +Render.render('icon', {icon: "emoji_smile" , color: "#aaa" }, '')+ '';
			
			if (options.emoji){
				icx="  " +Render.render('icon', {emoji:options.emoji}, '')+ '';
			}
			
			icon_picker="<span class='inline-icon-picker'> <input type='hidden' name='emoji' value='"+(options.emoji||'')+"'/> <span class='icon-display url' data-url='::base/emoji'>"+(icx)+"</span> </span>";
		}
		
		
		if (options.color_picker && options.color_picker=='full'){
			icon_picker=Form.icon.colorPickerHTML(options.id, options.color);
		}else if (options.color_picker){
			var color_display='';
			if (!options.color){
				options.color=0;
			}else{
				options.color=parseInt(options.color);
				color_display="<div class='icx -bg-alt"+(options.color)+"'></div>";
			}
			
			icon_picker="<span class='inline-icon-picker url' data-url=':fn:UIInputRender.pickColor'> <input type='hidden' name='color' value='"+(options.color||'')+"'/><span class='icon-display url' data-url=':active:parent'>"+(color_display)+"</span> </span>";
		}
		
		
		var icon="";
		if (options.role=="date"){
			icon="<span class='-ap icon-uniF1072' style='position: absolute; right:10px; top:10px; color:#aaa; font-size:16px;'></span>";
		}
		
		var unit="";
		if (options.unit && options.unit.length){
			icon="<span class='unit-text' style='position: absolute; right:10px; top:9px; color:#aaa; font-size:12px; text-transform:uppercase'>"+options.unit+"</span>";
		}
		
		
		var prefix = '';
		if (options.__original && options.__original.prefix){
			prefix = "<span class='-ip-prefix'>"+(options.__original.prefix)+"</span>";
		}
		
		return "<div class='input data'>"+icon+unit+prefix+"<input autocomplete='off' data-role='"+options.role+"' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"' type='text' name='"+options.name+"' placeholder='"+options.placeholder+"' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/></div>"+note + icon_picker+getExtra(options);
	};
	
	this.textarea=function(options){
		var input="<textarea data-role='"+options.role+"' "+(options.readOnly?" readonly ":"")+" id='"+options.id+"' name='"+options.name+"' placeholder='"+options.placeholder+"'></textarea>";
		if (options.role=="editor"){
			return "<div class='input data'><div class='input-editor'>"+input+"</div></div>";	
		}
		
		return "<div class='input data'>"+input+"</div>"+getExtra(options);
	};
	
	this.lines=function(options){
		var input="<textarea data-role='"+options.role+"' "+(options.readOnly?" readonly ":"")+" id='"+options.id+"' name='"+options.name+"' placeholder='"+options.placeholder+"'></textarea>";
		return "<div class='input data'>"+input+"</div>";
	};
	
	
	this.password=function(options){
		return "<div class='input data'><input "+(options.readOnly?" readonly ":"")+" id='"+options.id+"' class='std' type='password' name='"+options.name+"' placeholder='"+options.placeholder+"'/></div>";
	};
	
	this.select=function(options){
		if (options.role=="team"){
			return "<div class='select data' data-role='team'><select "+(options.readOnly?" disabled ":"")+" id='"+options.id+"' name='"+options.name+"'>"+Tag.teamOptions()+"</select></div>";
		}
		
		var data="";
		
		if (options.optgroups && options.optgroups.length){
			for (var i=0; i<options.optgroups.length; i++){
				var g=options.optgroups[i];
				
				data+="<optgroup label='"+optObjName(g)+"'>"+AP.render(g.items, function(e){
					return "<option value='"+e.id+"'>"+optObjName(e)+"</option>";
				})+"</optgroup>";
			}
			
			if (options.empty){
				data="<option value='"+options.empty.value+"'>"+options.empty.label+"</option>"+data;
			}
		}else{
			if (!options.options){
				console.warn("Select options empty", options);
				return;
			}
			
			if (AP.data.isString(options.options)){
				data=options.options;
			}else{
				for (var i=0; i<options.options.length; i++){
					var opt=options.options[i];
					if (AP.data.isObject(opt)){
						if (!opt.label && (!opt.value || opt.name) && opt.id){
							data+="<option value='"+opt.id+"'>"+optObjName(opt)+"</option>";
						}else{
							data+="<option value='"+opt.value+"'>"+opt.label+"</option>";	
						}	
					}else{
						data+="<option value='"+opt+"'>"+opt+"</option>";
					}
				}
			}
			
			
			if (options.empty){
				data="<option value='"+options.empty.value+"'>"+options.empty.label+"</option>"+data;
			}
		}
		
		
		var select = "<select "+((options.multiple?' multiple':''))+" id='"+(options.id)+"' name='"+(options.name)+"'> "+(data)+" </select>";
		
		if (options.readOnly && !options.v1_readOnly){
			var rip = '';
			var v = '';
			var dv = ' --- ';
			
			if (options.__original && options.__original.value){
				v = options.__original.value
				var opt = ARR.single(options.options, function(e){
					return (se(e.id, v));
				});
				
				if (opt){
					dv = opt.name;
				}
			}
			
			rip = "<input type='hidden' name='"+(options.name)+"' value='"+(v)+"'/>";
			select = ""+(rip)+"<div class='input data'><div class='input-fake ap-xdot' id='"+(options.id)+"'>"+(dv)+"</div></div>";
		}else if (options.readOnly){
			var select = "<select disabled "+((options.multiple?' multiple':''))+" id='"+(options.id)+"' name='"+(options.name)+"'> "+(data)+" </select>";
		}
		
		return "<div class='select data'> "+(select)+" </div>"+(getExtra(options))+"";
	};
	
	this.fake=function(options, value){
		return "<div class='input data'><div class='input-fake ap-xdot' id='"+options.id+"'>"+value+"</div></div>";
	};
	
	this.file=function(options, value){
		var extra="";
		if (value && value.length){
			extra="<div class='filelink'><a href='"+value+"' target='_blank'>"+options.placeholder+"</a></div>";
		}
		
		var accept = '';
		if (options.__original && options.__original.accept){
			accept = " accept= '"+(options.__original.accept)+"'";
		}
		
		return "<div class='input data'> <input id='"+(options.id)+"' type='file' "+(accept)+" name='"+(options.name)+"'/> "+(extra)+" </div> "+(getExtra(options))+"";
	};
	
	
	this.files=function(options, value){
		var extra="";
		var files="";
		var max=options.max;
		
		if (!max){
			if (options.__original){
				max=options.__original.max_files || options.__original.max || 0;	
			}
		}
		
		if (!max){
			max=3;
		}
		
		var accept = '';
		if (options.__original && options.__original.accept){
			accept = " accept= '"+(options.__original.accept)+"'";
		}
		
		for (var i=0; i<max; i++){
			files+="<div class='fi "+(i==0?"":"hidden")+"'><input id='"+options.id+"-"+i+"' "+accept+"onchange='UIInputRender.__fileUpdate(this);' type='file' name='"+options.name+"-"+i+"'/></div>";
		}
		
		return "<div class='input data xflat'>"+files+"</div>"+getExtra(options);
	};
	
	
	/**
	 * @desc Update file on filelist
	 */
	this.__fileUpdate=function(ref){
		var val=$(ref).val();
		if (!val){
			return;
		}
		var $next=$(ref).closest(".fi").next();
		if ($next.length){
			$next.show();
		}
	};
	
	
	this.checkbox=function(options){
		var checked="";
		if (options.checked){
			checked="checked";
		}
		
		var ratio = 0;
		if (options && options.__original && options.__original.ratio){
			ratio = 1;
		}
		
		return "<div class='data ap-f15 -ischeckbox "+(ratio?'-ratio':'')+"'> <label class='block'> <input id='"+(options.id)+"' style='vertical-align:-2px' type='checkbox' "+(checked)+" name='"+(options.name)+"'/> <span class='checkmark'></span> "+(options.placeholder||'')+" </label> </div>";
	};
	
	
	this.checkboxes=function(options){
		var html="";
//		if (options.checked){
//			checked="checked";
//		}
//		return "<div class='data ap-f15'><input id='"+options.id+"' style='vertical-align:-2px' type='checkbox' "+checked+" name='"+options.name+"'/> &nbsp; "+options.placeholder+"</div>";
		
		for (var i=0; i<options.options.length; i++){
			var name=options.name;
			
			var opt=options.options[i];
			var label=opt.label;
			var value=opt.value;
			
			if (typeof(opt.id) != "undefined" && typeof(opt.name) != "undefined"){
				value=opt.id;
				label=opt.name;
			}
			
			html+="<label class='li block' data-value='"+value+"'><input type='checkbox' name='"+name+"[]' value='"+value+"' data-dvalue='"+value+"'/><span class='checkmark'></span>"+label+"</label>";
		}
		
		return "<div class='data'><div class='list checkboxes' id='"+options.id+"'>"+html+"</div></div>";
	};
	
	
	this.pickColors=function(options){
		var html="";
		for (var i=0; i<options.options.length; i++){
			var opt=options.options[i];
			html+="<div class='opt' data-value='"+opt.value+"' onclick=\"uiinput_pick(this);\">"+opt.label+"</div>";
		}
		return "<div class='colors data'>" +
				"<div style='display:none'><input id='"+options.id+"' style='display:none' name='"+options.name+"'/></div>" +
				"<div class='options'>"+html+"</div>" +
			"</div>";
	};

	
	this.pickOrgchart=function(options){
		var users=getUserCheckboxes(options.options);
		return "<div class='form-org-picker'> <div class='hidden'><textarea name='"+(options.name)+"'></textarea></div> <div class='form-org-users scroll-y unselectable'>"+(users)+"</div> </div>";
	};
	
	
	this.datetime=function(options){
		if (Client.native){
			return "<div class='input data'>" +
				"<input style='' data-role='date' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-date' type='text' name='"+options.name+"-date' placeholder='Type to select a date' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"' autocomplete='off'/>" +
				"<input style='margin-top:10px' data-role='time' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-time' type='text' name='"+options.name+"-time' placeholder='Type to select a time' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/>" +
			"</div>";
		}
		
		var dicon="<span class='-ap icon-uniF1072 -date-icon' style='position: absolute; right:8px; top:7px; color:#aaa; font-size:16px;'></span>";
		var ticon="<span class='-ap icon-uniF10B -date-icon' style='position: absolute; right:8px; top:7px; color:#aaa; font-size:16px;'></span>";
		
		return "<div class='input data clear-fix fi-datetime'>" +
			"<div class='relative fi-datetime-date' style='float:left; width:200px'>"+dicon+"<input autocomplete='off' data-role='date' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-date' type='text' name='"+options.name+"-date' placeholder='Nháº¥n Ä‘á»ƒ chá»n ngĂ y' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/></div>" +
			"<div class='relative fi-datetime-time' style='float:left; margin-left:6px; width:200px'>"+ticon+" <input data-role='time' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-time' type='text' name='"+options.name+"-time' placeholder='Nháº¥n Ä‘á»ƒ chá»n thá»i gian' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'/></div>" +
		"</div>";
	};
	
	
	this.tags=function(options){
		return "<div class='input data'> <div class='selected-tags-wrapper'> <input type='hidden' name='"+(options.name)+"'/> <div class='selected-tags'> <div class='none'>Please select tags</div> </div> </div> </div>";
	};
	
	
	this.dob=function(options){
		if (Client.native){
			
		}
		
		return "<div class='input data'>" +
			"<select style='float:left; width:32%' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-day' type='text' name='"+options.name+"-day' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'>"+dobDays()+"</select>" +
			"<select style='float:left; width:32%; margin-left:2%'"+(options.readOnly?" readonly ":"")+"id='"+options.id+"-month' type='text' name='"+options.name+"-month' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'>"+dobMonths()+"</select>" +
			"<select style='float:left; width:32%; margin-left:2%' "+(options.readOnly?" readonly ":"")+"id='"+options.id+"-year' type='text' name='"+options.name+"-year' class='std "+(options.readOnly?" -readonly ":"")+""+options['class']+"'>"+dobYears()+"</select>" +
		"</div>";
	};
	
	
	this.customHTML = function(opts){
		return "<div class='input-custom-html'>"+(opts.html)+"</div>";
	};
	

	this.list=function(options){
		var html="";
		for (var i=0; i<options.options.length; i++){
			var opt=options.options[i];
			var sublabel=(opt.sublabel)?"<div class='sublabel'>"+opt.sublabel+"</div>":"";
			html+="<div class='opt' data-value='"+opt.value+"' onclick=\"uiinput_pick(this);\"><div class='circle'><div class='cin'></div></div>"+opt.label+sublabel+"</div>";
		}
		
		if (options.wrap){
			html="<div class='list-wrap'>"+html+"</div>";
		}
		
		return "<div class='list-radio data' data-empty='"+(options.empty?1:0)+"'>" +
				"<div style='display:none'><input id='"+options.id+"' style='display:none' name='"+options.name+"'/></div>" +
				"<div class='options'>"+html+"</div>" +
			"</div>";
	};
	
	
	this.checkboxList=function(option){
		var items = AP.render(option.options, function(opt){
			var checked = (opt.value&&parseInt(opt.value))?'checked':'';
			var cp = mobile();
			if (!cp && 'compact' in opt && opt.compact === 0){
				cp = 1;
			}
			
			return "<div class='liw "+(cp?'':'-compact')+"'> <label class='li block unselectable'> <input type='checkbox' name='"+(opt.name)+"' "+(checked)+"/> <span class='checkmark'></span> "+(opt.label||opt.title)+" </label> </div>";
		});
		
		return "<div class='list checkboxes -simple'>"+(items)+"</div>";
	};

	
	
	this.pickColor=function(ref){
		Form.inlineColorTagger(ref, function(color){
			$(this).closest(".ap-inline-colors-wrap").find(".icon-display").html("<div class='icx -bg-alt"+(color)+"'></div>")
			$(this).closest(".ap-inline-colors-wrap").find("input[name=color]").val(color);
		}, {
			auto: true,
			click: true,
			left:-100
		});
	};

	
	function dobDays(){
		return quickOptions(1, 31, "Chá»n ngĂ y");
	};
	
	function dobMonths(){
		return quickOptions(1, 12, "Chá»n thĂ¡ng");
	};
	
	function dobYears(){
		return quickOptions(1900, 2016, "Chá»n nÄƒm");
	};
	
	function quickOptions(start, end, empty){
		var html="<option value='0'>"+empty+"</option>";
		for (var i=start; i<=end; i++){
			html+="<option value='"+i+"'>"+AP.data.zeroPrefix(i)+"</option>";
		}
		
		return html;
	};
	
	
	
	/**
	 * @desc Getting extra options
	 */
	function getExtra(options){
		if (options.inline_add){
			var ix = options.inline_add;
			Form.inline_success_callback = ix.callback || ix.success;
			return "<div class='fi-extra'>&rarr; <span class='url' data-url='"+(ix.action)+"'>"+(ix.label)+"</span></div>";
		}
		
		if (!options.__extra){
			return "";
		}
		
		var extra = UI.textParse(options.__extra);
		
		
		return "<div class='fi-extra'>"+(extra)+"</div>";
		
	};
	
	/**
	 * @desc Get displayed name of object in select box
	 */
	function optObjName(obj){
		if ("opt_name" in obj){
			return obj.opt_name; 
		}
		
		return obj.name;
	};
	
	
	
	function getUserCheckboxes(tree){
		var users=AP.render(tree.nodes, function(e){
			if (e.metatype=="user"){
				return "<div class='fo-user' data-username='"+(e.username)+"' onclick='fo_toggleUser(this)'> <div class='level level-"+(e.level)+"'> <div class='fo-cb'></div> <div class='fo-display-name'>"+(e.name)+" <span class='fo-username'>@"+(e.username)+"</span></div> </div> </div>";
			}else{
				return getUserCheckboxes(e);
			}
		});
		
		var manager="";
		if (tree.user_id && parseInt(tree.user_id) && tree.username){
			var u=People.get(tree.user_id);
			if (u && parseInt(u.id)){
				manager="<div class='fo-user' data-username='"+(u.username)+"' onclick='fo_toggleUser(this)'> <div class='level level-"+(tree.level+1)+"'> <div class='fo-cb'></div> <div class='fo-display-name'>"+(u.name)+" <span class='fo-username'>Manager &middot; @"+(u.username)+"</span></div> </div> </div>";	
			}
		}
		
		var html="<div class='fo-node level-"+(tree.level)+"' data-id='"+(tree.id)+"'> <div class='fo-group' data-group='"+(tree.id)+"' onclick='fo_toggleGroup(this)'> <div class='level level-"+(tree.level)+"'> <div class='fo-cb'></div> <span class='fo-triangle'><span class='-ap icon-triangle-down'></span></span> &nbsp; "+(tree.name)+" </div> </div> <div class='fo-subnodes'> "+(manager)+" "+(users)+" </div> </div>";
		
		return html;
	};
	
	
};


function fo_toggleUser(ref){
	var $node=$(ref);
	
	var username=$node.data("username");
	$node.toggleClass("selected");
	
	if ($node.hasClass("selected")){
		fo_upperSelected($node);
	}else{
		$node.parents(".fo-node").each(function(){
			$(this).children(".fo-group").removeClass("selected");
		});
	}
	
	fo_syncData($node);
};

function fo_toggleGroup(ref){
	var $node=$(ref);
	
	var username=$node.data("username");
	$node.toggleClass("selected");
	
	if ($node.hasClass("selected")){
		$node.parent().find(".fo-user").addClass("selected");
		$node.parent().find(".fo-group").addClass("selected");
		
		fo_upperSelected($node);
	}else{
		$node.parent().find(".fo-user").removeClass("selected");
		$node.parent().find(".fo-group").removeClass("selected");
		
		$node.parents(".fo-node").each(function(){
			$(this).children(".fo-group").removeClass("selected");
		});
	}
	
	fo_syncData($node);
};


function fo_syncData($node){
	var $box=$node.closest(".form-org-picker");
	var $input=$box.find("textarea");
	var usernames=[];
	
	$box.find(".fo-user.selected").each(function(){
		usernames.push("@"+$(this).data("username"));
	});
	
	$input.val(usernames.join(" "));
};


function fo_upperSelected($node){
	var skip=false;
	$node.parents(".fo-node").each(function(){
		if (skip){
			return;
		}
		
		var total=$(this).children(".fo-subnodes").children().length;
		var user_selected=$(this).children(".fo-subnodes").children(".fo-user.selected").length;
		var group_selected=0;
		$(this).children(".fo-subnodes").children(".fo-node").each(function(){
			if ($(this).children(".fo-group.selected").length){
				group_selected++;
			}
		});
		
		
		if (total==user_selected+group_selected){
			$(this).children(".fo-group").addClass("selected");
		}else{
			skip=true;
		}
	});
};

function uiinput_pick(ref){
	var value=$(ref).data('value');
	var $options=$(ref).closest('.options');
	var $input=$options.prev().find('input');
	var empty=$(ref).closest(".data").data("empty");
	if (empty && (empty=="1" || empty==1)){
		empty=1;
	}else{
		empty=0;
	}
	
	$options.find('.opt').each(function(){
		if (AP.data.equal($(this).data('value'), value)){
			if (empty){
				if ($(this).hasClass("selected")){
					value=0;
					$(this).removeClass('selected');
				}else{
					$(this).addClass('selected');	
				}
			}else{
				$(this).addClass('selected');	
			}
		}else{
			$(this).removeClass('selected');
		}
	});
	
	$input.val(value).change();
};





function uiinput_pick_by_id(id, value){
	var $input=$("#"+id);
	var $options=$input.parent().next();
	
	$options.find('.opt').each(function(){
		if (AP.data.equal($(this).data('value'), value)){
			$(this).addClass('selected');
		}else{
			$(this).removeClass('selected');
		}
	});
	
	$input.val(value).change();
};




function uiinput_check(ref){
	var $ref=$(ref);
	var $input=$ref.find('input');
	var val=parseInt($input.val());
	
	if (val==0){
		uiinput_check_setval($ref, $input, 1);
	}else if (val==1){
		uiinput_check_setval($ref, $input, 0);
	}
};


function uiinput_check_setval($ref, $input, val){
	if ($input===null){
		$input=$ref.find('input');
	}
	
	if (val==1){
		$input.val(1);
		$ref.find('.square').replaceWith("<div class='square active'><span class='-ap icon-check2'></span></div>");
	}else{
		$input.val(0);
		$ref.find('.square').replaceWith("<div class='square'><span></span></div>");
	}

};function UIRow(label, input, type){
	this.label="";
	this.good=false;
	this.type="";
	this.input="";
	this.opts={};
	this.__css={};
	this.__classes=[];
	this.__inlinehmtl="";
	
	if (type){
		this.type=type;
		this.label=label;
		this.input=input;
	}else{
		if (input===null){
			this.label=label;
			this.good=false;
		}else{
			this.label=label;
			this.input=input;
			this.good=true;	
		}
	}
	
	this.id=AP.uuid();
	
	this.setType=function(type){
		this.type=type;
		return this;
	};
	
	
	this.setOptions=function(opts){
		this.opts=opts;
	};
	
	
	this.css=function(css){
		this.__css=css;
	};
	
	
	this.inline=function(html){
		this.__inlinehtml=html;
	};
	
	this.addClass=function(classname){
		this.__classes.push(classname);
	};
	
	this.html=function(){
		if (this.type && this.type=="custom-html"){
			return "<div class='row -custom' style='display:"+this.input.display+"' id='"+this.input.id+"'>"+this.label+"</div>";
		}
		
		if (this.type && this.type=="placeholder"){
			var raw_html='';
			if (this.input && this.input.raw_html){
				raw_html=this.input.raw_html;
			}
			
			if (this.input.__label){
				return "<div class='row'> <div class='label'>"+(this.input.__label)+"</div> <div class='row-placeholder' id='"+(this.label)+"'>"+(raw_html)+"</div> </div>";
			}
			
			return "<div class='row-placeholder' id='"+(this.label)+"'>"+(raw_html)+"</div>";
		}
		
		if (this.type && this.type=="wrapper"){
			if (!this.label){
				return "</div>";
			}else{
				var id=this.input;
				if (id){
					if (id.charAt(0)=="#"){
						id=id.substr(1);
					}
				}
				
				return "<div class='wrapper hidden'"+((id && id.length)?" id='"+id+"'":"")+"><div class='wtitle'>"+this.label+"</div> <div class='__ph'></div>"; // One DIV missing by intention
			}
		}
		
		
		if (this.type && this.type=="note"){
			return "<div class='row -"+this.input+"'>"+this.label+"</div>";
		}
		
		if (!this.good){
			return "<div class='row-sep'><div class='render'></div><em>"+this.label+"</em></div>";
		}
		
		var eclass="";
		if (this.opts.classes){
			eclass+=" "+this.opts.classes;
		}
		
		var extra_inline="";
		if (this.__inlinehtml && this.__inlinehtml.length){
			extra_inline="<div class='extra'>"+this.__inlinehtml+"</div>";
		}
		var etype="base";
		if (this.input && this.input.options && this.input.options.type){
			etype=this.input.options.type;
		}
		
		if (this.label.isEmpty()){
			eclass+=" -empty-label";
		}
		
		if (isContainer(this)){
			return this.input.html();
		}
		
		var hidden = (this.input && this.input.hidden)?' hidden':'';
		
		return "<div class='row -is"+(etype)+" "+(eclass)+" "+(hidden)+"' id='"+(this.id)+"'> "+(this.label.html())+" "+(this.input.html())+" "+(extra_inline)+" <div class='clear'></div> </div>";
	};
	
	
	this.update=function(row){
		$("#"+this.id).css(this.__css);
		for (var i=0; i<this.__classes.length; i++){
			$("#"+this.id).addClass(this.__classes[i]);
		}
	};
	
	
	function isContainer(obj){
		if (obj.input && obj.input.options){
			var t = obj.input.options.type;
			if (t == "container-open" || t == "open" || t == "container-close" || t == "close"){
				return true;
			}
		}
		
		return false;
	};
	
};var cForm=new function __cForm(){
	this.inputs=[];
	this.complete=null;
	this.saved=[];
	
	this.clean=function(){
		this.saved=[];
		this.inputs=[];
	};
	
	
	this.get=function(){
		return this.saved;
	};
	
	
	this.quickEdit=function(obj, url, callback){
		return this.edit.quick(obj, url, callback);
	};
	
	
	
	this.design=function(complete){
		this.inputs=[];
		this.ui.newForm();
		this.complete=complete;
		
		if (this.saved && this.saved.length){
			this.set(this.saved);
		}
	};
	
	
	this.set=function(inputs){
		this.inputs=inputs;
		for (var i=0; i<inputs.length; i++){
			this.ui.previewAdd(inputs[i]);
		}
		Form.balance("#custom-form-fx");
	};
	
	
	this.finishDesign=function(ref){
		// AP.closeDialog(ref);
		var fn=this.complete;
		var preview=this.ui.getPreview(this.inputs);
		fn(this.inputs, preview, this.ui.makeForm(this.inputs));
		this.saved=this.inputs;
	};
	
	
	this.attach=function(form, cform, values){
		var has_title=false;
		
		for (var i=0; i<cform.length; i++){
			var input=cform[i];
			if (input.disabled && parseInt(input.disabled)){
				continue;
			}
			
			var val = "";
			if (values != null && values.length) {
				for (var j = 0; j < values.length; j++) {
					if (values[j].id == cform[i].id) {
						val = values[j].value;
						break;
					}
				}
			}
			
			var name=input.name;
			if (parseInt(input.required)){
				name=name+" *";
			}
			
			if (input.placeholder) {
				input.placeholder=input.placeholder.replace(/â‘/g,'&#92;').replace(/&#9290;/g, '&#92;');
			}
			var placeholder=input.placeholder;
			if (!placeholder || !placeholder.length){
				placeholder=getDefaultPlaceHolder(input.type);
			}
			
			if (input.type=="select"){
				var opts=[];
			
				if(typeof input.options == 'undefined' || input.options == null) {
					input.options = input.values;
				}
				
				for (var j=0; j<input.options.length; j++){
					opts.push({label: input.options[j], value: input.options[j]});
				}
				
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'select', "placeholder": placeholder, name:"custom_"+input.id, options: opts}).value(val)
				);
			}else if (input.type=="int"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', role:"int", "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>int</em>"}).value(val)
				);
			}else if (input.type=="float"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', role:"int", "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>decimal</em>"}).value(val)
				);
			}else if (input.type=="date"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', role:"date", placeholder: placeholder, name:"custom_"+input.id, unit:"<em>date</em>"}).value(val)
				);
			}else if (input.type=="datetime"){
				var val_datetime = "";
				
				//check datetime val
				if (val) {
					var val_arr = val.split(" ");
					if (val_arr.length == 2){
						var val_date = val_arr[0];
						var val_time = val_arr[1];

						var val_date_arr = val_date.split("/");
						var val_time_arr = val_time.split(":");
						if (val_date_arr.length == 3 && val_time_arr.length == 2) {
							var date_obj = new Date(val_date_arr[1] + "/" + val_date_arr[0] + "/" + val_date_arr[2]);
							val_datetime = Math.floor(date_obj.getTime() / 1000);
							val_datetime += val_time_arr[0] * 3600 + val_time_arr[1] * 60;
						}
					}
				}

				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'datetime', role:"datetime", placeholder: placeholder, name:"custom_"+input.id}).value(val_datetime)
				);
			}else if (input.type=="textarea"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'textarea', "placeholder": placeholder, name:"custom_"+input.id}).css({'min-height': 120, resize: 'vertical', overflow: 'auto'}).value(val)
				);
			}else if (input.type=="title"){
				has_title=true;
				form.rowHTML("<div class='row-subtitle'>"+input.name+"</div>");	
			}else if (input.type=="file"){
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'file', role:"file", "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>file</em>"}).value(val)
				);
			} else if (input.type == "select-m") {
				var input_data = shallowClone(input);
		
				input_data.label = input.name;
				if (parseInt(input.required)){
					input_data.label = input_data.label + " *";
				}

				input_data.name = "custom_" + input.id;
				
				input_data.type = "select";
				input_data.multiple = 1;
				
				input_data.value = AP.word.split(",", val).map(function(e) {
					return $.trim(e);
				});
				
				var ip = Form.v2.getIPData(input_data);

				form.row(
					Form.label({label: input_data.label, "sublabel":input.placeholder}),
					ip
				).addClass("-active");
			} else if (input.type=="input-table") {

				var input_data = shallowClone(input);
				
				input_data.label = input.name;
				if (parseInt(input.required)){
					input_data.label = input_data.label + " *";
				}

				input_data.name = "custom_"+input.id;

				input_data.value = val ? val : "W10=";

				var ip = Form.v2.getIPData(input_data);

				form.row(
					Form.label({label: input_data.label}),
					ip
				).addClass("-active");
			} else {
				form.row(
					Form.label({label: name, "sublabel":input.placeholder}),
					Form.input({'type':'text', "placeholder": placeholder, name:"custom_"+input.id, unit:"<em>text</em>"}).value(val)
				);	
			}
		}
		
		if (has_title){
			form.rowHTML("<div class='row-subtitle -none'></div>");
		}
	};	
	
	
	this.attachInline=function(fields, canvas, values){
		for (var i=0; i<fields.length; i++){
			var val = "";
			if (values != null && values.length) {
				for (var j = 0; j < values.length; j++) {
					if (values[j].id == fields[i].id) {
						val = values[j].value;
						break;
					}
				}
			}
			
			attachSingleField(fields[i], canvas, val);
		};
		
		Form.render(canvas);
	};
	
	
	
	this.submit=function(url, exported, callback, extra_data){
		if ($("#instant-file-upload").length){
			$("#instant-file-upload").html("").empty().remove();
		}
		
		var $form=$("<form id='instant-file-upload' action='"+url+"' class='__temp'></form>");
		$form.appendTo("#ap-temp");
		$form.html(exported);
		
		UI.ajaxShow();
		AP.submit($form, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback();
		}, extra_data);
	};
	
	
	function getDefaultPlaceHolder(type){
		if (type=="int"){
			return "Vui lĂ²ng nháº­p má»™t sá»‘";
		}
		
		if (type=="double" || type=="float"){
			return "Vui lĂ²ng nháº­p má»™t sá»‘ tháº­p phĂ¢n";
		}
		
		if (type=="text"){
			return "Vui lĂ²ng nháº­p má»™t dĂ²ng kĂ½ tá»±";
		}
		
		if (type=="date"){
			return "Nháº¥n Ä‘á»ƒ chá»n ngĂ y";
		}
		
		return "";
	};
	
	
	/**
	 * @desc Insert a single field 
	 */
	function attachSingleField(field, canvas, value){

		if (field.type == "title") {
			var html = "<div class='is-title' data-type='"+(field.type)+"' title='"+(field.name)+"'>"+(field.name)+"</div>";
			$(canvas).append(html);

			return;
		}

		var df="";
		var name=field.name;
		if (parseInt(field.required)){
			name=name+" *";
		}
		
		var placeholder=field.placeholder;
		if (!placeholder || !placeholder.length){
			placeholder=getDefaultPlaceHolder(field.type);
		}
		if (placeholder && placeholder.length) {
			df="active";
		}
		
		var input="<input name='custom_"+(field.id)+"' value='"+(value)+"' placeholder='"+(placeholder)+"'/>";

		if (field.type=="int"){
			input= "<input name='custom_"+(field.id)+"' value='"+(value)+"' data-role='int' placeholder='"+(placeholder)+"'/>";
		}

		if (field.type=="float"){
			input= "<input name='custom_"+(field.id)+"' value='"+(value)+"' data-role='int' placeholder='"+(placeholder)+"'/>";
		}
		
		if (field.type=="date"){
			input= "<input name='custom_"+(field.id)+"' data-value='"+(value)+"' data-role='date' placeholder='"+(placeholder)+"'/>";
		}
		
		if (field.type=="datetime"){
			df="active";
			input= "<div class='wrap inline relative' style='width:60%'><input name='custom_"+(field.id)+"-date' data-value='"+(value)+"' placeholder='Nháº¥n Ä‘á»ƒ chá»n ngĂ y' data-role='date'/></div> <div class='wrap inline relative' style='width:30%'><input name='custom_"+(field.id)+"-time' data-value='"+(value)+"' data-role='time'/></div>";
		}

		if (field.type=="file"){
			df="active";
			input= "<input name='custom_"+(field.id)+"' data-value='"+(value)+"' type='file' placeholder='"+(placeholder)+"'/>";
		}
		
		if (field.type=="textarea"){
			df="active";
			var value_textarea = value ? value.br2nl() : "";
			input= "<textarea name='custom_"+(field.id)+"' data-autoexpand='1' data-maxheight='50'>"+(value_textarea)+"</textarea>";
		}
		
		if (field.type=="select"){
			df="active";
			
			var opts=AP.render(field.options, function(e){
				return "<option value='"+(AP.purify(e))+"'>"+(e)+"</option>";
			});
			
			input= "<select name='custom_"+(field.id)+"' data-value='"+(value)+"'>"+(opts)+"</select>";
		}
		
		if (field.type=="select-m"){
			var opts=AP.render(field.options, function(e){
				return "<option value='"+(AP.purify(e))+"'>"+(e)+"</option>";
			});
			
			input= "<select name='custom_"+(field.id)+"' multiple>"+(opts)+"</select>";
		}
		
		if (field.type=="checkbox"){
			df="active";
			var opts="<option value='no'>Unchecked</option><option value='yes'>Checked</option>";
			
			input= "<select name='custom_"+(field.id)+"'>"+(opts)+"</select>";
		}
		
		if (field.type=="input-table"){
			placeholder='';
			input= "  " +Render.render('fi_table', {_name: "custom_"+(field.id)+"" , defs:field.placeholder, value:value}, '')+ '';
		}
		
		var html= "<div class='row "+(df)+"' data-type='"+(field.type)+"' title='"+(name)+" - "+(placeholder)+"'> <div class='label'>"+(name)+" <span class='normal'> &nbsp; &mdash; &nbsp; "+(placeholder)+"</span></div> <div class='input'>"+(input)+"</div> </div>";
		
		$(canvas).append(html);
		
		if (field.type=="select-m"){
			Form.select.improve($(canvas).find("select[name=custom_"+(field.id)+"]"), {
				multiple: 1,
				empty: "",
				value: AP.word.safeSplit(",", value)
			});
		}
	};
};


cForm.edit=new function __CFormEdit(){
	this.quick=function(obj, url, callback){
		cForm.clean();
		
		if (!obj.form || !obj.form.length){
			return cForm.edit.quickDesign(obj, url);
		}
		
		var options=[];
		for (var i=0; i<obj.form.length; i++){
			var xobj=obj.form[i];
			xobj.origin={hid: obj.hid, token: obj.token};
			options.push({label: "["+obj.form[i].type+"] "+ obj.form[i].name, sublabel: obj.form[i].placeholder, icon:"arrow-right2", 'xobj': xobj, action: function(elem){
				cForm.edit.row(elem.xobj, url, callback);
			}});
		}
		
		options.push({"label": "Insert more inputs to the custom form", sublabel:"Click to add more inputs to the custom form", icon:"plus", action: function(){
			cForm.edit.quickDesign(obj, url);
		}});
		
		AP.actionMenu(options,{title:"Please select an input to start editing"});
	};

	
	this.quickDesign=function(obj, url, callback){
		cForm.design(function(inputs, preview, tf){
			cForm.submit(url, tf, function(code){
				UI.flash("Save successfully ...");
				AP.xRefresh();
			},{hid: obj.hid, token: obj.token});
		});
	};
	

	this.row=function(row, url, callback){
		var data={hid: row.origin.hid, token: row.origin.token, id: row.id};
		
		var opts=[{label: "Short text", value:"text"}, {label: "Long text", value:"textarea"}, {label: "Date", value:"date"}, {label: "Integer", value:"int"}, {label: "Selection", value:"select"}];
		
		var form=Form.create('fly-custom-fx',{'action': url})
		.row(
			Form.label({label: "Input name *",sublabel: "The name of the custom input"}),
			Form.input({name: 'name', "placeholder":"The name of the custom input"}).value(row.name)
		)
		.row(
			Form.label({label: "Input type *",sublabel: "The input type"}),
			Form.input({name: 'type', type:"select", options: opts}).value(row.type)
		)
		.rowHidden(
			Form.label({label: "Possible options *",sublabel: "Please list all possible options, separated by (,)"}),
			Form.input({name: 'values', type:"textarea"}).value(row.values.join(", "))
		)
		.row(
			Form.label({label: "Guideline text",sublabel: "The text to hint users"}),
			Form.input({name: 'placeholder', "placeholder":"The text to hint users"}).value(row.placeholder)
		)
		.row(
			Form.label({label: "Require answer?",sublabel: ""}),
			Form.input({name: 'required', type:"select", options: [{label: "No", value:0}, {label: "Yes", value:1}]}).value(row.required)
		)
		.row(
			Form.label({label: "Disabled?",sublabel: "Disable this custom input?"}),
			Form.input({name: 'disabled', type:"select", options: [{label: "No", value:0}, {label: "Yes", value:1}]}).value(row.disabled)
		)
		.buttons([
			 {label: "Edit custom input", action: function(){
				 Form.submit("#fly-custom-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					callback(code);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Cancel", action: function(){
				 Form.hide("fly-custom-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			form.find("type").change(function(){
				var val=$(this).val();
				if (val=="select"){
					form.findRow("values").show();
				}else{
					form.findRow("values").hide();
				}
			}).change();
		});	
		
		
		Form.pop({width: 720, label: 'Edit custom input'
		}).setForm(form).show().focus('name');
	};
};



cForm.ui=new function __cFormUI(){
	this.addInput=function(){
		var name=safe($("#custom-form-fx input[name=name]").val());
		var type=$("#custom-form-fx select[name=type]").val();
		var placeholder=safe($("#custom-form-fx input[name=placeholder]").val());
		var required=parseInt($("#custom-form-fx select[name=required]").val());
		var values=[];
		var id=AP.uuid();
			
		if (type=="select"){
			values=$("#custom-form-fx input[name=values]").val().split(",");
			if (!values.length){
				return AP.alertError("Please enter possible options for the input.")
			}
		}
		
		var disabled=0;
		
		if (!name || !name.length){
			return AP.alertError("Please enter the input name");
		}
		
		var input={id: id, name: name, type: type, values: values, required: required, disabled: disabled, placeholder:placeholder};
		cForm.inputs.push(input);
		
		this.previewAdd(input);
		this.clearInput();
	};
	
	
	this.clearInput=function(){
		$("#custom-form-fx input").val("");
		$("#custom-form-fx select[name=required]").val(0);
		$("#custom-form-fx select[name=type]").val("text");
		$("#custom-form-fx input[name=values]").closest(".row").hide();
		Form.balance("#custom-form-fx");
	};
	
	
	
	this.makeForm=function(inputs){
		var form="";
		for (var i=0; i<inputs.length; i++){
			var ip=inputs[i];
			form+="<input type='hidden' name='custom-name-"+i+"' value='"+ip.name+"'>" +
				"<input type='hidden' name='custom-type-"+i+"' value='"+ip.type+"'>" +
				"<input type='hidden' name='custom-required-"+i+"' value='"+ip.required+"'>" +
				"<input type='hidden' name='custom-placeholder-"+i+"' value='"+ip.placeholder+"'>" +
				"<input type='hidden' name='custom-values-"+i+"' value='"+ip.values.join(",")+"'>";	
		}
		
		return "<div style='display:none'><input type='hidden' name='__cform' value='1'/> "+form+"</div>";
	};
	
	
	this.getPreview=function(inputs){
		var html="";
		for (var i=0; i<inputs.length; i++){
			html+=getInputPreview(inputs[i]);
		}
		
		return "<div class='embed -cform'>"+html+"</div>";
	};
	
	
	
	this.previewAdd=function(input){
		var html=getInputPreview(input);
		$(html).appendTo("#custom-form-fx .embed.-cform").addClass("pointer").attr("title","Click to clear this input").click(function(){
			var $this=$(this);
			AP.confirm("Remove this input?", function(){
				$this.slideUp(400, function(){
					$this.remove();
					cForm.ui.removeInput(input);
				});
			});
		});
	};
	
	
	this.removeInput=function(input){
		var r=[];
		for (var i=0; i<cForm.inputs.length; i++){
			if (cForm.inputs[i].id==input.id){
			}else{
				r.push(cForm.inputs[i]);
			}
		}
		
		cForm.inputs=r;
		return;
	};
	
	
	this.newForm=function(){
		
		var html="<div class='design form form-inline'>" +
		"	<h1>Táº¡o custom form</h1>" +
		"	<div class='row flat'>" +
		"		<div class='label'>TĂªn trÆ°á»ng *</div>" +
		"		<div class='input data'><input type='text' name='name' placeholder='The question you want to ask'/></div>" +
		"	</div>" +
		"	<div class='row'>" +
		"		<div class='label'>Loáº¡i dá»¯ liá»‡u type *</div>" +
		"		<div class='select data'><select name='type'>" +
		"			<option value='text'>Text ngáº¯n (má»™t dĂ²ng)</option>" +
		"			<option value='textarea'>Text dĂ i (nhiá»u dĂ²ng)</option>" +
		"			<option value='int'>Integer (sá»‘ nguyĂªn)</option>" +
		"			<option value='float'>Float (sá»‘ thá»±c)</option>" +
		"			<option value='date'>Date (ngĂ y)</option>" +
		"			<option value='datetime'>Datetime (ngĂ y vĂ  giá»)</option>" +
		"			<option value='select'>Dropdown list (danh sĂ¡ch chá»n)</option>" +
		"		</select></div>" +
		"	</div>" +
		"	<div class='row row-options hidden'>" +
		"		<div class='label'>Táº¥t cáº£ cĂ¡c lá»±a chá»n cho danh sĂ¡ch *</div>" +
		"		<div class='input data'><input type='text' placeholder='Enter all possible options; separated by commans (,)' name='values'/></div>" +
		"	</div>" +
		"	<div class='row'>" +
		"		<div class='label'>YĂªu cáº§u tráº£ lá»i? *</div>" +
		"		<div class='select data'><select name='required'>" +
		"			<option value='0'>KhĂ´ng báº¯t buá»™c</option>" +
		"			<option value='1'>Báº¯t buá»™c tráº£ lá»i</option>" +
		"		</select></div>" +
		"	</div>" +
		"	<div class='row'>" +
		"		<div class='label'>Gá»£i Ă½ tráº£ lá»i</div>" +
		"		<div class='input data'><input type='text' name='placeholder' placeholder='The guideline text (not required)'/></div>" +
		"	</div>" +
		"	<div class='buttons -two' style='padding-top:15px;'>" +
		"		<div class='button -first -gradient -big -rounded -stroked' onclick='cForm.ui.clearInput();'>Clear input</div>" +
		"		<div class='button -second -cta -big -rounded -stroked' onclick='cForm.ui.addInput();'>Add input</div>" +
		"	</div>" +
		"</div>";
		
		html+="<div class='results'>" +
				"<div class='title'>Form Ä‘Æ°á»£c khá»Ÿi táº¡o</div>" +
				"<div class='embed -cform'></div>" +
			"</div>";

		
		html="<div class='custom-form-design' id='custom-form-design'>"+html+"" +
			"<div class='buttons'>" +
			"	<div class='button -success -big -rounded' onclick='cForm.finishDesign(this);'>Finish designing custom form</div>" +
			"	<div class='cancel pointer' onclick='AP.closeDialog(this);'>Cancel</div>" +
			"</div>"
		"</div>";
		
		
		AP.customDialog(html, "custom-form-fx").width(700).show();
		
		$("#custom-form-fx select[name=type]").change(function(){
			var val=$(this).val();
			if (val=="select"){
				$("#custom-form-fx .row-options").show();
			}else{
				$("#custom-form-fx .row-options").hide();
			}
		});
		
		$("#custom-form-fx input[name=name]").autofocus();
	};
	
	
	
	function getInputPreview(input){
		var star="";
		if (parseInt(input.required)){
			star="<span class='red bold'>*</span>";
		}
		
		var values="";
		if (input.type=="select"){
			if(typeof input.options == 'undefined' || input.options == null) {
			   input.options = input.values;
			}
			values="<div class='values'>{"+AP.word.join(input.values,",")+"}</div>";
		}
		
		var placeholder="";
		if (input.placeholder && input.placeholder.length){
			placeholder="<div class='ph'>"+input.placeholder+"</div>";
		}
		
		return "<div class='item' data-id='"+input.id+"'>" +
			"<div class='name'>"+input.name+star+"</div>" +
			placeholder+
			"<div class='type'>"+input.type+"</div>" +
			values+
		"</div>";
	};
};







// Custom Form v2

var CustomForm = new function __CustomForm(){
	this.dialog=function(canvas, object, url, formKey, options){
		return new CustomFormAPI({canvas: canvas, object: object, url: url, formKey: formKey, extra: options}, 'dialog');
	};
	
	this.inline=function(canvas, object, url, formKey, options){
		return Line.initCustom({canvas: canvas, object: object, url: url, formKey: formKey, extra: options}, 'inline');
	};
	
	this.line=function(canvas, object, url, reorder){
		return Line.init({canvas: canvas, object: object, url: url, reorder: reorder});
	};
	
	this.complex=function(canvas, object, url, reorder){
		return Line.complex({canvas: canvas, object: object, url: url, reorder: reorder});
	};
};




function CustomFormAPI(options, type){
	this.options=options;
	this.type=type;
	
	
	this.data=function(rows){
		cForm.edit.quickDesign(this.options.object, this.option.url, function(code){
			$.log(code);
		});
	};
	
	
	this.show=function(){
		var html=getRowsHTML(this.rows);
	};
	
	this.flat=function(){
		
	};
};var CheckList=new function __CheckList(){
	this.check=function(url, data, callback){
		UI.ajaxShow();
		AP.post(url, data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.item);
		});
	};
	
	
	this.edit=function(checklist, url, data){
		var html="<h1 class='center'>Edit stage checklist</h1><div class='sep-10'></div>";
		
		for (var i=0; i<checklist.length; i++){
			var item=checklist[i];
			
			html+="<div class='item -checklist'>" +
				"<div class='row row-hidden'><div class='input'><input data-name='"+item.name+"' data-id='"+item.id+"' type='text' name='item-"+item.id+"' placeholder='Checklist item' value='"+item.name+"'></div> " +
					"<div class='buttons -two unselectable'>"+
					"	<div class='button -first -success -rounded' onclick='CheckList.editItem(this);'>Edit</div>" +
					"	<div class='button -second -gradient -stroked -rounded' onclick='CheckList.cancelEditItem(this);'>Cancel</div>" +
					"</div>" +
				"</div>" +
				"<div class='real'>" +
				"	<div class='icon'><span class='-ap icon-checkbox-unchecked'></span></div>" +
				"	<div class='name' onclick=\"CheckList.showEdit(this);\">"+item.name+"</div>" +
				"	<div class='actions'>" +
				"		<span class='action a' onclick=\"CheckList.showEdit(this);\">Edit now</span> &middot; " +
				"		<span class='action a' onclick=\"CheckList.moveUp('"+item.id+"');\">Move up</span> &middot; " +
				"		<span class='action a' onclick=\"CheckList.moveDown('"+item.id+"');\">Move down</span> &middot; " +
				"		<span class='action a' onclick=\"CheckList.removeItem(this);\">Remove</span>" +
				"	</div>" +
				"</div>" +
			"</div>";
		}
		
		html+="<div class='sep-20'></div>" +
		"<div class='item more'><div class='row'>" +
			"<h3 style='padding-bottom:8px;'>Add more checklist item</h3>" +
			"<div class='input'><input type='text' name='name' placeholder='Checklist item name'></div> " +
			"<div class='buttons -two unselectable'>"+
			"	<div class='button -first -success -rounded' onclick='CheckList.addMore(this);'>Add</div>" +
			"	<div class='button -second -gradient -stroked -rounded' onclick='CheckList.resetEdit(this);'>Reset</div>" +
			"</div>" +
		"</div></div>";
		
		html+="<div class='cancel'><span onclick='CheckList.closeEdit(this);'>Close dialog</span></div>";
		
		AP.customDialog(html, "checklist-edit").closable(true).width(600).show();
		$("#checklist-edit").data("data", data).data("url", url);
	};
	
	
	this.closeEdit=function(ref){
		AP.closeDialog(ref);
	};
	
	this.showEdit=function(ref){
		$("#checklist-edit .item.-checklist").removeClass("editing");
		$(ref).closest(".item").addClass("editing");
	};
	
	this.resetEdit=function(ref){
		$(ref).closest(".row").find("input[type=text]").val("");
	};
	
	this.addMore=function(ref){
		var val=$(ref).closest(".item").find("input[type=text]").val();
		if (val && val.length){
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			data.name=val;
			data.action="add";
			
			update(data, url);
		}
	};
	
	
	this.editItem=function(ref){
		var $input=$(ref).closest(".item").find("input[type=text]");
		var val=$input.val();
		var item_id=$input.data("id");
		
		if (val && val.length){
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			data.name=val;
			data.item_id=item_id;
			data.action="edit";
			
			update(data, url);
		}
	};
	
	this.cancelEditItem=function(ref){
		$(ref).closest(".item").removeClass("editing");
	};
	
	
	this.removeItem=function(ref){
		var $input=$(ref).closest(".item").find("input[type=text]");
		var item_id=$input.data("id");
		var name=$input.data("name");
		
		AP.confirm("Are you sure that you want to remove this checklist item? This action cannot be undone and will affect every job of the current workflow.", function(){
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			data.action="remove";
			data.item_id=item_id;
			
			update(data, url);
		});
	};
	
	
	
	this.moveUp=function(item_id){
		var data=$("#checklist-edit").data("data");
		var url=$("#checklist-edit").data("url");
		
		data.action="up";
		data.item_id=item_id;
		
		update(data, url);
	};
	
	
	this.moveDown=function(item_id){
		var data=$("#checklist-edit").data("data");
		var url=$("#checklist-edit").data("url");
		
		data.action="down";
		data.item_id=item_id;
		
		update(data, url);
	};
	
	
	
	

	this.updateAdd=function(item){
		
	};
	
	
	function update(data, url){
		AP.ajaxShow();
		AP.post(url, data, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// Update checklist
			var data=$("#checklist-edit").data("data");
			var url=$("#checklist-edit").data("url");
			
			CheckList.edit(code.checklist, url, data);
		});
	}
};Form.inline = new function __FormInline(){
	/**
	 * @desc Bind a color picker on a selector click
	 */
	this.color=function(selector, callback, opts){
		if (!opts){
			opts={};
		}
		
		opts=$.extend({}, {auto: 1, left: -10}, opts);
		
		$(selector).click(function(){
			Form.inlineColorTagger(this, callback, opts);
		});
	};
	
	
	this.text=function(selector, options){
		options=$.extend({}, {data: {}, position: {top:0, left:0}, placeholder: "Edit", loading: false}, options);
		
		var $handler=$(selector);
		
		if (options.handler){
			$handler=options.handler;
		}
			
		$handler.click(function(){
			var $this=$(selector);
			
			var val=$(selector).data('value');
			if (typeof val=="undefined" || val===null){
				if ('value' in options){
					val=options.value;
				}else if ('val' in options){
					val=options.val;
				}else{
					val=$(selector).text();
				}
				
				val=$.trim(safe(val));
			}
			
			var html="<div class='xform-inline' title='Press enter to save'>" +
					"<div class='input'><input type='text' value='"+val+"' placeholder='"+options.placeholder+"'/></div>" +
					"<div class='close' onclick='Form.inline.cancel_text_input(this);'><span class='-ap icon-undo' title='Cancel'></span></div>" +
				"</div>";
			
			var $canvas=null;
			var binding=false;
			if ($this.parent().hasClass("js_xform_wrap")){
				$canvas=$this.parent();
				binding=true;
			}else{
				var id=AP.uuid();
				$this.addClass("js_xform_initial").wrap("<div id='"+id+"' class='js_xform_wrap'></div>");	
				$canvas=$("#"+id);
				$canvas.append(html);
			}
			
			$this.hide();
			
			$canvas.find(".xform-inline").show().cloneCSS($this, "padding, margin, fontSize, color");
			
			if (!binding){
				$canvas.find("input").enter(function(){
					save_text_input(this, options, $(this).val());
				});
			}
			
			$canvas.find("input").autofocus().val(val);
			
		});
	};
	
	
	
	
	function save_text_input(ref, options, val){
		var url=options.url;
		var data=options.data;
		if (!data){
			data={};
		}
		
		data.value=val;
		
		var $canvas=$(ref).closest(".js_xform_wrap");
		$canvas.ajaxShow();
		
		if (options.loading){
			UI.ajaxShow();
		}
		AP.post(url, data, function(code){
			if (options.loading){
				UI.ajaxHide();
			}
			
			$canvas.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (options.done){
				Form.inline.cancel_text_input(ref);
				options.done.call($canvas.find(".js_xform_initial")[0], code);
			}
		});
	};
	
	
	this.cancel_text_input=function(ref){
		var $canvas=$(ref).closest(".js_xform_wrap");
		$canvas.find(".xform-inline").hide();
		$canvas.find(".js_xform_initial").show();
	};
};var Comment=new function __Comment(){
	this.on={};
	
	this.canvas=null;
	
	this.quickPost=function(input, callback, error_callback){
		var $form=$(input).closest("form");
		
		if ($form.parent().ajaxOn()){
			return;
		}
		
		var hid=$(input).data('hid');
		var token=$(input).data('token');
		var content=$(input).val();
		var file=$form.find("input[name=file]").val();
		
		if (!file || !file.length){
			if (!content || !content.length){
				return; // NO CONTENT
			}
		}
		
		$form.find('.textarea').ajaxShow();
		
		
		AP.submit($form, function(code){
			$form.find('.textarea').ajaxHide();
			
			if (!code.good()){
				if (error_callback){
					error_callback(code);
				}
				return AP.alertError(code.message);
			}
			
			$(input).val("").restore();
			$form.find("input[type=file]").val("");
			$form.find(".comment-file").hide();
			
			if (callback){
				callback.apply(input, [code.origin, code.comment]);	
			}
			
			AP.fire("comment.posted",[code.origin, code.comment]);
		}, {hid: hid, token: token, content: content});
	};
	
	
	this.quickRefPost=function(ref, callback, error_callback){
		var $input=$(ref).closest(".post").find("textarea");
		$input.triggerEnter();
	};
	
	
	
	this.taggable=function(input, network_id){
		Tag.user(input, network_id);
	};
	
	
	this.get=function(hid, token, callback, error_callback){
		AP.post("api/comment/get",{'hid': hid, 'token': token}, function(code){
			if (!code.good()){
				if (error_callback) error_callback(code);
				return;
			}
			callback(code.comment);
		});
	};
	
	
	/**
	 * @desc Load comment on a hash id
	 */
	this.load=function(hid, token, options, callback, error_handler){
		if (!hid){
			return;
		}	
		
		AP.post("api/comment/load",{'hid': hid, 'token': token, 'method': options.method, 'position': options.position}, function(code){
			if (!code.good()){
				if (error_handler){
					error_handler(code);
				}
				return;
			}
			
			callback(code.origin, code.comments);
		});
	};
	
	
	
	this.uploadForm=function(ref){
		var $area=$(ref).prev();
		var hid=$area.data("hid");
		var token=$area.data("token");
		
		var object={hid: hid, token: token};
		
		var $canvas=$(ref).closest(".box.comments");
		
		FileX.create(object, function(_origin, comment, log){
			Comment.ui.insert($canvas, _origin, comment);
			$canvas.find(".__updateinfo").replaceWith(Comment.ui.header(_origin));
			$canvas.trigger("commentposted", _origin);
			$canvas.find(".comment-count").html(_origin.stats.comments);
			
			AP.fire("comment-"+_origin.hid, [_origin, comment]);
		});
	};
	
	
	this.pickFile=function(input){
		var $input=$(input);
		var $box=$input.closest(".textarea");
		var name=getUploadFN($input.val());
		if (!name || !name.length){
			return;
		}
		
		$box.find(".comment-file").show();
		$box.find(".comment-file em").html(name);
	};
	
	
	this.removePickedFile=function(ref){
		var $box=$(ref).closest(".textarea");
		$box.find("input[name=file]").val("");
		$box.find(".comment-file").hide();
	};
	
	
	this.emoji=function(ref){
		var $box=$(ref).closest(".textarea");
		
		if (useUIKit()){
			Base.emoji.init({
				icon: ref,
				autohide: 1,
			}, function(emoji){
				Base.emoji.insert($box.find("textarea[name=comment]"), emoji);
			});
			
			return;
		}
		
		Emoji.pick(function(emoji){
			var $input=$box.find("textarea");
			var content=$input.val();
			if (content && content.length){
				$input.val(content+" "+emoji+" ").focus();
			}else{
				$input.val(emoji).triggerEnter();
			}
		});
	};
	
	
	this.sticker=function(ref){
		var $box=$(ref).closest(".textarea");
		
		if (useUIKit()){
			Base.emoji.giphy.init({
				icon: ref,
				autohide: 1,
			}, function(sticker){
				$box.find("textarea[name=comment]").val("-- @sticker "+sticker.gif).triggerEnter();
			});
			
			return;
		}
		
		Emoji.pick(function(emoji){
			var $input=$box.find("textarea");
			var content=$input.val();
			if (content && content.length){
				$input.val(content+" "+emoji+" ").focus();
			}else{
				$input.val(emoji).triggerEnter();
			}
		});
	};
	
	
	this.auto=function(canvas, obj, opts){
		opts=$.extend({},{placeholder: "BĂ¬nh luáº­n vĂ  nháº¥n Enter Ä‘á»ƒ gá»­i", order: "bottom", header: true, subheader: 0, autofocus: false, tagdir:"top", api: "api/comment", counter: ".comment-counter-"+obj.hid, theme: '', coc: 0}, opts);
		
		this.canvas=canvas;
		
		var $canvas=$(canvas);
		$canvas.addClass("__comment_canvas");
		var hid=obj.hid;
		var token=obj.token;
		
		$canvas.data('hid', hid);
		$canvas.data('hid', hid);
		$canvas.data('object', obj);
		
		var prefix=$canvas.data('prefix');
		if (!prefix){
			prefix=AP.uuid();
			$canvas.data('prefix', prefix);
		}
		
		
		var theme="-white";
		if (opts && opts.theme){
			theme=opts.theme;
			if (theme[0]!='-'){
				theme="-"+theme;
			}
		}

		if (!obj.stats){
			obj.stats= {};
		}
		
		var header="<h1>BĂ¬nh luáº­n <small class='comment-count-"+obj.hid+"'>("+obj.stats.comments+")</small></h1>";
		if (opts.header==false){
			header="";
		}
		
		var upload="<span class='upload'> " +Render.render('icon', {icon: "base_file" , style: "top:5px" }, '')+ "<input type='file' name='file' onchange='Comment.pickFile(this);'/> </span> <div class='comment-file hidden'>Táº£i lĂªn: <em>...</em> &middot; <span class='a normal std' onclick='Comment.removePickedFile(this);'>xĂ³a</span> &middot; <span class='a normal std' onclick='Comment.quickRefPost(this);'>gá»­i bĂ¬nh luáº­n</span> </div>";
		
		var emoji="<span class='emoji' title='Emojis' onclick='Comment.emoji(this);'> " +Render.render('icon', {icon: "emoji_smile_16" , style: "top:5px" }, '')+ "</span>";
		var sticker="<span class='sticker' title='Stickers and gifs' onclick='Comment.sticker(this);'> " +Render.render('icon', {icon: "emoji_sticker" , style: "top:5px" }, '')+ "</span>";
		
		var form="<div class='post'><form method='post' action='api/comment/post'> <div class='textarea'> <textarea data-hid='"+(hid)+"' data-token='"+(token)+"' name='comment' placeholder='"+(opts.placeholder)+"'></textarea> "+(upload)+""+(sticker)+""+(emoji)+" </div> </form></div>";
		
		var form_top="";
		var form_bottom="";
		
		if (opts.order=="bottom"){
			form_bottom=form;
		}else{
			form_top=form;
		}
		
		var header = ((opts && opts.layout && opts.layout=="-wide" && opts.header)?"<h1>BĂ¬nh luáº­n <small>("+obj.stats.comments+")</small></h1>":"");
		var subheader= (obj.subheader?getHeader(obj, opts):"");
		
		var html="";
		if (opts.order=="bottom"){
			html="<div class='box comments "+(theme)+" js-base-comment js-base-comment-"+(obj.hid)+"' id='auto-comments-"+(obj.hid)+"'> "+(header)+""+(subheader)+" <div class='arrow'></div> <div class='more'></div> <div class='__comments'></div> <div class='js-user-comments js-user-comments-"+(obj.hid)+" user-comments'></div> "+(form)+" </div>";
		}else{
			html="<div class='box comments "+(theme)+" js-base-comment js-base-comment-"+(obj.hid)+"' id='auto-comments-"+(obj.hid)+"'> "+(header)+""+(subheader)+""+(form)+" <div class='arrow'></div> <div class='__comments'></div> <div class='js-user-comments js-user-comments-"+(obj.hid)+" user-comments'></div> <div class='more'></div> </div>";
		}
		
		$canvas.html(html).data("options", opts).data("order", opts.order).data("coc", opts.coc);
		if (opts.coc){
			$canvas.addClass("js-coc");
		}
		
		if (opts.tagdir=="bottom"){
			$canvas.find(".post textarea").data("tagdir", "bottom");	
		}
		
		if (opts.theme && opts.theme.length){
			$canvas.addClass("theme-"+opts.theme);
		}
		
		if (opts && !opts.autofocus){
		}else if (!Client.native){
			$(".post textarea", $canvas).focus();
		}
		
		if (opts.order=="bottom"){
			$(canvas).find("> .comments").addClass("bottom_top");
		}
		
		$(opts.counter).html(obj.stats.comments);
		
		$(".post textarea", $canvas).autoExpand().enter(function(){
			var $this=$(this);
			Comment.quickPost(this, function(origin, comment){
				Comment.liveInsert(origin, comment, $this);
			});
		}).screencopy("api/comment/post", function(code, $_this){
			Comment.liveInsert(code.origin, code.comment, $_this);
		},{hid: hid, token: token});
		
	
		this.taggable($canvas.find(".post textarea"), Client.people);
		
		
		var last_id=$canvas.data("last-id");
		if (!last_id){
			last_id=0;
		}
		
		last_id=parseInt(last_id);
		
		var options={method: 'prev', position: last_id};
		
		if (opts.preload){
			Comment.ui.show($canvas, obj, opts.preload);
		}else{
			Comment.load(hid, token, options, function(origin, comments){
				Comment.ui.show($canvas, origin, comments);
				AP.fire("comments.loaded."+origin.hid,null);
			});
		}
		
	};
	
	
	/**
	 * @desc Response to an event
	 */
	this.response=function(comment, origin){
		var $canvas=$("#auto-comments-"+origin.hid);
		
		if ($canvas.length){
			Comment.ui.insertTop($canvas, origin, comment);	
		}
		
		$canvas=$("#comments-"+origin.hid);
		
		if ($canvas.length){
			Comment.ui.insert($canvas, origin, comment);	
		}
	};
	

	/**
	 * @desc Autofocus
	 */
	this.autoFocus=function(){
		$(this.canvas).find("textarea").autofocus();
	};
	
	
	/**
	 * @desc Live inserting comments
	 */
	this.liveInsert=function(origin, comment, $ref){
		var $c=$ref.closest(".__comment_canvas");
		if ($c.find(".js-user-comments .js-comment-"+(comment.id)+"").length){
			return;
		}
		
		var options=$c.data("options");
		Comment.ui.insert($c, origin, comment);
		
		$c.find(".__updateinfo").replaceWith(Comment.ui.header(origin));
		$c.trigger("commentposted", origin);
		$(options.counter).html(origin.stats.comments);
		
		AP.fire("comment-"+origin.hid, [origin, comment]);
	};
	
	
	/**
	 * @desc Attach the form at bottom when the comments are over full-height
	 */
	this.attachBottom=function(box, obj){
		$(box).find(".comments").data("attach-bottom",1).data("attach-to", box);
		
		var nobox=(!$(box).find('.__postbottom').length || !$(box).find('.__postbottom').text().length);
		
		if (nobox){
			var id=AP.uuid();
			
			var upload="<span class='upload'><input type='file' name='file' onchange='Comment.pickFile(this);'/><span class='-ap icon-upload3'></span></span> " +
			"<div class='comment-file hidden'>Táº£i lĂªn: <em>...</em> &middot; <span class='a normal std' onclick='Comment.removePickedFile(this);'>XĂ³a</span> &middot; <span class='a normal std' onclick='Comment.quickRefPost(this);'>Gá»­i bĂ¬nh luáº­n</span></div>";
			var emoji="<span class='emoji' onclick='Comment.emoji(this);'><span class='-ap icon-mood'></span></span>";
			var sticker="<span class='sticker' onclick='Comment.sticker(this);'><span class='-ap icon-whatshot'></span></span>";
			
			var html="<div class='__postbottom'><div class='post'><form method='post' action='api/comment/post'>" +
			"	<div class='textarea'><textarea id='"+id+"' data-hid='"+obj.hid+"' data-token='"+obj.token+"' name='comment' placeholder='BĂ¬nh luáº­n vĂ  nháº¥n Enter Ä‘á»ƒ gá»­i'></textarea>"+upload+emoji+"</div>" +
			"</form></div></div>";
			
			$(html).appendTo(box);
			$("#"+id).enter(function(){
				var $this=$(this);
				var $canvas=$(box).find(".box.comments");
				
				Comment.quickPost(this, function(origin, comment){
					Comment.ui.insert($canvas, origin, comment);
					$canvas.find(".__updateinfo").replaceWith(Comment.ui.header(origin));
					$this.focus();
				});
			}).screencopy("api/comment/post", function(code, $_this){
				var origin=code.origin;
				var comment=code.comment;
				var $canvas=$(box).find(".box.comments");
				
				Comment.ui.insert($canvas, origin, comment);
				$canvas.find(".__updateinfo").replaceWith(Comment.ui.header(origin));
				$canvas.trigger("commentposted", origin);
				$canvas.find(".comment-count").html(origin.stats.comments);
				
				AP.fire("comment-"+origin.hid, [origin, comment]);
			},{hid: obj.hid, token: obj.token});
		}
		
	};
	
	

	this.like=function(ref){
		var $this=$(ref);
		var $canvas=$this.closest('.__comment_canvas');
		var hid=$canvas.data('hid');
		var token=$canvas.data('token');
		
		if ($this.hasClass('unlike')){
			Like.unlike(hid, token, function(origin, like){
				Comment.ui.updateOrigin($canvas, origin);
			});
		}else{
			Like.like(hid, token, function(origin, like){
				Comment.ui.updateOrigin($canvas, origin);
			});
		}
	};
	
	
	this.editOptions = function(ref) {
		var options = [];
		
		options.push({label: "Chá»‰nh sá»­a bĂ¬nh luáº­n", icon: "uniF11A", action: function(){
			Comment.edit(ref);
		}});
		
		options.push({label: "XĂ³a bĂ¬nh luáº­n", icon: "uniF11F", action:function(){
			Comment.remove(ref);
		}});
		
		AP.actionMenu(options);
	};
	
	
	this.edit = function(ref){
		var $this=$(ref);
		var $box=$this.closest(".comment");
		var hid=$box.data('hid');
		var token=$box.data('token');
		
		
		$(ref).ajaxShow();
		this.get(hid, token, function(comment){
			$(ref).ajaxHide();
			Form.edit({type: "textarea","height":200, "title":"Chá»‰nh sá»­a bĂ¬nh luáº­n", "action":"api/comment/edit", "content":comment.content.br2nl(),"button":"Chá»‰nh sá»­a", data: {hid: comment.hid, token:comment.token}, "name":"content"}, function(code){
				var html=Comment.ui.html(code.comment, $box.data("ns"), $box.data("coc"));
				$box.replaceWith(html);
			});
		}, function(){
			$(ref).ajaxHide();
		});
	};
	
	this.remove = function(ref){
		return Comment.form.remove(ref);
	};
	
	
	/**
	 * @desc Load previous comment
	 */
	this.more=function(ref){
		var $canvas=$(ref).closest(".__comment_canvas");
		var obj=$canvas.data("object");
		var last_id=$canvas.data("last-id");
		if (!last_id){
			last_id=0;
		}
		
		last_id=parseInt(last_id);
		
		var options={method: 'prev', position: last_id};
		Comment.load(obj.hid, obj.token, options, function(origin, comments){
			Comment.ui.show($canvas, origin, comments, true);
			AP.fire("comments.loaded."+origin.hid,null);
		});
	};
	
	
	/**
	 * @desc Like a comment
	 */
	this.likeComment=function(ref){
		var $this=$(ref);
		var $box=$this.closest(".comment");
		
		var hid=$box.data('hid');
		var token=$box.data('token');
		var $canvas=$this.closest('.__comment_canvas');
		
		
		if ($this.hasClass('unlike')){
			Like.unlike(hid, token, function(origin, like){
				Comment.ui.update($box, origin);
			});
		}else{
			Like.like(hid, token, function(origin, like){
				Comment.ui.update($box, origin);
			});
		}
	};
	
	
	/**
	 * @desc On comment liked
	 */
	this.onLike=function(comment){
		$(".comment-"+comment.hid).each(function(){
			var $box=$(this);
			var hid=$box.data("hid");
			var token=$box.data("token");
			
			var html="&middot; <span class='-ap icon-like2'></span> <span class='link' onclick=\"Like.who('"+hid+"','"+token+"');\">"+comment.likes+" "+AP.word.plural("like", comment.likes)+"</span>";
			$box.find(".comment-counter-ph").html(html).show();
		});
	};
	
	
	this.getContentHTML=function(comment){
		return this.getDefaultContentHTML(comment);
	};
	
	
	this.getDefaultContentHTML=function(comment){
		var content=comment.content;
		if (content && content.length){
			content=content.replace(/â‘/g,'&#92;').replace(/&#9290;/g, '&#92;');
		}
		
		return "<span class='message'>"+UI.emotion(UI.parse(content))+"</span>";
	};
	
	
	
	this.focusComment=function(ref){
		$(ref).closest(".comments").find("textarea").focus();
	};
	
	
	/**
	 * @desc For case comments and logs to be separated, show logs in a canvas 
	 */
	this.showLogs=function(canvas, logs){
		logs.sort(function(e, f){
			return parseInt(f.since)-parseInt(e.since);
		});
		
		$(canvas).html("<div class='comment-logs'></div>");
		for (var i=0; i<logs.length; i++){
			appendLog($(canvas).find(".comment-logs"), logs[i]);
		}
	};
	
	
	/**
	 * @desc Insert a new log, public function
	 */
	this.insertLog=function(canvas, log){
		var $canvas=$(canvas).find(".comment-logs");
		
		var date=AP.time.time('%d%m%Y',log.since);
		var $ms=$canvas.find(".c-date.js-"+date).first();
		if ($ms.length){
			$ms.after(getLog(log));
			return;
		}
		
		$canvas.append("<div class='c-date js-"+(date)+"'>"+(AP.time.time('%V, %d/%m',log.since))+"</div>");
		$canvas.find(".js-"+date).after(getLog(log));
	};
	
	
	
	function appendLog($canvas, log){
		var date=AP.time.time('%d%m%Y',log.since);
		var $ms=$canvas.find(".js-"+date).last();
		if ($ms.length){
			$ms.after(getLog(log));
			return;
		}
		
		$canvas.append("<div class='c-date js-"+(date)+"'>"+(AP.time.time('%V, %d/%m',log.since))+"</div>");
		$canvas.find(".js-"+date).after(getLog(log));
	};
	
	
	
	function getLog(e){
		var detail = '';
		if (e.attachment && typeof e.attachment != 'undefined') {
			if (typeof e.attachment[0] != 'undefined') {
				if (typeof e.attachment[0].has_change != 'undefined') {
					detail = "&middot; <span class='detail'>Chi tiáº¿t</span>";
				}
			}
		}

		var u = People.get(e.username);
		return "<div class='comment-log js-comment-log-"+(e.id)+" js-"+(AP.time.time('%d%m%Y',e.since))+"' data-id='"+(e.id)+"'> <div class='c-avatar'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> </div> <div class='c-display'> <em>"+(u.name)+"</em> <span class='content'>"+(e.content)+"</span> &middot; <span class='time'>"+(AP.i18n.time(e.since))+"</span> "+(detail)+" </div> </div>";
	};
	
	
	function getHeader(obj, opts){
		if (!opts.header){
			return "";
		}
		return Comment.ui.header(obj);
	}
};



Comment.ui=new function __CommentUI(){
	this.show=function($canvas, obj, comments, is_more){
		var last_id=0;
		var options=$canvas.data("options");
		if (!options){
			options={};
		}

		if (comments.length == 0) {
			$canvas.find(".more:first").hide();
			fixBottom($canvas.find(".comments"), true);
			return;
		}
		
		if (options.order=="top"){
		}else{
			comments=comments.reverse();
		}
		
		var html=AP.render(comments, function(comment){
			if (parseInt(comment.id) < last_id || last_id==0){
				last_id=parseInt(comment.id);
			}
			return Comment.ui.html(comment, $canvas.data("ns"), $canvas.data("coc"));
		});
		
		if (is_more){
			$canvas.data("last-id", last_id).find(".js-user-comments").prepend(html);	
		}else{
			$canvas.data("last-id", last_id).find(".js-user-comments").append(html);
		}
		
		var total=$canvas.find(".comment").length;
		
		if (total < parseInt(obj.stats.comments)){
			$canvas.find(".more:first").replaceWith(getMoreLink(total, obj));
			$canvas.find(".more:first").show();
		}else{
			$canvas.find(".more:first").hide();
		}
		
		
		fixBottom($canvas.find(".comments"), true);
		
		if (parseInt(Query.get("comment")) > 0) {
			var $target_comment = $canvas.find(".js-comment-" + Query.get("comment"));
			if (typeof $target_comment.data("id") != 'undefined' && $target_comment.data("id") == Query.get("comment")) {
				$target_comment.find(".info .js-action.url").click();
			}
		}
	};
	
	
	this.insert=function($canvas, obj, comment){
		if ($canvas.data("order")=="bottom"){
			$canvas.data('object', obj).find(".js-user-comments-"+(obj.hid)+"").append(this.html(comment, $canvas, $canvas.data("coc")));
		}else{
			$canvas.data('object', obj).find(".js-user-comments-"+(obj.hid)+"").prepend(this.html(comment, $canvas, $canvas.data("coc")));
		}
		
		fixBottom($canvas, true);
	};
	
	
	this.insertTop=function($canvas, obj, comment){
		if ($canvas.hasClass("bottom_top")){
			Comment.ui.insert($canvas, obj, comment);	
		}else{
			$canvas.prepend(this.html(comment, $canvas));
		}
		
	};
	
	this.update=function($box, comment){
		$box.replaceWith(this.html(comment, $box));
	};
	
	
	this.updateOrigin=function($canvas, obj){
		$canvas.find(".__updateinfo").replaceWith(this.header(obj));
	};
	
	
	/**
	 * @desc We should use Component from now on
	 */
	this.html=function(comment, ns, enabled_sub_comments){
		return "  " +Render.render('comment_item', {comment:comment, coc:enabled_sub_comments}, '')+ '';
	};
	
	
	this.header=function(obj){
		if (!obj.stats){
			return '';
		}
		
		var action_like="<span class='action action-like' onclick='Comment.like(this);'>Like</span>  &nbsp; &middot; &nbsp; ";
		if (obj.liked && parseInt(obj.liked)){
			action_like="<span class='action action-like unlike' onclick='Comment.like(this);'>Unlike</span>  &nbsp; &middot; &nbsp; ";
		}
		
		return "<div class='info __updateinfo'> "+(action_like)+" <span class='action' onclick='Comment.focusComment(this);'>Comment</span> &nbsp; &middot; &nbsp; <em>"+(obj.stats.comments)+"</em> "+(AP.word.plural('comment', obj.stats.comments))+" &nbsp; &middot; &nbsp; <span class='-ap icon-like2'></span>&nbsp; <span class='link pointer' onclick=\"Like.who('"+(obj.hid)+"','"+(obj.token)+"');\"><em>"+(obj.stats.likes)+"</em> "+(AP.word.plural('like', obj.stats.likes))+"</span> '</div>";
	};
	
	
	this.attachment = function(comment){
		var att=comment.attachment;
		if (!att || !att.type){
			return "";
		}
		
		if (att.type=="file"){
			return FileX.inlinePreview(att);
		}
		
		if (att.type=="text"){
			return "<div class='text-attm'>"+(att.content)+"</div>";
		}
		
		if (att.type == "gif"){
			return "<div class='attachment'> <div class='att-gif'><img src='"+(att.src)+"'/></div> </div>";
		}
		
		if (att.image && att.title){
			return "<div class='attachment with-cover small' title='"+att.title+"'>" +
				"<div class='cover'><img src='"+AP.thumb(att.image)+"'/></div>" +
				"<div class='-text'><div><a class='title std' href='"+att.url+"' target='_blank''>"+att.title+"</a></div><div class='desc ap-xdot'>"+att.description+"</div></div>"+
			"</div>";	
		}else if (att.title){
			return "<div class='attachment simple' title='"+att.title+"'>" +
				"<div class='-text'><div><a class='title std' href='"+att.url+"' target='_blank''>"+att.title+"</a></div><div class='desc ap-xdot'>"+att.description+"</div></div>"+
			"</div>";
		}
	};
	
	
	this.actions = function(comment){
		var actions="";
		if (parseInt(comment.user_id)==parseInt(Client.viewer.id)){
			if (comment.metatype=="system"){
				actions+="<div class='action' title='This comment cannot be editted'><span class='-ap icon-lock'></span></div>";
			}else{
				actions+="<div class='action' onclick='Comment.editOptions(this);'><span class='-ap icon-mode_edit'></span></div>";	
			}
			
		}
		
		return  "<div class='actions'>"+actions+"</div>";
	};
	
	
	this.fixFocus=function($canvas){
		fixBottom($canvas, true);
	};
	
	
	
	function fixBottom($canvas, scroll_down_now){
		if ($canvas.data("attach-bottom") && parseInt($canvas.data("attach-bottom")) && $canvas.data("attach-to")){
			var box=$canvas.data("attach-to");
			
			if ($canvas.parent().parent().height() >= $(box).height()-30){
				if (!$(box).hasClass("__bottomshowup")){
					$(box).addClass("__bottomshowup");
					if (Client.native){
						$(box).find(".__postbottom textarea").val($canvas.find(".post textarea").val());	
					}else{
						$(box).find(".__postbottom textarea").val($canvas.find(".post textarea").val()).focus();	
					}
				}
				
				if (scroll_down_now){
					Layout.scrollDown(box);
				}
			}else{
				$(box).removeClass("__bottomshowup");
			}
		}
	};
	
	
	function getMoreLink(total, obj){
		return "<div class='more'> <span class='pointer' onclick='Comment.more(this);'><span class='ficon-angle-up'></span>&nbsp; Load previous comments</span> <div class='info'>Hiá»ƒn thá»‹ "+(total)+"/"+(obj.stats.comments)+" bĂ¬nh luáº­n</div> </div>";
	};
	
	
	function getActions(comment){
		
	};
};


Comment.form = new function __CommentForm(){
	this.remove = function(ref){
		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n xoĂ¡ bĂ¬nh luáº­n nĂ y? Ná»™i dung bá»‹ xoĂ¡ sáº½ khĂ´ng thá»ƒ khĂ´i phá»¥c.", function() {
			var $this = $(ref);
			var $box = $this.closest(".comment");
			var hid = $box.data('hid');
			var token = $box.data('token');
			var $parent = $box.closest(".__comment_canvas");
			var origin_hid = $parent.data('hid');
			
			$(ref).ajaxShow();
			AP.post("api/comment/remove", {hid: hid, token: token, origin_hid: origin_hid}, function(code) {
				$(ref).ajaxHide();
				if (!code.good()){	
					return AP.alertError(code.message, function() {
						AP.xRefresh();
					});
				}
				// var html = Comment.ui.html(code.comment, $box.data("ns"));
				$box.remove();
				// $(".post", $parent).hide(); 
				
				if (Comment.on.removed){
					Comment.on.removed(code, $parent);
				}
				
				var options=$parent.data("options");
				if (!options){
					return;
				}
				
				$(options.counter).each(function(){
					var v=parseInt($(this).text()) || 0;
					v=v-1;
					if (v<=0){
						v=0;
					}
					
					$(this).html(v);
				});
			});
		});
	};
};


Render.on("comment-item", function(){
	var comment = this.comment;
	
	var like_action="<span class='action a std' onclick='Comment.likeComment(this);'>Like</span>";
	if (parseInt(comment.liked)){
		like_action="<span class='action a std unlike' onclick='Comment.likeComment(this);'>Unlike</span>";
	}
	
	like_action="<div class='js-action inline'>"+(Like.reaction.getReactionButton(comment))+"</div>";
	
	var eclass="";
	if (comment.metatype){
		eclass=" -alt";
	}
	
	var coc_id=AP.uuid();
	var coc = "<div class='sub-comments' id='js-coc-"+(coc_id)+"'></div>";
	var reply_action="&nbsp;&middot; <div class='js-action inline url' data-url='::base/comment' data-reply_to='"+(comment.username)+"'>Tráº£ lá»i</div>";
	
	if (!this.coc){
		coc='';
	}else{
		reply_action="&nbsp;&middot; <div class='js-action inline url' data-url=':comment' data-id='"+(comment.id)+"' data-hid='"+(comment.hid)+"' data-token='"+(comment.token)+"' data-resolver='Comment' data-placeholder='Tráº£ lá»i bĂ¬nh luáº­n nĂ y' data-box='#js-coc-"+(coc_id)+"'>Tráº£ lá»i (<span class='js-ccount-"+(comment.hid)+"'>"+(comment.stats.comments)+"</span>)</div>";	
	}
	
	var animated = '';
	if (this.is_new){
		this.addClass("-is-new");
		animated = "<div class='is-new anim-showhide-inf'></div> <div class='new-tag'> <div class='new-icon anim-showhide-inf'><span class='ap icon-primitive-dot'></span></div> New </div>";
	}
	
	return "<div class='js-comment js-comment-"+(comment.id)+" comment __origin "+(this.get('class'))+"' data-id='"+(comment.id)+"' data-hid='"+(comment.hid)+"' data-token='"+(comment.token)+"' data-coc='"+(this.coc||0)+"' "+(this.show('id'))+"> <div class='image avatar avatar-32 -rounded'><img src='"+(AP.xthumb(comment.gavatar))+"'></div> "+(animated)+" <div class='text'><b class='a url username std' data-username='"+(comment.username)+"'> "+(name(comment.username))+"</b>&nbsp; "+(Comment.getContentHTML(comment))+" </div> "+(Comment.ui.attachment(comment))+" <div class='info'>"+(like_action)+""+(reply_action)+" &middot; "+(UI.simpleTime(comment.since))+" <div class='comment-reactions'>"+(Like.reaction.getReactions(comment))+"</div> </div> "+(Comment.ui.actions(comment))+" "+(coc)+" </div>";
}, function(params){
	if (params.is_new){
		var $that = $(this);
		setTimeout(function(){
			$that.find(".is-new").remove();
			$that.find(".new-tag").remove();
			$that.removeClass("-is-new");
		}, 5000);
	}
});


Comment.v2 = function (opts){
	
	if (!parseInt(Client.env)){
		var params={
			"origin": "[REQUIRED] The origin object, DB release",
			"canvas": "[REQUIRED] The canvas selector, string or jQuery",
			"header": "boolean (TRUE|FALSE) - should we show header?",
			"form": "string {top|bottom} - should the input form at top or bottom (this will impact the comment loading order)",
			"placeholder": "string - input placeholder, default as #Comment and press Enter to post#",
			"tag": "string {up|down} - should the tagging user function appear above the form or under the form"
		};
		
		var str = JSON.stringify(params, null, 2);
		$.log("Comment.v2(opts) opts param:")
		$.log(str);
	}
	
	if (!opts.obj){
		opts.obj=opts.origin;
	}
	
	var obj=opts.obj;
	var canvas=opts.canvas;
	
	opts=$.extend({}, {placeholder: "Viáº¿t bĂ¬nh luáº­n cá»§a báº¡n", align: "bottom", tagdir:"bottom", header: true, counter: ".comment-counter-"+obj.hid, layout: "standard", coc: 0}, opts);
	
	if (opts.reverse){
		opts.align = "top";
	}
	
	Comment.auto(canvas, obj, opts);
};


$(document).ready(function(){
	N.on("commented", function(comment){
		var $box = $(".js-base-comment-"+comment.origin.hid);
		if (!$box.length){
			return;
		}
		
		var coc = $box.data("coc")||"";
		
		if (!coc && $box.parent().hasClass("js-coc")){
			coc = 1;
		}
		
		if ($box.find(".js-user-comments .js-comment-"+(comment.id)+"").length){
			return;
		}
		
		$box.find(".js-user-comments-"+comment.origin.hid).append("  " +Render.render('comment_item', {comment:comment, coc:coc, is_new:1}, '')+ '');
	});
	
	
	N.on("liked", function(origin){
		Like.safeUpdate(origin);
	});
});


var Post=new function __Post(){
	this.obj=null;
	this.init=function(obj, canvas, post_form){
		obj.canvas=canvas;
		this.obj=obj;
		this.highlight();
		Post.form.init(post_form);

		var $canvas=$(Post.obj.canvas);

		Post.load(this.obj.hid, this.obj.token, 0, function(origin, posts){
			for (var i=0; i< posts.length; i++){
				Post.insert(posts[i], $canvas);
			}
		});
	};


	this.standardize=function(post){
		post.original={hid: post.hid, token: post.token};

		if (post.attachment && post.attachment.id && post.attachment.type){
			post.hid=post.attachment.hid;
			post.token=post.attachment.token;
			post.stats=post.attachment.stats;
			post.liked=post.attachment.liked;
		}
	};


	this.response=function(post, origin){
		if (!this.obj || this.obj.hid!=origin.hid){
			return;
		};

		this.insert(post, this.obj.canvas, true);
	};


	this.quickPost=function(input, callback){
		if ($(input).parent().ajaxOn()){
			return;
		}

		$(input).parent().ajaxShow();
		var hid=$(input).data('hid');
		var token=$(input).data('token');
		var content=$(input).val();

		if (!content || !content.length){
			return; // NO CONTENT
		}

		var data={hid: hid, token: token, content: content};
		if (AP.isset("Channel")){
			data.channel_id= Channel.channel.id;
		}

		AP.post("api/post/post",data, function(code){
			$(input).parent().ajaxHide();

			if (!code.good()){
				return AP.alertError(code.mesage);
			}

			$(input).val("").restore();
			callback(code.origin, code.comment);
		});

	};



	/**
	 * @desc Load comment on a hash id
	 */
	this.load=function(hid, token, last_id, callback, error_handler){
		this.cid=hid;

		if (!hid){
			return;
		}

		AP.post("api/post/load",{'hid': hid, 'token': token, 'last_id': last_id}, function(code){
			if (!code.good()){
				if (error_handler){
					error_handler(code);
				}
				return;
			}

			callback(code.origin, code.posts);
			AP.fire("POST.LOADED", code.posts.length);
		});
	};


	this.loadMore=function(ref){
		var $master_canvas=$(ref).closest(".__auto_post");
		var origin=$master_canvas.data("object");

		var last_id=0;
		var $canvas=$master_canvas.find(".list.-posts");

		$canvas.find(".li.post").each(function(){
			var id=parseInt($(this).data("id"));
			if (id<last_id || last_id==0){
				last_id=id;
			}
		});

		AP.ajaxShow();
		AP.post("api/post/load",{'hid': origin.hid, 'token': origin.token, 'last_id': last_id}, function(code){
			AP.ajaxHide();

			if (!code.good()){
				return AP.alertError(code.message);
			}

			for (var i=0; i< code.posts.length; i++){
				Post.insert(code.posts[i], $canvas);
			}

			AP.fire("POST.LOADED", code.posts.length);
		});
	};


	this.highlight=function(){
		AP.on("POST.LOADED", function(num_posts){
			if (num_posts && num_posts==10){
				$("#topic-loadmore").show();
			}else{
				$("#topic-loadmore").hide();
			}

			var hl=Query.get("hl");

			if (!hl || !hl.length || !hl.isAlphaNumeric()){
				return;
			}


			if ($("#post-embed-"+hl).length){
				var $box=$("#post-embed-"+hl).closest(".post");
				AP.ajaxShow();
				setTimeout(function(){
					AP.ajaxHide();
					Layout.scrollTo($box, 100, 200);
					Post.comment.show($box.find("> .footer .comment"));
				}, 300);
			}else{
				var $post_id = parseInt(parseInt(Query.get("hl"))/10000);
				var $target_post_box = $("#post-comments-" + $post_id).closest('.post');
				if (typeof $target_post_box != 'undefined') {
					Layout.scrollTo($target_post_box, 100, 200);
					Post.comment.show($target_post_box.find("> .footer .comment"));
				} else {
					if (!$("#post-"+hl).length){
						return;
					}
	
					AP.ajaxShow();
					setTimeout(function(){
						AP.ajaxHide();
	
						Layout.scrollTo("#post-"+hl, 100, 200);
						Post.comment.show($("#post-"+hl).find("> .footer .comment"));
					}, 500);
				}
				
			}
		});
	};


	this.insert=function(post, $canvas, prepend){
		this.standardize(post);

		var context_menu="<div class='-dd' onclick='Post.contextMenu(this);'></div>";
		if (!AP.data.equal(post.user_id,Client.viewer.id)){
			context_menu="";
		}

		if (post.metatype=="system"){
			context_menu="<div class='-di' title='This post is locked'><span class='-ap icon-lock5'></span></div>";
		}

		var html= "<div class='li post' id='post-"+post.hid+"' data-id='"+post.id+"' data-hid='"+post.hid+"' data-token='"+post.token+"' data-xhid='"+post.original.hid+"' data-xtoken='"+post.original.token+"'>" +
			context_menu+
			"<div class='title'>" +
			"	<div class='avatar avatar-48 -circled pull-left'><div class='image'><img src='"+AP.xthumb(post.gavatar)+"'/></div></div>" +
			getTitle(post)+
			"	<div class='info'>"+AP.time.time("%H:%i",post.since)+" <em>"+AP.time.time("%M %d", post.since)+"</em></div>" +
			"</div>" +
			getContent(post)+
			getInfo(post)+
			"<div class='post-comments' id='post-comments-"+post.id+"'></div>"+
			"</div>";

		if (prepend){
			$(html).prependTo($canvas);
		}else{
			$(html).appendTo($canvas);
		}

		$("#post-"+post.hid).data("object", post);

		$("#post-comments-"+post.id).bind("commentposted", function(event, obj){
			var $box=$(this).closest(".post");
			Post.updateInfo($box, obj);
		});

		$("#post-embed-"+post.id).bind("voted", function(event, obj){
			var $box=$(this).closest(".post");
			Post.updateInfo($box, obj);
		});

		MarkDown.render("#post-"+post.hid);
		$("#post-"+post.hid).linkify();
	};



	this.insertTop=function(post, $canvas){
		this.insert(post, $canvas, true)
	};



	this.contextMenu=function(ref){
		var actions=[];
		actions.push({label:"Chá»‰nh sá»­a tháº£o luáº­n", icon: "pencil", action:function(){
				Post.editMe(ref);
			}});

		actions.push({label:"XĂ³a tháº£o luáº­n", icon: "block", action:function(){
				Post.deleteMe(ref);
			}});

		AP.actionMenu(actions);
	};



	this.like=function(ref){
		var $this=$(ref);
		var $canvas=$(ref).closest(".post");
		var hid=$canvas.data("hid");
		var token=$canvas.data("token");

		$canvas.ajaxShow();
		if ($this.hasClass('unlike')){
			Like.unlike(hid, token, function(origin, like){
				$canvas.ajaxHide();
				Post.updateInfo($canvas, origin);
			}, function(){
				$canvas.ajaxHide();
			});
		}else{
			Like.like(hid, token, function(origin, like){
				$canvas.ajaxHide();
				Post.updateInfo($canvas, origin);
			}, function(){
				$canvas.ajaxHide();
			});
		}
	};


	this.updateInfo=function($canvas, post){
		$canvas.find(".footer").replaceWith(getInfo(post));
	};


	this.__latest=null;

	/**
	 * @desc Auto post
	 */
	this.auto=function(canvas, obj, opts){
		opts = $.extend({}, {
			poll: 1,
			file: 1,
			placeholder: "Viáº¿t tháº£o luáº­n cá»§a báº¡n"
		}, opts);

		this.__latest=canvas;
		$(canvas).html(getAutoPostForm(obj, opts)).data("object", obj).addClass("__auto_post");
		Post.form.init(canvas);


		Post.init(obj, "#obj-posts", "#obj-post");

		if (Query.getInt("auto_post")){
			$("textarea", canvas).autofocus();
		}


		AP.rebind("new-file-"+obj.hid, function(file, log){
			if ($("#obj-files").length){
				$("#obj-files .none").hide();
				$("#obj-files").prepend(getFileHTML(file));
			}

			Post.insert(log, "#obj-posts", true);
		});


		AP.rebind("new-post-"+obj.hid, function(post, origin){
			Post.insert(post, "#obj-posts", true);
			var counter = origin.stats.posts + origin.stats.files;

			if (typeof origin.stats.comments !== "undefined") {
				counter += origin.stats.comments;
			}

			if (isNaN(counter)) {
				counter = 0;
			}

			$(".post-counter-"+origin.hid).html(counter);
		});
	};


	this.triggerAction=function(action){
		if (action=='reply'){
			setTimeout(function(){
				$(Post.__latest).find(".box.-postform textarea").focus();
			},300);
		}else if (action=='file'){
			$(this.__latest).find(".box.-postform .tab.tab-file").click();
		}else if (action=='poll'){
			$(this.__latest).find(".box.-postform .tab.tab-poll").click();
		}
	};


	this.addFile=function(ref){
		var obj=$(ref).closest(".__auto_post").data("object");
		
		var form=Form.create('invite-fx',{'action':'api/post/post'})
		.row(
			Form.label({label: "Select one or multiple files *",sublabel: ""}),
			Form.input({name: 'file', type:"files", "placeholder":""})
		)
		.row(
			Form.label({label: "Your comment",sublabel: ""}),
			Form.input({name: 'content', type:"textarea", "placeholder":"Some comments, not required"})
		)
		.hiddens({
			"type":"file",
			"hid": obj.hid,
			"token": obj.token,
		})
		.buttons([
			 {label: "Upload file", action: function(){
				 Form.submit("#invite-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 Form.hide("invite-fx");
					 AP.fire("new-post-"+code.origin.hid, [code.post, code.origin]);
		 			 AP.fire("new-post", [code.post, code.origin]);
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Cancel", action: function(){
				 Form.hide("invite-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).settings({block: true});
	
		Form.pop({id:'invite-fx-dx', width: 480, label: 'Upload files'}).setForm(form).show();
	
		
		// FileX.create(obj);	
	};


	this.addPoll=function(ref){
		var obj=$(ref).closest(".__auto_post").data("object");
		Poll.create(obj);
	};


	this.editMe=function(ref){
		var $canvas=$(ref).closest('.li.post');
		var hid=$canvas.data("xhid");
		var token=$canvas.data("xtoken");

		var post=$canvas.data("object");
		
		Form.edit({
			type: "textarea",
			content: post.content,
			name: "content",
			action: "api/post/edit",
			data:{hid: hid, token: token},
			height:130
		}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}

			UI.flash("The post was edited...");
			$canvas.find(".text.-content").html(UI.emotion(UI.parse(code.post.content))).removeClass("-no-data");
			$canvas.find(".text.-content").linkify();
		});
	};



	this.deleteMe=function(ref){
		var $canvas=$(ref).closest('.li.post');
		var hid=$canvas.data("xhid");
		var token=$canvas.data("xtoken");

		AP.confirm("Are you sure that you want to delete this post?", function(){
			AP.ajaxShow();
			AP.post("api/post/delete",{hid: hid, token: token}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}

				UI.flash("The post was removed");
				$canvas.slideUp(500, function(code){
					$canvas.remove();
				});
			});
		});
	};


	
	this.activate = function(ref){
		$(ref).closest(".form").addClass("-activated");
		if ($(ref).closest(".form").hasClass("-activated")){
			$(ref).closest(".form").find("textarea").focus();
		}
	};

	function getTitle(obj){
		var txt="";
		if (obj.attachment && obj.attachment.id && obj.attachment.type){
			if (obj.attachment.type=="poll"){
				txt=" shared a poll";
			}

			if (obj.attachment.type=="file"){
				if (parseInt(obj.attachment.image)){
					txt=" shared an image <span class='a normal std' onclick=\"FileX.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">"+obj.attachment.name+"</span>";
				}else{
					txt=" shared a file";
				}
			}
			
			if (obj.attachment.type=="task"){
				txt=" created a task";
			}

			if (obj.attachment.type=="request"){
				txt=" created a request";
			}
		}
		
		if (obj.metatype=="files"){
			if (obj.attachments.length==1){
				txt=" shared a file";
			}else{
				txt=" shared "+obj.attachments.length+" files"; 
			}
		}

		if (obj.metatype=="system"){
			return "<div class='name'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b> "+obj.title+"</div>";
		}else if (obj.title=="note"){
			return "<div class='name ap-xdot'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b> shared a note</div>";
		}else if (obj.title=="system"){
			return "<div class='name'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b> "+obj.content+"</div>";
		}
		return "<div class='name ap-xdot'><b class='url username' data-username='"+obj.username+"'>"+name(obj.username)+"</b>"+txt+"</div>";
	}


	function getContent(obj){
		if (obj.title=="system"){
			return "";
		}

		if (obj.attachment && obj.attachment.id && obj.attachment.type){
			if (obj.attachment.type=="poll"){
				return "<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+Poll.embed.html(obj.attachment)+"</div></div>";
			}
			if (obj.attachment.type=="file"){
				return getRealContent(obj)+"<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+FileX.ui.embed(obj.attachment)+"</div></div>";
			}
			if (obj.attachment.type=="task"){
				return getRealContent(obj)+"<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+Task.ui.embed(obj.attachment)+"</div></div>";
			}
			if (obj.attachment.type=="request"){
				return getRealContent(obj)+"<div class='text'><div class='embed' id='post-embed-"+obj.attachment.gid+"'>"+Request.ui.embed(obj.attachment)+"</div></div>";
			}
		}
		
		if (obj.attachments && obj.attachments.length){
			if (obj.metatype == "screenshot"){
				return getRealContent(obj)+"<div class='text js-files item-post-files'>"+AP.render(obj.attachments, function(e){
					return getFileImageHTML(e);
				})+"</div>";
			}
			
			return getRealContent(obj)+"<div class='text js-files item-post-files'>"+AP.render(obj.attachments, function(e){
				return getFileItemHTML(e);
			})+"</div>";
		}

		if (obj.attachment && !obj.attachment.id && obj.attachment.type=="file"){
			var att=obj.attachment;
			var icon=UI.file.icon(att.name);

			return getRealContent(obj)+"<div class='text'>" +
				"<div class='ifile'>" +
				"	<div class='ifileicon'><img src='"+Client.share_url+"/mimex/"+icon+".png'/></div>" +
				"	<div class='name ap-xdot' onclick=\"Base.file.preview('"+att.src+"');\">"+att.name+"</div>" +
				"	<div class='actions'>" +
				"		<div class='action' onclick=\"Base.file.preview('"+att.src+"');\">Preview</div> &middot; " +
				"		<a class='action' target='_blank' href=\""+att.download+"\">Download</div></a>" +
				"</div>" +
				"</div>";
		}

		return getRealContent(obj);
	}


	function getRealContent(obj){
		if (!obj.content){
			return "<div class='text -content -no-data'></div>";
		}
		return "<div class='text -content'>"+UI.emotion(UI.parse(obj.content))+"</div>";
	}


	function getInfo(obj){
		if (obj.attachment && obj.attachment.id && obj.attachment.type && obj.attachment.type=="request"){
			return "<div class='footer'>" +
				"	<span class='comment url' data-url='requests/show/"+obj.attachment.id+"'><span class='-ap icon-forward'></span> &nbsp; <span class='normal'>View request details</span></span>" +
				"</div>";
		}

		var preview_action="";
		if (obj.attachment && obj.attachment.id && obj.attachment.type){
			if (obj.attachment.type=="poll"){
//				return "<div class='footer'>" +
//					"<span class='comment' onclick=\"Poll.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">Comments <span class='count'>"+obj.attachment.stats.comments+"</span></span> " +
//					" &nbsp; &middot; &nbsp; "+obj.attachment.stats.votes+" " +AP.word.plural("vote", obj.attachment.stats.votes)+
//					" &nbsp; &middot; &nbsp; "+obj.attachment.stats.likes+" " +AP.word.plural("like", obj.attachment.stats.likes)+
//				"</div>";
				preview_action="<span class='a action std' onclick=\"Poll.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">Preview</span> &nbsp; &middot; &nbsp; ";

			}else if (obj.attachment.type=="file"){
				// return "<div class='sep-15'></div>";
				preview_action="<span class='a action std' onclick=\"FileX.preview('"+obj.attachment.hid+"','"+obj.attachment.token+"');\">Preview</span> &nbsp; &middot; &nbsp; ";
			}
		}



		var like_action="<span class='a action std' onclick='Post.like(this);'>Like</span>";
		var me="";
		var who="<span class='subaction pointer' onclick=\"Like.who('"+obj.hid+"','"+obj.token+"');\">"+obj.stats.likes+" "+AP.word.plural("like",obj.stats.likes)+"</span>";

		if (parseInt(obj.liked)){
			like_action="<span class='a action std unlike' onclick='Post.like(this);'>Unlike</span>";
			me=" &nbsp;&middot;&nbsp; You liked it";
		}

		return "<div class='footer'> <span class='comment' onclick='Post.comment.show(this);'> Comments <span class='count'>"+(obj.stats.comments)+"</span> </span> &nbsp; &middot; &nbsp; "+(preview_action)+" <div class='like inline'> "+(Like.reaction.getReactionButton(obj))+" </div> <div class='post-reactions'> "+(Like.reaction.getReactions(obj))+" </div> </div>";
	}


	/**
	 * Create a auto post form
	 * ---
	 * @param obj
	 * @param opts
	 * @returns {string}
	 */
	function getAutoPostForm(obj, opts) {

		// Poll and File buttons
		var num_conversions = obj.stats.posts;

		if (typeof obj.stats.comments !== "undefined") {
			num_conversions += obj.stats.comments;
		}

		if (isNaN(num_conversions)) {
			num_conversions = 0;
		}


		// Skeleton of Post Form
		var html = "<div id='js-obj-post' class='box -postform' data-hid='" + obj.hid + "' data-token='" + obj.token + "'>" +
			getForm(obj, opts) +
			"</div>" +
			"<div class='postnform'>" +
			"	<div class='postbox-header'><span class='post-counter-" + obj.hid + "'>" + num_conversions + "</span> posts</div>" +
			"	<div class='list -posts' id='obj-posts' data-origin_hid='"+obj.hid+"'></div>" +
			"	<div class='postbox-loadmore' onclick='Post.loadMore(this);'>Load previous posts</div>" +
			"</div>";

		return html;
	};
	
	
	function getForm(obj, opts){
		var mform = "<div class='mform'><div class='mc'> <div class='mavatar'><img src='"+(AP.xthumb(Client.viewer.gavatar))+"'></div> <div class='mtext' onclick='Post.activate(this)'> <div>"+(opts.placeholder)+"</div> </div> <div class='mside'> <div class='mupload' onclick='Post.addFile(this)'> " +Render.render('action', {icon: "form_upload" }, "Táº£i lĂªn")+ "</div> </div> </div></div>";
		
		if (opts.layout!='modern'){
			mform = '';
		}
		
		return "<div class='form "+(opts.layout=='modern'?'-modern':'')+"'> "+(mform)+" <form method='post' action='api/post/post'> "+(getUser())+" "+(getActions(obj, opts))+" <input type='hidden' name='hid' value='"+(obj.hid)+"'/> <input type='hidden' name='token' value='"+(obj.token)+"'/> <input type='hidden' name='title' value='note'/> <div class='textarea'> <div class='rg'></div><div class='r'></div> <div class='real real-editor'> <textarea name='content' placeholder='"+(opts.placeholder)+"'></textarea> </div> </div> <div class='real'> <div class='buttons xo'> <div class='button -rounded -cta left' onclick='Post.form.submit(this);'>Post now</div> <div class='cancel right' onclick='Post.form.hide(this);'><span class='-ap icon-cross2'></span> &nbsp; Há»§y</div> </div> </div> </form> </div>";
	};
	
	
	function getUser(){
		return "<div class='user'> <div class='avatar avatar-40 -circled'><div class='image'><img src='"+(AP.xthumb(Client.viewer.gavatar))+"'></div></div> <div class='name'> <em>"+(Client.viewer.name)+"</em> <div class='info'>"+(Client.viewer.title)+" &middot; @"+(Client.viewer.username)+"</div> </div> </div>";
	};
	
	
	function getActions(obj, opts){
		var poll_button = "";
		var file_button = "";
		
		if (opts.poll && opts.poll === 1){
			poll_button= "<div class='action' onclick='Post.addPoll(this);'>" +
				"	<span class='-ap icon-equalizer'></span>" +
				"	<span class='info'><span>ThĂªm bĂ¬nh chá»n</span></span>" +
				"</div>";
		}

		if (opts.file || opts.file == 0){
			file_button= "<div class='action' onclick='Post.addFile(this);'>" +
				"		<span class='-ap icon-attach_file'></span> ThĂªm tĂ i liá»‡u" +
				"		<span class='info'><span>ThĂªm tĂ i liá»‡u</span></span>" +
				"	</div>";
		}
		
		return "<div class='actions'>"+(poll_button)+" "+(file_button)+"</div>";
	};
	
	
	function getFileItemHTML(e){
		var att=e;
		var icon=UI.file.icon(att.name);

		return "<div class='js-file-item'> <div class='ifile'> <div class='ifileicon'><img src='"+(Client.share_url)+"/mimex/"+(icon)+".png'/></div> <div class='name ap-xdot' onclick='Base.file.preview(\""+(att.src)+"\")'>"+(att.name)+"</div> <div class='actions'> <div class='action' onclick='Base.file.preview(\""+(att.src)+"\")'>Preview</div> &nbsp;&middot;&nbsp; <a class='action' target='_blank' href='"+(att.download)+"'>Download</a> </div> </div> </div>";
	};
	
	
	function getFileImageHTML(e){
		return "<div class='js-file-item'> <div class='ifile-image'> <img src='"+(e.src)+"' class='url' data-url='::base/file?file="+(Base64.encodeURI(e.src))+"'/> </div> </div>";
	};

};




Post.socket=new function __PostSocket(){
	this.prepend=function(post, origin){
		if ($("#obj-posts").length && $("#obj-posts").data("origin_hid")==origin.hid){
			Post.insert(post, "#obj-posts", true);	
		}
	};
	
	this.append=function(post, origin){
		if ($("#obj-posts").length && $("#obj-posts").data("origin_hid")==origin.hid){
			Post.insert(post, "#obj-posts", false);
		}
	};
};







Post.form=new function __PostForm(){
	this.init=function(canvas){
		$('textarea[name="content"]', canvas).autoExpand();
		Tag.user($('textarea[name="content"]', canvas), Client.people);

		var hid = $(canvas).find("input[name=hid]").val();
		var token = $(canvas).find("input[name=token]").val();
		
		$(canvas+" textarea").on("input change blur", function(){
			var val=$(this).val();
			if (val && val.length){
				$(this).closest(".-postform").addClass("writing");
			}else{
				$(this).closest(".-postform").removeClass("writing");
			}
			
		}).screencopy("api/post/post", function(code, $_this){
			var origin=code.origin;
			var post=code.post;
			
			var $p=$_this.closest(".form");
			$p.find("textarea").val("").change();

			AP.fire("new-post-"+code.origin.hid, [code.post, code.origin]);
			AP.fire("new-post", [code.post, code.origin]);
			
		},{hid: hid, token: token});;

	};

	this.submit=function(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message)
			}
			UI.flash("The post was saved ...");
			var $p=$(ref).closest(".form");
			$p.find("textarea").val("").change();

			AP.fire("new-post-"+code.origin.hid, [code.post, code.origin]);
			AP.fire("new-post", [code.post, code.origin]);
		});
	};


	this.hide=function(ref){
		var $p=$(ref).closest(".form");
		var val=$.trim($p.find("textarea").val());
		if (val && val.length){
			return AP.confirm("Are you sure that you want to discard this post?", function(){
				$p.removeClass("-activated");
				
				$p.find("textarea").val("");
				$p.removeClass("writing");
				AP.hideAlert();
			});
		}
		
		$p.removeClass("writing");
		$p.removeClass("-activated");
	};

};Post.comment=new function __PostComment(){
	this.show=function(ref){
		var $canvas=$(ref).closest(".post");
		if (!$canvas.hasClass("__inited")){
			$canvas.addClass("__inited");
			var obj=$canvas.data("object");
			var dark = 0;
			if ($canvas.closest(".js-base-posts").hasClass("-dark")){
				dark = 1;
			}
			
			$("#post-comments-"+obj.id).html("  " +Render.render('comment', {obj:obj, dark:dark}, '')+ '');
			Render.finish();
		}
		
		var $box=$canvas.find(".post-comments");
		if ($box.is(":visible")){
			$box.hide();
			return;
		}
		
		
		$box.show();
		if (!Client.native){
			$box.find("textarea").focus();
		}
		
		setTimeout(function(){
			$box.slideDown(200);
		});
	};
};var Like=new function __Like(){
	this.like=function(hid, token, callback, error_callback){
		AP.post("api/like/like",{hid: hid, token: token}, function(code){
			if (!code.good()){
				if (error_callback){
					error_callback(code);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.like);
		});
		
	};
	
	
	this.unlike=function(hid, token, callback, error_callback){
		AP.post("api/like/unlike",{hid: hid, token: token}, function(code){
			if (!code.good()){
				if (error_callback){
					error_callback(code);
				}
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.like);
		});
		
	};
	
	
	this.react=function(ref, reaction, callback){
		var $box=$(ref).closest(".reaction-box");
		var hid=$box.data("hid");
		var token=$box.data("token");
		
		var endpoint="";
		if ($box.data("objtype") && $box.data("objtype")=="messages"){
			endpoint=Base.domain("message")+"/ajax/";
		}
		
		UI.ajaxShow();
		AP.post(endpoint+"api/like/reaction",{hid: hid, token: token, reaction: reaction}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (callback){
				callback(code.origin, code.like);	
			}else{
				safeReactionUpdate(ref, code.origin);
			}
		});
	};
	
	
	this.safeUpdate = function(origin){
		safeReactionUpdate($(".js-likebtn-"+origin.hid+" .reaction-icon").first(), origin);
	};
	
	
	this.who=function(hid, token){
		AP.post("api/like/who", {hid: hid, token: token}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.user.list("People who like this", code.users);
		});
	};
	
	
	this.response=function(origin){
		if (!origin){
			return;
		}
		
		if (origin.type=="comment"){
			return Comment.onLike(origin);
		}
		
		
		$(".likecount-"+origin.gid).each(function(){
			var val=parseInt($(this).text());
			val++;
			$(this).html(val);
		});
	};
	
	
	this.explain=function(obj){
		if (!obj){
			$.log("Error explaining like.explain");
			return;
		}
		
		if (obj.type=="file"){
			$.log(obj);
		}
		
		obj.stats.likes=parseInt(obj.stats.likes);
		if (obj.stats.likes && (!obj.likes || !obj.likes.length)){
			return simpleCase(obj);
		}
		
		var text="";
		
		if (obj.stats.likes){
			var last=getThree(obj.likes);
			if (obj.liked){
				last.unshift(Client.viewer);
			}
			
			
			if (obj.stats.likes > last.length){
				text= "<span class='lb2'><span class='-ap icon-thumb_up'></span></span> &nbsp; "+getExplain(last, true)+" and <span class='sharper pointer' onclick=\"Like.who('"+obj.hid+"','"+obj.token+"');\">"+(obj.stats.likes-3)+" other</span> liked it";
			}else{
				text= "<span class='lb2'><span class='-ap icon-thumb_up'></span></span> &nbsp; "+getExplain(last, false)+" liked it";
			}
				
		}
		
		if (text && text.length){
			 text=" &nbsp; &middot;  &nbsp; "+text;
		}
		
		return text;
	};
	
	
	function simpleCase(obj){
		var like_promotion="<em class='likecount-"+obj.gid+"'>"+obj.stats.likes+"</em> " +AP.word.plural("like", obj.stats.likes)+"";
		
		return " &nbsp; &middot;  &nbsp; <span class='lb2'><span class='-ap icon-thumb_up'></span></span>&nbsp; <span class='link pointer' onclick=\"Like.who('"+obj.hid+"','"+obj.token+"');\">"+like_promotion+"</span>"+
		(obj.liked?" <span class='ilikeit'>&nbsp;&middot&nbsp; You liked it</span>":"");
	}
	
	
	function getExplain(last, has_more){
		var text="";
		for (var i=0; i<last.length; i++){
			var p=last[i];
			if (p && p.id==Client.viewer.id){
				text+="<span class='sharper url username' data-username='"+p.username+"'>You</span>";
			}else{
				text+="<span class='sharper url username' data-username='"+p.username+"'>"+name(p)+"</span>";
			}
			
			
			if (i<last.length-1){
				if (i==last.length-2 && !has_more){
					text+=" and ";
				}else{
					text+=", ";
				}
				
				
			}
		}
		
		return text;
		
	};
	
	
	function getThree(likes){
		if (!likes){
			return [];
		}
		
		var r=[];
		for (var i=0; i<likes.length; i++){
			var id=likes[i];
			if (id!=Client.viewer.id){
				r.push(id);
			}
			
			if (r.length>=3){
				break;
			}
		}
		
		var ps=[];
		for (var i=0; i<r.length; i++){
			var p=People.getID(r[i]);
			if (p){
				ps.push(p);
			}
		}
		
		return ps;
	};
	
	
	function safeReactionUpdate(ref, origin){
		return Like.reaction.onUpdate(ref, origin);
	};
	
};







Like.reaction=new function __LikeReaction(){
	this.getReactionButton=function(obj){
		var reactions=obj.reactions;
		if (!reactions){
			reactions=[];
		}
		
		var icon="<span class='reaction-default pointer'><span class='-ap icon-thumb_up'></span>&nbsp; Like</span>";
		var reacted=false;
		
		for (var i=0; i<reactions.length; i++){
			if (parseInt(reactions[i].user_id)==parseInt(Client.viewer.id)){
				reacted=true;
				icon="<span class='reacted re-"+(reactions[i].reaction)+"'> <span class='reaction-me'><img src='"+(Client.share_url)+"/reactions/"+(reactions[i].reaction)+".svg'/></span> &nbsp; <b>"+(AP.word.capitalize(reactions[i].reaction))+"</b> </span>";
				
				break;
			}
		}

		return "<div class='reaction-wrapper js-likebtn-"+(obj.hid)+"'> "+(icon)+" <div class='reaction-area'> "+(this.getPopup(obj))+" </div> </div>";
	};
	
	
	this.getReactionIcon=function(obj){
		var icon="<span class='-ap icon-insert_emoticon'></span>";
		var reacted=false;
		
		for (var i=0; i<obj.reactions.length; i++){
			if (parseInt(obj.reactions[i].user_id)==parseInt(Client.viewer.id)){
				reacted=true;
				icon="<span class='reaction-me'><img src='"+(Client.share_url)+"/reactions/"+(obj.reactions[i].reaction)+".svg'/></span>";
				break;
			}
		}
		
		return "<div class='reaction-wrapper'> "+(icon)+" <div class='reaction-area'> "+(this.getPopup(obj))+" </div> </div>";
	};
	
	
	
	this.getReactions=function(obj, show_full){
		var reactions=obj.reactions;
		if (!reactions){
			reactions=[];
		}
		
		var list=getReactionOverview(reactions);
		
		if (show_full){
			if (!list.length){
				return '';
			}
			
			var users=AP.render(reactions, function(r){
				var u = People.get(r.user_id);
				return "<div class='reaction-user ap-xdot'> "+(u.name)+" <span class='r-icon'><img src='"+(Client.share_url)+"/reactions/"+(r.reaction)+".svg'/></span> </div>";
			});
			
			var es = "";
			var overview = getFullOverview(reactions, list);
			if (!overview){
				es = "-empty";
			}
			
			return "<div class='reaction-full-list "+(es)+"'> <div class='rf-wrapper'> <div class='rf-display'> "+(overview)+" </div> <div class='reaction-users'>"+(users)+"</div> </div> </div>";
		}
		
		var reactions_html=AP.render(list, function(e){
			var users=AP.render(e.users, function(u){
				return "<div class='reaction-user ap-xdot' title='"+(u.name)+"'>"+(u.name)+"</div>"; 
			});
			
			return "<div class='reaction-item'> <div class='reaction-img'> <img src='"+(Client.share_url)+"/reactions/"+(e.reaction)+".svg'/> <span class='reaction-count'>"+(e.count)+"</span> <div class='reaction-users'>"+(users)+"</div> </div> </div>";
		});
		
		var html= "<div class='reaction-list rc-"+(reactions.length)+"' title='Reactions'>"+(reactions_html)+"</div>";
		return html;
	};
	
	
	this.getPopup=function(obj){
		return "<div class='reaction-box' data-hid='"+(obj.hid)+"' data-token='"+(obj.token)+"' data-objtype='"+(obj.type)+"'> <div class='reaction-icon' onclick='Like.react(this, \"like\");'> <label>Like</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/like.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"love\");'> <label>Love</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/love.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"haha\");'> <label>Haha</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/haha.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"wow\");'> <label>Wow</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/wow.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"sad\");'> <label>Sad</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/sad.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"care\");'> <label>Care</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/care.svg'></div> </div> <div class='reaction-icon' onclick='Like.react(this, \"angry\");'> <label>Angry</label> <div class='reaction-img'><img src='"+(Client.share_url)+"/reactions/angry.svg'></div> </div> </div>";
	};
	
	
	/**
	 * @desc Action call after successfully update reaction
	 */
	this.onUpdate=function(ref, origin){
		var $box=$(ref).closest(".reaction-box");
		
		// Reaction on comment
		if (origin.type && origin.type=="comment"){
			$box.closest(".comment").find(".comment-reactions:first").html(this.getReactions(origin));
			$box.closest(".comment").find(".reaction-wrapper:first").replaceWith(this.getReactionButton(origin));
		}else if (origin.type && origin.type=="post"){
			$box.closest(".footer").find(".post-reactions").html(this.getReactions(origin));
			$box.closest(".footer").find(".reaction-wrapper").replaceWith(this.getReactionButton(origin));
		}else if (origin.type && origin.type=="update"){
			$box.closest(".update").find(".update-reactions").html(this.getReactions(origin));
			$box.closest(".js-update-actions").find(".reaction-wrapper").replaceWith(this.getReactionButton(origin));
		}else{
			AP.sys.trigger("reaction", [ref, origin]);
		}
	};
	
	
	/**
	 * @desc Embed the object reaction quickly
	 */
	this.embed=function(obj, canvas, opts){
		$(canvas).html("<div class='reaction-embed-button'></div><div class='reaction-embed-list'></div>").addClass("reaction-embed");
		$(canvas+" .reaction-embed-button").html(Like.reaction.getReactionButton(obj));
		$(canvas+" .reaction-embed-list").html(Like.reaction.getReactions(obj));
	};
	
	
	
	
	function getReactionOverview(reactions){
		var u={};
		for (var i=0; i<reactions.length; i++){
			var r=reactions[i];
			
			if (u[r.reaction]){
				u[r.reaction].users.push(r.user_id);
			}else{
				u[r.reaction]={reaction: r.reaction, users: [r.user_id]}
			}
		}
		
		var list=[];
		for (var key in u){
			u[key].count=u[key].users.length;
			list.push(u[key]);
		}
		
		for (var i=0; i<list.length; i++){
			list[i].users=People.getList(list[i].users);
		}
		return list;
	};
	
	
	
	function getFullOverview(reactions, list){
		if (!list.length){
			return '';
		}
		
		var is_reacted = ARR.find(reactions, function(e){
			return se(e.user_id, Client.viewer.id);
		});
		
		if (is_reacted && reactions.length==1){
			return '';
		}
		
		var icons = AP.render(list, function(r, index){
			return "<span class='r-icon'><img src='"+(Client.share_url)+"/reactions/"+(r.reaction)+".svg'/></span>";
		});
		
		var names = AP.render(reactions, function(r, index){
			if (index >= 3){
				return '';
			}
			
			if (se(r.user_id, Client.viewer.id)){
				return '';
			}
			
			var u = People.get(r.user_id);
			if (u && !u.error){
				return "<em>"+(u.name)+"</em>, ";
			}
		});
		
		if (names && names.length){
			names = names.substr(0, names.length-2);
			
			if (reactions.length>=5){
				names += " vĂ  "+(reactions.length-3)+" other people";
			}else if (reactions.length>=4){
				names += " vĂ  1 other person";
			}
			
			if (is_reacted){
				names = "You, "+(names)+"";
			}
			
			names = "<span class='fnames'>"+(names)+"</span>";
			
		}else{
			return '';
		}
		
		return "<span class='fo'>"+(icons)+" "+(names)+" reacted on this</span>";
	};
	
};
var Pin=new function __Pin(){
	this.pin=function(object, callback){
		AP.post("api/pin/pin",{hid: object.hid, token: object.token}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			object.pin=1;
			UI.flash("Content pinned ...");
			
			updateDisplay(object, code.pin);
			
			
			
			if (callback){
				callback(object, code.pin);	
			}
		});
	};
	
	
	this.unpin=function(object, callback){
		AP.post("api/pin/unpin",{hid: object.hid, token: object.token}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			object.pin=0;
			UI.flash("Content unpinned ...");
			
			updateDisplay(object, code.pin);
			
			if (callback){
				callback(object, code.pin);	
			}
		});
	};
	
	
	
	this.pinUpdate=function(ref){
		var $this=$(ref);
		var $canvas=$this.closest('.update');
		var object=$canvas.data('object');
		
		this.pin(object);
	};
	
	
	this.unpinUpdate=function(ref){
		var $this=$(ref);
		var $canvas=$this.closest('.update');
		var object=$canvas.data('object');
		
		this.unpin(object);
		
	};
	
	
	this.removePin=function(ref){
		$("#home-pins .li").each(function(){
			if ($(this).data("ref")==ref.gid){
				$(this).remove();
			}
		});
	};
	
	
	
	function updateDisplay(object, pin){
		var $canvas=$("#update-"+object.id);
		
		if ($canvas && $canvas.length){
			$canvas.each(function(){
				Update.update(object, $(this));		
			});
		}
		
		if (pin){
			if (parseInt(object.pin)){
				Update.home.updatePin(pin, false);
			}else{
				Update.home.updatePin(pin, true);
			}
		}
	};
};var Poll=new function __Poll(){
	this.getForm=function(url, callback){
		this.form.create(url, {type: 'poll'}, callback);
	};
	
	
	this.hideForm=function(){
		Form.hide("#fly-poll-fx");
	};
	
	
	this.create=function(params, callback){
		
		
		params.type="poll";
		this.form.create("api/survey/create", params, function(form){
			UI.ajaxShow();
			AP.submit(form, function(code){
				UI.ajaxHide();
				Poll.form.hide();
				callback(code);
				
				if (params && params.gid){
					AP.fire("new-poll-"+params.gid, [code.poll, code.log, _origin]);
	                AP.fire("new-poll", [code.poll, code.log, _origin]);
				}
			});
		});
	};
	
	
	this.edit=function(){
		Poll.form.edit(Poll.ui.current, function(poll){
			Poll.ui.display(poll);
		});
	};
	
	
	this.vote=function(hid, token, answers, callback, error_callback){
		answers.hid=hid;
		answers.token=token;
		
		AP.post("api/survey/vote", answers, function(code){
			if (!code.good()){
				AP.alertError(code.message);
				if (error_callback) error_callback();
				return;
			};
			
			callback(code.survey);
		});
	};
	
	
	this.preview=function(hid, token){
		AP.ajaxShow();
		AP.post("api/survey/get",{hid: hid, token: token}, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				AP.alertError(code.message);
				return;
			}
			
			Poll.ui.display(code.survey);
		});
	};
};



Poll.ui=new function __PollUI(){
	this.current=null;
	
	this.display=function(poll){
		this.current=poll;
		BC.title(getTitle(poll));
		BC.side(getSide(poll));
		BC.main(getMain(poll));
		BC.show();
		
		Comment.auto("#side-comment-"+poll.id, poll);
		Comment.attachBottom("#bside", poll);
		$("#side-followers").html(BC.ui.followers(poll));
	};
	
	
	
	function getTitle(poll){
		var edit="";
		var export_link = "";
		if (poll.user_id===Client.viewer.id){
			edit=" <span class='a std' onclick='Poll.edit();'>Chá»‰nh sá»­a</span> &middot; ";
			export_link = " <a class='std' style='font-size: 11px;' href='" + Client.url + "/survey/export/" + poll.id + "'>Xuáº¥t ra excel</a> &middot; ";
		}
		
		var extra="Hoáº¡t Ä‘á»™ng cuá»‘i lĂºc "+UI.simpleTime(poll.last_update);
		if (poll.expired && parseInt(poll.expired)){
			extra="Háº¿t háº¡n vĂ o "+UI.simpleDate(poll.expired);
		}
		
		return "" +
		"<div class='image'><img src='"+Client.share_url+"/32/chart.png'></div>"+
		"<h1><span class='sub'>Poll:</span> "+poll.name+"</h1>" +
		"<h3>Created by <span class='a std url' data-username='"+poll.username+"'>"+name(poll.username)+"</span> &middot; "+ edit + export_link + "" + UI.simpleTime(poll.since)+" &middot; "+extra+"</h3>" +
		"<div class='actions align-right'>" +
		"	<div class='stat'><b>"+poll.stats.votes+"</b> votes</div>" +
	"</div>";
	};
	
	
	function getSide(poll){
		return "<div id='side-followers' class='section'></div> <div id='side-comment-"+poll.id+"'></div>";
	};
	
	
	function getMain(poll){
		return "<div class='embed-20 fill scroll-y'><div class='in'>"+Poll.embed.html(poll, true)+"</div></div>";			
	};
};Poll.form=new function __PollForm(){
    this.maxOpts = 20;
    
	this.create=function(url, data, callback){
	    // get end of day
	    var t = new Date();
	    t.setSeconds(59);
        t.setMinutes(59);
        t.setHours(23);
        var timeEndOfDay = Math.floor(t.getTime()/1000);
	    
		var form=Form.create('fly-poll-fx',{'action': url})
			.row(
				Form.label({label: "Poll name *",sublabel: "the name of the poll"}),
				Form.input({name: 'name', "placeholder":"Choose a short name for the poll"})
			)
//			.row(
//				Form.label({label: "Multiple selection?",sublabel: "do you allow multiple selections?"}),
//				Form.input({name: 'ptype', type:'select', "placeholder":"The content of the email", options:[
//                     {value: 0, 'label':'Each person could only select a single option'},
//                     {value: 1, 'label':'Allow multiple selections'},
//                ]})
//			)
			.noRow("Poll options (max of " + Poll.form.maxOpts + " options)")
			.row(
				Form.label({label: "Option 1"}),
				Form.input({name: 'option-1', type:'text', "placeholder":"Option 1", "class":"__choice"})
			)
			.addClass("pollopt")
			.row(
				Form.label({label: "Option 2"}),
				Form.input({name: 'option-2', type:'text', "placeholder":"Option 2", "class":"__choice"})
			)
			.addClass("pollopt")
			.row(
				Form.label({label: "Option 3"}),
				Form.input({name: 'option-3', type:'text', "placeholder":"Option 3", "class":"__choice"})
			)
			.addClass("pollopt")
			.row(
				Form.label({label: "Option 4"}),
				Form.input({name: 'option-4', type:'text', "placeholder":"Option 4", "class":"__choice"})
			)
			.addClass("pollopt")
			.rowHTML("<div class='link'>-- More advanced options --</div>")
			.wrap("Advanced poll options","#advopts")
			.row(
				Form.label({label: "NgÆ°á»i theo dĂµi",sublabel: "ThĂ nh viĂªn theo dĂµi bĂ¬nh chá»n nĂ y. Báº¡n cĂ³ thá»ƒ Ä‘á»ƒ trá»‘ng."}),
				Form.input({name: 'usernames', "placeholder":"Sá»­ dá»¥ng @ tag thĂ nh viĂªn theo dĂµi", role:"tag"})
			)
			.row(
				Form.label({label: "HĂ¬nh áº£nh",sublabel: "ÄÄƒng hĂ¬nh áº£nh cho bĂ¬nh chá»n"}),
				Form.input({name: 'image', type:"file"})
			)
			.row(
                Form.label({label: "Thá»i háº¡n *",sublabel: "Äá»ƒ trá»‘ng náº¿u khĂ´ng cĂ³ thá»i háº¡n bĂ¬nh chá»n"}),
                Form.input({name: 'expcheckbox', "placeholder":"", type:"checkboxes", 
                    options:[{label:"BĂ¬nh chá»n cĂ³ thá»i háº¡n", value:0, name: "expcheck"}]})
            )
			.rowHidden(
                Form.label({label: "Thá»i Ä‘iá»ƒm háº¿t háº¡n *"}),
                Form.input({name: 'expired', type: 'datetime', "role":"date", "placeholder":"Chá»n thá»i Ä‘iá»ƒm bĂ¬nh chá»n háº¿t háº¡n"}).value(timeEndOfDay)
            )
			.wrap()
			.buttons([
			     {label: "Create a new poll", action: function(){
			    	 var callback=$("#fly-poll-fx").data("callback");
			    	 callback("#fly-poll-fx");
			     }, style: 'ok -success -rounded bold'},
			     {label: "Cancel", action: function(){
			    	 Form.hide("fly-poll-fx");
			     }, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(form){
				form.elem(".link").click(function(){
					$(this).hide();
					$("#advopts").show();
				});
				
				$("#fly-poll-fx").data("callback", callback);
				$("#fly-poll-fx").on("focus", ".input input.__choice", function(){
					var $next=$(this).closest(".row").next(".pollopt");
					if (!$next  || !$next.length){
						var index= $("#fly-poll-fx .row .input input.__choice").length+1;
						if (index > Poll.form.maxOpts){
							return;
						}
						
						$("#fly-poll-fx .row input.__choice").last().closest(".row").after("<div class='row pollopt'><div class='label'>Option "+index+"</div><div class='input data'><input class='std __choice' type='text' name='option-"+index+"' placeholder='Option "+index+"'></div><div class='clear'></div></div>"); 
					}
				});
				
				$('input[name="expcheckbox[]"]').change(function(){
	                var $row = $(this).closest(".row");
	                var $next = $row.next(".row");
	                
	                if($('input[name="expcheckbox[]"]').is(':checked')) {
	                    $next.show();
	                } else {
	                    $next.hide();
	                }
	            });
			});
		
		Form.pop({width: 720, label: 'Create a poll'
		}).setForm(form).show().focus('name');
	};
	
	
	this.edit=function(poll, callback){
		if (!poll){
			return;
		}
		var data={hid: poll.hid, token:poll.token};
		
		var form=Form.create('fly-poll-fx',{'action': "api/survey/edit"})
		.row(
			Form.label({label: "Poll name *",sublabel: "the name of the poll"}),
			Form.input({name: 'name', "placeholder":"Choose a short name for the poll"}).value(poll.name)
		)
		.row(
			Form.label({label: "Cover image",sublabel: "Upload poll's cover image (not required)"}),
			Form.input({name: 'image', type:"file"})
		)
		.row(
            Form.label({label: "Thá»i háº¡n *",sublabel: "Äá»ƒ trá»‘ng náº¿u khĂ´ng cĂ³ thá»i háº¡n bĂ¬nh chá»n"}),
            Form.input({name: 'expcheckbox', "placeholder":"", type:"checkboxes", 
                options:[{label:"BĂ¬nh chá»n cĂ³ thá»i háº¡n", value:0, name: "expcheck"}]})
        )
        .rowHidden(
            Form.label({label: "Thá»i Ä‘iá»ƒm háº¿t háº¡n *"}),
            Form.input({name: 'expired', type: 'datetime', "role":"date", "placeholder":"Chá»n thá»i Ä‘iá»ƒm bĂ¬nh chá»n háº¿t háº¡n"}).value(poll.expired)
        )
		.buttons([
		     {label: "Edit poll", action: function(){
		    	 Form.submit("#fly-poll-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 Form.hide("#fly-poll-fx");
		    		 callback(code.poll);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("fly-poll-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
		    if(typeof poll.expired !== 'undefined' && poll.expired != 0) {
		        $('input[name="expcheck"]').prop('checked', true);
		        var $expcheckRow = $('input[name="expired-date"]').closest(".row");
		        $expcheckRow.show();
		    }
		    $('input[name="expcheck"]').change(function(){
                var $row = $(this).closest(".row");
                var $next = $row.next(".row");
                
                if($('input[name="expcheck"]').is(':checked')) {
                    $next.show();
                } else {
                    $next.hide();
                }
            });
		});
		
		Form.pop({width: 720, label: 'Edit poll'
		}).setForm(form).show().focus('name');
	};
	
	
	
	this.hide=function(){
		Form.hide("fly-poll-fx");
	};
	
	this.submit=function(success_callback){
		Form.submit("#fly-poll-fx", function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Poll.form.hide();
			success_callback(code);
		});
	};
	
	
	this.insertData=function(form, data){
		var html="";
		for (var key in data){
			html+="<input type='hidden' name='"+key+"' value='"+data[key]+"'/>";
		}
		
		if (!$(".__insert", form).length){
			$("<div class='hidden __insert'></div>").appendTo(form);
		}
		
		$(".__insert", form).html(html);
	};
};
Poll.embed = new function __PollEmbed() {

	/**
	 * Poll Embed HTML
	 * Everything about HTML on here.
	 * ---
	 * @param {object} poll
	 * @param {boolean} on_popup
	 * @returns {string}
	 */
	this.html = function (poll, on_popup) {
		var answer = null;
		if (parseInt(poll.voted)) {
			answer = poll.vote.answers[0];
		}

		var question = poll.questions[0];
		var poll_voted_class = answer ? " -voted" : "";
		var poll_voted_title = answer ? " title='You voted on this poll'" : "";
		var poll_cover = (poll.cover && poll.cover.length) ? "<div class='cover'><img src='"+(poll.cover)+"'/></div>" : "";
		var poll_options = (question.choices.length > 0) ? AP.render(question.choices, function (option, index) {
			return getChoice(option, index, question, answer);
		}) : "";
		var poll_submit = "";

		if (parseInt(poll.expired) && parseInt(poll.expired) < AP.time.now()) {
			poll_submit = "<div class='submit'> <div class='txt red' style='font-style:normal'>The poll is expired and cannot accept votes anymore.</div> </div>";
		} else {
			if (!parseInt(poll.voted)) {
				poll_submit = "<div class='submit'> <div class='button -success -rounded' onclick='survey_vote_now(this);'>Vote now</div> </div>";
			} else {
				poll_submit = "<div class='submit'><div class='txt'>You already voted at <span>" + UI.simpleTime(poll.vote.since) + "</span> " +
					(on_popup ? "" : "&middot; <span class='a std action' onclick=\"Poll.preview('" + poll.hid + "','" + poll.token + "');\">Voting details</span>") +
					"</div></div>";
			}
		}

		return "<div class='poll -embed box box-survey -survey-question "+(poll_voted_class)+"' data-hid='"+(poll.hid)+"' data-token='"+(poll.token)+"' "+(poll_voted_title)+"> <div class='title'>"+(question.name)+"</div> "+(poll_cover)+" <div class='choices'> "+(poll_options)+" <input type='hidden' name='answer-0' value='-1'/> </div> "+(poll_submit)+" </div>";
	};


	this.update = function (poll, $canvas) {
		$canvas.replaceWith(this.html(poll));
	};


	function getChoice(choice, choice_index, question, answer) {
		if (answer === null) {
			return "<div class='choice relative' onclick='survey_select_choice(this)' data-token='" + choice.key + "'><div class='-radio -unchecked -big pull-left'></div> <div class='-text'>" + choice.text + "</div></div>";
		} else {
			var count = parseInt(choice.count);
			var total = 0;
			for (var i = 0; i < question.choices.length; i++) {
				total += parseInt(question.choices[i].count);
			}
			var percent = 0;
			if (total > 0) {
				percent = Math.floor(count * 100 / total);
			}

			var bar = "<div class='process-bar'>" +
				"<div class='-process'><div class='-bar -bg-success' style='width:" + percent + "%'></div></div> " +
				"<div class='-text'><b>" + percent + "%</b> (" + count + " " + AP.word.plural("vote", count) + ")</div>" +
				"</div>";

			if (parseInt(answer) === choice_index) {
				return "<div class='choice relative voted -checked' data-token='" + choice.key + "'><div class='-radio -checked -big pull-left'></div> <div class='-text'>" + choice.text + "</div>" + bar + "</div>";
			} else {
				return "<div class='choice relative voted' data-token='" + choice.key + "'><div class='-radio -unchecked -big pull-left'></div> <div class='-text'>" + choice.text + "</div>" + bar + "</div>";
			}
		}

	};
};


function survey_select_choice(ref) {
	var $ref = $(ref);
	$ref.closest(".choices").find(".choice").removeClass("-checked").find(".-radio").removeClass("-checked").addClass("-unchecked");
	$ref.closest(".choices").find("input").val($($ref.parent().find('.choice')).index($ref));
	$ref.find(".-radio").removeClass("-unchecked").addClass("-checked");
	$ref.addClass("-checked");
};


function survey_vote_now(ref) {
	var $canvas = $(ref).closest(".box-survey");
	var hid = $canvas.data("hid");
	var token = $canvas.data("token");

	var answers = {};


	$canvas.find("input").each(function () {
		answers[$(this).attr("name")] = $(this).val();
	});

	if ($canvas.ajaxOn()) {
		return;
	}


	$canvas.ajaxShow();

	Poll.vote(hid, token, answers, function (poll) {
		$canvas.ajaxHide();
		Poll.embed.update(poll, $(ref).closest(".box-survey"));
	}, function () {
		$canvas.ajaxHide();
	});
};var FileX = new function __File(){
	this.inited=false;
	this.pickerCallback=null;	
	this.fileTypes = {
			'GDOC': '0',
			'GXLS': '1',
			'GPPT': '2',
			'GDRAW': '3',
			'GFILE': '4'
		};
	
	
	this.create=function(origin, callback){
		FileX.pick(function(file){
			if (file.type=="dropbox" || file.type=="onedrive" || file.type=="google"){
				FileX.save(file, {hid: origin.hid, token: origin.token}, function(_origin, file, log){
					// Handle file add
					FileX.hideForm();
					UI.flash("The file was saved ...");
					AP.fire("new-file-"+_origin.gid, [file, log, _origin]);
					AP.fire("new-file", [file, log, _origin]);
					
					if (callback){
						callback(file, log, _origin);
					}
				});
			}else if (file.type=="upload"){
				var data={hid: origin.hid, token: origin.token};
				if (AP.isset("Channel")){
					// data.channel_id=Channel.channel.id;
				}
				FileX.upload.now(file, data, function(_origin, file, log){
					//$.log([origin, file, log]);
					FileX.hideForm();
					UI.flash("The file was uploaded ...");
					AP.fire("new-file-"+_origin.gid, [file, log, _origin]);
					AP.fire("new-file", [file, log, _origin]);
					
					if (callback){
						callback(file, log, _origin);
					}
				});
			} else if(file.type == "txt") {
				FileX.upload.txt({hid: origin.hid, token: origin.token, filename: file.name, filecontent: file.content}, function(_origin, file, log) {
					FileX.hideForm();
					UI.flash("The file was created!");
					AP.fire("new-file-" + _origin.gid, [file, log, _origin]);
					AP.fire("new-file", [file, log, _origin]);
					
					if (callback){
						callback(file, log, _origin);
					}
				});
			}
		});
	};
	
	
	this.pick=function(callback){
		if (!this.inited){
			this.inited=true;
			this.initPicker();
		}
		
		this.pickerCallback=callback;
		
		var domain = "//" + CONFIG.home_src;
		var html="" +
			"<div class='title'>Select a file <div class='-close' onclick='AP.closeDialog(this);'></div></div>"+
			"<div class='list list-actions -border'>" +
				"<div class='li item unselectable'>" +
				"   <div class='-icon -big'><span class='-ap icon-cloud_upload'></span></div>" +
				"   Browse file from computer <div class='sub'>Click to browse and upload the file</div>" +
				"   <div class='full-mask fileapi' id='file-upload-input-inv'><input type='file' name='file' onchange='file_local_change(this, FileX.localSelect);'/></div>" +
				"</div>" +
				"<div class='li item unselectable' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-dropbox2'></span></div>" +
				"   Pick from Dropbox <div class='sub'>You can select a file from your Dropbox account</div>" +
				"   <div class='full-mask fileapi'><iframe src='"+domain+"/filepick/dropbox' frameBorder='0' width='100%' height='100%' allowTransparency='true'></iframe></div>" +
				"</div>" +
				"<div class='li item unselectable' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-google-drive'></span></div>" +
				"   Pick from Google Drive <div class='sub'>You can select a file from your Google Drive account</div>" +
				"   <div class='full-mask fileapi'><div style='width:100%; height:100%' onclick='FileX.replaceGdriveFrame();'></div></div>" +
				"</div>" +
				"<div class='li item unselectable' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-onedrive'></span></div>" +
				"   Pick from Microsoft OneDrive <div class='sub'>You can select a file from your OneDrive account</div>" +
				"   <div class='full-mask fileapi'><iframe src='"+domain+"/filepick/onedrive' frameBorder='0' width='100%' height='100%' allowTransparency='true'></iframe></div>" +
				"</div>" +
				"<div class='li -sep' style='display: none;'></div>" +
				"<div class='li item unselectable' onclick='FileX.createTextFile();' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-add_circle_outline'></span></div>" +
				"   Create a text document <div class='sub'>Create a new document file directly in WorkTime</div>" +
				"</div>" +
				"<div class='li item unselectable' onclick='FileX.createGDoc();' style='display: none;'>" +
				"   <div class='-icon -big'><span class='-ap icon-add_circle_outline'></span></div>" +
				"   Create a new file via Google Docs <div class='sub'>Create a collaborative file (document, presentation, spreadsheet) via Googe Docs</div>" +
				"   <div class='full-mask fileapi'><iframe id='gjs-iframe' src='"+domain+"/filepick/gdoc' frameBorder='0' width='0' height='0' allowTransparency='true'></iframe></div>" +
				"</div>" +
			"</div>";
		
		AP.customDialog(html, "custom-selection").width(600).style("-full").show();
	};
	
	
	this.unpick=function(){
		AP.closeDialog("#custom-selection");
	};
	
	
	
	this.pick2Save=function(base, callback){
		FileX.pick(function(file){
			if (file.type=="dropbox" || file.type=="onedrive" || file.type=="google"){
				FileX.save(file, {hid: base.hid, token: base.token}, function(origin, file, log){
					UI.flash("Upload successfully!");
					AP.fire("upload-"+base.gid, [origin, file, log]);
					FileX.unpick();
					if (callback){
						callback(origin, file, log);
					}
				});
			}else if (file.type=="upload"){
				var data={hid: base.hid, token: base.token};
				
				FileX.upload.now(file, data, function(origin, file, log){
					//$.log(base);
					UI.flash("Upload successfully!");
					// AP.xRefresh();
					// AP.fire("upload-"+base.gid, [origin, file, log]);
					FileX.unpick();
					if (callback){
						callback(origin, file, log);
					}
				});
			} else if(file.type == "txt") {
				FileX.upload.txt({hid: base.hid, token: base.token, filename: file.name, filecontent: file.content}, function(origin, file, log) {
					
					UI.flash("The file was created!");
					AP.fire("upload-" + base.gid, [origin, file, log]);
					FileX.unpick();
					if (callback){
						callback(origin, file, log);
					}
				});
			}
		});
	};
	
	
	
	this.hideForm=function(){
		return this.unpick();
	};
	
	
	
	this.save=function(file, data, callback, error_callback){
		for (var key in data){
			file[key]=data[key];
		}
		
		AP.ajaxShow();
		AP.post("api/file/create",file, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.file, code.log);
		});
	};
	
	
	
	
	this.preview=function(hid, token){
		AP.ajaxShow();
		AP.post("api/file/get",{hid: hid, token: token}, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				AP.alertError(code.message);
				return;
			}
			
			FileX.display(code.file);
		});
	};

	
	this.inlinePreview=function(file){
		if (!file || !file.src){
			return "";
		}
		
		var src=file.src;
		var download=file.download;
		if (!download){
			download=src;
		}
		
		if (file.image && parseInt(file.image)){
			return "<div class='inline-file-preview' style='padding-left:0px' onclick=\"FileX.quickPreview('"+src+"');\">" +
				"<div class='preview-image'><img src='"+AP.zthumb(src)+"'/></div>" +
			"</div>";
		}
		
		return "<div class='inline-file-preview -line' onclick=\"FileX.quickPreview('"+src+"');\">" +
			"<span class='icon'><span class='-ap icon-uniF10A'></span></span>" +
			"<div class='name ap-xdot'>"+file.name+"</div>" +
			"<a class='download' target='_blank' href='"+download+"'>Download</a>" +
		"</div>";
	};
	
	
	
	this.__cache=null;
	
	this.quickPreview=function(file_src, multiple){
		if (!multiple){
			multiple={};
			this.cache=null;
		}else if (multiple==1 && this.__cache){
			multiple=this.__cache;
		}else{
			this.__cache=multiple;
		}
		
		if (mobile()){
			window.open(getMobileFileURL(file_src));
			return;
		}
		
		if (AP.data.isObject(file_src)){
			BC.show();
			BC.noSide();
			BC.main(FileX.ui.getMain(file_src));
			return;
		}
		
		var is_image=0;
		var ext=UI.file.ext(file_src);
		if (ext=="jpg" || ext=="png" || ext=="bmp" || ext=="jpeg" || ext=="gif"){
			is_image=1;
		}
		
		var file={name: file_src, src: file_src, image: is_image};
		BC.show();
		BC.noSide();
		BC.main(FileX.ui.getMain(file));
		
		// Handle multiple
		$("#bcanvas .-in .mnav").remove();
		
		if (multiple.container && $(multiple.container).find(multiple.filter).length>1){
			var prev=file_src;
			var next=file_src;
			
			$(multiple.container).find(multiple.filter).each(function(index){
				var fid=$(this).data("file");
				
				if (fid==file_src){
					var $prev=$(multiple.container).find(multiple.filter).eq(index-1);
					var $next=$(multiple.container).find(multiple.filter).eq(index+1);
					
					if ($prev.length){
						prev=$prev.data("file");
					}
					
					if ($next.length){
						next=$next.data("file");
					}
					
					return;
				}
			});
			
			$("#bcanvas .-in").append("<span class='mnav -left pointer' onclick=\"FileX.quickPreview('"+(prev)+"', 1);\"><span class='-ap icon-arrow-left2'></span></span> <span class='mnav -right pointer' onclick=\"FileX.quickPreview('"+(next)+"', 1);\"><span class='-ap icon-arrow-right2'></span></span>");
		}
	};
	
	

	this.quickPreviewNoDownload = function(fid) {
		BC.show();
		BC.noSide();
		BC.main(FileX.ui.getMainNoDownload(fid));
	};


	/**
	 * @desc Preview a list of files
	 */
	var cached_lists = [];
	this.previewList = function(files, first){
		if (files){
			cached_lists = files;
			if (!first && files.length){
				first = files[0].src;
			}
		}
		
		if (!first){
			return;
		}
		
		if (cached_lists && cached_lists.length){
			var obj = null;
			var next = null;
			var prev = null;
			
			for (var i=0; i<cached_lists.length; i++){
				var e = cached_lists[i];
				if (e.id == first || e.src == first || e.fid == first){
					obj = e;
					if (i<cached_lists.length-1){
						next = cached_lists[i+1].src;
					}else{
						next = cached_lists[0].src;
					}
					
					if (i>0){
						prev = cached_lists[i-1].src;
					}else{
						prev = cached_lists[cached_lists.length-1].src;
					}
					
					break;
				}
			}
			
			
			if (!obj){
				return;
			}
			
			FileX.quickPreview(obj.src);
			
			$("#bcanvas .-in").append("<span class='mnav -left pointer' onclick=\"FileX.previewList(null, '"+(prev)+"');\"><span class='-ap icon-arrow-left2'></span></span> <span class='mnav -right pointer' onclick=\"FileX.previewList(null, '"+(next)+"');\"><span class='-ap icon-arrow-right2'></span></span>");
		}
	};
	
	
	
	this.display=function(file){
		FileX.ui.file=file;
		BC.title(FileX.ui.getTitle(file));
		BC.side(FileX.ui.getSide(file));
		BC.main(FileX.ui.getMain(file));
		BC.show();
		
		Comment.auto("#side-comment-"+file.id, file);
		Comment.attachBottom("#bside", file);
		$("#side-followers").html(BC.ui.followers(file));
	};
	
	
	this.edit=function(hid, token, name){
		Form.edit({type: 'input', action:"api/file/edit", content: name, button:"Edit filename", data:{hid: hid, token:token},"name":"name"}, function(code){
			UI.flash("Filename edited successfully")
			var file=code.file;
			$("#bcanvas .__title h1").html(file.name);
		});
	};
	
	
	this.options=function(){
		var file=FileX.ui.file;
		var actions=[];
		
		var download=file.src;
		if (file.metatype=="" || file.metatype=="upload"){
			download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}
		
		actions.push({label: "Download this file", icon: "download", url: download});
		
		if (file.user_id==Client.viewer.id){
			actions.push({label: "Add a new revision", icon: "upload3", action: function(){
				FileX.newRev(file.hid,file.token,file.gid);
			}});
		}
		
		actions.push({label: "Extend preview windows", icon: "open_in_new", action: function(){
			BC.extend();
		}});
		
		actions.push({label: "Share to company's knowledge-base", icon: "documents", action: function(){
			KBase.shareFrom(file);
		}});
		
		
		AP.actionMenu(actions);
	};
	
	
	this.setPrivate=function(hid, token){
		AP.confirm("Are you sure that you want to set this file as <i>private</i>? If this file is set <i>private</i>, you can browse it in <b>Files</b> &rsaquo; <b>My Files</b>", function(){
			UI.ajaxShow();
			AP.post("api/file/setprivate",{hid: hid, token: token, privacy: 1}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("This file is private now. Only you can view it.");
				$("#bcanvas .__title .set_privacy").replaceWith("<span class='a action std set_privacy' onclick=\"FileX.setPublic('"+hid+"','"+token+"');\">Set public</span>");
			});
		});
	};
	
	
	this.setPublic=function(hid, token){
		AP.confirm("Are you sure that you want to set this file as <i>public</i>? This will allow other people to read this file.", function(){
			UI.ajaxShow();
			AP.post("api/file/setprivate",{hid: hid, token: token, privacy: 0}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.alertSuccess("This file is set public now.");
				$("#bcanvas .__title .set_privacy").replaceWith("<span class='a action std set_privacy' onclick=\"FileX.setPublic('"+hid+"','"+token+"');\">Set private</span>");
			});
		});
	};
	
	
	
	this.newRev=function(hid, token, gid){
		this.pick2Save({hid: hid, token:token, gid: gid}, function(origin, file, log){
			FileX.ui.showRev(origin, file);
		});
	};
	
	
	this.initPicker=function(){
		var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
		var eventer = window[eventMethod];
		var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

		// Listen to message from child window
		eventer(messageEvent,function(e) {
			switch(e.data) {
				case "validToken":
					FileX._showCreateForm();
					break;
				case "GoogleAPI failed":
					AP.ajaxHide();
					AP.alert("Something went wrong with Google Drive API. Please try again.")
					break;
				case "!_{h:''}":
					break;
				default:
					try{
						var data = JSON.parse(e.data);
						if(data.result == "gsuccess") {
							FileX.successGDoc(data);
						} else {
							FileX.pickerCallback(data);
						}
					} catch(e) {
						// !_h{}
						console.log(e);
					}
					break;
			}
		},false);
	};
	
	
	this.localSelect=function(file){
		FileX.pickerCallback(file);
	};
	
	this.replaceGdriveFrame = function(callback) {
		AP.closeDialog("#custom-selection");
		if (Client.https) {
			var extGTab = window.open("https://" + CONFIG.home_src + "/filepick/google", "_blank");
		} else {
			var extGTab = window.open("http://" + CONFIG.home_src + "/filepick/google", "_blank");
		}
	};
	
	this.sendMessage = function(child_id, msg) {
		var iframe = document.getElementById(child_id);
		iframe.contentWindow.postMessage(msg, '*');
	};
	
	this.createGDoc = function() {
		this.sendMessage('gjs-iframe', 'doAuth');
	};
	
	this._showCreateForm = function() {
		var text = "<h2>Create new public file in Google Drive</h2>";
		text += "<h6>Document title</h6><input type='text' name='title' id='gdoc-title' placeholder='Insert title of document'/>";
		text += "<h6>Choose type</h6><select name='type' placeholder='Type of document' id='gdoc-type'>";
		
		text += "<option value='" + this.fileTypes.GDOC + "'>Google Docs</option>";
		text += "<option value='" + this.fileTypes.GXLS + "'>Google Sheets</option>";
		text += "<option value='" + this.fileTypes.GPPT + "'>Google Slides</option>";
		text += "<option value='" + this.fileTypes.GDRAW + "'>Google Drawing</option>";
		text += "<option value='" + this.fileTypes.GFILE + "'>Google File</option>";
		
		text += "</select>";
			
		text += "<div class='buttons -two'><div class='button -error -first -rounded' onclick='AP.closeDialog(this);'>Cancel</div><div class='button -success -second -rounded' onclick='FileX.createNew(FileX.successGDoc);'>Create</div></div>";
	
		AP.customDialog(text)
		.width(500)
		.show();
	};
	
	
	this.createNew = function() {
		AP.ajaxShow();
		var title = $('#gdoc-title').val();
		
		if (!title || title.length == 0) {
			AP.alertError("Please enter file name.");
			AP.ajaxHide();
		} else {
			var type = $('#gdoc-type').val();
			var txtMsg = JSON.stringify({action: "create", title: title, type: type});
			this.sendMessage('gjs-iframe', txtMsg);
		}
	};
	

	
	/**
	 * Default callback when successfully creating new (public) file in Google Drive
	 */
	this.successGDoc = function(successObj) {
		AP.ajaxHide();
		var file = ({
			name:successObj.fileTitle,
			src: successObj.altLink,
			type:"google",
			preview:"https://drive.google.com/file/d/" + successObj.fileId + "/preview"
		});
		FileX.pickerCallback(file);
		AP.closeDialog('#custom-dialog');
		AP.closeDialog("#custom-selection");
		AP.alertSuccess("Your file has been created! <a target='_blank' href='"+successObj.altLink+"'>Click here</a> to edit.");
	};
	
	
	this.createTextFile = function() {
		var form = Form.create('textfile-create-fx', {action: 'api/file/prepare.text'})
		.row(
			Form.label({label: "File name *", "sublabel":"The name of the text file"}),
			Form.input({name: 'name', "placeholder":"A short name for the text file"})
		)
		.rowHTML(
			"<div class='input'><textarea placeholder='Fill content of text file here' name='content' style='height: 300px; width: 100%;'></textarea></div>" +
			"<div class='clear'></div>"
		)
		.render()
		.buttons([
			 {label: "Create text file", action: function() {
				 Form.submit("textfile-create-fx", function(code) {
					 if(code.good()) {
						 Form.hide("textfile-create-fx");

						 var file = {name: code.filename, content: code.txt, icon: UI.file.fontIcon("untitled.txt"), type: "txt"};
						 FileX.pickerCallback(file);
					 } else {
						 return AP.alertError(code.message);
					 }
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Cancel", action: function() {
				 Form.hide("textfile-create-fx");
			 }, style:'-cancel -passive-2 rounded'}
		]);
		
		
		Form.pop({id:'textfile-create-fx-dx', width: 720, 
			label: 'Create a new text file'
		}).setForm(form).show().focus('name');
	};
	
	
	function getMobileFileURL(file_url){
		return file_url;
	};
};




FileX.ui=new function __FileUI(){
	this.file=null;
	
	this.embed=function(file){
		if (parseInt(file.image)){
			return "<div class='box -fileemebd -full-image'><div class='-canvas'><img onclick=\"FileX.preview('"+file.hid+"','"+file.token+"');\" src='"+file.url+"'/></div></div>";
		}
		
		var icon=UI.file.icon(file.name);
		var preview="";
		if (file.metatype=="dropbox"){
			preview="<div class='-meta'><span class='ap-f14 ficon-dropbox'></span> &nbsp; <a class='normal std' target='_blank' href='"+file.src+"'>View on Dropbox</a></div>";
		}else if (file.metatype=="onedrive"){
			preview="<div class='-meta'><span class='ap-f14 ficon-windows'></span> &nbsp; <a class='normal std' target='_blank' href='"+file.src+"'>View on OneDrive</a></div>";
		}
		
		var stats=" &middot; "+file.stats.comments+" "+AP.word.plural("comment",file.stats.comments);
		
		
		return "<div class='box -fileembed'>" +
			"<div class='-image pull-left'><img src='"+Client.share_url+"/64/file-"+icon+".png'/></div>" +
			"<div class='-name'><b class='pointer' onclick=\"FileX.preview('"+file.hid+"','"+file.token+"');\">"+file.name+"</b></div>" +
			"<div class='-meta'>Created by @<b class='url username'>"+file.username+"</b> at "+UI.simpleTime(file.since)+"</div>" +
			preview+
		"</div>";
	};
	
	
	this.showRevs=function(){
		var file=this.file;
		if (!file){
			return;
		}
		
		var options=AP.select(file.revs, function(e, index){
			return {data: e, type: 'rev', label: "<b>Rev "+(index+1)+"</b>: "+e.name, sublabel: "Created at "+UI.simpleTime(e.since),"icon":"label_outline"};
		});
		
		options.push({type:'rev','label':"<b>Current version</b>: "+file.name, sublabel: "Created at "+UI.simpleTime(file.since), data: file});
		
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
			options.push({type:'action','label':'<b>Create/upload a new revison</b>', sublabel:'Click to start creating a new version of this file', data: file});
		}
		

		AP.selectAction(options, function(opt){
			if (opt.type && opt.type=='action'){
				return FileX.newRev(opt.data.hid, opt.data.token, opt.data.gid);
			}
			
			FileX.ui.showRev(FileX.ui.file,opt.data);
			
		});
	};
	
	
	this.showRev=function(file, rev){
		BC.main(FileX.ui.getMain(rev));
		BC.title(FileX.ui.getTitle(file, rev));
	};
	
	
	
	this.getTitle=function(file, rev){
		var name=file.name;
		
		var meta=file.metatype;
		var since=file.since;
		if (rev){
			name=rev.name;
			download=rev.src;
			meta=rev.metatype;
			since=rev.since;
		}
		
		
		var icon=UI.file.icon(name);
		
		var download=file.src;
		if (meta=="" || meta=="upload"){
			download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}
		
		var rev_action='';
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
		}
		
		
		var edit_action=" &middot; <span class='a action std' onclick=\"FileX.edit('"+file.hid+"','"+file.token+"','"+file.name+"');\">Edit</span>";
		var set_private=" &middot; <span class='a action std set_privacy' onclick=\"FileX.setPrivate('"+file.hid+"','"+file.token+"','"+file.name+"');\">Set private</span>";
		if (parseInt(file.privacy)==1){
			set_private=" &middot; <span class='a action std set_privacy' onclick=\"FileX.setPublic('"+file.hid+"','"+file.token+"','"+file.name+"');\">Set public</span>";
		}
		
		if (parseInt(file.user_id)!= parseInt(Client.viewer.id)){
			edit_action="";
			set_private="";
		}
		
		var revs_action="";
		if (file.revs && file.revs.length){
			revs_action="<span class='action icon' title='Revisions' onclick='FileX.ui.showRevs();'><span class='count'>"+file.revs.length+"</span><span class='-ap icon-layers2'></span></span>";
		}
		
		var other=" &middot; <span class='a action std advanced' onclick=\"FileX.options('"+file.hid+"','"+file.token+"','"+file.name+"');\">More options</span>";
		
		
		return "" +
			"<div class='image'><img src='"+Client.share_url+"/32/file-"+icon+".png'></div>"+
			"<h1 class='ap-xdot' title='"+name+"'>"+name+"</h1>" +
			"<h3>Created by <span class='a std url username'>@"+file.username+"</span> &middot; "+UI.simpleTime(since)+" &middot; Last activity "+UI.simpleTime(file.last_update)+" " +
			edit_action+set_private+
			rev_action+
			other+
			"</h3>" +
			"<div class='actions align-right'>" +
			revs_action+
			"   <span class='action icon' title='Extend preview' onclick='BC.extend();'><span class='-ap icon-open_in_new'></span></span>" +
			"   <a class='action icon' target='_blank' href='"+download+"' title='Download the file'><span class='-ap icon-get_app'></span></a>" +
		"</div>";
	};
	
	
	this.getSide=function(file){
		return "<div id='side-followers' class='section'></div> <div id='side-comment-"+file.id+"'></div>";
	};
	
	
	this.getMain=function(file) {
		var fileExtension = AP.fileExt(file.name);
		if (isImage(file)) {
			return "<div class='embed-20 embed-image'><div class='image'><img src='"+file.src+"'/></div></div>";
		}else if (isEmbeddable(file) || (fileExtension == "txt")){
			
			if (file.metatype=="onedrive"){
				var url=file.src+"&em=2";
				
				// get cid
				var pos = url.indexOf('resid=');
				var suburl = url.substring(pos);
				var pivot = suburl.indexOf('!');
				var cid = suburl.substring(6, pivot);
				
				url = url.replace("redir?","embed?cid="+cid+"&");
				
				return "<div class='embed-20 embed-file -iframe'>" +
					"<iframe src=\""+url+"\" style='width:100%; height:100%;' frameborder='0' scrolling='no'></iframe>"+
				"</div>";
			}else if (file.metatype=="dropbox"){
				var url=file.preview;
				if (!url){
					return "<div style='margin-top: 60px; font-size: 15px; text-align:center;'>" +
							"<div class='featured' style='margin-bottom: 15px;'>This file has been picked from Dropbox and can't be previewed.</div>" +
							"<a href='" + file.src + "'>Click here to download file</a>" +
							"</div>";
				}
				
				url=url.replace("bounding_box=75","bounding_box=800");
				return "<div class='embed-20 embed-image'><div class='image'><img src='"+url+"'/></div></div>"
			}else if (file.metatype == "google" || file.metatype == "googledrive"){
				if ($.inArray(fileExtension, ['gdoc', 'gsheet', 'gdraw', 'gslides']) < 0) {
					return "<div class='embed-20 embed-file'>" +
						"<iframe src=\""+file.preview+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
				} else {
					return "<div class='embed-20 embed-file'>" +
						"<iframe src=\""+file.src.substr(0, file.src.lastIndexOf('?'))+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
				}
			}

			// preview from drive
			if (file.name.indexOf("drive.google.com") !== -1 && file.name.indexOf("preview") !== -1){
				return "<div class='embed-20 embed-file -iframe'>"+
					"<iframe src='" + file.src + "' style='width:100%; height:100%;' frameborder='0'></iframe>" +
					"</div>";
			}
			
			// M$ Office file types
			
			if ($.inArray(fileExtension, ['doc', 'docx', 'xls', 'xlsx', 'xlsm', 'ppt', 'pptx']) >= 0) {
				return "<div class='embed-20 -iframe embed-file'>" +
					"<iframe src=\"https://view.officeapps.live.com/op/embed.aspx?src="+file.src+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
				"</div>";
			}

			if (fileExtension == "pdf") {
				return "<div class='embed-20 embed-file -iframe'>"+
					"<iframe src='" + file.src + "' style='width:100%; height:100%;' frameborder='0'></iframe>" +
				"</div>";
			}

			if (Client.https) {
				return "<div class='embed-20 -iframe embed-file'>" +
					"<iframe src=\"https://docs.google.com/gview?url="+file.src+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
				"</div>";
			}
			return "<div class='embed-20 -iframe embed-file'>" +
				"<iframe src=\"http://docs.google.com/gview?url="+file.src+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
			"</div>";
		}else if (fileExtension=='webm'){
			return "<div class='embed-20 embed-image'><div class='embed-video-inline -abs-fit'> <video controls style='max-height:100%; width:100%; height: auto;'> <source src='"+(file.src)+"' type='video/webm'> Sorry, your browser doesn't support embedded videos. </video> </div></div>";
		}else if (fileExtension=='mp3'){
			return "<div class='embed-20 embed-image'><div class='embed-video-inline -abs-fit center'> <audio controls> <source src='"+(file.src)+"' type='audio/mpeg'> Your browser does not support the audio element. </audio> </div></div>";
		}else if (fileExtension=='svg'){
			return "<div class='embed-20 embed-image'><div class='embed-svg -abs-fit center'> <img src='"+(file.src)+"'/> </div></div>";
		}else{
			var download=file.src;
			return "<div class='center' style='padding:20px;'>No preview avaiable. Please <a href='"+download+"' target='_blank'>download the file</a>.</div>";
		}
	};
	this.getMainNoDownload = function(fid) {
		var sfileview_url = "https://fileviewer-" + Client.domain.split('.').join("") + ".basecdn.net";
		return "<div class='embed-20 -iframe embed-file'>" +
			"<iframe src=\"" + sfileview_url + "/web/viewer.html?file=/sview/" + fid + "&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
			"</div>";
	};	
	
	
	function isImage(file){
		if (file.image && parseInt(file.image)){
			return true;
		}

		return false;
	};
	
	
	function isEmbeddable(file){
		var ext = AP.fileExt(file.name);
		
		if (file.metatype=="onedrive"){
			return true;
		}
		
		if (file.metatype=="dropbox" && file.preview && file.preview.length && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
			return true;
		}
		
		if (file.metatype == "google" || file.metatype == "googledrive"){
			return true;
		}

		if (file.name.indexOf("drive.google.com") !== -1 && file.name.indexOf("preview") !== -1){
			return true;
		}
		
		if ($.inArray(ext, ["doc", "docx", "rtf", "xls", "xlsx", "ppt", "pptx", "pdf", "txt", "json", "xml", "db"]) > -1) {
			return true;
		}
		
		return false;
	};
};



function file_local_change(ref, callback){
	var $ref=$(ref);
	var val=$ref.val();
	var $p=$ref.parent();
	
	var filename=getUploadFN(val);
	
	if (!AP.word.fileX(filename,'png jpg jpeg gif bmp psd pdf ai doc docx ppt pptx xls xlsx xlsm txt zip rar log csv txt pps tar')){
		return AP.alertError("Please choose an regular file");
	}
	
	var id=AP.uuid();
	var icon=UI.file.fontIcon(filename);
	
	var file={name: filename, icon: icon, input: $ref, type: "upload"};
	
	callback(file);
};FileX.upload=new function __FileUpload(){
	this.now=function(file, data, callback, error_callback){
		if ($("#instant-file-upload").length){
			$("#instant-file-upload").html("").empty().remove();
		}
		
		var $form=$("<form id='instant-file-upload' action='api/file/upload' class='__temp'></form>");
		$form.appendTo("#ap-temp");
		this.copy(file, $form);
		
		AP.ajaxShow("Uploading ...");
		
		AP.submit($form, function(code){
			AP.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.origin, code.file, code.log);
		}, data);
	};
	
	
	this.copy=function(file, $form){
		file.input.appendTo($form);
		$("#file-upload-input-inv").html("<input type='file' name='file' onchange='file_local_change(this, FileX.localSelect);'/>");
	};
	
	this.txt = function(data, callback, error_callback){
        AP.ajaxShow("Uploading ...");
        
        AP.post("api/file/create.text", data, function(code){
            AP.ajaxHide();
            
            if (!code.good()){
                return AP.alertError(code.message);
            }
            
            callback(code.origin, code.file, code.log);
        });
    };
};FileX.auto=function(canvas, obj, opts){
	var counter="";
	if (obj.stats && obj.stats.files){
		counter="("+obj.stats.files+")";
	}
	
	var html="<span class='button -stroked -rounded'><span class='-ap icon-upload3'></span>&nbsp; Upload</span><h1>Files <small class='file-counter-"+obj.gid+"'>"+counter+"</small></h1> <div class='sep-10'></div> <div class='list list-files -no-border'></div>";
	
	$(canvas).html(html);
	$(canvas).find(" > .button").click(function(){
		FileX.create(obj, function(file, log){
		});
	});
	
	
	AP.post("api/file/load",{hid: obj.hid, token: obj.token}, function(code){
		if (!code.good()){
			$.log("ERROR: File cannot be loaded");
			$.log(obj);
			// return AP.alertError(code.message);
			return;
		}
		
		
		for (var i=0; i<code.files.length; i++){
			var html=getFileHTML(code.files[i]);
			$(html).appendTo($(canvas).find(".list-files")).data("object", code.files[i]).click(function(){
				var obj=$(this).data("object");
				FileX.quickPreview(obj);
			});
		}
		
		
		if (!code.files.length){
			html ="<div class='empty -side'>No file was found in here ...</div>";
			$(canvas).find(".list-files").html(html);
		}
		
	});
	
	
	AP.removeListener("new-file-"+obj.gid);
	
	AP.on("new-file-"+obj.gid, function(file, log, origin){
		$(canvas).find(".list-files").prepend(getFileHTML(file)).data("object", file).click(function(){
			var _obj=$(this).data("object");
			FileX.quickPreview(_obj);
		});
		
		$(".file-counter-"+origin.gid).html("("+origin.stats.files+")");
		$(canvas).find(".empty").hide();
	});
	
	
	function getFileHTML(f){
		var icon=Client.share_url+"/32/file-"+UI.file.icon(f.name)+".png";
		return "<div class='li'><span class='icon -fi'><img src='"+icon+"'></span>" +
				"<div class='text ap-xdot'>"+f.name+"" +
					"<div class='sub'>Created by @<span class=''>"+f.username+"</span> &middot; "+UI.simpleTime(f.since)+"</div>" +
				"</div>" +
			"</div>";
	};
};var N=new function __N(){
	this.api=Base.apiURL()+"api/me/";
	
	
	this.tabID=AP.uuid();
	this.appID=((Client.base && Client.base.app)? Client.base.app :"none"); 
	this.__off=false;
	this.__init=false;
	
	this.off=function(){
		this.__off=true;
	};
	
	this.init=function(){
		if (this.__off || this.__init){
			return;
		}
		
		this.__init=true;
		
		this.ui.init();
		
		setTimeout(function(){
			DN.init();
		});
		
	};
	
	
	this.hideAll=function(){
		N.ui.hide();
		// N.work.hide();
		// Chat.panel.hide();
		// Todo.notis.hide();
	};
	
	
	this.broadcast=function(){
		if ((typeof Client.base !== 'undefined') && (typeof Client.base.app !== 'undefined')){
			Clog.log("appid", this.appID);
			Clog.log("tabid", this.tabID);
			
			$(window).focus(function() {
				Base.__systemActive=1;
				Clog.log("tabid", N.tabID);
				Clog.log("appid", N.appID);
			}).on("blur", function(){
				Base.__systemActive=0;
			});	
		}
	};
};




N.live=new function __NLive(){
	this.init=function(){
		
	};
};



N.ui=new function __NotisUI(){	
	this.last_load=0;
	this.has_new=true;
	this.canvas="#base-notis";
	this.__inited=false;
	
	
	this.init=function(){
		this.has_new=true;
		
//		Client.num_notis=parseInt(Client.num_notis);
//		if (Client.num_notis){
//			show_badge(Client.num_notis);
//		}
	};
	
	
	this.update=function(user){ 
		this.trigger(user);
	};
	
	this.toggle=function(ref){
		if (!$(this.canvas).is(":visible")){
			N.hideAll('notis');
			this.load(ref);
		}else{
			this.hide();
		}
	};
	
	this.show=function(ref){
		this.load(ref);
	};
	
	
	this.trigger=function(user){
		this.has_new=true;
		show_badge(user.num_notis);
		animate_badge();
	};
	
	
	this.load=function(ref){
		if (AP.time.now()-this.last_load>30*60){
			// 30 min waiting
			this.has_new=true;
		}
		
		if (!this.has_new){
			$(this.canvas).show();
			return;
		}
		
		if ($(ref).ajaxOn()){
			return;
		}
		
		
		if (Live.mode=="socket"){
			// Use socket instead of get
			Live.post("notifications.get", {last_update: 0}, function(data){
				// $(ref).ajaxOn();
				if (!data.params){
					return;
				}
				
				N.ui.last_load=AP.time.now();
				N.ui.has_new=false;
				clear_badge();
				
				if (data.params.load_more){
					N.ui.displayAppend(data.rows);
					if (!data.rows.length){
						N.ui.showNoMore();
					}
				}else{
					if (data.rows && data.rows.length){
						N.ui.display(data.rows);
					}else{
						N.ui.showNoMore();
					}
				}
			});
		}else{
			UI.ajaxShow();
			AP.post(N.api+"notification/load",{stoken: Client.base.secureData.token}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				N.ui.last_load=AP.time.now();
				N.ui.has_new=false;
				N.ui.display(code.notifications);
				clear_badge();
			});
		}
	};
	
	
	this.hide=function(){
		$(this.canvas).hide();
	};

	
	this.insert=function(notis){
		var html=get_html(notis);
		var last_update=real_ts(notis.last_update);
		var lsince=0;
		
		if (!AP.time.sameDay(last_update, AP.time.now())){
			var date=AP.time.time('%d%m%Y',last_update);
			
			if (!$("#base-notis-items .js-sep-"+(date)+"").length){
				var dago=Math.floor((AP.time.now()-AP.time.beginOfDay(last_update))/(24*3600));
				ago="<span class='diff'>"+dago+" ngĂ y trÆ°á»›c</span>";
				
				$(this.canvas+"-items").append("<div class='datesep js-sep-"+(date)+"'><span class='d'>"+(AP.i18n.date(last_update))+"</span> "+(ago)+"</div>");	
			}
		}	
		
		
		$(this.canvas+"-items").append(html);
	};
	
	
	this.display=function(notifications){
		$(this.canvas+"-items").html('');
		
		for (var i=0; i<notifications.length; i++){
		   this.insert(notifications[i]);
		}
		
		$(this.canvas).show();
		update_last(notifications);
		this.scrollable();
	};
	
	
	this.displayAppend = function(notifications){
		for (var i=0; i<notifications.length; i++){
			this.insert(notifications[i]);
		}
		
		
		// var html=AP.render(notifications, function(notis,index, total){
		//  return get_html(notis);
		// });
		// $(this.canvas+"-items").html(html);
		$(this.canvas).show();
		update_last(notifications);
		this.scrollable();
	};
	
	
	this.scrollable=function(){
		if (!this.__inited){
			Layout.scrollable(this.canvas+"-scroll");
			this.__inited=true;
		}
	}
		
	
	this.html=function(notis){
		return get_html(notis);
	}
	
	this.loadMore = function() {
		var last_update = $(this.canvas+"-items div.notis:last-child").data('ts');
		
		if (last_update == -1) return;
		
		if (Live.mode=="socket"){
			Live.emit("notifications.get", {stoken: Client.base.secureData.token, last_update: last_update, load_more: 1});
		}else{
			$("#item-notis").ajaxShow();
			AP.post(N.api+"notification/load", {stoken: Client.viewer.stoken, last: last_notis}, function(code){
				$("#item-notis").ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				if (code.notifications.length > 0) {
					N.ui.last_load = AP.time.now();
					N.ui.has_new = false;
					N.ui.displayAppend(code.notifications);
					clear_badge();
				} else {
					N.ui.showNoMore();
				}
				
			});
		}
	};
	
	
	this.showNoMore=function(){
		$(N.ui.canvas + "-items").append("<div class='notis' data-nid='-1' data-ts='-1' style='padding-top: 17px; display: inherit; text-align: center; font-size: 15px;'><em>No more notification</em></div>");
	};
	
	this.markRead=function(id, ref){
		if (!$(ref).hasClass("unread")){
			return;
		}
		
		if (Live.mode=="socket"){
			Live.post("notifications/mark.read", {notis_id: id}, function(data){
				if (data.code && parseInt(data.code)){
					$(ref).removeClass("unread");
				}
			});
		}else{
			AP.post(N.api+"notification/mark.read", {stoken: Client.viewer.stoken, notis_id: id}, function (code) {
				if (!code.good()) {
					AP.alertError(code.message);
				}else {
					$(ref).removeClass("unread");
				}
			});
		}
	};
	
	
	function clear_badge(){
		show_badge(0);
	};
	
	function show_badge(count){
		if (count && count>0){
			$(N.ui.canvas+"-badge").html(count).show();
		}else{
			count=0;
			$(N.ui.canvas+"-badge").hide();
		}
	};
	
	function animate_badge(){
		$(N.ui.canvas+"-badge").animate({fontSize: '15px'}, 400).animate({opacity:1.0}, 1000).animate({fontSize: '11px'}, 400, function(){});
	};
	
	
	function get_html(notis){
		if ($("#base-notis-items .js-notis-"+notis.id).length){
			return "";
		}
		
		var unread=false;
		
		if (parseInt(notis.last_update) > Client.last_seen_notis){
			// unread=true;
		}
		
		if (!parseInt(notis.last_clicked) && AP.time.now()-parseInt(notis.last_update)<60*24*3600){
			unread=true;
		}
		
		if (notis.link){
			var inspect=Base.inspect(notis.link);
			if (inspect.base){
				notis.link=inspect.url;
			}	
		}else{
			notis.link="";
		}
		
		
		if (unread){
			unread=' unread';
		}
		
		
		var app_icon="";
		if (!notis.app){
			var data=notis.data;
			
			if (AP.data.isString(data)){
				data = "";
				try{
					data = JSON.parse(notis.data);
				} catch (e) {
					console.log(e);
				}

			}
			
			if (data && data.__app){
				notis.app=data.__app;
			}
		}
		
		if (notis.app){
			app_icon="<div class='appicon'><img src='"+Client.share_url+"/apps/"+notis.app+".png'/></div>";
		}
		
		var ts=real_ts(notis.last_update);
		
		var items="";
		if (notis.lasts && notis.lasts.length){
			try{
				var lasts=JSON.parse(notis.lasts);
				if (lasts && lasts.length){
					items=AP.render(lasts, function(e, index){
						return "<div class='subitem'> <div class='sname ap-xdot'>"+(e.title)+"</div> <div class='stime' title='"+(AP.i18n.datetime(real_ts(e.since)))+"'>"+(AP.i18n.time(real_ts(e.since)))+"</div> </div>";
					});
					
					if (index>3){
						return "";
					}
				}
			}catch(e){
				
			}
			
		}
		
		var body=((notis.body && notis.body.length)?("<div class='body'>"+UI.clean(notis.body)+"</div>"):"");
		var image = notis.image;
		if (AP.word.prefix(image, Client.share_url)){
		}else{
			if (is_thumb(notis.image)){
				image = notis.image;	
			}else{
				image = AP.xthumb(notis.image);
			}
		}
		
		return "<div class='li url notis "+(unread)+" js-notis-"+(notis.id)+"' data-url='"+(notis.link)+"' data-nid='"+(notis.id)+"' data-ts='"+(ts*1000)+"' onclick='N.ui.hide(); N.ui.markRead("+(notis.id)+", this);' data-since='"+(ts*1000)+"'> <div class='avatar avatar-40 -circled'><div class='image'><img src='"+(image)+"'/></div></div> <div class='text'> <div class='-title'>"+(notis.title)+"</div> "+(body)+" "+(items)+" <div class='info'>"+(AP.i18n.datetime(ts))+"</div> "+(app_icon)+" </div> </div>";
			
	};
	
	
	function real_ts(ts){
		ts=parseInt(ts);
		if (ts<1600000000){
			return ts;
		}
		
		return Math.floor(ts/1000);
	};
	
	function update_last(objs){
		for (var i=0; i<objs.length; i++){
			var since=parseInt(objs[i].since);
			if (since>Client.last_seen_notis){
				Client.last_seen_notis=since;
			}
		}
	};
	
	
	function is_thumb(imgpath){
		if (!imgpath) {
			return false;
		}
		var parts = imgpath.split("/");
		if (parts && parts.length){
			var last = parts[parts.length-1];
			if (AP.word.prefix(last, "0.") || AP.word.prefix(last, "1.") || AP.word.prefix(last, "2.") || AP.word.prefix(last, "3.")){
				return true;
			}
			
			return false;
		}
		
		return false;
	};
};




// Log latest channels




var DN=new function __DN(){
	this.state="unset";
	this.direct=true;
	
	
	if (Client.url && Client.url.indexOf("account.base")!=-1){
		// this.direct=true;	
	}
	
	this.init=function(){
		if (mobile()){
			return;	
		}
		
		$("#fallback-notis").click(function(){
			var options=$(this).data("options");
			if (!options){
				$("#fallback-notis").hide();	
				return;
			}
			
			if (options.url && options.url.length){
				// AP.toURL(options.url);	
			}else if (options.action){
				options.action();
			}else{
				// $.log(options);
			}
			
			$("#fallback-notis").hide();
		});
		
		
		
		 if (!("Notification" in window)){
			 return;
		 }
		 
		 
		 if (!mobile()){
			 if (Notification.permission == "granted"){
			 }else if (Notification.permission == "denied"){
			 }else{
				 if (this.direct){
					 this.showRequestNotification(); 
				 }
			 }
			 
			 if (!this.direct){
				 DN.indirect.init(); 
			 } 
		 }
	};
	
	
	this.show=function(opts){
		if (!opts){
			return;
		}
		
		if (!opts.time){
			opts.time=5000;
		}
		
		if (!opts.tag){
			if (!opts.id){
				opts.tag=AP.time.now();
			}else{
				opts.tag=opts.id;
			}
		}
		
		if (!opts.__state){
			opts.__state=opts.tag;
		}
		
		if (!opts.url){
			opts.url='';
		}
		
		if (!opts.dir){
			opts.dir=null;
		}
		
		var options = {
			body: UI.clean(opts.body),
			icon: opts.icon,
			url: opts.url,
			tag: opts.tag,
			time: opts.time,
			title: opts.title,
			__state: opts.__state,
			__data: opts
	    };
		
		
		if (opts.action){
			options.action=opts.action;
		}
	
		var timer=500;
		var inspect=Base.inspect(opts.url);
		var test_url=opts.url;
		if (inspect.base){
			test_url=inspect.url;
		}
		
		if (AP.word.prefix(test_url, Client.url)){
			timer=0;
		}
		
		setTimeout(function(){
			notificationNow(opts, options);
		}, timer);
	};
	
	
	this.notify = this.show;
	
	this.bip=function(index, key){
		if (key && localStorage){
			var item=localStorage.getItem("sound");
			if (item==key){
				return;
			}
			localStorage.setItem("sound", key);
		}
		
		
		return document.getElementById('audio'+index).play();
		
	};
	
	this.bipDirect = function(index){
		return document.getElementById('audio'+index).play();
	};
	
	
	this.bipInf=function(index, play){
		if (play){
			document.getElementById('audio'+index).play();
			$("#audio"+index).on("ended", function(){
				this.play();
			});	
		}else{
			var s=document.getElementById('audio'+index);
			s.pause();
			s.currentTime = 0;
		}
	};
	
	
	
	this.requestDesktopNotification=function(){
		if (!this.direct){
			return DN.indirect.openRequest();
		}
		
		Notification.requestPermission(function (permission) {
			if (!('permission' in Notification)) {
				Notification.permission = permission;
			}
		  
			if (permission === "granted") {
				// Okay, we are good
				// Get back to direct method
				DN.direct=true;
			}
		});
	};
	
	
	this.showRequestNotification=function(){
		$("#notification-request").show().find(".main").click(function(){
			 if (DN.indirect.request_popup){
				 $("#notification-request").hide();
			 }
			 DN.requestDesktopNotification();
		 });
	};
	
	
	
	function notificationNow(opts, options){
		if (!("Notification" in window) || DN.state=="denied") {
			logNotified(options.__state);
			return fallback(opts, options);
		}
		
		
		if (Base.systemActive()){
			logNotified(options.__state);
			return fallback(opts, options);
		}
		
		if (!options.flatten){
			var inspect=Base.inspect(options.url);
			
			if (inspect.base){
				options.url=inspect.url;
			}
		}
		
		realDesktopNotification(UI.clean(opts.title), options);
	};
	
	
	function realDesktopNotification(title, options){
		if (notified(options.__state)){
			Base.console("SKIP BECAUSE STATE FOUND",options.__state);
			return;
		}
		
		logNotified(options.__state);
		
		if (!DN.direct){
			DN.indirect.notify(title, options);
			return;
		}
		
		    
		// delete options.__data;
		// delete options.__state;
		// delete options.data;
		// options.image=options.icon;
		
		// options.silent=true;
		var notification = new Notification(title, options);

		notification.onclick=function(){
			window.focus();
			if (options.url && options.url.length){
				AP.toURL(options.url);	
			}else if (options.action){
				options.action();
			}else{
				
			}
			
	    	this.close();
		};
		
		notification.onerror=function(e){
		};
		
		notification.onshow=function(e){
		};
		
		notification.onclose=function(){
		};
		
		setTimeout(function(){
		    if (notification){
		    	notification.close();
		    }
		}, 5000);
	};
	
	
	
	function fallback(opts, options){
		var inspect=Base.inspect(options.url);
		if (inspect.base){
			options.url=inspect.url;
		}
		
		if (options.url){
			$("#fallback-notis").addClass("url").data("url", options.url);	
		}else{
			$("#fallback-notis").removeClass("url").data("url", '');
		}
		
		$("#fallback-notis .image").html("<img src='"+options.icon+"'/>");
		$("#fallback-notis .footer").html(UI.simpleTime(options.time));
		$("#fallback-notis .content").html(options.body);
		$("#fallback-notis .title").html(opts.title);
		
		$("#fallback-notis").data("options", options).data("timer", AP.time.now()).show();
		
		fallback_hide();
	};
	
	
	function fallback_hide(){
		setTimeout(function(){
			var timer=parseInt($("#fallback-notis").data("timer"));
			if (AP.time.now() - timer >= 5){
				$("#fallback-notis").hide();
			}else{
				fallback_hide();
			}
		},5500);
	};
	
	
	
	
	function notified(token){
		var ln=Clog.getCookie("__ln");
		if (!ln){
			ln="";
		}
		
		if (ln==token){
			return true;
		}
		
		return false;
	};
	
	
	function logNotified(token){
		Clog.setCookie("__ln", token);
	};
	
};



DN.indirect = new function __DNIndirect(){
	// Request on iframe or on a new windows
	this.request_popup=true;
	
	this.url="http://"+Client.domain;
	
	if (Client.https && parseInt(Client.https)){
		this.url="https://"+Client.domain;	
	}
	
	this.api=this.url+"/notify/";
	this.receiver = null;
	this.events={};
	this.last_clear=0;
	
	this.notify=function(title, options){
		var id=AP.uuid();
		var xopts={
			icon: options.icon,
			body: options.body,
			title: options.title,
			tag: options.tag
		};
		var obj={'title': title, 'options': xopts, __refid: id, __domain: Client.url}
		
		this.logEvent(id, options);
		this.receiver.postMessage(obj, this.url);
	};
	

	this.init=function(){
		if (!$("#idn_iframe").length){
			$("<iframe id='idn_iframe' style='display:none' src='"+this.api+"'/>").appendTo($(document.body));
			this.receiver = document.getElementById('idn_iframe').contentWindow;
		}
		
		window.addEventListener('message', function(e){
			var org=e.origin;
			if (org!=DN.indirect.url){
				return;
			}
			
			var data = e.data;
			
			if (data.event=="notis.perm"){
				return DN.indirect.request(data.p);
			}
			
			if (data.event=="int.perm.result"){
				return DN.indirect.response(data.event.p);
			}
			
			if (!data || data.event!="notis.indirect.click"){
				return;
			}
			
			var event=DN.indirect.getEvent(data.refid);
			if (!event){
				return;
			}
			
			var options=event.options;
			
			if (options.url && options.url.length){
				AP.toURL(options.url);	
			}else if (options.action){
				options.action();
			}else{
			}
		});
	};
	
	
	this.internalEvent=function(event, data){
		this.receiver.postMessage({
			'event': event,
			'data': data
		}, this.url);
	};
	
	
	this.getEvent=function(id){
		if (this.events[id]){
			return this.events[id];
		}
		
		return null;
	};
	
	
	this.logEvent=function(id, options){
		var limit=4;
		var now=AP.time.now();
		this.events[id]={time: now, options: options};
		
		if (now - this.last_clear>limit){
			this.last_clear=now;
			for (var key in this.events){
				if (now - this.events[key].time > limit){
					delete this.events[key];
				}
			}
		};
	};
	
	
	
	this.request = function(current){
		if (current=="denied"){
			DN.state="denied";
			
			checkIncognito(function(){
				$.log("INCOGNITO MODE!!!");
			}, function(){
				DN.showRequestNotification();
			});
		}
		
		if (current=="pending"){
			DN.showRequestNotification();
		};
		
		if (current=="granted"){
			// 
			$.log("Desktop notification is granted ...");
			DN.direct=true;
		};
	};
	
	
	this.openRequest=function(){
		if (this.request_popup){
			this.openRequestPopup();		
		}else{
			this.internalEvent("int.perm.request");
		}
	};
	
	
	this.openRequestPopup=function(){
		Clog.log("npe", 0);
		window.open(this.api+"?request=1");
		
//		var intv=setInterval(function(){
//			var n=Clog.getLog("npe");
//			if (n==1 || n=="1"){
//				return AP.refresh();
//			}
//		},500);
	};
	
	
	this.response=function(p){
		AP.refresh();
	};
	
	
	function checkIncognito(incog, notincog){
		var fs = window.RequestFileSystem || window.webkitRequestFileSystem;
		if (!fs){
			return false;
		}else{
			fs(window.TEMPORARY,100, function(){
				notincog();
			},function(){
				incog();
			});
		}
	};
};


N.reminder=new function __NReminder(){
	this.get=function(){
		
	};
	
	this.render=function(list){
		
	};
};


N.live=new function __NLive(){
	this.init=function(){
		
	};
};



N.on = function(event, fn){
	return N.events.bind(event, fn);
};


N.events = new function __NEvents(){
	var fns = {};
	
	this.bind = function(event, fn){
		fns[safe(event)] = fn;
	};
	
	this.get = function(event){
		return fns[safe(event)]; 
	};
};


N.broadcast();

var Reminder=new function __Reminder(){
	this.__inited=false;
	this.__state=AP.uuid();
	
	this.init=function(){
		if (mobile()){
			return;
		}
		
		prepare();
		scheduleAlert();
		
		this.api("meaningful", {}, function(rows, code){
			Reminder.ui.list(rows);
		});
	};
	
	
	/**
	 * @desc API endpoint
	 */
	this.api=function(endpoint, data, callback){
		data._rstate=Reminder.__state;
		data._endpoint=endpoint;
		
		Live.post("reminders."+endpoint, data, function(code){
			code.rows=AP.array.sortObj(code.rows, "time");
			for (var i=0; i<code.rows.length; i++){
				try {
					code.rows[i].data=JSON.parse(code.rows[i].data);
			    } catch(e) {
			        code.rows[i].data={};
			    }
			}
			
			return callback(code.rows, code);
		}, true);
	};
	
	
	/**
	 * @desc Loading tab
	 */
	this.loadTab=function(tab){
		if (tab=="today"){
			this.api("today", {}, function(rows, code){
				$("#reminder-items .tab-today .ritems").html(AP.render(rows, function(e){
					return Reminder.ui.getHTML(e);
				}));
			});
		}else if (tab=="late"){
			this.api("late", {}, function(rows, code){
				$("#reminder-items .tab-late .ritems").html(AP.render(rows, function(e){
					return Reminder.ui.getHTML(e);
				}));
			});
		}
	};
	
	
	this.insert=function(reminder){
		return Reminder.ui.insert(reminder);
	};
	
	
	this.remove=function(reminder){
		return Reminder.ui.remove(reminder);
	};
	
	
	/**
	 * @desc Check if a calendar is ever meaningful
	 */
	this.meaningful=function(e){
		var state=parseInt(e.state);
		var alert=parseInt(e.alert);
		var now=AP.time.now();
		var deadline=parseInt(e.time);
		var offset=7;

		var w_s = AP.time.beginOfDay(now - offset * 24 * 3600);
		var w_e = AP.time.beginOfDay(now + offset * 24 * 3600) + 86399; // end of day, 1 week later
		if (deadline > w_e || deadline < w_s) {
			return 0;
		}
			
		
		if (state==1){ // ALREADY HANDLE
			return 0;
		}
		
		if (state==0){ // NO STATE
			if (deadline>=now){
				return 1;
			}else{
				return 0;
			}
		}
		
		if (state==-1){ // PENDING
			if (deadline>=now -offset *24*3600){
				return 1;
			}
			
			return 0;
		}
		
		return 0;
	};
	
	
	
	function prepare(opts){
		if (mobile()){
			return;
		}
		
		if (Reminder.__inited){
			return true;
		}
		
		Reminder.__inited=true;

		opts = $.extend({}, opts, {display: "notification"});

		Reminder.ui.initCanvas(opts);
		bindEvents();
	};
	
	
	
	function scheduleAlert(){
		setInterval(function(){
			Reminder.alarm.check();
		}, 2000);
	};
	
	
	
	function bindEvents(){
		Live.on("reminder", function(e){
			Reminder.insert(e);
		});
		
		Live.on("server.reminder.remove", function(e){
			Reminder.remove(e);
		});
	};
	
};



Reminder.ui=new function __ReminderUI(){
	this.rows=[];
	this.counter=0;
	
	/**
	 * @desc Show a list of reminders
	 */
	this.list=function(rows){
		rows=AP.array.uniqueObjects(rows);
		
		rows=AP.array.filter(rows, function(e){
			return Reminder.meaningful(e);
		});
		
		rows=AP.array.sortObj(rows, "time");
		rows=AP.array.cut(rows, 200);
		
		for (var i=0; i<rows.length; i++){
			rows[i].r0=0;
			rows[i].r30=0;
			rows[i].r60=0;
		}
		
		this.rows=rows;
		
		var total=0;
		sections={
			"today": "",
			"late": "",
			"upcoming": "",
			"other": ""
		};
		
		var counters={
			"today": 0,
			"late": 0,
			"upcoming": 0,
			"other": 0
		};
		
		for (var i=0; i<rows.length; i++){
			var meaningful=Reminder.meaningful(rows[i]);
			
			total+=meaningful;
			var section=getSection(rows[i]);
			counters[section]++;
			
			if (section=="upcoming"){
				sections[section]=Reminder.ui.getHTML(rows[i])+sections[section];	
			}else{
				sections[section]+=Reminder.ui.getHTML(rows[i]);
			}
		}
		
		var html="";
		if (sections.today.length){
			html+="<div class='section-title'>HĂ´m nay <span class='count'>"+(counters.today)+"</span></div><div class='section-body'>"+(sections.today)+"</div>";
		}
		
		if (sections.late.length){
			html+="<div class='section-title'>Muá»™n <span class='count'>"+(counters.late)+"</span></div><div class='section-body'>"+(sections.late)+"</div>";
		}
		
		if (sections.upcoming.length){
			html+="<div class='section-title'>Sáº¯p tá»›i <span class='count'>"+(counters.upcoming)+"</span></div><div class='section-body'>"+(sections.upcoming)+"</div>";
		}
		
		if (sections.other.length){
			html+="<div class='section-title'>KhĂ¡c <span class='count'>"+(counters.other)+"</span></div><div class='section-body'>"+(sections.other)+"</div>";
		}
		
		$("#reminder-items .tab-meaningful .ritems").html(html);
		
		setCounter(total);
	};

	
	
	
	this.remove=function(reminder){
		$("#reminder-items .js-reminder-"+reminder.id).remove();
		$("#reminder-calendar .js-reminder-"+reminder.id).remove();
		
		this.rows=AP.array.removeByID(this.rows, reminder.id);
		this.list(this.rows);
	};
	
	this.insert=function(reminder){
		this.rows.unshift(reminder);		
		this.list(this.rows);
	};
	
	
	this.getHTML=function(e){
		var appicon="";
		if (e.data.app && e.data.app){
			appicon="<div class='appicon'><img src='"+(Client.share_url)+"/apps/"+(e.data.app)+".png'/></div>";
		}
		
		var overdue=0;
		if (parseInt(e.state)==-1 && parseInt(e.time)<AP.time.now()){
			overdue=1;
		}
		
		return "<div class='item meaningful-"+(Reminder.meaningful(e))+" overdue-"+(overdue)+" state-"+(e.state)+" alert-"+(e.alert)+" js-reminder-"+(e.id)+"' data-deadline='"+(AP.i18n.datetime(e.time))+"' title='"+(e.name)+"'> <div class='dot'></div> <div class='name'>"+(e.name)+"</div> <div class='info'><span class='time'>"+(AP.i18n.datetime(e.time))+"</span> <span class='hidden'>&middot; QuĂ¡ háº¡n</span></div> <div class='trigger'>"+(appicon)+"<span class='-ap icon-keyboard_arrow_right'></span></div> <div class='alert'></div> <div class='actions'> <span class='action -ignored' title='Ignore this reminder' onclick='Reminder.action.ignore("+(e.id)+")'>Bá» qua</span> </div> <div class='mask url' data-url='"+(e.link)+"' ></div> </div>";
	};
	
	
	
	this.initCanvas=function(opts){
		var icon = "<div class='icon'> <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 1 C 10.696 1 9.5965937 1.837 9.1835938 3 L 5 3 C 3.895 3 3 3.895 3 5 L 3 19 C 3 20.105 3.895 21 5 21 L 19 21 C 20.105 21 21 20.105 21 19 L 21 5 C 21 3.895 20.105 3 19 3 L 14.816406 3 C 14.403406 1.837 13.304 1 12 1 z M 12 3 C 12.552 3 13 3.448 13 4 C 13 4.552 12.552 5 12 5 L 19 5 L 19 19 L 5 19 L 5 5 L 12 5 C 11.448 5 11 4.552 11 4 C 11 3.448 11.448 3 12 3 z M 15.292969 8.2929688 L 11 12.585938 L 8.7070312 10.292969 L 7.2929688 11.707031 L 11 15.414062 L 16.707031 9.7070312 L 15.292969 8.2929688 z'/></svg> </div>";
		var extra_footer = '';
		if (opts.icon && opts.extra_footer) {
			icon = opts.icon;
			extra_footer = opts.extra_footer;
		}
		var html="<div id='reminder-canvas-wrapper'> <div id='reminder-button' title='Nháº¯c viá»‡c hĂ´m nay cá»§a báº¡n'> <div id='reminder-round'></div> "+(icon)+" <div class='count'></div> </div> <div id='reminder-canvas'> <div class='reminder-header'> <div class='reminder-close' title='ÄĂ³ng nháº¯c viá»‡c'><span class='-ap icon-close'></span></div> <div class='title'>Nháº¯c viá»‡c</div> <div class='tabs clear-fix'> <div class='tab active' data-tab='meaningful'><span class='icon ficon-bell'></span> Quan trá»ng</div> <div class='tab' data-tab='today'><span class='icon ficon-circle-o'></span> HĂ´m nay</div> <div class='tab' data-tab='late'><span class='icon ficon-exclamation-circle'></span> Muá»™n</div> </div> </div> <div class='reminder-body scroll-y'> <div id='reminder-items'> <div class='tab tab-meaningful' data-tab='meaningful'> <div class='notice'>Má»™t sá»‘ Ä‘iá»u báº¡n cáº§n chĂº Ă½ <div class='count'></div> </div> <div class='ritems only-meaningful'></div> </div> <div class='tab tab-today' data-tab='today'> <div class='ritems'></div> </div> <div class='tab tab-late' data-tab='late'> <div class='ritems'></div> </div> </div> </div> "+(extra_footer)+" <div class='reminder-footer' onclick='Reminder.calendar.display();'> <span class='icon ficon-external-link-square'></span> &nbsp; Má»Ÿ lá»‹ch biá»ƒu </div> </div> </div> "+(Reminder.calendar.getCanvas())+"";
		
		$("#base-notis").after(html);
		
		
		$("#reminder-button").click(function(){
			$("#reminder-canvas-wrapper").toggleClass("active");
		});
		
		$("#reminder-canvas .reminder-header .reminder-close").click(function(){
			$("#reminder-canvas-wrapper").removeClass("active");
		});
		
		UI.tabView("#reminder-canvas .reminder-header .tabs .tab", "#reminder-canvas .reminder-body .tab", function(tab){
			Reminder.loadTab(tab);
		});
		
		
		AP.html.resize(function(){
			$("#reminder-canvas").height($(window).height()-130);
		}, true);
		
		
		$("#reminder-calendar .header .tab").click(function(){
			var tab=$(this).data("tab");
			
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			
			if (tab=="meaningful"){
				$("#reminder-calendar").addClass("meaningful");
			}else{
				$("#reminder-calendar").removeClass("meaningful");
			}
		});
		
		if (Client.base && Client.base.app){
			var app=Client.base.app;
			if (app=="sysadmin"){
				$("#reminder-button").css({left: 20});
				$("#reminder-canvas").css({left: 2});
			}
		}
	};
	
	
	function setCounter(total){
		if (total){
			$("#reminder-button .count").html(total).show().addClass("hl");
			$("#reminder-items .notice .count").html("<em>"+total+"</em>")
			$("#reminder-items .notice").show();
			
			setTimeout(function(){
				$("#reminder-button .count").removeClass("hl");	
			},2000)
		}else{
			$("#reminder-button .count").hide();
			$("#reminder-items .notice").hide();
		}
	};
	
	
	function getHTML(r){
		
	};
	
	
	function getSection(e){
		var now=AP.time.now();
		var time=parseInt(e.time);
		if (AP.time.sameDay(time, now)){
			return "today";
		}
		
		if (time < now){
			if (e.state==-1){
				return "late";
			}
		}
		
		if (time > now){
			return "upcoming";
		}
		
		return "other";
	};
	
	
	function showSections(sections){
		
	};
};


Reminder.calendar=new function __ReminderCalendar(){
	this.ts=AP.time.now();
	this.__inited=false;
	
	this.show=function(ts){
		this.ts=parseInt(ts);
		
		initLayout(this.ts);
		loadReminders(this.ts);
	};

	this.today=function(){
		this.show(AP.time.now());
	};
	
	this.prev=function(){
		this.ts=this.ts-7*24*3600;
		this.show(this.ts);
	};
	
	this.next=function(){
		this.ts=this.ts+7*24*3600;
		this.show(this.ts);
	};
	
	this.display=function(){
		if (!this.__inited){
			this.__inited=true;
			this.show(AP.time.now());
		}
		
		$("#reminder-calendar-wrappers").show();
	};
	
	this.hide=function(){
		$("#reminder-calendar-wrappers").hide();
	};
	
	this.getCanvas=function(){
		var days="";
		for (var i=0; i<7; i++){
			days+="<div class='day js-day day-"+(i)+"'> <div class='dheader'></div> <div class='dbody'> <div class='dgrid'></div> <div class='ditems ditems-am'></div> <div class='ditems ditems-pm'></div> </div> </div>";
		};
		
		return "<div id='reminder-calendar-wrappers'> <div id='reminder-calendar'> <div class='header'> <div class='icon'><span class='-ap icon-calendar5'></span></div> <div class='title'><span title='Back to today' onclick='Reminder.calendar.today();'>"+(Client.viewer.name)+"</span></div> <div class='tabs'> <div class='tab active' data-tab=''>Everything</div> <div class='tab' data-tab='meaningful'>Only important</div> </div> <div class='side'> <div class='item nav' onclick='Reminder.calendar.prev();'><span class='-ap icon-keyboard_arrow_left'></span></div> <div class='item nav' onclick='Reminder.calendar.next();'><span class='-ap icon-keyboard_arrow_right'></span></div> <div class='item'>Week of <em></em></div> </div> <div class='close js-close' onclick='Reminder.calendar.hide();'><span class='-ap icon-close'></span></div> </div> <div class='body'>"+(days)+"</div> </div> </div>";
	};
	
	
	function initLayout(ts){
		$("#reminder-calendar .header em").html(AP.i18n.date(ts));
		
		
		$("#reminder-calendar .ditems").empty();
		$("#reminder-calendar .dheader").empty();
		$("#reminder-calendar .day").removeClass("today");
		
		
		var ft=AP.time.beginOfWeek(ts);
		var today=AP.time.beginOfDay();
		
		for (var i=0; i<7; i++){
			var d=ft+i*24*3600;
			
			var html="<div class='w'>"+(AP.time.tvDays[i])+"</div> <div class='d'>"+(AP.time.time('%d',d))+"</div>";
			$("#reminder-calendar .day-"+(i)+" .dheader").html(html);
			
			if (today==d){
				$("#reminder-calendar .day-"+(i)+"").addClass("today");
			}
		}
		
	};
	
	
	function showReminder(e){
		var html=getHTML(e);
		var dow=AP.time.time("%w",e.time);
		var apm=AP.time.time("%a",e.time);
		
		$("#reminder-calendar .day-"+dow+" .ditems-"+apm+"").append(html);
	};
	
	
	function getHTML(e){
		return "<div class='item meaningful-"+(Reminder.meaningful(e))+" state-"+(e.state)+" alert-"+(e.alert)+" url js-reminder-"+(e.id)+"' data-url='"+(e.link)+"' title='"+(stringSafe(e.name))+" - "+(AP.i18n.datetime(e.time))+"'> <div class='c'></div> <div class='name'>"+(e.name)+"</div> <div class='time'>"+(AP.time.time('%H:%i',e.time))+"</div> </div>";
	};
	
	function stringSafe(str){
		return str.replace(/'/g,'');
	};
	
	function loadReminders(ts){
		Reminder.api("week", {ts: ts}, function(reminders){
			reminders=AP.array.usort(reminders, function(e, f){
				return parseInt(e.time)-parseInt(f.time);
			});
			
			for (var i=0; i<reminders.length; i++){
				showReminder(reminders[i]);	
			}
			
			$.log("Finish rendering ... "+reminders.length);
		});
	};
	
};


Reminder.action=new function __ReminderAction(){
	
	/**
	 * @desc Remove a reminder by ID
	 */
	this.remove=function(id){
		AP.confirm("XĂ³a nháº¯c viá»‡c nĂ y?", function(){
			Live.post("reminders.remove", {id: id}, function(code){
				Reminder.ui.remove({id: id});
			});
		});
	};
	
	
	/**
	 * @des Alias of remove
	 */
	this.ignore=function(id){
		return this.remove(id);
	};


	this.lookbackVideo = function() {
		if (!Client.lookback_video_src) {
			// return false;
		}

		var video_src = Client.lookback_video_src;
		// video_src = 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';

		var header = "<div class='bl-header'> <div class='bl-title inline' onclick='AP.dialog.close(this)'></div> <div class='right bl-close' onclick='AP.dialog.close(this)'><span class='-ap icon-ion-android-close'></span></div> </div>";
		var html=""+(header)+" <div class='base-lookback-video-wrapper' style='min-height:400px'> <div id='js-lookback-video-frame' class='lookback-video-frame'> <div class='video center'> <video width='960' height='540' controls autoplay> <source src='"+(video_src)+"' type='video/mp4'> Your browser does not support the video tag. </video> </div> </div> <div class='video-btn'> <div class='btn-wrapper'> <div class='download'> <a class='cta' href='"+(video_src)+"' target='_blank' download>Download</a> </div> </div> </div> </div>";
		AP.customDialog(html, "lookback-video-dx").width(960).style("-full").closable(true).show();
	};
};


Reminder.alarm=new function __ReminderAlarm(){
	this.check=function(){
		for (var i=0; i<Reminder.ui.rows.length; i++){
			var e=Reminder.ui.rows[i];
			var al=getAlarm(e);
			if (al && al.length){
				if (al =="soon"){
					notify(e, "DUE: ");
				}
				
				if (al=="r60"){
					notify(e, "DUE IN 01 HOUR: ");
				}
			}
		}
	};
	
	
	function notify(e, prefix){
		var icon=Client.share_url+"/apps/base.png";
		if (e.data && e.data.app){
			icon=Client.share_url+"/apps/"+e.data.app+".png";	
		}
		
		var obj={
			url: e.link,
			tag: e.hid+"."+e.time,
			title: prefix+e.name,
			body: AP.i18n.date(e.time),
			time: 10000,
			icon: icon
		};
		
		DN.show(obj);
	};
	
	
	function getAlarm(e){
		var now=AP.time.now();
		var diff=parseInt(e.time)-now;
		
		if (!AP.time.sameDay(e.time, now)){
			return "";
		}
		
		if (diff<0){
			return "";
		}
		
		if (diff<10 && !e.r0){
			e.r0=1;
			return "now";
		}
		
		
		if (diff<30*60 && diff > 30*60-30){
			if (!e.r30){
				e.r30=1;
				return "r30";	
			}
			
			return "";
		}
		
		
		if (diff<60*60 && diff > 60*60-30){
			if (!e.r60){
				e.r60=1;
				return "r60";	
			}
		}
		
		return "";
	};
};
Base.task=new function __BaseTask(){
	this.cached_projects = null;
	
	this.endpoint=function(ep){
		return Base.domain("wework")+"/ajax/api/v2/"+ep;
	};
	
	this.enabled=function(){
		if (!hasApp("wework")){
			return false;
		}
		
		return true;
	};
	
	this.embed=function(obj, opts){
		if (!hasApp("wework")){
			return;
		}
		
		if (!$(opts.canvas).length){
			return;
		}
		
		$(opts.canvas).data("origin", obj);
		
		var header=getHeader(obj, opts);
		var form=getForm(obj, opts);
		
		
		$(opts.canvas).addClass("js-etask-wrapper etask-wrapper").html(header+form+"<div class='js-subtasks-list etasklist'></div>");
		showTasks(obj, opts);
		
		Form.render($(opts.canvas).find(".etaskform"));
		
		$(opts.canvas).find("input.js-subtask-ip").enter(function(){
			createTaskInline(this);
		}).on("focus", function(){
			$(this).closest(".etaskform").addClass("active");
		}).on("blur", function(){
			$(this).closest(".etaskform").removeClass("active");
		});
		
		$(opts.canvas).find(".esubmit").click(function(){
			createTaskInline($(this).parent().find(".minput"));
		});
		
		$(opts.canvas).find(".ef-button.-cta").click(function(){
			createTaskInline($(this).closest(".etaskform").find(".minput"));
		});
		
		
		$(opts.canvas).find(".ef-button.-cancel").click(function(){
			$(this).closest(".etaskform").removeClass("activated");
		});
		
		$(opts.canvas).find("select[name=project_id]").on("change", function(){
			if (!Base.task.cached_projects){
				return;
			}
			
			var val = $(this).val();
			var project = ARR.findObj(Base.task.cached_projects, val);
			
			if (!project){
				var tasklists = "<option value='0'>- Chá»n nhĂ³m CV -</option> "+(tasklists)+"";
				$(this).closest(".etaskform").find("select[name=tasklist_id]").html(tasklists);
				return;
			}
			
			var tasklists = AP.render(project.cached_tasklists, function(e){
				return "<option value='"+(e.id)+"'>"+(e.name)+"</option>";
			});
			
			tasklists = "<option value='0'>- Chá»n nhĂ³m CV -</option> "+(tasklists)+"";
			
			$(this).closest(".etaskform").find("select[name=tasklist_id]").html(tasklists);
		});
		
		
		if (Client.base && Client.base.app=="wework"){
			
		}else{
			if (this.cached_projects){
				setProjects($(opts.canvas).find(".etaskform"), this.cached_projects);
			}
		}
		
		
		
		if (Client.base && Client.base.app=="wework"){
			$(opts.canvas).find(".js-subtasks-list").sortable({
				items: ".etask-detail",
				handle: ".icon-base-sorter",
				axis: "y",
				stop: function(event, ui){
					var id=$(ui.item).data("id");
					var pid=$(ui.item).data("pid");
					var pos=$(ui.item).index();
					
					reorder(id, pos, pid);
				}
			});
		}
	};
	
	
	this._check=function(ref){
		var $box=$(ref).closest(".etask-detail");
		if (!$box.hasClass("is-checkable")){
			return;
		}
		
		var set_status="check";
		if ($box.hasClass("status-1")){
			set_status="uncheck";
		}
		
		var data={id: $(ref).data("id"), "action": set_status};
		
		if (set_status == 'uncheck') {
			AP.confirm("Báº¡n cĂ³ muá»‘n bá» hoĂ n thĂ nh cĂ´ng viá»‡c nĂ y?", function () {
				UI.ajaxShow();
				AP.post(Base.domain("wework")+"/ajax/api/task/check", data, function(code){
					UI.ajaxHide();
					
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					insertTaskAtTop(code.task, $(ref).closest(".js-etask-wrapper"));
					
					AP.sys.fire("subtask.updated", code.task);
				});
			});
		} else {
			UI.ajaxShow();
			AP.post(Base.domain("wework")+"/ajax/api/task/check", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				insertTaskAtTop(code.task, $(ref).closest(".js-etask-wrapper"));
				
				AP.sys.fire("subtask.updated", code.task);
			});
		}
	};
	
	
	this._showID=function(id, token, view_token){
		if (Client.base && Client.base.app=="wework"){
			TaskDisplay.display(id);
			return;
		}
		
		window.open(Base.domain("wework")+"/tasks?task="+id+"&task_token="+token+"&view_token="+view_token);
	};
	
	
	this.exportHTML=function(task){
		return getHTML(task);
	};
	
	
	/**
	 * @desc Initialize the task's project lists
	 */
	this._initialize = function(ref){
		if (Client.base && Client.base.app=="wework"){
			$(ref).closest(".etaskform").addClass("activated");
			$(ref).closest(".etaskform").addClass("-wework").find(".extra-data.-last").remove();
			return;
		}
		
		
		if (this.cached_projects){
			$(ref).closest(".etaskform").addClass("activated");
			$(ref).closest(".etaskform").find("*[name=name]").focus();
			return;
		}
		
		var $elem = $(ref).closest(".etaskform").find(".rf");
		$elem.ajaxShow();
		
		AP.post(Base.domain("wework")+"/ajax/api/v2/projects", {}, function(code){
			$elem.ajaxHide();
			$(ref).closest(".etaskform").addClass("activated");
			setProjects(ref, code.projects);
			$(ref).closest(".etaskform").find("*[name=name]").focus();
			
		});
	};
	
	
	function hasApp(key){
		for (var i=0; i<Client.applist.length; i++){
			if (Client.applist[i].key==key){
				return true;
			}
		}
		
		return false;
	};
	
	
	function getHeader(obj, opts){
		if (!opts.header){
			return "";
		}
		
		return "<div class='etask-header'>"+opts.header+"</div>";
	};
	
	
	function getForm(obj, opts){
		if (!obj.signed_token){
			obj.signed_token="";
		}
		
		if (!obj.abs_link){
			obj.abs_link="";
		}
		
		if (!opts.project_id){
			opts.project_id=0;
		}
		
		var ph = "Táº¡o cĂ´ng viá»‡c, nháº­p @ Ä‘á»ƒ gáº¯n tháº» vĂ  giao viá»‡c, nháº¥n enter Ä‘á»ƒ lÆ°u";
		var last_data = "<div class='extra-data -last "+(mobile()?'-mobile':'')+"'> <div class='elem'><span class='icon ficon-folder-o'></span> <span class='elabel'>Dá»± Ă¡n:</span> <div class='eselect'> <select name='project_id'></select> </div> </div> <div class='elem'><span class='icon ficon-bookmark-o'></span> <span class='elabel'>NhĂ³m cĂ´ng  viá»‡c:</span> <div class='eselect'> <select name='tasklist_id'></select> </div> </div> <div class='elem last'><span class='icon ficon-user-o'></span><input type='text' name='followers' data-role='tag' data-context='global' placeholder='Chá»n ngÆ°á»i theo dĂµi'/></div> </div>";
		
		var hidden_ip = '';
		
		if (Client.base && Client.base.app=="wework"){
			ph = "Táº¡o cĂ´ng viá»‡c con, nháº­p @ Ä‘á»ƒ gáº¯n tháº» vĂ  giao viá»‡c, nháº¥n enter Ä‘á»ƒ lÆ°u";
			hidden_ip = "<input type='hidden' name='project_id' value='"+(opts.project_id)+"'/>";
			last_data = '';
		}

		var tracking_task_created = "data-feature='wework:wework_task_created:task'";
		if (Client.base.app == "wework") {
			tracking_task_created = "data-feature='wework:wework_subtask_created:task'";
		}
		
		var html="<div class='etaskform'> <div class='rf' onclick='Base.task._initialize(this);'> <div class='textarea ap-xdot'>"+(ph)+"</div> </div> <div class='r'> <div class='einput js-container'> <div class='hidden'> "+(hidden_ip)+" <input type='hidden' name='origin_hid' value='"+(obj.hid)+"'/> <input type='hidden' name='origin_token' value='"+(obj.token)+"'/> <input type='hidden' name='origin_signed_token' value='"+(obj.signed_token)+"'/> <input type='hidden' name='origin_abs_link' value='"+(obj.abs_link)+"'/> <input type='hidden' name='origin_name' value='"+(obj.name)+"'/> </div> <div class='minput'> <input class='js-subtask-ip' data-role='tag' data-context='global' type='text' name='name' autocomplete='off' placeholder='"+(ph)+"'/> </div> <div class='extra-data'> <div class='elem'><span class='icon ficon-user-circle'></span><input type='text' name='assign' data-role='tag' data-context='global' placeholder='GĂ¡n @ Ä‘á»ƒ giao viá»‡c'/></div> <div class='elem'><span class='icon ficon-calendar-o'></span><input type='text' data-role='date' name='deadline' placeholder='Thá»i háº¡n ngĂ y (khĂ´ng báº¯t buá»™c)'/></div> <div class='elem last'><span class='icon ficon-clock-o'></span><input type='text' name='deadline-time' date-time='none' placeholder='Thá»i gian (hh:mm, khĂ´ng báº¯t buá»™c)'/></div> </div> "+(last_data)+" <div class='extra-footer'> <div class='ef-button -cta url' "+(tracking_task_created)+">Táº¡o</div> <div class='ef-button -cancel'>Há»§y</div> </div> </div> <div class='esubmit url' "+(tracking_task_created)+"><img src='"+(Client.share_url)+"/send.svg'/></div> </div>";
		
		return html;
	};
	
	
	
	function setProjects(ref, projects){
		Base.task.cached_projects = projects;
		
		var $canvas= $(ref).closest(".etaskform");
		var html = AP.render(projects, function(e){
			return "<option value='"+(e.id)+"'>"+(e.name)+"</option>";
		});
		
		html = "<option value='0'> - Chá»n dá»± Ă¡n -</option> "+(html)+"";
		
		$canvas.find("select[name=project_id]").html(html).trigger("change");
		
		Form.improveSelect($canvas.find("select[name=project_id]"), {
			with_empty: 0
		});
	};
	
	
	
	
	function showTasks(obj, opts){
		if (Client.tempData && Client.tempData.subtasks){
			for (var i=Client.tempData.subtasks.length-1; i>=0; i--){
				insertTaskAtTop(Client.tempData.subtasks[i], opts.canvas);
			}
			return;
		}
		
		
		AP.post(Base.task.endpoint("load"),{origin_id: obj.id, origin_type: obj.type, origin_hid: obj.hid, origin_token: obj.token, origin_signed_token: obj.signed_token}, function(code){
			if (!code.good()){
				console.log(code);
				return;
			}
			
			for (var i=code.tasks.length-1; i>=0; i--){
				insertTaskAtTop(code.tasks[i], opts.canvas);
			}
		});
		
		return "";
	};
	
	
	function createTaskInline(ref){
		var $c=$(ref).closest(".js-container");
		var data=assoc($c.find(":input").serializeArray());
		if (!data.name){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Base.task.endpoint("create"), data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			insertTaskAtTop(code.task, $(ref).closest(".js-etask-wrapper"));
			$c.find(".js-subtask-ip").val("").focus();
			
			AP.sys.fire("subtask.created", code.task);
		});
	};
	
	
	function insertTaskAtTop(task, canvas){
		var origin=$(canvas).closest(".js-etask-wrapper").data("origin");
		
		var html=getHTML(task, origin);
		if ($(canvas).find(".js-subtasks-list .etask-"+task.id).length){
			$(canvas).find(".js-subtasks-list .etask-"+task.id).replaceWith(html);
		}else{
			$(canvas).find(".js-subtasks-list").prepend(html);	
		}
	};
	
	
	
	
	function getHTML(task, origin){
		if (!origin){
			origin={};
		}
		
		var assign="<div class='no-assign'>ChÆ°a giao</div>";
		var u=People.get(task.user_id);
		if (u && parseInt(u.id)){
			assign="<div class='etask-user'><img src='"+(AP.xthumb(u.gavatar))+"'/> <span>"+(u.first_name)+"</span></div>";
		}
		
		var status_checkable="is-checkable";
		if (!parseInt(task.acl.status)){
			status_checkable="is-uncheckable";
		}
		
		var deadline=getDeadline(task);

		var tracking_task_check = '';
		if (!parseInt(task.status)) {
			tracking_task_check = "data-feature='wework:wework_task_check:task'";
		}
		
		var html="<div class='etask-detail etask-"+(task.id)+" js-inline-subtask-"+(task.id)+" "+(status_checkable)+" status-"+(task.status)+"' data-status='"+(task.status)+"' data-id='"+(task.id)+"' data-pid='"+(task.parent_id)+"'> <div class='icon-base-sorter' style='left:-16px; top:14px;'></div> <div class='echeckbox url' "+(tracking_task_check)+" data-id='"+(task.id)+"' onclick='Base.task._check(this);'></div> <div class='etask-name url' data-feature='wework:wework_task_show:task' onclick='Base.task._showID("+(task.id)+",\""+(task.token)+"\",\""+(origin.viewed_token)+"\")'>"+(task.name)+"</div> <div class='etask-deadline'>"+(deadline)+"</div> "+(assign)+" </div>";
		
		return html;
	};
	
	
	
	function getDeadline(task){
		if (!task.deadline || !parseInt(task.deadline)){
			return "";
		}
		
		if (task.deadline_has_time){
			return "<span title='Deadline'>"+AP.i18n.datetime(task.deadline)+"</span>";
		}else{
			return "<span title='Deadline'>"+AP.i18n.date(task.deadline)+"</span>";
		}
	};
	
	
	
	function reorder(id, pos, pid){
		if (!pid || !parseInt(pid)){
			return;
		}
		
		UI.ajaxShow();
		AP.post("api/task/subtask.reorder", {id: id, position: pos, parent_id: pid}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully");
		});
	};
	
};







Base.esign = new function __BaseESign(){
	
	this.proposeFile = function(opts){
		return Base.esign.proposer.file(opts);
	}
	
};


Base.esign.proposer = new function __BEProposer(){
	
	/**
	 * @desc Propose a file to sign
	 */
	this.file = function(opts){
		if (!opts){
			return $.error("esign invalid opts");
		}
		
		if (!opts.data){
			opts.data = {};
		}
		
		$.log(opts);
		
		if (!opts.file){
			return $.error("esign invalid opts (2)");
		}
		
		var rows = [
			{label: "File to sign", value: opts.file.name, type: "fake"},
			{label: "Signers", name: "signers", type: "textarea", role: "tag"}
		];
		
		Form.v2({
			title: "Propose file to e-sign",
			action: opts.action || "api/esign/propose",
			rows: rows,
			data: opts.data,
			buttons: Form.button(":submit").button(":cancel")
		})
		
	};
	
};
Base.drive=new function __Drive(){
	this.__inited=false;
	this.token="";
	this.callback=null;
	
	
	this.init=function(){
		if (this.__inited){
			return;
		}
		
		this.__inited=true;
		AP.postmessage.listen(function(data, origin){
			if (data.token!=Base.drive.token){
				return;
			}
			
			if (origin!=Base.domain("drive")){
				return;
			}
			
			$("#js-drive-picker").remove();
			AP.hideCustomDialog();
			
			if (Base.drive.callback){
				if (data.files && data.files.length){
					Base.drive.callback(AP.select(data.files, function(e, index){
						e._html=Base.drive.renderInputs(e, "file_"+index);
						return e;
					}));	
				}
			}
				
		});
	};
	
	this.pick=function(options){
		options=$.extend({multi: 0, ext: 0}, options);
		
		this.init();
		if (options.callback){
			this.callback=options.callback;	
		}
		
		this.token=AP.uuid();
		var picker_iframe=Base.domain("drive")+"/picker?multi="+options.multi+"&ext="+options.ext+"&base_token="+this.token+"&base_domain="+encodeURIComponent(Client.url);
		if (mobile()){
			var w=$(window).width();
			var h=$(window).height();
			var html="<div id='js-drive-picker' style='width:"+w+"px; height: "+h+"px; background-color:#fff; overflow:hidden;'><iframe style='width: 100%; height:100%' src='"+picker_iframe+"'/></div>";
		}else{
			var html="<div id='js-drive-picker' style='width:800px; height: 480px; background-color:#fff; overflow:hidden; border-radius:3px; -webkit-border-radius:3px;'><iframe style='width: 100%; height:100%' src='"+picker_iframe+"'/></div>";	
		}
		
		AP.customCanvas(html, true).data("full", (mobile()?1:0)).show().on({
			"close": function(){
				$("#js-drive-picker").remove();
			}
		});
		
		$("#__apdialog_custom-dialog .full-mask").off();
	};
	
	
	
	this.append=function(data, files, name){
		if (!name){
			name="file";
		}
		
		data.__drive_upload=1;
		
		for (var i=0; i<files.length; i++){
			data[name+""+i+"_name"]=files[i].name;
			data[name+""+i+"_refid"]=files[i].refid;
			data[name+""+i+"_metatype"]=files[i].metatype;
			data[name+""+i+"_size"]=files[i].size;
			data[name+""+i+"_fid"]=files[i].fid;
			data[name+""+i+"_is_image"]=files[i]["is_image"];
			data[name+""+i+"_download"]=files[i]["download"];
			data[name+""+i+"_preview"]=files[i]["preview"];
		}
		
		return data;
	};
	
	
	
	this.renderInputs=function(file, name){
		return "<div class='hidden js-basepicker js-base-picker-"+name+"' data-name='"+name+"'>" +
			"<input type='hidden' name='"+name+"_name' data-name='name' value='"+file.name+"'/>" +
			"<input type='hidden' name='"+name+"_refid' data-name='refid' value='"+file.refid+"'/>" +
			"<input type='hidden' name='"+name+"_metatype' data-name='metatype' value='"+file.metatype+"'/>" +
			"<input type='hidden' name='"+name+"_weblink' data-name='weblink' value='"+file.weblink+"'/>" +
			"<input type='hidden' name='"+name+"_size' data-name='size' value='"+file.size+"'/>" +
			"<input type='hidden' name='"+name+"_fid' data-name='fid' value='"+file.fid+"'/>" +
			"<input type='hidden' name='"+name+"_is_image' data-name='is_image' value='"+file.is_image+"'/>" +
			"<input type='hidden' name='"+name+"_preview' data-name='preview' value='"+file.preview+"'/>" +
			"<input type='hidden' name='"+name+"_download' data-name='download' value='"+file.download+"'/>" +
		"</div>";
	};
};Base.board=new function __BaseBoard(){
	
};Base.emoji = new function __BaseEmoji(){
	var use_twemoji = true;
	var heights = null; 
	var locked = false;
	var callback = null;
	
	var autohide = 0;
	
	var ii_codes = null;
	var ii_short_codes = null;
	
	/**
	 * @desc Initialize the callback
	 */
	this.init = function(opts, _callback){
		callback = _callback;
		if ($("#js-base-emoji").length && $("#js-base-emoji").is(":visible")){
			$("#js-base-emoji").hide();
			return;
		}
		
		_init(opts);
	};
	
	
	this.hide = function(){
		$("#js-base-emoji").hide();
	};
	
	
	/**
	 * @desc Callback on select
	 */
	this.onSelect = function(emj){
		Base.emoji.recent.cache(emj);
		rebuild();
		
		if (autohide){
			$("#js-base-emoji").hide();
		}
		
		if (callback){
			callback(emj);
		}
	};
	
	
	this.update = function(){
		rebuild();
	};
	
	
	/**
	 * @desc Insert the selected emoji
	 */
	this.insert = function(input, emoji){
		var str;
		if (emoji.code == "custom-yahoo"){
			str = emoji.shortcode+" ";
		}else if (AP.word.prefix(emoji.code, "custom-")){
			str = ":"+emoji.shortcode+": ";
		}else{
			str = emoji.emoji;	
		}
		
		if (!str){
			return;
		}
			
		var c = new CaretHandler("#"+$(input).attr("id"));
		c.insert(str);
	};
	
	
	/**
	 * @desc Get emoji by codes
	 */
	this.getByCode = function(code){
		if (!ii_codes){
			initInvertedIndexes();
		}
		
		if (ii_codes[code]){
			return ii_codes[code];
		}
		
		return null;
	};
	
	
	/**
	 * @desc Get emoji by codes
	 */
	this.getByShortCode = function(code){
		if (!ii_codes){
			initInvertedIndexes();
		}
		
		if (ii_short_codes[code]){
			return ii_short_codes[code];
		}
		
		return null;
	};
	
	
	function _init(opts){
		if (opts && opts.icon){
			detectPosition(opts);
		}
		
		if ('autohide' in opts){
			autohide = opts.autohide;
		}else{
			autohide = 0;
		}

		if ($("#js-base-emoji").length){
			$("#js-base-emoji").show().css(Render.position.get(opts));
			
			if ('yahoo' in opts && !opts.yahoo){
				$("#js-base-emoji .js-group-yahoo").hide();	
			}else{
				$("#js-base-emoji .js-group-yahoo").show();
			}
			
			
			return;
		}
		
		UI.ajaxShow();
		
		var groups = AP.render(Base.emoji.groups, function(g){
			var items = AP.render(g.emojis, function(e){
				return getEmoji(e);
			});
			
			return "<div class='be-group js-group-"+(g.groupkey)+"' data-code='"+(g.groupkey)+"'> " +Render.render('title', {}, ""+(g.group)+"")+ "<div class='be-items'>"+(items)+"</div> </div>";
		});
		
		groups = getRecentEmojis() + groups;
		groups += getYahooEmojis() + getCustomEmojis();
		
		var darkmode = (Client.darkmode&&parseInt(Client.darkmode))?'-darkmode':'';
		var html = "<div class='base-emoji-canvas "+(darkmode)+"' style='"+(Render.position.getText(opts))+"' id='js-base-emoji'> <div class='base-emoji'> <div class='be-header'> <div class='be-tab active' data-group='recent' title='{{Recent}'> " +Render.render('icon', {icon: "emoji_recent" }, '')+ "</div> <div class='be-tab' data-group='smileys_emotion' title='Smileys and Emoticons'> " +Render.render('icon', {icon: "emoji_smile" }, '')+ "</div> <div class='be-tab' data-group='animals_nature' title='Animals and natural'> " +Render.render('icon', {icon: "emoji_leaf" }, '')+ "</div> <div class='be-tab' data-group='food_drink' title='Food and drink'> " +Render.render('icon', {icon: "emoji_food" }, '')+ "</div> <div class='be-tab' data-group='travel_places' title='Travel and places'> " +Render.render('icon', {icon: "emoji_travel" }, '')+ "</div> <div class='be-tab' data-group='activities' title='Hoáº¡t Ä‘á»™ng'> " +Render.render('icon', {icon: "emoji_activity" }, '')+ "</div> <div class='be-tab' data-group='people_body' title='People and body'> " +Render.render('icon', {icon: "emoji_people" }, '')+ "</div> <div class='be-tab' data-group='objects' title='Objects'> " +Render.render('icon', {icon: "emoji_object" }, '')+ "</div> <div class='be-tab' data-group='symbols' title='Symbols'> " +Render.render('icon', {icon: "emoji_symbol" }, '')+ "</div> <div class='be-tab' data-group='flags' title='Flags'> " +Render.render('icon', {icon: "emoji_flag" }, '')+ "</div> <div class='be-tab' data-group='yahoo' title='Yahoo'> " +Render.render('icon', {icon: "emoji_yahoo" }, '')+ "</div> <div class='be-tab' data-group='custom' title='Custom emojis'> " +Render.render('icon', {icon: "emoji_custom" }, '')+ "</div> <div class='close js-close'><span class='-ap icon-ion-android-close'></span></div> </div> <div class='be-search'> " +Render.render('search', {placeholder: "Filter emoji" , disable_autocomplete:1}, '')+ "</div> <div class='be-body'> <div class='be-fake-header hidden'></div> <div class='be-body-inner' data-autoscroll='1' data-autohide='1'> <div class='js-emojis'></div> </div> </div> <div class='be-footer'> <div class='be-add'> " +Render.render('button', {icon: "ap plus2" , title: "Custom emoji" }, '')+ "</div> <div class='selected-emoji'></div> <div class='be-guide'>Click to select emoji</div> </div> </div> </div>";
		
		$(document.body).append(html);
		Layout.scrollable("#js-base-emoji .be-body-inner");
		$("#js-base-emoji .js-emojis").html(groups);
		bindEvents();
		
		$("#js-base-emoji .js-close").click(function(){
			$("#js-base-emoji").hide();
		});
		
		if ('yahoo' in opts && !opts.yahoo){
			$("#js-base-emoji .js-group-yahoo").hide();	
		}else{
			$("#js-base-emoji .js-group-yahoo").show();
		}
		
		UI.ajaxHide();
	};
	
	
	
	function getRecentEmojis(){
		var items = AP.render(Base.emoji.recent.get(), function(e){
			return getEmoji(e);
		});
		
		return "<div class='be-group js-group-recent' data-code='recent'> " +Render.render('title', {}, "Recently used")+ "<div class='be-items'>"+(items)+"</div> </div>";
	};
	
	
	function getYahooEmojis(){
		var items = "";
		
		for (var key in UI.emoticons){
			var f = UI.emoticons[key];
			var parts = f.split("/")
			var e = {
				name: parts[parts.length-1],
				shortcode: key,
				emoji: f,
				code: "custom-yahoo"
			};
			
			items+= getEmoji(e);
		}
		
		return "<div class='be-group js-group-yahoo' data-code='yahoo'> " +Render.render('title', {}, "Yahoo emojis")+ "<div class='be-items -sm'>"+(items)+"</div> </div>";
	};
	
	
	function getCustomEmojis(){
		var items = AP.render(Client.emojis, function(e){
			return getEmoji(e);
		});
		
		return "<div class='be-group js-group-custom' data-code='custom'> " +Render.render('title', {}, "Custom emojis")+ "<div class='be-items'>"+(items)+"</div> </div>";
	};
	
	
	function rebuild(){
		var recent = AP.render(Base.emoji.recent.get(), function(e){
			return getEmoji(e);
		});
		
		$("#js-base-emoji .js-group-recent .be-items").html(recent);
		
		var custom = AP.render(Client.emojis, function(e){
			return getEmoji(e);
		});
		
		$("#js-base-emoji .js-group-custom .be-items").html(custom);
	};
	
	
	
	
	function getEmoji(e){
		return "<div class='js-emoji be-emoji' data-kw='"+(purifyStrict(e.name))+"' data-name='"+(e.name)+"' data-emoji='"+(e.emoji)+"' data-shortcode='"+(e.shortcode)+"' data-code='"+(e.code)+"'> <span class='symbol'>"+(getEmojiIcon(e.emoji, e.code))+"</span> </div>";
	};
	
	
	/**
	 * @desc Get to render a single emoji icon/image
	 */
	function getEmojiIcon(emj, code){
		code = ""+code;
		
		if (AP.data.isString(code) && code == 'custom' || AP.word.prefix(code, "custom-")){
			return "<img src='"+(emj)+"'/>"
		}
		
		var _emoji = emj;
		if (use_twemoji){
			if (!code){
				return;
			}
			
			code = code.toLowerCase().replace(/\s/g,'-');
			_emoji = "<img src='"+(Client.share_url)+"/twemoji/svg/"+(code)+".svg'/>";
		}
		
		return _emoji;
	};
	
	
	/**
	 * @desc Bind events
	 */
	function bindEvents(){
		$("#js-base-emoji .be-footer .base-button").click(function(){
			return Base.emoji.custom.create();
		});
		
		$("#js-base-emoji .be-emoji").hover(function(){
			$("#js-base-emoji .be-footer").addClass("active");
			$("#js-base-emoji .be-footer .selected-emoji").html(getExplainedEmoji($(this)));
		}, function(){
			$("#js-base-emoji .be-footer").removeClass("active");
		});
		
		$("#js-base-emoji").on("click", ".be-emoji", function(){
			var emj = {
				name: $(this).data('name'),
				code: $(this).data('code'),
				emoji: $(this).data('emoji'),
				shortcode: $(this).data('shortcode'),
				type: $(this).data('type')||''
			}
			
			Base.emoji.onSelect(emj);
		});
		
		
		// Init tabbing
		$("#js-base-emoji .be-header .be-tab").each(function(){
			$(this).click(function(){
				$(this).siblings().removeClass("active");
				$(this).addClass("active");
				
				var g = $(this).data("group");
				var $g = $("#js-base-emoji .be-body .js-group-"+g);
				if (!$g.length || !$g.is(":visible")){
					return;
				}
				
				var top = $g.position().top;
				locked = true;
				$("#js-base-emoji .scrollin").animate({scrollTop: top}, 300, function(){
					locked = false;
				});
			});
		});
		
		
		$("#js-base-emoji .scrollin").on("scroll", function(){
			if (locked){
				return;
			}
			
			var top = $(this).scrollTop();
			showVisible(top);
		});
		
		
		// Init searching
		$("#js-base-emoji .base-search input").on("input", function(){
			var v = purifyStrict($(this).val());
			if (!v){
				$("#js-base-emoji .js-emoji").show();
				return;
			}
			
			$("#js-base-emoji .js-emoji").each(function(){
				var kw = $(this).data("kw");
				if (kw.indexOf(v)!=-1){
					$(this).show();
				}else{
					$(this).hide();
				}
			});
		});
	};
	
	
	function getExplainedEmoji($ref){
		var emj = getEmojiIcon($ref.data("emoji"), $ref.data("code"));
		var name = $ref.data('name');
		var scode = $ref.data('shortcode');
		return "<span class='emoji'>"+(emj)+"</span> <span class='emj-name'>"+(name)+"</span> <span class='emj-scode'>:"+(scode)+":</span>";
	};
	
	
	
	function showVisible(t){
		if (!heights){
			heights = [];
			$("#js-base-emoji .be-group").each(function(index){
				var top = $(this).position().top;
				heights.push(top);
			});
		}
		
		var i=0; 
		while(true){
			if (i<heights.length && heights[i]<t-10){
				i++;
			}else{
				break;
			}
		}
		
		if (i==0){
			i=1;
		}
		
		setActive(i-1, t);	
		
	};
	
	
	function setActive(index, t){
		$("#js-base-emoji .be-header .be-tab").removeClass("active");
		$("#js-base-emoji .be-header .be-tab").eq(index).addClass("active");
	};
	
	
	
	function detectPosition(opts){
		var offset = $(opts.icon).offset();
		opts.left = offset.left-380;
		var _top = offset.top-390;
		
		if (_top<0){
			opts.top = offset.top+40;
		}else{
			opts.top = _top;
		}
	};
	
	
	function initInvertedIndexes(){
		ii_codes = {};
		ii_short_codes = {};
		
		ARR.each(Base.emoji.groups, function(g){
			ARR.each(g.emojis, function(e){
				ii_codes[e.code] = e;
				ii_short_codes[e.shortcode] = e;
			});
		});
		
		ARR.each(Client.emojis, function(e){
			ii_codes[e.code] = e;
			ii_short_codes[e.shortcode] = e;
		});
	};
	
	
};


SVG.group("emoji", {
	emoji_recent: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 2 C 8.9883724 2 6.3037203 3.3556682 4.4707031 5.4707031 L 2 3 L 2 9 L 8 9 L 5.8769531 6.8769531 C 7.3450482 5.1245479 9.5396099 4 12 4 C 16.411 4 20 7.589 20 12 C 20 16.411 16.411 20 12 20 C 7.589 20 4 16.411 4 12 L 2 12 C 2 17.514 6.486 22 12 22 C 17.514 22 22 17.514 22 12 C 22 6.486 17.514 2 12 2 z M 11 6 L 11 12.414062 L 14.292969 15.707031 L 15.707031 14.292969 L 13 11.585938 L 13 6 L 11 6 z'/></svg>",
	emoji_smile: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 2 C 6.477 2 2 6.477 2 12 C 2 17.523 6.477 22 12 22 C 17.523 22 22 17.523 22 12 C 22 6.477 17.523 2 12 2 z M 12 4 C 16.418 4 20 7.582 20 12 C 20 16.418 16.418 20 12 20 C 7.582 20 4 16.418 4 12 C 4 7.582 7.582 4 12 4 z M 8.5 8 A 1.5 1.5 0 0 0 7 9.5 A 1.5 1.5 0 0 0 8.5 11 A 1.5 1.5 0 0 0 10 9.5 A 1.5 1.5 0 0 0 8.5 8 z M 15.5 8 A 1.5 1.5 0 0 0 14 9.5 A 1.5 1.5 0 0 0 15.5 11 A 1.5 1.5 0 0 0 17 9.5 A 1.5 1.5 0 0 0 15.5 8 z M 6.890625 14 C 7.690625 16.04 9.67 17.5 12 17.5 C 14.33 17.5 16.309375 16.04 17.109375 14 L 6.890625 14 z'/></svg>",
	emoji_leaf: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 16.638672 1.9042969 L 16.068359 2.0214844 C 16.068359 2.0214844 13.891965 2.4729649 11.320312 3.5292969 C 8.7486616 4.5856288 5.7126699 6.2281869 3.953125 8.8632812 L 3.9375 8.8847656 L 3.9238281 8.90625 C 3.117214 10.261502 3 11.563976 3 12.5625 C 3 14.469775 3.8970272 16.083022 5.0566406 17.197266 C 5.5502907 17.671601 6.0941263 18.047902 6.65625 18.347656 C 5.7124953 19.05328 4.6998074 19.643905 3.6289062 20.072266 L 4.3710938 21.927734 C 9.7463903 19.777616 13.645891 14.528734 14.964844 9.2285156 L 13.023438 8.7460938 C 12.297056 11.665061 10.626181 14.620299 8.3535156 16.882812 C 7.7600793 16.707306 7.0409385 16.330059 6.4433594 15.755859 C 5.6029728 14.948353 5 13.842225 5 12.5625 C 5 11.704133 5.0742979 10.907299 5.6367188 9.9511719 C 7.007217 7.9178775 9.6982404 6.3572704 12.080078 5.3789062 C 14.148033 4.5294729 15.437855 4.2697877 15.880859 4.1699219 C 18.039377 6.8847258 18.969237 10.221386 18.998047 12.390625 C 19.028137 14.638794 18.446926 16.265722 17.582031 17.332031 C 16.720357 18.39437 15.57295 18.939564 14.242188 18.996094 C 13.647213 18.988594 12.968543 19.015564 11.982422 18.257812 L 10.763672 19.84375 C 12.225887 20.967347 13.710143 20.991474 14.253906 21 L 14.28125 21 L 14.308594 21 C 16.172464 20.92605 17.919161 20.090488 19.134766 18.591797 C 20.350371 17.093106 21.03296 14.974065 20.998047 12.365234 C 20.960613 9.5460885 19.860042 5.5623822 17.023438 2.3398438 L 16.638672 1.9042969 z'/></svg>",
	emoji_food: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 9.0214844 1.9882812 A 1.0001 1.0001 0 0 0 8.015625 2.8085938 L 2.0625 20.671875 A 1.0001 1.0001 0 0 0 3.328125 21.9375 L 21.140625 16 L 21.011719 16 A 1.0001 1.0001 0 0 0 21.958984 14.683594 C 19.978018 8.7259491 15.274051 4.0219824 9.3164062 2.0410156 A 1.0001 1.0001 0 0 0 9.0214844 1.9882812 z M 9.3261719 5.2050781 C 13.632241 6.9302645 17.070639 10.368059 18.794922 14.673828 L 15.900391 15.638672 A 2 2 0 0 0 16.011719 14.988281 A 2 2 0 0 0 14.011719 12.988281 A 2 2 0 0 0 12.011719 14.988281 A 2 2 0 0 0 12.884766 16.642578 L 10.005859 17.603516 A 1.5 1.5 0 0 0 10.011719 17.488281 A 1.5 1.5 0 0 0 8.5117188 15.988281 A 1.5 1.5 0 0 0 7.0117188 17.488281 A 1.5 1.5 0 0 0 7.3847656 18.476562 L 4.5917969 19.408203 L 7.3574219 11.111328 A 2 2 0 0 0 9.0117188 11.988281 A 2 2 0 0 0 11.011719 9.9882812 A 2 2 0 0 0 9.0117188 7.9882812 A 2 2 0 0 0 8.3613281 8.0996094 L 9.3261719 5.2050781 z'/></svg>",
	emoji_travel: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' width='48px' height='48px'><path d='M 36.886719 7.0976562 C 35.596746 7.155645 34.325741 7.6941814 33.382812 8.6894531 A 1.50015 1.50015 0 0 0 33.380859 8.6914062 L 28.597656 13.755859 L 13.644531 9.3144531 L 13.691406 9.3300781 C 11.99063 8.7626393 10.095367 9.2648505 8.8984375 10.617188 C 7.6020481 12.081559 7.9093591 14.334884 9.4023438 15.496094 A 1.50015 1.50015 0 0 0 9.453125 15.533203 L 19.855469 22.962891 L 14.914062 28.080078 L 12.955078 27.476562 C 11.294976 26.749339 9.3416963 27.081256 8.0292969 28.347656 C 6.6704667 29.657072 6.6889705 31.84522 8.0039062 33.160156 A 1.50015 1.50015 0 0 0 8.1933594 33.320312 L 9.4472656 34.216797 L 9.6757812 33.880859 C 8.628274 35.42899 8.8296213 37.527232 10.150391 38.849609 C 11.47159 40.170808 13.569119 40.373703 15.119141 39.330078 L 14.787109 39.554688 L 15.681641 40.808594 A 1.50015 1.50015 0 0 0 15.841797 40.998047 C 17.157605 42.313855 19.345037 42.330877 20.654297 40.972656 C 21.918295 39.661258 22.251134 37.710812 21.525391 36.050781 L 20.921875 34.087891 L 26.039062 29.146484 L 33.46875 39.548828 A 1.50015 1.50015 0 0 0 33.503906 39.599609 C 34.664855 41.092762 36.919407 41.400779 38.384766 40.103516 A 1.50015 1.50015 0 0 0 38.386719 40.103516 C 39.73856 38.90553 40.237815 37.009864 39.671875 35.310547 L 39.6875 35.357422 L 35.246094 20.404297 L 40.310547 15.621094 A 1.50015 1.50015 0 0 0 40.3125 15.619141 C 42.302764 13.733551 42.468229 10.540639 40.609375 8.4941406 A 1.50015 1.50015 0 0 0 40.509766 8.3925781 C 39.486747 7.4626943 38.176692 7.0396675 36.886719 7.0976562 z M 37.011719 10.148438 C 37.534401 10.123527 38.043778 10.285338 38.414062 10.587891 C 39.03485 11.349768 38.976892 12.749216 38.25 13.439453 L 32.515625 18.857422 A 1.50015 1.50015 0 0 0 32.107422 20.375 L 36.810547 36.212891 A 1.50015 1.50015 0 0 0 36.826172 36.259766 C 37.016232 36.830449 36.854642 37.451408 36.396484 37.857422 C 36.258343 37.979717 36.028064 37.952723 35.875 37.757812 L 27.470703 25.986328 A 1.50015 1.50015 0 0 0 25.208984 25.779297 L 18.175781 32.568359 A 1.50015 1.50015 0 0 0 17.783203 34.089844 L 18.664062 36.951172 A 1.50015 1.50015 0 0 0 18.755859 37.179688 C 19.042541 37.753051 18.936598 38.431575 18.494141 38.890625 C 18.365836 39.023727 18.144352 39.011357 17.988281 38.876953 L 16.378906 36.621094 A 1.50015 1.50015 0 0 0 14.318359 36.25 L 13.443359 36.841797 L 13.443359 36.839844 C 13.067747 37.093372 12.591222 37.048254 12.271484 36.728516 C 11.951197 36.407838 11.908199 35.932097 12.160156 35.560547 A 1.50015 1.50015 0 0 0 12.160156 35.558594 L 12.751953 34.683594 A 1.50015 1.50015 0 0 0 12.380859 32.623047 L 10.125 31.013672 C 9.99014 30.857286 9.9761199 30.636099 10.109375 30.507812 A 1.50015 1.50015 0 0 0 10.111328 30.505859 C 10.570101 30.063166 11.248273 29.959098 11.822266 30.246094 A 1.50015 1.50015 0 0 0 12.050781 30.337891 L 14.912109 31.21875 A 1.50015 1.50015 0 0 0 16.433594 30.826172 L 23.222656 23.792969 A 1.50015 1.50015 0 0 0 23.015625 21.53125 L 11.244141 13.126953 C 11.047095 12.972188 11.021366 12.744594 11.144531 12.605469 C 11.549601 12.147805 12.171016 11.985223 12.742188 12.175781 A 1.50015 1.50015 0 0 0 12.789062 12.191406 L 28.626953 16.894531 A 1.50015 1.50015 0 0 0 30.144531 16.486328 L 35.5625 10.751953 C 35.916607 10.379042 36.461324 10.174668 37.011719 10.148438 z'/></svg>",
	emoji_activity: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 16.111328 1.9882812 C 15.493963 2.0053 14.848342 2.071506 14.1875 2.1816406 C 11.544134 2.6221792 8.6046796 3.8852734 6.2285156 6.2167969 L 6.2207031 6.2246094 L 6.2148438 6.2304688 C 3.8805695 8.6083491 2.6179701 11.568121 2.1777344 14.220703 C 1.7374986 16.873285 1.9707542 19.257864 3.3574219 20.644531 C 4.7386889 22.025798 7.1214519 22.285207 9.7773438 21.855469 C 12.433236 21.42573 15.400065 20.159943 17.779297 17.78125 C 20.117979 15.442028 21.379943 12.499093 21.820312 9.8457031 C 22.260683 7.1923134 22.015484 4.7954416 20.65625 3.3769531 L 20.642578 3.3613281 L 20.626953 3.3457031 C 19.920223 2.6684923 18.971819 2.2685287 17.869141 2.0917969 C 17.317801 2.003431 16.728693 1.9712625 16.111328 1.9882812 z M 16.132812 4.0195312 C 16.639479 4.0202336 17.108511 4.0627407 17.523438 4.1328125 C 18.342979 4.2712145 18.941009 4.5214966 19.220703 4.78125 C 19.738834 5.339471 20.222953 7.2562749 19.847656 9.5175781 C 19.470026 11.792938 18.361552 14.370409 16.365234 16.367188 C 14.326466 18.405493 11.729889 19.513098 9.4570312 19.880859 C 7.184173 20.248621 5.2712174 19.730202 4.7714844 19.230469 C 4.276152 18.735136 3.7726264 16.824996 4.1503906 14.548828 C 4.5277066 12.275361 5.6394779 9.6767067 7.6367188 7.6386719 C 9.6774067 5.6397049 12.253436 4.5313092 14.515625 4.1542969 C 15.081846 4.0599315 15.626146 4.0188289 16.132812 4.0195312 z M 15.292969 7.2929688 L 13.5 9.0859375 L 12.207031 7.7929688 L 10.792969 9.2070312 L 12.085938 10.5 L 10.5 12.085938 L 9.2070312 10.792969 L 7.7929688 12.207031 L 9.0859375 13.5 L 7.2929688 15.292969 L 8.7070312 16.707031 L 10.5 14.914062 L 11.792969 16.207031 L 13.207031 14.792969 L 11.914062 13.5 L 13.5 11.914062 L 14.792969 13.207031 L 16.207031 11.792969 L 14.914062 10.5 L 16.707031 8.7070312 L 15.292969 7.2929688 z'/></svg>",
	emoji_object: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 2 C 9.8830028 2 7.9080247 2.578249 6.4238281 3.7695312 C 4.9396315 4.9608137 4 6.796781 4 9 C 4 10.777864 4.8810092 12.49329 5.9492188 14.021484 C 6.9022182 15.384857 8.0234885 16.571833 9 17.443359 L 9 20 C 9 21.093063 9.9069372 22 11 22 L 13 22 C 14.093063 22 15 21.093063 15 20 L 15 17.443359 C 15.976512 16.571833 17.097782 15.384857 18.050781 14.021484 C 19.118991 12.49329 20 10.777864 20 9 C 20 6.796781 19.060368 4.9608137 17.576172 3.7695312 C 16.091975 2.578249 14.116997 2 12 2 z M 12 4 C 13.749003 4 15.274915 4.4878605 16.324219 5.3300781 C 17.373522 6.1722958 18 7.337219 18 9 C 18 10.062136 17.35615 11.524444 16.412109 12.875 C 15.534434 14.130614 14.44756 15.230028 13.570312 16 L 10.429688 16 C 9.5524393 15.230028 8.4655663 14.130614 7.5878906 12.875 C 6.6438502 11.524444 6 10.062136 6 9 C 6 7.337219 6.626478 6.1722958 7.6757812 5.3300781 C 8.7250846 4.4878605 10.250997 4 12 4 z M 11 18 L 13 18 L 13 20 L 11 20 L 11 18 z'/></svg>",
	emoji_symbol: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 6 6 C 2.6983746 6 0 8.6983746 0 12 C 0 15.301625 2.6983746 18 6 18 C 7.94 18 9.6597656 17.080391 10.759766 15.650391 C 10.319766 15.020391 9.9303125 14.379297 9.5703125 13.779297 C 8.9303125 15.099297 7.57 16 6 16 C 3.7796254 16 2 14.220375 2 12 C 2 9.7796254 3.7796254 8 6 8 C 7.2222222 8 8.0436765 8.4577391 8.8554688 9.2695312 C 9.6672608 10.081323 10.392578 11.263672 11.142578 12.513672 C 11.892578 13.763672 12.667261 15.081323 13.730469 16.144531 C 14.793677 17.207739 16.222222 18 18 18 C 21.301625 18 24 15.301625 24 12 C 24 8.6983746 21.301625 6 18 6 C 16.06 6 14.340234 6.9196094 13.240234 8.3496094 C 13.680234 8.9796094 14.069688 9.6207031 14.429688 10.220703 C 15.069688 8.9007031 16.43 8 18 8 C 20.220375 8 22 9.7796254 22 12 C 22 14.220375 20.220375 16 18 16 C 16.777778 16 15.956323 15.542261 15.144531 14.730469 C 14.332739 13.918677 13.607422 12.736328 12.857422 11.486328 C 12.107422 10.236328 11.332739 8.9186765 10.269531 7.8554688 C 9.2063236 6.7922608 7.7777778 6 6 6 z'/></svg>",
	emoji_flag: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 3 2 L 3 22 L 5 22 L 5 2 Z M 6 2 L 6 4 L 19 4 L 19 13 L 6 13 L 6 15 L 21 15 L 21 2 Z'/></svg>",
	emoji_people: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 11.208984 0.96679688 L 10.322266 4.8710938 L 6.7070312 7.9375 C 6.2591873 8.3173676 6 8.8763736 6 9.4628906 L 6 19 C 6 20.093063 6.9069372 21 8 21 L 16.634766 21 C 17.388427 21 18.081202 20.571852 18.419922 19.900391 L 21.835938 13.126953 C 21.946341 12.912279 22 12.675206 22 12.443359 L 22 10 C 22 8.9069372 21.093063 8 20 8 L 15.435547 8 C 15.717519 7.1230458 16 5.9865419 16 4.8632812 C 16 3.1275839 14.913925 1.9898585 13.945312 1.5078125 C 12.9767 1.0257665 12.041016 1 12.041016 1 L 11.208984 0.96679688 z M 12.748047 3.2148438 C 12.888793 3.2572208 12.90593 3.2247941 13.054688 3.2988281 C 13.586074 3.5632825 14 3.8569786 14 4.8632812 C 14 6.2517803 13.078125 8.6113281 13.078125 8.6113281 L 12.492188 10 L 20 10 L 20 12.324219 L 16.634766 19 L 8 19 L 8 9.4628906 L 12.125 5.9628906 L 12.748047 3.2148438 z M 2 8 L 2 21 L 4 21 L 4 8 L 2 8 z'/></svg>",
	emoji_custom: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 3 C 9.8027056 3 8 4.8027056 8 7 C 8 9.1972944 9.8027056 11 12 11 C 14.197294 11 16 9.1972944 16 7 C 16 4.8027056 14.197294 3 12 3 z M 12 5 C 13.116414 5 14 5.8835859 14 7 C 14 8.1164141 13.116414 9 12 9 C 10.883586 9 10 8.1164141 10 7 C 10 5.8835859 10.883586 5 12 5 z M 12 14 C 8.859 14 3 15.545 3 18.5 L 3 21 L 14.185547 21 L 12.96875 19.947266 L 11.873047 19 L 5 19 L 5 18.5 C 5 17.631 8.708 16 12 16 C 13.406 16 14.887047 16.299031 16.123047 16.707031 L 16.902344 14.855469 C 15.222344 14.289469 13.357 14 12 14 z M 19.011719 15 L 17.683594 18.142578 L 14.277344 18.433594 L 16.859375 20.669922 L 16.083984 23.998047 L 19.011719 22.234375 L 21.939453 24 L 21.164062 20.662109 L 23.746094 18.427734 L 20.341797 18.136719 L 19.011719 15 z'/></svg>",
	emoji_sticker: "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><path d='M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z'></path></svg>",
	emoji_smile_16: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' ><path d='M8 15A7 7 0 118 1a7 7 0 010 14zm0 1A8 8 0 108 0a8 8 0 000 16z'></path><path d='M4.285 9.567a.5.5 0 01.683.183A3.498 3.498 0 008 11.5a3.498 3.498 0 003.032-1.75.5.5 0 11.866.5A4.498 4.498 0 018 12.5a4.498 4.498 0 01-3.898-2.25.5.5 0 01.183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z'></path></svg>",
	emoji_yahoo: "<svg height='384pt' viewBox='0 0 384 384' width='384pt' xmlns='http://www.w3.org/2000/svg'><path d='m192 0c-105.871094 0-192 86.128906-192 192 0 105.863281 86.128906 192 192 192s192-86.136719 192-192c0-105.871094-86.128906-192-192-192zm0 352c-88.222656 0-160-71.777344-160-160s71.777344-160 160-160 160 71.777344 160 160-71.777344 160-160 160zm0 0'/><path d='m153.855469 156.785156-36.765625-58.832031-27.136719 16.957031 46.046875 73.675782v91.414062h32v-90.207031l46.535156-55.839844-24.582031-20.488281zm0 0'/><path d='m232 112h32v104h-32zm0 0'/><path d='m232 240h32v40h-32zm0 0'/></svg>",
	emoji_buzz: "<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'><path d='M5.52.359A.5.5 0 0 1 6 0h4a.5.5 0 0 1 .474.658L8.694 6H12.5a.5.5 0 0 1 .395.807l-7 9a.5.5 0 0 1-.873-.454L6.823 9.5H3.5a.5.5 0 0 1-.48-.641l2.5-8.5zM6.374 1 4.168 8.5H7.5a.5.5 0 0 1 .478.647L6.78 13.04 11.478 7H8a.5.5 0 0 1-.474-.658L9.306 1H6.374z'></path></svg>",
});




Base.emoji.recent = new function __BaseEmojiRecent(){
	/**
	 * @desc Get the recent list
	 */
	this.get = function(){
		var data = Me.pref().get("emojis");
		if (!data){
			return [];
		}
		
		return data;
	};
	
	
	
	/**
	 * @desc Cache a single emoji
	 */
	this.cache = function(emoji){
		var data = this.get();
		data.unshift(emoji);
		if (data.length>20){
			data = ARR.cut(data, 20); 
		}
		
		data = ARR.unique(data, function(e, f){
			return ""+e.code == ""+f.code;
		});
		
		Me.pref().set("emojis", data);
		return data;
	};
	
};


Base.emoji.groups = [{"group":"Smileys & Emotion","groupkey":"smileys_emotion","emojis":[{"emoji":"đŸ˜€","shortcode":"grinning_face","name":"grinning face","code":"1F600"},{"emoji":"đŸ˜ƒ","shortcode":"grinning_face_with_big_eyes","name":"grinning face with big eyes","code":"1F603"},{"emoji":"đŸ˜„","shortcode":"grinning_face_with_smiling_eyes","name":"grinning face with smiling eyes","code":"1F604"},{"emoji":"đŸ˜","shortcode":"beaming_face_with_smiling_eyes","name":"beaming face with smiling eyes","code":"1F601"},{"emoji":"đŸ˜†","shortcode":"grinning_squinting_face","name":"grinning squinting face","code":"1F606"},{"emoji":"đŸ˜…","shortcode":"grinning_face_with_sweat","name":"grinning face with sweat","code":"1F605"},{"emoji":"đŸ¤£","shortcode":"rolling_on_the_floor_laughing","name":"rolling on the floor laughing","code":"1F923"},{"emoji":"đŸ˜‚","shortcode":"face_with_tears_of_joy","name":"face with tears of joy","code":"1F602"},{"emoji":"đŸ™‚","shortcode":"slightly_smiling_face","name":"slightly smiling face","code":"1F642"},{"emoji":"đŸ™ƒ","shortcode":"upside_down_face","name":"upside-down face","code":"1F643"},{"emoji":"đŸ˜‰","shortcode":"winking_face","name":"winking face","code":"1F609"},{"emoji":"đŸ˜","shortcode":"smiling_face_with_smiling_eyes","name":"smiling face with smiling eyes","code":"1F60A"},{"emoji":"đŸ˜‡","shortcode":"smiling_face_with_halo","name":"smiling face with halo","code":"1F607"},{"emoji":"đŸ¥°","shortcode":"smiling_face_with_hearts","name":"smiling face with hearts","code":"1F970"},{"emoji":"đŸ˜","shortcode":"smiling_face_with_heart_eyes","name":"smiling face with heart-eyes","code":"1F60D"},{"emoji":"đŸ¤©","shortcode":"star_struck","name":"star-struck","code":"1F929"},{"emoji":"đŸ˜˜","shortcode":"face_blowing_a_kiss","name":"face blowing a kiss","code":"1F618"},{"emoji":"đŸ˜—","shortcode":"kissing_face","name":"kissing face","code":"1F617"},{"emoji":"đŸ˜","shortcode":"kissing_face_with_closed_eyes","name":"kissing face with closed eyes","code":"1F61A"},{"emoji":"đŸ˜™","shortcode":"kissing_face_with_smiling_eyes","name":"kissing face with smiling eyes","code":"1F619"},{"emoji":"đŸ¥²","shortcode":"smiling_face_with_tear","name":"smiling face with tear","code":"1F972"},{"emoji":"đŸ˜‹","shortcode":"face_savoring_food","name":"face savoring food","code":"1F60B"},{"emoji":"đŸ˜›","shortcode":"face_with_tongue","name":"face with tongue","code":"1F61B"},{"emoji":"đŸ˜œ","shortcode":"winking_face_with_tongue","name":"winking face with tongue","code":"1F61C"},{"emoji":"đŸ¤ª","shortcode":"zany_face","name":"zany face","code":"1F92A"},{"emoji":"đŸ˜","shortcode":"squinting_face_with_tongue","name":"squinting face with tongue","code":"1F61D"},{"emoji":"đŸ¤‘","shortcode":"money_mouth_face","name":"money-mouth face","code":"1F911"},{"emoji":"đŸ¤—","shortcode":"hugging_face","name":"hugging face","code":"1F917"},{"emoji":"đŸ¤­","shortcode":"face_with_hand_over_mouth","name":"face with hand over mouth","code":"1F92D"},{"emoji":"đŸ¤«","shortcode":"shushing_face","name":"shushing face","code":"1F92B"},{"emoji":"đŸ¤”","shortcode":"thinking_face","name":"thinking face","code":"1F914"},{"emoji":"đŸ¤","shortcode":"zipper_mouth_face","name":"zipper-mouth face","code":"1F910"},{"emoji":"đŸ¤¨","shortcode":"face_with_raised_eyebrow","name":"face with raised eyebrow","code":"1F928"},{"emoji":"đŸ˜","shortcode":"neutral_face","name":"neutral face","code":"1F610"},{"emoji":"đŸ˜‘","shortcode":"expressionless_face","name":"expressionless face","code":"1F611"},{"emoji":"đŸ˜¶","shortcode":"face_without_mouth","name":"face without mouth","code":"1F636"},{"emoji":"đŸ˜","shortcode":"smirking_face","name":"smirking face","code":"1F60F"},{"emoji":"đŸ˜’","shortcode":"unamused_face","name":"unamused face","code":"1F612"},{"emoji":"đŸ™„","shortcode":"face_with_rolling_eyes","name":"face with rolling eyes","code":"1F644"},{"emoji":"đŸ˜¬","shortcode":"grimacing_face","name":"grimacing face","code":"1F62C"},{"emoji":"đŸ¤¥","shortcode":"lying_face","name":"lying face","code":"1F925"},{"emoji":"đŸ˜Œ","shortcode":"relieved_face","name":"relieved face","code":"1F60C"},{"emoji":"đŸ˜”","shortcode":"pensive_face","name":"pensive face","code":"1F614"},{"emoji":"đŸ˜ª","shortcode":"sleepy_face","name":"sleepy face","code":"1F62A"},{"emoji":"đŸ¤¤","shortcode":"drooling_face","name":"drooling face","code":"1F924"},{"emoji":"đŸ˜´","shortcode":"sleeping_face","name":"sleeping face","code":"1F634"},{"emoji":"đŸ˜·","shortcode":"face_with_medical_mask","name":"face with medical mask","code":"1F637"},{"emoji":"đŸ¤’","shortcode":"face_with_thermometer","name":"face with thermometer","code":"1F912"},{"emoji":"đŸ¤•","shortcode":"face_with_head_bandage","name":"face with head-bandage","code":"1F915"},{"emoji":"đŸ¤¢","shortcode":"nauseated_face","name":"nauseated face","code":"1F922"},{"emoji":"đŸ¤®","shortcode":"face_vomiting","name":"face vomiting","code":"1F92E"},{"emoji":"đŸ¤§","shortcode":"sneezing_face","name":"sneezing face","code":"1F927"},{"emoji":"đŸ¥µ","shortcode":"hot_face","name":"hot face","code":"1F975"},{"emoji":"đŸ¥¶","shortcode":"cold_face","name":"cold face","code":"1F976"},{"emoji":"đŸ¥´","shortcode":"woozy_face","name":"woozy face","code":"1F974"},{"emoji":"đŸ˜µ","shortcode":"knocked_out_face","name":"knocked-out face","code":"1F635"},{"emoji":"đŸ¤¯","shortcode":"exploding_head","name":"exploding head","code":"1F92F"},{"emoji":"đŸ¤ ","shortcode":"cowboy_hat_face","name":"cowboy hat face","code":"1F920"},{"emoji":"đŸ¥³","shortcode":"partying_face","name":"partying face","code":"1F973"},{"emoji":"đŸ¥¸","shortcode":"disguised_face","name":"disguised face","code":"1F978"},{"emoji":"đŸ˜","shortcode":"smiling_face_with_sunglasses","name":"smiling face with sunglasses","code":"1F60E"},{"emoji":"đŸ¤“","shortcode":"nerd_face","name":"nerd face","code":"1F913"},{"emoji":"đŸ§","shortcode":"face_with_monocle","name":"face with monocle","code":"1F9D0"},{"emoji":"đŸ˜•","shortcode":"confused_face","name":"confused face","code":"1F615"},{"emoji":"đŸ˜Ÿ","shortcode":"worried_face","name":"worried face","code":"1F61F"},{"emoji":"đŸ™","shortcode":"slightly_frowning_face","name":"slightly frowning face","code":"1F641"},{"emoji":"đŸ˜®","shortcode":"face_with_open_mouth","name":"face with open mouth","code":"1F62E"},{"emoji":"đŸ˜¯","shortcode":"hushed_face","name":"hushed face","code":"1F62F"},{"emoji":"đŸ˜²","shortcode":"astonished_face","name":"astonished face","code":"1F632"},{"emoji":"đŸ˜³","shortcode":"flushed_face","name":"flushed face","code":"1F633"},{"emoji":"đŸ¥º","shortcode":"pleading_face","name":"pleading face","code":"1F97A"},{"emoji":"đŸ˜¦","shortcode":"frowning_face_with_open_mouth","name":"frowning face with open mouth","code":"1F626"},{"emoji":"đŸ˜§","shortcode":"anguished_face","name":"anguished face","code":"1F627"},{"emoji":"đŸ˜¨","shortcode":"fearful_face","name":"fearful face","code":"1F628"},{"emoji":"đŸ˜°","shortcode":"anxious_face_with_sweat","name":"anxious face with sweat","code":"1F630"},{"emoji":"đŸ˜¥","shortcode":"sad_but_relieved_face","name":"sad but relieved face","code":"1F625"},{"emoji":"đŸ˜¢","shortcode":"crying_face","name":"crying face","code":"1F622"},{"emoji":"đŸ˜­","shortcode":"loudly_crying_face","name":"loudly crying face","code":"1F62D"},{"emoji":"đŸ˜±","shortcode":"face_screaming_in_fear","name":"face screaming in fear","code":"1F631"},{"emoji":"đŸ˜–","shortcode":"confounded_face","name":"confounded face","code":"1F616"},{"emoji":"đŸ˜£","shortcode":"persevering_face","name":"persevering face","code":"1F623"},{"emoji":"đŸ˜","shortcode":"disappointed_face","name":"disappointed face","code":"1F61E"},{"emoji":"đŸ˜“","shortcode":"downcast_face_with_sweat","name":"downcast face with sweat","code":"1F613"},{"emoji":"đŸ˜©","shortcode":"weary_face","name":"weary face","code":"1F629"},{"emoji":"đŸ˜«","shortcode":"tired_face","name":"tired face","code":"1F62B"},{"emoji":"đŸ¥±","shortcode":"yawning_face","name":"yawning face","code":"1F971"},{"emoji":"đŸ˜¤","shortcode":"face_with_steam_from_nose","name":"face with steam from nose","code":"1F624"},{"emoji":"đŸ˜¡","shortcode":"pouting_face","name":"pouting face","code":"1F621"},{"emoji":"đŸ˜ ","shortcode":"angry_face","name":"angry face","code":"1F620"},{"emoji":"đŸ¤¬","shortcode":"face_with_symbols_on_mouth","name":"face with symbols on mouth","code":"1F92C"},{"emoji":"đŸ˜ˆ","shortcode":"smiling_face_with_horns","name":"smiling face with horns","code":"1F608"},{"emoji":"đŸ‘¿","shortcode":"angry_face_with_horns","name":"angry face with horns","code":"1F47F"},{"emoji":"đŸ’€","shortcode":"skull","name":"skull","code":"1F480"},{"emoji":"đŸ’©","shortcode":"pile_of_poo","name":"pile of poo","code":"1F4A9"},{"emoji":"đŸ¤¡","shortcode":"clown_face","name":"clown face","code":"1F921"},{"emoji":"đŸ‘¹","shortcode":"ogre","name":"ogre","code":"1F479"},{"emoji":"đŸ‘º","shortcode":"goblin","name":"goblin","code":"1F47A"},{"emoji":"đŸ‘»","shortcode":"ghost","name":"ghost","code":"1F47B"},{"emoji":"đŸ‘½","shortcode":"alien","name":"alien","code":"1F47D"},{"emoji":"đŸ‘¾","shortcode":"alien_monster","name":"alien monster","code":"1F47E"},{"emoji":"đŸ¤–","shortcode":"robot","name":"robot","code":"1F916"},{"emoji":"đŸ˜º","shortcode":"grinning_cat","name":"grinning cat","code":"1F63A"},{"emoji":"đŸ˜¸","shortcode":"grinning_cat_with_smiling_eyes","name":"grinning cat with smiling eyes","code":"1F638"},{"emoji":"đŸ˜¹","shortcode":"cat_with_tears_of_joy","name":"cat with tears of joy","code":"1F639"},{"emoji":"đŸ˜»","shortcode":"smiling_cat_with_heart_eyes","name":"smiling cat with heart-eyes","code":"1F63B"},{"emoji":"đŸ˜¼","shortcode":"cat_with_wry_smile","name":"cat with wry smile","code":"1F63C"},{"emoji":"đŸ˜½","shortcode":"kissing_cat","name":"kissing cat","code":"1F63D"},{"emoji":"đŸ™€","shortcode":"weary_cat","name":"weary cat","code":"1F640"},{"emoji":"đŸ˜¿","shortcode":"crying_cat","name":"crying cat","code":"1F63F"},{"emoji":"đŸ˜¾","shortcode":"pouting_cat","name":"pouting cat","code":"1F63E"},{"emoji":"đŸ™ˆ","shortcode":"see_no_evil_monkey","name":"see-no-evil monkey","code":"1F648"},{"emoji":"đŸ™‰","shortcode":"hear_no_evil_monkey","name":"hear-no-evil monkey","code":"1F649"},{"emoji":"đŸ™","shortcode":"speak_no_evil_monkey","name":"speak-no-evil monkey","code":"1F64A"},{"emoji":"đŸ’‹","shortcode":"kiss_mark","name":"kiss mark","code":"1F48B"},{"emoji":"đŸ’Œ","shortcode":"love_letter","name":"love letter","code":"1F48C"},{"emoji":"đŸ’˜","shortcode":"heart_with_arrow","name":"heart with arrow","code":"1F498"},{"emoji":"đŸ’","shortcode":"heart_with_ribbon","name":"heart with ribbon","code":"1F49D"},{"emoji":"đŸ’–","shortcode":"sparkling_heart","name":"sparkling heart","code":"1F496"},{"emoji":"đŸ’—","shortcode":"growing_heart","name":"growing heart","code":"1F497"},{"emoji":"đŸ’“","shortcode":"beating_heart","name":"beating heart","code":"1F493"},{"emoji":"đŸ’","shortcode":"revolving_hearts","name":"revolving hearts","code":"1F49E"},{"emoji":"đŸ’•","shortcode":"two_hearts","name":"two hearts","code":"1F495"},{"emoji":"đŸ’Ÿ","shortcode":"heart_decoration","name":"heart decoration","code":"1F49F"},{"emoji":"đŸ’”","shortcode":"broken_heart","name":"broken heart","code":"1F494"},{"emoji":"đŸ§¡","shortcode":"orange_heart","name":"orange heart","code":"1F9E1"},{"emoji":"đŸ’›","shortcode":"yellow_heart","name":"yellow heart","code":"1F49B"},{"emoji":"đŸ’","shortcode":"green_heart","name":"green heart","code":"1F49A"},{"emoji":"đŸ’™","shortcode":"blue_heart","name":"blue heart","code":"1F499"},{"emoji":"đŸ’œ","shortcode":"purple_heart","name":"purple heart","code":"1F49C"},{"emoji":"đŸ¤","shortcode":"brown_heart","name":"brown heart","code":"1F90E"},{"emoji":"đŸ–¤","shortcode":"black_heart","name":"black heart","code":"1F5A4"},{"emoji":"đŸ¤","shortcode":"white_heart","name":"white heart","code":"1F90D"},{"emoji":"đŸ’¯","shortcode":"hundred_points","name":"hundred points","code":"1F4AF"},{"emoji":"đŸ’¢","shortcode":"anger_symbol","name":"anger symbol","code":"1F4A2"},{"emoji":"đŸ’¥","shortcode":"collision","name":"collision","code":"1F4A5"},{"emoji":"đŸ’«","shortcode":"dizzy","name":"dizzy","code":"1F4AB"},{"emoji":"đŸ’¦","shortcode":"sweat_droplets","name":"sweat droplets","code":"1F4A6"},{"emoji":"đŸ’¨","shortcode":"dashing_away","name":"dashing away","code":"1F4A8"},{"emoji":"đŸ’£","shortcode":"bomb","name":"bomb","code":"1F4A3"},{"emoji":"đŸ’¬","shortcode":"speech_balloon","name":"speech balloon","code":"1F4AC"},{"emoji":"đŸ’­","shortcode":"thought_balloon","name":"thought balloon","code":"1F4AD"},{"emoji":"đŸ’¤","shortcode":"zzz","name":"zzz","code":"1F4A4"}]},{"group":"Animals & Nature","groupkey":"animals_nature","emojis":[{"emoji":"đŸµ","shortcode":"monkey_face","name":"monkey face","code":"1F435"},{"emoji":"đŸ’","shortcode":"monkey","name":"monkey","code":"1F412"},{"emoji":"đŸ¦","shortcode":"gorilla","name":"gorilla","code":"1F98D"},{"emoji":"đŸ¦§","shortcode":"orangutan","name":"orangutan","code":"1F9A7"},{"emoji":"đŸ¶","shortcode":"dog_face","name":"dog face","code":"1F436"},{"emoji":"đŸ•","shortcode":"dog","name":"dog","code":"1F415"},{"emoji":"đŸ¦®","shortcode":"guide_dog","name":"guide dog","code":"1F9AE"},{"emoji":"đŸ•â€đŸ¦º","shortcode":"service_dog","name":"service dog","code":"1F415-200D-1F9BA"},{"emoji":"đŸ©","shortcode":"poodle","name":"poodle","code":"1F429"},{"emoji":"đŸº","shortcode":"wolf","name":"wolf","code":"1F43A"},{"emoji":"đŸ¦","shortcode":"fox","name":"fox","code":"1F98A"},{"emoji":"đŸ¦","shortcode":"raccoon","name":"raccoon","code":"1F99D"},{"emoji":"đŸ±","shortcode":"cat_face","name":"cat face","code":"1F431"},{"emoji":"đŸˆ","shortcode":"cat","name":"cat","code":"1F408"},{"emoji":"đŸˆâ€â¬›","shortcode":"black_cat","name":"black cat","code":"1F408-200D-2B1B"},{"emoji":"đŸ¦","shortcode":"lion","name":"lion","code":"1F981"},{"emoji":"đŸ¯","shortcode":"tiger_face","name":"tiger face","code":"1F42F"},{"emoji":"đŸ…","shortcode":"tiger","name":"tiger","code":"1F405"},{"emoji":"đŸ†","shortcode":"leopard","name":"leopard","code":"1F406"},{"emoji":"đŸ´","shortcode":"horse_face","name":"horse face","code":"1F434"},{"emoji":"đŸ","shortcode":"horse","name":"horse","code":"1F40E"},{"emoji":"đŸ¦„","shortcode":"unicorn","name":"unicorn","code":"1F984"},{"emoji":"đŸ¦“","shortcode":"zebra","name":"zebra","code":"1F993"},{"emoji":"đŸ¦Œ","shortcode":"deer","name":"deer","code":"1F98C"},{"emoji":"đŸ¦¬","shortcode":"bison","name":"bison","code":"1F9AC"},{"emoji":"đŸ®","shortcode":"cow_face","name":"cow face","code":"1F42E"},{"emoji":"đŸ‚","shortcode":"ox","name":"ox","code":"1F402"},{"emoji":"đŸƒ","shortcode":"water_buffalo","name":"water buffalo","code":"1F403"},{"emoji":"đŸ„","shortcode":"cow","name":"cow","code":"1F404"},{"emoji":"đŸ·","shortcode":"pig_face","name":"pig face","code":"1F437"},{"emoji":"đŸ–","shortcode":"pig","name":"pig","code":"1F416"},{"emoji":"đŸ—","shortcode":"boar","name":"boar","code":"1F417"},{"emoji":"đŸ½","shortcode":"pig_nose","name":"pig nose","code":"1F43D"},{"emoji":"đŸ","shortcode":"ram","name":"ram","code":"1F40F"},{"emoji":"đŸ‘","shortcode":"ewe","name":"ewe","code":"1F411"},{"emoji":"đŸ","shortcode":"goat","name":"goat","code":"1F410"},{"emoji":"đŸª","shortcode":"camel","name":"camel","code":"1F42A"},{"emoji":"đŸ«","shortcode":"two_hump_camel","name":"two-hump camel","code":"1F42B"},{"emoji":"đŸ¦™","shortcode":"llama","name":"llama","code":"1F999"},{"emoji":"đŸ¦’","shortcode":"giraffe","name":"giraffe","code":"1F992"},{"emoji":"đŸ˜","shortcode":"elephant","name":"elephant","code":"1F418"},{"emoji":"đŸ¦£","shortcode":"mammoth","name":"mammoth","code":"1F9A3"},{"emoji":"đŸ¦","shortcode":"rhinoceros","name":"rhinoceros","code":"1F98F"},{"emoji":"đŸ¦›","shortcode":"hippopotamus","name":"hippopotamus","code":"1F99B"},{"emoji":"đŸ­","shortcode":"mouse_face","name":"mouse face","code":"1F42D"},{"emoji":"đŸ","shortcode":"mouse","name":"mouse","code":"1F401"},{"emoji":"đŸ€","shortcode":"rat","name":"rat","code":"1F400"},{"emoji":"đŸ¹","shortcode":"hamster","name":"hamster","code":"1F439"},{"emoji":"đŸ°","shortcode":"rabbit_face","name":"rabbit face","code":"1F430"},{"emoji":"đŸ‡","shortcode":"rabbit","name":"rabbit","code":"1F407"},{"emoji":"đŸ¦«","shortcode":"beaver","name":"beaver","code":"1F9AB"},{"emoji":"đŸ¦”","shortcode":"hedgehog","name":"hedgehog","code":"1F994"},{"emoji":"đŸ¦‡","shortcode":"bat","name":"bat","code":"1F987"},{"emoji":"đŸ»","shortcode":"bear","name":"bear","code":"1F43B"},{"emoji":"đŸ»â€â„ï¸","shortcode":"polar_bear","name":"polar bear","code":"1F43B-200D-2744-FE0F"},{"emoji":"đŸ¨","shortcode":"koala","name":"koala","code":"1F428"},{"emoji":"đŸ¼","shortcode":"panda","name":"panda","code":"1F43C"},{"emoji":"đŸ¦¥","shortcode":"sloth","name":"sloth","code":"1F9A5"},{"emoji":"đŸ¦¦","shortcode":"otter","name":"otter","code":"1F9A6"},{"emoji":"đŸ¦¨","shortcode":"skunk","name":"skunk","code":"1F9A8"},{"emoji":"đŸ¦˜","shortcode":"kangaroo","name":"kangaroo","code":"1F998"},{"emoji":"đŸ¦¡","shortcode":"badger","name":"badger","code":"1F9A1"},{"emoji":"đŸ¾","shortcode":"paw_prints","name":"paw prints","code":"1F43E"},{"emoji":"đŸ¦ƒ","shortcode":"turkey","name":"turkey","code":"1F983"},{"emoji":"đŸ”","shortcode":"chicken","name":"chicken","code":"1F414"},{"emoji":"đŸ“","shortcode":"rooster","name":"rooster","code":"1F413"},{"emoji":"đŸ£","shortcode":"hatching_chick","name":"hatching chick","code":"1F423"},{"emoji":"đŸ¤","shortcode":"baby_chick","name":"baby chick","code":"1F424"},{"emoji":"đŸ¥","shortcode":"front_facing_baby_chick","name":"front-facing baby chick","code":"1F425"},{"emoji":"đŸ¦","shortcode":"bird","name":"bird","code":"1F426"},{"emoji":"đŸ§","shortcode":"penguin","name":"penguin","code":"1F427"},{"emoji":"đŸ¦…","shortcode":"eagle","name":"eagle","code":"1F985"},{"emoji":"đŸ¦†","shortcode":"duck","name":"duck","code":"1F986"},{"emoji":"đŸ¦¢","shortcode":"swan","name":"swan","code":"1F9A2"},{"emoji":"đŸ¦‰","shortcode":"owl","name":"owl","code":"1F989"},{"emoji":"đŸ¦¤","shortcode":"dodo","name":"dodo","code":"1F9A4"},{"emoji":"đŸª¶","shortcode":"feather","name":"feather","code":"1FAB6"},{"emoji":"đŸ¦©","shortcode":"flamingo","name":"flamingo","code":"1F9A9"},{"emoji":"đŸ¦","shortcode":"peacock","name":"peacock","code":"1F99A"},{"emoji":"đŸ¦œ","shortcode":"parrot","name":"parrot","code":"1F99C"},{"emoji":"đŸ¸","shortcode":"frog","name":"frog","code":"1F438"},{"emoji":"đŸ","shortcode":"crocodile","name":"crocodile","code":"1F40A"},{"emoji":"đŸ¢","shortcode":"turtle","name":"turtle","code":"1F422"},{"emoji":"đŸ¦","shortcode":"lizard","name":"lizard","code":"1F98E"},{"emoji":"đŸ","shortcode":"snake","name":"snake","code":"1F40D"},{"emoji":"đŸ²","shortcode":"dragon_face","name":"dragon face","code":"1F432"},{"emoji":"đŸ‰","shortcode":"dragon","name":"dragon","code":"1F409"},{"emoji":"đŸ¦•","shortcode":"sauropod","name":"sauropod","code":"1F995"},{"emoji":"đŸ¦–","shortcode":"t_rex","name":"T-Rex","code":"1F996"},{"emoji":"đŸ³","shortcode":"spouting_whale","name":"spouting whale","code":"1F433"},{"emoji":"đŸ‹","shortcode":"whale","name":"whale","code":"1F40B"},{"emoji":"đŸ¬","shortcode":"dolphin","name":"dolphin","code":"1F42C"},{"emoji":"đŸ¦­","shortcode":"seal","name":"seal","code":"1F9AD"},{"emoji":"đŸŸ","shortcode":"fish","name":"fish","code":"1F41F"},{"emoji":"đŸ ","shortcode":"tropical_fish","name":"tropical fish","code":"1F420"},{"emoji":"đŸ¡","shortcode":"blowfish","name":"blowfish","code":"1F421"},{"emoji":"đŸ¦ˆ","shortcode":"shark","name":"shark","code":"1F988"},{"emoji":"đŸ™","shortcode":"octopus","name":"octopus","code":"1F419"},{"emoji":"đŸ","shortcode":"spiral_shell","name":"spiral shell","code":"1F41A"},{"emoji":"đŸŒ","shortcode":"snail","name":"snail","code":"1F40C"},{"emoji":"đŸ¦‹","shortcode":"butterfly","name":"butterfly","code":"1F98B"},{"emoji":"đŸ›","shortcode":"bug","name":"bug","code":"1F41B"},{"emoji":"đŸœ","shortcode":"ant","name":"ant","code":"1F41C"},{"emoji":"đŸ","shortcode":"honeybee","name":"honeybee","code":"1F41D"},{"emoji":"đŸª²","shortcode":"beetle","name":"beetle","code":"1FAB2"},{"emoji":"đŸ","shortcode":"lady_beetle","name":"lady beetle","code":"1F41E"},{"emoji":"đŸ¦—","shortcode":"cricket","name":"cricket","code":"1F997"},{"emoji":"đŸª³","shortcode":"cockroach","name":"cockroach","code":"1FAB3"},{"emoji":"đŸ¦‚","shortcode":"scorpion","name":"scorpion","code":"1F982"},{"emoji":"đŸ¦Ÿ","shortcode":"mosquito","name":"mosquito","code":"1F99F"},{"emoji":"đŸª°","shortcode":"fly","name":"fly","code":"1FAB0"},{"emoji":"đŸª±","shortcode":"worm","name":"worm","code":"1FAB1"},{"emoji":"đŸ¦ ","shortcode":"microbe","name":"microbe","code":"1F9A0"},{"emoji":"đŸ’","shortcode":"bouquet","name":"bouquet","code":"1F490"},{"emoji":"đŸŒ¸","shortcode":"cherry_blossom","name":"cherry blossom","code":"1F338"},{"emoji":"đŸ’®","shortcode":"white_flower","name":"white flower","code":"1F4AE"},{"emoji":"đŸŒ¹","shortcode":"rose","name":"rose","code":"1F339"},{"emoji":"đŸ¥€","shortcode":"wilted_flower","name":"wilted flower","code":"1F940"},{"emoji":"đŸŒº","shortcode":"hibiscus","name":"hibiscus","code":"1F33A"},{"emoji":"đŸŒ»","shortcode":"sunflower","name":"sunflower","code":"1F33B"},{"emoji":"đŸŒ¼","shortcode":"blossom","name":"blossom","code":"1F33C"},{"emoji":"đŸŒ·","shortcode":"tulip","name":"tulip","code":"1F337"},{"emoji":"đŸŒ±","shortcode":"seedling","name":"seedling","code":"1F331"},{"emoji":"đŸª´","shortcode":"potted_plant","name":"potted plant","code":"1FAB4"},{"emoji":"đŸŒ²","shortcode":"evergreen_tree","name":"evergreen tree","code":"1F332"},{"emoji":"đŸŒ³","shortcode":"deciduous_tree","name":"deciduous tree","code":"1F333"},{"emoji":"đŸŒ´","shortcode":"palm_tree","name":"palm tree","code":"1F334"},{"emoji":"đŸŒµ","shortcode":"cactus","name":"cactus","code":"1F335"},{"emoji":"đŸŒ¾","shortcode":"sheaf_of_rice","name":"sheaf of rice","code":"1F33E"},{"emoji":"đŸŒ¿","shortcode":"herb","name":"herb","code":"1F33F"},{"emoji":"đŸ€","shortcode":"four_leaf_clover","name":"four leaf clover","code":"1F340"},{"emoji":"đŸ","shortcode":"maple_leaf","name":"maple leaf","code":"1F341"},{"emoji":"đŸ‚","shortcode":"fallen_leaf","name":"fallen leaf","code":"1F342"},{"emoji":"đŸƒ","shortcode":"leaf_fluttering_in_wind","name":"leaf fluttering in wind","code":"1F343"}]},{"group":"Food & Drink","groupkey":"food_drink","emojis":[{"emoji":"đŸ‡","shortcode":"grapes","name":"grapes","code":"1F347"},{"emoji":"đŸˆ","shortcode":"melon","name":"melon","code":"1F348"},{"emoji":"đŸ‰","shortcode":"watermelon","name":"watermelon","code":"1F349"},{"emoji":"đŸ","shortcode":"tangerine","name":"tangerine","code":"1F34A"},{"emoji":"đŸ‹","shortcode":"lemon","name":"lemon","code":"1F34B"},{"emoji":"đŸŒ","shortcode":"banana","name":"banana","code":"1F34C"},{"emoji":"đŸ","shortcode":"pineapple","name":"pineapple","code":"1F34D"},{"emoji":"đŸ¥­","shortcode":"mango","name":"mango","code":"1F96D"},{"emoji":"đŸ","shortcode":"red_apple","name":"red apple","code":"1F34E"},{"emoji":"đŸ","shortcode":"green_apple","name":"green apple","code":"1F34F"},{"emoji":"đŸ","shortcode":"pear","name":"pear","code":"1F350"},{"emoji":"đŸ‘","shortcode":"peach","name":"peach","code":"1F351"},{"emoji":"đŸ’","shortcode":"cherries","name":"cherries","code":"1F352"},{"emoji":"đŸ“","shortcode":"strawberry","name":"strawberry","code":"1F353"},{"emoji":"đŸ«","shortcode":"blueberries","name":"blueberries","code":"1FAD0"},{"emoji":"đŸ¥","shortcode":"kiwi_fruit","name":"kiwi fruit","code":"1F95D"},{"emoji":"đŸ…","shortcode":"tomato","name":"tomato","code":"1F345"},{"emoji":"đŸ«’","shortcode":"olive","name":"olive","code":"1FAD2"},{"emoji":"đŸ¥¥","shortcode":"coconut","name":"coconut","code":"1F965"},{"emoji":"đŸ¥‘","shortcode":"avocado","name":"avocado","code":"1F951"},{"emoji":"đŸ†","shortcode":"eggplant","name":"eggplant","code":"1F346"},{"emoji":"đŸ¥”","shortcode":"potato","name":"potato","code":"1F954"},{"emoji":"đŸ¥•","shortcode":"carrot","name":"carrot","code":"1F955"},{"emoji":"đŸŒ½","shortcode":"ear_of_corn","name":"ear of corn","code":"1F33D"},{"emoji":"đŸ«‘","shortcode":"bell_pepper","name":"bell pepper","code":"1FAD1"},{"emoji":"đŸ¥’","shortcode":"cucumber","name":"cucumber","code":"1F952"},{"emoji":"đŸ¥¬","shortcode":"leafy_green","name":"leafy green","code":"1F96C"},{"emoji":"đŸ¥¦","shortcode":"broccoli","name":"broccoli","code":"1F966"},{"emoji":"đŸ§„","shortcode":"garlic","name":"garlic","code":"1F9C4"},{"emoji":"đŸ§…","shortcode":"onion","name":"onion","code":"1F9C5"},{"emoji":"đŸ„","shortcode":"mushroom","name":"mushroom","code":"1F344"},{"emoji":"đŸ¥œ","shortcode":"peanuts","name":"peanuts","code":"1F95C"},{"emoji":"đŸŒ°","shortcode":"chestnut","name":"chestnut","code":"1F330"},{"emoji":"đŸ","shortcode":"bread","name":"bread","code":"1F35E"},{"emoji":"đŸ¥","shortcode":"croissant","name":"croissant","code":"1F950"},{"emoji":"đŸ¥–","shortcode":"baguette_bread","name":"baguette bread","code":"1F956"},{"emoji":"đŸ«“","shortcode":"flatbread","name":"flatbread","code":"1FAD3"},{"emoji":"đŸ¥¨","shortcode":"pretzel","name":"pretzel","code":"1F968"},{"emoji":"đŸ¥¯","shortcode":"bagel","name":"bagel","code":"1F96F"},{"emoji":"đŸ¥","shortcode":"pancakes","name":"pancakes","code":"1F95E"},{"emoji":"đŸ§‡","shortcode":"waffle","name":"waffle","code":"1F9C7"},{"emoji":"đŸ§€","shortcode":"cheese_wedge","name":"cheese wedge","code":"1F9C0"},{"emoji":"đŸ–","shortcode":"meat_on_bone","name":"meat on bone","code":"1F356"},{"emoji":"đŸ—","shortcode":"poultry_leg","name":"poultry leg","code":"1F357"},{"emoji":"đŸ¥©","shortcode":"cut_of_meat","name":"cut of meat","code":"1F969"},{"emoji":"đŸ¥“","shortcode":"bacon","name":"bacon","code":"1F953"},{"emoji":"đŸ”","shortcode":"hamburger","name":"hamburger","code":"1F354"},{"emoji":"đŸŸ","shortcode":"french_fries","name":"french fries","code":"1F35F"},{"emoji":"đŸ•","shortcode":"pizza","name":"pizza","code":"1F355"},{"emoji":"đŸŒ­","shortcode":"hot_dog","name":"hot dog","code":"1F32D"},{"emoji":"đŸ¥ª","shortcode":"sandwich","name":"sandwich","code":"1F96A"},{"emoji":"đŸŒ®","shortcode":"taco","name":"taco","code":"1F32E"},{"emoji":"đŸŒ¯","shortcode":"burrito","name":"burrito","code":"1F32F"},{"emoji":"đŸ«”","shortcode":"tamale","name":"tamale","code":"1FAD4"},{"emoji":"đŸ¥™","shortcode":"stuffed_flatbread","name":"stuffed flatbread","code":"1F959"},{"emoji":"đŸ§†","shortcode":"falafel","name":"falafel","code":"1F9C6"},{"emoji":"đŸ¥","shortcode":"egg","name":"egg","code":"1F95A"},{"emoji":"đŸ³","shortcode":"cooking","name":"cooking","code":"1F373"},{"emoji":"đŸ¥˜","shortcode":"shallow_pan_of_food","name":"shallow pan of food","code":"1F958"},{"emoji":"đŸ²","shortcode":"pot_of_food","name":"pot of food","code":"1F372"},{"emoji":"đŸ«•","shortcode":"fondue","name":"fondue","code":"1FAD5"},{"emoji":"đŸ¥£","shortcode":"bowl_with_spoon","name":"bowl with spoon","code":"1F963"},{"emoji":"đŸ¥—","shortcode":"green_salad","name":"green salad","code":"1F957"},{"emoji":"đŸ¿","shortcode":"popcorn","name":"popcorn","code":"1F37F"},{"emoji":"đŸ§ˆ","shortcode":"butter","name":"butter","code":"1F9C8"},{"emoji":"đŸ§‚","shortcode":"salt","name":"salt","code":"1F9C2"},{"emoji":"đŸ¥«","shortcode":"canned_food","name":"canned food","code":"1F96B"},{"emoji":"đŸ±","shortcode":"bento_box","name":"bento box","code":"1F371"},{"emoji":"đŸ˜","shortcode":"rice_cracker","name":"rice cracker","code":"1F358"},{"emoji":"đŸ™","shortcode":"rice_ball","name":"rice ball","code":"1F359"},{"emoji":"đŸ","shortcode":"cooked_rice","name":"cooked rice","code":"1F35A"},{"emoji":"đŸ›","shortcode":"curry_rice","name":"curry rice","code":"1F35B"},{"emoji":"đŸœ","shortcode":"steaming_bowl","name":"steaming bowl","code":"1F35C"},{"emoji":"đŸ","shortcode":"spaghetti","name":"spaghetti","code":"1F35D"},{"emoji":"đŸ ","shortcode":"roasted_sweet_potato","name":"roasted sweet potato","code":"1F360"},{"emoji":"đŸ¢","shortcode":"oden","name":"oden","code":"1F362"},{"emoji":"đŸ£","shortcode":"sushi","name":"sushi","code":"1F363"},{"emoji":"đŸ¤","shortcode":"fried_shrimp","name":"fried shrimp","code":"1F364"},{"emoji":"đŸ¥","shortcode":"fish_cake_with_swirl","name":"fish cake with swirl","code":"1F365"},{"emoji":"đŸ¥®","shortcode":"moon_cake","name":"moon cake","code":"1F96E"},{"emoji":"đŸ¡","shortcode":"dango","name":"dango","code":"1F361"},{"emoji":"đŸ¥Ÿ","shortcode":"dumpling","name":"dumpling","code":"1F95F"},{"emoji":"đŸ¥ ","shortcode":"fortune_cookie","name":"fortune cookie","code":"1F960"},{"emoji":"đŸ¥¡","shortcode":"takeout_box","name":"takeout box","code":"1F961"},{"emoji":"đŸ¦€","shortcode":"crab","name":"crab","code":"1F980"},{"emoji":"đŸ¦","shortcode":"lobster","name":"lobster","code":"1F99E"},{"emoji":"đŸ¦","shortcode":"shrimp","name":"shrimp","code":"1F990"},{"emoji":"đŸ¦‘","shortcode":"squid","name":"squid","code":"1F991"},{"emoji":"đŸ¦ª","shortcode":"oyster","name":"oyster","code":"1F9AA"},{"emoji":"đŸ¦","shortcode":"soft_ice_cream","name":"soft ice cream","code":"1F366"},{"emoji":"đŸ§","shortcode":"shaved_ice","name":"shaved ice","code":"1F367"},{"emoji":"đŸ¨","shortcode":"ice_cream","name":"ice cream","code":"1F368"},{"emoji":"đŸ©","shortcode":"doughnut","name":"doughnut","code":"1F369"},{"emoji":"đŸª","shortcode":"cookie","name":"cookie","code":"1F36A"},{"emoji":"đŸ‚","shortcode":"birthday_cake","name":"birthday cake","code":"1F382"},{"emoji":"đŸ°","shortcode":"shortcake","name":"shortcake","code":"1F370"},{"emoji":"đŸ§","shortcode":"cupcake","name":"cupcake","code":"1F9C1"},{"emoji":"đŸ¥§","shortcode":"pie","name":"pie","code":"1F967"},{"emoji":"đŸ«","shortcode":"chocolate_bar","name":"chocolate bar","code":"1F36B"},{"emoji":"đŸ¬","shortcode":"candy","name":"candy","code":"1F36C"},{"emoji":"đŸ­","shortcode":"lollipop","name":"lollipop","code":"1F36D"},{"emoji":"đŸ®","shortcode":"custard","name":"custard","code":"1F36E"},{"emoji":"đŸ¯","shortcode":"honey_pot","name":"honey pot","code":"1F36F"},{"emoji":"đŸ¼","shortcode":"baby_bottle","name":"baby bottle","code":"1F37C"},{"emoji":"đŸ¥›","shortcode":"glass_of_milk","name":"glass of milk","code":"1F95B"},{"emoji":"â˜•","shortcode":"hot_beverage","name":"hot beverage","code":"2615"},{"emoji":"đŸ«–","shortcode":"teapot","name":"teapot","code":"1FAD6"},{"emoji":"đŸµ","shortcode":"teacup_without_handle","name":"teacup without handle","code":"1F375"},{"emoji":"đŸ¶","shortcode":"sake","name":"sake","code":"1F376"},{"emoji":"đŸ¾","shortcode":"bottle_with_popping_cork","name":"bottle with popping cork","code":"1F37E"},{"emoji":"đŸ·","shortcode":"wine_glass","name":"wine glass","code":"1F377"},{"emoji":"đŸ¸","shortcode":"cocktail_glass","name":"cocktail glass","code":"1F378"},{"emoji":"đŸ¹","shortcode":"tropical_drink","name":"tropical drink","code":"1F379"},{"emoji":"đŸº","shortcode":"beer_mug","name":"beer mug","code":"1F37A"},{"emoji":"đŸ»","shortcode":"clinking_beer_mugs","name":"clinking beer mugs","code":"1F37B"},{"emoji":"đŸ¥‚","shortcode":"clinking_glasses","name":"clinking glasses","code":"1F942"},{"emoji":"đŸ¥ƒ","shortcode":"tumbler_glass","name":"tumbler glass","code":"1F943"},{"emoji":"đŸ¥¤","shortcode":"cup_with_straw","name":"cup with straw","code":"1F964"},{"emoji":"đŸ§‹","shortcode":"bubble_tea","name":"bubble tea","code":"1F9CB"},{"emoji":"đŸ§ƒ","shortcode":"beverage_box","name":"beverage box","code":"1F9C3"},{"emoji":"đŸ§‰","shortcode":"mate","name":"mate","code":"1F9C9"},{"emoji":"đŸ§","shortcode":"ice","name":"ice","code":"1F9CA"},{"emoji":"đŸ¥¢","shortcode":"chopsticks","name":"chopsticks","code":"1F962"},{"emoji":"đŸ´","shortcode":"fork_and_knife","name":"fork and knife","code":"1F374"},{"emoji":"đŸ¥„","shortcode":"spoon","name":"spoon","code":"1F944"},{"emoji":"đŸ”ª","shortcode":"kitchen_knife","name":"kitchen knife","code":"1F52A"},{"emoji":"đŸº","shortcode":"amphora","name":"amphora","code":"1F3FA"}]},{"group":"Travel & Places","groupkey":"travel_places","emojis":[{"emoji":"đŸŒ","shortcode":"globe_showing_europe_africa","name":"globe showing Europe-Africa","code":"1F30D"},{"emoji":"đŸŒ","shortcode":"globe_showing_americas","name":"globe showing Americas","code":"1F30E"},{"emoji":"đŸŒ","shortcode":"globe_showing_asia_australia","name":"globe showing Asia-Australia","code":"1F30F"},{"emoji":"đŸŒ","shortcode":"globe_with_meridians","name":"globe with meridians","code":"1F310"},{"emoji":"đŸ—¾","shortcode":"map_of_japan","name":"map of Japan","code":"1F5FE"},{"emoji":"đŸ§­","shortcode":"compass","name":"compass","code":"1F9ED"},{"emoji":"đŸŒ‹","shortcode":"volcano","name":"volcano","code":"1F30B"},{"emoji":"đŸ—»","shortcode":"mount_fuji","name":"mount fuji","code":"1F5FB"},{"emoji":"đŸ§±","shortcode":"brick","name":"brick","code":"1F9F1"},{"emoji":"đŸª¨","shortcode":"rock","name":"rock","code":"1FAA8"},{"emoji":"đŸªµ","shortcode":"wood","name":"wood","code":"1FAB5"},{"emoji":"đŸ›–","shortcode":"hut","name":"hut","code":"1F6D6"},{"emoji":"đŸ ","shortcode":"house","name":"house","code":"1F3E0"},{"emoji":"đŸ¡","shortcode":"house_with_garden","name":"house with garden","code":"1F3E1"},{"emoji":"đŸ¢","shortcode":"office_building","name":"office building","code":"1F3E2"},{"emoji":"đŸ£","shortcode":"japanese_post_office","name":"Japanese post office","code":"1F3E3"},{"emoji":"đŸ¤","shortcode":"post_office","name":"post office","code":"1F3E4"},{"emoji":"đŸ¥","shortcode":"hospital","name":"hospital","code":"1F3E5"},{"emoji":"đŸ¦","shortcode":"bank","name":"bank","code":"1F3E6"},{"emoji":"đŸ¨","shortcode":"hotel","name":"hotel","code":"1F3E8"},{"emoji":"đŸ©","shortcode":"love_hotel","name":"love hotel","code":"1F3E9"},{"emoji":"đŸª","shortcode":"convenience_store","name":"convenience store","code":"1F3EA"},{"emoji":"đŸ«","shortcode":"school","name":"school","code":"1F3EB"},{"emoji":"đŸ¬","shortcode":"department_store","name":"department store","code":"1F3EC"},{"emoji":"đŸ­","shortcode":"factory","name":"factory","code":"1F3ED"},{"emoji":"đŸ¯","shortcode":"japanese_castle","name":"Japanese castle","code":"1F3EF"},{"emoji":"đŸ°","shortcode":"castle","name":"castle","code":"1F3F0"},{"emoji":"đŸ’’","shortcode":"wedding","name":"wedding","code":"1F492"},{"emoji":"đŸ—¼","shortcode":"tokyo_tower","name":"Tokyo tower","code":"1F5FC"},{"emoji":"đŸ—½","shortcode":"statue_of_liberty","name":"Statue of Liberty","code":"1F5FD"},{"emoji":"â›ª","shortcode":"church","name":"church","code":"26EA"},{"emoji":"đŸ•Œ","shortcode":"mosque","name":"mosque","code":"1F54C"},{"emoji":"đŸ›•","shortcode":"hindu_temple","name":"hindu temple","code":"1F6D5"},{"emoji":"đŸ•","shortcode":"synagogue","name":"synagogue","code":"1F54D"},{"emoji":"đŸ•‹","shortcode":"kaaba","name":"kaaba","code":"1F54B"},{"emoji":"â›²","shortcode":"fountain","name":"fountain","code":"26F2"},{"emoji":"â›º","shortcode":"tent","name":"tent","code":"26FA"},{"emoji":"đŸŒ","shortcode":"foggy","name":"foggy","code":"1F301"},{"emoji":"đŸŒƒ","shortcode":"night_with_stars","name":"night with stars","code":"1F303"},{"emoji":"đŸŒ„","shortcode":"sunrise_over_mountains","name":"sunrise over mountains","code":"1F304"},{"emoji":"đŸŒ…","shortcode":"sunrise","name":"sunrise","code":"1F305"},{"emoji":"đŸŒ†","shortcode":"cityscape_at_dusk","name":"cityscape at dusk","code":"1F306"},{"emoji":"đŸŒ‡","shortcode":"sunset","name":"sunset","code":"1F307"},{"emoji":"đŸŒ‰","shortcode":"bridge_at_night","name":"bridge at night","code":"1F309"},{"emoji":"đŸ ","shortcode":"carousel_horse","name":"carousel horse","code":"1F3A0"},{"emoji":"đŸ¡","shortcode":"ferris_wheel","name":"ferris wheel","code":"1F3A1"},{"emoji":"đŸ¢","shortcode":"roller_coaster","name":"roller coaster","code":"1F3A2"},{"emoji":"đŸ’ˆ","shortcode":"barber_pole","name":"barber pole","code":"1F488"},{"emoji":"đŸª","shortcode":"circus_tent","name":"circus tent","code":"1F3AA"},{"emoji":"đŸ‚","shortcode":"locomotive","name":"locomotive","code":"1F682"},{"emoji":"đŸƒ","shortcode":"railway_car","name":"railway car","code":"1F683"},{"emoji":"đŸ„","shortcode":"high_speed_train","name":"high-speed train","code":"1F684"},{"emoji":"đŸ…","shortcode":"bullet_train","name":"bullet train","code":"1F685"},{"emoji":"đŸ†","shortcode":"train","name":"train","code":"1F686"},{"emoji":"đŸ‡","shortcode":"metro","name":"metro","code":"1F687"},{"emoji":"đŸˆ","shortcode":"light_rail","name":"light rail","code":"1F688"},{"emoji":"đŸ‰","shortcode":"station","name":"station","code":"1F689"},{"emoji":"đŸ","shortcode":"tram","name":"tram","code":"1F68A"},{"emoji":"đŸ","shortcode":"monorail","name":"monorail","code":"1F69D"},{"emoji":"đŸ","shortcode":"mountain_railway","name":"mountain railway","code":"1F69E"},{"emoji":"đŸ‹","shortcode":"tram_car","name":"tram car","code":"1F68B"},{"emoji":"đŸŒ","shortcode":"bus","name":"bus","code":"1F68C"},{"emoji":"đŸ","shortcode":"oncoming_bus","name":"oncoming bus","code":"1F68D"},{"emoji":"đŸ","shortcode":"trolleybus","name":"trolleybus","code":"1F68E"},{"emoji":"đŸ","shortcode":"minibus","name":"minibus","code":"1F690"},{"emoji":"đŸ‘","shortcode":"ambulance","name":"ambulance","code":"1F691"},{"emoji":"đŸ’","shortcode":"fire_engine","name":"fire engine","code":"1F692"},{"emoji":"đŸ“","shortcode":"police_car","name":"police car","code":"1F693"},{"emoji":"đŸ”","shortcode":"oncoming_police_car","name":"oncoming police car","code":"1F694"},{"emoji":"đŸ•","shortcode":"taxi","name":"taxi","code":"1F695"},{"emoji":"đŸ–","shortcode":"oncoming_taxi","name":"oncoming taxi","code":"1F696"},{"emoji":"đŸ—","shortcode":"automobile","name":"automobile","code":"1F697"},{"emoji":"đŸ˜","shortcode":"oncoming_automobile","name":"oncoming automobile","code":"1F698"},{"emoji":"đŸ™","shortcode":"sport_utility_vehicle","name":"sport utility vehicle","code":"1F699"},{"emoji":"đŸ›»","shortcode":"pickup_truck","name":"pickup truck","code":"1F6FB"},{"emoji":"đŸ","shortcode":"delivery_truck","name":"delivery truck","code":"1F69A"},{"emoji":"đŸ›","shortcode":"articulated_lorry","name":"articulated lorry","code":"1F69B"},{"emoji":"đŸœ","shortcode":"tractor","name":"tractor","code":"1F69C"},{"emoji":"đŸ›µ","shortcode":"motor_scooter","name":"motor scooter","code":"1F6F5"},{"emoji":"đŸ¦½","shortcode":"manual_wheelchair","name":"manual wheelchair","code":"1F9BD"},{"emoji":"đŸ¦¼","shortcode":"motorized_wheelchair","name":"motorized wheelchair","code":"1F9BC"},{"emoji":"đŸ›º","shortcode":"auto_rickshaw","name":"auto rickshaw","code":"1F6FA"},{"emoji":"đŸ²","shortcode":"bicycle","name":"bicycle","code":"1F6B2"},{"emoji":"đŸ›´","shortcode":"kick_scooter","name":"kick scooter","code":"1F6F4"},{"emoji":"đŸ›¹","shortcode":"skateboard","name":"skateboard","code":"1F6F9"},{"emoji":"đŸ›¼","shortcode":"roller_skate","name":"roller skate","code":"1F6FC"},{"emoji":"đŸ","shortcode":"bus_stop","name":"bus stop","code":"1F68F"},{"emoji":"â›½","shortcode":"fuel_pump","name":"fuel pump","code":"26FD"},{"emoji":"đŸ¨","shortcode":"police_car_light","name":"police car light","code":"1F6A8"},{"emoji":"đŸ¥","shortcode":"horizontal_traffic_light","name":"horizontal traffic light","code":"1F6A5"},{"emoji":"đŸ¦","shortcode":"vertical_traffic_light","name":"vertical traffic light","code":"1F6A6"},{"emoji":"đŸ›‘","shortcode":"stop_sign","name":"stop sign","code":"1F6D1"},{"emoji":"đŸ§","shortcode":"construction","name":"construction","code":"1F6A7"},{"emoji":"â“","shortcode":"anchor","name":"anchor","code":"2693"},{"emoji":"â›µ","shortcode":"sailboat","name":"sailboat","code":"26F5"},{"emoji":"đŸ›¶","shortcode":"canoe","name":"canoe","code":"1F6F6"},{"emoji":"đŸ¤","shortcode":"speedboat","name":"speedboat","code":"1F6A4"},{"emoji":"đŸ¢","shortcode":"ship","name":"ship","code":"1F6A2"},{"emoji":"đŸ›«","shortcode":"airplane_departure","name":"airplane departure","code":"1F6EB"},{"emoji":"đŸ›¬","shortcode":"airplane_arrival","name":"airplane arrival","code":"1F6EC"},{"emoji":"đŸª‚","shortcode":"parachute","name":"parachute","code":"1FA82"},{"emoji":"đŸ’º","shortcode":"seat","name":"seat","code":"1F4BA"},{"emoji":"đŸ","shortcode":"helicopter","name":"helicopter","code":"1F681"},{"emoji":"đŸŸ","shortcode":"suspension_railway","name":"suspension railway","code":"1F69F"},{"emoji":"đŸ ","shortcode":"mountain_cableway","name":"mountain cableway","code":"1F6A0"},{"emoji":"đŸ¡","shortcode":"aerial_tramway","name":"aerial tramway","code":"1F6A1"},{"emoji":"đŸ€","shortcode":"rocket","name":"rocket","code":"1F680"},{"emoji":"đŸ›¸","shortcode":"flying_saucer","name":"flying saucer","code":"1F6F8"},{"emoji":"đŸ§³","shortcode":"luggage","name":"luggage","code":"1F9F3"},{"emoji":"âŒ›","shortcode":"hourglass_done","name":"hourglass done","code":"231B"},{"emoji":"â³","shortcode":"hourglass_not_done","name":"hourglass not done","code":"23F3"},{"emoji":"âŒ","shortcode":"watch","name":"watch","code":"231A"},{"emoji":"â°","shortcode":"alarm_clock","name":"alarm clock","code":"23F0"},{"emoji":"đŸ•›","shortcode":"twelve_o_clock","name":"twelve oâ€™clock","code":"1F55B"},{"emoji":"đŸ•§","shortcode":"twelve_thirty","name":"twelve-thirty","code":"1F567"},{"emoji":"đŸ•","shortcode":"one_o_clock","name":"one oâ€™clock","code":"1F550"},{"emoji":"đŸ•œ","shortcode":"one_thirty","name":"one-thirty","code":"1F55C"},{"emoji":"đŸ•‘","shortcode":"two_o_clock","name":"two oâ€™clock","code":"1F551"},{"emoji":"đŸ•","shortcode":"two_thirty","name":"two-thirty","code":"1F55D"},{"emoji":"đŸ•’","shortcode":"three_o_clock","name":"three oâ€™clock","code":"1F552"},{"emoji":"đŸ•","shortcode":"three_thirty","name":"three-thirty","code":"1F55E"},{"emoji":"đŸ•“","shortcode":"four_o_clock","name":"four oâ€™clock","code":"1F553"},{"emoji":"đŸ•Ÿ","shortcode":"four_thirty","name":"four-thirty","code":"1F55F"},{"emoji":"đŸ•”","shortcode":"five_o_clock","name":"five oâ€™clock","code":"1F554"},{"emoji":"đŸ• ","shortcode":"five_thirty","name":"five-thirty","code":"1F560"},{"emoji":"đŸ••","shortcode":"six_o_clock","name":"six oâ€™clock","code":"1F555"},{"emoji":"đŸ•¡","shortcode":"six_thirty","name":"six-thirty","code":"1F561"},{"emoji":"đŸ•–","shortcode":"seven_o_clock","name":"seven oâ€™clock","code":"1F556"},{"emoji":"đŸ•¢","shortcode":"seven_thirty","name":"seven-thirty","code":"1F562"},{"emoji":"đŸ•—","shortcode":"eight_o_clock","name":"eight oâ€™clock","code":"1F557"},{"emoji":"đŸ•£","shortcode":"eight_thirty","name":"eight-thirty","code":"1F563"},{"emoji":"đŸ•˜","shortcode":"nine_o_clock","name":"nine oâ€™clock","code":"1F558"},{"emoji":"đŸ•¤","shortcode":"nine_thirty","name":"nine-thirty","code":"1F564"},{"emoji":"đŸ•™","shortcode":"ten_o_clock","name":"ten oâ€™clock","code":"1F559"},{"emoji":"đŸ•¥","shortcode":"ten_thirty","name":"ten-thirty","code":"1F565"},{"emoji":"đŸ•","shortcode":"eleven_o_clock","name":"eleven oâ€™clock","code":"1F55A"},{"emoji":"đŸ•¦","shortcode":"eleven_thirty","name":"eleven-thirty","code":"1F566"},{"emoji":"đŸŒ‘","shortcode":"new_moon","name":"new moon","code":"1F311"},{"emoji":"đŸŒ’","shortcode":"waxing_crescent_moon","name":"waxing crescent moon","code":"1F312"},{"emoji":"đŸŒ“","shortcode":"first_quarter_moon","name":"first quarter moon","code":"1F313"},{"emoji":"đŸŒ”","shortcode":"waxing_gibbous_moon","name":"waxing gibbous moon","code":"1F314"},{"emoji":"đŸŒ•","shortcode":"full_moon","name":"full moon","code":"1F315"},{"emoji":"đŸŒ–","shortcode":"waning_gibbous_moon","name":"waning gibbous moon","code":"1F316"},{"emoji":"đŸŒ—","shortcode":"last_quarter_moon","name":"last quarter moon","code":"1F317"},{"emoji":"đŸŒ˜","shortcode":"waning_crescent_moon","name":"waning crescent moon","code":"1F318"},{"emoji":"đŸŒ™","shortcode":"crescent_moon","name":"crescent moon","code":"1F319"},{"emoji":"đŸŒ","shortcode":"new_moon_face","name":"new moon face","code":"1F31A"},{"emoji":"đŸŒ›","shortcode":"first_quarter_moon_face","name":"first quarter moon face","code":"1F31B"},{"emoji":"đŸŒœ","shortcode":"last_quarter_moon_face","name":"last quarter moon face","code":"1F31C"},{"emoji":"đŸŒ","shortcode":"full_moon_face","name":"full moon face","code":"1F31D"},{"emoji":"đŸŒ","shortcode":"sun_with_face","name":"sun with face","code":"1F31E"},{"emoji":"đŸª","shortcode":"ringed_planet","name":"ringed planet","code":"1FA90"},{"emoji":"â­","shortcode":"star","name":"star","code":"2B50"},{"emoji":"đŸŒŸ","shortcode":"glowing_star","name":"glowing star","code":"1F31F"},{"emoji":"đŸŒ ","shortcode":"shooting_star","name":"shooting star","code":"1F320"},{"emoji":"đŸŒŒ","shortcode":"milky_way","name":"milky way","code":"1F30C"},{"emoji":"â›…","shortcode":"sun_behind_cloud","name":"sun behind cloud","code":"26C5"},{"emoji":"đŸŒ€","shortcode":"cyclone","name":"cyclone","code":"1F300"},{"emoji":"đŸŒˆ","shortcode":"rainbow","name":"rainbow","code":"1F308"},{"emoji":"đŸŒ‚","shortcode":"closed_umbrella","name":"closed umbrella","code":"1F302"},{"emoji":"â˜”","shortcode":"umbrella_with_rain_drops","name":"umbrella with rain drops","code":"2614"},{"emoji":"â¡","shortcode":"high_voltage","name":"high voltage","code":"26A1"},{"emoji":"â›„","shortcode":"snowman_without_snow","name":"snowman without snow","code":"26C4"},{"emoji":"đŸ”¥","shortcode":"fire","name":"fire","code":"1F525"},{"emoji":"đŸ’§","shortcode":"droplet","name":"droplet","code":"1F4A7"},{"emoji":"đŸŒ","shortcode":"water_wave","name":"water wave","code":"1F30A"}]},{"group":"Activities","groupkey":"activities","emojis":[{"emoji":"đŸƒ","shortcode":"jack_o_lantern","name":"jack-o-lantern","code":"1F383"},{"emoji":"đŸ„","shortcode":"christmas_tree","name":"Christmas tree","code":"1F384"},{"emoji":"đŸ†","shortcode":"fireworks","name":"fireworks","code":"1F386"},{"emoji":"đŸ‡","shortcode":"sparkler","name":"sparkler","code":"1F387"},{"emoji":"đŸ§¨","shortcode":"firecracker","name":"firecracker","code":"1F9E8"},{"emoji":"âœ¨","shortcode":"sparkles","name":"sparkles","code":"2728"},{"emoji":"đŸˆ","shortcode":"balloon","name":"balloon","code":"1F388"},{"emoji":"đŸ‰","shortcode":"party_popper","name":"party popper","code":"1F389"},{"emoji":"đŸ","shortcode":"confetti_ball","name":"confetti ball","code":"1F38A"},{"emoji":"đŸ‹","shortcode":"tanabata_tree","name":"tanabata tree","code":"1F38B"},{"emoji":"đŸ","shortcode":"pine_decoration","name":"pine decoration","code":"1F38D"},{"emoji":"đŸ","shortcode":"japanese_dolls","name":"Japanese dolls","code":"1F38E"},{"emoji":"đŸ","shortcode":"carp_streamer","name":"carp streamer","code":"1F38F"},{"emoji":"đŸ","shortcode":"wind_chime","name":"wind chime","code":"1F390"},{"emoji":"đŸ‘","shortcode":"moon_viewing_ceremony","name":"moon viewing ceremony","code":"1F391"},{"emoji":"đŸ§§","shortcode":"red_envelope","name":"red envelope","code":"1F9E7"},{"emoji":"đŸ€","shortcode":"ribbon","name":"ribbon","code":"1F380"},{"emoji":"đŸ","shortcode":"wrapped_gift","name":"wrapped gift","code":"1F381"},{"emoji":"đŸ«","shortcode":"ticket","name":"ticket","code":"1F3AB"},{"emoji":"đŸ†","shortcode":"trophy","name":"trophy","code":"1F3C6"},{"emoji":"đŸ…","shortcode":"sports_medal","name":"sports medal","code":"1F3C5"},{"emoji":"đŸ¥‡","shortcode":"1st_place_medal","name":"1st place medal","code":"1F947"},{"emoji":"đŸ¥ˆ","shortcode":"2nd_place_medal","name":"2nd place medal","code":"1F948"},{"emoji":"đŸ¥‰","shortcode":"3rd_place_medal","name":"3rd place medal","code":"1F949"},{"emoji":"â½","shortcode":"soccer_ball","name":"soccer ball","code":"26BD"},{"emoji":"â¾","shortcode":"baseball","name":"baseball","code":"26BE"},{"emoji":"đŸ¥","shortcode":"softball","name":"softball","code":"1F94E"},{"emoji":"đŸ€","shortcode":"basketball","name":"basketball","code":"1F3C0"},{"emoji":"đŸ","shortcode":"volleyball","name":"volleyball","code":"1F3D0"},{"emoji":"đŸˆ","shortcode":"american_football","name":"american football","code":"1F3C8"},{"emoji":"đŸ‰","shortcode":"rugby_football","name":"rugby football","code":"1F3C9"},{"emoji":"đŸ¾","shortcode":"tennis","name":"tennis","code":"1F3BE"},{"emoji":"đŸ¥","shortcode":"flying_disc","name":"flying disc","code":"1F94F"},{"emoji":"đŸ³","shortcode":"bowling","name":"bowling","code":"1F3B3"},{"emoji":"đŸ","shortcode":"cricket_game","name":"cricket game","code":"1F3CF"},{"emoji":"đŸ‘","shortcode":"field_hockey","name":"field hockey","code":"1F3D1"},{"emoji":"đŸ’","shortcode":"ice_hockey","name":"ice hockey","code":"1F3D2"},{"emoji":"đŸ¥","shortcode":"lacrosse","name":"lacrosse","code":"1F94D"},{"emoji":"đŸ“","shortcode":"ping_pong","name":"ping pong","code":"1F3D3"},{"emoji":"đŸ¸","shortcode":"badminton","name":"badminton","code":"1F3F8"},{"emoji":"đŸ¥","shortcode":"boxing_glove","name":"boxing glove","code":"1F94A"},{"emoji":"đŸ¥‹","shortcode":"martial_arts_uniform","name":"martial arts uniform","code":"1F94B"},{"emoji":"đŸ¥…","shortcode":"goal_net","name":"goal net","code":"1F945"},{"emoji":"â›³","shortcode":"flag_in_hole","name":"flag in hole","code":"26F3"},{"emoji":"đŸ£","shortcode":"fishing_pole","name":"fishing pole","code":"1F3A3"},{"emoji":"đŸ¤¿","shortcode":"diving_mask","name":"diving mask","code":"1F93F"},{"emoji":"đŸ½","shortcode":"running_shirt","name":"running shirt","code":"1F3BD"},{"emoji":"đŸ¿","shortcode":"skis","name":"skis","code":"1F3BF"},{"emoji":"đŸ›·","shortcode":"sled","name":"sled","code":"1F6F7"},{"emoji":"đŸ¥Œ","shortcode":"curling_stone","name":"curling stone","code":"1F94C"},{"emoji":"đŸ¯","shortcode":"direct_hit","name":"direct hit","code":"1F3AF"},{"emoji":"đŸª€","shortcode":"yo_yo","name":"yo-yo","code":"1FA80"},{"emoji":"đŸª","shortcode":"kite","name":"kite","code":"1FA81"},{"emoji":"đŸ±","shortcode":"pool_8_ball","name":"pool 8 ball","code":"1F3B1"},{"emoji":"đŸ”®","shortcode":"crystal_ball","name":"crystal ball","code":"1F52E"},{"emoji":"đŸª„","shortcode":"magic_wand","name":"magic wand","code":"1FA84"},{"emoji":"đŸ§¿","shortcode":"nazar_amulet","name":"nazar amulet","code":"1F9FF"},{"emoji":"đŸ®","shortcode":"video_game","name":"video game","code":"1F3AE"},{"emoji":"đŸ°","shortcode":"slot_machine","name":"slot machine","code":"1F3B0"},{"emoji":"đŸ²","shortcode":"game_die","name":"game die","code":"1F3B2"},{"emoji":"đŸ§©","shortcode":"puzzle_piece","name":"puzzle piece","code":"1F9E9"},{"emoji":"đŸ§¸","shortcode":"teddy_bear","name":"teddy bear","code":"1F9F8"},{"emoji":"đŸª…","shortcode":"pinata","name":"piĂ±ata","code":"1FA85"},{"emoji":"đŸª†","shortcode":"nesting_dolls","name":"nesting dolls","code":"1FA86"},{"emoji":"đŸƒ","shortcode":"joker","name":"joker","code":"1F0CF"},{"emoji":"đŸ€„","shortcode":"mahjong_red_dragon","name":"mahjong red dragon","code":"1F004"},{"emoji":"đŸ´","shortcode":"flower_playing_cards","name":"flower playing cards","code":"1F3B4"},{"emoji":"đŸ­","shortcode":"performing_arts","name":"performing arts","code":"1F3AD"},{"emoji":"đŸ¨","shortcode":"artist_palette","name":"artist palette","code":"1F3A8"},{"emoji":"đŸ§µ","shortcode":"thread","name":"thread","code":"1F9F5"},{"emoji":"đŸª¡","shortcode":"sewing_needle","name":"sewing needle","code":"1FAA1"},{"emoji":"đŸ§¶","shortcode":"yarn","name":"yarn","code":"1F9F6"},{"emoji":"đŸª¢","shortcode":"knot","name":"knot","code":"1FAA2"}]},{"group":"People & Body","groupkey":"people_body","emojis":[{"emoji":"đŸ‘‹","shortcode":"waving_hand","name":"waving hand","code":"1F44B"},{"emoji":"đŸ¤","shortcode":"raised_back_of_hand","name":"raised back of hand","code":"1F91A"},{"emoji":"âœ‹","shortcode":"raised_hand","name":"raised hand","code":"270B"},{"emoji":"đŸ––","shortcode":"vulcan_salute","name":"vulcan salute","code":"1F596"},{"emoji":"đŸ‘Œ","shortcode":"ok_hand","name":"OK hand","code":"1F44C"},{"emoji":"đŸ¤Œ","shortcode":"pinched_fingers","name":"pinched fingers","code":"1F90C"},{"emoji":"đŸ¤","shortcode":"pinching_hand","name":"pinching hand","code":"1F90F"},{"emoji":"đŸ¤","shortcode":"crossed_fingers","name":"crossed fingers","code":"1F91E"},{"emoji":"đŸ¤Ÿ","shortcode":"love_you_gesture","name":"love-you gesture","code":"1F91F"},{"emoji":"đŸ¤˜","shortcode":"sign_of_the_horns","name":"sign of the horns","code":"1F918"},{"emoji":"đŸ¤™","shortcode":"call_me_hand","name":"call me hand","code":"1F919"},{"emoji":"đŸ‘ˆ","shortcode":"backhand_index_pointing_left","name":"backhand index pointing left","code":"1F448"},{"emoji":"đŸ‘‰","shortcode":"backhand_index_pointing_right","name":"backhand index pointing right","code":"1F449"},{"emoji":"đŸ‘†","shortcode":"backhand_index_pointing_up","name":"backhand index pointing up","code":"1F446"},{"emoji":"đŸ–•","shortcode":"middle_finger","name":"middle finger","code":"1F595"},{"emoji":"đŸ‘‡","shortcode":"backhand_index_pointing_down","name":"backhand index pointing down","code":"1F447"},{"emoji":"đŸ‘","shortcode":"thumbs_up","name":"thumbs up","code":"1F44D"},{"emoji":"đŸ‘","shortcode":"thumbs_down","name":"thumbs down","code":"1F44E"},{"emoji":"âœ","shortcode":"raised_fist","name":"raised fist","code":"270A"},{"emoji":"đŸ‘","shortcode":"oncoming_fist","name":"oncoming fist","code":"1F44A"},{"emoji":"đŸ¤›","shortcode":"left_facing_fist","name":"left-facing fist","code":"1F91B"},{"emoji":"đŸ¤œ","shortcode":"right_facing_fist","name":"right-facing fist","code":"1F91C"},{"emoji":"đŸ‘","shortcode":"clapping_hands","name":"clapping hands","code":"1F44F"},{"emoji":"đŸ™Œ","shortcode":"raising_hands","name":"raising hands","code":"1F64C"},{"emoji":"đŸ‘","shortcode":"open_hands","name":"open hands","code":"1F450"},{"emoji":"đŸ¤²","shortcode":"palms_up_together","name":"palms up together","code":"1F932"},{"emoji":"đŸ¤","shortcode":"handshake","name":"handshake","code":"1F91D"},{"emoji":"đŸ™","shortcode":"folded_hands","name":"folded hands","code":"1F64F"},{"emoji":"đŸ’…","shortcode":"nail_polish","name":"nail polish","code":"1F485"},{"emoji":"đŸ¤³","shortcode":"selfie","name":"selfie","code":"1F933"},{"emoji":"đŸ’ª","shortcode":"flexed_biceps","name":"flexed biceps","code":"1F4AA"},{"emoji":"đŸ¦¾","shortcode":"mechanical_arm","name":"mechanical arm","code":"1F9BE"},{"emoji":"đŸ¦¿","shortcode":"mechanical_leg","name":"mechanical leg","code":"1F9BF"},{"emoji":"đŸ¦µ","shortcode":"leg","name":"leg","code":"1F9B5"},{"emoji":"đŸ¦¶","shortcode":"foot","name":"foot","code":"1F9B6"},{"emoji":"đŸ‘‚","shortcode":"ear","name":"ear","code":"1F442"},{"emoji":"đŸ¦»","shortcode":"ear_with_hearing_aid","name":"ear with hearing aid","code":"1F9BB"},{"emoji":"đŸ‘ƒ","shortcode":"nose","name":"nose","code":"1F443"},{"emoji":"đŸ§ ","shortcode":"brain","name":"brain","code":"1F9E0"},{"emoji":"đŸ«€","shortcode":"anatomical_heart","name":"anatomical heart","code":"1FAC0"},{"emoji":"đŸ«","shortcode":"lungs","name":"lungs","code":"1FAC1"},{"emoji":"đŸ¦·","shortcode":"tooth","name":"tooth","code":"1F9B7"},{"emoji":"đŸ¦´","shortcode":"bone","name":"bone","code":"1F9B4"},{"emoji":"đŸ‘€","shortcode":"eyes","name":"eyes","code":"1F440"},{"emoji":"đŸ‘…","shortcode":"tongue","name":"tongue","code":"1F445"},{"emoji":"đŸ‘„","shortcode":"mouth","name":"mouth","code":"1F444"},{"emoji":"đŸ‘¶","shortcode":"baby","name":"baby","code":"1F476"},{"emoji":"đŸ§’","shortcode":"child","name":"child","code":"1F9D2"},{"emoji":"đŸ‘¦","shortcode":"boy","name":"boy","code":"1F466"},{"emoji":"đŸ‘§","shortcode":"girl","name":"girl","code":"1F467"},{"emoji":"đŸ§‘","shortcode":"person","name":"person","code":"1F9D1"},{"emoji":"đŸ‘±","shortcode":"person_blond_hair","name":"person blond hair","code":"1F471"},{"emoji":"đŸ‘¨","shortcode":"man","name":"man","code":"1F468"},{"emoji":"đŸ§”","shortcode":"person_beard","name":"person beard","code":"1F9D4"},{"emoji":"đŸ‘¨â€đŸ¦°","shortcode":"man_red_hair","name":"man red hair","code":"1F468-200D-1F9B0"},{"emoji":"đŸ‘¨â€đŸ¦±","shortcode":"man_curly_hair","name":"man curly hair","code":"1F468-200D-1F9B1"},{"emoji":"đŸ‘¨â€đŸ¦³","shortcode":"man_white_hair","name":"man white hair","code":"1F468-200D-1F9B3"},{"emoji":"đŸ‘¨â€đŸ¦²","shortcode":"man_bald","name":"man bald","code":"1F468-200D-1F9B2"},{"emoji":"đŸ‘©","shortcode":"woman","name":"woman","code":"1F469"},{"emoji":"đŸ‘©â€đŸ¦°","shortcode":"woman_red_hair","name":"woman red hair","code":"1F469-200D-1F9B0"},{"emoji":"đŸ§‘â€đŸ¦°","shortcode":"person_red_hair","name":"person red hair","code":"1F9D1-200D-1F9B0"},{"emoji":"đŸ‘©â€đŸ¦±","shortcode":"woman_curly_hair","name":"woman curly hair","code":"1F469-200D-1F9B1"},{"emoji":"đŸ§‘â€đŸ¦±","shortcode":"person_curly_hair","name":"person curly hair","code":"1F9D1-200D-1F9B1"},{"emoji":"đŸ‘©â€đŸ¦³","shortcode":"woman_white_hair","name":"woman white hair","code":"1F469-200D-1F9B3"},{"emoji":"đŸ§‘â€đŸ¦³","shortcode":"person_white_hair","name":"person white hair","code":"1F9D1-200D-1F9B3"},{"emoji":"đŸ‘©â€đŸ¦²","shortcode":"woman_bald","name":"woman bald","code":"1F469-200D-1F9B2"},{"emoji":"đŸ§‘â€đŸ¦²","shortcode":"person_bald","name":"person bald","code":"1F9D1-200D-1F9B2"},{"emoji":"đŸ‘±â€â™€ï¸","shortcode":"woman_blond_hair","name":"woman blond hair","code":"1F471-200D-2640-FE0F"},{"emoji":"đŸ‘±â€â™‚ï¸","shortcode":"man_blond_hair","name":"man blond hair","code":"1F471-200D-2642-FE0F"},{"emoji":"đŸ§“","shortcode":"older_person","name":"older person","code":"1F9D3"},{"emoji":"đŸ‘´","shortcode":"old_man","name":"old man","code":"1F474"},{"emoji":"đŸ‘µ","shortcode":"old_woman","name":"old woman","code":"1F475"},{"emoji":"đŸ™","shortcode":"person_frowning","name":"person frowning","code":"1F64D"},{"emoji":"đŸ™â€â™‚ï¸","shortcode":"man_frowning","name":"man frowning","code":"1F64D-200D-2642-FE0F"},{"emoji":"đŸ™â€â™€ï¸","shortcode":"woman_frowning","name":"woman frowning","code":"1F64D-200D-2640-FE0F"},{"emoji":"đŸ™","shortcode":"person_pouting","name":"person pouting","code":"1F64E"},{"emoji":"đŸ™â€â™‚ï¸","shortcode":"man_pouting","name":"man pouting","code":"1F64E-200D-2642-FE0F"},{"emoji":"đŸ™â€â™€ï¸","shortcode":"woman_pouting","name":"woman pouting","code":"1F64E-200D-2640-FE0F"},{"emoji":"đŸ™…","shortcode":"person_gesturing_no","name":"person gesturing NO","code":"1F645"},{"emoji":"đŸ™…â€â™‚ï¸","shortcode":"man_gesturing_no","name":"man gesturing NO","code":"1F645-200D-2642-FE0F"},{"emoji":"đŸ™…â€â™€ï¸","shortcode":"woman_gesturing_no","name":"woman gesturing NO","code":"1F645-200D-2640-FE0F"},{"emoji":"đŸ™†","shortcode":"person_gesturing_ok","name":"person gesturing OK","code":"1F646"},{"emoji":"đŸ™†â€â™‚ï¸","shortcode":"man_gesturing_ok","name":"man gesturing OK","code":"1F646-200D-2642-FE0F"},{"emoji":"đŸ™†â€â™€ï¸","shortcode":"woman_gesturing_ok","name":"woman gesturing OK","code":"1F646-200D-2640-FE0F"},{"emoji":"đŸ’","shortcode":"person_tipping_hand","name":"person tipping hand","code":"1F481"},{"emoji":"đŸ’â€â™‚ï¸","shortcode":"man_tipping_hand","name":"man tipping hand","code":"1F481-200D-2642-FE0F"},{"emoji":"đŸ’â€â™€ï¸","shortcode":"woman_tipping_hand","name":"woman tipping hand","code":"1F481-200D-2640-FE0F"},{"emoji":"đŸ™‹","shortcode":"person_raising_hand","name":"person raising hand","code":"1F64B"},{"emoji":"đŸ™‹â€â™‚ï¸","shortcode":"man_raising_hand","name":"man raising hand","code":"1F64B-200D-2642-FE0F"},{"emoji":"đŸ™‹â€â™€ï¸","shortcode":"woman_raising_hand","name":"woman raising hand","code":"1F64B-200D-2640-FE0F"},{"emoji":"đŸ§","shortcode":"deaf_person","name":"deaf person","code":"1F9CF"},{"emoji":"đŸ§â€â™‚ï¸","shortcode":"deaf_man","name":"deaf man","code":"1F9CF-200D-2642-FE0F"},{"emoji":"đŸ§â€â™€ï¸","shortcode":"deaf_woman","name":"deaf woman","code":"1F9CF-200D-2640-FE0F"},{"emoji":"đŸ™‡","shortcode":"person_bowing","name":"person bowing","code":"1F647"},{"emoji":"đŸ™‡â€â™‚ï¸","shortcode":"man_bowing","name":"man bowing","code":"1F647-200D-2642-FE0F"},{"emoji":"đŸ™‡â€â™€ï¸","shortcode":"woman_bowing","name":"woman bowing","code":"1F647-200D-2640-FE0F"},{"emoji":"đŸ¤¦","shortcode":"person_facepalming","name":"person facepalming","code":"1F926"},{"emoji":"đŸ¤¦â€â™‚ï¸","shortcode":"man_facepalming","name":"man facepalming","code":"1F926-200D-2642-FE0F"},{"emoji":"đŸ¤¦â€â™€ï¸","shortcode":"woman_facepalming","name":"woman facepalming","code":"1F926-200D-2640-FE0F"},{"emoji":"đŸ¤·","shortcode":"person_shrugging","name":"person shrugging","code":"1F937"},{"emoji":"đŸ¤·â€â™‚ï¸","shortcode":"man_shrugging","name":"man shrugging","code":"1F937-200D-2642-FE0F"},{"emoji":"đŸ¤·â€â™€ï¸","shortcode":"woman_shrugging","name":"woman shrugging","code":"1F937-200D-2640-FE0F"},{"emoji":"đŸ§‘â€â•ï¸","shortcode":"health_worker","name":"health worker","code":"1F9D1-200D-2695-FE0F"},{"emoji":"đŸ‘¨â€â•ï¸","shortcode":"man_health_worker","name":"man health worker","code":"1F468-200D-2695-FE0F"},{"emoji":"đŸ‘©â€â•ï¸","shortcode":"woman_health_worker","name":"woman health worker","code":"1F469-200D-2695-FE0F"},{"emoji":"đŸ§‘â€đŸ“","shortcode":"student","name":"student","code":"1F9D1-200D-1F393"},{"emoji":"đŸ‘¨â€đŸ“","shortcode":"man_student","name":"man student","code":"1F468-200D-1F393"},{"emoji":"đŸ‘©â€đŸ“","shortcode":"woman_student","name":"woman student","code":"1F469-200D-1F393"},{"emoji":"đŸ§‘â€đŸ«","shortcode":"teacher","name":"teacher","code":"1F9D1-200D-1F3EB"},{"emoji":"đŸ‘¨â€đŸ«","shortcode":"man_teacher","name":"man teacher","code":"1F468-200D-1F3EB"},{"emoji":"đŸ‘©â€đŸ«","shortcode":"woman_teacher","name":"woman teacher","code":"1F469-200D-1F3EB"},{"emoji":"đŸ§‘â€â–ï¸","shortcode":"judge","name":"judge","code":"1F9D1-200D-2696-FE0F"},{"emoji":"đŸ‘¨â€â–ï¸","shortcode":"man_judge","name":"man judge","code":"1F468-200D-2696-FE0F"},{"emoji":"đŸ‘©â€â–ï¸","shortcode":"woman_judge","name":"woman judge","code":"1F469-200D-2696-FE0F"},{"emoji":"đŸ§‘â€đŸŒ¾","shortcode":"farmer","name":"farmer","code":"1F9D1-200D-1F33E"},{"emoji":"đŸ‘¨â€đŸŒ¾","shortcode":"man_farmer","name":"man farmer","code":"1F468-200D-1F33E"},{"emoji":"đŸ‘©â€đŸŒ¾","shortcode":"woman_farmer","name":"woman farmer","code":"1F469-200D-1F33E"},{"emoji":"đŸ§‘â€đŸ³","shortcode":"cook","name":"cook","code":"1F9D1-200D-1F373"},{"emoji":"đŸ‘¨â€đŸ³","shortcode":"man_cook","name":"man cook","code":"1F468-200D-1F373"},{"emoji":"đŸ‘©â€đŸ³","shortcode":"woman_cook","name":"woman cook","code":"1F469-200D-1F373"},{"emoji":"đŸ§‘â€đŸ”§","shortcode":"mechanic","name":"mechanic","code":"1F9D1-200D-1F527"},{"emoji":"đŸ‘¨â€đŸ”§","shortcode":"man_mechanic","name":"man mechanic","code":"1F468-200D-1F527"},{"emoji":"đŸ‘©â€đŸ”§","shortcode":"woman_mechanic","name":"woman mechanic","code":"1F469-200D-1F527"},{"emoji":"đŸ§‘â€đŸ­","shortcode":"factory_worker","name":"factory worker","code":"1F9D1-200D-1F3ED"},{"emoji":"đŸ‘¨â€đŸ­","shortcode":"man_factory_worker","name":"man factory worker","code":"1F468-200D-1F3ED"},{"emoji":"đŸ‘©â€đŸ­","shortcode":"woman_factory_worker","name":"woman factory worker","code":"1F469-200D-1F3ED"},{"emoji":"đŸ§‘â€đŸ’¼","shortcode":"office_worker","name":"office worker","code":"1F9D1-200D-1F4BC"},{"emoji":"đŸ‘¨â€đŸ’¼","shortcode":"man_office_worker","name":"man office worker","code":"1F468-200D-1F4BC"},{"emoji":"đŸ‘©â€đŸ’¼","shortcode":"woman_office_worker","name":"woman office worker","code":"1F469-200D-1F4BC"},{"emoji":"đŸ§‘â€đŸ”¬","shortcode":"scientist","name":"scientist","code":"1F9D1-200D-1F52C"},{"emoji":"đŸ‘¨â€đŸ”¬","shortcode":"man_scientist","name":"man scientist","code":"1F468-200D-1F52C"},{"emoji":"đŸ‘©â€đŸ”¬","shortcode":"woman_scientist","name":"woman scientist","code":"1F469-200D-1F52C"},{"emoji":"đŸ§‘â€đŸ’»","shortcode":"technologist","name":"technologist","code":"1F9D1-200D-1F4BB"},{"emoji":"đŸ‘¨â€đŸ’»","shortcode":"man_technologist","name":"man technologist","code":"1F468-200D-1F4BB"},{"emoji":"đŸ‘©â€đŸ’»","shortcode":"woman_technologist","name":"woman technologist","code":"1F469-200D-1F4BB"},{"emoji":"đŸ§‘â€đŸ¤","shortcode":"singer","name":"singer","code":"1F9D1-200D-1F3A4"},{"emoji":"đŸ‘¨â€đŸ¤","shortcode":"man_singer","name":"man singer","code":"1F468-200D-1F3A4"},{"emoji":"đŸ‘©â€đŸ¤","shortcode":"woman_singer","name":"woman singer","code":"1F469-200D-1F3A4"},{"emoji":"đŸ§‘â€đŸ¨","shortcode":"artist","name":"artist","code":"1F9D1-200D-1F3A8"},{"emoji":"đŸ‘¨â€đŸ¨","shortcode":"man_artist","name":"man artist","code":"1F468-200D-1F3A8"},{"emoji":"đŸ‘©â€đŸ¨","shortcode":"woman_artist","name":"woman artist","code":"1F469-200D-1F3A8"},{"emoji":"đŸ§‘â€âœˆï¸","shortcode":"pilot","name":"pilot","code":"1F9D1-200D-2708-FE0F"},{"emoji":"đŸ‘¨â€âœˆï¸","shortcode":"man_pilot","name":"man pilot","code":"1F468-200D-2708-FE0F"},{"emoji":"đŸ‘©â€âœˆï¸","shortcode":"woman_pilot","name":"woman pilot","code":"1F469-200D-2708-FE0F"},{"emoji":"đŸ§‘â€đŸ€","shortcode":"astronaut","name":"astronaut","code":"1F9D1-200D-1F680"},{"emoji":"đŸ‘¨â€đŸ€","shortcode":"man_astronaut","name":"man astronaut","code":"1F468-200D-1F680"},{"emoji":"đŸ‘©â€đŸ€","shortcode":"woman_astronaut","name":"woman astronaut","code":"1F469-200D-1F680"},{"emoji":"đŸ§‘â€đŸ’","shortcode":"firefighter","name":"firefighter","code":"1F9D1-200D-1F692"},{"emoji":"đŸ‘¨â€đŸ’","shortcode":"man_firefighter","name":"man firefighter","code":"1F468-200D-1F692"},{"emoji":"đŸ‘©â€đŸ’","shortcode":"woman_firefighter","name":"woman firefighter","code":"1F469-200D-1F692"},{"emoji":"đŸ‘®","shortcode":"police_officer","name":"police officer","code":"1F46E"},{"emoji":"đŸ‘®â€â™‚ï¸","shortcode":"man_police_officer","name":"man police officer","code":"1F46E-200D-2642-FE0F"},{"emoji":"đŸ‘®â€â™€ï¸","shortcode":"woman_police_officer","name":"woman police officer","code":"1F46E-200D-2640-FE0F"},{"emoji":"đŸ•µï¸â€â™‚ï¸","shortcode":"man_detective","name":"man detective","code":"1F575-FE0F-200D-2642-FE0F"},{"emoji":"đŸ•µï¸â€â™€ï¸","shortcode":"woman_detective","name":"woman detective","code":"1F575-FE0F-200D-2640-FE0F"},{"emoji":"đŸ’‚","shortcode":"guard","name":"guard","code":"1F482"},{"emoji":"đŸ’‚â€â™‚ï¸","shortcode":"man_guard","name":"man guard","code":"1F482-200D-2642-FE0F"},{"emoji":"đŸ’‚â€â™€ï¸","shortcode":"woman_guard","name":"woman guard","code":"1F482-200D-2640-FE0F"},{"emoji":"đŸ¥·","shortcode":"ninja","name":"ninja","code":"1F977"},{"emoji":"đŸ‘·","shortcode":"construction_worker","name":"construction worker","code":"1F477"},{"emoji":"đŸ‘·â€â™‚ï¸","shortcode":"man_construction_worker","name":"man construction worker","code":"1F477-200D-2642-FE0F"},{"emoji":"đŸ‘·â€â™€ï¸","shortcode":"woman_construction_worker","name":"woman construction worker","code":"1F477-200D-2640-FE0F"},{"emoji":"đŸ¤´","shortcode":"prince","name":"prince","code":"1F934"},{"emoji":"đŸ‘¸","shortcode":"princess","name":"princess","code":"1F478"},{"emoji":"đŸ‘³","shortcode":"person_wearing_turban","name":"person wearing turban","code":"1F473"},{"emoji":"đŸ‘³â€â™‚ï¸","shortcode":"man_wearing_turban","name":"man wearing turban","code":"1F473-200D-2642-FE0F"},{"emoji":"đŸ‘³â€â™€ï¸","shortcode":"woman_wearing_turban","name":"woman wearing turban","code":"1F473-200D-2640-FE0F"},{"emoji":"đŸ‘²","shortcode":"person_with_skullcap","name":"person with skullcap","code":"1F472"},{"emoji":"đŸ§•","shortcode":"woman_with_headscarf","name":"woman with headscarf","code":"1F9D5"},{"emoji":"đŸ¤µ","shortcode":"person_in_tuxedo","name":"person in tuxedo","code":"1F935"},{"emoji":"đŸ¤µâ€â™‚ï¸","shortcode":"man_in_tuxedo","name":"man in tuxedo","code":"1F935-200D-2642-FE0F"},{"emoji":"đŸ¤µâ€â™€ï¸","shortcode":"woman_in_tuxedo","name":"woman in tuxedo","code":"1F935-200D-2640-FE0F"},{"emoji":"đŸ‘°","shortcode":"person_with_veil","name":"person with veil","code":"1F470"},{"emoji":"đŸ‘°â€â™‚ï¸","shortcode":"man_with_veil","name":"man with veil","code":"1F470-200D-2642-FE0F"},{"emoji":"đŸ‘°â€â™€ï¸","shortcode":"woman_with_veil","name":"woman with veil","code":"1F470-200D-2640-FE0F"},{"emoji":"đŸ¤°","shortcode":"pregnant_woman","name":"pregnant woman","code":"1F930"},{"emoji":"đŸ¤±","shortcode":"breast_feeding","name":"breast-feeding","code":"1F931"},{"emoji":"đŸ‘©â€đŸ¼","shortcode":"woman_feeding_baby","name":"woman feeding baby","code":"1F469-200D-1F37C"},{"emoji":"đŸ‘¨â€đŸ¼","shortcode":"man_feeding_baby","name":"man feeding baby","code":"1F468-200D-1F37C"},{"emoji":"đŸ§‘â€đŸ¼","shortcode":"person_feeding_baby","name":"person feeding baby","code":"1F9D1-200D-1F37C"},{"emoji":"đŸ‘¼","shortcode":"baby_angel","name":"baby angel","code":"1F47C"},{"emoji":"đŸ…","shortcode":"santa_claus","name":"Santa Claus","code":"1F385"},{"emoji":"đŸ¤¶","shortcode":"mrs_claus","name":"Mrs. Claus","code":"1F936"},{"emoji":"đŸ§‘â€đŸ„","shortcode":"mx_claus","name":"mx claus","code":"1F9D1-200D-1F384"},{"emoji":"đŸ¦¸","shortcode":"superhero","name":"superhero","code":"1F9B8"},{"emoji":"đŸ¦¸â€â™‚ï¸","shortcode":"man_superhero","name":"man superhero","code":"1F9B8-200D-2642-FE0F"},{"emoji":"đŸ¦¸â€â™€ï¸","shortcode":"woman_superhero","name":"woman superhero","code":"1F9B8-200D-2640-FE0F"},{"emoji":"đŸ¦¹","shortcode":"supervillain","name":"supervillain","code":"1F9B9"},{"emoji":"đŸ¦¹â€â™‚ï¸","shortcode":"man_supervillain","name":"man supervillain","code":"1F9B9-200D-2642-FE0F"},{"emoji":"đŸ¦¹â€â™€ï¸","shortcode":"woman_supervillain","name":"woman supervillain","code":"1F9B9-200D-2640-FE0F"},{"emoji":"đŸ§™","shortcode":"mage","name":"mage","code":"1F9D9"},{"emoji":"đŸ§™â€â™‚ï¸","shortcode":"man_mage","name":"man mage","code":"1F9D9-200D-2642-FE0F"},{"emoji":"đŸ§™â€â™€ï¸","shortcode":"woman_mage","name":"woman mage","code":"1F9D9-200D-2640-FE0F"},{"emoji":"đŸ§","shortcode":"fairy","name":"fairy","code":"1F9DA"},{"emoji":"đŸ§â€â™‚ï¸","shortcode":"man_fairy","name":"man fairy","code":"1F9DA-200D-2642-FE0F"},{"emoji":"đŸ§â€â™€ï¸","shortcode":"woman_fairy","name":"woman fairy","code":"1F9DA-200D-2640-FE0F"},{"emoji":"đŸ§›","shortcode":"vampire","name":"vampire","code":"1F9DB"},{"emoji":"đŸ§›â€â™‚ï¸","shortcode":"man_vampire","name":"man vampire","code":"1F9DB-200D-2642-FE0F"},{"emoji":"đŸ§›â€â™€ï¸","shortcode":"woman_vampire","name":"woman vampire","code":"1F9DB-200D-2640-FE0F"},{"emoji":"đŸ§œ","shortcode":"merperson","name":"merperson","code":"1F9DC"},{"emoji":"đŸ§œâ€â™‚ï¸","shortcode":"merman","name":"merman","code":"1F9DC-200D-2642-FE0F"},{"emoji":"đŸ§œâ€â™€ï¸","shortcode":"mermaid","name":"mermaid","code":"1F9DC-200D-2640-FE0F"},{"emoji":"đŸ§","shortcode":"elf","name":"elf","code":"1F9DD"},{"emoji":"đŸ§â€â™‚ï¸","shortcode":"man_elf","name":"man elf","code":"1F9DD-200D-2642-FE0F"},{"emoji":"đŸ§â€â™€ï¸","shortcode":"woman_elf","name":"woman elf","code":"1F9DD-200D-2640-FE0F"},{"emoji":"đŸ§","shortcode":"genie","name":"genie","code":"1F9DE"},{"emoji":"đŸ§â€â™‚ï¸","shortcode":"man_genie","name":"man genie","code":"1F9DE-200D-2642-FE0F"},{"emoji":"đŸ§â€â™€ï¸","shortcode":"woman_genie","name":"woman genie","code":"1F9DE-200D-2640-FE0F"},{"emoji":"đŸ§Ÿ","shortcode":"zombie","name":"zombie","code":"1F9DF"},{"emoji":"đŸ§Ÿâ€â™‚ï¸","shortcode":"man_zombie","name":"man zombie","code":"1F9DF-200D-2642-FE0F"},{"emoji":"đŸ§Ÿâ€â™€ï¸","shortcode":"woman_zombie","name":"woman zombie","code":"1F9DF-200D-2640-FE0F"},{"emoji":"đŸ’†","shortcode":"person_getting_massage","name":"person getting massage","code":"1F486"},{"emoji":"đŸ’†â€â™‚ï¸","shortcode":"man_getting_massage","name":"man getting massage","code":"1F486-200D-2642-FE0F"},{"emoji":"đŸ’†â€â™€ï¸","shortcode":"woman_getting_massage","name":"woman getting massage","code":"1F486-200D-2640-FE0F"},{"emoji":"đŸ’‡","shortcode":"person_getting_haircut","name":"person getting haircut","code":"1F487"},{"emoji":"đŸ’‡â€â™‚ï¸","shortcode":"man_getting_haircut","name":"man getting haircut","code":"1F487-200D-2642-FE0F"},{"emoji":"đŸ’‡â€â™€ï¸","shortcode":"woman_getting_haircut","name":"woman getting haircut","code":"1F487-200D-2640-FE0F"},{"emoji":"đŸ¶","shortcode":"person_walking","name":"person walking","code":"1F6B6"},{"emoji":"đŸ¶â€â™‚ï¸","shortcode":"man_walking","name":"man walking","code":"1F6B6-200D-2642-FE0F"},{"emoji":"đŸ¶â€â™€ï¸","shortcode":"woman_walking","name":"woman walking","code":"1F6B6-200D-2640-FE0F"},{"emoji":"đŸ§","shortcode":"person_standing","name":"person standing","code":"1F9CD"},{"emoji":"đŸ§â€â™‚ï¸","shortcode":"man_standing","name":"man standing","code":"1F9CD-200D-2642-FE0F"},{"emoji":"đŸ§â€â™€ï¸","shortcode":"woman_standing","name":"woman standing","code":"1F9CD-200D-2640-FE0F"},{"emoji":"đŸ§","shortcode":"person_kneeling","name":"person kneeling","code":"1F9CE"},{"emoji":"đŸ§â€â™‚ï¸","shortcode":"man_kneeling","name":"man kneeling","code":"1F9CE-200D-2642-FE0F"},{"emoji":"đŸ§â€â™€ï¸","shortcode":"woman_kneeling","name":"woman kneeling","code":"1F9CE-200D-2640-FE0F"},{"emoji":"đŸ§‘â€đŸ¦¯","shortcode":"person_with_white_cane","name":"person with white cane","code":"1F9D1-200D-1F9AF"},{"emoji":"đŸ‘¨â€đŸ¦¯","shortcode":"man_with_white_cane","name":"man with white cane","code":"1F468-200D-1F9AF"},{"emoji":"đŸ‘©â€đŸ¦¯","shortcode":"woman_with_white_cane","name":"woman with white cane","code":"1F469-200D-1F9AF"},{"emoji":"đŸ§‘â€đŸ¦¼","shortcode":"person_in_motorized_wheelchair","name":"person in motorized wheelchair","code":"1F9D1-200D-1F9BC"},{"emoji":"đŸ‘¨â€đŸ¦¼","shortcode":"man_in_motorized_wheelchair","name":"man in motorized wheelchair","code":"1F468-200D-1F9BC"},{"emoji":"đŸ‘©â€đŸ¦¼","shortcode":"woman_in_motorized_wheelchair","name":"woman in motorized wheelchair","code":"1F469-200D-1F9BC"},{"emoji":"đŸ§‘â€đŸ¦½","shortcode":"person_in_manual_wheelchair","name":"person in manual wheelchair","code":"1F9D1-200D-1F9BD"},{"emoji":"đŸ‘¨â€đŸ¦½","shortcode":"man_in_manual_wheelchair","name":"man in manual wheelchair","code":"1F468-200D-1F9BD"},{"emoji":"đŸ‘©â€đŸ¦½","shortcode":"woman_in_manual_wheelchair","name":"woman in manual wheelchair","code":"1F469-200D-1F9BD"},{"emoji":"đŸƒ","shortcode":"person_running","name":"person running","code":"1F3C3"},{"emoji":"đŸƒâ€â™‚ï¸","shortcode":"man_running","name":"man running","code":"1F3C3-200D-2642-FE0F"},{"emoji":"đŸƒâ€â™€ï¸","shortcode":"woman_running","name":"woman running","code":"1F3C3-200D-2640-FE0F"},{"emoji":"đŸ’ƒ","shortcode":"woman_dancing","name":"woman dancing","code":"1F483"},{"emoji":"đŸ•º","shortcode":"man_dancing","name":"man dancing","code":"1F57A"},{"emoji":"đŸ‘¯","shortcode":"people_with_bunny_ears","name":"people with bunny ears","code":"1F46F"},{"emoji":"đŸ‘¯â€â™‚ï¸","shortcode":"men_with_bunny_ears","name":"men with bunny ears","code":"1F46F-200D-2642-FE0F"},{"emoji":"đŸ‘¯â€â™€ï¸","shortcode":"women_with_bunny_ears","name":"women with bunny ears","code":"1F46F-200D-2640-FE0F"},{"emoji":"đŸ§–","shortcode":"person_in_steamy_room","name":"person in steamy room","code":"1F9D6"},{"emoji":"đŸ§–â€â™‚ï¸","shortcode":"man_in_steamy_room","name":"man in steamy room","code":"1F9D6-200D-2642-FE0F"},{"emoji":"đŸ§–â€â™€ï¸","shortcode":"woman_in_steamy_room","name":"woman in steamy room","code":"1F9D6-200D-2640-FE0F"},{"emoji":"đŸ§—","shortcode":"person_climbing","name":"person climbing","code":"1F9D7"},{"emoji":"đŸ§—â€â™‚ï¸","shortcode":"man_climbing","name":"man climbing","code":"1F9D7-200D-2642-FE0F"},{"emoji":"đŸ§—â€â™€ï¸","shortcode":"woman_climbing","name":"woman climbing","code":"1F9D7-200D-2640-FE0F"},{"emoji":"đŸ¤º","shortcode":"person_fencing","name":"person fencing","code":"1F93A"},{"emoji":"đŸ‡","shortcode":"horse_racing","name":"horse racing","code":"1F3C7"},{"emoji":"đŸ‚","shortcode":"snowboarder","name":"snowboarder","code":"1F3C2"},{"emoji":"đŸŒï¸â€â™‚ï¸","shortcode":"man_golfing","name":"man golfing","code":"1F3CC-FE0F-200D-2642-FE0F"},{"emoji":"đŸŒï¸â€â™€ï¸","shortcode":"woman_golfing","name":"woman golfing","code":"1F3CC-FE0F-200D-2640-FE0F"},{"emoji":"đŸ„","shortcode":"person_surfing","name":"person surfing","code":"1F3C4"},{"emoji":"đŸ„â€â™‚ï¸","shortcode":"man_surfing","name":"man surfing","code":"1F3C4-200D-2642-FE0F"},{"emoji":"đŸ„â€â™€ï¸","shortcode":"woman_surfing","name":"woman surfing","code":"1F3C4-200D-2640-FE0F"},{"emoji":"đŸ£","shortcode":"person_rowing_boat","name":"person rowing boat","code":"1F6A3"},{"emoji":"đŸ£â€â™‚ï¸","shortcode":"man_rowing_boat","name":"man rowing boat","code":"1F6A3-200D-2642-FE0F"},{"emoji":"đŸ£â€â™€ï¸","shortcode":"woman_rowing_boat","name":"woman rowing boat","code":"1F6A3-200D-2640-FE0F"},{"emoji":"đŸ","shortcode":"person_swimming","name":"person swimming","code":"1F3CA"},{"emoji":"đŸâ€â™‚ï¸","shortcode":"man_swimming","name":"man swimming","code":"1F3CA-200D-2642-FE0F"},{"emoji":"đŸâ€â™€ï¸","shortcode":"woman_swimming","name":"woman swimming","code":"1F3CA-200D-2640-FE0F"},{"emoji":"â›¹ï¸â€â™‚ï¸","shortcode":"man_bouncing_ball","name":"man bouncing ball","code":"26F9-FE0F-200D-2642-FE0F"},{"emoji":"â›¹ï¸â€â™€ï¸","shortcode":"woman_bouncing_ball","name":"woman bouncing ball","code":"26F9-FE0F-200D-2640-FE0F"},{"emoji":"đŸ‹ï¸â€â™‚ï¸","shortcode":"man_lifting_weights","name":"man lifting weights","code":"1F3CB-FE0F-200D-2642-FE0F"},{"emoji":"đŸ‹ï¸â€â™€ï¸","shortcode":"woman_lifting_weights","name":"woman lifting weights","code":"1F3CB-FE0F-200D-2640-FE0F"},{"emoji":"đŸ´","shortcode":"person_biking","name":"person biking","code":"1F6B4"},{"emoji":"đŸ´â€â™‚ï¸","shortcode":"man_biking","name":"man biking","code":"1F6B4-200D-2642-FE0F"},{"emoji":"đŸ´â€â™€ï¸","shortcode":"woman_biking","name":"woman biking","code":"1F6B4-200D-2640-FE0F"},{"emoji":"đŸµ","shortcode":"person_mountain_biking","name":"person mountain biking","code":"1F6B5"},{"emoji":"đŸµâ€â™‚ï¸","shortcode":"man_mountain_biking","name":"man mountain biking","code":"1F6B5-200D-2642-FE0F"},{"emoji":"đŸµâ€â™€ï¸","shortcode":"woman_mountain_biking","name":"woman mountain biking","code":"1F6B5-200D-2640-FE0F"},{"emoji":"đŸ¤¸","shortcode":"person_cartwheeling","name":"person cartwheeling","code":"1F938"},{"emoji":"đŸ¤¸â€â™‚ï¸","shortcode":"man_cartwheeling","name":"man cartwheeling","code":"1F938-200D-2642-FE0F"},{"emoji":"đŸ¤¸â€â™€ï¸","shortcode":"woman_cartwheeling","name":"woman cartwheeling","code":"1F938-200D-2640-FE0F"},{"emoji":"đŸ¤¼","shortcode":"people_wrestling","name":"people wrestling","code":"1F93C"},{"emoji":"đŸ¤¼â€â™‚ï¸","shortcode":"men_wrestling","name":"men wrestling","code":"1F93C-200D-2642-FE0F"},{"emoji":"đŸ¤¼â€â™€ï¸","shortcode":"women_wrestling","name":"women wrestling","code":"1F93C-200D-2640-FE0F"},{"emoji":"đŸ¤½","shortcode":"person_playing_water_polo","name":"person playing water polo","code":"1F93D"},{"emoji":"đŸ¤½â€â™‚ï¸","shortcode":"man_playing_water_polo","name":"man playing water polo","code":"1F93D-200D-2642-FE0F"},{"emoji":"đŸ¤½â€â™€ï¸","shortcode":"woman_playing_water_polo","name":"woman playing water polo","code":"1F93D-200D-2640-FE0F"},{"emoji":"đŸ¤¾","shortcode":"person_playing_handball","name":"person playing handball","code":"1F93E"},{"emoji":"đŸ¤¾â€â™‚ï¸","shortcode":"man_playing_handball","name":"man playing handball","code":"1F93E-200D-2642-FE0F"},{"emoji":"đŸ¤¾â€â™€ï¸","shortcode":"woman_playing_handball","name":"woman playing handball","code":"1F93E-200D-2640-FE0F"},{"emoji":"đŸ¤¹","shortcode":"person_juggling","name":"person juggling","code":"1F939"},{"emoji":"đŸ¤¹â€â™‚ï¸","shortcode":"man_juggling","name":"man juggling","code":"1F939-200D-2642-FE0F"},{"emoji":"đŸ¤¹â€â™€ï¸","shortcode":"woman_juggling","name":"woman juggling","code":"1F939-200D-2640-FE0F"},{"emoji":"đŸ§˜","shortcode":"person_in_lotus_position","name":"person in lotus position","code":"1F9D8"},{"emoji":"đŸ§˜â€â™‚ï¸","shortcode":"man_in_lotus_position","name":"man in lotus position","code":"1F9D8-200D-2642-FE0F"},{"emoji":"đŸ§˜â€â™€ï¸","shortcode":"woman_in_lotus_position","name":"woman in lotus position","code":"1F9D8-200D-2640-FE0F"},{"emoji":"đŸ›€","shortcode":"person_taking_bath","name":"person taking bath","code":"1F6C0"},{"emoji":"đŸ›Œ","shortcode":"person_in_bed","name":"person in bed","code":"1F6CC"},{"emoji":"đŸ§‘â€đŸ¤â€đŸ§‘","shortcode":"people_holding_hands","name":"people holding hands","code":"1F9D1-200D-1F91D-200D-1F9D1"},{"emoji":"đŸ‘­","shortcode":"women_holding_hands","name":"women holding hands","code":"1F46D"},{"emoji":"đŸ‘«","shortcode":"woman_and_man_holding_hands","name":"woman and man holding hands","code":"1F46B"},{"emoji":"đŸ‘¬","shortcode":"men_holding_hands","name":"men holding hands","code":"1F46C"},{"emoji":"đŸ’","shortcode":"kiss","name":"kiss","code":"1F48F"},{"emoji":"đŸ‘©â€â¤ï¸â€đŸ’‹â€đŸ‘¨","shortcode":"kiss_woman_man","name":"kiss woman, man","code":"1F469-200D-2764-FE0F-200D-1F48B-200D-1F468"},{"emoji":"đŸ‘¨â€â¤ï¸â€đŸ’‹â€đŸ‘¨","shortcode":"kiss_man_man","name":"kiss man, man","code":"1F468-200D-2764-FE0F-200D-1F48B-200D-1F468"},{"emoji":"đŸ‘©â€â¤ï¸â€đŸ’‹â€đŸ‘©","shortcode":"kiss_woman_woman","name":"kiss woman, woman","code":"1F469-200D-2764-FE0F-200D-1F48B-200D-1F469"},{"emoji":"đŸ’‘","shortcode":"couple_with_heart","name":"couple with heart","code":"1F491"},{"emoji":"đŸ‘©â€â¤ï¸â€đŸ‘¨","shortcode":"couple_with_heart_woman_man","name":"couple with heart woman, man","code":"1F469-200D-2764-FE0F-200D-1F468"},{"emoji":"đŸ‘¨â€â¤ï¸â€đŸ‘¨","shortcode":"couple_with_heart_man_man","name":"couple with heart man, man","code":"1F468-200D-2764-FE0F-200D-1F468"},{"emoji":"đŸ‘©â€â¤ï¸â€đŸ‘©","shortcode":"couple_with_heart_woman_woman","name":"couple with heart woman, woman","code":"1F469-200D-2764-FE0F-200D-1F469"},{"emoji":"đŸ‘ª","shortcode":"family","name":"family","code":"1F46A"},{"emoji":"đŸ‘¨â€đŸ‘©â€đŸ‘¦","shortcode":"family_man_woman_boy","name":"family man, woman, boy","code":"1F468-200D-1F469-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘©â€đŸ‘§","shortcode":"family_man_woman_girl","name":"family man, woman, girl","code":"1F468-200D-1F469-200D-1F467"},{"emoji":"đŸ‘¨â€đŸ‘©â€đŸ‘§â€đŸ‘¦","shortcode":"family_man_woman_girl_boy","name":"family man, woman, girl, boy","code":"1F468-200D-1F469-200D-1F467-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘©â€đŸ‘¦â€đŸ‘¦","shortcode":"family_man_woman_boy_boy","name":"family man, woman, boy, boy","code":"1F468-200D-1F469-200D-1F466-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘©â€đŸ‘§â€đŸ‘§","shortcode":"family_man_woman_girl_girl","name":"family man, woman, girl, girl","code":"1F468-200D-1F469-200D-1F467-200D-1F467"},{"emoji":"đŸ‘¨â€đŸ‘¨â€đŸ‘¦","shortcode":"family_man_man_boy","name":"family man, man, boy","code":"1F468-200D-1F468-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘¨â€đŸ‘§","shortcode":"family_man_man_girl","name":"family man, man, girl","code":"1F468-200D-1F468-200D-1F467"},{"emoji":"đŸ‘¨â€đŸ‘¨â€đŸ‘§â€đŸ‘¦","shortcode":"family_man_man_girl_boy","name":"family man, man, girl, boy","code":"1F468-200D-1F468-200D-1F467-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘¨â€đŸ‘¦â€đŸ‘¦","shortcode":"family_man_man_boy_boy","name":"family man, man, boy, boy","code":"1F468-200D-1F468-200D-1F466-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘¨â€đŸ‘§â€đŸ‘§","shortcode":"family_man_man_girl_girl","name":"family man, man, girl, girl","code":"1F468-200D-1F468-200D-1F467-200D-1F467"},{"emoji":"đŸ‘©â€đŸ‘©â€đŸ‘¦","shortcode":"family_woman_woman_boy","name":"family woman, woman, boy","code":"1F469-200D-1F469-200D-1F466"},{"emoji":"đŸ‘©â€đŸ‘©â€đŸ‘§","shortcode":"family_woman_woman_girl","name":"family woman, woman, girl","code":"1F469-200D-1F469-200D-1F467"},{"emoji":"đŸ‘©â€đŸ‘©â€đŸ‘§â€đŸ‘¦","shortcode":"family_woman_woman_girl_boy","name":"family woman, woman, girl, boy","code":"1F469-200D-1F469-200D-1F467-200D-1F466"},{"emoji":"đŸ‘©â€đŸ‘©â€đŸ‘¦â€đŸ‘¦","shortcode":"family_woman_woman_boy_boy","name":"family woman, woman, boy, boy","code":"1F469-200D-1F469-200D-1F466-200D-1F466"},{"emoji":"đŸ‘©â€đŸ‘©â€đŸ‘§â€đŸ‘§","shortcode":"family_woman_woman_girl_girl","name":"family woman, woman, girl, girl","code":"1F469-200D-1F469-200D-1F467-200D-1F467"},{"emoji":"đŸ‘¨â€đŸ‘¦","shortcode":"family_man_boy","name":"family man, boy","code":"1F468-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘¦â€đŸ‘¦","shortcode":"family_man_boy_boy","name":"family man, boy, boy","code":"1F468-200D-1F466-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘§","shortcode":"family_man_girl","name":"family man, girl","code":"1F468-200D-1F467"},{"emoji":"đŸ‘¨â€đŸ‘§â€đŸ‘¦","shortcode":"family_man_girl_boy","name":"family man, girl, boy","code":"1F468-200D-1F467-200D-1F466"},{"emoji":"đŸ‘¨â€đŸ‘§â€đŸ‘§","shortcode":"family_man_girl_girl","name":"family man, girl, girl","code":"1F468-200D-1F467-200D-1F467"},{"emoji":"đŸ‘©â€đŸ‘¦","shortcode":"family_woman_boy","name":"family woman, boy","code":"1F469-200D-1F466"},{"emoji":"đŸ‘©â€đŸ‘¦â€đŸ‘¦","shortcode":"family_woman_boy_boy","name":"family woman, boy, boy","code":"1F469-200D-1F466-200D-1F466"},{"emoji":"đŸ‘©â€đŸ‘§","shortcode":"family_woman_girl","name":"family woman, girl","code":"1F469-200D-1F467"},{"emoji":"đŸ‘©â€đŸ‘§â€đŸ‘¦","shortcode":"family_woman_girl_boy","name":"family woman, girl, boy","code":"1F469-200D-1F467-200D-1F466"},{"emoji":"đŸ‘©â€đŸ‘§â€đŸ‘§","shortcode":"family_woman_girl_girl","name":"family woman, girl, girl","code":"1F469-200D-1F467-200D-1F467"},{"emoji":"đŸ‘¤","shortcode":"bust_in_silhouette","name":"bust in silhouette","code":"1F464"},{"emoji":"đŸ‘¥","shortcode":"busts_in_silhouette","name":"busts in silhouette","code":"1F465"},{"emoji":"đŸ«‚","shortcode":"people_hugging","name":"people hugging","code":"1FAC2"},{"emoji":"đŸ‘£","shortcode":"footprints","name":"footprints","code":"1F463"}]},{"group":"Objects","groupkey":"objects","emojis":[{"emoji":"đŸ‘“","shortcode":"glasses","name":"glasses","code":"1F453"},{"emoji":"đŸ¥½","shortcode":"goggles","name":"goggles","code":"1F97D"},{"emoji":"đŸ¥¼","shortcode":"lab_coat","name":"lab coat","code":"1F97C"},{"emoji":"đŸ¦º","shortcode":"safety_vest","name":"safety vest","code":"1F9BA"},{"emoji":"đŸ‘”","shortcode":"necktie","name":"necktie","code":"1F454"},{"emoji":"đŸ‘•","shortcode":"t_shirt","name":"t-shirt","code":"1F455"},{"emoji":"đŸ‘–","shortcode":"jeans","name":"jeans","code":"1F456"},{"emoji":"đŸ§£","shortcode":"scarf","name":"scarf","code":"1F9E3"},{"emoji":"đŸ§¤","shortcode":"gloves","name":"gloves","code":"1F9E4"},{"emoji":"đŸ§¥","shortcode":"coat","name":"coat","code":"1F9E5"},{"emoji":"đŸ§¦","shortcode":"socks","name":"socks","code":"1F9E6"},{"emoji":"đŸ‘—","shortcode":"dress","name":"dress","code":"1F457"},{"emoji":"đŸ‘˜","shortcode":"kimono","name":"kimono","code":"1F458"},{"emoji":"đŸ¥»","shortcode":"sari","name":"sari","code":"1F97B"},{"emoji":"đŸ©±","shortcode":"one_piece_swimsuit","name":"one-piece swimsuit","code":"1FA71"},{"emoji":"đŸ©²","shortcode":"briefs","name":"briefs","code":"1FA72"},{"emoji":"đŸ©³","shortcode":"shorts","name":"shorts","code":"1FA73"},{"emoji":"đŸ‘™","shortcode":"bikini","name":"bikini","code":"1F459"},{"emoji":"đŸ‘","shortcode":"woman_s_clothes","name":"womanâ€™s clothes","code":"1F45A"},{"emoji":"đŸ‘›","shortcode":"purse","name":"purse","code":"1F45B"},{"emoji":"đŸ‘œ","shortcode":"handbag","name":"handbag","code":"1F45C"},{"emoji":"đŸ‘","shortcode":"clutch_bag","name":"clutch bag","code":"1F45D"},{"emoji":"đŸ’","shortcode":"backpack","name":"backpack","code":"1F392"},{"emoji":"đŸ©´","shortcode":"thong_sandal","name":"thong sandal","code":"1FA74"},{"emoji":"đŸ‘","shortcode":"man_s_shoe","name":"manâ€™s shoe","code":"1F45E"},{"emoji":"đŸ‘Ÿ","shortcode":"running_shoe","name":"running shoe","code":"1F45F"},{"emoji":"đŸ¥¾","shortcode":"hiking_boot","name":"hiking boot","code":"1F97E"},{"emoji":"đŸ¥¿","shortcode":"flat_shoe","name":"flat shoe","code":"1F97F"},{"emoji":"đŸ‘ ","shortcode":"high_heeled_shoe","name":"high-heeled shoe","code":"1F460"},{"emoji":"đŸ‘¡","shortcode":"woman_s_sandal","name":"womanâ€™s sandal","code":"1F461"},{"emoji":"đŸ©°","shortcode":"ballet_shoes","name":"ballet shoes","code":"1FA70"},{"emoji":"đŸ‘¢","shortcode":"woman_s_boot","name":"womanâ€™s boot","code":"1F462"},{"emoji":"đŸ‘‘","shortcode":"crown","name":"crown","code":"1F451"},{"emoji":"đŸ‘’","shortcode":"woman_s_hat","name":"womanâ€™s hat","code":"1F452"},{"emoji":"đŸ©","shortcode":"top_hat","name":"top hat","code":"1F3A9"},{"emoji":"đŸ“","shortcode":"graduation_cap","name":"graduation cap","code":"1F393"},{"emoji":"đŸ§¢","shortcode":"billed_cap","name":"billed cap","code":"1F9E2"},{"emoji":"đŸª–","shortcode":"military_helmet","name":"military helmet","code":"1FA96"},{"emoji":"đŸ“¿","shortcode":"prayer_beads","name":"prayer beads","code":"1F4FF"},{"emoji":"đŸ’„","shortcode":"lipstick","name":"lipstick","code":"1F484"},{"emoji":"đŸ’","shortcode":"ring","name":"ring","code":"1F48D"},{"emoji":"đŸ’","shortcode":"gem_stone","name":"gem stone","code":"1F48E"},{"emoji":"đŸ”‡","shortcode":"muted_speaker","name":"muted speaker","code":"1F507"},{"emoji":"đŸ”ˆ","shortcode":"speaker_low_volume","name":"speaker low volume","code":"1F508"},{"emoji":"đŸ”‰","shortcode":"speaker_medium_volume","name":"speaker medium volume","code":"1F509"},{"emoji":"đŸ”","shortcode":"speaker_high_volume","name":"speaker high volume","code":"1F50A"},{"emoji":"đŸ“¢","shortcode":"loudspeaker","name":"loudspeaker","code":"1F4E2"},{"emoji":"đŸ“£","shortcode":"megaphone","name":"megaphone","code":"1F4E3"},{"emoji":"đŸ“¯","shortcode":"postal_horn","name":"postal horn","code":"1F4EF"},{"emoji":"đŸ””","shortcode":"bell","name":"bell","code":"1F514"},{"emoji":"đŸ”•","shortcode":"bell_with_slash","name":"bell with slash","code":"1F515"},{"emoji":"đŸ¼","shortcode":"musical_score","name":"musical score","code":"1F3BC"},{"emoji":"đŸµ","shortcode":"musical_note","name":"musical note","code":"1F3B5"},{"emoji":"đŸ¶","shortcode":"musical_notes","name":"musical notes","code":"1F3B6"},{"emoji":"đŸ¤","shortcode":"microphone","name":"microphone","code":"1F3A4"},{"emoji":"đŸ§","shortcode":"headphone","name":"headphone","code":"1F3A7"},{"emoji":"đŸ“»","shortcode":"radio","name":"radio","code":"1F4FB"},{"emoji":"đŸ·","shortcode":"saxophone","name":"saxophone","code":"1F3B7"},{"emoji":"đŸª—","shortcode":"accordion","name":"accordion","code":"1FA97"},{"emoji":"đŸ¸","shortcode":"guitar","name":"guitar","code":"1F3B8"},{"emoji":"đŸ¹","shortcode":"musical_keyboard","name":"musical keyboard","code":"1F3B9"},{"emoji":"đŸº","shortcode":"trumpet","name":"trumpet","code":"1F3BA"},{"emoji":"đŸ»","shortcode":"violin","name":"violin","code":"1F3BB"},{"emoji":"đŸª•","shortcode":"banjo","name":"banjo","code":"1FA95"},{"emoji":"đŸ¥","shortcode":"drum","name":"drum","code":"1F941"},{"emoji":"đŸª˜","shortcode":"long_drum","name":"long drum","code":"1FA98"},{"emoji":"đŸ“±","shortcode":"mobile_phone","name":"mobile phone","code":"1F4F1"},{"emoji":"đŸ“²","shortcode":"mobile_phone_with_arrow","name":"mobile phone with arrow","code":"1F4F2"},{"emoji":"đŸ“","shortcode":"telephone_receiver","name":"telephone receiver","code":"1F4DE"},{"emoji":"đŸ“Ÿ","shortcode":"pager","name":"pager","code":"1F4DF"},{"emoji":"đŸ“ ","shortcode":"fax_machine","name":"fax machine","code":"1F4E0"},{"emoji":"đŸ”‹","shortcode":"battery","name":"battery","code":"1F50B"},{"emoji":"đŸ”Œ","shortcode":"electric_plug","name":"electric plug","code":"1F50C"},{"emoji":"đŸ’»","shortcode":"laptop","name":"laptop","code":"1F4BB"},{"emoji":"đŸ’½","shortcode":"computer_disk","name":"computer disk","code":"1F4BD"},{"emoji":"đŸ’¾","shortcode":"floppy_disk","name":"floppy disk","code":"1F4BE"},{"emoji":"đŸ’¿","shortcode":"optical_disk","name":"optical disk","code":"1F4BF"},{"emoji":"đŸ“€","shortcode":"dvd","name":"dvd","code":"1F4C0"},{"emoji":"đŸ§®","shortcode":"abacus","name":"abacus","code":"1F9EE"},{"emoji":"đŸ¥","shortcode":"movie_camera","name":"movie camera","code":"1F3A5"},{"emoji":"đŸ¬","shortcode":"clapper_board","name":"clapper board","code":"1F3AC"},{"emoji":"đŸ“º","shortcode":"television","name":"television","code":"1F4FA"},{"emoji":"đŸ“·","shortcode":"camera","name":"camera","code":"1F4F7"},{"emoji":"đŸ“¸","shortcode":"camera_with_flash","name":"camera with flash","code":"1F4F8"},{"emoji":"đŸ“¹","shortcode":"video_camera","name":"video camera","code":"1F4F9"},{"emoji":"đŸ“¼","shortcode":"videocassette","name":"videocassette","code":"1F4FC"},{"emoji":"đŸ”","shortcode":"magnifying_glass_tilted_left","name":"magnifying glass tilted left","code":"1F50D"},{"emoji":"đŸ”","shortcode":"magnifying_glass_tilted_right","name":"magnifying glass tilted right","code":"1F50E"},{"emoji":"đŸ’¡","shortcode":"light_bulb","name":"light bulb","code":"1F4A1"},{"emoji":"đŸ”¦","shortcode":"flashlight","name":"flashlight","code":"1F526"},{"emoji":"đŸ®","shortcode":"red_paper_lantern","name":"red paper lantern","code":"1F3EE"},{"emoji":"đŸª”","shortcode":"diya_lamp","name":"diya lamp","code":"1FA94"},{"emoji":"đŸ“”","shortcode":"notebook_with_decorative_cover","name":"notebook with decorative cover","code":"1F4D4"},{"emoji":"đŸ“•","shortcode":"closed_book","name":"closed book","code":"1F4D5"},{"emoji":"đŸ“–","shortcode":"open_book","name":"open book","code":"1F4D6"},{"emoji":"đŸ“—","shortcode":"green_book","name":"green book","code":"1F4D7"},{"emoji":"đŸ“˜","shortcode":"blue_book","name":"blue book","code":"1F4D8"},{"emoji":"đŸ“™","shortcode":"orange_book","name":"orange book","code":"1F4D9"},{"emoji":"đŸ“","shortcode":"books","name":"books","code":"1F4DA"},{"emoji":"đŸ““","shortcode":"notebook","name":"notebook","code":"1F4D3"},{"emoji":"đŸ“’","shortcode":"ledger","name":"ledger","code":"1F4D2"},{"emoji":"đŸ“ƒ","shortcode":"page_with_curl","name":"page with curl","code":"1F4C3"},{"emoji":"đŸ“œ","shortcode":"scroll","name":"scroll","code":"1F4DC"},{"emoji":"đŸ“„","shortcode":"page_facing_up","name":"page facing up","code":"1F4C4"},{"emoji":"đŸ“°","shortcode":"newspaper","name":"newspaper","code":"1F4F0"},{"emoji":"đŸ“‘","shortcode":"bookmark_tabs","name":"bookmark tabs","code":"1F4D1"},{"emoji":"đŸ”–","shortcode":"bookmark","name":"bookmark","code":"1F516"},{"emoji":"đŸ’°","shortcode":"money_bag","name":"money bag","code":"1F4B0"},{"emoji":"đŸª™","shortcode":"coin","name":"coin","code":"1FA99"},{"emoji":"đŸ’´","shortcode":"yen_banknote","name":"yen banknote","code":"1F4B4"},{"emoji":"đŸ’µ","shortcode":"dollar_banknote","name":"dollar banknote","code":"1F4B5"},{"emoji":"đŸ’¶","shortcode":"euro_banknote","name":"euro banknote","code":"1F4B6"},{"emoji":"đŸ’·","shortcode":"pound_banknote","name":"pound banknote","code":"1F4B7"},{"emoji":"đŸ’¸","shortcode":"money_with_wings","name":"money with wings","code":"1F4B8"},{"emoji":"đŸ’³","shortcode":"credit_card","name":"credit card","code":"1F4B3"},{"emoji":"đŸ§¾","shortcode":"receipt","name":"receipt","code":"1F9FE"},{"emoji":"đŸ’¹","shortcode":"chart_increasing_with_yen","name":"chart increasing with yen","code":"1F4B9"},{"emoji":"đŸ“§","shortcode":"e_mail","name":"e-mail","code":"1F4E7"},{"emoji":"đŸ“¨","shortcode":"incoming_envelope","name":"incoming envelope","code":"1F4E8"},{"emoji":"đŸ“©","shortcode":"envelope_with_arrow","name":"envelope with arrow","code":"1F4E9"},{"emoji":"đŸ“¤","shortcode":"outbox_tray","name":"outbox tray","code":"1F4E4"},{"emoji":"đŸ“¥","shortcode":"inbox_tray","name":"inbox tray","code":"1F4E5"},{"emoji":"đŸ“¦","shortcode":"package","name":"package","code":"1F4E6"},{"emoji":"đŸ“«","shortcode":"closed_mailbox_with_raised_flag","name":"closed mailbox with raised flag","code":"1F4EB"},{"emoji":"đŸ“ª","shortcode":"closed_mailbox_with_lowered_flag","name":"closed mailbox with lowered flag","code":"1F4EA"},{"emoji":"đŸ“¬","shortcode":"open_mailbox_with_raised_flag","name":"open mailbox with raised flag","code":"1F4EC"},{"emoji":"đŸ“­","shortcode":"open_mailbox_with_lowered_flag","name":"open mailbox with lowered flag","code":"1F4ED"},{"emoji":"đŸ“®","shortcode":"postbox","name":"postbox","code":"1F4EE"},{"emoji":"đŸ“","shortcode":"memo","name":"memo","code":"1F4DD"},{"emoji":"đŸ’¼","shortcode":"briefcase","name":"briefcase","code":"1F4BC"},{"emoji":"đŸ“","shortcode":"file_folder","name":"file folder","code":"1F4C1"},{"emoji":"đŸ“‚","shortcode":"open_file_folder","name":"open file folder","code":"1F4C2"},{"emoji":"đŸ“…","shortcode":"calendar","name":"calendar","code":"1F4C5"},{"emoji":"đŸ“†","shortcode":"tear_off_calendar","name":"tear-off calendar","code":"1F4C6"},{"emoji":"đŸ“‡","shortcode":"card_index","name":"card index","code":"1F4C7"},{"emoji":"đŸ“ˆ","shortcode":"chart_increasing","name":"chart increasing","code":"1F4C8"},{"emoji":"đŸ“‰","shortcode":"chart_decreasing","name":"chart decreasing","code":"1F4C9"},{"emoji":"đŸ“","shortcode":"bar_chart","name":"bar chart","code":"1F4CA"},{"emoji":"đŸ“‹","shortcode":"clipboard","name":"clipboard","code":"1F4CB"},{"emoji":"đŸ“Œ","shortcode":"pushpin","name":"pushpin","code":"1F4CC"},{"emoji":"đŸ“","shortcode":"round_pushpin","name":"round pushpin","code":"1F4CD"},{"emoji":"đŸ“","shortcode":"paperclip","name":"paperclip","code":"1F4CE"},{"emoji":"đŸ“","shortcode":"straight_ruler","name":"straight ruler","code":"1F4CF"},{"emoji":"đŸ“","shortcode":"triangular_ruler","name":"triangular ruler","code":"1F4D0"},{"emoji":"đŸ”’","shortcode":"locked","name":"locked","code":"1F512"},{"emoji":"đŸ”“","shortcode":"unlocked","name":"unlocked","code":"1F513"},{"emoji":"đŸ”","shortcode":"locked_with_pen","name":"locked with pen","code":"1F50F"},{"emoji":"đŸ”","shortcode":"locked_with_key","name":"locked with key","code":"1F510"},{"emoji":"đŸ”‘","shortcode":"key","name":"key","code":"1F511"},{"emoji":"đŸ”¨","shortcode":"hammer","name":"hammer","code":"1F528"},{"emoji":"đŸª“","shortcode":"axe","name":"axe","code":"1FA93"},{"emoji":"đŸ”«","shortcode":"water_pistol","name":"water pistol","code":"1F52B"},{"emoji":"đŸªƒ","shortcode":"boomerang","name":"boomerang","code":"1FA83"},{"emoji":"đŸ¹","shortcode":"bow_and_arrow","name":"bow and arrow","code":"1F3F9"},{"emoji":"đŸª","shortcode":"carpentry_saw","name":"carpentry saw","code":"1FA9A"},{"emoji":"đŸ”§","shortcode":"wrench","name":"wrench","code":"1F527"},{"emoji":"đŸª›","shortcode":"screwdriver","name":"screwdriver","code":"1FA9B"},{"emoji":"đŸ”©","shortcode":"nut_and_bolt","name":"nut and bolt","code":"1F529"},{"emoji":"đŸ¦¯","shortcode":"white_cane","name":"white cane","code":"1F9AF"},{"emoji":"đŸ”—","shortcode":"link","name":"link","code":"1F517"},{"emoji":"đŸª","shortcode":"hook","name":"hook","code":"1FA9D"},{"emoji":"đŸ§°","shortcode":"toolbox","name":"toolbox","code":"1F9F0"},{"emoji":"đŸ§²","shortcode":"magnet","name":"magnet","code":"1F9F2"},{"emoji":"đŸªœ","shortcode":"ladder","name":"ladder","code":"1FA9C"},{"emoji":"đŸ§ª","shortcode":"test_tube","name":"test tube","code":"1F9EA"},{"emoji":"đŸ§«","shortcode":"petri_dish","name":"petri dish","code":"1F9EB"},{"emoji":"đŸ§¬","shortcode":"dna","name":"dna","code":"1F9EC"},{"emoji":"đŸ”¬","shortcode":"microscope","name":"microscope","code":"1F52C"},{"emoji":"đŸ”­","shortcode":"telescope","name":"telescope","code":"1F52D"},{"emoji":"đŸ“¡","shortcode":"satellite_antenna","name":"satellite antenna","code":"1F4E1"},{"emoji":"đŸ’‰","shortcode":"syringe","name":"syringe","code":"1F489"},{"emoji":"đŸ©¸","shortcode":"drop_of_blood","name":"drop of blood","code":"1FA78"},{"emoji":"đŸ’","shortcode":"pill","name":"pill","code":"1F48A"},{"emoji":"đŸ©¹","shortcode":"adhesive_bandage","name":"adhesive bandage","code":"1FA79"},{"emoji":"đŸ©º","shortcode":"stethoscope","name":"stethoscope","code":"1FA7A"},{"emoji":"đŸª","shortcode":"door","name":"door","code":"1F6AA"},{"emoji":"đŸ›—","shortcode":"elevator","name":"elevator","code":"1F6D7"},{"emoji":"đŸª","shortcode":"mirror","name":"mirror","code":"1FA9E"},{"emoji":"đŸªŸ","shortcode":"window","name":"window","code":"1FA9F"},{"emoji":"đŸª‘","shortcode":"chair","name":"chair","code":"1FA91"},{"emoji":"đŸ½","shortcode":"toilet","name":"toilet","code":"1F6BD"},{"emoji":"đŸª ","shortcode":"plunger","name":"plunger","code":"1FAA0"},{"emoji":"đŸ¿","shortcode":"shower","name":"shower","code":"1F6BF"},{"emoji":"đŸ›","shortcode":"bathtub","name":"bathtub","code":"1F6C1"},{"emoji":"đŸª¤","shortcode":"mouse_trap","name":"mouse trap","code":"1FAA4"},{"emoji":"đŸª’","shortcode":"razor","name":"razor","code":"1FA92"},{"emoji":"đŸ§´","shortcode":"lotion_bottle","name":"lotion bottle","code":"1F9F4"},{"emoji":"đŸ§·","shortcode":"safety_pin","name":"safety pin","code":"1F9F7"},{"emoji":"đŸ§¹","shortcode":"broom","name":"broom","code":"1F9F9"},{"emoji":"đŸ§º","shortcode":"basket","name":"basket","code":"1F9FA"},{"emoji":"đŸ§»","shortcode":"roll_of_paper","name":"roll of paper","code":"1F9FB"},{"emoji":"đŸª£","shortcode":"bucket","name":"bucket","code":"1FAA3"},{"emoji":"đŸ§¼","shortcode":"soap","name":"soap","code":"1F9FC"},{"emoji":"đŸª¥","shortcode":"toothbrush","name":"toothbrush","code":"1FAA5"},{"emoji":"đŸ§½","shortcode":"sponge","name":"sponge","code":"1F9FD"},{"emoji":"đŸ§¯","shortcode":"fire_extinguisher","name":"fire extinguisher","code":"1F9EF"},{"emoji":"đŸ›’","shortcode":"shopping_cart","name":"shopping cart","code":"1F6D2"},{"emoji":"đŸ¬","shortcode":"cigarette","name":"cigarette","code":"1F6AC"},{"emoji":"đŸª¦","shortcode":"headstone","name":"headstone","code":"1FAA6"},{"emoji":"đŸ—¿","shortcode":"moai","name":"moai","code":"1F5FF"},{"emoji":"đŸª§","shortcode":"placard","name":"placard","code":"1FAA7"}]},{"group":"Symbols","groupkey":"symbols","emojis":[{"emoji":"đŸ§","shortcode":"atm_sign","name":"ATM sign","code":"1F3E7"},{"emoji":"đŸ®","shortcode":"litter_in_bin_sign","name":"litter in bin sign","code":"1F6AE"},{"emoji":"đŸ°","shortcode":"potable_water","name":"potable water","code":"1F6B0"},{"emoji":"â™¿","shortcode":"wheelchair_symbol","name":"wheelchair symbol","code":"267F"},{"emoji":"đŸ¹","shortcode":"men_s_room","name":"menâ€™s room","code":"1F6B9"},{"emoji":"đŸº","shortcode":"women_s_room","name":"womenâ€™s room","code":"1F6BA"},{"emoji":"đŸ»","shortcode":"restroom","name":"restroom","code":"1F6BB"},{"emoji":"đŸ¼","shortcode":"baby_symbol","name":"baby symbol","code":"1F6BC"},{"emoji":"đŸ¾","shortcode":"water_closet","name":"water closet","code":"1F6BE"},{"emoji":"đŸ›‚","shortcode":"passport_control","name":"passport control","code":"1F6C2"},{"emoji":"đŸ›ƒ","shortcode":"customs","name":"customs","code":"1F6C3"},{"emoji":"đŸ›„","shortcode":"baggage_claim","name":"baggage claim","code":"1F6C4"},{"emoji":"đŸ›…","shortcode":"left_luggage","name":"left luggage","code":"1F6C5"},{"emoji":"đŸ¸","shortcode":"children_crossing","name":"children crossing","code":"1F6B8"},{"emoji":"â›”","shortcode":"no_entry","name":"no entry","code":"26D4"},{"emoji":"đŸ«","shortcode":"prohibited","name":"prohibited","code":"1F6AB"},{"emoji":"đŸ³","shortcode":"no_bicycles","name":"no bicycles","code":"1F6B3"},{"emoji":"đŸ­","shortcode":"no_smoking","name":"no smoking","code":"1F6AD"},{"emoji":"đŸ¯","shortcode":"no_littering","name":"no littering","code":"1F6AF"},{"emoji":"đŸ±","shortcode":"non_potable_water","name":"non-potable water","code":"1F6B1"},{"emoji":"đŸ·","shortcode":"no_pedestrians","name":"no pedestrians","code":"1F6B7"},{"emoji":"đŸ“µ","shortcode":"no_mobile_phones","name":"no mobile phones","code":"1F4F5"},{"emoji":"đŸ”","shortcode":"no_one_under_eighteen","name":"no one under eighteen","code":"1F51E"},{"emoji":"đŸ”ƒ","shortcode":"clockwise_vertical_arrows","name":"clockwise vertical arrows","code":"1F503"},{"emoji":"đŸ”„","shortcode":"counterclockwise_arrows_button","name":"counterclockwise arrows button","code":"1F504"},{"emoji":"đŸ”™","shortcode":"back_arrow","name":"BACK arrow","code":"1F519"},{"emoji":"đŸ”","shortcode":"end_arrow","name":"END arrow","code":"1F51A"},{"emoji":"đŸ”›","shortcode":"on_arrow","name":"ON! arrow","code":"1F51B"},{"emoji":"đŸ”œ","shortcode":"soon_arrow","name":"SOON arrow","code":"1F51C"},{"emoji":"đŸ”","shortcode":"top_arrow","name":"TOP arrow","code":"1F51D"},{"emoji":"đŸ›","shortcode":"place_of_worship","name":"place of worship","code":"1F6D0"},{"emoji":"đŸ•","shortcode":"menorah","name":"menorah","code":"1F54E"},{"emoji":"đŸ”¯","shortcode":"dotted_six_pointed_star","name":"dotted six-pointed star","code":"1F52F"},{"emoji":"â™ˆ","shortcode":"aries","name":"Aries","code":"2648"},{"emoji":"â™‰","shortcode":"taurus","name":"Taurus","code":"2649"},{"emoji":"â™","shortcode":"gemini","name":"Gemini","code":"264A"},{"emoji":"â™‹","shortcode":"cancer","name":"Cancer","code":"264B"},{"emoji":"â™Œ","shortcode":"leo","name":"Leo","code":"264C"},{"emoji":"â™","shortcode":"virgo","name":"Virgo","code":"264D"},{"emoji":"â™","shortcode":"libra","name":"Libra","code":"264E"},{"emoji":"â™","shortcode":"scorpio","name":"Scorpio","code":"264F"},{"emoji":"â™","shortcode":"sagittarius","name":"Sagittarius","code":"2650"},{"emoji":"â™‘","shortcode":"capricorn","name":"Capricorn","code":"2651"},{"emoji":"â™’","shortcode":"aquarius","name":"Aquarius","code":"2652"},{"emoji":"â™“","shortcode":"pisces","name":"Pisces","code":"2653"},{"emoji":"â›","shortcode":"ophiuchus","name":"Ophiuchus","code":"26CE"},{"emoji":"đŸ”€","shortcode":"shuffle_tracks_button","name":"shuffle tracks button","code":"1F500"},{"emoji":"đŸ”","shortcode":"repeat_button","name":"repeat button","code":"1F501"},{"emoji":"đŸ”‚","shortcode":"repeat_single_button","name":"repeat single button","code":"1F502"},{"emoji":"â©","shortcode":"fast_forward_button","name":"fast-forward button","code":"23E9"},{"emoji":"âª","shortcode":"fast_reverse_button","name":"fast reverse button","code":"23EA"},{"emoji":"đŸ”¼","shortcode":"upwards_button","name":"upwards button","code":"1F53C"},{"emoji":"â«","shortcode":"fast_up_button","name":"fast up button","code":"23EB"},{"emoji":"đŸ”½","shortcode":"downwards_button","name":"downwards button","code":"1F53D"},{"emoji":"â¬","shortcode":"fast_down_button","name":"fast down button","code":"23EC"},{"emoji":"đŸ¦","shortcode":"cinema","name":"cinema","code":"1F3A6"},{"emoji":"đŸ”…","shortcode":"dim_button","name":"dim button","code":"1F505"},{"emoji":"đŸ”†","shortcode":"bright_button","name":"bright button","code":"1F506"},{"emoji":"đŸ“¶","shortcode":"antenna_bars","name":"antenna bars","code":"1F4F6"},{"emoji":"đŸ“³","shortcode":"vibration_mode","name":"vibration mode","code":"1F4F3"},{"emoji":"đŸ“´","shortcode":"mobile_phone_off","name":"mobile phone off","code":"1F4F4"},{"emoji":"â•","shortcode":"plus","name":"plus","code":"2795"},{"emoji":"â–","shortcode":"minus","name":"minus","code":"2796"},{"emoji":"â—","shortcode":"divide","name":"divide","code":"2797"},{"emoji":"â“","shortcode":"red_question_mark","name":"red question mark","code":"2753"},{"emoji":"â”","shortcode":"white_question_mark","name":"white question mark","code":"2754"},{"emoji":"â•","shortcode":"white_exclamation_mark","name":"white exclamation mark","code":"2755"},{"emoji":"â—","shortcode":"red_exclamation_mark","name":"red exclamation mark","code":"2757"},{"emoji":"đŸ’±","shortcode":"currency_exchange","name":"currency exchange","code":"1F4B1"},{"emoji":"đŸ’²","shortcode":"heavy_dollar_sign","name":"heavy dollar sign","code":"1F4B2"},{"emoji":"đŸ”±","shortcode":"trident_emblem","name":"trident emblem","code":"1F531"},{"emoji":"đŸ“›","shortcode":"name_badge","name":"name badge","code":"1F4DB"},{"emoji":"đŸ”°","shortcode":"japanese_symbol_for_beginner","name":"Japanese symbol for beginner","code":"1F530"},{"emoji":"â­•","shortcode":"hollow_red_circle","name":"hollow red circle","code":"2B55"},{"emoji":"âœ…","shortcode":"check_mark_button","name":"check mark button","code":"2705"},{"emoji":"âŒ","shortcode":"cross_mark","name":"cross mark","code":"274C"},{"emoji":"â","shortcode":"cross_mark_button","name":"cross mark button","code":"274E"},{"emoji":"â°","shortcode":"curly_loop","name":"curly loop","code":"27B0"},{"emoji":"â¿","shortcode":"double_curly_loop","name":"double curly loop","code":"27BF"},{"emoji":"đŸ”Ÿ","shortcode":"keycap_10","name":"keycap 10","code":"1F51F"},{"emoji":"đŸ” ","shortcode":"input_latin_uppercase","name":"input latin uppercase","code":"1F520"},{"emoji":"đŸ”¡","shortcode":"input_latin_lowercase","name":"input latin lowercase","code":"1F521"},{"emoji":"đŸ”¢","shortcode":"input_numbers","name":"input numbers","code":"1F522"},{"emoji":"đŸ”£","shortcode":"input_symbols","name":"input symbols","code":"1F523"},{"emoji":"đŸ”¤","shortcode":"input_latin_letters","name":"input latin letters","code":"1F524"},{"emoji":"đŸ†","shortcode":"ab_button","name":"AB button (blood type)","code":"1F18E"},{"emoji":"đŸ†‘","shortcode":"cl_button","name":"CL button","code":"1F191"},{"emoji":"đŸ†’","shortcode":"cool_button","name":"COOL button","code":"1F192"},{"emoji":"đŸ†“","shortcode":"free_button","name":"FREE button","code":"1F193"},{"emoji":"đŸ†”","shortcode":"id_button","name":"ID button","code":"1F194"},{"emoji":"đŸ†•","shortcode":"new_button","name":"NEW button","code":"1F195"},{"emoji":"đŸ†–","shortcode":"ng_button","name":"NG button","code":"1F196"},{"emoji":"đŸ†—","shortcode":"ok_button","name":"OK button","code":"1F197"},{"emoji":"đŸ†˜","shortcode":"sos_button","name":"SOS button","code":"1F198"},{"emoji":"đŸ†™","shortcode":"up_button","name":"UP! button","code":"1F199"},{"emoji":"đŸ†","shortcode":"vs_button","name":"VS button","code":"1F19A"},{"emoji":"đŸˆ","shortcode":"japanese_here_button","name":"Japanese â€œhereâ€ button","code":"1F201"},{"emoji":"đŸˆ¶","shortcode":"japanese_not_free_of_charge_button","name":"Japanese â€œnot free of chargeâ€ button","code":"1F236"},{"emoji":"đŸˆ¯","shortcode":"japanese_reserved_button","name":"Japanese â€œreservedâ€ button","code":"1F22F"},{"emoji":"đŸ‰","shortcode":"japanese_bargain_button","name":"Japanese â€œbargainâ€ button","code":"1F250"},{"emoji":"đŸˆ¹","shortcode":"japanese_discount_button","name":"Japanese â€œdiscountâ€ button","code":"1F239"},{"emoji":"đŸˆ","shortcode":"japanese_free_of_charge_button","name":"Japanese â€œfree of chargeâ€ button","code":"1F21A"},{"emoji":"đŸˆ²","shortcode":"japanese_prohibited_button","name":"Japanese â€œprohibitedâ€ button","code":"1F232"},{"emoji":"đŸ‰‘","shortcode":"japanese_acceptable_button","name":"Japanese â€œacceptableâ€ button","code":"1F251"},{"emoji":"đŸˆ¸","shortcode":"japanese_application_button","name":"Japanese â€œapplicationâ€ button","code":"1F238"},{"emoji":"đŸˆ´","shortcode":"japanese_passing_grade_button","name":"Japanese â€œpassing gradeâ€ button","code":"1F234"},{"emoji":"đŸˆ³","shortcode":"japanese_vacancy_button","name":"Japanese â€œvacancyâ€ button","code":"1F233"},{"emoji":"đŸˆº","shortcode":"japanese_open_for_business_button","name":"Japanese â€œopen for businessâ€ button","code":"1F23A"},{"emoji":"đŸˆµ","shortcode":"japanese_no_vacancy_button","name":"Japanese â€œno vacancyâ€ button","code":"1F235"},{"emoji":"đŸ”´","shortcode":"red_circle","name":"red circle","code":"1F534"},{"emoji":"đŸŸ ","shortcode":"orange_circle","name":"orange circle","code":"1F7E0"},{"emoji":"đŸŸ¡","shortcode":"yellow_circle","name":"yellow circle","code":"1F7E1"},{"emoji":"đŸŸ¢","shortcode":"green_circle","name":"green circle","code":"1F7E2"},{"emoji":"đŸ”µ","shortcode":"blue_circle","name":"blue circle","code":"1F535"},{"emoji":"đŸŸ£","shortcode":"purple_circle","name":"purple circle","code":"1F7E3"},{"emoji":"đŸŸ¤","shortcode":"brown_circle","name":"brown circle","code":"1F7E4"},{"emoji":"â«","shortcode":"black_circle","name":"black circle","code":"26AB"},{"emoji":"âª","shortcode":"white_circle","name":"white circle","code":"26AA"},{"emoji":"đŸŸ¥","shortcode":"red_square","name":"red square","code":"1F7E5"},{"emoji":"đŸŸ§","shortcode":"orange_square","name":"orange square","code":"1F7E7"},{"emoji":"đŸŸ¨","shortcode":"yellow_square","name":"yellow square","code":"1F7E8"},{"emoji":"đŸŸ©","shortcode":"green_square","name":"green square","code":"1F7E9"},{"emoji":"đŸŸ¦","shortcode":"blue_square","name":"blue square","code":"1F7E6"},{"emoji":"đŸŸª","shortcode":"purple_square","name":"purple square","code":"1F7EA"},{"emoji":"đŸŸ«","shortcode":"brown_square","name":"brown square","code":"1F7EB"},{"emoji":"â¬›","shortcode":"black_large_square","name":"black large square","code":"2B1B"},{"emoji":"â¬œ","shortcode":"white_large_square","name":"white large square","code":"2B1C"},{"emoji":"â—¾","shortcode":"black_medium_small_square","name":"black medium-small square","code":"25FE"},{"emoji":"â—½","shortcode":"white_medium_small_square","name":"white medium-small square","code":"25FD"},{"emoji":"đŸ”¶","shortcode":"large_orange_diamond","name":"large orange diamond","code":"1F536"},{"emoji":"đŸ”·","shortcode":"large_blue_diamond","name":"large blue diamond","code":"1F537"},{"emoji":"đŸ”¸","shortcode":"small_orange_diamond","name":"small orange diamond","code":"1F538"},{"emoji":"đŸ”¹","shortcode":"small_blue_diamond","name":"small blue diamond","code":"1F539"},{"emoji":"đŸ”º","shortcode":"red_triangle_pointed_up","name":"red triangle pointed up","code":"1F53A"},{"emoji":"đŸ”»","shortcode":"red_triangle_pointed_down","name":"red triangle pointed down","code":"1F53B"},{"emoji":"đŸ’ ","shortcode":"diamond_with_a_dot","name":"diamond with a dot","code":"1F4A0"},{"emoji":"đŸ”˜","shortcode":"radio_button","name":"radio button","code":"1F518"},{"emoji":"đŸ”³","shortcode":"white_square_button","name":"white square button","code":"1F533"},{"emoji":"đŸ”²","shortcode":"black_square_button","name":"black square button","code":"1F532"}]},{"group":"Flags","groupkey":"flags","emojis":[{"emoji":"đŸ","shortcode":"chequered_flag","name":"chequered flag","code":"1F3C1"},{"emoji":"đŸ©","shortcode":"triangular_flag","name":"triangular flag","code":"1F6A9"},{"emoji":"đŸŒ","shortcode":"crossed_flags","name":"crossed flags","code":"1F38C"},{"emoji":"đŸ´","shortcode":"black_flag","name":"black flag","code":"1F3F4"},{"emoji":"đŸ³ï¸â€đŸŒˆ","shortcode":"rainbow_flag","name":"rainbow flag","code":"1F3F3-FE0F-200D-1F308"},{"emoji":"đŸ³ï¸â€â§ï¸","shortcode":"transgender_flag","name":"transgender flag","code":"1F3F3-FE0F-200D-26A7-FE0F"},{"emoji":"đŸ´â€â˜ ï¸","shortcode":"pirate_flag","name":"pirate flag","code":"1F3F4-200D-2620-FE0F"},{"emoji":"đŸ‡¦đŸ‡¨","shortcode":"flag_ascension_island","name":"flag Ascension Island","code":"1F1E6-1F1E8"},{"emoji":"đŸ‡¦đŸ‡©","shortcode":"flag_andorra","name":"flag Andorra","code":"1F1E6-1F1E9"},{"emoji":"đŸ‡¦đŸ‡ª","shortcode":"flag_united_arab_emirates","name":"flag United Arab Emirates","code":"1F1E6-1F1EA"},{"emoji":"đŸ‡¦đŸ‡«","shortcode":"flag_afghanistan","name":"flag Afghanistan","code":"1F1E6-1F1EB"},{"emoji":"đŸ‡¦đŸ‡¬","shortcode":"flag_antigua_barbuda","name":"flag Antigua & Barbuda","code":"1F1E6-1F1EC"},{"emoji":"đŸ‡¦đŸ‡®","shortcode":"flag_anguilla","name":"flag Anguilla","code":"1F1E6-1F1EE"},{"emoji":"đŸ‡¦đŸ‡±","shortcode":"flag_albania","name":"flag Albania","code":"1F1E6-1F1F1"},{"emoji":"đŸ‡¦đŸ‡²","shortcode":"flag_armenia","name":"flag Armenia","code":"1F1E6-1F1F2"},{"emoji":"đŸ‡¦đŸ‡´","shortcode":"flag_angola","name":"flag Angola","code":"1F1E6-1F1F4"},{"emoji":"đŸ‡¦đŸ‡¶","shortcode":"flag_antarctica","name":"flag Antarctica","code":"1F1E6-1F1F6"},{"emoji":"đŸ‡¦đŸ‡·","shortcode":"flag_argentina","name":"flag Argentina","code":"1F1E6-1F1F7"},{"emoji":"đŸ‡¦đŸ‡¸","shortcode":"flag_american_samoa","name":"flag American Samoa","code":"1F1E6-1F1F8"},{"emoji":"đŸ‡¦đŸ‡¹","shortcode":"flag_austria","name":"flag Austria","code":"1F1E6-1F1F9"},{"emoji":"đŸ‡¦đŸ‡º","shortcode":"flag_australia","name":"flag Australia","code":"1F1E6-1F1FA"},{"emoji":"đŸ‡¦đŸ‡¼","shortcode":"flag_aruba","name":"flag Aruba","code":"1F1E6-1F1FC"},{"emoji":"đŸ‡¦đŸ‡½","shortcode":"flag_aland_islands","name":"flag Ă…land Islands","code":"1F1E6-1F1FD"},{"emoji":"đŸ‡¦đŸ‡¿","shortcode":"flag_azerbaijan","name":"flag Azerbaijan","code":"1F1E6-1F1FF"},{"emoji":"đŸ‡§đŸ‡¦","shortcode":"flag_bosnia_herzegovina","name":"flag Bosnia & Herzegovina","code":"1F1E7-1F1E6"},{"emoji":"đŸ‡§đŸ‡§","shortcode":"flag_barbados","name":"flag Barbados","code":"1F1E7-1F1E7"},{"emoji":"đŸ‡§đŸ‡©","shortcode":"flag_bangladesh","name":"flag Bangladesh","code":"1F1E7-1F1E9"},{"emoji":"đŸ‡§đŸ‡ª","shortcode":"flag_belgium","name":"flag Belgium","code":"1F1E7-1F1EA"},{"emoji":"đŸ‡§đŸ‡«","shortcode":"flag_burkina_faso","name":"flag Burkina Faso","code":"1F1E7-1F1EB"},{"emoji":"đŸ‡§đŸ‡¬","shortcode":"flag_bulgaria","name":"flag Bulgaria","code":"1F1E7-1F1EC"},{"emoji":"đŸ‡§đŸ‡­","shortcode":"flag_bahrain","name":"flag Bahrain","code":"1F1E7-1F1ED"},{"emoji":"đŸ‡§đŸ‡®","shortcode":"flag_burundi","name":"flag Burundi","code":"1F1E7-1F1EE"},{"emoji":"đŸ‡§đŸ‡¯","shortcode":"flag_benin","name":"flag Benin","code":"1F1E7-1F1EF"},{"emoji":"đŸ‡§đŸ‡±","shortcode":"flag_st_barthelemy","name":"flag St. BarthĂ©lemy","code":"1F1E7-1F1F1"},{"emoji":"đŸ‡§đŸ‡²","shortcode":"flag_bermuda","name":"flag Bermuda","code":"1F1E7-1F1F2"},{"emoji":"đŸ‡§đŸ‡³","shortcode":"flag_brunei","name":"flag Brunei","code":"1F1E7-1F1F3"},{"emoji":"đŸ‡§đŸ‡´","shortcode":"flag_bolivia","name":"flag Bolivia","code":"1F1E7-1F1F4"},{"emoji":"đŸ‡§đŸ‡¶","shortcode":"flag_caribbean_netherlands","name":"flag Caribbean Netherlands","code":"1F1E7-1F1F6"},{"emoji":"đŸ‡§đŸ‡·","shortcode":"flag_brazil","name":"flag Brazil","code":"1F1E7-1F1F7"},{"emoji":"đŸ‡§đŸ‡¸","shortcode":"flag_bahamas","name":"flag Bahamas","code":"1F1E7-1F1F8"},{"emoji":"đŸ‡§đŸ‡¹","shortcode":"flag_bhutan","name":"flag Bhutan","code":"1F1E7-1F1F9"},{"emoji":"đŸ‡§đŸ‡»","shortcode":"flag_bouvet_island","name":"flag Bouvet Island","code":"1F1E7-1F1FB"},{"emoji":"đŸ‡§đŸ‡¼","shortcode":"flag_botswana","name":"flag Botswana","code":"1F1E7-1F1FC"},{"emoji":"đŸ‡§đŸ‡¾","shortcode":"flag_belarus","name":"flag Belarus","code":"1F1E7-1F1FE"},{"emoji":"đŸ‡§đŸ‡¿","shortcode":"flag_belize","name":"flag Belize","code":"1F1E7-1F1FF"},{"emoji":"đŸ‡¨đŸ‡¦","shortcode":"flag_canada","name":"flag Canada","code":"1F1E8-1F1E6"},{"emoji":"đŸ‡¨đŸ‡¨","shortcode":"flag_cocos_islands","name":"flag Cocos (Keeling) Islands","code":"1F1E8-1F1E8"},{"emoji":"đŸ‡¨đŸ‡©","shortcode":"flag_congo_kinshasa","name":"flag Congo - Kinshasa","code":"1F1E8-1F1E9"},{"emoji":"đŸ‡¨đŸ‡«","shortcode":"flag_central_african_republic","name":"flag Central African Republic","code":"1F1E8-1F1EB"},{"emoji":"đŸ‡¨đŸ‡¬","shortcode":"flag_congo_brazzaville","name":"flag Congo - Brazzaville","code":"1F1E8-1F1EC"},{"emoji":"đŸ‡¨đŸ‡­","shortcode":"flag_switzerland","name":"flag Switzerland","code":"1F1E8-1F1ED"},{"emoji":"đŸ‡¨đŸ‡®","shortcode":"flag_cote_d_ivoire","name":"flag CĂ´te dâ€™Ivoire","code":"1F1E8-1F1EE"},{"emoji":"đŸ‡¨đŸ‡°","shortcode":"flag_cook_islands","name":"flag Cook Islands","code":"1F1E8-1F1F0"},{"emoji":"đŸ‡¨đŸ‡±","shortcode":"flag_chile","name":"flag Chile","code":"1F1E8-1F1F1"},{"emoji":"đŸ‡¨đŸ‡²","shortcode":"flag_cameroon","name":"flag Cameroon","code":"1F1E8-1F1F2"},{"emoji":"đŸ‡¨đŸ‡³","shortcode":"flag_china","name":"flag China","code":"1F1E8-1F1F3"},{"emoji":"đŸ‡¨đŸ‡´","shortcode":"flag_colombia","name":"flag Colombia","code":"1F1E8-1F1F4"},{"emoji":"đŸ‡¨đŸ‡µ","shortcode":"flag_clipperton_island","name":"flag Clipperton Island","code":"1F1E8-1F1F5"},{"emoji":"đŸ‡¨đŸ‡·","shortcode":"flag_costa_rica","name":"flag Costa Rica","code":"1F1E8-1F1F7"},{"emoji":"đŸ‡¨đŸ‡º","shortcode":"flag_cuba","name":"flag Cuba","code":"1F1E8-1F1FA"},{"emoji":"đŸ‡¨đŸ‡»","shortcode":"flag_cape_verde","name":"flag Cape Verde","code":"1F1E8-1F1FB"},{"emoji":"đŸ‡¨đŸ‡¼","shortcode":"flag_curacao","name":"flag CuraĂ§ao","code":"1F1E8-1F1FC"},{"emoji":"đŸ‡¨đŸ‡½","shortcode":"flag_christmas_island","name":"flag Christmas Island","code":"1F1E8-1F1FD"},{"emoji":"đŸ‡¨đŸ‡¾","shortcode":"flag_cyprus","name":"flag Cyprus","code":"1F1E8-1F1FE"},{"emoji":"đŸ‡¨đŸ‡¿","shortcode":"flag_czechia","name":"flag Czechia","code":"1F1E8-1F1FF"},{"emoji":"đŸ‡©đŸ‡ª","shortcode":"flag_germany","name":"flag Germany","code":"1F1E9-1F1EA"},{"emoji":"đŸ‡©đŸ‡¬","shortcode":"flag_diego_garcia","name":"flag Diego Garcia","code":"1F1E9-1F1EC"},{"emoji":"đŸ‡©đŸ‡¯","shortcode":"flag_djibouti","name":"flag Djibouti","code":"1F1E9-1F1EF"},{"emoji":"đŸ‡©đŸ‡°","shortcode":"flag_denmark","name":"flag Denmark","code":"1F1E9-1F1F0"},{"emoji":"đŸ‡©đŸ‡²","shortcode":"flag_dominica","name":"flag Dominica","code":"1F1E9-1F1F2"},{"emoji":"đŸ‡©đŸ‡´","shortcode":"flag_dominican_republic","name":"flag Dominican Republic","code":"1F1E9-1F1F4"},{"emoji":"đŸ‡©đŸ‡¿","shortcode":"flag_algeria","name":"flag Algeria","code":"1F1E9-1F1FF"},{"emoji":"đŸ‡ªđŸ‡¦","shortcode":"flag_ceuta_melilla","name":"flag Ceuta & Melilla","code":"1F1EA-1F1E6"},{"emoji":"đŸ‡ªđŸ‡¨","shortcode":"flag_ecuador","name":"flag Ecuador","code":"1F1EA-1F1E8"},{"emoji":"đŸ‡ªđŸ‡ª","shortcode":"flag_estonia","name":"flag Estonia","code":"1F1EA-1F1EA"},{"emoji":"đŸ‡ªđŸ‡¬","shortcode":"flag_egypt","name":"flag Egypt","code":"1F1EA-1F1EC"},{"emoji":"đŸ‡ªđŸ‡­","shortcode":"flag_western_sahara","name":"flag Western Sahara","code":"1F1EA-1F1ED"},{"emoji":"đŸ‡ªđŸ‡·","shortcode":"flag_eritrea","name":"flag Eritrea","code":"1F1EA-1F1F7"},{"emoji":"đŸ‡ªđŸ‡¸","shortcode":"flag_spain","name":"flag Spain","code":"1F1EA-1F1F8"},{"emoji":"đŸ‡ªđŸ‡¹","shortcode":"flag_ethiopia","name":"flag Ethiopia","code":"1F1EA-1F1F9"},{"emoji":"đŸ‡ªđŸ‡º","shortcode":"flag_european_union","name":"flag European Union","code":"1F1EA-1F1FA"},{"emoji":"đŸ‡«đŸ‡®","shortcode":"flag_finland","name":"flag Finland","code":"1F1EB-1F1EE"},{"emoji":"đŸ‡«đŸ‡¯","shortcode":"flag_fiji","name":"flag Fiji","code":"1F1EB-1F1EF"},{"emoji":"đŸ‡«đŸ‡°","shortcode":"flag_falkland_islands","name":"flag Falkland Islands","code":"1F1EB-1F1F0"},{"emoji":"đŸ‡«đŸ‡²","shortcode":"flag_micronesia","name":"flag Micronesia","code":"1F1EB-1F1F2"},{"emoji":"đŸ‡«đŸ‡´","shortcode":"flag_faroe_islands","name":"flag Faroe Islands","code":"1F1EB-1F1F4"},{"emoji":"đŸ‡«đŸ‡·","shortcode":"flag_france","name":"flag France","code":"1F1EB-1F1F7"},{"emoji":"đŸ‡¬đŸ‡¦","shortcode":"flag_gabon","name":"flag Gabon","code":"1F1EC-1F1E6"},{"emoji":"đŸ‡¬đŸ‡§","shortcode":"flag_united_kingdom","name":"flag United Kingdom","code":"1F1EC-1F1E7"},{"emoji":"đŸ‡¬đŸ‡©","shortcode":"flag_grenada","name":"flag Grenada","code":"1F1EC-1F1E9"},{"emoji":"đŸ‡¬đŸ‡ª","shortcode":"flag_georgia","name":"flag Georgia","code":"1F1EC-1F1EA"},{"emoji":"đŸ‡¬đŸ‡«","shortcode":"flag_french_guiana","name":"flag French Guiana","code":"1F1EC-1F1EB"},{"emoji":"đŸ‡¬đŸ‡¬","shortcode":"flag_guernsey","name":"flag Guernsey","code":"1F1EC-1F1EC"},{"emoji":"đŸ‡¬đŸ‡­","shortcode":"flag_ghana","name":"flag Ghana","code":"1F1EC-1F1ED"},{"emoji":"đŸ‡¬đŸ‡®","shortcode":"flag_gibraltar","name":"flag Gibraltar","code":"1F1EC-1F1EE"},{"emoji":"đŸ‡¬đŸ‡±","shortcode":"flag_greenland","name":"flag Greenland","code":"1F1EC-1F1F1"},{"emoji":"đŸ‡¬đŸ‡²","shortcode":"flag_gambia","name":"flag Gambia","code":"1F1EC-1F1F2"},{"emoji":"đŸ‡¬đŸ‡³","shortcode":"flag_guinea","name":"flag Guinea","code":"1F1EC-1F1F3"},{"emoji":"đŸ‡¬đŸ‡µ","shortcode":"flag_guadeloupe","name":"flag Guadeloupe","code":"1F1EC-1F1F5"},{"emoji":"đŸ‡¬đŸ‡¶","shortcode":"flag_equatorial_guinea","name":"flag Equatorial Guinea","code":"1F1EC-1F1F6"},{"emoji":"đŸ‡¬đŸ‡·","shortcode":"flag_greece","name":"flag Greece","code":"1F1EC-1F1F7"},{"emoji":"đŸ‡¬đŸ‡¸","shortcode":"flag_south_georgia_south_sandwich_islands","name":"flag South Georgia & South Sandwich Islands","code":"1F1EC-1F1F8"},{"emoji":"đŸ‡¬đŸ‡¹","shortcode":"flag_guatemala","name":"flag Guatemala","code":"1F1EC-1F1F9"},{"emoji":"đŸ‡¬đŸ‡º","shortcode":"flag_guam","name":"flag Guam","code":"1F1EC-1F1FA"},{"emoji":"đŸ‡¬đŸ‡¼","shortcode":"flag_guinea_bissau","name":"flag Guinea-Bissau","code":"1F1EC-1F1FC"},{"emoji":"đŸ‡¬đŸ‡¾","shortcode":"flag_guyana","name":"flag Guyana","code":"1F1EC-1F1FE"},{"emoji":"đŸ‡­đŸ‡°","shortcode":"flag_hong_kong_sar_china","name":"flag Hong Kong SAR China","code":"1F1ED-1F1F0"},{"emoji":"đŸ‡­đŸ‡²","shortcode":"flag_heard_mcdonald_islands","name":"flag Heard & McDonald Islands","code":"1F1ED-1F1F2"},{"emoji":"đŸ‡­đŸ‡³","shortcode":"flag_honduras","name":"flag Honduras","code":"1F1ED-1F1F3"},{"emoji":"đŸ‡­đŸ‡·","shortcode":"flag_croatia","name":"flag Croatia","code":"1F1ED-1F1F7"},{"emoji":"đŸ‡­đŸ‡¹","shortcode":"flag_haiti","name":"flag Haiti","code":"1F1ED-1F1F9"},{"emoji":"đŸ‡­đŸ‡º","shortcode":"flag_hungary","name":"flag Hungary","code":"1F1ED-1F1FA"},{"emoji":"đŸ‡®đŸ‡¨","shortcode":"flag_canary_islands","name":"flag Canary Islands","code":"1F1EE-1F1E8"},{"emoji":"đŸ‡®đŸ‡©","shortcode":"flag_indonesia","name":"flag Indonesia","code":"1F1EE-1F1E9"},{"emoji":"đŸ‡®đŸ‡ª","shortcode":"flag_ireland","name":"flag Ireland","code":"1F1EE-1F1EA"},{"emoji":"đŸ‡®đŸ‡±","shortcode":"flag_israel","name":"flag Israel","code":"1F1EE-1F1F1"},{"emoji":"đŸ‡®đŸ‡²","shortcode":"flag_isle_of_man","name":"flag Isle of Man","code":"1F1EE-1F1F2"},{"emoji":"đŸ‡®đŸ‡³","shortcode":"flag_india","name":"flag India","code":"1F1EE-1F1F3"},{"emoji":"đŸ‡®đŸ‡´","shortcode":"flag_british_indian_ocean_territory","name":"flag British Indian Ocean Territory","code":"1F1EE-1F1F4"},{"emoji":"đŸ‡®đŸ‡¶","shortcode":"flag_iraq","name":"flag Iraq","code":"1F1EE-1F1F6"},{"emoji":"đŸ‡®đŸ‡·","shortcode":"flag_iran","name":"flag Iran","code":"1F1EE-1F1F7"},{"emoji":"đŸ‡®đŸ‡¸","shortcode":"flag_iceland","name":"flag Iceland","code":"1F1EE-1F1F8"},{"emoji":"đŸ‡®đŸ‡¹","shortcode":"flag_italy","name":"flag Italy","code":"1F1EE-1F1F9"},{"emoji":"đŸ‡¯đŸ‡ª","shortcode":"flag_jersey","name":"flag Jersey","code":"1F1EF-1F1EA"},{"emoji":"đŸ‡¯đŸ‡²","shortcode":"flag_jamaica","name":"flag Jamaica","code":"1F1EF-1F1F2"},{"emoji":"đŸ‡¯đŸ‡´","shortcode":"flag_jordan","name":"flag Jordan","code":"1F1EF-1F1F4"},{"emoji":"đŸ‡¯đŸ‡µ","shortcode":"flag_japan","name":"flag Japan","code":"1F1EF-1F1F5"},{"emoji":"đŸ‡°đŸ‡ª","shortcode":"flag_kenya","name":"flag Kenya","code":"1F1F0-1F1EA"},{"emoji":"đŸ‡°đŸ‡¬","shortcode":"flag_kyrgyzstan","name":"flag Kyrgyzstan","code":"1F1F0-1F1EC"},{"emoji":"đŸ‡°đŸ‡­","shortcode":"flag_cambodia","name":"flag Cambodia","code":"1F1F0-1F1ED"},{"emoji":"đŸ‡°đŸ‡®","shortcode":"flag_kiribati","name":"flag Kiribati","code":"1F1F0-1F1EE"},{"emoji":"đŸ‡°đŸ‡²","shortcode":"flag_comoros","name":"flag Comoros","code":"1F1F0-1F1F2"},{"emoji":"đŸ‡°đŸ‡³","shortcode":"flag_st_kitts_nevis","name":"flag St. Kitts & Nevis","code":"1F1F0-1F1F3"},{"emoji":"đŸ‡°đŸ‡µ","shortcode":"flag_north_korea","name":"flag North Korea","code":"1F1F0-1F1F5"},{"emoji":"đŸ‡°đŸ‡·","shortcode":"flag_south_korea","name":"flag South Korea","code":"1F1F0-1F1F7"},{"emoji":"đŸ‡°đŸ‡¼","shortcode":"flag_kuwait","name":"flag Kuwait","code":"1F1F0-1F1FC"},{"emoji":"đŸ‡°đŸ‡¾","shortcode":"flag_cayman_islands","name":"flag Cayman Islands","code":"1F1F0-1F1FE"},{"emoji":"đŸ‡°đŸ‡¿","shortcode":"flag_kazakhstan","name":"flag Kazakhstan","code":"1F1F0-1F1FF"},{"emoji":"đŸ‡±đŸ‡¦","shortcode":"flag_laos","name":"flag Laos","code":"1F1F1-1F1E6"},{"emoji":"đŸ‡±đŸ‡§","shortcode":"flag_lebanon","name":"flag Lebanon","code":"1F1F1-1F1E7"},{"emoji":"đŸ‡±đŸ‡¨","shortcode":"flag_st_lucia","name":"flag St. Lucia","code":"1F1F1-1F1E8"},{"emoji":"đŸ‡±đŸ‡®","shortcode":"flag_liechtenstein","name":"flag Liechtenstein","code":"1F1F1-1F1EE"},{"emoji":"đŸ‡±đŸ‡°","shortcode":"flag_sri_lanka","name":"flag Sri Lanka","code":"1F1F1-1F1F0"},{"emoji":"đŸ‡±đŸ‡·","shortcode":"flag_liberia","name":"flag Liberia","code":"1F1F1-1F1F7"},{"emoji":"đŸ‡±đŸ‡¸","shortcode":"flag_lesotho","name":"flag Lesotho","code":"1F1F1-1F1F8"},{"emoji":"đŸ‡±đŸ‡¹","shortcode":"flag_lithuania","name":"flag Lithuania","code":"1F1F1-1F1F9"},{"emoji":"đŸ‡±đŸ‡º","shortcode":"flag_luxembourg","name":"flag Luxembourg","code":"1F1F1-1F1FA"},{"emoji":"đŸ‡±đŸ‡»","shortcode":"flag_latvia","name":"flag Latvia","code":"1F1F1-1F1FB"},{"emoji":"đŸ‡±đŸ‡¾","shortcode":"flag_libya","name":"flag Libya","code":"1F1F1-1F1FE"},{"emoji":"đŸ‡²đŸ‡¦","shortcode":"flag_morocco","name":"flag Morocco","code":"1F1F2-1F1E6"},{"emoji":"đŸ‡²đŸ‡¨","shortcode":"flag_monaco","name":"flag Monaco","code":"1F1F2-1F1E8"},{"emoji":"đŸ‡²đŸ‡©","shortcode":"flag_moldova","name":"flag Moldova","code":"1F1F2-1F1E9"},{"emoji":"đŸ‡²đŸ‡ª","shortcode":"flag_montenegro","name":"flag Montenegro","code":"1F1F2-1F1EA"},{"emoji":"đŸ‡²đŸ‡«","shortcode":"flag_st_martin","name":"flag St. Martin","code":"1F1F2-1F1EB"},{"emoji":"đŸ‡²đŸ‡¬","shortcode":"flag_madagascar","name":"flag Madagascar","code":"1F1F2-1F1EC"},{"emoji":"đŸ‡²đŸ‡­","shortcode":"flag_marshall_islands","name":"flag Marshall Islands","code":"1F1F2-1F1ED"},{"emoji":"đŸ‡²đŸ‡°","shortcode":"flag_north_macedonia","name":"flag North Macedonia","code":"1F1F2-1F1F0"},{"emoji":"đŸ‡²đŸ‡±","shortcode":"flag_mali","name":"flag Mali","code":"1F1F2-1F1F1"},{"emoji":"đŸ‡²đŸ‡²","shortcode":"flag_myanmar","name":"flag Myanmar (Burma)","code":"1F1F2-1F1F2"},{"emoji":"đŸ‡²đŸ‡³","shortcode":"flag_mongolia","name":"flag Mongolia","code":"1F1F2-1F1F3"},{"emoji":"đŸ‡²đŸ‡´","shortcode":"flag_macao_sar_china","name":"flag Macao SAR China","code":"1F1F2-1F1F4"},{"emoji":"đŸ‡²đŸ‡µ","shortcode":"flag_northern_mariana_islands","name":"flag Northern Mariana Islands","code":"1F1F2-1F1F5"},{"emoji":"đŸ‡²đŸ‡¶","shortcode":"flag_martinique","name":"flag Martinique","code":"1F1F2-1F1F6"},{"emoji":"đŸ‡²đŸ‡·","shortcode":"flag_mauritania","name":"flag Mauritania","code":"1F1F2-1F1F7"},{"emoji":"đŸ‡²đŸ‡¸","shortcode":"flag_montserrat","name":"flag Montserrat","code":"1F1F2-1F1F8"},{"emoji":"đŸ‡²đŸ‡¹","shortcode":"flag_malta","name":"flag Malta","code":"1F1F2-1F1F9"},{"emoji":"đŸ‡²đŸ‡º","shortcode":"flag_mauritius","name":"flag Mauritius","code":"1F1F2-1F1FA"},{"emoji":"đŸ‡²đŸ‡»","shortcode":"flag_maldives","name":"flag Maldives","code":"1F1F2-1F1FB"},{"emoji":"đŸ‡²đŸ‡¼","shortcode":"flag_malawi","name":"flag Malawi","code":"1F1F2-1F1FC"},{"emoji":"đŸ‡²đŸ‡½","shortcode":"flag_mexico","name":"flag Mexico","code":"1F1F2-1F1FD"},{"emoji":"đŸ‡²đŸ‡¾","shortcode":"flag_malaysia","name":"flag Malaysia","code":"1F1F2-1F1FE"},{"emoji":"đŸ‡²đŸ‡¿","shortcode":"flag_mozambique","name":"flag Mozambique","code":"1F1F2-1F1FF"},{"emoji":"đŸ‡³đŸ‡¦","shortcode":"flag_namibia","name":"flag Namibia","code":"1F1F3-1F1E6"},{"emoji":"đŸ‡³đŸ‡¨","shortcode":"flag_new_caledonia","name":"flag New Caledonia","code":"1F1F3-1F1E8"},{"emoji":"đŸ‡³đŸ‡ª","shortcode":"flag_niger","name":"flag Niger","code":"1F1F3-1F1EA"},{"emoji":"đŸ‡³đŸ‡«","shortcode":"flag_norfolk_island","name":"flag Norfolk Island","code":"1F1F3-1F1EB"},{"emoji":"đŸ‡³đŸ‡¬","shortcode":"flag_nigeria","name":"flag Nigeria","code":"1F1F3-1F1EC"},{"emoji":"đŸ‡³đŸ‡®","shortcode":"flag_nicaragua","name":"flag Nicaragua","code":"1F1F3-1F1EE"},{"emoji":"đŸ‡³đŸ‡±","shortcode":"flag_netherlands","name":"flag Netherlands","code":"1F1F3-1F1F1"},{"emoji":"đŸ‡³đŸ‡´","shortcode":"flag_norway","name":"flag Norway","code":"1F1F3-1F1F4"},{"emoji":"đŸ‡³đŸ‡µ","shortcode":"flag_nepal","name":"flag Nepal","code":"1F1F3-1F1F5"},{"emoji":"đŸ‡³đŸ‡·","shortcode":"flag_nauru","name":"flag Nauru","code":"1F1F3-1F1F7"},{"emoji":"đŸ‡³đŸ‡º","shortcode":"flag_niue","name":"flag Niue","code":"1F1F3-1F1FA"},{"emoji":"đŸ‡³đŸ‡¿","shortcode":"flag_new_zealand","name":"flag New Zealand","code":"1F1F3-1F1FF"},{"emoji":"đŸ‡´đŸ‡²","shortcode":"flag_oman","name":"flag Oman","code":"1F1F4-1F1F2"},{"emoji":"đŸ‡µđŸ‡¦","shortcode":"flag_panama","name":"flag Panama","code":"1F1F5-1F1E6"},{"emoji":"đŸ‡µđŸ‡ª","shortcode":"flag_peru","name":"flag Peru","code":"1F1F5-1F1EA"},{"emoji":"đŸ‡µđŸ‡«","shortcode":"flag_french_polynesia","name":"flag French Polynesia","code":"1F1F5-1F1EB"},{"emoji":"đŸ‡µđŸ‡¬","shortcode":"flag_papua_new_guinea","name":"flag Papua New Guinea","code":"1F1F5-1F1EC"},{"emoji":"đŸ‡µđŸ‡­","shortcode":"flag_philippines","name":"flag Philippines","code":"1F1F5-1F1ED"},{"emoji":"đŸ‡µđŸ‡°","shortcode":"flag_pakistan","name":"flag Pakistan","code":"1F1F5-1F1F0"},{"emoji":"đŸ‡µđŸ‡±","shortcode":"flag_poland","name":"flag Poland","code":"1F1F5-1F1F1"},{"emoji":"đŸ‡µđŸ‡²","shortcode":"flag_st_pierre_miquelon","name":"flag St. Pierre & Miquelon","code":"1F1F5-1F1F2"},{"emoji":"đŸ‡µđŸ‡³","shortcode":"flag_pitcairn_islands","name":"flag Pitcairn Islands","code":"1F1F5-1F1F3"},{"emoji":"đŸ‡µđŸ‡·","shortcode":"flag_puerto_rico","name":"flag Puerto Rico","code":"1F1F5-1F1F7"},{"emoji":"đŸ‡µđŸ‡¸","shortcode":"flag_palestinian_territories","name":"flag Palestinian Territories","code":"1F1F5-1F1F8"},{"emoji":"đŸ‡µđŸ‡¹","shortcode":"flag_portugal","name":"flag Portugal","code":"1F1F5-1F1F9"},{"emoji":"đŸ‡µđŸ‡¼","shortcode":"flag_palau","name":"flag Palau","code":"1F1F5-1F1FC"},{"emoji":"đŸ‡µđŸ‡¾","shortcode":"flag_paraguay","name":"flag Paraguay","code":"1F1F5-1F1FE"},{"emoji":"đŸ‡¶đŸ‡¦","shortcode":"flag_qatar","name":"flag Qatar","code":"1F1F6-1F1E6"},{"emoji":"đŸ‡·đŸ‡ª","shortcode":"flag_reunion","name":"flag RĂ©union","code":"1F1F7-1F1EA"},{"emoji":"đŸ‡·đŸ‡´","shortcode":"flag_romania","name":"flag Romania","code":"1F1F7-1F1F4"},{"emoji":"đŸ‡·đŸ‡¸","shortcode":"flag_serbia","name":"flag Serbia","code":"1F1F7-1F1F8"},{"emoji":"đŸ‡·đŸ‡º","shortcode":"flag_russia","name":"flag Russia","code":"1F1F7-1F1FA"},{"emoji":"đŸ‡·đŸ‡¼","shortcode":"flag_rwanda","name":"flag Rwanda","code":"1F1F7-1F1FC"},{"emoji":"đŸ‡¸đŸ‡¦","shortcode":"flag_saudi_arabia","name":"flag Saudi Arabia","code":"1F1F8-1F1E6"},{"emoji":"đŸ‡¸đŸ‡§","shortcode":"flag_solomon_islands","name":"flag Solomon Islands","code":"1F1F8-1F1E7"},{"emoji":"đŸ‡¸đŸ‡¨","shortcode":"flag_seychelles","name":"flag Seychelles","code":"1F1F8-1F1E8"},{"emoji":"đŸ‡¸đŸ‡©","shortcode":"flag_sudan","name":"flag Sudan","code":"1F1F8-1F1E9"},{"emoji":"đŸ‡¸đŸ‡ª","shortcode":"flag_sweden","name":"flag Sweden","code":"1F1F8-1F1EA"},{"emoji":"đŸ‡¸đŸ‡¬","shortcode":"flag_singapore","name":"flag Singapore","code":"1F1F8-1F1EC"},{"emoji":"đŸ‡¸đŸ‡­","shortcode":"flag_st_helena","name":"flag St. Helena","code":"1F1F8-1F1ED"},{"emoji":"đŸ‡¸đŸ‡®","shortcode":"flag_slovenia","name":"flag Slovenia","code":"1F1F8-1F1EE"},{"emoji":"đŸ‡¸đŸ‡¯","shortcode":"flag_svalbard_jan_mayen","name":"flag Svalbard & Jan Mayen","code":"1F1F8-1F1EF"},{"emoji":"đŸ‡¸đŸ‡°","shortcode":"flag_slovakia","name":"flag Slovakia","code":"1F1F8-1F1F0"},{"emoji":"đŸ‡¸đŸ‡±","shortcode":"flag_sierra_leone","name":"flag Sierra Leone","code":"1F1F8-1F1F1"},{"emoji":"đŸ‡¸đŸ‡²","shortcode":"flag_san_marino","name":"flag San Marino","code":"1F1F8-1F1F2"},{"emoji":"đŸ‡¸đŸ‡³","shortcode":"flag_senegal","name":"flag Senegal","code":"1F1F8-1F1F3"},{"emoji":"đŸ‡¸đŸ‡´","shortcode":"flag_somalia","name":"flag Somalia","code":"1F1F8-1F1F4"},{"emoji":"đŸ‡¸đŸ‡·","shortcode":"flag_suriname","name":"flag Suriname","code":"1F1F8-1F1F7"},{"emoji":"đŸ‡¸đŸ‡¸","shortcode":"flag_south_sudan","name":"flag South Sudan","code":"1F1F8-1F1F8"},{"emoji":"đŸ‡¸đŸ‡¹","shortcode":"flag_sao_tome_principe","name":"flag SĂ£o TomĂ© & PrĂ­ncipe","code":"1F1F8-1F1F9"},{"emoji":"đŸ‡¸đŸ‡»","shortcode":"flag_el_salvador","name":"flag El Salvador","code":"1F1F8-1F1FB"},{"emoji":"đŸ‡¸đŸ‡½","shortcode":"flag_sint_maarten","name":"flag Sint Maarten","code":"1F1F8-1F1FD"},{"emoji":"đŸ‡¸đŸ‡¾","shortcode":"flag_syria","name":"flag Syria","code":"1F1F8-1F1FE"},{"emoji":"đŸ‡¸đŸ‡¿","shortcode":"flag_eswatini","name":"flag Eswatini","code":"1F1F8-1F1FF"},{"emoji":"đŸ‡¹đŸ‡¦","shortcode":"flag_tristan_da_cunha","name":"flag Tristan da Cunha","code":"1F1F9-1F1E6"},{"emoji":"đŸ‡¹đŸ‡¨","shortcode":"flag_turks_caicos_islands","name":"flag Turks & Caicos Islands","code":"1F1F9-1F1E8"},{"emoji":"đŸ‡¹đŸ‡©","shortcode":"flag_chad","name":"flag Chad","code":"1F1F9-1F1E9"},{"emoji":"đŸ‡¹đŸ‡«","shortcode":"flag_french_southern_territories","name":"flag French Southern Territories","code":"1F1F9-1F1EB"},{"emoji":"đŸ‡¹đŸ‡¬","shortcode":"flag_togo","name":"flag Togo","code":"1F1F9-1F1EC"},{"emoji":"đŸ‡¹đŸ‡­","shortcode":"flag_thailand","name":"flag Thailand","code":"1F1F9-1F1ED"},{"emoji":"đŸ‡¹đŸ‡¯","shortcode":"flag_tajikistan","name":"flag Tajikistan","code":"1F1F9-1F1EF"},{"emoji":"đŸ‡¹đŸ‡°","shortcode":"flag_tokelau","name":"flag Tokelau","code":"1F1F9-1F1F0"},{"emoji":"đŸ‡¹đŸ‡±","shortcode":"flag_timor_leste","name":"flag Timor-Leste","code":"1F1F9-1F1F1"},{"emoji":"đŸ‡¹đŸ‡²","shortcode":"flag_turkmenistan","name":"flag Turkmenistan","code":"1F1F9-1F1F2"},{"emoji":"đŸ‡¹đŸ‡³","shortcode":"flag_tunisia","name":"flag Tunisia","code":"1F1F9-1F1F3"},{"emoji":"đŸ‡¹đŸ‡´","shortcode":"flag_tonga","name":"flag Tonga","code":"1F1F9-1F1F4"},{"emoji":"đŸ‡¹đŸ‡·","shortcode":"flag_turkey","name":"flag Turkey","code":"1F1F9-1F1F7"},{"emoji":"đŸ‡¹đŸ‡¹","shortcode":"flag_trinidad_tobago","name":"flag Trinidad & Tobago","code":"1F1F9-1F1F9"},{"emoji":"đŸ‡¹đŸ‡»","shortcode":"flag_tuvalu","name":"flag Tuvalu","code":"1F1F9-1F1FB"},{"emoji":"đŸ‡¹đŸ‡¼","shortcode":"flag_taiwan","name":"flag Taiwan","code":"1F1F9-1F1FC"},{"emoji":"đŸ‡¹đŸ‡¿","shortcode":"flag_tanzania","name":"flag Tanzania","code":"1F1F9-1F1FF"},{"emoji":"đŸ‡ºđŸ‡¦","shortcode":"flag_ukraine","name":"flag Ukraine","code":"1F1FA-1F1E6"},{"emoji":"đŸ‡ºđŸ‡¬","shortcode":"flag_uganda","name":"flag Uganda","code":"1F1FA-1F1EC"},{"emoji":"đŸ‡ºđŸ‡²","shortcode":"flag_u_s_outlying_islands","name":"flag U.S. Outlying Islands","code":"1F1FA-1F1F2"},{"emoji":"đŸ‡ºđŸ‡³","shortcode":"flag_united_nations","name":"flag United Nations","code":"1F1FA-1F1F3"},{"emoji":"đŸ‡ºđŸ‡¸","shortcode":"flag_united_states","name":"flag United States","code":"1F1FA-1F1F8"},{"emoji":"đŸ‡ºđŸ‡¾","shortcode":"flag_uruguay","name":"flag Uruguay","code":"1F1FA-1F1FE"},{"emoji":"đŸ‡ºđŸ‡¿","shortcode":"flag_uzbekistan","name":"flag Uzbekistan","code":"1F1FA-1F1FF"},{"emoji":"đŸ‡»đŸ‡¦","shortcode":"flag_vatican_city","name":"flag Vatican City","code":"1F1FB-1F1E6"},{"emoji":"đŸ‡»đŸ‡¨","shortcode":"flag_st_vincent_grenadines","name":"flag St. Vincent & Grenadines","code":"1F1FB-1F1E8"},{"emoji":"đŸ‡»đŸ‡ª","shortcode":"flag_venezuela","name":"flag Venezuela","code":"1F1FB-1F1EA"},{"emoji":"đŸ‡»đŸ‡¬","shortcode":"flag_british_virgin_islands","name":"flag British Virgin Islands","code":"1F1FB-1F1EC"},{"emoji":"đŸ‡»đŸ‡®","shortcode":"flag_u_s_virgin_islands","name":"flag U.S. Virgin Islands","code":"1F1FB-1F1EE"},{"emoji":"đŸ‡»đŸ‡³","shortcode":"flag_vietnam","name":"flag Vietnam","code":"1F1FB-1F1F3"},{"emoji":"đŸ‡»đŸ‡º","shortcode":"flag_vanuatu","name":"flag Vanuatu","code":"1F1FB-1F1FA"},{"emoji":"đŸ‡¼đŸ‡«","shortcode":"flag_wallis_futuna","name":"flag Wallis & Futuna","code":"1F1FC-1F1EB"},{"emoji":"đŸ‡¼đŸ‡¸","shortcode":"flag_samoa","name":"flag Samoa","code":"1F1FC-1F1F8"},{"emoji":"đŸ‡½đŸ‡°","shortcode":"flag_kosovo","name":"flag Kosovo","code":"1F1FD-1F1F0"},{"emoji":"đŸ‡¾đŸ‡ª","shortcode":"flag_yemen","name":"flag Yemen","code":"1F1FE-1F1EA"},{"emoji":"đŸ‡¾đŸ‡¹","shortcode":"flag_mayotte","name":"flag Mayotte","code":"1F1FE-1F1F9"},{"emoji":"đŸ‡¿đŸ‡¦","shortcode":"flag_south_africa","name":"flag South Africa","code":"1F1FF-1F1E6"},{"emoji":"đŸ‡¿đŸ‡²","shortcode":"flag_zambia","name":"flag Zambia","code":"1F1FF-1F1F2"},{"emoji":"đŸ‡¿đŸ‡¼","shortcode":"flag_zimbabwe","name":"flag Zimbabwe","code":"1F1FF-1F1FC"},{"emoji":"đŸ´ó §ó ¢ó ¥ó ®ó §ó ¿","shortcode":"flag_england","name":"flag England","code":"1F3F4-E0067-E0062-E0065-E006E-E0067-E007F"},{"emoji":"đŸ´ó §ó ¢ó ³ó £ó ´ó ¿","shortcode":"flag_scotland","name":"flag Scotland","code":"1F3F4-E0067-E0062-E0073-E0063-E0074-E007F"},{"emoji":"đŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿","shortcode":"flag_wales","name":"flag Wales","code":"1F3F4-E0067-E0062-E0077-E006C-E0073-E007F"}]}];


Base.emoji.custom = new function __BaseEmojiCustom(){
	
	/**
	 * @desc Create a custom emoji
	 */
	this.create = function(){
		Base.emoji.hide();
		
		var rows = [
			{label: "Emoji", placeholder: "Emoji name", name: "name"},
			{label: "Short code", placeholder: "Emoji short code, custom_ will be automatically added", name: "shortcode"},
			{label: "Image (png)", type: "file", accept: "png", name: "file"},
		];
		
		Form.v2({
			rows: rows,
			action: Base.domain("account")+"/ajax/api/emoji/create",
			buttons: Form.button(":submit", function(code, ref){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Client.emojis.unshift(code.emoji);
				Base.emoji.update();
			}).button(":cancel"),
			title: "Create custom emoji"
		});
	};
	
	
	
	/**
	 * @desc Add or remove a custom emoji
	 */
	this.manage = function(){
		
	};
	
};


Base.emoji.giphy = new function __Giphy(){
	var apikey = "Zl5GZLHbEnJPt0nBy01QGYWFRkrcD1K7";
	var base_sets = [];
	var callback;
	var autohide = true;
	
	
	this.init = function(opts, _callback){
		if (!opts){
			opts = {};
		}
		
		if ('icon' in opts){
			detectPosition(opts);
		}
		
		if ($("#js-base-gif").is(":visible")){
			$("#js-base-gif").hide();
			return;
		}
		
		callback = _callback;
		_init(opts);
	};
	
	
	this.hide = function(){
		$("#js-base-gif").hide();
	};
	
	
	/**
	 * @desc Callback action onSelect
	 */
	this.onSelect = function(emj){
		// Autoclose
		if (autohide){
			$("#js-base-gif").hide();
		}
		
		if (callback){
			callback(emj);
		}
	};
	
	
	
	/**
	 * @desc Load fixed base gifs
	 */
	this.load = function(key, configs){
		configs.key=key;
		base_sets.push({
			name: key,
			items: configs
		});
	};
	
	
	
	/**
	 * @desc Initialize the canvas
	 */
	function _init(opts){
		if ('autohide' in opts && opts.autohide){
			autohide = opts.autohide;
		}else{
			autohide = true;
		}
		
		if ($("#js-base-gif").length){
			$("#js-base-gif").show().css(Render.position.get(opts));
			return;
		}
		
		var darkmode = (Client.darkmode&&parseInt(Client.darkmode))?'-darkmode':'';
		var html = "<div class='base-emoji-canvas "+(darkmode)+"' id='js-base-gif' style='"+(Render.position.getText(opts))+"'> <div class='base-emoji'> <div class='be-header'> <div class='be-tab -text active' data-page='giphy' title='{{Giphy}'>Giphy gifs</div> <div class='be-tab -text' data-page='giphy-sticker' title='{{Giphy stickers}'>Giphy stickers</div> <div class='be-tab -text' data-page='giphy-random' title='{{Giphy random}'>Random</div> <div class='be-tab -text hidden' data-page='gfycat' title='{{Gfycat}'>Gfycat</div> <div class='be-tab -text' data-page='base' title='Base'>Base</div> <div class='close js-close'><span class='-ap icon-ion-android-close'></span></div> </div> <div class='be-page js-page-base'> <div class='be-body -ext'> <div class='be-body-inner' data-autoscroll='1' data-autohide='1'> "+(getBaseGifs())+" </div> </div> </div> <div class='be-page js-page-giphy active' data-page='giphy'> <div class='be-search -wb'> " +Render.render('search', {placeholder: "Search gifts in Giphy" , disable_autocomplete:1}, '')+ " " +Render.render('button', {title: "TĂ¬m kiáº¿m" , cta:1}, '')+ "</div> <div class='be-body'> <div class='be-fake-header hidden'></div> <div class='be-body-inner' data-autoscroll='1' data-autohide='1'> <div class='js-gifs ggifs'> "+(guides())+" <div class='js-trending' style='margin-top:20px'></div> </div> <div class='js-more load-more hidden'>Load more</div> <div class='brand'> <img src='"+(Client.share_url)+"/plugins/giphy.dark.png' class='-brand-dark'> <img src='"+(Client.share_url)+"/plugins/giphy.white.png' class='-brand-white'> </div> </div> </div> </div> <div class='be-page js-page-giphy-sticker' data-page='giphy-sticker'> <div class='be-search -wb'> " +Render.render('search', {placeholder: "Search stickers in Giphy" , disable_autocomplete:1}, '')+ " " +Render.render('button', {title: "TĂ¬m kiáº¿m" , cta:1}, '')+ "</div> <div class='be-body'> <div class='be-fake-header hidden'></div> <div class='be-body-inner' data-autoscroll='1' data-autohide='1'> <div class='js-gifs ggifs'>"+(guides())+"</div> <div class='js-more load-more hidden'>Load more</div> <div class='brand'> <img src='"+(Client.share_url)+"/plugins/giphy.dark.png' class='-brand-dark'> <img src='"+(Client.share_url)+"/plugins/giphy.white.png' class='-brand-white'> </div> </div> </div> </div> <div class='be-page js-page-giphy-random' data-page='giphy-random'> <div class='be-search -wb'> " +Render.render('search', {placeholder: "Random gifs in Giphy" , disable_autocomplete:1}, '')+ " " +Render.render('button', {title: "Random" , cta:1}, '')+ "</div> <div class='be-body'> <div class='be-fake-header hidden'></div> <div class='be-body-inner' data-autoscroll='1' data-autohide='1'> <div class='js-gifs ggifs'>"+(guides())+"</div> <div class='brand'> <img src='"+(Client.share_url)+"/plugins/giphy.dark.png' class='-brand-dark'> <img src='"+(Client.share_url)+"/plugins/giphy.white.png' class='-brand-white'> </div> </div> </div> </div> <div class='be-page js-page-gfycat' data-page='gfycat'> <div class='be-search -wb'> " +Render.render('search', {placeholder: "Search in Gfycat" , disable_autocomplete:1}, '')+ " " +Render.render('button', {title: "TĂ¬m kiáº¿m" , cta:1}, '')+ "</div> <div class='be-body'> <div class='be-fake-header hidden'></div> <div class='be-body-inner' data-autoscroll='1' data-autohide='1'> <div class='js-gifs ggifs'>"+(guides())+"</div> <div class='js-more load-more hidden'>Load more</div> </div> </div> </div> </div> </div>";
		
		$(document.body).append(html);
		Layout.scrollable("#js-base-gif .be-body-inner");
		
		$("#js-base-gif .js-close").click(function(){
			$("#js-base-gif").hide();
		});
		
		$("#js-base-gif .be-header .be-tab").click(function(){
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			
			$("#js-base-gif .be-page").removeClass("active");
			$("#js-base-gif .js-page-"+$(this).data("page")).addClass("active");
			$("#js-base-gif .js-page-"+$(this).data("page")).find(".base-search input").autofocus();
		});
		
		$("#js-base-gif .be-search .base-button").on("click", function(){
			$(this).parent().find("input").triggerEnter();
		});
		
		$("#js-base-gif .base-search input").enter(function(){
			var val = $(this).val();
			if (!val){
				$(this).closest(".be-page").find(".js-gifs").html(guides());
				$(this).closest(".be-page").find(".js-more").hide();
				return;
			}
			
			activateSearch(val, this);
		});
		
		$("#js-base-gif").on("click", ".js-gif", function(){
			var emj = {
				gif: $(this).data('gif'),
				type: $(this).data('type'),
			}
			
			Base.emoji.giphy.onSelect(emj);
		});
		
		showTrendings();
		$("#js-base-gif .js-more").click(function(){
			loadMoreGifs(this);
		});
	};
	
	
	function guides(){
		return "  " +Render.render('flag_message', {icon: "ap favorite_outline" , color: "success" , style: "margin:10px 10px 0 0" , title: "Please choose the right keyword" , sm:1}, "You are responsible for the images/stickers you share.")+ '';
	};
	
	
	function getBaseGifs(){
		return html = AP.render(base_sets, function(e){
			var items = AP.render(range(e.items.start, e.items.end), function(g){
				var url = ""+(Client.share_url)+"/stickers/"+(e.items.key)+"/"+(g)+".gif";
				return "<div class='bgif js-gif' data-gif='"+(url)+"' data-type='base'> <img src='"+(url)+"'/> </div>";
			});
			
			return "<div class='be-group'> " +Render.render('title', {}, ""+(e.name)+"")+ "<div class='be-gifs -fixed'>"+(items)+"</div> </div>";
		});
	};
	
	
	/**
	 * @desc Activate search, return 20 result
	 */
	function activateSearch(val, ref){
		var $more = $(ref).closest(".be-page").find(".js-more");
		$more.data("page_id", 0).data("cursor", "");
		
		$(ref).closest(".be-page").find(".js-gifs").empty().html("");
		
		showResults(ref, val, 0);
		$more.show();
	};
	
	
	function loadMoreGifs(ref){
		var val = $(ref).closest(".be-page").find(".search input").val();
		var $more = $(ref).closest(".be-page").find(".js-more");
		var page_id = $more.data("page_id") || 0;
		page_id = parseInt(page_id) + 1;
		
		$more.data("page_id", page_id);
		showResults(ref, val, page_id);
	};
	
	
	function showTrendings(){
		var url = "https://api.giphy.com/v1/gifs/trending?api_key="+(apikey)+"&limit=20&rating=g";
		
		$.ajax({
			url: url,
			type: "GET",
			dataType: "json",
		    contentType: "application/json; charset=utf-8"
		}).done(function(code){
			var html= AP.render(code.data, function(e){
				return getGif(e);
			});
			
			$("#js-base-gif").find(".js-trending").html(html);
		}).fail(function(){
			$(ref).closest(".base-search").ajaxHide();
		});
	};
	
	
	
	function showResults(ref, val, page_id){
		$(ref).closest(".base-search").ajaxShow();
		var page = $(ref).closest(".be-page").data("page");
		
		var endpoint = 'gifs/search';
		if (page == 'giphy-sticker'){
			endpoint = 'stickers/search';
		}else if (page == 'giphy-random'){
			endpoint = 'gifs/random';
		}
		
		var ipp = 20;
		var offset = page_id*ipp;
		if (offset > 1000){
			return;
		}
		
		var url = "https://api.giphy.com/v1/"+(endpoint)+"?api_key="+(apikey)+"&limit="+(ipp)+"&rating=g&q="+(AP.encodeURI(val))+"&offset="+(offset)+"";
		
		if (page == "gfycat"){
			url = "https://api.gfycat.com/v1/gfycats/search?search_text="+(AP.encodeURI(val))+"";
			var cursor = $(ref).closest(".be-page").find(".js-more").data("cursor");
			
			if (cursor){
				url += "&cursor="+(cursor)+"";
			}
		}
		
		$.ajax({
			url: url,
			type: "GET",
			dataType: "json",
		    contentType: "application/json; charset=utf-8"
		}).done(function(code){
			$(ref).closest(".base-search").ajaxHide();
			if (page == "gfycat"){
				$(ref).closest(".be-page").find(".js-more").data("cursor", code.cursor);
				return renderGfys(code.gfycats, ref);	
			}
			
			renderGifs(code.data, ref);
		}).fail(function(){
			$(ref).closest(".base-search").ajaxHide();
		});
		
	};
	
	
	
	/**
	 * @desc Rendering a single gif
	 */
	function renderGifs(data, ref){
		var html = "";
		if (AP.data.isArray(data)){
			html= AP.render(data, function(e){
				return getGif(e);
			});	
		}else{
			html = getGif(data);
		}
		
		$(ref).closest(".be-page").find(".js-gifs").append(html);
	};
	
	
	/**
	 * @desc Rendering a single gif
	 */
	function renderGfys(data, ref){
		var html= AP.render(data, function(e){
			return getGif({
				images: {
					downsized: {
						url: e.content_urls.max1mbGif.url
					},
					fixed_height: {
						url: e.content_urls.max2mbGif.url,
					}
				},
				embed_url: e.gifURL,
				origin: e
			});
		});
		
		$(ref).closest(".be-page").find(".js-gifs").append(html);
	};
	
	
	/**
	 * @desc Get a single gif
	 */
	function getGif(e){
		
		return "<div class='ggif js-gif' data-gif='"+(safe(e.images.downsized.url))+"' data-embed='"+(safe(e.embed_url))+"' data-type='giphy'> <div class='_gif'><img src='"+(e.images.fixed_height.url)+"'/></div> </div>";
	};
	
	
	function detectPosition(opts){
		var offset = $(opts.icon).offset();
		opts.left = offset.left-380;
		var _top = offset.top-350;
		
		if (_top<0){
			opts.top = offset.top+40;
		}else{
			opts.top = _top;
		}
	};
};





Base.emoji.giphy.load("tuzki",{
	"name":"Tuzki",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":15,
});


Base.emoji.giphy.load("puppy",{
	"name":"Puppy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});



Base.emoji.giphy.load("kitty",{
	"name":"Kitty",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});



Base.emoji.giphy.load("cute",{
	"name":"Cute",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});





Base.emoji.giphy.load("cotton",{
	"name":"Candy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});





Base.emoji.giphy.load("nerd",{
	"name":"Nerdy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":15,
});



//Base.emoji.giphy.load("bunny",{
//	"name":"Bunny",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":36,
//});
//
//
//Base.emoji.giphy.load("rabbit",{
//	"name":"Rabbit",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":29,
//});



//Base.emoji.giphy.load("princess",{
//	"name":"Princess",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":40,
//});



Base.emoji.giphy.load("owl",{
	"name":"Owla",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});




//Base.emoji.giphy.load("pancake",{
//	"name":"Pancake",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":17,
//});



Base.emoji.giphy.load("bigeye",{
	"name":"Big Eyes",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});


Base.emoji.giphy.load("alien",{
	"name":"Alien",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":43,
});






//Base.emoji.giphy.load("fatcat",{
//	"name":"Fatcat",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":36,
//});



//Base.emoji.giphy.load("snoppy",{
//	"name":"Snoppy",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":28,
//});


//Base.emoji.giphy.load("jellyfish",{
//	"name":"Jellyfish",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":40,
//});


//Base.emoji.giphy.load("ducky",{
//	"name":"Ducky",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":32,
//});



//Base.emoji.giphy.load("meow",{
//	"name":"Meow",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":26,
//});


//Base.emoji.giphy.load("potato",{
//	"name":"Potato",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":50,
//});


//Base.emoji.giphy.load("troll",{
//	"name":"Meme",
//	"type":"simple",
//	"file":"png",
//	"start":1,
//	"end":16,
//});



Render.on("emoji", function(){
	if ('code' in this){
		var emj = Base.emoji.getByCode(this.code);
		
		if (this.size && AP.data.isInt(this.size)){
			this.css("font-size", this.size+"px");
		}
		
		if (emj){
			if (AP.word.prefix(emj.code, "custom-")){
				return "<span class='js-emoji base-emoji-inline' "+(this.css())+"><img src='"+(emj.emoji)+"'/></span>";
			}else{
				if (this.use_svg || Base.emoji.forced_svg){
					if (this.size && AP.data.isInt(this.size)){
						this.css("width", this.size+"px");
						this.css("height", this.size+"px");
					}
					
					var svg = "<img src='"+(Client.share_url)+"/twemoji/svg/"+(emj.code)+".svg'/>";
					return "<span class='js-emoji base-emoji-inline' title='"+(emj.emoji)+"' "+(this.css())+">"+(svg)+"</span>";
				}else{
					return "<span class='js-emoji base-emoji-inline' "+(this.css())+">"+(emj.emoji)+"</span>";	
				}	
			}
		}else{
			
		}
	}
	
	
	if (this.emoji){
		if (this.size && AP.data.isInt(this.size)){
			this.css("font-size", this.size+"px");
		}
		
		return "<span class='js-emoji base-emoji-inline -direct' "+(this.css())+">"+(this.emoji)+"</span>";	
	}
	
	return '';
});
var analytics = window.analytics = window.analytics || [];
if (!analytics.initialize) if (analytics.invoked) window.console && console.error && console.error("Segment snippet included twice.");
else {
	analytics.invoked = !0; analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "reset", "group", "track", "ready", "alias", "debug", "page", "once", "off", "on"]; analytics.factory = function (t) { return function () { var e = Array.prototype.slice.call(arguments); e.unshift(t); analytics.push(e); return analytics } }; for (var t = 0; t < analytics.methods.length; t++) { var e = analytics.methods[t]; analytics[e] = analytics.factory(e) } analytics.load = function (t, e) { var n = document.createElement("script"); n.type = "text/javascript"; n.async = false; n.defer = true; n.src = "https://cdn.segment.com/analytics.js/v1/" + t + "/analytics.min.js"; var a = document.getElementsByTagName("script")[0]; a.parentNode.insertBefore(n, a); analytics._loadOptions = e }; analytics.SNIPPET_VERSION = "4.1.0";
	analytics.load("MGF8H9rbs8aPiKP5nXXbmu0RkWRjLo1M");//SegmentId
	analytics.page();
};


if ((Client.env == 1 && Client.domain == "base.vn") && Client.viewer && Client.viewer.id && Client.base && Client.base.app && (typeof Client.viewer.system_id != 'undefined')){
	analytics.identify(Client.viewer.id,{
		name: Client.viewer.name, 
		email: Client.viewer.email, 
		account_id: Client.viewer.system_id,
		product_id: Client.base.app,
		user_base_uid: Client.viewer.id
	});

	analytics.group(Client.viewer.system_id, {
		name: Client.system.name,
		employees: Client.people.length,
		"system_id": Client.viewer.system_id
	});
};


function url_track($ref){
	var feature=$ref.data("feature");
	if (!feature || !AP.data.isString(feature) || !feature.length){
		return;
	}
	
	var parts=feature.split(":");
	if (parts.length==3){
		return raw_track(parts[0], parts[1], parts[2]);
	}else if (parts.length==2){
		return raw_track(parts[0], parts[1]);
	}
	
};


function raw_track(module_id, feature_id, ref){
	if (!ref){
		ref="none";
	}
	
	if ((Client.env == 1 && Client.domain == "base.vn") && Client.viewer && Client.viewer.id && Client.base && Client.base.app){
		analytics.track(feature_id, {
			account_id: Client.viewer.system_id,
			user_id: Client.viewer.id,
			user_base_uid: Client.viewer.id,
			product_id: Client.base.app,
			module_id: module_id,
			
			feature_id: feature_id,
			location: ref,
			type: ref,
		});
	}
};


function page_identify(){
	analytics.page({
		account_id: Client.viewer.system_id,
		user_id: Client.viewer.id,
		user_base_uid: Client.viewer.id
	});
};
SVG.group("basic ui", {	
	document: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path d='M9 1H4a2 2 0 00-2 2v10a2 2 0 002 2h5v-1H4a1 1 0 01-1-1V3a1 1 0 011-1h5v2.5A1.5 1.5 0 0010.5 6H13v2h1V6L9 1z'></path><path fill-rule='evenodd' d='M15.854 10.146a.5.5 0 010 .708l-3 3a.5.5 0 01-.708 0l-1.5-1.5a.5.5 0 01.708-.708l1.146 1.147 2.646-2.647a.5.5 0 01.708 0z'></path></svg>",
	target_4: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16px' height='16px'><path d='M 7 0 L 7 2.023438 C 4.367188 2.265625 2.265625 4.367188 2.023438 7 L 0 7 L 0 8 L 2.023438 8 C 2.265625 10.632813 4.367188 12.734375 7 12.972656 L 7 15 L 8 15 L 8 12.972656 C 10.632813 12.734375 12.734375 10.632813 12.972656 8 L 15 8 L 15 7 L 12.972656 7 C 12.734375 4.367188 10.632813 2.265625 8 2.023438 L 8 0 Z M 7 3.050781 L 7 4 L 8 4 L 8 3.050781 C 10.085938 3.28125 11.71875 4.914063 11.949219 7 L 11 7 L 11 8 L 11.949219 8 C 11.71875 10.085938 10.085938 11.71875 8 11.949219 L 8 11 L 7 11 L 7 11.949219 C 4.914063 11.71875 3.28125 10.085938 3.050781 8 L 4 8 L 4 7 L 3.050781 7 C 3.28125 4.914063 4.914063 3.28125 7 3.050781 Z'/></svg>",
	platform_api: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' width='48px' height='48px'><path d='M 9.5 7 C 6.4802259 7 4 9.4802259 4 12.5 L 4 35.5 C 4 38.519774 6.4802259 41 9.5 41 L 38.5 41 C 41.519774 41 44 38.519774 44 35.5 L 44 12.5 C 44 9.4802259 41.519774 7 38.5 7 L 9.5 7 z M 9.5 10 L 38.5 10 C 39.898226 10 41 11.101774 41 12.5 L 41 35.5 C 41 36.898226 39.898226 38 38.5 38 L 9.5 38 C 8.1017741 38 7 36.898226 7 35.5 L 7 12.5 C 7 11.101774 8.1017741 10 9.5 10 z M 16 18 C 15.487 18 15.026891 18.313016 14.837891 18.791016 L 11.087891 28.291016 C 10.834891 28.933016 11.149016 29.658109 11.791016 29.912109 C 12.435016 30.166109 13.158109 29.850984 13.412109 29.208984 L 13.792969 28.25 L 18.210938 28.25 L 18.589844 29.208984 C 18.781844 29.700984 19.252953 30 19.751953 30 C 19.903953 30 20.058984 29.972109 20.208984 29.912109 C 20.850984 29.659109 21.165109 28.933016 20.912109 28.291016 L 17.162109 18.791016 C 16.973109 18.313016 16.513 18 16 18 z M 24.25 18 C 23.56 18 23 18.56 23 19.25 L 23 28.75 C 23 29.44 23.56 30 24.25 30 C 24.94 30 25.5 29.44 25.5 28.75 L 25.5 27 L 27.5 27 C 29.981 27 32 24.981 32 22.5 C 32 20.019 29.981 18 27.5 18 L 24.25 18 z M 35.25 18 C 34.56 18 34 18.56 34 19.25 L 34 28.75 C 34 29.44 34.56 30 35.25 30 C 35.94 30 36.5 29.44 36.5 28.75 L 36.5 19.25 C 36.5 18.56 35.94 18 35.25 18 z M 25.5 20.5 L 27.5 20.5 C 28.603 20.5 29.5 21.397 29.5 22.5 C 29.5 23.603 28.603 24.5 27.5 24.5 L 25.5 24.5 L 25.5 20.5 z M 16 22.654297 L 17.222656 25.75 L 14.777344 25.75 L 16 22.654297 z'/></svg>",
	
	ui_filter: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path d='M6 12h4v-2H6v2zM2 4v2h12V4H2zm2 5h8V7H4v2z'></path></svg>",
});




AP.rewrite("::uikit/([a-zA-Z0-9\+\.]+)", "uikit?action=$1", function(qs){
	if (qs.action=="notis"){
		return Base.toggle("notis");
	}
	
	if (qs.action=="apps"){
		return Base.toggle("apps");
	}
	
	if (qs.action=="showobj"){
		return UIKit.obj.show();
	}
	
	if (qs.action=="showobjfull"){
		return UIKit.obj.showFull();
	}
	
});


Render.helper = new function __RenderHelper(){
	
	
	/**
	 * @desc Get value
	 */
	this.getValue = function(v, unit, verbatim){
		if (typeof v == "undefined"){
			return "---";
		}
		
		if (verbatim && parseInt(verbatim)){
			return v;
		}
		
		if (unit){
			if (AP.data.isInt(v) || AP.data.isNumber(v)){
				return AP.data.numberFormat(v);
			}
		}
		
		return v;
	};
	
	/**
	 * @desc Get internal icon
	 */
	this.getIcon = function(obj, set_color){
		if ('emoji' in obj && obj.emoji){
			return "  " +Render.render('emoji', {code:obj.emoji, use_svg:obj.use_svg||'', size:obj.size||''}, '')+ '';
		}
		
		var icon = obj.svg;
		if (icon){
			if (AP.data.isString(icon) && icon.length <= 32){
				icon = SVG[icon];
				return icon;
			}else{
				return icon;
			}
		}
		
		icon = obj.icon;
		
		if (!icon){
			return '';
		}
		
		var ec = [];
		
		if (set_color || obj.icon_color){
			var cx=obj.icon_color;
			if (!cx && set_color){
				cx=obj.color;
			}
			
			if (cx){
				var color = this.getColor(cx);

				if (icon == "dot"){
					ec.push("background-color: "+(color)+"");	
				}else{
					ec.push("color: "+(color)+"");
				}
				
			}	
		}
		
		
		// Special case
		if (icon == 'dot'){
			return "<span class='-idot' style='"+(ec.join(' '))+"'></span>";
		}
		
		if (AP.word.prefix(icon, "ap ")){
			return "<span class='ap-icon' style='"+(ec.join(' '))+"'><span class='-ap icon-"+(icon.substr(3))+"'></span></span>";
		}
		
		if (AP.word.prefix(icon, "fa ")){
			return "<span class='fa-icon' style='"+(ec.join(' '))+"'><span class='-ficon ficon-"+(icon.substr(3))+"'></span></span>";
		}
		
		if (icon.length<=32){
			if (AP.word.prefix(icon, 'edge ')){
				return "<span class='-icon-svg -edge-svg' style='"+(ec.join(' '))+"' data-svgicon='"+(icon)+"'>"+(SVG._edge_icons[icon.substr(5)])+"</span>";
			}
			
			return "<span class='-icon-svg' data-svgicon='"+(icon)+"' style='"+(ec.join(' '))+"'>"+(SVG[icon]||'')+"</span>";
		}
		
		if (AP.word.prefix(icon, "https://")){
			return "<img class='-img-icon' src='"+(icon)+"'>";
		}
		
		return icon;
		
	};
	
	
	
	this.getIconByName = function(icon){
		if (AP.data.isString(icon) && icon.length >= 64){
			return icon;
		}
		
		if (AP.word.prefix(icon, "ap")){
			return "<span class='ap-icon'><span class='-ap icon-"+(icon.substr(3))+"'></span></span>";
		}
		
		if (AP.word.prefix(icon, "fa")){
			return "<span class='fa-icon''><span class='-ficon ficon-"+(icon.substr(3))+"'></span></span>";
		}
		
		if (AP.word.prefix(icon, 'edge ')){
			return "<span class='-edge-svg'>"+(SVG._edge_icons[icon.substr(5)])+"</span>";
		}
		
		return SVG[icon];
	};
	
	
	
	this.getIconType = function(obj){
		var icon = obj.icon;
		if (!icon){
			return "-icon-none";
		}
		
		if (AP.data.isString(icon) && icon.length >= 64){
			return '-icon-is-svg';
		}
		
		if (AP.word.prefix(icon, "ap")){
			return "-icon-is-ap";
		}
		
		if (AP.word.prefix(icon, "fa")){
			return "-icon-is-fa";
		}
		
		if (AP.word.prefix(icon, 'edge ')){
			return "icon-svg icon-svg-edge";
		}
		
		return 'icon-svg';
	};
	
	
	
	/**
	 * @desc Check if a color is hex
	 */
	this.isHexColor = function(color){
		return /^#[0-9A-F]{6}$/i.test(color) || /^#[0-9A-F]{3}$/i.test(color);
	};
	
	
	this.getColor = function(color, df){
		var r = "#aaaaaa";
		
		if (this.isHexColor(color)){
			if (color.length==4){
				r = color+color.substr(1);
			}else{
				r = color;	
			}
		}else{
			if (AP.word.prefix(color, 'rgba(')){
				return color;
			}
			
			r = Color.get(color);
		}
		

		if (!r){
			return df;
		}
		
		return r;
	};
	
	
	this.getFunction = function(str){
		return getFunctionByName(str);
	};
	
	
	
	
	
	this.getTextContent = function(obj){
		if (obj.ap_xdot || obj.fit){
			return "<div class='ap-xdot'>"+(obj.content)+"</div>";
		}
		
		return obj.content;
	};
	
	
	
	this.showCode=function(block){
		$(block).each(function(){
			hljs.highlightBlock($(this)[0]);
		});
	};
	

	this.escape = function(content){
		var cx=content.replace(/&amp;/g, '&').replace(/&#8216;/g, "'").replace(/&#9290;/g, "&#92;").replace(/&#39;/g, "`").replace(/â‘/g, "&#92;").replace(/â€˜/g, "'").replace(/&lsquo;/g, "'").replace(/\{br\}/g,'<br>').replace(/\n/g,'<br>').replace(/\t/g,'&nbsp;&nbsp;&nbsp;&nbsp;');
		return cx;
	};
	
	
	this.acl = function(acl_key){
		if (typeof acl_key == 'undefined'){
			return true;
		}
		
		return computeACL(acl_key);
	};
	
	
	this.safeUnit = function(unit){
		if (AP.data.isString(unit) && unit.indexOf("%")!=-1){
			return unit;
		}
		
		return unit+"px";
	};
	
	
	this.getOpts = function(opts, empty){
		var html = AP.render(opts, function(e){
			return "<option value='"+(e.id||e.value)+"'>"+(e.name||e.label)+"</option>";
		});
		
		if (empty){
			html = "<option value=''>"+(empty)+"</option>"+html;
		}
		
		return html;
	};
	
	function computeACL(acl_key){
		
		if (acl_key === true){
			return true;
		}else if (acl_key === false){
			return false;
		}  
		
		if (acl_key === "1"){
			return true;
		}
		
		if (acl_key === "0"){
			return false;
		}
		
		if (AP.data.isInt(acl_key)){			
			if (parseInt(acl_key) == 0){
				return false;
			}
			
			if (parseInt(acl_key) == 1){
				return true;
			}
			
			return false;
		}
	
		
		if (acl_key == "sys:owner"){
			if (!Me.isSystemOwner()){
				return false;
			}else{
				return true;
			}
		}
		
		if (acl_key == "sys:admin"){
			if (!Me.isSystemAdmin()){
				return false;
			}else{
				return true;
			}
		}
		
		if (acl_key == "web"){
			if (mobile()){
				return false;
			}
			
			return true;
		}
		
		if (acl_key == "mobile"){
			if (mobile()){
				return true;
			}
			
			return false;
		}
		
		if (acl_key == "app:admin"){
			if (!Me.isAppAdmin()){
				return false;
			}else{
				return true;
			}
		}
		
		
		if (acl_key == "dev"){
			if (parseInt(Client.env)){
				return false;
			}else{
				return true;
			}
		}
		
		if (typeof acl_key === "undefined"){
			return false;
		}
		
		if (acl_key && !AP.data.isNumber(acl_key) && !AP.data.isString(acl_key)){
			return false;
		}
		
		var mparts = AP.word.split("|", acl_key);
		
		if (mparts && mparts.length>=2){
			for (var i=0; i<mparts.length; i++){
				if (computeACL(mparts[i])){
					return true;
				}
			}
			
			return false;
		}
		
		var aparts = AP.word.split("+", acl_key);
		
		if (aparts && aparts.length>=2){
			for (var i=0; i<aparts.length; i++){
				if (!computeACL(aparts[i])){
					return false;
				}
			}
			
			return true;
		}
		
		
		
		var parts = acl_key.split(":");
		if (parts.length==2){
			if (parts[0] =="appkey"){
				if (Client.base && Client.base.app == parts[1]){
					return true;
				}
				
				return false;
			}
			
			if (parts[0] =="appenabled"){
				if (Base.appEnabled(parts[1])){
					return true;
				}
				
				return false;
			}
			
			if (parts[0] =="sys"||parts[0] =="sysid"){
				if (Client.system && parseInt(Client.system.id) == parseInt(parts[1])){
					return true;
				}
				
				return false;
			}
			
			if (!acl(parts[0], parts[1])){
				return false; // NO RENDER because of failed ACL
			}
		}else if (parts.length==1){
			if (!acl(parts[0], 1)){
				return false; // NO RENDER because of failed ACL
			}
		}
		
		return true;
	};
	
	
};



Render.on("url", function(){
	if (this.param){
		return "<span class='url base-url "+(this.get('class'))+"' data-urlparam='"+(this.param)+"' data-value='"+(this.value)+"'>"+(this.content)+"</span>";
	}
	
	if (this.username){
		return "<span class='url base-url "+(this.get('class'))+"' data-username='"+(this.username)+"'>"+(this.content)+"</span>";
	}
	
	if (this.color){
		this.css("color", Render.helper.getColor(this.color));
	}
	
	return "<span class='url base-url "+(this.get('class'))+"' "+(this.css())+" data-url='"+(this.url)+"'>"+(this.content)+"</span>";
});



Render.on("image", function(){
	if (this.logo){
		return "<span class='base-image base-logo'><img src='"+(Client.share_url)+"/apps/"+(this.logo)+".png'/></span>";
	};
	
	if (this.src){
		if (AP.word.prefix(this.src,'<img')){
			return "<span class='base-image -direct-html'>"+(this.src)+"</span>";
		}else{
			return "<span class='base-image -direct-src'><img src='"+(this.src)+"'/></span>";	
		}
	}
	
	return "";
});



Render.on("photo", function(){
	if (this.width){
		this.css("width", this.width+"px");
	}
	
	if (this.bg){
		this.css("background-color", Color.get(this.bg));
	}
	
	var mask = '';
	if (this.mask){
		mask = "<div class='-mask'><div class='-txt'><div class='-lb'>"+(this.mask)+"</div></div></div>";
	}
	
	if (this.ratio){
		var parts = this.ratio.split(":");
		var ratio = 100*parseFloat(parts[1])/parseFloat(parts[0]);
		
		return "<div "+(this.showURL())+" class='base-photo -fixed-ratio "+(this.get('class'))+"'> <div class='-fixed-adjust' style='padding-bottom:"+(ratio)+"%'></div> <div class='-fixed-inner' "+(this.css())+"> " +Render.render('image', {src:this.src}, '')+ "</div> "+(mask)+" </div>";	
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	return "<div "+(this.showURL())+" class='base-photo "+(this.get('class'))+"' "+(this.css())+"> " +Render.render('image', {src:this.src}, '')+ ""+(mask)+" </div>";
});



Render.on("gallery", function(){
	if (!this.images.length){
		return '';
	}
	
	if (this.images.length === 1){
		return "<div class='base-gallery -is-single' "+(this.show('id'))+"> " +Render.render('photo', {src:this.images[0].src, url: "::base/file?file="+(Base64.encodeURI(this.images[0].src))+"&list=base-photo&container=base-gallery" , fit:1}, '')+ "</div>";
	}else if (this.images.length === 2){
		return "<div class='base-gallery -is-double' "+(this.show('id'))+"> " +Render.render('cols', {equal:1}, '' +Render.render('photo', {src:AP.zthumb(this.images[0].src), url: "::base/file?file="+(Base64.encodeURI(this.images[0].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ " " +Render.render('photo', {src:AP.zthumb(this.images[1].src), url: "::base/file?file="+(Base64.encodeURI(this.images[1].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ '')+ "</div>";
	}else if (this.images.length === 3){
		return "<div class='base-gallery -is-ext'  "+(this.show('id'))+"> " +Render.render('photo', {src:AP.thumb(this.images[0].src, 3), url: "::base/file?file="+(Base64.encodeURI(this.images[0].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ " " +Render.render('cols', {equal:1}, '' +Render.render('photo', {src:AP.zthumb(this.images[1].src), url: "::base/file?file="+(Base64.encodeURI(this.images[1].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ " " +Render.render('photo', {src:AP.zthumb(this.images[2].src), url: "::base/file?file="+(Base64.encodeURI(this.images[2].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ '')+ "</div>";
	}else if (this.images.length >=4){
		var mask = "+"+(this.images.length-3)+" more photos";
		if (this.images.length==3){
			mask = '';
		}
		
		return "<div class='base-gallery -is-ext' "+(this.show('id'))+"> " +Render.render('photo', {src:AP.thumb(this.images[0].src, 3), url: "::base/file?file="+(Base64.encodeURI(this.images[0].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ " " +Render.render('cols', {equal:1}, '' +Render.render('photo', {src:AP.zthumb(this.images[1].src), url: "::base/file?file="+(Base64.encodeURI(this.images[1].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ " " +Render.render('photo', {mask:mask, src:AP.zthumb(this.images[2].src), url: "::base/file?file="+(Base64.encodeURI(this.images[2].src))+"&list=base-photo&container=base-gallery" , ratio: "16:9" , forced:1}, '')+ '')+ "</div>";
	}
}, function(params, obj){
	$(this).data("images", ARR.deepClone(obj.images));
});




Render.on("label", function(){
	var prefix='';
	var css='';
	if (this.icon){
		var ec=this.animated?'anim-showhide-inf':'';
		
		prefix="<div class='-icon "+(ec)+"'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
		this.addClass(Render.helper.getIconType(this));
	}
	
	this.addStatusColor();
	
	if (this.color && (this.fill || this.fill_text)){
		css="color: "+(Render.helper.getColor(this.color))+"";
	}else if (this.color){
		css="color: "+(Render.helper.getColor(this.color))+"";
	}
	
	if (this.url){
		this.addClass("url");
	}
	
	if (this.inline){
		this.addClass("inline");
	}
	
	this.addSizingClass();
	
	return "<div class='base-label "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.show('title'))+"> "+(prefix)+" <span class='-content' style='"+(css)+"'>"+(this.content)+"</span> </div>";
});


Render.on(["textfit", "text-fit"], function(){
	var _default=this._default?(""+(this._default)+""):'';
	if (!this.height){
		this.height=16;
	}
	
	if (this.content && $.trim(this.content)){
		_default='';
	}
	
	return "<div style='height:"+(this.height)+"px' class='relative'> <div style='position:absolute; left:0px; top:0px; width:100%;'><div class='ap-xdot'>"+(this.content)+""+(_default)+"</div></div> </div>";
});


Render.on("text-title", function(){
	if (this.url){
		this.addClass("url");
	}
	
	return "<div class='base-text text-title "+(this.get('class'))+"' "+(this.show('url'))+">"+(Render.helper.getTextContent(this))+"</div>";
});

Render.on("text-sub", function(){
	return "<div class='base-text text-sub "+(this.get('class'))+"'>"+(Render.helper.getTextContent(this))+"</div>";
});

Render.on("text-info", function(){
	return "<div class='base-text text-info "+(this.get('class'))+"'>"+(Render.helper.getTextContent(this))+"</div>";
});


Render.on("text-upper", function(){
	if (this.color){
		this.css("color", Render.helper.getColor(this.color));
	}
	
	this.css("text-transform", "uppercase");
	
	if (this.thick){
		this.addClass("thick");
	}
	
	if (this.bold){
		this.addClass("bold");
	}
	
	return "<span class='text-upper "+(this.get('class'))+"' "+(this.css())+">"+(this.content)+"</span>";
});


Render.on(["text-prefix", "text-prefixes"], function(){
	var v = this.text||this.content||'';
	v = v.replace(/[_\W]+/g,' ');
	v = v.split(" ");
	
	var len = this.length || 2;
	var r = "";
	
	for (var i=0; i<v.length; i++){
		r+=v[i].charAt(0);
		if (r.length>=len){
			break;
		}
	}
	
	return "<span class='text-prefixes'>"+(r)+"</span>";
});

Render.on("text-index", function(){
	this.addSizingClass();
	return "<div class='text-index "+(this.get('class'))+"'>"+(AP.data.zeroPrefix(this.index))+"</div>";
});


Render.on("text-alt", function(){
	if (this.value===true || this.value===1 || parseInt(this.value)===1){
		return "<span class='text-alt -df'>"+(this.text)+"</span>";
	}
	
	return "<span class='text-alt -alt'>"+(this.alt)+"</span>";
});


Render.on("text-yesno", function(){
	if (this.value && parseInt(this.value)){
		return "<span class='text-success'>"+(SVG.fa('check'))+" <b>CĂ³</b></span>";
	}
	
	return "<b class='text-a'>KhĂ´ng</b>";
});



Render.on("text-ticker", function(){
	var status = this.status||this.value;
	if (status && parseInt(status)){
		return "<span class='text-ticker text-success'>"+(SVG.fa('check'))+"</span>";
	}
	
	return "<span class='text-ticker -none'>"+(this._default||'')+"</span>";
});




Render.on("text-code", function(){
	if (this.fit){
		this.addClass("-fit");
	}
	
	if (this.inline){
		this.addClass("-inline");
	}
	
	return "<div class='text-code "+(this.get('class'))+"' "+(this.css())+">"+(this.content)+"</div>";
});



Render.on("text-linkify", function(){
	if (this.fit){
		this.addClass("-fit ap-xdot");
	}
	
	if (this.inline){
		this.addClass("-inline");
	}
	
	return "<div class='text-linkify "+(this.get('class'))+"' "+(this.show('id'))+">"+(this.content)+"</div>";
}, function(params){
	$(this).linkify();
});


Render.on("text-number", function(){
	this.addStandardTextLayout();

	return "<span class='text-number "+(this.get('class'))+"' "+(this.css())+">"+(AP.data.numberFormat(this.content||this.value))+"</span>";
});


Render.on("text-explain", function(){
	if (this.icon){
		
	}
	
	var exp = explain(this.content, {});
	
	if (this.left){
		this.css("padding-left", this.left+"px");
	}
	
	return "<span class='text-explain inline' "+(this.css())+">"+(exp)+"</span>";
});


Render.on(["text-limit", "base-limit"], function(){
	if (!this.font_size){
		this.font_size=13;
	}
	
	this.max_lines = parseInt(this.max_lines);
	var lh = (this.lh||this.line_height)?parseInt(this.lh||this.line_height):17;
	
	var css ="max-height: "+(this.max_lines * lh)+"px; line-height:"+(lh)+"px; font-size: "+(this.font_size)+"px; -webkit-line-clamp: "+(this.max_lines)+";";
	
	return "<div class='text-limit -max-"+(this.max_lines)+"' style='"+(css)+"'>"+(this.content)+"</div>";
});

Render.on("text-datetime", function(){
	var ts= this.ts;
	if (this.ts=="" || this.ts==null || typeof(this.ts)=="undefined"){
		ts = this.content;
	}
	
	this.addStandardTextLayout();
	
	if (!ts || !parseInt(ts)){
		return "<span class='text-datetime'>"+(this.es||'NA')+"</span>";
	}
	
	if (this.ago){
		return "<span class='text-datetime'>"+(AP.time.ago(ts))+"</span>";
	}
	
	if (this.inline){
		this.addClass("-inline");
	}
	
	if (this.multiple_lines){
		return "<div class='text-datetime'> <div class='td-date ap-f14'>"+(AP.time.time('%M %d', this.ts))+"</div> <div class='td-time ap-f12 text-a' style='padding-top:3px;'>"+(AP.time.time('%H:%i:%s', ts))+"</div> </div>";
	}
	
	return "<span class='text-datetime' "+(this.css())+">"+(AP.i18n.datetime(ts))+"</span>";
});


Render.on("text-date", function () {
	var ts = this.ts;
	if (this.ts == "" || this.ts == null || typeof (this.ts) == "undefined") {
		ts = this.content;
	}
	
	this.addStandardTextLayout();

	if (!ts || !parseInt(ts)) {
		return "<span class='text-date -es'>"+(this.es||this._default || 'NA')+"</span>";
	}

	return "<span class='text-date "+(this.get('class'))+"' "+(this.css())+">"+(AP.i18n.date(ts))+"</span>";
});



Render.on("text-ago", function () {
	var ts = this.ts;
	if (this.ts == "" || this.ts == null || typeof (this.ts) == "undefined") {
		ts = this.content;
	}

	this.addStandardTextLayout();
	
	if (!ts || !parseInt(ts)) {
		return "<span class='text-date'>"+(this.es || 'NA')+"</span>";
	}
	return "<span class='text-ago' "+(this.css())+">"+(AP.time.ago(ts))+"</span>";
});



Render.on("text-duration", function(){
	var duration= this.duration;
	if (!duration || !parseInt(duration)){
		return "<span class='text-date'>"+(this.es||'NA')+"</span>";
	}
	
	return "<span class='text-duration'>"+(AP.i18n.duration(duration))+"</span>";
});


Render.on(["text-daterange", "text-date-range"], function(){
	var from = parseInt(this._from);
	var to = parseInt(this.to);
	
	if (AP.time.sameYear(from, to)){
		
		if (AP.time.sameYear(from, AP.time.now())){
			return "<span class='text-daterange'>"+(AP.time.time('%M %d',from))+" - "+(AP.time.time('%M %d',to))+"</span>";
		}
		
		return "<span class='text-daterange'>"+(AP.time.time('%M %d',from))+" - "+(AP.time.time('%M %d %Y',to))+"</span>";
	}
	
	return "<span class='text-daterange'>"+(AP.time.time('%M %d, %Y',from))+" - "+(AP.time.time('%M %d, %Y',to))+"</span>";
});


Render.on(["text-datetime-range", "text-datetimerange"], function(){
	var from = parseInt(this._from);
	var to = parseInt(this.to);
	
	if (AP.time.sameYear(from, to)){
		if (AP.time.sameYear(from, AP.time.now())){
			return "<span class='text-daterange'>"+(AP.time.time('%H:%i %M %d',from))+" - "+(AP.time.time('%H:%i %M %d',to))+"</span>";
		}
		
		return "<span class='text-daterange'>"+(AP.time.time('%H:%i %M %d',from))+" - "+(AP.time.time('%H:%i %M %d, %Y',to))+"</span>";
	}
	
	return "<span class='text-daterange'>"+(AP.time.time('%H:%i %M %d, %Y',from))+" - "+(AP.time.time('%H:%i %M %d, %Y',to))+"</span>";
});


Render.on(["text-date-remain", "text-dateremain"], function(){
	var ts = parseInt(this.ts||this.value);
	var now = AP.time.now();
	
	var diff = ts - now;
	
	if (diff < 0){
		return "--";
	}
	
	var day = Math.ceil(diff / (24*3600));
	return ""+(day)+" NgĂ y";
});


Render.on(["text-datecount", "text-date-count"], function(){
	var from = parseInt(this._from);
	var to = parseInt(this.to);
	if (to<=from){
		return "<span class='text-datecount'>Day 0 of 0</span>";
	}
	
	var total = Math.ceil((to-from)/(24*3600));
	
	var time = AP.time.now();
	if (time<from){
		return "<span class='text-datecount'>Day 0 of "+(total)+"</span>";
	}else if (time>to){
		return "<span class='text-datecount'>Day "+(total)+" of "+(total)+"</span>";
	}else{
		var count = Math.ceil((time-from)/(24*3600))
		return "<span class='text-datecount'>Day "+(count)+" of "+(total)+"</span>";
	}
});


Render.on("text-clock", function(){
	return "<span class='text-clock' "+(this.show('id'))+"></span>";
}, function(params, obj){
	Render.interval("#"+params.id, function(){
		var _html = AP.time.time("%H:%i:%s");
		$(this).html(_html);
	});
});


Render.on(["text-int", "text-num"], function(){
	var val=this.content;
	if (!val){
		val=this.value;
	}
	
	if (!val){
		val=0;
	}else{
		val=parseInt(val);
	}
	
	if (this.with_zero){
		val= AP.data.zeroPrefix(val);
	}
	
	return "<span>"+(val)+"</span>";
});


Render.on("text-box", function(){
	this.addStatusColor();
	this.addSizingClass();
	
	if (this.color){
		var c= Render.helper.getColor(this.color);
		
		if (this.subtle){
			this.css("background-color", Color.rgba(c, 0.1));
			this.css("color", Color.adjust(c, 10, 10));
		}else{
			this.css("background-color", c);
			this.css("color", "#fff");
		}
	}
	
	if (this.inline){
		this.addClass("-inline");
	}
	
	if (this.icon){
		this.addClass("-picon");
	}
	
	return "<div class='text-box "+(this.get('class'))+"' "+(this.css())+">"+(Render.helper.getTextContent(this))+"</div>";
});





Render.on("text-status", function(){
	this.addStatusColor();
	this.addSizingClass();
	
	if (this.inline){
		this.addClass("-inline");
	}
	
	if (this.color){
		var c= Render.helper.getColor(this.color);		
		this.css("color", Color.adjust(c, 10, 10));
	}
	
	if (this.padding){
		this.addClass("-padding");
	}
	
	
	if (this.icon){
		this.addClass("-picon");
	}
	
	return "<div class='text-status "+(this.get('class'))+"' "+(this.css())+">"+(Render.helper.getTextContent(this))+"</div>";
});


Render.on("text-icon", function(){
	if (!this.icon){
		return '';
	}
	
	this.addStandardTextLayout();
	if (this.url){
		this.addClass('url');
	}
	
	return "<div class='base-icon-stat inline "+(this.get('class'))+" "+(Render.helper.getIconType(this))+"' "+(this.show('url'))+" "+(this.css())+"> <span class='-bis-icon'>"+(Render.helper.getIcon(this))+"</span> <span class='-bis-content' "+(this.css())+">"+(this.content)+"</span> </div>";
});


// ADVANCED

Render.on("text-editor", function(){
	if (!this.content){
		return "<div class='text-editor -no-content "+(this.get('class'))+"' "+(this.show('id'))+"> " +Render.render('none', {}, ""+(this.es||'')+"")+ "</div>"; 
	}
	
	if (this.code_highlight){
		return "  " +Render.render('text_editor_code', {}, ""+(Render.helper.escape(this.content))+"")+ '';
	}
	
	this.addSizingClass();
	
	return "<div class='text-editor "+(this.get('class'))+"' "+(this.show('id'))+"> "+(UI.parse(this.content))+" </div>";
}, function(params){
	if (params.linkify || params.linkified){
		$(this).linkify();
	}
});


Render.on("text-editor-code", function(){
	return "<div class='text-editor' "+(this.show('id'))+"> "+(this.content)+" </div>";
}, {
	done: function(params){
		Render.helper.showCode($(this).find("pre"));
	}
});


Render.on("text-markdown", function(){
	if (this.dark || Client.darkmode){
		this.addClass("-dark");
	}
	
	if (!AP.isset('toastui')){
		return "  " +Render.render('block', {}, '' +Render.render('title', {url:this.fallback, thick:1, sm:1}, "Formatted code block")+ " " +Render.render('block_info', {}, "Click to view in Base Message")+ '')+ '';
	}
	
	return "<div class='text-markdown base-text-markdown "+(this.get('class'))+"' "+(this.show('id'))+"></div>";
}, function(params, obj){
	if (!AP.isset('toastui')){
		return;
	}
	
	var content = params.content.replace(/&#9290;/g,'\\');
	
	if (params.purified){
		content = content.replace(/&amp;/g, '&').replace(/&#96;/g,'`').replace(/&#43;/g,'+').replace(/&gt;/g, '>').replace(/&lt;/g, '<')
		.replace(/&quot;/g, '"');	
	}
	
	var _viewer = new toastui.Editor({
		height: this.height||'auto',
		el: document.querySelector('#'+params.id),
		initialValue: content,
		viewer: true,
	});
	
	Render.helper.showCode($('#'+params.id).find("pre"));
});


Render.on("text-editable", function(){
	return "<div class='relative text-editable inline'> <div class='-te-inner'>"+(this.content)+"</div> <div class='-edit-icon url' data-url='"+(this.url)+"'> " +Render.render('icon', {icon: "form_edit" }, '')+ "</div> </div>";
});



Render.ui.tieSave = function(ref){
	var $box = $(ref).closest(".text-ie");
	var action = $box.data("action");
	var val = $box.find("input").val();
	
	$box.ajaxShow();
	AP.post(action, {
		value: val
	}, function(code){
		$box.ajaxHide();
		
		if (!code.good()){
			return AP.alertError(code.message);
		}
		
		$box.find(".tie-display .js-value").html(safe(val));
		$box.removeClass("-active");
		
		var callback = $box.data("callback");
		if (callback){
			var fn = Render.helper.getFunction(callback);
			if (fn){
				return fn(code);
			}
		}
	});
};



Render.on(["text-inline-edit", "text-ie", "text-inline-editable"], function(){
	var ph = this.placeholder||'Inline edit';
	
	return "<div class='text-ie' "+(this.show('id'))+" data-action='"+(this.action)+"' data-callback='"+(this.callback||this.success||'')+"'> <div class='tie-display url' data-url=':active/1' title='Click to edit'> <span class='js-value'>"+(this.value)+"</span> <span class='js-signal -signal inline'> " +Render.render('icon', {icon: "form_edit" }, '')+ "</span> </div> <div class='tie-ip'> <input type='text' name='value' placeholder='"+(ph)+"'/> <div class='tie-actions unselectable'> <div class='tie-save' title='LÆ°u'>LÆ°u</div> <div class='tie-cancel url' data-url=':active/3' title='Há»§y'> " +Render.render('icon', {icon: "form_undo" }, '')+ "</div> </div> </div> </div>";
}, function(params){
	$(this).find(".tie-ip input").val(params.value).enter(function(){
		Render.ui.tieSave(this);
	});
	
	$(this).find(".tie-save").click(function(){
		Render.ui.tieSave(this);
	});
});



// Randomize text
Render.on("text-random", function(){
	if (this.editor){
		this.line = this.line||5;
		
		return "<p>Great jobs, thank you</p> <p>It's an amazing moment to work with you and have your support. Just a bit of comment that there is a chance for the SLA to be improved.</p>";
		
	}
	
	return '';
});



Render.on("text-dot", function(){
	var color = Render.helper.getColor(this.color||'#aaaaaa');
	this.addStandardTextLayout();
	if (this.text_fill || this.fill_text){
		this.css("color", color);
	}
	
	return "<span class='text-dot "+(this.get('class'))+"' "+(this.css())+"> <span class='-td-inner'> <span class='-dot' style='background-color:"+(color)+"'></span> <span class='-txt'>"+(this.content)+"</span> </span> </span>";
});



Render.on("text-dd", function(){
	return "<span class='text-dd'> <span class='tdd-inner inline relative -cmenuw-active'> <span class='tdd-label url' data-url=':active:parent'>"+(this.text||this.label)+"</span> "+(this.content)+" </span> </span>";
});


Render.on("text-cts", function(){
	return "<div class='text-cts' "+(this.show('id'))+">"+(this.content)+"</div>";
}, function(params){
	UI.clickToShow("#"+params.id, {
		height: params.max_height|| params.height || 100,
		dark: Client.darkmode,
		dark_color: params.bg||''
	})
});


// BADGE
Render.on("text-badge", function(){
	var val = this.value||this.content;
	if (!val || !parseInt(val)){
		this.addClass("hidden");
	}
	
	this.css("background-color", Color.get("error"));
	
	return "<span class='text-badge "+(this.get('class'))+"' "+(this.css())+">"+(val)+"</span>";
});


Render.on("textarea", function(){
	var value = this.value||'';
	if (this.autosave && !value){
		var key = "autosave-"+(this.autosave)+"";
		var val = Base.pref().get(key);
		if (val){
			value = Base64.decode(val);
		}
	}
	
	return "<textarea id='"+(this.id)+"' placeholder='"+(this.placeholder||'')+"' name='"+(this._name)+"' "+(this.get('class'))+" "+(this.showAllData())+">"+(value||'')+""+(this.content)+"</textarea>";
}, function(params){
	if (params.autoexpand){
		$(this).autoExpand();
	}
	
	if (params.autosave){
		var key = "autosave-"+(params.autosave)+"";
		$(this).on("change", function(){
			var val = $(this).val();
			Base.pref().set(key, Base64.encode(val));
		});
	}
	
	if (params.tag || params.role == "tag"){
		return Tag.user(this, Tag.people());
	}
	
	if (params.autofocus){
		$(this).autofocus();
	}
});


Render.on("tooltip", function(){
	if (this.down || this.direction == "down" || this.bottom){
		this.addClass('-tt-down');
	}else{
		this.addClass('-tt-up');
	}
	
	if (this.comfort || this.padding){
		this.addClass("-comfort");
	}
	
	if (this.inline || this.fit){
		this.addClass("-tt-inline");
	}
	
	if (this.width){
		this.css("width", this.width+"px");
		this.css("margin-left", (-(this.width/2))+"px");
		this.css("left", "50%");
	}
	
	this.addSizingClass();
	
	return "<div class='base-tooltip "+(this.get('class'))+"' "+(this.css())+"> <div class='-bt-inner'> <div class='-bt-content'>"+(this.content)+"</div> <div class='-bt-arrow'></div> </div> </div>";
});


// Rendering an icon
Render.on("icon", function(){
	var color = this.color;
	if (color){
		this.css("color", Render.helper.getColor(color));
	}else if (this.icon_color){
		this.css("color", Render.helper.getColor(this.icon_color));
	}
	
	if (this.url || this.urlparam){
		this.addClass("url");
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	if (this.sm){
		this.size=14;
	}
	
	if (this.lg){
		this.size=24;
	}
	
	if (this.xl){
		this.size=32;
	}
	
	if ('size' in this){
		this.css("width", this.size+"px");
		this.css("height", this.size+"px");
		this.addClass("-fixed-size");
	}else{
		this.addSizingClass();	
	}
	
	this.addClass("-ic-"+Render.helper.getIconType(this));
	if (this.emoji){
		this.addClass("-ic-emoji");
	}
	
	var tt = '';
	if (this.tt){
		tt = "  " +Render.render('tooltip', {width:this.tt_width||150, bottom:this.tt_bottom||this.tt_down||'', comfort:1, sm:1}, ""+(this.tt)+"")+ '';
	}
	
	if (this.inline){
		return "<div class='base-icon-inline "+(this.get('class'))+"'><div "+(this.showURL())+" class='base-icon "+(this.get('class'))+"' "+(this.css())+" "+(this.showData('urlparam'))+" "+(this.showHTMLSemantics())+" "+(this.showData('value'))+"> "+(Render.helper.getIcon(this))+" "+(tt)+" </div></div>";
	}
	
	return "<div "+(this.showURL())+" class='base-icon "+(this.get('class'))+"' "+(this.css())+" "+(this.showData('urlparam'))+" "+(this.showData('value'))+" "+(this.showHTMLSemantics())+"> "+(Render.helper.getIcon(this))+" "+(tt)+" </div>";
});



// Rendering an icon box
Render.on("iconbox", function(){
	var icon, bg;
	if (this.url){
		this.addClass("url");
	}
	
	if (this.iconbox){
		var parts = this.iconbox.split(" ");
		if (parts.length==2){
			icon = Render.helper.getIconByName(parts[0]);
			color = parts[1];
		}else if (parts.length==3){
			icon = Render.helper.getIconByName(parts[0]+ " "+parts[1]);
			color = parts[2];
		}else{
			return "";
		}
		

		color = Color.get(color);
		
		
		this.fill=1;
		
		if (Color.isDark(color)){
			this.addClass("-is-dark");
		}else{
			this.subtle=1;
			this.addClass("-is-light");
		}
		
		if (this.size||this.width){
			var w = this.size||this.width;
			if (AP.data.isInt(w)){
				this.css("width", w+"px");
				this.css("height", w+"px");
				this.css("padding-top", ((w-10)/3)+"px")	
			}
		}
	}else{
		icon = Render.helper.getIcon(this);
		
		var color = "#aaaaaa";
		if (this.isHexColor(this.color)){
			color = this.color
		}else{
			color = Color.get(this.color);
		}
	}
	
	this.addSizingClass();
	if (this.square){
		this.addClass("-square");
	}
	
	if (this.no_fill){
		this.css("color", Color.adjust(color, 20, 20));
	}else{
		if (this.fill || this.solid){
			if (this.fill == "none"){
				this.css("background-color", Color.adjust(color));
			}else if (this.fill == "subtle"){
				this.css("color", Color.adjust(color, 20, 20));
				this.css("background-color", Color.adjust(color, 10, -85));
			}else if (this.subtle==1){
				this.css("color", Color.adjust(color, 50, 50));
				this.css("background-color", color);
			}else if (this.fill == 1){
				this.css("color", "#fff");
				this.css("background-color", color);	
			}else{
				this.css("color", "rgba(255,255,255,0.9)");
				this.css("background-color", Color.adjust(color, 10, 10));	
			}
			
		}else{
			this.css("color", Color.adjust(color, 20, 20));
			this.css("background-color", Color.adjust(color, 10, -80));
			if (this.edge){
				this.addClass("-edge");
				this.css("border", ""+(this.edge)+"px solid "+Color.adjust(color, 15, -70));
			}
		}
	}
	
	
	return "<div class='base-iconbox "+(this.get('class'))+"' "+(this.showHTMLSemantics())+" data-url='"+(this.url||'')+"'> <div class='-bi' "+(this.css())+"> <div class='-icon'>"+(icon)+"</div> </div> </div>";
});



Render.on("ficon", function(){
	var size = "normal";
	var fs = this.filename||this.fid||this.content;
	var icon = '';
	
	if (this.sm){
		size = "sm";
		icon = UI.file.fontIcon(fs);
		
		return "<span class='base-ficon -sm'><span class='-ap icon-"+(icon)+"'></span></span>";
	}
	
	if (this.lg){
		icon = UI.file.icon(fs);
		return "<span class='base-ficon -lg'><img src='"+(Client.share_url)+"/32/file-"+(icon)+".png'/></span>";
	}
	
	icon = UI.file.icon(fs);
	return "<span class='base-ficon -nm'><img src='"+(Client.share_url)+"/m4/"+(icon)+".svg'/></span>";
	
});




Render.on("icon-stat", function(){
	if (!this.stat || !parseInt(this.stat)){
		return '';
	}
	
	this.addSizingClass();
	
	return "<div class='base-icon-stat inline "+(this.get('class'))+"'> <span class='-bis-icon'>"+(Render.helper.getIconByName(this.icon))+"</span> <span class='-bis-txt -bis-count'>"+(this.stat||'')+"</span> "+(this.content)+" </div>";
});



Render.on("dot", function(){
	if (!this.color){
		this.color='gray less';
	}
	
	this.addStatusColor();
	
	if (this.status && parseInt(this.status)){
		this.color='success';
	}
	
	var color = Render.helper.getColor(this.color);
	this.addSizingClass();
	
	if (this.size && AP.data.isInt(this.size)){
		this.css("width", this.size+"px");
		this.css("height", this.size+"px");
	}
	
	if (this.animated){
		this.addClass("anim-showhide-inf");
	}
	
	if (this.edge || this.fill=='subtle'){
		this.css("background-color", Color.rgba(color,0.2));
		this.css("border", "1px solid "+(color)+"");
		return "<div class='base-dot "+(this.get('class'))+"' "+(this.css())+" "+(this.showHTMLSemantics())+">"+(this.content)+"</div>";
	}else{
		this.css("background-color", color);
		this.css("border", "1px solid "+(Color.adjust(color,5,5))+"");
		
		return "<div class='base-dot "+(this.get('class'))+"' "+(this.css())+" "+(this.showHTMLSemantics())+">"+(this.content)+"</div>";
	}
});




Render.on("shape", function(){
	var shape = "";
	var size = this.width||this.size||this.height||32;
	
	if (this.sm){
		size = 16;
	}
	
	if (this.lg){
		size = 24;
	}
	
	var color = Render.helper.getColor(this.color);
	
	if (this.rounded){
		this.addClass("-rounded");
	}
	
	var content = '';
	if (this.content){
		content = "<div class='-content'>"+(this.content)+"</div>";
	}
	
	if (this.square || this.shape == "square"){
		shape = "<div class='shape-square' style='background-color:"+(color)+"'>"+(content)+"</div>";
	}else if (this.triangle || this.shape == "triangle"){
		shape = "<div class='shape-triangle'>"+(this.content)+"</div>";
	}else if (this.circle || this.shape == "circle"){
		shape = "<div class='shape-circle' style='background-color:"+(color)+"'>"+(content)+"</div>";
	};
	
	return "<div class='base-shape "+(this.get('class'))+"' style='width:"+(size)+"px; height: "+(size)+"px'> <div class='-bs-inner'>"+(shape)+"</div> </div>";
});



// Show avatar
Render.on("avatar", function(){
	this.addSizingClass();
	if (this.fit){
		this.addClass("-fit");
	}
	
	if (this.square){
		this.addClass("-square");
	}
	
	if (this.width||this.size||this.height){
		var w=this.width||this.size||this.height;
		this.css("width", w+"px");
		this.css("height", w+"px");
	}
	
	if (this.url){
		this.addClass("url");
	}
	
	if (this.online){
		this.addClass("-online");
	}
	
	if (this.icon){
		var bg_color = Render.helper.getColor(this.bg,'#666');
		
		return "<div class='base-avatar "+(this.get('class'))+" -avatar-type-icon' "+(this.css())+"> <div class='avatar-icon' style='background-color:"+(bg_color)+"'>"+(Render.helper.getIconByName(this.icon))+"</div> </div>";
		
	}else if (this.user){
		this.src = AP.thumb(this.user.gavatar);
	}else if (this.user_id){
		var user = People.get(this.user_id)
		if (user && !user.error){
			this.src = AP.thumb(user.gavatar);	
		}
		
		if (this.with_url){
			this.url = "::base/user?username="+(user.username)+"";
			this.addClass("url");
		}
	}else if (this.text){
		var label='';
		var ptext=purify(this.text);
		var color = UI.str2int(ptext);
		var bg = Color.alt(color);
		
		if (this.bg){
			bg = Render.helper.getColor(this.bg);
		}
		
		var parts = AP.word.split(" ", ptext);
		if (parts.length>=2){
			label=parts[0].substr(0,1)+parts[1].substr(0,1);
		}else if (parts.length>=1){
			label=parts[0].substr(0,1)+parts[0].substr(0,1);
		}
		
		if ((this.sm || this.singular) && label){
			label=label.substr(0,1);
		}
		
		if (label && label.length){
			label = "<div class='-avatar-text' style='background-color:"+(bg)+"'>"+(label.toUpperCase())+"</div>";
		}else{
			label = "<div class='-avatar-text' style='background-color:"+(bg)+"'></div>";
		}
		
		return "<div class='base-avatar "+(this.get('class'))+"' "+(this.css())+" "+(this.show('url'))+" "+(this.showHTMLSemantics())+"> "+(label)+" </div>";
	}else{
		if (this.src && this.resize){
			this.src = AP.thumb(this.src);
		}
	}
	
	var img = "<img src='"+(this.src)+"'/>";
	if (typeof this.src == "undefined" || !this.src){
		img = "<div class='invalid-avatar'></div>";
	}
	
	
	return "<div class='base-avatar "+(this.get('class'))+"' "+(this.css())+" "+(this.show('url'))+" "+(this.showHTMLSemantics())+"> <div class='avatar-image'>"+(img)+"</div> </div>";
});


Render.on("avatars", function(){
	this.addSizingClass();
	
	if (!this.limit){
		this.limit=20;
	}
	
	var ok=0;
	var not_shown=0;
	var shown = 0;
	
	var not_html='';
	var subtle = '';
	
	var limit=this.limit;
	var is_team = 0;
	
	var users=this.users;
	if (this.employees){
		users = this.employees;
	}else if (this.teams){
		is_team = 1;
		users = this.teams;
	}
	
	if (!users || !users.length){
		if ("es" in this || "_default" in this){
			return "<div class='base-avatars -none'> " +Render.render('none', {}, ""+(this.es||this._default)+"&nbsp;")+ "</div>";
		}
	}
	
	if (this.right){
		this.addClass("float-right");
	}
	
	if (this.separate){
		this.addClass("-separate");
	}
	
	var that = this;
	
	var avatars = AP.render(users, function(e){
		var u=e;
		
		if (is_team){
			u = UserGroup.get(e);
			if (!u){
				return '';
			}
		}else if (!AP.data.isObject(e)){
			u  = People.get(e);	
		}
		
		if (is_team){
			ok++;
			
			if (ok>=limit){
				not_shown++;
				not_html+="  " +Render.render('cmenu_item', {}, ""+(u.name)+"")+ '';
				return '';
			}

			
			shown++;
			subtle = "<div class='inline-avatar-subtle url' title='"+(u.name)+"'> <div class='inline-avatar' title='"+(u.name)+"'><div class='-img'> " +Render.render('avatar', {text:u.path, fit:1, singular:1}, '')+ "</div></div> <div class='ia-name'>"+(u.name)+"</div> </div>";
			
			return "<div class='inline-avatar url' title='"+(u.name)+"' title='"+(u.name)+"'><div class='-img'> " +Render.render('avatar', {text:u.path, fit:1, singular:1}, '')+ "</div></div>";
		}else if (u.metatype && u.metatype=="employee"){
			if (!this.show_terminated && parseInt(u.is_terminated)){
				return '';
			}
			
			ok++;
			
			if (ok>=limit){
				not_shown++;
				not_html+="  " +Render.render('cmenu_item', {username:u.user_id, avatar:u.avatar}, ""+(u.name)+"")+ '';
				return '';
			}
			
			shown++;
			return "<div class='inline-avatar url' title='"+(u.name)+"' data-username='"+(u.user_id)+"'><div class='-img'><img src='"+(AP.xthumb(u.avatar))+"'/></div></div>";
		}else if (u && !u.error){
			ok++;
			
			if (ok>=limit){
				not_shown++;
				not_html+="  " +Render.render('cmenu_item', {username:u.username, avatar:u.gavatar}, ""+(u.name)+"")+ '';
				return '';
			}

			var _img = u.gavatar;
			if (!_img) {
				_img = u.avatar;
			}
			
			shown++;
			subtle = "<div class='inline-avatar-subtle url' data-username='"+(u.username)+"'> <div class='inline-avatar' title='"+(u.name)+"'><div class='-img'><img src='"+(AP.xthumb(_img))+"'/></div></div> <div class='ia-name'>"+(that.first_name_only?u.first_name:u.name)+"</div> </div>";
			
			var online = '';
			if (that.online || that.show_online){
				if (u.online){
					online = "-online";
				}
			}
			
			return "<div class='inline-avatar url "+(online)+"' title='"+(u.name)+"' data-username='"+(u.username)+"'><div class='-img'><img src='"+(AP.xthumb(_img))+"'/></div></div>";
		}
		
		return '';
	});
	
	if (not_shown){
		avatars+="<div class='inline-avatar -cmenuw-active "+(this.get('class'))+"'> <div class='-more url' data-url=':active:parent'>"+(not_shown)+"</div> " +Render.render('cmenu', {}, ""+(not_html)+"")+ "</div>";
	}
	
	if (this.center){
		return "<div class='base-avatars-wrap-center'> <div class='base-avatars clear-fix "+(this.get('class'))+"'>"+(avatars)+"</div> </div>";	
	}
	
	if (shown == 1 && this.subtle){
		avatars = subtle;
	}
	
	return "<div class='base-avatars clear-fix "+(this.get('class'))+"'>"+(avatars)+"</div>";
	
});


Render.on("title", function(){
	var content = this.content;
	var ec = '';
	if (this.dd){
		ec="<span class='url' "+(this.show('url'))+">"+(this.title)+"</span>";
	}else if (this.url){
		content="<span class='url' "+(this.show('url'))+">"+(this.content)+"</span>";
	}
	
	if (this.fit){
		this.addClass("ap-xdot");
	}
	
	if (this.dd){
		this.addClass("-dd -cmenuw");
	}
	
	this.addSizingClass();
	if (this.color){
		this.css("color", Render.helper.getColor(this.color));
	}
	
	if (this.icon){
		content = "<span class='bt-content-picon'>"+(Render.helper.getIcon(this))+" "+(content)+"</span>";
	}
	
	return "<div class='base-title "+(this.get('class'))+"' "+(this.css())+">"+(ec)+""+(content)+"</div>";
});


Render.on(["attr", "attribute"], function(){
	if ('width' in this){
		this.css("width", this.width+"px");
	}
	
	return "<div class='base-attr' "+(this.css())+"> <div class='-ba-attr'>"+(this.attr)+"</div> <div class='-ba-value'>"+(this.value||this.content)+"</div> </div>";
});



Render.on("actions", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	if (this.cta){
		this.addClass("-cta");
	}
	
	this.addSizingClass();
	
	return "<div class='base-actions clear-fix "+(this.get('class'))+"' "+(this.css())+" "+(this.show('id'))+">"+(this.content)+"</div>";
	
}, function(params){
	
	if (params.auto_active){
		$(this).find(".base-action").setActiveURL();
	}
	
});


Render.on("action", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	var label = this.title;
	if (!label){
		label = this.label;
	}
	
	if (!label){
		label='';
	}
	
	var prefix = '';
	var suffix = '';
	
	if (this.more){
		this.dd=1;
	}
	
	if (this.dd){
		this.addClass("-pdd -cmenuw");
		suffix="<span class='-ap icon-chevron-down2'></span>";
	}
	
	if (this.icon || this.svg){
		prefix = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	if (this.icon || this.svg){
		prefix = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	if (this.right_icon){
		suffix = "<div class='-ricon'>"+(Render.helper.getIconByName(this.right_icon))+"</div>";
		this.addClass("-pricon");
	}
	
	if (this.upper){
		this.addClass("-uppercase");
	}
	
	if (this.link){
		this.addClass("-link");
	}
	
	if (this.danger){
		this.addClass("-danger");
	}
	
	if (this.disabled){
		this.addClass("-disabled");
	}
	
	if (this.subtle){
		this.addClass("-subtle");
	}
	
	if (this.cta){
		this.addClass("-cta");
	}
	
	if (this.url || this.urlparam){
		this.addClass("url");
	}
	
	if (this.active){
		this.addClass("-active");
	}
	
	if (this.inline){
		this.addClass("-inline");
	}
	
	if (this.icon_only){
		this.addClass("-icon-only");
	}
	
	this.addSizingClass();
	
	return "<div class='base-action "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.showData('urlparam'))+" "+(this.showData('value'))+" "+(this.showAllData())+"> "+(prefix)+" <span class='-txt'>"+(label)+"</span> "+(suffix)+" "+(this.content)+" </div>";
	
});


Render.on("button", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	var label = this.title;
	if (!label){
		label = this.label;
	}
	
	if (!label){
		label='';
	}
	
	var prefix = '';
	var suffix = '';
	
	if (this.dd){
		this.addClass("-pdd -cmenuw");
		suffix = "<div class='-suffix'><span class='-dd-icon'></span></div>";
	}
	
	if (this.icon || this.svg){
		prefix = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	if (this.icon || this.svg){
		prefix = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	if (this.right_icon){
		suffix = "<div class='-ricon'>"+(Render.helper.getIconByName(this.right_icon))+"</div>";
		this.addClass("-pricon");
	}
	
	if (this.upper){
		this.addClass("-uppercase");
	}
	
	if (this.link){
		this.addClass("-link -fit");
	}
	
	if (this.danger){
		this.addClass("-danger");
	}
	
	if (this.disabled){
		this.addClass("-disabled");
	}
	
	if (this.subtle){
		this.addClass("-subtle -fit");
	}
	
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	if (this.cta){
		this.addClass("-cta");
	}
	
	if (this.success){
		this.addClass("-success");
	}
	
	if (this.danger || this.error){
		this.addClass("-error");
	}
	
	if (this.warning){
		this.addClass("-warning");
	}
	
	
	if (this.special){
		this.addClass("-special");
	}
	
	if (this.left){
		this.css("float", "left");
	}
	
	if (this.right){
		this.css("float", "right");
	}
	
	if (this.icon_only){
		this.addClass('-icon-only');
	}
	
	if (this.center){
		this.addClass("center");
	}
	
	var subtle_link='';
	if (!this.dd){
		if (this.url || this.urlparam){
			this.addClass("url");
		}	
	}else{
		if (this.url){
			subtle_link="<div class='-absfit url' data-url='"+(this.url)+"'></div>";
		}
	}
	
	this.addSizingClass();
	
	return "<div "+(this.show('id'))+" class='base-button "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.showData('urlparam'))+" "+(this.showData('value'))+" "+(this.showHTMLSemantics())+" "+(this.showHTMLEvents())+" "+(this.css())+"> "+(subtle_link)+" "+(prefix)+" <span class='-txt'>"+(label)+"</span> "+(suffix)+" "+(this.content)+" </div>";
	
});


Render.on("button-more", function(){
	if (this.acl && !Render.helper.acl(this.acl)){
		return '';
	}
	
	return "<div class='base-button-more -cmenuw'><span class='-ap icon-dots-two-horizontal'></span> "+(this.content)+" </div>";
});



Render.on("button-dd", function(){
	if (('acl' in this) && !Render.helper.acl(this.acl)){
		return '';
	}
	
	this.addSizingClass();
	var icon="<span class='-ap icon-dots-two-horizontal'></span>";
	
	if (this.icon){
		icon = Render.helper.getIcon(this);
	}
	
	if (this.left){
		this.css("float", "left");
	}
	
	if (this.right){
		this.css("float", "right");
	}
	
	if (this.icon_only){
		this.addClass('-icon-only');
	}
	
	if (this.stroked || this.bordered){
		this.addClass("-stroked");
	}
	
	if (this.url){
		this.addClass("url");
	}
	
	return "<div class='base-button-dd -cmenuw "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.css())+"> <div class='bdd-content ap-f13'>"+(this.content)+"</div> "+(icon)+" </div>";
});




Render.on(["button-selected", "selected-button"], function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	var label = this.label||this.title||'ÄĂ£ chá»n';
	this.icon = this.icon||'ap uniF12F';

	var suffix = "<div class='-suffix'></div>";;
	var prefix = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
	
	if (this.active){
		this.css("display", "block");
	}
	
	if (this.upper){
		this.addClass("-uppercase");
	}
	
	
	if (this.danger){
		this.addClass("-danger");
	}
	
	if (this.disabled){
		this.addClass("-disabled");
	}
	
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	if (this.success){
		this.addClass("-success");
	}
	
	if (this.danger || this.error){
		this.addClass("-error");
	}
	
	if (this.warning){
		this.addClass("-warning");
	}
	
	if (this.left){
		this.css("float", "left");
	}
	
	if (this.right){
		this.css("float", "right");
	}
	
	if (this.center){
		this.addClass("center");
	}
	
	this.addSizingClass();
	
	return "<div class='base-selected-button "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.showData('urlparam'))+" "+(this.showData('value'))+" "+(this.showHTMLSemantics())+" "+(this.css())+" "+(this.show('id'))+"> "+(prefix)+" <span class='-txt'>"+(label)+"</span> <span class='-js-scount'></span> "+(suffix)+" "+(this.content)+" </div>";
	
});






Render.on("block", function(){
	var icon = '';
	if (this.icon){
		if (this.icon=='1' || this.icon==1){
			
		}else{
			icon = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";	
		}
		
		this.addClass("-picon");
	}else if (this.avatar){
		if (this.avatar=='1' || this.avatar==1){
		}else{
			icon = "<div class='-avatar'> " +Render.render('avatar', {src:this.avatar}, '')+ "</div>";
		}
		
		this.addClass("-pavatar");
	}else if (this.avatar_lg){
		this.addClass("-pavatar-lg");
	}
	
	var title_df=this.title?("<div class='block-title'>"+(this.title)+"</div>"):'';
	var subtitle_df=this.subtitle?("<div class='block-info'>"+(this.subtitle)+"</div>"):'';
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	this.addSizingClass();
	
	if (this.width){
		this.css("width", this.width+"px");
	}
	
	if (this.top){
		this.css("margin-top", this.top+"px");
	}
	
	if (this.compact){
		this.addClass("-compact");
	}
	
	return "<div class='base-block "+(this.get('class'))+"' "+(this.css())+" "+(this.showHTMLSemantics())+" "+(this.showURL())+"> "+(icon)+" "+(title_df)+" "+(this.content)+" "+(subtitle_df)+" </div>";
	
});


Render.on("stat", function(){
	var icon='';
	if (this.icon){
		this.addClass('-picon');
		
		if (this.icon!='0' && this.icon!='1'){
			icon = "<div class='base-icon'>"+(Render.helper.getIcon(this))+"</div>";
		}
	}
	
	var val = "<div class='bs-value'>"+(this.value)+"</div>";
	if (!('value' in this)){
		val = '';
	}
	
	var label = '';
	if (this.label){
		label = "<div class='bs-label'>"+(this.label)+"</div>";
	}
	
	return "<div class='base-stat-wrapper'> <div class='base-stat "+(this.get('class'))+"'> "+(icon)+" "+(val)+" "+(label)+" <div class='bs-content'>"+(this.content)+"</div> </div> </div>";
});


// Show context-menu
Render.on("cmenu", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	var that = this;
	
	if (this.sm){
		this.css("width", "180px");
	}else{
		this.css("width", "200px");
	}
	
	if (this.width){
		this.css("width", this.width+"px");
	}
	
	if (this.dark){
		this.addClass("-dark");
	}
	
	var opts ="";
	
	if (this.options){
		if (AP.data.isArray(this.options)){
			opts = AP.render(this.options, function(e){
				if (e=="---"){
					return "  " +Render.render('cmenu_item', {sep:1}, '')+ '';
				}
				return "  " +Render.render('cmenu_item', {url:e.url||e.link||e.path, icon:e.icon||''}, ""+(e.opt_name||e.name||e.label)+"")+ '';
			});
		}else if (AP.data.isObject(this.options)){
			opts = this.options.inline();
		}
	}else if (this.items){
		opts = AP.render(this.items, function(e){
			var url = e.url||e.link||e.path;
			if (that.url){
				url = Render.matchURL(that.url, e);
			}
			
			return "  " +Render.render('cmenu_item', {url:url, icon:e.icon||''}, ""+(e.opt_name||e.name)+"")+ '';
		});
	}
	
	var filter = '';
	if (this.filter){
		var id = this.get('id');
		
		filter="<div class='-cmenu-filter'> " +Render.render('search', {placeholder: "Lá»c nhanh" , filter: "#"+(id)+" .-item" , disable_autocomplete:1, borderless:1}, '')+ "</div>";
	}
	
	var content = ""+(opts)+""+(this.content)+"";
	
	if (this.height || this.max_height){
		var mh = this.height || this.max_height;
		content = ""+(filter)+"<div class='-cmenu-scroll scroll-y' style='max-height:"+(mh)+"px'>"+(content)+"</div>";
		this.addClass('-scroll-fit');
	}
	
	if (this.url && !this.items){
		this.addClass("url");
	}
	
	return "<div class='-cmenu -padding -no-icon "+(this.get('class'))+"' "+(this.showData('url'))+" "+(this.css())+" "+(this.show('id'))+">"+(content)+"</div>";
}, function(params, obj){
	if (params.auto_active && params.urlparam){
		$(this).find(".-item").addClass("url").each(function(){
			$(this).data("urlparam", params.urlparam);
		});
		$(this).find(".-item").setActiveURLParam(params.urlparam, '');
	}else if (params.active_url){
		$(this).find(".-item").setActiveURL(params.active_url);
	}
});


// Context-menu item
Render.on("cmenu-item", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	if (this.sep){
		return "<div class='-item-sep'></div>";
	}
	
	if (this.url=='::user'){
		this.url='';
	}
	
	var prefix='';
	
	if (this.avatar){
		prefix = "  " +Render.render('avatar', {src:this.avatar, sm:1}, '')+ '';
		this.addClass('-pavatar');
	}else if (this.icon){
		prefix = "<div class='-cmenu-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass('-with-icon');
	}
	
	if (this.complex){
		return "<div class='-item url -submenu -left "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.showData('username'))+" "+(this.showAllData())+" title='"+(this.label||'')+"'> "+(prefix)+""+(this.label||'')+" <div class='submenu'> "+(this.content)+" </div> </div>";
	}else{
		var urlvalue = '';
		if (this.value){
			urlvalue= " data-value='"+(this.value)+"' ";
		}
		
		return "<div class='-item url ap-xdot "+(this.get('class'))+"' "+(this.show('url'))+" "+(urlvalue)+" "+(this.showData('username'))+" "+(this.showAllData())+" title='"+(this.label||inline(this.content)||'')+"'>"+(prefix)+""+(this.label||'')+""+(this.content)+"</div>";	
	}
	
	
});



// Render a value
Render.on("value", function(){
	var unit = '';
	
	if (this.unit && this.unit == 'currency' || this.currency){
		this.unit = Currency.unit;
	}
	
	if (this.unit){
		unit="<span class='bi-unit'>"+(this.unit)+"</span>";
	}
	
	var value = Render.helper.getValue(this.value, this.unit, this.verbatim);
	if (this.short){
		if (this.currency){
			value = Currency.format(this.value);
			unit='';
		}else{
			value = Currency.simple(this.value);
		}
	}
	
	this.addSizingClass();
	var prefix=this.prefix||this.label;
	if (prefix){
		prefix= "<span class='-prefix'>"+(prefix)+"</span>";
	}else{
		prefix='';
	}
	
	return "<div class='base-value "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.showData('unit'))+" "+(this.showData('verbatim'))+"> "+(prefix)+" <span class='js-value -value'>"+(value)+"</span> "+(unit)+" "+(this.content)+" </div>";
},{
	updateValue: function(v){
		$(this).find(".js-value").html(Render.helper.getValue(v, $(this).data("unit"), $(this).data("verbatim")));
	},
	
	done: function(attrs){
		// $.log(attrs);
	}
});



Render.on("change", function(){
	var cx;
	
	if ('value' in this && 'compare_to' in this){
		this.change = parseFloat(this.value) - parseFloat(this.compare_to)
		cx=AP.data.numberFormat(this.change);
		
		if (this.short){
			cx=Currency.simple(this.change);
		}
		
		
		if (this.percent){
			cx = '0%';
			if (parseFloat(this.compare_to)){
				cx = parseFloat(100*this.change/this.compare_to).toFixed(2)+"%";
			}
		}
	}else{
		cx=AP.data.numberFormat(this.change);
		
		if (this.short){
			if (this.change<0){
				cx = "-"+Currency.simple(-this.change);
			}else{
				cx = Currency.simple(this.change);	
			}
		}	
	}
	
	var dir = "";
	
	if (this.up){
		dir = "up";
	}else if (this.down){
		dir = "down";
	}else{
		if (parseFloat(this.change)>0){
			dir = "up";
		}else{
			dir = "down";
		}
	}
	
	var exp ='';
	if (this.exp){
		exp = explain(this.exp, {align: this.exp_align||''});
	}
	
	
	
	return "<div class='base-change size-"+(this.get('size'))+" -is-"+(dir)+"'> <span class='ci-icon -"+(dir)+"'></span> <span class='ci-value'>"+(cx)+"</span> "+(exp)+" "+(this.content)+" </div>";
});




Render.on("tag", function(){
	if (this.url){
		this.addClass("url");
	}
	
	if (this.noticable || this.edge){
		this.addClass("-noticable");
	}
	
	this.addSizingClass();
	
	var icon = '';
	if (this.icon){
		icon = "<div class='tag-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	
	if (this.color){
		var c = Color.get(this.color);
		this.css("background-color", c);
		if (Color.isDark(c)){
			this.addClass("-fill-dark");
		}else{
			this.addClass("-fill-white");
		}
	}else{
		this.addClass("-fill-white");
	}
	
	if (this.text_color){
		this.css("color", Color.get(this.text_color));
	}
	
	return "<div class='base-tag "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.showHTMLSemantics())+" "+(this.css())+"> <div class='-tag-inner'> "+(icon)+""+(this.label||'')+""+(this.content)+" </div> </div>";
});




Render.on("special-tag", function(){
	if (this.url){
		this.addClass("url");
	}
	
	if (this.noticable || this.edge){
		this.addClass("-noticable -edge");
	}
	
	if (this.subtle){
		
	}
	
	if (this.circled){
		this.addClass("-circled");
	}
	
	this.addSizingClass();
	this.addStatusColor();
	
	if (this.color){
		var color = Render.helper.getColor(this.color);
		
		if (this.subtle){
			this.css("color", Color.adjust(color, 30, 30));
			if (this.no_fill){
				this.css("border", "1px solid "+(Color.rgba(color, 0.25))+"");	
			}else{
				this.css("background-color", Color.rgba(color, 0.15));	
			}
		}else{
			this.css("color", '#fff');
			this.css("background-color", Color.adjust(color, 10, 10));	
		}
	}
	
	return "<div class='base-special-tag "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.showHTMLSemantics())+" "+(this.css())+">"+(this.label||'')+""+(this.content)+"</div>";
});


Render.on("repeat", function(){
	var content = "";
	for (var i=0; i< parseInt(this.repeat); i++){
		content+=this.content;
	}
	
	return ""+(content)+"";
});


// Absolute box

Render.on("abs", function(){
	if ('top' in this){
		this.css('top', Render.helper.safeUnit(this.top));
	}
	
	if ('marginTop' in this){
		this.css('margin-top', Render.helper.safeUnit(this.marginTop));
	}
	
	if ('left' in this){
		this.css('left', this.left+'px');
	}
	
	if ('right' in this){
		this.css('right', this.right+'px');
	}
	
	if ('bottom' in this){
		this.css('bottom', this.bottom+'px');
	}
	
	if ('width' in this){
		this.css('width', this.width+'px');
	}
	
	if (this.url){
		this.addClass("url");
	}
	
	return "<div class='base-abs absolute "+(this.get('class'))+"' "+(this.css())+" "+(this.show('url'))+">"+(this.content)+"</div>";
});


Render.on("sep", function(){
	return "<div class='base-sep' style='height: "+(this.value)+"px; clear: both'></div>";
});


// Rendering a back icon
Render.on("back", function(){
	var style=this.caret?'caret':'arrow';
	return "<div class='base-back url' "+(this.show('url'))+"><div class='-icon-"+(style)+"'></div></div>";
});


Render.on("link", function(){
	var icon = '';
	if (this.icon){
		icon = "<span class='-link-icon'>"+(Render.helper.getIcon(this))+"</span>";
		this.addClass("-with-icon");
		this.addClass(Render.helper.getIconType(this));
	}
	
	return "<span class='base-link "+(this.get('class'))+" url' "+(this.show('url'))+" "+(this.css())+"> "+(icon)+" <span class='-txt js-txt'>"+(this.content)+"</span> </span>";
});

// Show side
Render.on("side", function(){
	if (!Render.acl(this)){
		return '';
	}
	
	if (this.width){
		this.css("width", this.width+"px");
	}
	
	return "<div class='base-side "+(this.get('class'))+"' "+(this.css())+" "+(this.show('id'))+">"+(this.content)+"</div>";
});


Render.on("thick", function(){
	return "<em class='thick "+(this.get('class'))+"' "+(this.css())+">"+(this.content)+"</em>";
});


Render.on("list-report-item", function(){
	return "<div class='base-ri'> "+(this.content)+" </div>";
});

Render.on("collapsable-header", function(){
	return "<div class='base-collapsable_header'> <div class='title unselectable'> <div class='url ap-xdot' data-url=':collapse/3'>"+(this.title)+"</div> </div> </div>";
});




Render.on("info-row", function(){
	if (!Render.acl(this)){
		return '';
	}
	
	var value='';
	
	if (this.value){
		value = "<div class='bi-value'>"+(this.value)+"</div>";
	}
	
	if (this.info){
		value = "<div class='bi-value'>"+(this.info)+"</div>";
	}
	
	var sublabel = '';
	if (this.sublabel){
		sublabel = "<div class='bi-sublabel ap-xdot' title='"+(this.sublabel)+"'>"+(this.sublabel)+"</div>";
	}
	
	var label = this.label?"<div class='bi-label'>"+(this.label)+"</div>":'';
	
	var icon='';
	
	if (this.icon){
		if (this.icon==1){
			
		}else{
			icon = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";	
		}
		
		this.addClass("-picon");
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	return "<div class='base-info-row "+(this.get('class'))+"' "+(this.show('id'))+" data-ui='info-row' "+(this.css())+"> "+(icon)+" "+(label)+" "+(sublabel)+" "+(value)+" <div class='-content'>"+(this.content)+"</div> </div>";
});


Render.on("info-rows", function(){
	return "<div class='base-info-rows'> <div class='bi-rows-title'>"+(this.title)+"</div> <div class='bi-rows'>"+(this.content)+"</div> </div>";
});


Render.on("switch", function(){
	var react= '';
	if (this.acl && !Render.helper.acl(this.acl)){
		
	}else{
		if (this.action){
			this.addClass("url");
			react="data-url='"+(this.action)+"'";
		}else if (this.url){
			this.addClass("url");
			react="data-url='"+(this.url)+"'";
		}
	}
	
	if (this.status && parseInt(this.status)){
		return "<div class='base-switch -on "+(this.get('class'))+"' "+(react)+"></div>";
	}
	
	return "<div class='base-switch -off "+(this.get('class'))+"' "+(react)+"></div>";
	
});


// Render pagination
Render.on("pagination", function(){
	var url = this.url;
	
	if (!url){
		url = Render.pagination.getContextURL();
	}
	
	var page = Query.getInt("page");
	if (!page) {
		page = 1;
	}
	
	if (this.comfort){
		this.addClass("comfort");
	}
	
	if (this.dark){
		this.addClass("-dark");
	}
	
	this.addSizingClass();
	

	if (!('num_items' in this)){
		return "<div class='base-pagination "+(this.get('class'))+"'> <div class='apppages center "+(this.get('class'))+"'>"+(Render.pagination.simple(url, page))+"</div> </div>";
	}
	
	
	if (!this.ipp){
		this.ipp=20;
	}
	
	if (!this.limit){
		this.limit=8;
	}
	
	this.num_items = parseInt(this.num_items);
	this.ipp = parseInt(this.ipp);
	
	var pages = Render.pagination.getPages(this, url, page);

	var html = AP.render(pages, function(e){
		if (e == "-truncation-"){
			return "<div class='pag-trunc'><span class='-ap icon-dots-two-horizontal'></span></div>";
		}else{
			return "<div class='pag url "+(parseInt(e)==page?'active':'')+"' data-url='"+(Render.pagination.url(url, e))+"'>"+(e)+"</div>";
		}
	});
	
	var prev = "<div class='pag-nav -prev url' data-url='"+(Render.pagination.url(url, page-1))+"'><span class='-ap icon-chevron-left22'></span></div>";
	if (page<=1){
		prev = "<div class='pag-nav -prev -disabled'><span class='-ap icon-chevron-left22'></span></div>";
	}
	
	var num_pages = Math.ceil(this.num_items/this.ipp);
	
	var next = "<div class='pag-nav -next url' data-url='"+(Render.pagination.url(url, page+1))+"'><span class='-ap icon-chevron-right22'></span></div>";
	if (page>=num_pages){
		next = "<div class='pag-nav -next -disabled'><span class='-ap icon-chevron-right22'></span></div>";
	}
	
	
	html=""+(prev)+" "+(html)+" "+(next)+"";
	
	var _from = (page-1)*this.ipp+1;
	var _to = page*this.ipp;
	if (_to>this.num_items){
		_to=Math.max(this.num_items, 1);
	}
	
	return "<div class='base-pagination "+(this.get('class'))+"' "+(this.css())+"><div class='bp-wrapper'> <div class='bp-panel'>"+(html)+"</div> <div class='bp-exp'>Showing results <em>"+(_from)+"</em> - <em>"+(_to)+"</em> of <em>"+(this.num_items)+"</em></div> </div> </div>";
});




Render.pagination = new function __RenderPag(){
	this.getPages = function(context, url, page){
		var num_pages = Math.ceil(context.num_items/context.ipp);
		
		var pages=[];
		for (var i= page-context.limit; i<page+context.limit; i++){
			if (i<=0 || i>num_pages){
				continue;
			}
			
			pages.push(i);
		}
		
		while (true){
			if (pages.length<=context.limit){
				break;
			}
			
			var left_diff = page - pages[0];
			var right_diff = pages[pages.length-1] - page;
			
			if (right_diff >= left_diff){
				pages.pop();
			}else{
				pages.shift();
			}
		}
		
		if (pages.length==0){
			return [1];
		}
		
		if (pages.length<=1){
			return pages;
		}
		
		if (pages[0]>2){
			pages.unshift("-truncation-");
			pages.unshift(1);
		}else if (pages[0]==2){
			pages.unshift(1);
		}
		
		if (pages[pages.length-1] <= num_pages-2){
			pages.push("-truncation-");
			pages.push(num_pages);
		}else if (pages[pages.length-1] == num_pages-1){
			pages.push(num_pages);
		}
		
		return pages;
	};
	
	
	this.simple = function(url, page){
		var counter='';
		if (Client.pageData.result_counts){
			counter = " &nbsp; (of total "+(Client.pageData.result_counts)+" records) ";
		}
		
		var prev = "<div class='prev url "+(page==1?'disabled':'')+"' data-url='"+(this.url(url, page-1))+"'><span class='-ap icon-chevron-left22'></span></div>";
		var next = "<div class='next url' data-url='"+(this.url(url, page+1))+"'><span class='-ap icon-chevron-right22'></span></div>";
		
		var html = "<div class='icons'> "+(prev)+"<div class='label url' data-url=':xrefresh'>Page "+(page)+" "+(counter)+"</div>"+(next)+" </div>";

		return html;
	};
	
	
	this.url = function(url, page){
		if (!page || page<=1){
			return url;
		}
		
		if (url.indexOf("?") != -1){
			return url + "&page=" + (page);	
		}else{
			return url + "?page=" + (page);
		}
	};
	
	this.getContextURL = function(){
		var url=Client.path.base;
		if (!url){
			url="";
		}
		
		var cqs="";
		
		var qs=Query.all();
		for (var key in qs){
			if (key=="env" || key=="page" || !key){
				continue;
			}
			cqs+=key+"="+qs[key]+"&";
		}
		
		if (cqs.length){
			cqs=cqs.substr(0, cqs.length-1);
		}
		
		if (cqs){
			if (Client.path.current.indexOf("?")==-1 || cqs){
				url=url+"?"+cqs;
			}else{
				url=url+"&"+cqs;
			}
		}
		
		return url;
	};
};




Render.on("bc", function(){
	if (this.stacked){
		this.addClass('-stacked');
	}
	
	var icon = '';
	
	if (this.icon){
		this.addClass('-with-icon');
		icon = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
	}
	
	var content = '';
	if (this.items){
		content = AP.render(this.items, function(e){
			return "  " +Render.render('bc_item', {url:e.url||e.link, label:e.name||e.label}, '')+ ''
		});
	}
	
	return "<div class='base-bc clear-fix "+(this.get('class'))+"' "+(this.show('id'))+">"+(icon)+" <div class='base-bc-inner'> "+(content)+" "+(this.content)+" </div> </div>";
}, function(params){
	if (params.stacked){
		
	}
	
	if (params.sep_icon){
		$(this).addClass("-with-sep-icon")
		$(this).find(".base-bc").each(function(){
			if ($(this).is(":last-child")){
				
			}else{
				$(this).find(".sep-icon").html("  " +Render.render('icon', {_class: "sep-icon" , icon:this.icon}, '')+ '');
			}
		});
	}
});


Render.on("bc-item", function(){
	return "<div class='base-bc-item url "+(this.get('class'))+"' "+(this.css())+" "+(this.show('url'))+" "+(this.showHTMLSemantics())+"> <span>"+(this.label||'')+""+(this.content)+"</span> <span class='sep-icon'></span> </div>";
});


Render.on("col", function(){
	if (this.top){
		if (this.top < 0){
			this.css('margin-top', this.top+'px');
		}else{
			this.css('padding-top', this.top+'px');	
		}
		
	}
	
	if (this.left){
		this.css('padding-left', this.left+'px');
	}
	
	if (this.right){
		this.css('padding-right', this.right+'px');
	}
	
	if (this.width){
		this.css('width', this.width+'px');
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	var title = "";
	if (this.title){
		title = "<div class='col-title'>"+(this.title)+"</div>";
	}
	
	return "<div class='base-col "+(this.get('class'))+"' "+(this.css())+"> <div class='-bc-inner'>"+(title)+""+(this.content)+"</div> </div>";
});


Render.ui.autocomplete = {
	cancel: function(ref){
		var name = $(ref).data("name");
		AP.setURLParams(assoc(name, null), true);
	},
};


Render.on("search", function(){
	var p = this.placeholder || 'Nháº­p Ä‘á»ƒ tĂ¬m kiáº¿m';
	this.input_name = this.input_name||this._name||'qsearch';
	var extra='';
	if (this.disable_autocomplete || this.filter || this.autocomplete){
		extra="autocomplete='off'";
	}
	
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	var cancel = '';
	if (this.autocomplete){
		this.addClass("-ac");
		cancel = "<div class='ac-cancel' onclick='Render.ui.autocomplete.cancel(this)' data-name='"+(this.filter||this._name)+"'> " +Render.render('icon', {icon: "ap ion-android-close" }, '')+ "</div>";
	}
	
	this.addSizingClass();
	
	if (this.icon_left){
		this.addClass("-icon-left");
	}
	
	return "<div class='search base-search "+(this.get('class'))+"' id='"+(this.id)+"-wrapper'> <input type='text' "+(extra)+" name='"+(this.input_name)+"' "+(this.show('id'))+" placeholder='"+(p)+"'/> "+(cancel)+" </div>";
},{
	done: function(params, obj){
		if (params.autocomplete){
			if (params.value){
				$(this).val(params.value);
				$(this).parent().addClass("-activated");
			}
			
			var $p = $(this).parent();
			
			// Handle auto-complete
			if (params.autocomplete === 1){
				var source = AP.select(obj.source, function(e){
					return {label: e.name, value: e.name, id: e.id};
				});
				
				$(this).apcomplete(source, false, function(e){
					if (params.filter){
						AP.setURLParams(assoc(params.filter, e.id), true);
					}
					
					if ($p.hasClass("__input_autocomplete")){
						$p.parent().find(".hidden input").val(e.id);
						$p.parent().find(".hidden input").data("obj", e);
					}
				});
				
				if (params.filter && Query.get(params.filter)){
					var v = ARR.findObj(source, Query.get(params.filter));
					if (v){
						$(this).val(v.value);
						$(this).parent().addClass("-activated");
					}
				}
			}else{
				$(this).apcomplete(params.autocomplete, false, function(e){
					if (params.filter){
						AP.setURLParams(assoc(params.filter, e.id), true);
					}
					
					if ($p.hasClass("__input_autocomplete")){
						$p.parent().find(".hidden input").val(e.id);
						$p.parent().find(".hidden input").data("obj", e);
					}
				});
			}
			
		}else if (params.binding || params.bind){
			AP.bindSearch("#"+params.id);
		}else if (params.filter){
			var that=this;
			setTimeout(function(){
				$(that).quickFilter(params.filter, function($e, q){
					return AP.word.fulltextMatch($e.text(), q);
				});
				
				if (params.auto_query || params.auto_filter || params.auto_filter){
					if (Query.get("q")){
						$(that).val(Query.get("q")).trigger("change");
					}	
				}
			});
		}else if (params.advanced){
			var opts = null;
			if (AP.data.isObject(obj.options)){
				opts = obj.options;
			}else{
				opts = BaseComponent.decode(params.advanced);
			}
			
			if (!opts){
				return;
			}
			
			return AP.bindAdvancedSearch("#"+params.id, {
				options: opts
			});
		}
	}
});


Render.on("dev-todo", function(){
	return "<div class='dev-todo'> " +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('content', {}, ""+(this.content)+"")+ "</div>";
});


Render.on("spinner", function(){
	this.width = parseInt(this.size||this.width) || 20;
	
	this.css("width", this.width+"px");
	if (this.padding){
		this.css("padding", this.padding+"px 0");
	}
	
	var bg = Color.rgba(Color.get('main'), 0.2);
	
	var css="border-top: 3px solid "+(bg)+"; border-right: 3px solid "+(bg)+"; border-bottom: 3px solid "+(bg)+"; border-left: 3px solid "+(Color.get('main'))+";";
	
	return "<div class='base-spinner' "+(this.css())+"> <div class='-bs-wrapper' style='width: "+(this.width)+"px; height: "+(this.width)+"px'> <div class='-bs-inner' style='"+(css)+"'></div> </div> </div>";
	
});







Render.on("acl", function(){
	if (this.require){
		var parts = this.require.split(":");
		if (parts.length==2){
			if (!acl(parts[0], parts[1])){
				return ''; // NO RENDER because of failed ACL
			}
		}else if (parts.length==1){
			if (!acl(parts[0], 1)){
				return ''; // NO RENDER because of failed ACL
			}
		}
	}
	
	if (this.acl && !Render.helper.acl(this.acl)){
		return '';
	}
	
	return this.content;
	
});


Render.on("progress", function(){
	var height = this.height || 6;
	var ec = '';
	if (this.color){
		ec="; background-color: "+(Render.helper.getColor(this.color))+"";
	}
	return "<div class='base-progress "+(this.get('class'))+"'> <div class='progress-bar' style='height:"+(height)+"px'> <div class='-completed' style='width:"+(this.percent)+"%"+(ec)+"'></div> </div> "+(this.content)+" </div>";
});




Render.on("flag-message", function(){
	this.addStatusColor();
	
	if (this.fill || this.solid){
		var color = "#fff";
		this.css("background-color", Color.rgba(Render.helper.getColor(this.color), 5, 5));
		this.css("color", "rgba(255,255,255, 0.9)");
		this.css("border", "1px solid rgba(0,0,0,0.01)");
		this.addClass("-fill");
	}else if (this.color){
		var color = Render.helper.getColor(this.color);
		this.addClass("-colorful -edge");
		this.css("background-color", Color.rgba(color, 0.1));
		this.css("border", "1px solid "+Color.rgba(color, 0.3));
	}
	
	var icon='';
	if (this.icon){
		icon = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	var cta='';
	if (this.url && this.cta){
		cta="<div class='bf-cta url' data-url='"+(this.url)+"'>"+(this.cta)+"</div>";
	}
	
	var title='';
	if (this.title){
		title= "<div class='-title' style='color:"+(color)+"'>"+(this.title)+"</div>";
		if (this.title_color){
			title= "<div class='-title' style='color:"+(Render.helper.getColor(this.title_color))+"'>"+(this.title)+"</div>";	
		}
	}
	
	return "<div class='base-flag-message "+(this.get('class'))+"' "+(this.css())+" "+(this.showHTMLSemantics())+"> "+(icon)+" <div class='bm-inner'> "+(title)+" "+(this.content)+" </div> "+(cta)+" </div>";
});


Render.on("message", function(){
	if (this.acl && !Render.helper.acl(this.acl)){
		return '';
	}
	
	
	if (this.color && this.edge){
		var color = Render.helper.getColor(this.color);
		this.addClass("-colorful -edge");
		this.css("border", "1px solid "+ Color.rgba(Color.adjust(color,20,20), 0.2));
		this.css("background-color", Color.rgba(color, 0.05));
		this.css("color", Color.adjust(color, 10, 10));
	}else if (this.color && (this.light||this.subtle)){
		var color = Render.helper.getColor(this.color);
		this.addClass("-colorful -subtle");
		this.css("background-color", Color.rgba(color, 0.1));
		this.css("border", "1px solid "+ Color.rgba(color, 0.3));
		this.css("color", Color.adjust(color, 10, 10));
	}else if (this.color){
		var color = Render.helper.getColor(this.color);
		this.css("background-color", Color.adjust(color, 10, 10));
		this.addClass("-colorful -fill");
	}
	
	this.addSizingClass();
	
	var icon='';
	if (this.icon){
		icon = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}else if (this.avatar){
		this.addClass("-pavatar");
	}else if (this.avatar_xl){
		this.addClass("-pavatar-xl");
	}else if (this.avatar_lg){
		this.addClass("-pavatar-lg");
	}
	
	return "<div class='base-message "+(this.get('class'))+"' "+(this.css())+"><div class='bm-inner-wrapper std-padding'> "+(icon)+" <div class='bm-inner'> "+(this.content)+" </div> </div></div>";
});


Render.ui.filter = {
	cancelUserFilter: function(ref){
		var name = $(ref).data("name");
		if (name && Query.get(name)){
			AP.setURLParams(assoc(name, null), true);
		}
	},

	cancelDateRangeFilter: function(ref){
		var names = $(ref).data("names");
		var parts = AP.word.split(",", names, true);
		
		if (parts && parts.length==2){
			var ps = {};
			ps[parts[0]]=null;
			ps[parts[1]]=null;
			AP.setURLParams(ps, true);
		}
	},
	
	cancelDateFilter: function(ref){
		var filter = $(ref).data("filter");
		AP.setURLParams(assoc(filter, null), true);
	}
};



// FILTERING LAYOUT

Render.on("filters", function(){
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	return "<div class='base-x-filters js-filters clear-fix "+(this.get('class'))+"' "+(this.show('id'))+"> "+(this.content)+" </div>";
});


Render.on("filter", function(){
	if (!Render.acl(this)){
		return '';
	}
	
	if (this.borderless){
		this.addClass('borderless');
	}
	
	if (!this.filter && this.binding){
		this.filter = this.binding;
	}
	
	if (this.right){
		this.css("float", "right");
		this.addClass("-right");
	}
	
	this.addSizingClass();
	
	var prefix = this.get("prefix")||'';
	
	var options="";
	if (this.options){
		options = AP.render(this.options, function(e){
			return "  " +Render.render('filter_opt', {value:e.id, label:e.name}, '')+ '';
		});
		
		if (this._default){
			options="  " +Render.render('filter_opt', {value: '' , label:this._default}, '')+ ''+options;
		}
		
		options="  " +Render.render('filter_opts', {}, ""+(options)+"")+ '';
	}
	
	var icon="<div class='bf-icon'><span class='ficon-filter'></span></div>";
	
	if (this.icon && this.icon == ":none:"){
		icon = '';
		this.addClass("-no-icon");
	}else if (this.icon){
		icon="<div class='bf-icon'>"+(Render.helper.getIconByName(this.icon))+"</div>";
	}
	
	
	if (this.no_icon){
		icon = '';
		this.addClass("-no-icon");
	}else{
		this.addClass("-with-icon");
	}
	
	return "<div class='base-filter js-filter -cmenuw "+(this.get('class'))+"' "+(this.css())+" data-filter='"+(this.filter)+"' "+(this.show('id'))+"> "+(icon)+" " +Render.render('filter_current', {prefix:prefix}, "--")+ ""+(options)+" "+(this.content)+" </div>";
}, {
	done: function(attrs){
		var f = $(this).data("filter");
		
		$(this).find(".js-filter-opt").each(function(){
			$(this).data("urlparam", f);
		});
		
		$(this).find(".js-filter-opt").setActiveURLParam(f, {fallback: ""});
		
		var v= $(this).find(".js-filter-opt.active").data('label');
		if (!v){
			return;
		}
		
		$(this).find(".filter-current .js-value").html(v);
	}
});


Render.on("filter-list", function(){
	if (this.borderless){
		this.addClass('borderless');
	}
	
	if (!this.filter && this.binding){
		this.filter = this.binding;
	}
	
	if (this.right){
		this.css("float", "right");
	}
	
	this.addSizingClass();
	
	if (this.checkbox){
		this.type='checkbox';
	}else{
		this.type='radio';
	}
	
	var title = this.title;
	if (this.dd){
		this.addClass("-dd");
		var ckey = '';
		if (this.dd!='1' && this.dd!=1){
			ckey = this.dd;
		}
		
		title = "<span class='url' data-url=':collapse/3' data-ckey='"+(ckey)+"'>"+(this.title)+"</span>";
	}
	
	var options="";
	if (this.options){
		options = AP.render(this.options, function(e){
			return "  " +Render.render('filter_opt', {value:e.id, label:e.name}, '')+ '';
		});
		
		if (this.empty || this._default){
			var lb = this.empty || this._default;
			options="  " +Render.render('filter_opt', {value: '' , label:lb}, '')+ ''+options;
		}
		
		options="  " +Render.render('filter_opts', {list:1}, ""+(options)+"")+ '';
	}
	
	return "<div class='filter-block base-filter-list js-filter -is-"+(this.type)+" "+(this.get('class'))+"' "+(this.css())+" data-filter='"+(this.filter)+"' "+(this.show('id'))+"> <div class='base-filter-list-inner'> <div class='bf-header'>"+(title)+"</div> <div class='bf-body'> "+(options)+" "+(this.content)+" </div> </div> </div>";
}, {
	done: function(attrs){
		if (attrs.dd){
			var ckey = '';
			if (attrs.dd!='1' && attrs.dd!=1){
				ckey = attrs.dd;
			}
			
			var pref = Base.pref().get(ckey);
			if (pref){
				$(this).addClass("-collapsed");
			}
		}
			
		var f = $(this).data("filter");
		
		$(this).find(".js-filter-opt").each(function(){
			$(this).data("urlparam", f);
		});
		
		$(this).find(".js-filter-opt").setActiveURLParam(f, {fallback: ""});
		
		var v= $(this).find(".js-filter-opt.active").data('label');
		if (!v){
			return;
		}
	}
});


Render.on("filter-opts", function(){
	var html = '';
	if (this.empty){
		html="  " +Render.render('filter_opt', {value: '' , label:this.empty}, '')+ '';
	}else if (this._default){
		html="  " +Render.render('filter_opt', {value: '' , label:this._default}, '')+ '';
	}
	
	if (this.options){
		html += AP.render(this.options, function(e){
			if (e.id && e.name){
				return "  " +Render.render('filter_opt', {value:e.id, label:e.name}, '')+ '';
			}else{
				return "  " +Render.render('filter_opt', {value:e.value, label:e.label}, '')+ '';
			}
		});
	}
	
	if (this.list){
		return "<div class='filter-opts' "+(this.show('id'))+"> "+(html)+" "+(this.content)+" </div>"; 
	}
	
	return "<div class='-cmenu -padding -no-icon' "+(this.show('id'))+"> "+(html)+" "+(this.content)+" </div>";
});


Render.on("filter-opt", function(){
	if ('acl' in this && !Render.acl(this)){
		return  '';
	}
	
	if (this.sep){
		return "<div class='filter-opt-sep'></div>";
	}
	
	return "<div class='base-filter-opt js-filter-opt -item url' data-value='"+(this.value)+"' data-label='"+(this.label)+"'> <div class='filter-ic'></div> <div class='ap-xdot'>"+(this.label||'')+""+(this.content)+"</div> </div>";
});


Render.on("filter-current", function(){
	var txt = this.prefix;
	if (!txt){
		return "<div class='filter-current no-prefix'><em class='js-value -value'>---</em></div>";	
	}
	
	return "<div class='filter-current'> <span class='js-prefix -prefix'>"+(txt)+"</span>: <em class='js-value -value'></em> </div>";
});




// FILTER USER

Render.on("filter-user", function(){
	var df = 'Filter user';
	var title = '';
	if (this.title){
		title = "<div class='bf-header'>"+(this.title)+"</div>";
	}
	
	var name = this.filter||this._name||'user';
	
	var v = '';
	if (Query.getInt(name)){
		var user = People.get(Query.getInt(name));
		if (user && !user.error){
			v="@"+user.username;
		}
		
	}
	
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	var cancel = "<div class='fu-cancel url' data-name='"+(name)+"' onclick='Render.ui.filter.cancelUserFilter(this)'> " +Render.render('icon', {icon: "ap ion-android-close" }, '')+ "</div>";
	if (!Query.getInt(name)){
		cancel = '';
	}
	
	return "<div class='filter-block filter-user "+(this.get('class'))+"' "+(this.show('id'))+"> "+(title)+" <div class='fu-comp'> <div class='fu-input'> <input type='text' name='"+(name)+"' data-context='global' placeholder='"+(this.placeholder||df)+"' value='"+(v)+"'/> </div> "+(cancel)+" </div> </div>";
}, {
	done: function(params, obj){
		Tag.user("#"+params.id+" input", Client.people);
		$("#"+params.id+" input").enter(function(){
			var u = People.get($(this).val());
			
			if (u && !u.error){
				var ps = {};
				
				var name = obj.filter||obj._name||'user';
				ps[name] = u.id;
				
				AP.setURLParams(ps, true);
			}
		});
	}
});




Render.on(["filter-daterange", "filter-date-range"], function(){
	var df = 'Filter user';
	var title = '';
	if (this.title){
		title = "<div class='bf-header'>"+(this.title)+"</div>";
	}
	
	
	
	var names = this.names||this._name||'start,end';
	var pnames = AP.word.split(",", names, true);
	
	if (pnames.length!=2){
		console.error("ERROR_FILTER_DATE_RANGE_NAME");
		return '';
	}
	
	var start = pnames[0];
	var end = pnames[0];
	
	var cancel = "<div class='fd-cancel url' data-names='"+(names)+"' onclick='Render.ui.filter.cancelDateRangeFilter(this)'> " +Render.render('icon', {icon: "ap ion-android-close" }, '')+ "</div>";
	
	if (!Query.getInt(start)){
//		cancel = '';
		this.addClass('-not-chosen');
	}
	
	return "<div class='filter-block filter-daterange "+(this.get('class'))+"' "+(this.show('id'))+" data-names='"+(names)+"'> "+(title)+" <div class='fd-comp'> <div class='fd-label'>NgĂ y:</div> <div class='fd-value js-range'> " +Render.render('none', {}, "Vui lĂ²ng chá»n")+ "</div> <div class='fd-mask abs-fit'></div> "+(cancel)+" </div> </div>";
}, {
	done: function(params){
		var m_start = null;
		var m_end = null;
		
		var ts = Query.get("start");
		if (ts){
			m_start = moment(ts, "DD-MM-YYYY");
		}
		
		var ts = Query.get("end");
		
		if (ts){
			m_end = moment(ts, "DD-MM-YYYY");
		}
		
		$("#"+params.id+" .fd-mask").dateRangePicker({
			getValue: function(){
				return this.innerHTML;
			},
			setValue: function(s, from, to, from_ts, to_ts, click){

			},
			onSelect: function(from, to){
				AP.setURLParams({
					start: encodeURIComponent(AP.time.time("%d-%m-%Y", from)),
					end: encodeURIComponent(AP.time.time("%d-%m-%Y",to)),
				}, true);

				$(this).data('dateRangePicker').close();
			}
		});
		
		if (m_start && m_end){
			$("#"+params.id).find(".js-range").html("  " +Render.render('text_daterange', {_from:m_start.unix(), to:m_end.unix()}, '')+ '');	
		}

		var dr = $("#"+params.id+" .fd-mask").data("dateRangePicker");
		
		if (m_start){
			dr.setStart(m_start.format("YYYY-MM-DD"));
		}
		
		if (m_end){
			dr.setEnd(m_end.format("YYYY-MM-DD"));
		}
	}
});





Render.on(["filter-date"], function(){
	var df = 'Filter date';
	var title = '';
	if (this.title){
		title = "<div class='bf-header'>"+(this.title)+"</div>";
	}
	
	var filter = this.filter||this._name||'date';
	
	var cancel = "<div class='fd-cancel url' data-filter='"+(filter)+"' onclick='Render.ui.filter.cancelDateFilter(this)'> " +Render.render('icon', {icon: "ap ion-android-close" }, '')+ "</div>";
	
	if (!Query.get(filter)){ 
		this.addClass('-not-chosen');
		cancel = '';
	}
	
	var icon = '';
	if (this.icon){
		icon = "<div class='-ft-icon'>"+(Render.helper.getIcon(this))+"</div>";
	}
	
	return "<div class='filter-block filter-date "+(this.get('class'))+"' "+(this.show('id'))+" data-name='"+(filter)+"'> "+(title)+" <div class='fd-comp'> "+(icon)+" <div class='fd-value js-range'><input name='"+(this.filter)+"' placeholder='"+(this.placeholder)+"'/></div> "+(cancel)+" </div> </div>";
}, {
	done: function(params){
		var ts = Query.getInt(params.filter);
		if (ts){
			$("#"+params.id).find(".js-range input").val(AP.time.time("%d/%m/%Y", ts));
		}
		
		
		$("#"+params.id+" .fd-value input").datepicker({
			dateFormat: AP.locale.get("date-format-jquery", "DD, MM d, yy"),
			firstDay: 1
		}).change(function(){
			var ts = moment($(this).val(), AP.locale.get("date-format", "DD, MM d, yy"));
			// $.log([$(this).val(), ts, AP.i18n.date(ts.unix()), AP.locale.get("date-format", "DD, MM d, yy")]);
			AP.setURLParams(assoc($(this).attr("name"), ts.unix()), true);
		});

	}
});



// CONTAINER
Render.on("filter-block", function(){
	if (!Render.acl(this)){
		return '';
	}
	
	var title = '';
	if (this.title){
		this.addClass("has-title");
		title = "<div class='fb-title'>"+(this.title)+"</div>";
	}
	
	return "<div class='filter-block-w "+(this.get('class'))+"'> "+(title)+" <div class='fb-content'>"+(this.content)+"</div> </div>";
});


// TAB LAYOUT

Render.ui.setAutoActiveTab = function($this, params){
	if (params.param){
		$this.find(".base-tab").addClass("url").data("urlparam", params.param);
		$this.find(".base-tab").setActiveURLParam(params.param, {fallback: params._default||''});
		
		if (!$this.find(".base-tab.active").length){
			$this.find(".base-tab").setActiveData("value", params._default);
		}
	}else{
		$this.find(".base-tab").setActiveURL({fallback: params._default||''});
		
		if (!$this.find(".base-tab.active").length){
			$this.find(".base-tab").setActive(params._default);
		}
	}
};

Render.on("tabs", function(){
	if (this.inline){
		return "<div class='base-tabs -inline clear-fix "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.css())+"><div class='-bt-inner'>"+(this.content)+"</div></div>";	
	}
	
	return "<div class='base-tabs clear-fix "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.css())+">"+(this.content)+"</div>";
	
}, {
	done: function(params){
		if (params.param){
			$("#"+params.id).find(".base-tab").addClass("url").data("urlparam", params.param);
		}else if (params.urlparam){
			$("#"+params.id).find(".base-tab").addClass("url").data("urlparam", params.urlparam);
			$(this).find(".base-tab").setActiveURLParam(params.urlparam, {fallback: params._default||''});
		}
		
		var $this = $(this);
		if (params.auto_active){
			Render.ui.setAutoActiveTab($this, params);
		}
		
		if (params.persistent){
			AP.sys.on(AP.EVENTS.PAGE.AFTERLOAD, function(){
				Render.ui.setAutoActiveTab($this, params);
			})
		}
	}
});


Render.on("tab", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	var icon='';
	var dd_icon='';
	
	if (this.icon){
		icon="  " +Render.render('icon', {icon:this.icon}, '')+ '';
		this.addClass("-picon");
	}
	
	if (this.dd){
		this.addClass('-pdd -cmenuw relative');
	}
	
	if (this.activate){
		this.addClass('url');
		this.url = '::base/activate';
		this.activate = this.activate;
	}
	
	
	if (this.active){
		this.addClass("active");
	}
	
	if (this.red){
		this.addClass("red");
	}
	
	var value='';
	if ('value' in this){
		value=" data-value='"+(this.value)+"'";
	}
	
	if (this.dd && this.url){
		return "<div class='base-tab "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.showData('activate'))+" "+(value)+" "+(this.showAllData())+" "+(this.showData('url'))+"> " +Render.render('backup', {url:this.url}, '')+ "<div class='-tab-wrapper'> "+(icon)+" <div class='-tab-inner'> <span class='url' data-url='"+(this.url)+"'>"+(this.label||'')+"</span> "+(this.content)+" </div> "+(dd_icon)+" </div> </div>";
	}
	
	if (this.has('url')){
		this.addClass("url");
	}
	
	
	return "<div class='base-tab "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.show('url'))+" "+(this.showData('activate'))+" "+(value)+" "+(this.showAllData())+"> <div class='-tab-wrapper'> "+(icon)+" <div class='-tab-inner'>"+(this.label||'')+""+(this.content)+"</div> "+(dd_icon)+" </div> </div>";
});




Render.on("itabs", function(){
	if (!Render.acl(this)){
		return '';
	}
	
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	this.addSizingClass();
	
	return "<div class='base-itabs clear-fix "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.css())+">"+(this.content)+"</div>";
}, function(params, obj){
	if (params.auto_active){
		if (params.param || params.urlparam){
			var pr = params.param || params.urlparam;
			
			var _df = '';
			if (params.cache_key){
				_df = Base.pref().get(params.cache_key);
			}
			
			_df = _df || params._default || '';
			
			$(this).find(".base-tab").addClass("url").data("urlparam", pr);
			$(this).find(".base-tab").setActiveURLParam(pr, {fallback: _df});
			
			// icon
			$(this).find("> .base-icon").setActiveURLParam(pr, {fallback: _df});
			
			if (!$(this).find(".base-tab.active").length){
				$(this).find(".base-tab").setActiveData("value", _df);
				$(this).find("> .base-icon").setActiveData("value", _df);
			}
			
			if (params.cache_key){
				$(this).find(".url").on("click", function(){
					var val = $(this).data("value");
					if (val){
						Base.pref().set(params.cache_key, val);
					}
				})
			}
			
			
		}else{
			$(this).find(".base-icon").setActiveURL({fallback: params._default||''});	
		}
	}
});







Render.on("list", function(){
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	if (this.comfort){
		this.addClass("-comfort");
	}
	
	if (this.sortable){
		this.addClass("-sortable");
	}
	
	if (this.compact){
		this.addClass("-compact");
	}

	
	return "<div class='base-list "+(this.get('class'))+"' "+(this.css())+" "+(this.show('id'))+"> "+(this.content)+" </div>";
}, function(params, obj){
	if (params.sortable){
		var data= {};
		if (params.sortable_data){
			data = $.extend({}, params.sortable_data);
		}
		
		UI.sortable({
			canvas: "#"+params.id,
			items: ".list-item",
			handle: ".list-icon",
			action: params.sortable,
			data: data
		});
	}
	
	if (params.limit){
		$(this).shortlist({
			max: params.limit
		});
	}
});


Render.on("list-footer", function(){
	return "<div class='list-footer'>"+(this.content)+"</div>";
});

Render.on("list-item", function(){
	var icon = '';
	if (this.icon){
		this.addClass("-picon");
		if (this.icon=="1" || this.icon==1){
		}else{
			icon = "<div class='list-icon'><div class='-icon'>"+(Render.helper.getIcon(this))+"</div></div>";
		}
	}else if (this.avatar){
		this.addClass("-pavatar");
		if (this.avatar==1 || this.avatar=='1'){
			
		}else{
			icon= "  " +Render.render('avatar', {src:this.avatar}, '')+ '';	
		}
	}
	
	if (this.comfort){
		this.addClass("-comfort");
	}
	
	if (this.super_comfort){
		this.addClass("-super-comfort");
	}
	
	if (this.cozy){
		this.addClass("-cozy");
	}
		
	if (this.padding){
		this.addClass("-padding");
	}
	
	if (this.url){
		this.addClass("url");
	}
	
	return "<div class='list-item "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.show('url'))+" "+(this.showAllData())+"><div class='li-container' "+(this.css())+"> "+(icon)+" "+(this.content)+" </div></div>";
});


Render.on("list-header", function(){
	if (this.active){
		this.addClass('active');
	}
	
	this.addStateClass();
	
	if (this.dd){
		this.addClass("-picon -dd");
	}
	
	if (this.avatar){
		this.addClass("-pavatar");
	}else if (this.icon){
		this.addClass("-picon");
	}
	
	return "<div class='list-header "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='-lh-inner'>"+(this.content)+"</div> </div>";
});



Render.on("list-inline", function(){
	return "<div class='list-inline "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='-li-main'> <div class='-li-navs'> <span class='-nav-left -nav'><span class='-ap icon-chevron-left22'></span></span> <span class='-nav-right -nav'><span class='-ap icon-chevron-right22'></span></span> </div> <div class='-li-items'>"+(this.content)+"</div> </div> </div>";
}, function(params){
	var $items = $(this).find(".-li-items");
	$items.children().first().addClass("visible");
	var len = $items.children().length;
	
	if (len <=1){
		$(this).addClass("-singular");
		return;
	}else{
		$(this).attr("title", ""+(len)+" items");	
	}
	
	$(this).find(".-nav-left").click(function(){
		var index = $items.find(".visible").index();
		if (index>0){
			index = index-1;
		}else{
			index = len-1;
		}
		
		$items.children().each(function(){
			$(this).removeClass("visible");
			
			if ($(this).index() == index){
				$(this).addClass("visible");
			}
		});
	});
	
	$(this).find(".-nav-right").click(function(){
		var index = $items.find(".visible").index();
		if (index<len-1){
			index = index+1;
		}else{
			index = 0;
		}
		
		$items.children().each(function(){
			$(this).removeClass("visible");
			if ($(this).index() == index){
				$(this).addClass("visible");
			}
		});
	});
	
});


Render.on("carousel", function(){
	if (this.fit){
		this.addClass("-fit");
	}
	
	return "<div class='base-carousel "+(this.get('class'))+"' "+(this.show('id'))+"><div class='bc-wrapper' style='height:"+(this.height||400)+"px'> <div class='bc-main'> <div class='bc-nav -left' onclick='Render.carousel.move(this, -1);'><div class='icon'><span class='-ap icon-chevron-left22'></span></div></div> <div class='bc-nav -right' onclick='Render.carousel.move(this, 1);'><div class='icon'><span class='-ap icon-chevron-right22'></span></div></div> <div class='bc-items'> <div class='bc-slider'>"+(this.content)+"</div> </div> </div></div> </div>";
}, {
	done: function(params){
		if (params.fit){
			var html = '';
			var index=0;
			var found=null;
			
			$(this).find(".carousel-item").each(function(){
				var id =$(this).attr("id");
				if (index==0){
					$(this).addClass("active");
					found = id;
				}
				
				html+="<div class='bc-dot url' onclick=\"Render.carousel.focus(this, '"+(id)+"')\" data-activate='#"+(id)+"'><span class='dot-icon'></span></div>";
				index++;
			});
			
			$(this).append("<div class='bc-footer'>"+(html)+"</div>")
			if (found){
				Render.carousel.focus($(this).find(".bc-footer .bc-dot:eq(0)"), found);
			}
			
			return;
		}
		
		var len = $(this).find(".bc-items .carousel-item").length;
		if (!len){
			$(this).addClass("-no-items");
			return;
		}
		
		var $slider = $(this).find(".bc-items");
		if (!$slider.length){
			return;
		}
		
		if (params.mouse){
			$slider.bind("mousewheel", function(e){
				e.preventDefault();
				
				if (e.originalEvent.wheelDelta >= 120){
					Render.carousel.move($slider[0], 1, 100);
				}else if (e.originalEvent.wheelDelta <= -120){
					Render.carousel.move($slider[0], -1, 100);
				}
			});
		}
	}
});



Render.on("carousel-item", function(){
	if (this.gap){
		this.css("padding", "0 "+(this.gap)+"px");
	}
	
	if (this.width){
		this.css('width', this.width+'px');
	}
	
	return "<div class='carousel-item url' "+(this.show('url'))+" "+(this.show('id'))+" "+(this.css())+">"+(this.content)+"</div>";
});





Render.carousel = new function __RenderCarousel(){
	this.move = function(ref, nav, unit){
		var $canvas = $(ref).closest(".base-carousel");
		if (!unit){
			unit = 100;
		}
		
		var left = parseInt($canvas.find(".bc-slider").css("left"));
		left = (parseInt(left/100) * 100);
		
		if (nav == -1){
			left= left-unit;
		}else{
			left= left+unit;
		}
		
		$canvas.find(".bc-slider").css("left", left);
	};
	
	
	this.focus = function(ref, id){
		$(ref).addClass("active");
		$(ref).siblings().removeClass("active");
		
		var left = $("#"+id).position().left;
		$("#"+id).closest(".bc-slider").css("left", -left);
	};
};







Render.helper.cardRSEngine = function($canvas, params){
	if (params.width){
		var parts = AP.word.split("-", params.width);
		var min_width = parseInt(parts[0]);
		var max_width = parseInt(parts[1]);
		
		var max_cols = $canvas.width()/min_width;
		var min_cols = $canvas.width()/max_width;
		
		
		var cols = Math.floor(max_cols/2 + min_cols/2);
		if (cols<1){
			cols=1;
		}
		
		if (cols>6){
			cols=6;
		}
		
		var w=100.000/cols;
		
		$canvas.find(".base-card").css("width", w+"%");
	}
};

Render.on("cards", function(){
	if (this.cols){
		this.addClass("-cols-"+this.cols);
	}else if (this.col){
		this.addClass("-cols-"+this.col);
	}	
	
	if (!this.gap){
		this.gap=20;
	}else{
		this.gap=parseInt(this.gap);
	}
	
	this.addClass("-gap-"+(this.gap)+"");
	if (this.width && !this.visible){
		this.addClass("-base-invisible");
	}
	
	return "<div class='base-cards-wrapper' "+(this.css())+"> <div class='base-cards "+(this.get('class'))+" clear-fix' "+(this.show('id'))+"> "+(this.content)+" </div> </div>";
}, {
	done: function(params){
		
		var $that = $(this);
		
		if (params.width){
			AP.html.resize(function(){
				Render.helper.cardRSEngine($that, params);
			});
			
			Render.helper.cardRSEngine($that, params);
			$that.removeClass("-base-invisible");
		}
	}
});


Render.on("card", function(){
	if (this.height == "auto"){
		this.addClass("-auto-height");
	}else{
		this.height = this.height||160;
		this.css("height", this.height+"px");	
	}
	
	if (this.no_fill){
		this.addClass("-no-fill");
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	if (this.width && this.canvas_width){
		var cw = parseInt(this.canvas_width);
		
		var parts = AP.word.split("-", this.width);
		var min_width = parseInt(parts[0]);
		var max_width = parseInt(parts[1]);
		
		var max_cols = cw/min_width;
		var min_cols = cw/max_width;
		
		
		var cols = Math.floor(max_cols/2 + min_cols/2);
		if (cols<1){
			cols=1;
		}
		
		if (cols>6){
			cols=6;
		}
		
		var w=100.000/cols;
		this.css("width", w+"%");
	}
	
	if (this.comfort){
		this.addClass("-comfort");
	}
	
	return "<div class='base-card "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.css())+"><div class='-bc-inner "+(this.url?'url':'')+"' "+(this.show('url'))+"> "+(this.content)+" </div></div>";
});


Render.on("card-header", function(){
	var icon='';
	
	if (this.avatar){
		this.addClass("-pavatar");
		
		if (this.avatar==1 || this.avatar=="1"){
			
		}else{
			icon="  " +Render.render('avatar', {src:this.avatar}, '')+ '';
		}
	}else if (this.icon){
		this.addClass("-picon");
		icon = "  " +Render.render('icon', {icon:this.icon}, '')+ '';
	}
	
	if (this.url){
		this.addClass("url");
	}
	
	return "<div class='card-header "+(this.get('class'))+"' "+(this.show('url'))+"> "+(icon)+""+(this.content)+" </div>";
});

Render.on("card-body", function(){
	return "<div class='card-body "+(this.get('class'))+"'> "+(this.content)+" </div>";
});

Render.on("card-footer", function(){
	if (this.sticky){
		this.addClass("-sticky");
	}
	
	return "<div class='card-footer "+(this.get('class'))+"'> "+(this.content)+" </div>";
});


// SECTION LAYOUT

Render.on("section", function(){
	if (this.acl && !Render.helper.acl(this.acl)){
		return '';
	}
	
	if (this.active){
		this.addClass('active');
	}
	
	if (this.fill){
		this.addClass("-fill-"+this.fill);
	}
	
	return "<div class='base-section "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.showAllData())+">"+(this.content)+"</div>";
});



Render.on("section-header", function(){
	if (this.active){
		this.addClass('active');
	}
	
	this.addStateClass();
	
	if (this.dd){
		this.addClass("-picon -dd");
	}
	
	if (this.avatar){
		this.addClass("-pavatar");
	}else if (this.icon){
		this.addClass("-picon");
	}
	
	var arr='';
	if (this.collapsible){
		this.addClass("-collapsible");
		arr = "<div class='triangle url' data-url=':collapse/2'><span class='-ap icon-triangle-down'></span></div>";
	}
	
	return "<div class='section-header "+(this.get('class'))+"' "+(this.show('id'))+"> "+(arr)+" <div class='-inner'>"+(this.content)+"</div> </div>";
});


Render.on("map-location", function(){
	if (inline){
		this.addClass("inline");
	}
	
	var embed="loc/preview?event=preview&latlng="+(this.lat)+","+(this.lng)+"";
	return "<div class='base-map-location "+(this.get('class'))+" url' data-url=':embed' data-title='Map location' data-app='api' data-embed='"+(embed)+"'>"+(this.content)+"</div>";
});


Render.on("percent", function(){
	if (this.subtle && !this.bg){
		this.bg = Color.adjust(Color.get(this.color), -30,-80);
	}
	
	if (!this.size){
		this.size = this.width;
	}
	
	var opts = {
		color: Render.helper.getColor(this.color),
		size: this.size||32,
		percent: this.percent||0,
		bg_color: this.bg||'#ffffff'
	};

	var text='';
	if ('text' in this){
		text="<div class='-bp-text'>"+(this.text)+"</div>";
	}
	
	var px = parseFloat(opts.percent);
	
	if (this.solid){
		var deg = 360*parseFloat(opts.percent)/100;
		
		var css="linear-gradient("+(deg+90)+"deg, transparent 50%, "+(opts.bg_color)+" 50%),linear-gradient(90deg, "+(opts.bg_color)+" 50%, transparent 50%)";
		
		if (deg >=180){
			css = "linear-gradient("+(deg-90)+"deg, transparent 50%, "+(opts.color)+" 50%),linear-gradient(90deg, "+(opts.bg_color)+" 50%, transparent 50%)";
		}
		
	
		return "<div class='base-percent' title='"+(px.toFixed(1))+"%'> <div style='position:absolute; width:"+(opts.size)+"px; height:"+(opts.size)+"px; background-image: "+(css)+"; overflow:hidden; border-radius: 50%; background-color:"+(opts.color)+"'></div> "+(text)+" </div>";
		
	}
	
	this.css("width", opts.size+"px");
	this.css("height", opts.size+"px");
	
	if (this.thickness){
		opts.thickness = this.thickness;
	}
	
	return "<div class='base-percent' title='"+(px.toFixed(1))+"%' "+(this.css())+">"+(text)+""+(SVG.percent(opts))+"</div>";
});



Render.on("istats", function(){
	return "<div class='base-istats "+(this.get('class'))+"'>"+(this.content)+"</div>";
});


Render.on("istat", function(){
	if (this.with_icon){
		this.addClass('-picon');
	}
	
	return "<div class='base-istat "+(this.get('class'))+"'> <div class='bi-label ap-xdot'>"+(this.label)+"</div> "+(this.content)+" </div>";
});




Render.on("number-stat", function(){
	return "<div class='base-number-stat'> <div class='bi-label'>"+(this.label)+"</div> "+(this.content)+" </div>";
});



Render.on("await", function(){
	if (!this.wait_for){
		return "<div style='display:none' id='"+(this.id)+"' class='base-await-target'>"+(this.content)+"</div>";
	}
	
	return "<div class='base-await' "+(this.show('id'))+" data-wait_for='"+(this.wait_for)+"'>"+(this.content)+"</div>";
}, {
	done: function(params){
		if (!params.wait_for){
			return;
		}
		
		var id=params.id;
		var wait_for = params.wait_for;
		
		setTimeout(function(){
			if ($(wait_for).length){
				if ($(wait_for).hasClass("base-await-target")){
					$('#'+id).empty();
					// $(wait_for).children().appendTo('#'+id);
					$("#"+id).replaceWith($(wait_for).children());
					// $.log($(wait_for).children().html());
				}else{
					$('#'+id).replaceWith($(wait_for).children());	
				}
			}
		});
	}
});


Render.on("cform", function(){
	var that = this;
	
	if (this.preview){
		if (this.borderless){
			this.addClass("-borderless");
		}
		
		return "<div id='"+(this.id)+"' class='base-cform-preview "+(this.get('class'))+"'></div>";
	}
	
	
	if (this.display_values){
		var defs = this.defs;
		var values = this.values;
		
		var ignore_empty = this.ignore_empty?1:0;
		if (!defs || !defs.length){
			return "<div class='base-cform display-values "+(this.get('class'))+"'> " +Render.render('empty', {icon: "base_question" , title: "KhĂ´ng cĂ³ trÆ°á»ng dá»¯ liá»‡u" , sm:1, inline:1}, ""+(this.es||'')+"")+ "</div>";
		}

		var rows = AP.render(defs, function(e, index){
			var vobj = ARR.findObj(values, e.id);
			var value="  " +Render.render('none', {}, "---")+ '';
			
			if (vobj){
				value = vobj.display;
				if (value == "" || value == null){
					value = vobj.value;
				}
				
				if (e.type == "input-table"){
					value = "  " +Render.render('cform_table', {def:vobj, value:value}, '')+ '';
				}
				
				if (e.type == "input-list"){
					value = "  " +Render.render('cform_list', {def:vobj, value:value}, '')+ '';
				}
				
				if (value == "" || value == null){
					value = "  " +Render.render('none', {}, "--")+ '';
				}
			}else{
				if (ignore_empty){
					return '';
				}
			}
			
			var counter = '';
			if (that.display_counter){
				counter = "<div class='-counter'>"+(AP.data.zeroPrefix(index+1))+"</div>";
			}
			
			return "<div class='bcf-row -type-"+(e.type)+"' data-cfid='"+(e.id)+"' data-cftype='"+(e.type)+"'> <div class='bcf-inner "+(that.display_counter?'-pcounter':'')+"'> "+(counter)+" <div class='bcf-label'>"+(e.name)+"</div> <div class='bcf-value'>"+(value)+"</div> </div> </div>";
		});
		
		if (this.display_compact || this.compact){
			this.addClass("-compact");
		}
		
		return "<div class='base-cform display-values "+(this.get('class'))+"'><div class='-dv-wrapper'>"+(rows)+"</div></div>";
	}
	
	
	if (this.display_compact || this.compact){
		this.addClass("-compact");
	}
	
	var values = this.values || [];
	
	var rows = AP.render(this.defs, function(e){
		var vobj = ARR.findObj(values, e.id);		
		if (e.type == "select"){
			return "  " +Render.render('form_row', {label:e.name}, '' +Render.render('form_input', {_name:e.id, type:e.type, placeholder:e.name||e.placeholder, options:e.options||[], _default: "-- Vui lĂ²ng chá»n --" }, '')+ '')+ '';
		}

		if (e.type == "select-m"){
			e.type = "select";
			return "  " +Render.render('form_row', {label:e.name}, '' +Render.render('form_input', {_name:e.id, type:e.type, placeholder:e.name||e.placeholder, options:e.options||[], multiple:1}, '')+ '')+ '';
		}
		
		return "  " +Render.render('form_row', {label:e.name}, '' +Render.render('form_input', {_name:e.id, type:e.type, placeholder:e.name||e.placeholder, options:e.options||[]}, '')+ '')+ '';
	});
	
	return "<div class='base-cform -fillable "+(this.get('class'))+"'><div class='-cf-wrapper'>"+(rows)+"</div></div>";
	
}, function(params, obj){
	if (params.preview){
		Base.cf.preview({
			canvas: "#"+this.id,
			rows: obj.defs,
			url:  params.url||'',
			onUpdated: function(rows){
				var update = params.update;
				if (update){
					var fn = getFunctionByName(fn);
					if (fn){
						fn(rows);
					}
				}
				
				Base.cf.preview({
					canvas: "#"+params.id,
					rows: rows,
					url:  params.url||''
				});
			}
		});
	}
});


Render.on("cform-table", function(){
	if (this.plain || this.plaintext){
		return "<div class='cform-display-plain-table'> "+(Form.ui.table.displayPlain(this.def, this.value))+" </div>";
	}
	
	return "<div class='cform-display-table'> "+(Form.ui.table.display(this.def, this.value))+" </div>";
});


Render.helper.star = new function __RenderHelperStar(){
	
};


Render.on("stars", function(){
	var max = this.max || 5;
	max = parseInt(max);
	
	var value = parseFloat(this.value);
	
	var html = '';
	for (var i=1; i<=max; i++){
		if (this.simple){
			if (i<=value){
				html+="<div class='base-star-single -filled'><div class='-bs -simple'><span class='-ap icon-star3'></span></div></div>";
			}else{
				html+="<div class='base-star-single -non-filled'><div class='-bs -simple'><span class='-ap icon-star3'></span></div></div>";
			}
			
			continue;
		}
		
		
		if (i<value){
			html+="<div class='base-star-single -filled'><div class='-bs -filled'><span class='-ap icon-star3'></span></div></div>";
		}else if (i>=value+1){
			html+="<div class='base-star-single -non-filled'><div class='-bs -non-filled'><span class='-ap icon-star3'></span></div></div>";
		}else{
			var w = (value-i+1)*100;
			html+="<div class='base-star-single -fractional'> <div class='-bs -non-filled'><span class='-ap icon-star_outline'></span></div> <div class='-bs-fractional' style='width:"+(w)+"%'> <div class='-bs -filled'><span class='-ap icon-star3'></span></div> </div> </div>";
		}
	}
	
	this.addSizingClass();
	this.addStatusColor();
	
	if (this.inline){
		this.addClass("inline");
	}
	
	return "<div class='base-stars "+(this.get('class'))+"'> <div class='-bs-inner clear-fix'>"+(html)+"</div> </div>";
	
});




Render.on(["form", "form-block"], function(){
	
	if (this.action){
		return "<div class='base-form' "+(this.show('id'))+"> <form method='POST' action='"+(this.action)+"'>"+(this.content)+"</form> </div>";
	}else{
		return "<div class='base-form' "+(this.show('id'))+"> "+(this.content)+" </div>";
	}
	
}, {
	done: function(params){
		if (params.display && params.display!='0'){
			$(this).find("select").each(function(){
				var val = $(this).find("option:selected").text();
				$(this).hide().after("<div class='value-display -select'>"+(val)+"</div>");
			});
			
			$(this).find("input").each(function(){
				var val = $(this).val();
				$(this).hide().after("<div class='value-display -text'>"+(safe(val))+"</div>");
			});
			
			$(this).find(".js-textarea-editor").each(function(){
				$(this).hide();
				$(this).siblings().show();
			});
			
			$(this).find(".form-footer").hide();
			
		}else{
			Form.render(this);	
		}	
		
		$(this).find(":input").each(function(){
			$(this).keypress(function(event){
				if ($(this).tagName() == "textarea"){
					return;
				}
				if (event.which == '13'){
					event.preventDefault();
				}
			});
		});
		
	}
});


Render.on("form-header", function(){
	var title = this.title?("  " +Render.render('title', {}, ""+(this.title)+"")+ ''):'';
	var subtitle = this.title?("  " +Render.render('subtitle', {}, ""+(this.subtitle)+"")+ ''):'';
	
	return "<div class='base-form-header'>"+(title)+""+(subtitle)+"</div>";
});

Render.on("form-row", function(){
	
	if (this.sep){
		return "<div class='form-row-sep'> <div class='fs-label'>"+(this.label||this.title)+"</div> </div>";
	}
	
	if (!Render.acl(this)){
		return '';
	}
	
	var icon = '';
	if (this.icon){
		icon = "<div class='-label-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-label-has-icon")
	}
	
	var required = '';
	if (this.required){
		required = " <span class='red'>*</span>";
	}
	
	var title= this.label?("<div class='fr-label'>"+(this.label)+""+(required)+"</div>"):'';
	var sublabel= this.sublabel?("<div class='fr-sublabel'>"+(this.sublabel)+"</div>"):'';
	
	if (this.compact){
		this.addClass("-compact-row");
	}
	
	this.addSizingClass();
	if (!this.label){
		this.addClass("-no-label");
	}
	
	return "<div class='base-form-row "+(this.get('class'))+"' "+(this.show('id'))+"> "+(icon)+" "+(title)+""+(sublabel)+" <div class='fr-content'>"+(this.content)+"</div> </div>";
});


Render.on("form-input", function(){
	var html = '';
	var attrs = '';
	if (this.disable_autocomplete){
		attrs += " autocomplete='off' ";
	}
	
	this.addSizingClass();
	
	if (this.type=='select' || this.select){
		var content = '';
		if (this.options){
			content = AP.render(this.options, function(e){
				if (AP.data.isObject(e)){
					return "<option value='"+(e.id||e.value)+"'>"+(e.name||e.label)+"</option>";	
				}
				
				return "<option value='"+(e)+"'>"+(e)+"</option>";
			});
			
			if (this.empty||this._default){
				content = "<option value=''>"+(this.empty||this._default)+"</option> "+(content)+"";
			}
		}else if (this.groups){
			content = AP.render(this.groups, function(g){
				var _items = AP.render(g.items, function(e){
					if (AP.data.isObject(e)){
						return "<option value='"+(e.id||e.value)+"'>"+(e.name||e.label)+"</option>";	
					}
					
					return "<option value='"+(e)+"'>"+(e)+"</option>";
				});
				
				return "<optgroup label='"+(g.name)+"'>"+(_items)+"</optgroup>";
			});
		}
		
		html="<select name='"+(this._name)+"' data-value='"+(this.value||'')+"' "+(attrs)+">"+(content)+""+(this.content)+"</select>";
	}else if (this.type=='textarea' || this.textarea){
		var val = this.value||'';
		if (!this.editor){
			val = Textarea.clean(val);
		}
		html="<textarea name='"+(this._name)+"' placeholder='"+(this.placeholder||'')+"' "+(attrs)+">"+(val)+"</textarea>";
	}else if (this.type=='editor' || this.editor){
		this.type='editor';
		html="<div class='relative js-textarea-editor'> <textarea name='"+(this._name)+"' data-type='editor' "+(attrs)+" placeholder='"+(this.placeholder||'')+"'></textarea> </div> <div class='hidden-value hidden'><div class='value-display -editor'> " +Render.render('text_editor', {}, ""+(this.value||'')+"")+ "</div></div>";
	}else if (this.type=='markdown' || this.markdown){
		this.type='markdown';
		html="<div class='js-input-markdown'> <div class='fr-markdown' id='"+(AP.uuid())+"'></div> <div class='hidden js-hidden'><textarea name='"+(this._name)+"' class='js-markdown-textarea'></textarea></div> </div>";
	}else if (this.type == "checkbox"){
		var checked = '';
		if (this.checked || this.value===1 || this.value==='1'){
			checked = '-checked';
		}
		
		html = "<div class='fic-checkbox unselectable "+(checked)+"'> <label> <input type='checkbox' name='"+(this._name)+"'> <span class='fic-checkmark'></span> <span class='fic-label'>"+(this.label||this.placeholder)+"</span> </label> </div>";
	}else if (this.type == "fake" || this.fake){
		html = "<div class='fi-fake'> <span class='-fif'>"+(this.content||this.value||this.placeholder)+"</span> </div>";
	}else if (this.type=='input-table'){
		html="  " +Render.render('fi_table', {_name:this._name, placeholder:this.placeholder, value:this.value||''}, '')+ '';
	}else if (this.type=='input-editor'){
		html="  " +Render.render('fi_editor', {_name:this._name, placeholder:this.placeholder, value:this.value||''}, '')+ '';
	}else if (this.type=='input-rating'){
		html="  " +Render.render('fi_rating', {_name:this._name, placeholder:this.placeholder, value:this.value||''}, '')+ '';
	}else if (this.type=='file' || this.file){
		html="<input type='file' name='"+(this._name)+"'/>";
	}else if (this.type == "files"){
		var limit = this.limit||10;
		var show = this.display||this.initial||3;
		
		var html = '';
		for (var i=0; i<=limit; i++){
			html+= "<div class='input-file "+(i>=show?' hidden':'')+"'><input type='file' name='"+(this._name)+"-"+(i)+"'/></div>";
		}
	
		return "<div class='fr-input-files' "+(this.show('id'))+">"+(html)+"</div>";
		
	}else if (this.type=='input-struct'){
		html="  " +Render.render('fi_struct', {_name:this._name, mobile:this.mobile, placeholder:this.placeholder, value:this.value||''}, '')+ '';
	}else if (this.type=='html'){
		html="<div class='custom-html'>"+(this.html)+"</div>";
	}else if (this.type == "datetime" || this.datetime){
		var date_val = '';
		var time_val = '';
		if (this.value){
			date_val = UI.inputDate(this.value);
			time_val = AP.time.time("%H:%i", this.value);
		}
		
		html="<span class='-ip-datetime'> <input type='text' name='"+(this._name)+"-date' class='-ip-date' placeholder='Choose a date' value='"+(date_val||'')+"' "+(attrs)+"/> <input type='text' name='"+(this._name)+"-time' class='-ip-time' placeholder='Choose a time' value='"+(time_val||'')+"' "+(attrs)+"/> </span>";
	}else if (this.type == "filebox" || this.filebox){
		html = "  " +Render.render('form_filebox', {_name:this._name, value:this.value||''}, '')+ '';
	}else if (this.type == "cover" || this.cover){
		html = "  " +Render.render('form_cover', {_name:this._name, value:this.value||'', template:this.template||'', ratio:this.ratio||''}, '')+ '';
	}else if (this.type == "color" || this.color){
		html = "  " +Render.render('form_color', {_name:this._name, value:this.value||''}, '')+ '';
	}else{
		html="<input type='text' name='"+(this._name)+"' placeholder='"+(this.placeholder||'')+"' value='"+(this.value||'')+"' "+(attrs)+"/>";
	}
	
	return "<div class='fr-input "+(this.get('class'))+"' "+(this.show('id'))+">"+(html)+"</div>";
	
}, function(params, obj){
	var $that = $(this);
	if (params.type=='editor' || params.editor){
		UI.editor($that.find("textarea"), {
			value: Textarea.editor(params.value||''),
			minHeight: params.height||100,
			bubble: params.bubble||'',
			compact: params.bubble?1:'',
			autogrow: params.autogrow||''
		});
	}
	
	if (params.type =='markdown' || params.markdown){
		var _viewer;
		var _opts = {
			el: document.querySelector('#'+params.id+' .fr-markdown'),
			initialValue: params.value||'',
			viewer: true,
			minHeight: params.height?(params.height+'px'):'50px',
			placeholder: params.placeholder||'Type here',
			hooks: {
				addImageBlobHook: Form.__toastImageHook
			},
			events: {
				change: function(event){
					var content = _viewer.getMarkdown();
					$(_viewer.layout.el).closest(".js-input-markdown").find(".js-markdown-textarea").val(content);
				}	
			}
		};
		
		_viewer = new toastui.Editor(_opts);
		if (params.value){
			$(_viewer.layout.el).closest(".js-input-markdown").find(".js-markdown-textarea").val(params.value||'');	
		}
		
		setTimeout(function(){
			// Adhock
			_viewer.on("focus", function(){
				// $(".-quill-focus").removeClass("-quill-focus");
				$('#'+params.id+' .fr-markdown').addClass("-x-focus");
				
				$(".-x-focus").each(function(){
					if ($(this).attr("id")!=$("#"+params.id+" .fr-markdown").attr("id")){
						$(this).removeClass("-x-focus");
					}
				});
			});
			
			$("#"+params.id+" .fr-markdown").on("click", function(){
				// $(".-quill-focus").removeClass("-quill-focus");
				$('#'+params.id+' .fr-markdown').addClass("-x-focus");
				
				$(".-x-focus").each(function(){
					if ($(this).attr("id")!=$("#"+params.id+" .fr-markdown").attr("id")){
						$(this).removeClass("-x-focus");
					}
				});
			});
			
			if (params.autofocus){
				_viewer.focus();
			}
			
		});
		
		return;
	}
	
	if (params.role == "tag"){
		var $ip = $that.find("input");
		if (!$ip.length){
			$ip = $that.find("textarea");
		}
		
		var val = "";
		if (obj._params.value && AP.data.isArray(obj._params.value)){
			val = AP.render(obj._params.value, function(e){
				if (AP.data.isInt(e)){
					var _u = People.get(e);
					if (_u && !_u.error){
						return "@"+_u.username+" ";
					}
					
					return "";
				}
				
				return "@"+e+" ";
			});
			
			$ip.val(val);
		}
		
		Tag.user($ip, Tag.people());
	}
	
	if (params.role == "date" || params.type == "date" || params.date){
		var $ip = $that.find("input");
		if (!$ip.length){
			$ip = $that.find("textarea");
		}
		
		var val=$ip.val();
		if (val && val.length && AP.data.isInt(val)){
			$ip.data("ts", val).val(UI.inputDate(val));	
		}
		
		
		$ip.attr("autocomplete", "off");
		return $ip.selectDate();
	}
	
	if (params.role == "datetime" || params.type == "datetime" || params.datetime){
		$that.find("input.-ip-date").selectDate();
		$that.find("input.-ip-time").selectTime();
	}
	
	if (params.role == "int"){
		better_int_enter($that.find("input"));
	}
	
	if (params.role == "teams"){
		var $ip = $that.find("input");
		if (!$ip.length){
			$ip = $that.find("textarea");
		}
		
		var val = "";
		if (obj._params.value && AP.data.isArray(obj._params.value)){
			val = AP.render(obj._params.value, function(e){
				var team = UserGroup.get(e);
				if (team){
					return ""+(team.name)+" (@"+(team.path)+"), ";
				}
				
				return "";
			});
		}
		
		$ip.val(val);
		Tag.team($ip);
	}
	
	
	if (params.type == "checkbox" && (params.value=="1" || params.value==1)){
		setTimeout(function(){
			$that.find("input").prop("checked", true);	
		}, 100);
	}
	
	if (params.type == "files"){
		$that.find("input[type=file]").change(function(){
			$(this).closest(".input-file").next().show();
		});
	}
	
	if (params.type == "select" || params.select){
		if ('value' in params && params.value !== null && params.value !== ''){
			$that.find("select").val(params.value);
		}
	}
	
	
	if (params.autocomplete && params.multiple){
		// Handle auto-complete
		var $p = $that;
		$p.addClass("apc-multiple");
		var $ip = $that.find("input");
		$ip.data("ul-class", "formv2-apc");
		
		$ip.apcomplete(params.autocomplete, true, function(e){
			$.log(e);
		});
	}else if (params.autocomplete){
		var $p = $that;
		var $ip = $that.find("input");
		$that.append("<div class='js-remove -cancel'><span class='-ap icon-close'></span></div>");
		
		$that.find(".js-remove").on("click", function(){
			$that.find("input").val("");
			$ip.trigger("apcomplete", [null]);
		});
		
		// Handle auto-complete
		$ip.apcomplete(params.autocomplete, false, function(e){
			$ip.trigger("apcomplete", [e]);
			
			if ($p.hasClass("__input_autocomplete")){
				$p.parent().find(".hidden input").val(e.id).trigger("change", [e]);
			}
		});
	}
	
	if (params.type == "select" || params.select){
		if (params.simple){
		}else{
			Form.improveSelect($that, {value: params.value||'', multiple: params.multiple||0});	
		}
	}
	
	if (params.type == "textarea" || params.textarea){
		if (params.autoexpand || params.autoexpand){
			$(this).find("textarea").autoExpand();
		}
	}
});


Render.on("form-input-value", function(){
	return "<div class='input-value "+(this.get('class'))+"'>"+(this.value||'')+""+(this.content)+"</div>";
});


Render.on("form-hidden", function(){
	return "<div class='hidden'><input name='"+(this._name)+"' type='hidden' value='"+(this.value||'')+"' class='"+(this.get('class'))+"'></div>";
});


Render.on("form-buttons", function(){
	return "<div class='base-form-buttons'>"+(this.content)+"</div>";
});


Render.on("form-button", function(){
	var url = '';
	if (this.submit){
		url = ':submit';
		this.addClass("-submit");
	}else if (this.cancel){
		url = ':xrefresh';
		this.addClass("-cancel");
	}
	
	return "<div class='form-button url "+(this.get('class'))+"' data-url='"+(this.url||url)+"'>"+(this.content)+"</div>";
});

Render.on("form-submit", function(){
	var url = this.url||':submit';
	
	return "  " +Render.render('button', {url:url, _class: "base-form-submit" , id:this.id}, ""+(this.label||'')+""+(this.content)+"")+ '';
});


Render.on("form-captcha", function(){
	return "  " +Render.render('form_row', {label: "Enter the code below" }, '' +Render.render('form_input', {_name: "captcha" , placeholder: "Enter the code below" }, '')+ "<div class='form-captcha'><img src='"+(Client.url)+"/captcha?ts="+(AP.time.now())+"&guest=1'/></div>")+ '';
});


Render.on("fi-radio", function(){
	
	return "<div class='fi-radio'> <div class='-radio'></div> </div>";
	
});


Render.on("fi-checkbox", function(){
	if (this.url){
		this.data_url=this.url;
		this.addClass('url');
	}
	
	if (this.status && parseInt(this.status)){
		this.addClass("-checked");
	}
	
	if (this.subtle){
		this.addClass("-subtle");
	}
	
	return "<div class='fi-checkbox "+(this.get('class'))+"' "+(this.showAllData())+"> <div class='-fcb'></div> </div>";
	
});


Render.on("fi-struct", function(){
	return "<div class='input-struct "+((mobile()||this.mobile)?'-mobile':'')+"'>"+(Form.ui.inputStruct.render(this))+"</div>";
});



Form.on("sep", function(opts){
	return "<div class='row-hr'></div>";
});

Form.on("input-video", function(opts){
	return "<div class='hidden'><input type='hidden' name='"+(opts.name)+"' value='' id='"+(opts.id)+"'/></div> <div class='base-input-video js-video-picker'> <div class='-txt ap-xdot'>"+(opts.placeholder||'Upload video')+"</div> </div>";
}, function(ip, value){
	var $box = $(ip).closest(".row");
	
	$box.find(".js-video-picker").on("click", function() {
		Form.ui.pickVideo(this);
	});
});


Form.on("input-lines", function(opts){
	return "<div class='input-mlines' id='"+(opts.id)+"' data-ip-name='"+(opts.name)+"'></div>";
}, function(ip, value){
	var $box = $(ip);
	var html = "";
	var name = $box.data("ip-name");
	
	if (value){
		html+= AP.render(value, function(v){
			return "<div class='ip-line -value'> <div class='counter'></div> <div class='ip-remove'><span class='-ap icon-ion-android-close'></span></div> <div class='input'><input type='text' name='"+(name)+"[]' value='"+(v)+"'/></div> </div>";
		});
	}
	
	html+="<div class='ip-line -empty'> <div class='counter'> " +Render.render('icon', {icon: "ap plus2" , icon_color: "main" }, '')+ "</div> <div class='input'><input type='text' name='"+(name)+"[]' value='' placeholder='Add more, press Enter'/></div> </div>";
	
	$box.html(html);
	
	Form.ui.inputLines.render($box);
	Form.ui.inputLines.bind($box);
});


Form.on("input-struct", function(opts){
	return "<div class='input-struct "+(mobile()?'-mobile':'')+"'>"+(Form.ui.inputStruct.render(opts))+"</div>";
}, function(ip, value){
	
});



Form.on("label-select", function(opts){
	return "<div id='"+(opts.id)+"' class='js-label-select'></div>";
}, function(input, value, org){
	$(input).html("  " +Render.render('input_label_select', {_name:org.name, options:org.options, value:value||''}, '')+ '');
	Render.finish();
});



Form.on("removable-files", function(opts){
	return "<div class='cx-current-files'> <div class='hidden'><input type='hidden' name='"+(opts.name)+"' value='' id='"+(opts.id)+"'/></div> <div class='cx-files'></div> </div>";
}, function(ip, value){

	if (!value || !AP.data.isArray(value)){
		$(ip).closest(".row").hide();
		return;
	}
	
	var html = AP.render(value, function(e){
		return "<div class='cx-file' data-fid='"+(e.id)+"'> " +Render.render('icon', {icon: "document" }, '')+ " " +Render.render('title', {}, "<span class='url' data-url=':file' data-file='"+(e.url)+"' title='Click to view'>"+(e.name)+"</span>")+ "<div class='cx-actions'> <div class='cx-action -remove js-remove'>XĂ³a</div> <div class='cx-action -undo js-undo'>Giá»¯ láº¡i</div> </div> </div>";
	});
	
	$(ip).closest(".cx-current-files").find(".cx-files").html(html);
	var $canvas = $(ip).closest(".cx-current-files");
	
	$canvas.find(".js-remove").on("click", function(){
		$(this).closest(".cx-file").addClass("-removed");
		Form.removeableFile.syncInput(this);
	});
	
	$canvas.find(".js-undo").on("click", function(){
		$(this).closest(".cx-file").removeClass("-removed");
		Form.removeableFile.syncInput(this);
	});
});


Form.removeableFile = {
	syncInput: function(ref){
		var $canvas = $(ref).closest(".cx-current-files");
		var removed = [];
		$canvas.find(".cx-file.-removed").each(function(){
			removed.push($(this).data("fid"));
		});
		
		$canvas.find(".hidden input").val(removed.join(","));
	}
};


Form.ui.inputLines = {
	render: function($canvas){
		$canvas.find(".ip-line").each(function(index){
			if ($(this).hasClass("-value")){
				$(this).find(".counter").html("  " +Render.render('icon', {icon: "align_right" , icon_color: "#aaa" }, '')+ " <span class='-counter'>"+(AP.data.zeroPrefix(index+1))+"</span>");
			}
		});
	},
		
	bind: function($canvas){
		$canvas.on("click", ".ip-remove", function(e){
			$(this).closest(".ip-line").remove();
			Form.ui.inputLines.render($canvas);			
		});
		
		$canvas.find(".ip-line.-empty input").enter(function(){
			var name = $canvas.data("ip-name");
			var v = $(this).val();
			if (v === "" || v === null){
				return;
			}
			
			var html = "<div class='ip-line -value'> <div class='counter'></div> <div class='ip-remove'><span class='-ap icon-ion-android-close'></span></div> <div class='input'><input type='text' name='"+(name)+"[]' value='"+(v)+"'/></div> </div>";
			
			$canvas.find(".ip-line.-empty").before(html);
			$(this).val("");
			
			Form.ui.inputLines.render($canvas);	
		});
	}
};



Form.ui.pickVideo = function(ref){
	Base.exchange.picker({
		title: "Select a video",
		app: "video",
		action: "picker",
		multi: 0,
		callback: function(data){
			var video = data.items[0];
			if (video && video.id) {
				var $row = $(ref).closest(".row");
				$row.find(".js-video-picker .-txt").html("<b>Base video</b>: "+(video.name)+" &rarr; "+(video.video_url)+"'");
				
				var obj = {
					id: video.id,
					name: video.name,
					url: video.video_url,
					embed: video.embed_url,
					duration: video.duration,
					image: video.images.length?video.images[0]:'',
					caption: inline(video.content)
				};
				
				$row.find("input").val(Base64.encode(JSON.stringify(obj)));
				$row.find("input").trigger("picked", [obj]);
				
			} else {
				return AP.alertError("Invalid video");
			}
		}
	});
};



Form.ui.inputStruct = new function __FormUIStruct(){
	this.render = function(opts){
		var parts = getParts(opts.placeholder);
		
		if (mobile() || opts.mobile){
			parts = ARR.unique(parts, function(e, f){
				return e.value == f.value;
			});
			
			var html = AP.render(parts, function(p){
				if (p.type == 'input'){
					var v = '';
					if (opts.value && AP.data.isObject(opts.value)){
						v = opts.value[p.value] ||'';
					}
					
					return "<div class='-struct-ipe js-struct-elem' data-key='"+(p.value)+"' title='"+(p.value)+"'> <span class='-struct-ipe-lb'>"+(p.value)+"</span> <span class='-struct-ipe-ip'><input name='"+(opts._name)+"-"+(p.value)+"' placeholder='"+(p.value)+"' value='"+(v)+"'/></span> </div>";
				}
				
				return '';
			});
			
			return "<div class='input-struct-mobile clear-fix'> <div class='ipm'> <div class='hidden'><input name='"+(opts._name)+"' value='"+(opts.display_value||'')+"'></div> <div class='ph'>"+(opts.placeholder)+"</div> <div class='ips-real'>"+(html)+"</div> </div> </div>";
		}
		
		var html = AP.render(parts, function(p){
			if (p.type == 'input'){
				var v = '';
				if (opts.value && AP.data.isObject(opts.value)){
					v = opts.value[p.value] ||'';
				}
				return "<div class='-struct-ipe js-struct-elem' data-key='"+(p.value)+"' title='"+(p.value)+"'><span><input name='"+(opts._name)+"-"+(p.value)+"' placeholder='"+(p.value)+"' value='"+(v)+"'/></span></div>";
			}
			
			return "<div class='-struct-str js-struct-elem' data-key='"+(p.value)+"'><span>"+(p.value)+"</span></div>";
		});
		
		return "<div class='input-struct-inner clear-fix'> <div class='hidden'><input name='"+(opts._name)+"' value='"+(opts.display_value||'')+"'></div> <div class='ips-real'>"+(html)+"</div> </div>";
	};
	
	
	/**
	 * @desc Get parts
	 */
	function getParts(str){
		var spaces = [];
		var token = AP.uuid();
		var temp = str.replace(/\{([a-zA-Z0-9]+)\}/g, function(ms){
			spaces.push(ms.substr(1, ms.length-2));
			return "{"+(token)+"}";
		});
		
		var parts = temp.split("{"+(token)+"}");
		
		var r = [];
		
		for (var i=0; i<parts.length; i++){
			if (parts[i].length){
				r.push({type: 'string', value: parts[i]});	
			}
			if (i<spaces.length){
				r.push({type: 'input', value: superSafe(spaces[i])});	
			}
		}
		
		return r;
	};
	
	
	function superSafe(val){
		return val.replace(/[^a-zA-Z0-9\_\-]/g,'');
	};
};


Form.ui.filebox = {
	change: function($canvas){
		var len = $canvas.find(".fb-file").length;
		
		if (len){
			$canvas.removeClass("-empty");
		}else{
			$canvas.addClass("-empty");
		}
	},
	
	remove: function(ref){
		var id = $(ref).closest(".fi-filebox").attr("id");
		$(ref).closest(".fb-file").remove();
		this.change($("#"+id));
	},
		
	toggleRemove: function(ref){
		var $file = $(ref).closest(".fb-file");
		$file.toggleClass("-removed");
		if ($file.hasClass("-removed")){
			$file.find("input").val(1);
		}else{
			$file.find("input").val(0);
		}
	}
};

Render.on(["form-filebox", "fi-filebox", "input-filebox"], function(){
	
	var files = '';
	if (this.value && this.value.length){
		files = AP.render(this.value, function(f){
			var id = AP.uuid();
			return "<div class='fb-file -existing' id='"+(id)+"' data-id='"+(f.id)+"'> <input type='hidden' name='"+(f.id)+"-removed' value='0'/> " +Render.render('ficon', {filename:f.name}, '')+ "<div class='fname'> " +Render.render('url', {url: "::base/file?file="+(Base64.encodeURI(f.src))+"" }, ""+(f.name)+"")+ "</div> " +Render.render('special_tag', {color: "#ddd" , circled:1, sm:1}, "Existing")+ "<div class='hidden js-real-file'></div> <div class='js-remove -remove' onclick='Form.ui.filebox.toggleRemove(this)'><span class='-ap icon-close'></span></div> </div>";
		});
		
	}else{
		this.addClass("-empty");
	}
	
	return "<div class='fi-filebox "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='-fb-wrapper'> <div class='fb-current-files fb-files'>"+(files)+"</div> <div class='fb-new-files fb-files'></div> <div class='fb-buttons'> <div class='fb-button -js-upload'>Choose file</div> <div class='fb-button -js-drive'>Pick from Base Drive</div> </div> </div> </div>";
}, function(params){
	var $canvas = $(this);
	
	AP.pickable($(this).find(".-js-upload"), {
		multi: 1,
		name: params._name+'[]',
		
		callback: function(filename){
			var id = AP.uuid();
			$canvas.find(".fb-new-files").append("<div class='fb-file' id='"+(id)+"'> " +Render.render('ficon', {filename:filename}, '')+ "<div class='fname'>"+(filename)+"</div> <div class='hidden js-real-file'></div> <div class='js-remove -remove' onclick='Form.ui.filebox.remove(this)'><span class='-ap icon-close'></span></div> </div>");
			
			$(this).appendTo("#"+id+" .js-real-file");
			
			Form.ui.filebox.change($canvas);
		}
	});
	
	
	AP.pickable($(this).find(".-js-drive"), {
		multi: 1,
		drive: 1,
		
		callback: function(files){
			for (var i=0; i<files.length; i++){
				var file = files[i];
				var id = AP.uuid();
				
				$canvas.find(".fb-new-files").append("<div class='fb-file -drive' id='"+(id)+"'> " +Render.render('ficon', {filename:file.fid}, '')+ "<div class='fname'>"+(file.name)+"</div> " +Render.render('special_tag', {color: "main" , circled:1, sm:1}, "Base Drive")+ "<div class='hidden js-real-file'> <input type='hidden' name='"+(params._name)+"-drive[]' value='"+(Base64.encodeURI(JSON.stringify(file)))+"'/> </div> <div class='js-remove -remove' onclick='Form.ui.filebox.remove(this)'><span class='-ap icon-close'></span></div> </div>");
			}
			
			Form.ui.filebox.change($canvas);
			
		}
	});
	
});


Form.ui.cover = {
	setImage: function(image, canvas){
		$(canvas).find(".js-type").val("image");
		$(canvas).find(".js-bg").val(image);
		$(canvas).find(".-bg").html("  " +Render.render('photo', {src:image, ratio: "16:9" }, '')+ '');
	},
	
	setImageTemplate: function(ref, value){
		if (!value){
			value = $(ref).data("value");
		}
		
		if (!value){
			return;
		}
		
		var parts = value.split("-");
		if (parts.length!=2){
			return;
		}
		
		var $canvas = $(ref).closest(".fi-cover")
		
		$canvas.find(".js-type").val("template");
		$canvas.find(".js-bg").val(value);
		$canvas.find(".-bg").html("  " +Render.render('photo', {src: ""+(Client.image_url)+"/"+(parts[0])+"/"+(parts[1])+".svg" , ratio: "16:9" }, '')+ '');
	},
	
	setColor: function(color, canvas){
		if (color){
			$(canvas).find(".-fill").css("background-color", color).show();
			
			var $input = $(canvas).find(".js-custom");
			$input.spectrum("set", color);
		}else{
			$(canvas).find(".-fill").hide();
		}
		
		$(canvas).find(".js-color-value").val(color);
	},
	
	setOpacity: function(opacity, canvas){
		if (!$(canvas).find("input[type=checkbox]").is(":checked")){
			$(canvas).find(".-bg").css("opacity", 1.0);
			return;
		}
		
		$(canvas).find(".-bg").css("opacity", parseFloat(opacity)/100);
	}
};


Form.ui.color = {
	pallete: function(ref){
		return this.set($(ref).data("value"), ref);
	},
	
	set: function(val, ref){
		var $canvas = $(ref).closest(".fi-colorbox");
		$canvas.removeClass("-empty").find(".fc-chosen").html("<div class='chosen "+(Color.isDark(val)?'-dark':'-light')+"'> " +Render.render('tooltip', {width: "90" }, "Chosen color: "+(val)+"")+ "<div class='sq' style='background-color:"+(val)+"'> " +Render.render('icon', {icon: "fa check" }, '')+ "</div> </div> <div class='reset' onclick='Form.ui.color.reset(this)'><span class='-ap icon-close'></span></div>");
		
		$canvas.find(".js-color-value").val(val).trigger("change");
		
		if (val){
			$canvas.find(".js-custom").css("background-color", val).addClass("-selected");
			$canvas.find(".js-custom em").html(val);
			
			if (Color.isDark(val)){
				$canvas.find(".js-custom").addClass("-dark-bg");
			}else{
				$canvas.find(".js-custom").removeClass("-dark-bg");
			}
		}else{
			$canvas.find(".js-custom").css("background-color", "#fff").removeClass("-selected");
		}
	},
	
	reset: function(ref){
		var $canvas = $(ref).closest(".fi-colorbox");
		$canvas.find(".js-color-value").val("").trigger("change");
		$canvas.addClass("-empty");
		
		$canvas.find(".js-custom").css("background-color", "#fff").removeClass("-selected");
	}
};




// INPUT COLOR

Render.on(["form-color", "fi-color", "input-color"], function(){
	var presets = AP.render(range(1, 9), function(e){
		var c= Color.alt(e)
		return "<div class='fc-val' data-value='"+(c)+"' onclick='Form.ui.color.pallete(this)' style='background-color:"+(c)+"'><div class='r'></div></div>";
	});
	
	presets += AP.render(range(1, 9), function(e){
		var c= Color.adjust(Color.alt(e), -10, -85);
		return "<div class='fc-val' data-value='"+(c)+"' onclick='Form.ui.color.pallete(this)' style='background-color:"+(c)+"'><div class='r'></div></div>";
	});
	
	if (!this.presets){
		presets = '';
	}
	
	this.addSizingClass();
	if (!this.value){
		this.addClass("-empty");
	}
	
	return "<div class='fi-colorbox "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='hidden'> <input name='"+(this._name)+"' class='js-color-value js-ignored js-hidden' value='"+(this.value||'')+"'/> </div> <div class='-fc-wrapper'> <div class='fc-presets'> <div class='fc-custom js-custom'  title='Click to select a custom color'> <div> " +Render.render('icon', {icon: "form_color" }, '')+ "</div> <em class='js-selected-color'></em> </div> "+(presets)+" </div> <div class='fc-chosen'></div> </div> </div>";
}, function(params){
	var $input = $(this).find(".js-custom");
	
	$input.spectrum({
		color: params.value||null,
		type: "flat",
		hideAfterPaletteSelect: false,
		showInitial: true,
		showAlpha: false,
		allowEmpty: "false",
		palette: Color.pallete(),
		change: function(val){
			if (val){
				Form.ui.color.set(val.toHexString(), this);	
			}else{
				Form.ui.color.set("", this);
			}
		}
	});
	
	if (params.value){
		Form.ui.color.set(params.value, $input);
	}
});



Render.on(["form-cover", "fi-cover", "input-cover"], function(){
	var ratio = this.ratio|| '16:9';
	var parts = ratio.split(":");
	var p = 100*parseFloat(parts[1])/parseFloat(parts[0]);
	
	var tstruct = null;
	if (this.template){
		tstruct = {};
		
		var ts = this.template.split("-");
		if (ts.length!=2){
			console.error("INVALID input-cover template")
			return '';
		}
		
		tstruct.dir = ts[0];
		tstruct.limit = parseInt(ts[1]);
	}
	
	var templates = '';
	var btn = '';
	if (tstruct){
		templates = AP.render(range(1, tstruct.limit), function(e){
			return "<div class='bg-tpl' onclick='Form.ui.cover.setImageTemplate(this)' data-value='"+(tstruct.dir)+"-"+(e)+"'> <img src='"+(Client.image_url)+"/"+(tstruct.dir)+"/"+(e)+".svg'/> </div>";
		});
		
		btn = "<div class='fc-button -dd url' data-url=':active'> <div class='-label'>Background template</div> <div class='fc-bg-templates'>"+(templates)+"</div> </div>";
	}
	
	var content = '';
	if (this.content){
		this.addClass("-has-content");
		content = "<div class='fc-content'>"+(this.content)+"</div>";
	}
	
	var fill = "<div class='-fill'></div>";
	if (this._default){
		fill = "<div class='-fill' style='background-color:"+(this._default)+"'></div>";
	}
	
	return "<div class='fi-cover "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='hidden'> <input type='hidden' class='js-type' name='"+(this._name)+"-type'/> <input type='hidden' class='js-bg' name='"+(this._name)+"-bg'/> </div> <div class='fc-ratio' style='padding-bottom:"+(p)+"%'></div> <div class='-fc-wrapper'> <div class='fc-cover'> "+(fill)+" <div class='-bg'></div> </div> <div class='fc-color-picker'> " +Render.render('input_color', {_name: ""+(this._name)+"-color" , sm:1}, '')+ "</div> <div class='fc-opacity'> " +Render.render('form_input', {type: "checkbox" , placeholder: "Opacity" , _name: ""+(this._name)+"-opacity" }, '')+ " " +Render.render('input_percent', {_name: ""+(this._name)+"-percent" , value: "100" }, '')+ "</div> <div class='fc-bg-picker unselectable'> "+(btn)+" <div class='fc-button -bt js-upload'>Upload background</div> </div> "+(content)+" </div> </div>";
}, function(params){
	var canvas = "#"+$(this).attr("id");
	AP.uploadable($(this).find(".fc-button.js-upload"), {
		action: Base.domain("api")+"/ajax/api/file/upload?method=file",
		data: {
			accept: 'image',
			svg: 1
		},
		image: 1,
	}, function(code){
		if (!code.good()){
			return AP.alertError(code.message);
		}
		
		Form.ui.cover.setImage(code.image, canvas);
	});
	
	$(canvas).find("input[name="+(params._name)+"-color").on("change", function(){
		Form.ui.cover.setColor($(this).val(), canvas);
	});
	
	$(canvas).find("input[name="+(params._name)+"-opacity").on("change", function(){
		if ($(this).is(":checked")){
			$(canvas).find(".input-percent-canvas").show();
			var opt = $("input[name="+(params._name)+"-percent").val();
			Form.ui.cover.setOpacity($(canvas).find(opt, canvas));
		}else{
			$(canvas).find(".input-percent-canvas").hide();
			Form.ui.cover.setOpacity(100, canvas);
		}
	}).trigger("change");
	
	$(canvas).find("input[name="+(params._name)+"-percent").on("change", function(){
		Form.ui.cover.setOpacity($(this).val(), canvas);
	}).trigger("change");
	
	
	// Screencopy
	$(canvas).screencopy(Base.domain("api")+"/ajax/api/file/upload?method=paste", function(code){
		Form.ui.cover.setImage(code.image, canvas);
	});
	
	
	if (params.value){
		if (AP.word.isURL(params.value)){
			Form.ui.cover.setImage(params.value, canvas);
		}else{
			var v = AP.json.parse(Base64.decode(params.value));
			if (v){
				
				if (v.type == "image" && v.image){
					Form.ui.cover.setImage(v.image, canvas);	
				}
				
				if (v.type == "template" && v.image){
					Form.ui.cover.setImageTemplate(canvas, v.image);	
				}
				
				if (v.color){
					Form.ui.cover.setColor(v.color, canvas);
				}
				
				if (v.opacity && parseInt(v.opacity)){
					var percent = v.percent;
					if (percent == ""){
						percent = 100;
					}else{
						percent = parseFloat(percent);
					}
					
					$(canvas).find(".ui-slider").slider('value', percent);
					$(canvas).find("input[name="+(params._name)+"-percent]").val(parseFloat(v.percent));
					$(canvas).find("input[name="+(params._name)+"-opacity]").prop("checked", true).trigger("change");
					
					Form.ui.cover.setOpacity(percent, canvas);
				}
			}
		}
	}
});





Render.on("cover", function(){
	var ratio = this.ratio|| '16:9';
	var parts = ratio.split(":");
	var p = 100*parseFloat(parts[1])/parseFloat(parts[0]);
	var adjusted = "<div class='-bc-ratio' style='padding-bottom:"+(p)+"%'></div>";
	
	var content = "";
	if (this.content && $.trim(this.content)){
		this.addClass("-has-content");
		content = "<div class='bc-content'>"+(this.content)+"</div>";
	}
	
	if (this.max_height){
		this.css("max-height", this.max_height+"px");
		this.addClass("-xo");
	}
	
	if (AP.word.isURL(this.cover)){
		return "<div "+(this.showURL())+" class='base-cover "+(this.get('class'))+"'> "+(adjusted)+" <div class='-bg'> " +Render.render('photo', {ratio:ratio, src:this.cover}, '')+ "</div> "+(content)+" </div>";
	}
	
	var obj = {};
	if (this.cover){
		obj = AP.json.parse(Base64.decode(this.cover)) || {};
	}
	
	var color = obj.color||this._default||'transparent';
	color = Color.get(color);
	
	if (obj.opacity && parseInt(obj.opacity)){
		var px = obj.percent;
		if (px == ""){
			px = 1.0;
		}else{
			px = parseFloat(px)/100;
		}
	}else{
		px = 1.0;
	}
	
	
	var bg = '';
	var default_icon = '';
	
	if (obj.type == "image"){
		bg = "  " +Render.render('photo', {ratio:ratio, src:obj.image}, '')+ '';
	}else if (obj.image){
		var dir = obj.image.split("-").join("/");
		bg = "  " +Render.render('photo', {ratio:ratio, src: ""+(Client.image_url)+"/"+(dir)+".svg" }, '')+ '';
	}
	
	if (!bg && !obj.color){
		this.addClass("-empty");
		
		if (this.default_icon){
			default_icon = "<div class='-di'> " +Render.render('icon', {icon:this.default_icon}, '')+ "</div>";	
		}
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	return "<div "+(this.showURL())+" class='base-cover "+(this.get('class'))+"' "+(this.css())+"> "+(adjusted)+" <div class='-fill' style='background-color:"+(color)+"'></div> <div class='-bg' style='opacity:"+(px)+"'>"+(bg)+"</div> "+(default_icon)+" "+(content)+" </div>";
});





Render.on("input-box-select", function(){
	var html = AP.render(this.options, function(e){
		return "  " +Render.render('card', {height: "auto" }, "<div class='ibs-item' data-value='"+(e.value)+"'> <div class='ibs-icon'> " +Render.render('icon', {size: "48" , icon:e.icon}, '')+ "</div> <div class='ibs-title'>"+(e.title||e.name||e.label)+"</div> <div class='ibs-info'>"+(e.subtitle||e.sublabel||e.info||'')+"</div> </div>")+ '';
	});
	
	return "<div class='ibs-wrapper js-ibs' "+(this.show('id'))+"> " +Render.render('form_hidden', {_name:this._name, value:this.value||''}, '')+ " " +Render.render('cards', {width: "130-180" }, ""+(html)+"")+ "</div>";
}, function(params){
	$(this).find(".ibs-item").click(function(){
		$(this).closest(".js-ibs").find(".ibs-item").removeClass("active");
		$(this).addClass("active");
		
		var val = $(this).data("value");
		$(this).closest(".js-ibs").find("input").val(val);
	});
	
	if (params.value){
		$(this).find("input").val(params.value);
		$(this).find(".ibs-item").each(function(){
			if (se($(this).data("value"), params.value)){
				$(this).click();
			}
		});
	}
	
	
	
});



Form.ui.ifi = {
	setImage: function(img, $canvas){
		$canvas.find("input.js-val").val(img);
		$canvas.find(".js-display").html("<div class='img'><img src='"+(img)+"'/></div>");
	},
	
	setIcon: function(icon, $canvas){
		$canvas.find("input.js-val").val(icon);
		$canvas.find(".js-display").html("<div class='img'> " +Render.render('icon', {icon:icon, size: "64" }, '')+ "</div>");
	},
	
	setColor: function(color, $canvas){
		if (color){
			$canvas.find(".js-color").css({backgroundColor: color});
			if (Color.isDark(color)){
				$canvas.find(".js-color").addClass("-dark");
			}else{
				$canvas.find(".js-color").removeClass("-dark");
			}
			
			$canvas.find(".display-icon").css("color", color);
			$canvas.find("input.js-cval").val(color);
		}
	},
};


Render.on("input-full-icon", function(){
	var icons = AP.render(Base.icon.all(), function(e){
		return "<div class='icon-item' data-value='"+(e)+"'> " +Render.render('icon', {icon:e}, '')+ "</div>";
	});
	
	return "<div class='ifi-wrapper js-ifi' "+(this.show('id'))+"> " +Render.render('form_hidden', {_name:this._name, _class: "js-val" , value:this.value||this.icon||''}, '')+ " " +Render.render('form_hidden', {_name: ""+(this._name)+"-color" , _class: "js-cval" , value:this.color||''}, '')+ "<div class='ifi-grid'> <div class='display-icon js-display'></div> </div> <div class='ifi-actions clear-fix'> <div class='ifi-action -upload js-upload'>Upload icon</div> <div class='ifi-action -default -dd url' data-url=':active'>Pick icon <div class='ifi-icons'>"+(icons)+"</div> </div> <div class='ifi-action -fit js-color-picker'><div class='js-color'> " +Render.render('icon', {icon: "form_color" }, '')+ "</div></div> </div> </div>";
}, function(params, obj){	
	var $canvas = $(this);
	
	AP.uploadable($canvas.find(".ifi-action.js-upload"), {
		action: Base.domain("api")+"/ajax/api/file/upload?method=file",
		data: {
			accept: 'image',
			svg: 1
		},
		image: 1,
	}, function(code){
		if (!code.good()){
			return AP.alertError(code.message);
		}
		
		Form.ui.ifi.setImage(code.image, $canvas);
	});
	
	$canvas.find(".icon-item").click(function(){
		Form.ui.ifi.setIcon($(this).data("value"), $canvas);
	});
	
	$canvas.find(".js-color-picker").spectrum({
		color: params.color||null,
		type: "flat",
		hideAfterPaletteSelect: false,
		showInitial: true,
		showAlpha: false,
		allowEmpty: "false",
		palette: Color.pallete(),
		change: function(val){
			if (val){
				Form.ui.ifi.setColor(val.toHexString(), $canvas);
			}else{
				Form.ui.ifi.setColor("", $canvas);
			}
		}
	});
	
	if (params.color){
		Form.ui.ifi.setColor(params.color, $canvas);
	}
	
	if (params.icon){
		Form.ui.ifi.setIcon(params.icon, $canvas);
	}
});




Render.on("input-switch", function(){
	var checked = '';
	if (this.value && parseInt(this.value)){
		checked = 'checked';
	}
	
	if (!this.placeholder){
		this.addClass("-no-ph");
	}
	
	this.addSizingClass();
	
	return "<label class='input-switch-container "+(this.get('class'))+"'> <div class='input-switch'> <input type='checkbox' name='"+(this._name)+"' "+(checked)+"> <span class='slider round'></span> </div> <span class='-ph'>"+(this.placeholder||'')+"</span> </label>";
});




Render.on("input-label-select", function(){
	var options = this.options;
	
	var opts = AP.render(options, function(e){
		var w = 99;
		if (options.length){
			w = (100/options.length)-1;
		}
		
		return "<div class='input-label' data-value='"+(e.value)+"' style='width:"+(w)+"%'> <div class='-r' style='background-color: "+(e.color)+"'></div> <div class='-label'>"+(e.label||e.name)+"</div> </div>";
	});
	
	return "<div class='input-labels' id='"+(this.id)+"'> <div class='hidden'><input type='text' name='"+(this._name)+"' id='"+(AP.uuid())+"'/></div> <div class='input-label-options'> <div class='-il-inner clear-fix'>"+(opts)+"</div> </div> <div class='input-extra-ph'>"+(opts.placeholder)+"</div> </div>";
	
}, function(params, org){
	var $canvas = $(this);
	
	$canvas.find(".input-label").each(function(){
		$(this).click(function(){
			$(this).toggleClass("active");
			$(this).siblings().removeClass("active");
			
			if ($(this).hasClass("active")){
				var val = $(this).data("value");
				$(this).closest(".input-labels").find("input").val(val);
			}else{
				$(this).closest(".input-labels").find("input").val("");
			}
		});
	});
	
	
	if (org.value){
		$canvas.find(".input-label").each(function(){
			if ($(this).data("value") == org.value){
				$(this).click();
			}
		});
	}
});




Render.on("row", function(){
	if (this.gutters){
		if (AP.data.isInt(this.gutters)){
			this.css("gap", this.gutters+"px");	
		}else{
			this.css("gap", this.gutters);
		}
	}
	
	return "<div class='base-row' "+(this.css())+"> "+(this.content)+" </div>";
});


Render.on("row-info", function(){
	var icon = '';
	if (this.icon){
		icon = "<div class='base-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	return "<div class='row-info "+(this.get('class'))+"'> <div class='rinner'>"+(icon)+"<div class='-txt'>"+(this.content)+"</div></div> </div>";
});


Render.on("cols", function(){
	if (this.col){
		this.addClass("-col-"+this.col);
	}
	
	if (this.space || this.gap || this.padding){
		this.addClass("-spacing");
	}
	
	return "<div class='base-flex-cols "+(this.get('class'))+"' "+(this.css())+" "+(this.show('id'))+">"+(this.content)+"</div>";
}, function(params){
	if (params.equal){
		var len =$(this).children().length;
		
		$(this).children().each(function(){
			$(this).css("width", (100/len)+"%");
		});
	}
});


Render.on(["master-grid", "grid-master"], function(){
	return "<div class='master-grid-wrapper "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='master-grid clear-fix'>"+(this.content)+"</div> </div>";
}, {
	done: function(params){
		var grids = AP.word.safeSplit(" ", params.grid);
		
		var $clist = $(this).find(".master-grid").children();
		var $c = $clist.first();
		
		var html = '';
		
		while (true){
			if (!grids.length){
				break;
			}
			
			var cur = grids.shift();
			
			if (cur == "gap"){
				html += "<td class='master-grid-gap'><div></div></td>";
			}else{
				var uuid = AP.uuid();
				var css = '';
				$c.data("mgrid-id", uuid).addClass("-mg-ph");
				
				if (cur!='flex'){
					css=" style='width: "+(cur)+";'";
				}else{
					$c.addClass("master-grid-flex");
				}
				
				html += "<td class='master-grid-col' data-ref='"+(uuid)+"' id='js-col-"+(uuid)+"' data-gridwidth='"+(cur)+"' "+(css)+"> </td>";
				
				$c = $c.next();
			}
		}
		
		$("#"+params.id+" .master-grid").prepend("<div class='master-grid-table'><table> <tr>"+(html)+"</tr> </table></div>");
		
		$("#"+params.id).find(".-mg-ph").each(function(){
			var refid = $(this).data("mgrid-id");
			$(this).appendTo("#js-col-"+refid);
		});
	}
});



Render.on("empty", function(){
	var title=this.title?"<div class='-title'>"+(this.title)+"</div>":'';
	if (this.md){
		this.addClass("-md");
	}else if (this.sm){
		this.addClass("-sm");
	}
	
	if (this.fill){
		this.addClass("-fill");
	}
	
	if (this.inline){
		this.addClass("-inline-display");
	}
	
	return "<div class='base-empty-state "+(this.get('class'))+"'> <div class='-icon'>"+(Render.helper.getIcon(this))+"</div> "+(title)+" <div class='-text'>"+(this.content)+"</div> </div>";
});



Render.on("none", function(){
	if (this.inline){
		this.addClass('inline');
	}
	
	if (this.normal){
		this.addClass('normal');
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	return "<div class='base-none "+(this.get('class'))+"'>"+(this.content)+"</div>";
});



Render.on("display-multi", function(){
	return "<div class='display-obj-multi "+(this.get('class'))+"' "+(this.show('id'))+"> "+(this.content)+" </div>";
});


Render.on("display-obj-title", function(){
	return "<div class='display-obj-title hidden'>"+(this.content)+"</div>";
});


Render.on("display-obj", function(){	
	if (this.dialog){
		return "<div class='display-obj display-obj-dx "+(this.get('class'))+"' "+(this.show('id'))+"> "+(this.content)+" </div>";	
	}else if (this.with_sidebar){
		return "<div class='display-obj-with-sidebar "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='do-wrapper clear-fix'>"+(this.content)+"</div> </div>";	
	}else if (this.multi || this.fs){
		if (this.compact){
			this.addClass("-compact");
		}
		
		if (this.darken || this.fs){
			this.addClass("-darken");
		}
		
		return "<div class='display-obj-multi -fs "+(this.get('class'))+"' "+(this.show('id'))+"> "+(this.content)+" </div>";
	}else{
		if (this.connected){
			this.addClass("-connected");
		}
		return "<div class='display-obj "+(this.get('class'))+"' "+(this.show('id'))+"> "+(this.content)+" </div>";
	}
}, {
	done: function(params){
		if (params.multi || params.fs){
			return Render.display.fs(this, params);
		}else if (params.with_sidebar){
			return Render.display.withSidebar(this, params);
		}else if (params.dialog){
			return Render.display.dialog(this, params);
		}
	}
});


Render.on("display-sidebar", function(){
	return "<div class='display-sidebar' "+(this.show('id'))+"> "+(this.content)+" </div>";
});


Render.on("display-main", function(){
	return "<div class='display-main' "+(this.show('id'))+"> "+(this.content)+" </div>";
});



Render.on("display-header", function(){
	var title=this.title?("<div class='title'>"+(this.title)+"</div>"):'';
	
	return "<div class='display-header "+(this.show('class'))+"' "+(this.show('id'))+"> <div class='-close' onclick='Base.load.closeFS();'><span class='-ap icon-chevron-left22'></span></div> "+(title)+" "+(this.content)+" </div>";
});



Render.on("display-cover", function(){
	var icon='';
	if (this.icon || this.svg){
		icon="<div class='cover-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	if (this.avatar){
		if (this.avatar=="1" || this.avatar==1){
			
		}else{
			
		}
		
		this.addClass("-pavatar");
	}
	
	var bg='';
	if (this.bg){
		bg="<div class='dc-cover'><img src='"+(this.bg)+"'/></div>";
	}
	
	if (this.color){
		// this.css("background-color", Render.helper.getColor(this.color));
	}
	
	return "<div class='display-cover"+(this.special?'-special':'')+""+(this.exchange?'-exchange':'')+" "+(this.get('class'))+"' "+(this.css())+"> "+(bg)+" "+(icon)+" "+(this.content)+" </div>";
});


Render.on("display-sections", function(){
	if (!Render.acl(this)){
		return "";
	}
	
	return "<div class='display-sections base-sections'>"+(this.content)+"</div>";
});


Render.on("display-section", function(){
	if (!Render.acl(this)){
		return "";
	}
	
	var subtitle = this.subtitle?"<div class='subtitle'>"+(this.subtitle)+"</div>":'';
	var header = "<div class='header'> <div class='title'>"+(this.title)+"</div> "+(subtitle)+" </div>";
	
	if (!this.title){
		header = '';
	}
	
	if (this.icon){
		this.data_icon=this.icon;
	}
	
	if (this.active){
		this.addClass("active");
	}
	
	var html = ""+(header)+" <div class='body'>"+(this.content)+"</div>";
	
	if (this.float){
		html =  "<div class='section-inner'>"+(html)+"</div>"
	}
	
	return "<div class='section display-section "+(this.get('class'))+"' "+(this.showAllData())+" "+(this.showData('title'))+" "+(this.show('id'))+" "+(this.css())+"> "+(html)+" </div>";
	
}, function(params, obj){
	$(this).find(" > .body > .base-side").appendTo($(this).find("> .header"))
});


Render.on("display-section-connector", function(){
	return "<div class='section-connector'>"+(this.content)+"</div>";
});




Render.display = new function __RenderDisplay(){
	this.fs = function(canvas, params){
		setTimeout(function(){
			render();
		});
	};
	
	this.withSidebar = function(canvas, params){
		setTimeout(function(){
			renderWithSidebar(canvas, params);
		});
	};
	
	this.dialog = function(canvas, params){
		setTimeout(function(){
			renderDialog(canvas, params);
		});
	}
	
	function renderDialog(canvas, params){
		groupSections("#"+params.id+"");
	};
	
	
	function render(){
		if (!$("#base-master-fs .display-sidebar .section.active").length){
			$("#base-master-fs .display-sidebar .section").eq(0).addClass("active");
		}
		
		var tabs = [];
		$("#base-master-fs .display-sidebar .section").each(function(){
			var uuid = AP.uuid();
			$(this).addClass("js-"+uuid);
			tabs.push({
				title: $(this).data("tab")||$(this).data("title"),
				uuid: uuid,
				icon: $(this).data("icon"),
				active: $(this).hasClass("active")
			});
		});
		
		var tabs_html = AP.render(tabs, function(e){
			return "<div class='icon js-icon-tab "+(e.active?'active':'')+"' data-tab='"+(e.uuid)+"' title='"+(e.title)+"'>"+(SVG[e.icon])+"</div>";
		});
		
		var html = "<div class='display-controls'> <div class='area'><div class='icon -close' onclick='Base.load.closeFS();'><span class='-ap icon-ion-android-close'></span></div></div> <div class='area'> "+(tabs_html)+" </div> </div>";
		
		$("#base-master-fs .display-obj-multi.-fs").append(html);
		
		$("#base-master-fs .display-controls .js-icon-tab").on("click", function(){
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			var uuid=$(this).data("tab");
			$("#base-master-fs .display-sidebar .section").removeClass("active").setActive(".js-"+uuid);
			
			setSidebarTitle();
		});
		
		
		$("#base-master-fs .display-sidebar").wrapInner("<div class='display-sidebar-scroller' data-autohide='1' data-autoscroll='1'></div>");
		$("#base-master-fs .display-sidebar").prepend("<div class='sidebar-header'></div>");
		Layout.scrollable("#base-master-fs .display-sidebar-scroller");
		
		
		$("#base-master-fs .display-obj").wrap("<div class='display-obj-scroller scroll-y forced-scroll'></div>");
		if (!$("#base-master-fs .display-header").length){
			$("#base-master-fs .display-obj-scroller").css({top: 0});
		}
		
		setSidebarTitle();
		
		groupSections("#base-master-fs .display-main .display-obj");
	};
	
	
	
	function renderWithSidebar(canvas, params){
		var $mcanvas = $(canvas).closest(".base-load-wrapper");
		var $bc = $(canvas).find(".base-bc");
		if ($bc.length){
			$mcanvas.find(".bl-header .bl-title").replaceWith($bc);
		}
		
		var $header = $(canvas).find(".display-obj-title");
		if ($header.length){
			$header.show();
			$mcanvas.find(".bl-header .bl-title").empty().html($header);
		}
		
	};
	
	
	
	function setSidebarTitle(){
		var title=$("#base-master-fs .display-sidebar .section.active .header").first().text();
		$("#base-master-fs .display-sidebar .sidebar-header").html($.trim(title));
	};
	
	
	function groupSections(canvas){
		$(canvas+" .base-sections").addClass("-bs-connected").each(function(){
			var tabs=[];
			$(this).find(".base-section, .section").each(function(){
				$(this).addClass("js-section");
				
				var ref=AP.uuid();
				var tab=$(this).data("tab");
				
				if (!tab){
					tab = safe($(this).find(".header .title").text());
				}
				$(this).addClass("js-"+ref);
				tabs.push({ref: ref, tab: tab});
			});
			
			$(this).wrapInner("<div class='sections-body'></div>");
			var tabs_html = AP.render(tabs, function(t){
				return "<div class='tab' data-ref='"+(t.ref)+"'>"+(t.tab)+"</div>";
			});
			
			$(this).prepend("<div class='tabs'>"+(tabs_html)+"</div>");
			$(this).find(".tabs .tab").on("click", function(){
				$(this).siblings().removeClass("active");
				$(this).addClass("active");
				$(this).closest(".base-sections").find(".sections-body .js-section").setActive(".js-"+$(this).data("ref"));
			});
			
			$(this).find('.tabs .tab:first').click();
		});
	};
	
};


Render.on("display-field", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	var value='';
	
	if (this.value){
		value = "<div class='field-value'>"+(this.value)+"</div>";
	}
	
	var sublabel = '';
	if (this.sublabel){
		sublabel = "<div class='field-sublabel ap-xdot' title='"+(this.sublabel)+"'>"+(this.sublabel)+"</div>";
	}
	
	var label = this.field?"<div class='field-label'>"+(this.field)+"</div>":'';
	
	var icon='';
	
	if (this.icon){
		icon = "<div class='-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	if (this.width){
		this.css("width", this.width+"px");
	}
	
	var content=this.content?"<div class='field-value'>"+(this.content)+"</div>":'';
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	return "<div class='display-field "+(this.get('class'))+"' "+(this.show('id'))+" data-ui='info-row' "+(this.css())+"> "+(icon)+" "+(label)+" "+(sublabel)+" "+(value)+" "+(content)+" </div>";
});


Render.on("display-fields", function(){
	return "<div class='base-info-rows'> <div class='bi-rows-title'>"+(this.title)+"</div> <div class='bi-rows'>"+(this.content)+"</div> </div>";
});


Render.on("display-sub-section", function(){
	if (!Render.acl(this)){
		return '';
	}
	
	var title="<div class='ss-header'> <div class='title'>"+(this.title)+"</div> </div>";
	
	if (this.first){
		this.addClass("-first");
	}
	
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	return "<div class='sub-section "+(this.get('class'))+"' "+(this.show('id'))+"> "+(title)+" <div class='ss-body'>"+(this.content)+"</div> </div>";
}, function(params){
	var $side = $(this).find(".ss-body > .base-side");
	if ($side.length){
		$side.appendTo($(this).find(".ss-header"));
	}
});









Render.on("cell", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	if (this.width){
		if (AP.data.isInt(this.width)){
			this.css('width', this.width+"px");
		}else{
			this.css('width', this.width);	
		}
		
	}
	
	var content = this.content;
	
	if (this.first){
		this.addClass('-first');
	}
	
	if (this.last){
		this.addClass('-last');
	}
	
	if (this.fit){
		this.addClass('-fit');
	}
	
	if (this.fill){
		var _fill = Color.get(this.fill);
		this.css("background-color", _fill);
		if (Color.isDark(_fill)){
			this.addClass("-fill-dark");
		}else{
			this.addClass("-fill-white");
		}
	}
	
	if (this.stroked){
		this.addClass("-stroked");
	}
	
	var _content = this.content;
	if (this.icon){
		_content = "<div class='-cell-x -picon'> " +Render.render('icon', {_class: "-cell-icon" , icon:this.icon, color:this.icon_color||''}, '')+ "<div class='-content'>"+(_content)+"</div> </div>";
	}else if (this.avatar){
		_content = "<div class='-cell-x -pavatar'> " +Render.render('avatar', {_class: "-cell-avatar" , icon:this.icon, src:this.avatar, resize:1}, '')+ "<div class='-content'>"+(_content)+"</div> </div>";
	}
	
	
	if (this.actions){
		var css='';
		if (this.top){
			css+="padding-top:"+(this.top)+"px; ";
		}
		
		content ="<div class='cell-actions' style='"+(css)+"'>"+(_content)+"</div>";
		
	}else if (this.top || this.right || this.left){
		var left='';
		if (this.left){
			left="padding-left:"+(this.left)+"px";
		}
		
		content="<div class='relative' style='margin-top:"+(this.top||0)+"px; padding-right:"+(this.right||0)+"px; "+(left)+"'>"+(_content)+"</div>";
	}
	
	var cs = '';
	if (this.colspan){
		cs = " colspan='"+(this.colspan)+"' ";
	}
	
	return "<td "+(this.css())+" class='"+(this.get('class'))+"' "+(cs)+"><div class='cell"+(this.lead?'-lead':'')+""+(this.align?' -align':'')+"'> "+(content)+" </div></td>";
});


Render.on("table-header", function(){
	this.addSizingClass();
	this.addStatusColor();
	
	if (this.gray){
		this.addClass('-gray');
	}
	
	return "<thead "+(this.show('id'))+" class='"+(this.get('class'))+"'> <tr>"+(this.content)+"</tr> </thead>";
}, {
	done: function(){
		$(this).find(".cell").wrapInner("<div class='ap-xdot'></div>");
	}
});


Render.on("table-row", function(){
	return "<tr class='js-table-row "+(this.get('class'))+"' "+(this.show('id'))+" "+(this.showAllData())+">"+(this.content)+"</tr>";
});



Render.on("table-body", function(){
	return "<tbody "+(this.show('class'))+" "+(this.show('id'))+">"+(this.content)+"</tbody>";
});


Render.on("table-lite", function(){
	var filter='';
	if (this.filter){
		filter="<div class='table-filter'> <input type='text' class='js-table-filter' placeholder='"+(this.filter)+"'/> </div>";
	}
	
	return "<div class='base-table-lite-wrapper' "+(this.show('id'))+"> "+(filter)+" <div class='base-table-lite'> <div class='table-lite'> <table>"+(this.content)+"</table> </div> </div> </div>";
}, {
	done: function(params){		
		if (params.filter){
			$(this).find(".js-table-filter").quickFilter($(this).find("tbody tr"), function($e, q){
				return AP.word.fulltextMatch($e.text(), q);
			});
		}
	}
});


Render.on(["table-compact", "table-inline"], function(){
	var filter='';
	if (this.filter){
		filter="<div class='table-filter'> <input type='text' class='js-table-filter' placeholder='"+(this.filter)+"'/> </div>";
	}
	
	return "<div class='base-table-compact-wrapper' "+(this.show('id'))+"> "+(filter)+" <div class='base-table-compact'> <div class='table-compact'> <table>"+(this.content)+"</table> </div> </div> </div>";
}, {
	done: function(params){		
		if (params.filter){
			$(this).find(".js-table-filter").quickFilter($(this).find("tbody tr"), function($e, q){
				return AP.word.fulltextMatch($e.text(), q);
			});
		}
	}
});


Render.on("table", function(){
	if (this.fill_white || this.fill=='white' || this.standout){
		this.addClass("-wbox");
	}
	
	return "<div class='base-table-wrapper "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='base-table-inner'> <div class='base-table'> <table>"+(this.content)+"</table> </div> </div> </div>";
},{
	done: function(params){
		if (params.sortable){
			var data= {};
			if (params.sortable_data){
				data = $.extend({}, Render.helper.decode(params.sortable_data));
			}
			
			var handle = ".cell > .base-icon";
			if ($(this).find(".sicon").length){
				handle = ".cell > .sicon";
			}
			
			UI.sortable({
				canvas: "#"+params.id,
				items: "tbody tr",
				handle: handle,
				action: params.sortable,
				data: data
			});
		}
		
		if (params.limit){
			var len = $(this).find("tr.js-table-row").length;
			if (len > params.limit){
				var extra = "<div class='base-table-show-more over-limit-footer'> <span class='js-table-show-more'>Show/hide "+(len - params.limit)+" more rows</span> </div>";
				
				$(this).find("tr.js-table-row").each(function(){
					if ($(this).index()>=params.limit){
						$(this).addClass("over-limit");
					}
				});
				
				$(this).append(extra);
			}
			
			$(this).find(".js-table-show-more").click(function(){
				if ($(this).hasClass("-activated")){
					var $table = $(this).closest(".base-table-wrapper");
					$table.find("tr.js-table-row").removeClass("over-limit-accepted");
					
					$(this).removeClass("-activated");
					return;
				}
				
				$(this).addClass("-activated");
				var $table = $(this).closest(".base-table-wrapper");
				$table.find("tr.js-table-row").addClass("over-limit-accepted");
			});
		}
		
	}
});



Render.on("super-table", function(){
	var model = this.model;
	
	if (this.selection){
		model.selection = this.selection;
	}

	SuperTable.filter = this.filter || null;
	
	model.prepareRender();
	var colgroups = this.colgroups||null;
	
	var colgroups_html = '';
	
	if (colgroups){
		for (var i=0; i<colgroups.length; i++){
			colgroups[i].__index = i;
			
			colgroups[i].__st_left = 0;
			colgroups[i].__st_width = 0;
		}
		
		for (var i=0; i<model.models.length; i++){
			if ('group_id' in model.models[i]){
				model.models[i].group = ARR.findObj(colgroups, model.models[i].group_id);
			}
		}
		
		model.models = ARR.sort(model.models, function(m, i){
			if (m.group){
				return 1000 + m.group.__index + 1;
			}
			
			return i;
		});
		
		for (var i=0; i<model.models.length; i++){
			if (model.models[i].group){
				model.models[i].group.__st_width += model.models[i].width;
			}
		}
		
		var __st_left = 0;
		if (this.selection){
			__st_left = 40;
		}
		for (var i=0; i<model.models.length; i++){
			if (model.models[i].group){
				if (!model.models[i].group.__st_left){
					model.models[i].group.__st_left = __st_left;
					__st_left = model.models[i].group.__st_left + model.models[i].group.__st_width;
				}
			}else{
				__st_left = __st_left + model.models[i].width;
			}
		}
		
		colgroups_html = AP.render(colgroups, function(cg){
			if (!cg.__st_width){
				return '';
			}
			
			return SuperTable.ui.gheader(cg); 
		});
		
		colgroups_html = "<div class='colgroups'>"+(colgroups_html)+"</div>";
	}
	
	var headers = AP.render(model.models, function(e){
		return SuperTable.ui.header(e);
	});
	
	if (model.selection){
		headers = SuperTable.ui.headerCB(model) + headers;
	}
	
	this.ipp = parseInt(this.ipp) || 0;

	var rows= '';
	var page = Query.getInt("page") || 1;
	
	
	for (var i=0; i<this.data.length; i++){
		if (this.ipp && (i<(page-1)*this.ipp || i>=page*this.ipp)){
			continue;
		}
		
		rows += model.getRowHTML(this.data[i]);
	}
	
	// HARD-CODED
	SuperTable.cache = {
		data: this.data,
		model: this.model,
		colgroups: this.colgroups
	};
	
	if (this.sticky_header){
		this.addClass("-sticky-header");
	}
	
	if (colgroups){
		this.addClass("-multiple-lines");
	}
	
	return "<div class='super-table-canvas "+(this.get('class'))+"' "+(this.show('id'))+"> "+(SuperTable.ui.extra(this))+" <div class='super-table-wrapper scroll-x scroll-y' id='"+(model.canvas_id)+"'> <div class='super-table' style='width: "+(model.width())+"px'> <div class='thead'>"+(headers)+"</div> "+(colgroups_html)+" <div class='tbody'> "+(rows)+" </div> </div> </div> </div>";
}, {
	done: function(params){
		SuperTable.inline.init("#"+params.id);

		$(this).find(".filter").click(function(){
			if (SuperTable.filter) {
				var ref = $(this).closest(".th");
				SuperTable.filter.render(ref, ref.data("id"));
			}
		});
		
		var $extra = $(this).find(".super-table-extra");
		if ($extra.length){
			$extra.find(".stp.-left").click(function(){
				SuperTable.ui.updatePage(-1);
			});
			
			$extra.find(".stp.-right").click(function(){
				SuperTable.ui.updatePage(1);
			});
			
			$extra.find("select").on("change", function(){
				var v =$(this).val();
				SuperTable.ui.setPage(v);
			});
			
			var cur = Query.getInt("page");
			if (cur){
				$extra.find("select").val(cur);	
			}else{
				$extra.find("select").val(1);
			}
		}
		
		if (params.sticky_header && !mobile()){
			var $header = $(this).find(".super-table-wrapper .thead, .super-table-wrapper .colgroups");
			
			$(this).find(".super-table-wrapper").on("scroll", function(){
				var top = $(this).scrollTop();
				var left = $(this).scrollLeft();
				$header.css("top", top);
				
				$(this).find(".-sticky-left").css({'transform': "translateX("+(left)+"px)"});
			});
		}
		
		if (params.row_class){
			$(this).find(".super-row").addClass(params.row_class);
		}
	}
});



Render.on("super-row", function(){
	return "<div class='super-row "+(this.get('class'))+"' "+(this.showAllData())+" "+(this.show('id'))+">"+(this.content)+"</div>";
});

Render.on("super-cell-wrapper", function(){
	if (this.width){
		this.css("width", this.width+"px");
	}
	
	var extra='';
	
	if (this.sticky_left){
		this.addClass("-sticky-left");
		extra = " data-mleft='"+(this.sticky_margin||'')+"'";
	}
	
	return "<div class='super-cell-wrapper "+(this.get('class'))+"' "+(this.css())+" "+(extra)+" "+(this.show('id'))+">"+(this.content)+"</div>";
}, function(params){
	
});


Render.on("super-row-checkbox", function(){
	return "<div class='row-checkbox-wrapper'> <div class='row-checkbox url' data-url='::super/table/selected'></div> </div>";
});


Render.on("super-cell", function(){
	if (this.align){
		this.top=6;
	}
	
	if (this.fit){
		this.addClass('-fit');
	}
	
	if (this.top){
		this.css("padding-top", this.top+"px");
	}
	
	if (this.left){
		this.css("padding-left", this.left+"px");
	}
	
	this.addSizingClass();
	
	var icon='';
	
	if (this.icon){
		this.addClass("-picon");
		if (this.icon!=1){
			icon= "<span class='-cell-icon'>"+(Render.helper.getIcon(this))+"</span>";
		}
	}else if (this.icon_sm){
		this.addClass("-picon-sm");
		icon= "<span class='-cell-icon'>"+(Render.helper.getIcon(this))+"</span>";
	}else if (this.avatar){
		this.addClass("-pavatar");
		
		if (this.avatar!=1){
			icon= "<div class='-cell-avatar'><img src='"+(this.avatar)+"'></div>";
		}
	}
	
	if (this.fill){
		this.css("background-color", Color.get(this.fill));
		this.addClass("-fillable");
	}
	
	var content = "<div class='sc-inner "+(this.url?' url':'')+"' "+(this.show('url'))+">"+(this.content)+"</div>";
	if (this.url){
		content = "<div class='sc-inner'><span class='url' "+(this.show('url'))+">"+(this.content)+"</span></div>";
	}
	
	return "<div class='super-cell "+(this.get('class'))+"' "+(this.css())+" "+(this.showHTMLSemantics())+">"+(icon)+" "+(content)+" </div>";
	
});




Render.superList = new function __RenderSuperList(){
	
	this.update = function(canvas){
		$(canvas).find(".sl-subs").each(function(){
			var $last = $(this).children().last();
			
			if (!$last || !$last.length){
				$(this).prev().hide();
				return;
			}
			
			var pos = $last.position();
			var h = pos.top-24;
			if (h<0){
				h=0;
				$(this).prev().hide();
				return;
			}
			
			$(this).prev().css({height: h}).show();
		});
	};
	
	
	this._update = function(ref){
		setTimeout(function(){
			Render.superList.update($(ref).closest(".base-super-list-wrapper"));
		});
	};
};

Render.on(["list-super", "super-list"], function(){
	if (this.render && this.items){
		var render = Render.helper.getFunction(this.render);
		var content = Render.helper.list.html(this.items, render);
		
		return "<div class='base-super-list-wrapper -with-arrow' "+(this.show('id'))+"> <div class='base-super-list'>"+(content)+"</div> </div>";
	}
	
	return "<div class='base-super-list-wrapper' "+(this.show('id'))+"> <div class='base-super-list'>"+(this.content)+"</div> </div>";
}, {
	done: function(){
		Render.superList.update(this);
	}
});

Render.on("list-super-item", function(){
	var dd_icon='';
	
	if (this.has_child && parseInt(this.has_child)){
		this.addClass('-has-child');
		dd_icon="<div class='-icon url' data-url=':collapse:parent' onclick='Render.superList._update(this);'>"+(SVG.ui_list_arr)+"</div>";
	}
	
	if (!dd_icon){
		dd_icon="<div class='-icon'><span class='-icon-ph'></span></div>";
	}
	
	if (this.last && parseInt(this.last)){
		this.addClass("-last");
	}
	
	return "<div class='sl-item-wrapper js-obj "+(this.get('class'))+"'> "+(dd_icon)+" "+(this.content)+" </div>";
});

Render.on("list-super-subs", function(){
	return "<div class='sl-r'></div> <div class='sl-subs'>"+(this.content)+"</div>";
});

Render.on("list-super-main", function(){
	return "<div class='sl-item-main'> <div class='sl-item'> <div class='line-h'></div> <div class='line-v'></div> "+(this.content)+" </div></div>";
});



Render.helper.list = new function __RenderHelperList(){
	this.html = function(items, render){
		return AP.render(items, function(e, index, total){
			return getNodeHTML(e, render, index==total-1);
		});
	};
	
	
	function getNodeHTML(node, render, is_last){
		var html = render(node);
		var items = '';
		
		if (!node.items || !node.items.length){
			
		}else{
			for (var i=0; i<node.items.length; i++){
				items += getNodeHTML(node.items[i], render, i==node.items.length-1);
			}	
		}
		
		var hc = (node.items && node.items.length>0)?1:0;
		var last = is_last?1:0;
		
		return "  " +Render.render('list_super_item', {has_child:hc, last:last}, '' +Render.render('list_super_main', {}, ""+(html)+"")+ " " +Render.render('list_super_subs', {}, ""+(items)+"")+ '')+ "";
	};
	
};


Render.on("super-tree", function(){
	var render = Render.helper.getFunction(this.render);
	var tree = new TreeRender(this);
	var html= tree.html(this.root, render);
	this.root.engine = tree;
	
	return "<div class='super-tree' "+(this.show('id'))+"> <div class='tree-controls unselectable'> " +Render.render('buttons', {}, '' +Render.render('button', {_class: "js-up" , icon: "ap plus2" , url: "::tree/up" , icon_only:1}, '')+ " " +Render.render('button', {_class: "js-value" , url: "::tree/initial" , text_only:1}, "100%")+ " " +Render.render('button', {_class: "js-down" , icon: "ap minus2" , url: "::tree/down" , icon_only:1}, '')+ '')+ " " +Render.render('button', {icon: "ap reload" , url: "::tree/balance" , icon_only:1}, '')+ "</div> <div class='tree-viewport'> <div class='js-canvas-dragger dragger'></div> <div class='tree-canvas' style='opacity:0'>"+(html)+"</div> </div> </div>";
}, {
	done: function(params){
		var $that=$(this);
		
		$that.find(".tree-canvas").draggable({
			stop: function(event, ui){
				var top=$that.data("offset_top") || 0;
				var left=$that.data("offset_left") || 0;
				
				$that.data("offset_top", top);
				$that.data("offset_left", left);
			}
		});
		
		$that.find(".js-canvas-dragger").draggable({
			helper: 'clone',
			drag: function(event, ui){
				var top=$that.data("offset_top") || 0;
				var left=$that.data("offset_left") || 0;
				
				top+=ui.position.top;
				left+=ui.position.left;
				
				
				$that.find(".tree-canvas").css({left: left, top: top});
			}, stop: function(event, ui){
				var top=$that.data("offset_top") || 0;
				var left=$that.data("offset_left") || 0;
				
				top+=ui.position.top;
				left+=ui.position.left;
				
				$that.data("offset_top", top);
				$that.data("offset_left", left);
			}
		});
		
		// Auto alignment
		
		var $root = $that.find(".tree-master-node:first");
		if ($root && $root.length){
			var width= $root.width();
			var wp = $root.closest(".super-tree").width();
			
			var offset_left = (wp-width)/2;
			$root.closest(".tree-canvas").css({"left": offset_left, "top": 50, opacity: 1.0});
			
			$that.data("offset_left", offset_left);
			$that.data("offset_top", 50);
		}
		
		
		// Mouse
		if (params.mouse || params.mousewheel || params.mouse_wheel){
			$that.on("mousewheel", function(event){
				var factor=event.originalEvent;
				if (!factor){
					return;
				}
				
				if (factor.deltaY<0){
					$that.find(".tree-controls .js-down").click();
				}else if (factor.deltaY>0){
					$that.find(".tree-controls .js-up").click();
				}
			});
		}
	}
});


Render.on("super-path", function(){
	
});


Rewrite.on("::tree/{action}", function(qs){
	var action = qs.action;
	
	if (action == "balance"){
		var $that = $(this).closest(".super-tree");
		var $root = $that.find(".tree-master-node:first");
		
		if ($root && $root.length){
			var width= $root.width();
			var wp = $root.closest(".super-tree").width();
			
			var offset_left = (wp-width)/2;
			$root.closest(".tree-canvas").animate({"left": offset_left, "top": 50}, 200);
			
			$that.data("offset_left", offset_left);
			$that.data("offset_top", 50);
		}
		
		return;
	}
	
	var $that = $(this).closest(".super-tree");
	var scale = $that.data("scale") || 100;
	
	if (action == "up"){
		scale+=5; 
	}else if (action == "down"){
		scale-=5; 
	}else if (action == 'initial'){
		scale = 100;
	}
	
	if (scale<10){
		scale=10;
	}
	
	if (scale>500){
		scale=500;
	}
	
	$that.data("scale", scale);
	$(this).closest(".tree-controls").find(".js-value").html(scale+"%");
	
	$that.find(".tree-canvas").css({
		transform: "scale("+(scale/100.0)+")",
		transformOrigin: 'center'
	});
	
	var $root = $that.find(".tree-master-node:first");
	
	if ($root && $root.length){
		var width= $root.width();
		var wp = $that.width();
		var offset_left = (wp-width)/2;
		$root.closest(".tree-canvas").animate({"left": offset_left, "top": 50}, 200);
		
		$that.data("offset_left", offset_left);
		$that.data("offset_top", 50);
	}
	
	return;
});


Render.on("kanban", function(){
	if (!this.width){
		this.width='280';
	}
	
	if (!this.header){
		this.header = '40';
	}
	
	return "<div class='kanban-wrapper scroll-y scroll-x forced-scroll' id='"+(this.get('id'))+"' "+(this.showData('width'))+" "+(this.showData('header'))+"> <div class='kanban-container'> <div class='kanban-board'> "+(this.content)+" </div> </div> </div>";
}, {
	done: function(params){
		$(this).find(".kanban-col").css("width", $(this).data("width"))
		var count = $(this).find(".kanban-col").length;
		var w = count * (parseInt($(this).data("width"))+10)
		$(this).find(".kanban-board").css("width", w).show();
	}
});


Render.on("kanban-col", function(){
	return "<div class='kanban-col' "+(this.showAllData())+"> <div class='kanban-col-main'>"+(this.content)+"</div> </div>";
});


Render.on("kanban-header", function(){
	return "<div class='kanban-header' "+(this.showAllData())+"> <div class='kanban-header-main'>"+(this.content)+"</div> </div>";
});


Render.on("kanban-item", function(){
	return "<div class='kanban-item' "+(this.show('id'))+"> <div class='kb-item'>"+(this.content)+"</div> </div>";
	
});



function Stack(data){
	var _data=[];
	
	if (data){
		for (var i=0; i<data.length; i++){
			_data.push(data[i]);
		}
	}
	
	/**
	 * @desc Get the length of the array
	 */
	this.length = function(){
		return _data.length;
	};
	
	
	/**
	 * @desc Check for empty
	 */
	this.empty = function(){
		return this.length() == 0;
	};
	
	
	/**
	 * @desc Push an element to the end of the array
	 */
	this.push = function(elem){
		_data.push(elem);
	};
	
	
	/**
	 * @desc Get the last element
	 */
	this.pop = function(){
		if (_data.length){
			return _data.pop();
		}
		
		return null;
	};
	
	
	/**
	 * @desc Get the last element of the stack
	 */
	this.last = function(){
		if (_data.length){
			return _data[_data.length-1];
		}
		
		return null;
	};
	
};


function TreeRender(opts){
	var left=0;
	var stack;
	var last;
	var debug = 0;
	var render = null;
	
	var max_level = 0;
	var card_width=100;
	
	if (opts.max_level){
		max_level = parseInt(opts.max_level);
	}
	
	if (opts.width){
		card_width = parseInt(opts.width) || 100;
	}
	
	this.html = function(root, _render){
		render = _render;
		
		// BUILD the stack
		stack = new Stack();
		last = null; 
		initialize(root);
		setLevels(root);
		buildStack(root, true);
		realign(stack);
		
		return getHTML(root);
	};
	
	
	/**
	 * @desc Update, normally when a tree is changed
	 */
	this.update = function(root){
		var dom_id=root.dom.id;
		
		stack = new Stack();
		last = null; 
		initialize(root);
		buildStack(root);
		realign(stack);
		var html= getHTML(root);
		$("#"+dom_id).closest(".tree-canvas").html(html);
	};
	
	
	this.balance = function(root){
		balanceLayout(root);
	};
	
	
	function initialize(root){
		root.parent_id = parseInt(root.parent_id);
		
		root.dom = {
			id: AP.uuid(),
			left: 0,
			cleft: 0,
			width: 1,
			level: 0,
			node_count: 0,
			depth: 0,
			items: 0
		};
		
		if (!root.items){
			root.items=[];
		}
		
		if (root.collapsed){
			return;
		}else{
			root.dom.items = root.items.length;
		}
		
		for (var i=0; i<root.items.length; i++){
			if (!root.items[i].parent){
				root.items[i].parent = root;	
			}
			
			if (i>0 && !root.items[i].prev){
				root.items[i].prev = root.items[i-1];	
			}

			root.items[i].parent_id = parseInt(root.items[i].parent_id);
			initialize(root.items[i]);
		}
	};
	
	
	function setLevels(node){
		for (var i=0; i<node.items.length; i++){
			node.items[i].dom.level = node.dom.level+1;
			setLevels(node.items[i]);
		}
	};
	
	
	
	function buildStack(root, set_max_level){
		stack.push(root);
		
		if (root.collapsed){
			return;
		}

		if (set_max_level && max_level){
			if (root.dom.level >= max_level){
				root.collapsed=1;
				// return;
			}
		}
		
		for (var i=root.items.length-1; i>=0; i--){
			// root.items[i].dom.level = root.dom.level+1;
			buildStack(root.items[i], set_max_level);
			root.dom.node_count += root.items[i].dom.node_count;
		}
		
		if (root.items.length && !root.collapsed){
			var max = ARR.max(root.items, function(e){
				return e.dom.depth;
			});
			
			root.dom.depth = 1+max.dom.depth; 
		}
		
		root.dom.node_count += root.items.length;
	};
	
	
	function getHTML(root){
		var html= render(root);
		var html_nodes = '';
		
		if (!root.collapsed){
			for (var i=0; i<root.items.length; i++){
				html_nodes += getHTML(root.items[i]);
			}	
		}
		
		
		var left = root.dom.left*card_width;
		var width = root.dom.width*card_width;
		
		var final_left=0;
		var cleft = left;
		
		if (!root.collapsed){
			if (root.items.length>=2){
				cleft = left + (root.items[0].dom.cleft+root.items[root.items.length-1].dom.cleft)*0.5;
			}else if (root.items.length==1){
				cleft = left + root.items[0].dom.cleft;
			}	
		}
		
		final_left = cleft-left;
		
		root.dom.cleft=cleft;
		root.dom.final_left=final_left;
		
		var actual_width = card_width*0.9;
		
		var title = "LEFT: "+(root.dom.left)+" - DEPTH: "+(root.dom.depth)+" -  CLEFT: "+(root.dom.cleft)+" - WIDTH: "+(root.dom.width)+"";
		if (parseInt(Client.env) || 1==1){
			title = root.name;
		}
		
		return "<div class='tree-master-node' id='"+(root.dom.id)+"' style='left: "+(left)+"px; width: "+(width)+"px'> "+(getConnections(root))+" <div class='tree-node' id='"+(root.dom.id)+"-main' style='left: "+(final_left)+"px; width:"+(actual_width)+"px; transform:translate(-"+(actual_width/2-5)+"px,0);' title='"+(title)+"'>"+(html)+"</div> <div class='tree-nodes' id='"+(root.dom.id)+"-nodes' style='width: "+(width)+"px'>"+(html_nodes)+"</div> </div>";
	};
	
	
	
	
	/**
	 * @desc Inspect the area containing the size of the element
	 */
	function realign(){
		var cur = stack.pop();
		if (cur == null){
			return; // WE ARE DONE
		}
		
		
		if (!cur.collapsed){
			if (!cur.dom.items){
				cur.dom.width=1;
			}else{
				cur.dom.width=0;
				
				for (var i=0; i<cur.items.length; i++){
					cur.dom.width += cur.items[i].dom.width;
					
					if (cur.items[i].dom.width >=2){
						if (i>0 && !cur.items[i].dom.items){
							cur.dom.width = cur.dom.width - 0.9;
						}else if (i>0 && cur.items[i].dom.items ==1 && cur.items[i-1].dom.depth==1){
							cur.dom.width = cur.dom.width - 1.8;
						}
					}else if (cur.items[i].dom.depth == 0){
						if (i>0 && cur.items[i-1].dom.width>=2){
							cur.dom.width = cur.dom.width - 0.9;
						}
					}
				}	
			}	
		}
		
//		var tw=cur.dom.width
//		if (tw >= 3){
//			cur.dom.width = cur.dom.width-0.7;
//		}else if (tw >= 2){
//			cur.dom.width = cur.dom.width-0.95;
//		}
		
		if (cur.dom.width <=1){
			cur.dom.width = 1;
		}
		
		if (!last){
			moveLeft(cur, 0);
			last = cur;
		}else{
			if (last.parent_id == cur.parent_id){
				if (cur.prev && cur.prev.dom.width>=3 && !cur.dom.depth){
					setLeft(cur, last.dom.left + last.dom.width - 0.9);
				}else if (cur.prev && cur.prev.dom.width>=2 && !cur.dom.depth){
					setLeft(cur, last.dom.left + last.dom.width - 0.5);
				}else if (!cur.dom.node_count && last.dom.width>=2){
					setLeft(cur, last.dom.left + last.dom.width/2+1);
				}else{
					setLeft(cur, last.dom.left+last.dom.width);	
				}
			}else if (last.parent_id == cur.id){
				if (cur.prev){
					if (!cur.prev.dom.node_count && cur.dom.width>=2){
						setLeft(cur, cur.prev.dom.left+0.5);
					}else if (cur.prev.dom.depth < 1 && cur.dom.items == 1 && cur.dom.width>=2){ // ONE LAYER
						setLeft(cur, cur.prev.dom.left+cur.prev.dom.width-0.5);
					}else if (cur.prev.dom.depth ==1 && cur.dom.items == 1 && cur.dom.width>=3){ // ONE LAYER
						setLeft(cur, cur.prev.dom.left+cur.prev.dom.width-1);
					}else if (cur.prev.dom.depth ==1 && cur.dom.items == 1 && cur.dom.width>=2){ // ONE LAYER
						setLeft(cur, cur.prev.dom.left+cur.prev.dom.width-0.5);
					}else{
						setLeft(cur, cur.prev.dom.left+cur.prev.dom.width);
					}	
				}else{
					setLeft(cur, 0);
				}
			}else{
				moveLeft(last, 0);
			}
			
			last = cur;
		}
		
		realign();
	};
	
	
	/**
	 * @desc Move a node to the left
	 */
	function moveLeft(node, val){
		node.dom.left += val;
	};
	
	/**
	 * @desc Move a node to the left
	 */
	function setLeft(node, left){
		node.dom.left = left;
	};
	
	
	function test(node){
		$.log([node.name, node.dom.cleft, node.dom.left, node.dom.width, node.dom.width, node.dom.node_count]);
	};
	
	
	function getConnections(node){
		if (node.collapsed || !node.items.length){
			return  '';
		}
		
		var hlines = AP.render(node.items, function(e, index, total){
			var ec='';
			if (total>=2 && index==0){
				ec= "<div class='-tl'></div>";
			}
			
			if (total>=2 && index==total-1){
				ec= "<div class='-tr'></div>";
			}
			return "<div class='nc-hline' data-for='"+(e.name)+"' style='left:"+(e.dom.cleft)+"px'>"+(ec)+"</div>";
		});
		
		return "<div class='node-connections'> <div class='nc-hline-main' style='left:"+(node.dom.final_left)+"px'></div> <div class='nc-vline-main' style='left:"+(node.items[0].dom.cleft)+"px; width:"+(node.items[node.items.length-1].dom.cleft - node.items[0].dom.cleft)+"px'></div> "+(hlines)+" </div>";
	};
	
	
	function balanceLayout(root){
		var $root = $("#"+root.dom.id);
		
		if ($root && $root.length){
			var $that=$root.closest(".super-tree");
			
			var width= $root.width();
			var wp = $root.closest(".super-tree").width();
			
			var offset_left = (wp-width)/2+50;
			$root.closest(".tree-canvas").animate({"left": offset_left, "top": 50}, 300);
			
			$that.data("offset_left", offset_left);
			$that.data("offset_top", 50);
		}
	}
	
	
};



TreeRender.map = function(root, fn){
	for (var i=0; i<root.items.length; i++){
		fn(root.items[i]);
	}
	
	fn(root);
};


var SuperTable = new function __SuperTable(){
	this.mdefs = [];
	this.filter = null;

	this.current = function(){
		return SuperTable.cache.model;
	};
	
	this.model = function(opts){
		if (AP.data.isArray(opts)){
			return new SuperModel({
				models: safeTransform(opts)
			});	
		}
		
		opts.models = safeTransform(opts.models);
		return new SuperModel(opts);
	};
	
	
	this.def = function(def){
		def.__permanent = 1;
		def.key = def.key || def.id;
		this.mdefs.push(def);
	};
	
	this.dynamicDef = function(def){
		def.key = def.key || def.id;
		this.mdefs.push(def);
	};
	
	this.on = function(id, config){
		config.id = id;
		this.def(config);
	}
	
	this.group = function(key, render){
		
	};
	
	this.getModel = function(model_key){
		return ARR.findObj(SuperTable.mdefs, model_key);
	}
	
	this.register = this.def;
	
	
	function safeTransform(models){
		var ms = [];
		
		for (var i=0; i<models.length; i++){
			if (AP.data.isObject(models[i])){
				ms.push(models[i].id);
				SuperTable.dynamicDef(models[i]);
			}else{
				ms.push(models[i]);
			}
		}
		
		return ms;
	}
};


SuperTable.cache = {};


AP.gc(function(){
	SuperTable.mdefs = ARR.filter(SuperTable.mdefs, function(e){
		if (!e.__permanent){
			return false;
		}
		
		return true;
	});
	
	SuperTable.mdefs = ARR.unique(SuperTable.mdefs, function(e, f){
		return e.id == f.id;
	});
	
});




SuperTable.ui = new function __SuperTableUI(){
	
	this.header = function(model){
		var filters ="";
		var sorter ="";
		var exp = "";
		var ec='';
		if (SuperTable.filter && !model.metatype) {
			var filter = AP.array.findObj(SuperTable.filter.filters, model.id);
			var icon = filter ? SVG.filtered : SVG.filter2;
			filters= "<div class='filter' id='"+(uuid)+"'> <div class='dd'>"+(icon)+"</div> </div>";
		} else if (model.filter && model.options){
			var opts = AP.render(model.options, function(e){
				return "<div class='opt ap-xdot url "+(activeClass(model.key, e.id))+"' data-urlparam='"+(model.key)+"' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
			});
			
			opts = "<div class='opt ap-xdot url "+(activeClass(model.key, null))+"' data-urlparam='"+(model.key)+"' data-value=''>No filter</div>" + opts;
			
			var title = '';
			if (model.filter_title){
				title = "<div class='-opts-title'>"+(model.filter_title)+"</div>";
			}
			
			var uuid = AP.uuid();
			var search = '';
			if (model.options && model.options.length>=10){
				search = "  " +Render.render('search', {filter: "#"+(uuid)+" .opt" , placeholder: "Lá»c nhanh" , sm:1}, '')+ '';
			}
			
			var header = '';
			if (title || search){
				header = "<div class='-opts-header "+(search?'-with-search':'')+"'>"+(search)+""+(title)+"</div>";
			}
			
			filters= "<div class='filter' id='"+(uuid)+"'> <div class='dd'> " +Render.render('icon', {icon: "ui_filter" , size: "16" }, '')+ "</div> <div class='opts' style='max-height:"+(model.maxHeight||300)+"px'> "+(header)+" <div class='-opts-wrapper'>"+(opts)+"</div> </div> </div>";

			if (Query.get(model.id)){
				ec='-filter-activated';
			}
		}

		if (filters){
			ec+=" -has-filter";
		}

		if (SuperTable.filter && SuperTable.filter.sorting && SuperTable.filter.sorting.model_id == model.id) {
			var icon = SuperTable.filter.sorting.sort == "asc" ? SVG.sort_asc : SVG.sort_desc;
			sorter = "<div class='sorter'> <div class='dd'>"+(icon)+"</div> </div>";
		}

		if (sorter){
			ec+=" -sorted";
		}
		
		if ('explain' in model){
			exp = "<div class='exp'>"+explain(model.explain, {direction: 'down'})+`</div>`;
		}
		
		var sc='';
		
		if (model.sticky_left || model.locked){
			sc='-sticky-left';
		}
		
		if (model.group){
			sc+=" -ml";
		}else{
			sc+=" -sl";
		}
		
		var html = "<div class='ap-xdot'>"+(model.label||model.name)+"</div>";
		if (model.html){
			html = model.html;
		}
		
		return "<div class='th "+(sc)+"' data-width='"+(model.width)+"' data-id='"+(model.id)+"' style='width:"+(model.width)+"px'> "+(sorter)+" <div class='cell "+(ec)+"' title='"+(model.label||model.name)+"'> <div class='name'>"+(html)+"</div> "+(exp)+" </div> "+(filters)+" </div>";
	};
	
	
	/**
	 * @desc Checkbox on item
	 */
	this.headerCB = function(model){
		return "<div class='th "+(model.sticky_left?'-sticky-left':'')+"' data-width='40' data-id='table:checkbox' style='width:40px'> <div class='cell'> <div class='row-checkbox'></div> </div> </div>";
	};
	
	
	/**
	 * @desc Colgroup header
	 */
	this.gheader = function(cg){
		return "<div class='colgroup' style='left:"+(cg.__st_left)+"px; width:"+(cg.__st_width)+"px'> <div class='cg-inner'>"+(cg.name)+"</div> </div>";
	};
	
	
	/**
	 * @desc Show extra paging for table
	 */
	this.extra = function(table){
		var num_items = table.data.length;
		var ipp = parseInt(table.ipp)||0;
		
		var num_pages = ipp>0?Math.ceil(num_items/ipp):0;
		var cur_page = Query.getInt("page") || 0;
		
		if (num_pages <= 1 && !cur_page){
			return "<div class='super-table-extra -es'> <div class='st-pagination'> <div class='stp-total'><em>"+(AP.data.numberFormat(num_items))+"</em> records</div> </div> </div>";
		}
		
		if (num_pages<=1 && cur_page){
			num_pages=1;
		}
		
		var pages = AP.render(range(1, num_pages), function(e){
			return "<option value='"+(e)+"'>Page "+(e)+"</option>";
		});
		
		var extra = "<div class='super-table-extra'> <div class='st-pagination'> <div class='stp -left'><span class='-ap icon-chevron-left22'></span></div> <div class='stp-total'><em>"+(AP.data.numberFormat(num_items))+"</em> records</div> <div class='stp-select'> <select name='q'><option>--</option>"+(pages)+"</select> </div> <div class='stp -right'><span class='-ap icon-chevron-right22'></span></div> </div> </div>";
		
		return extra;
	};
	
	
	/**
	 * @desc Update the current's paging
	 */
	this.updatePage = function(val){
		var page = Query.getInt("page");
		if (!page || page<=0){
			page=1;
		}
		
		page = page+val;
		if (!page || page<=0){
			page=1;
		}
		
		AP.setURLParams({"page": page}, true);
	};
	
	
	this.setPage = function(page){
		page = parseInt(page);
		
		if (!page || page<=0){
			page=1;
		}
		
		AP.setURLParams({"page": page}, true);
	};
	
	
	function activeClass(filter, value){
		var q=Query.get(filter);
		if (!q){
			if (!value){
				return 'active';
			}
			
			return '';
		}
		
		if (q==value){
			return 'active';
		}
		
		return ''; 
	};
	
	
};





function SuperModel(opts){
	this.models = [];
	this.selection = false;
	this.canvas_id = opts.canvas_id || AP.uuid();
	
	this.index= opts.index||null;
	this.setClass = opts.setClass||null;
	
	
	for (var i=0; i<opts.models.length; i++){
		var m = ARR.findObj(SuperTable.mdefs, opts.models[i]);
		if (m){
			m.superModel = function(){
				return SuperTable.cache.model;
			}
			
			this.models.push(m);
		}else{
			// STANDARD, getting object value
			var df = {
				id: opts.models[i],
				key: opts.models[i],
				width: 130,
				label: opts.models[i].toUpperCase(),
				render: function(obj, md){
					var id = md.id;
					if (obj[id]){
						val=obj[id];
					}else{
						val= "  " +Render.render('none', {}, "---")+ '';
					}
					
					return "  " +Render.render('super_cell', {top: "11" , fit:1}, ""+(val)+"")+ '';
				},
				filter: "string"
			};
			
			this.models.push(df);
		}
	}
	
	
	this.width = function(){
		var w=0;
		
		for (var i=0; i<this.models.length; i++){
			w+= (this.models[i].width||130);
		}
		
		if (this.selection){
			w+=40;
		}
		
		return w;
	};
	
	
	/**
	 * @desc Prepare rendering
	 */
	this.prepareRender = function(){
		var w=0;
				
		if (this.selection){
			w=40;
		}

		for (var i=0; i<this.models.length; i++){
			w+= (this.models[i].width||130);
			this.models[i].marginLeft = w;
			
			if (this.models[i].sticky_left || this.models[i].locked){
				this.sticky_left=1;
			}
		}
	};
	
	
	this.getRowHTML = function(row){
		var cells = AP.render(this.models, function(m){
			return getCellHTML(m, row);
		});
		
		if (this.selection){
			cells = getRowCheckbox(row, this) + cells;
		}
		
		var cx = '';
		if (this.setClass){
			cx = this.setClass(row);
		}
		
		return "  " +Render.render('super_row', {data_id:row.id, data_index:this.getIndex(row), _class:cx}, ""+(cells)+"")+ '';
	};
	
	
	this.getIndex = function(row){
		if (!this.index){
			return '';
		}
		
		return this.index(row);
	};
	
	
	function getCellHTML(model, data){
		var editable = '';
		var ec = '';
		var id = AP.uuid();
		var qe = '';
		
		if ('editable' in model){
			if (AP.data.isFunction(model.editable)){
				var temp = model.editable(data);
				if (temp && AP.data.isObject(temp) && temp instanceof ActionManager){
					temp = temp.release();
				}
				
				if (!temp || !AP.data.isObject(temp)){
					if (AP.data.isString(temp)){
						editable = "<div class='cell-edit url' title='Chá»‰nh sá»­a' id='"+(id)+"' data-url='"+(temp)+"'>"+(SVG.form_edit)+"</div>";
					}else{
						editable='';	
					}
				}else if (AP.data.isArray(temp)){
					if (temp.length == 1){
						editable = "<div class='cell-edit url' title='"+(temp[0].label)+"' id='"+(id)+"' data-url='"+(temp[0].url)+"'>"+(SVG.form_edit)+"</div>";
					}else{
						var opts = AP.render(temp, function(opt){
							if (!opt){
								return '';
							}
							
							if (AP.data.isObject(opt) && 'acl' in opt && !Render.helper.acl(opt.acl)){
								return '';
							}
							
							if (opt === "---" || opt === "sep"){
								return "  " +Render.render('cmenu_item', {sep:1}, '')+ '';
							}
							
							return "  " +Render.render('cmenu_item', {url:opt.url}, ""+(opt.label)+"")+ '';
						});
						
						editable = "<div class='cell-edit -cmenuw url' id='"+(id)+"' data-url=':active'>"+(SVG.form_edit)+" " +Render.render('cmenu', {}, ""+(opts)+"")+ "</div>";
					}
				}else if ('acl' in temp && !Render.helper.acl(temp.acl)){
					editable='';
				}else{
					if (temp.quick_edit){
						qe=1;
					}
					
					editable = "<div class='-qe-edit url' data-url='::super/table/inline-edit' data-ref_id='"+(id)+"'></div> <div class='cell-edit unselectable url' id='"+(id)+"' data-ref_id='"+(id)+"' data-url='::super/table/inline-edit'>"+(SVG.form_edit)+"</div>";	
				}
			}else if (parseInt(model.editable)){
				editable = "<div class='cell-edit unselectable url' id='"+(id)+"' data-url='::super/table/inline-edit'>"+(SVG.form_edit)+"</div>";
			}
			
		}
		
		// 
	
		var pad = 0;
		if (model.sticky_left || model.locked){
			pad = model.marginLeft;
		}
		
		var cx = ""+(editable?'-editable-cell':'')+" "+(ec)+""; 
		
		return "  " +Render.render('super_cell_wrapper', {width:model.width, sticky_left:model.sticky_left||model.locked||0, sticky_margin:pad, _class:cx, qe:qe}, ""+(model.render(data, model))+" "+(editable)+"")+ '';
	};
	
	
	function getRowCheckbox(row, model){
		return "  " +Render.render('super_cell_wrapper', {width: "40" , sticky_left:model.sticky_left?1:0}, '' +Render.render('super_row_checkbox', {}, '')+ '')+ '';
	};
};



// INLINE EDITABLE


SuperTable.inline = new function __SuperTableInline(){
	this.init=function(canvas){
		$(canvas).prepend("<div id='board-ie'></div>");
		$(canvas).find(".super-table-wrapper").on("scroll", function(){
			var sleft = $(this).scrollLeft();
			var stop = $(this).scrollTop();
			
			$("#board-ie").css("left", -sleft);
			$("#board-ie").css("top", -stop);
		});
		
		$(canvas).click(function(e){
			if ($(e.target).closest(".ie").length || $(e.target).closest(".iedit").length){
			}else{
				// $("#board-ie").hide().data("ref_id",0);
			}
		});
		
		// initContextMenu(canvas);
	};
	
	
	this.trigger=function(event, ref, qs){
		if (event=="inline-edit"){
			if ($(ref).data("ref_id") && $("#board-ie").data("ref_id")==$(ref).data("ref_id")){
				closeIE();
			}else{
				activate(ref);
			}
			
			return;
		}
		
		if (event=="inline-save"){
			return saveText(ref);
		}
		
		if (event=="inline-cancel"){
			return closeIE();
		}
		
		if (event=="inline-opt"){
			if (qs.multiple && parseInt(qs.multiple)){
				
			}
			
			return saveListItem(ref);
		}
	};
	
	
	this.context=function(am, pos){
		var html=am.text();
		$("#board-ie")
	};
	
	
	/**
	 * @desc Save an inline input
	 */
	function saveText(ref, cell){
		Form.submitFrom(ref, function(code){
			$(ref).closest("form").find("textarea").css("min-height", "33px");
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			var id = "#"+$("#board-ie").data("ref_id");
			var header = getHeaderByRef(id);
			var row_id = $(id).closest(".super-row").data("id");
			var old_obj = ARR.findObj(SuperTable.cache.data, row_id);
			
			if (header && header.editable && AP.data.isFunction(header.editable) && old_obj){
				var temp_fx = header.editable(old_obj);
				if (temp_fx){
					temp_fx.success.apply(code, [header, $(id).closest(".super-cell-wrapper").find(".super-cell").first(), SuperTable.cache.data]);
				}
			}
			
			closeIE();
			
		});
	};
	
	
	function saveListItem(ref){
		var $box = $(ref).closest(".dd.scroll-y");
		if (!$box.length){
			return;
		}
		
		var value = "";
		if ($box.data("multiple")){
			$(ref).toggleClass("-selected");
			$box.find(".opt").each(function(){
				if ($(this).hasClass("-selected")){
					value+=","+$(this).data("value");
				}
			});
		}else{
			value = $(ref).data("value");	
		}
		
		$(ref).closest("form").find("input[name=value]").val(value);
		
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			var id = "#"+$("#board-ie").data("ref_id");
			var header = getHeaderByRef(id);
			var row_id = $(id).closest(".super-row").data("id");
			var old_obj = ARR.findObj(SuperTable.cache.data, row_id);
			
			if (header && header.editable && AP.data.isFunction(header.editable) && old_obj){
				var temp_fx = header.editable(old_obj);
				if (temp_fx){
					temp_fx.success.apply(code, [header, $(id).closest(".super-cell-wrapper").find(".super-cell").first(), SuperTable.cache.data]);
				}
			}
			
			if ($box.data("multiple")){
				
			}else{
				closeIE();	
			}
		});
	};
	
	
	
	this.update=function(obj){
	};
	
	
	function getPosition(e){
		var top=e.pageY;
		var left=e.pageX;
		
		return {top: top, left: left}
	};
	
	
	function activate(ref){
		var $cell=$(ref).closest(".super-cell-wrapper");
		var $row = $cell.closest(".super-row");
		$row.siblings().removeClass("-selected");
		$row.addClass("-selected");
		
		
		var cell_index = $cell.index();
		var $header_cell = $(ref).closest(".super-table").find(".thead").find(".th:nth-child("+(cell_index+1)+")");
		
		if (!$header_cell.length){
			return;
		}
		
		var key=$header_cell.data("id");
		var header = getHeader(key);
		
		var obj = ARR.findObj(SuperTable.cache.data, $row.data("id"));
		
		if (!header || !obj){
			return;
		}
		
		var computed = header.editable(obj);
		
		if (AP.data.isArray(computed)){
			return;
			
		}else if (computed.type == "select"){
			var value = computed.value;
			
			var select_options = computed.options;
			if (!select_options){
				select_options = header.options;
			}
			
			if (computed.empty){
				select_options = ARR.clone(select_options);
				select_options.push({id: "", name: "-- <i>"+(computed.empty)+"</i> --"});
			}
			
			var html=AP.render(select_options, function(e){
				var selected='';
				
				if (typeof value!='undefined'){
					if (computed.multiple){
						if (ARR.contain(value, e.id, function(v, eid){
							return AP.data.equal(v, eid);
						})){
							selected=' -selected';
						}
					}else{
						if (e.id==value || (AP.data.isInt(e.id) && AP.data.isInt(value) && parseInt(e.id)==parseInt(value))){
							selected=' -selected';
						}
					}
				}
				
				return "<div class='opt ap-xdot url "+(selected)+" "+(computed.multiple?'':'-singular')+"' title='"+(safe(e.name))+"' data-value='"+(e.id)+"' data-url='::super/table/inline-opt?multiple="+(computed.multiple?1:0)+"'>"+(e.name)+"</div>";
			});
			
			var id=$row.data("id");
			var submit_multi = '';
			
			if (computed.multiple){
				// submit_multi= "<span class='url' data-url='::super/table/inline-multi'>Cáº­p nháº­t</span> &middot; ";
			}
			
			html="<div class='dd scroll-y' data-col='"+(key)+"' data-row='"+(id)+"' data-multiple='"+(computed.multiple?1:0)+"'> <div class='ie-scroll-list'> "+(html)+" </div> </div> <div class='ie-footer'> "+(submit_multi)+" <span class='url' data-url='::super/table/inline-cancel'>ÄĂ³ng</span> </div>";
			
			var opts = {
				top: $row.position().top+$cell.height(),
				left: $cell.position().left+$cell.width()-180,
				html: html,
				items: header.options,
				ref: $(ref).data("ref"),
				position: {col: key, row: $row.data("id"), row_index: $row.index()},
				ref_id: $(ref).data("ref_id")
			};
			
			for (var tkey in computed){
				if (!(tkey in opts)){
					opts[tkey]=computed[tkey];
				}
			}
			
			showSelect(opts);
		}else{
			var w=$cell.width();
			if (w<200){
				w=200;
			}
			
			var opts={
				top: $row.position().top,
				left: $cell.position().left,
				width: w,
				ref: $(ref).data("ref"),
				placeholder: header.label||header.name,
				value: computed.value,
				data: computed.data,
				position: {col: key, row: $row.data("id"), row_index: $row.index()},
				ref_id: $(ref).attr("id")
			};
			
			var index = $row.index();
			
			for (var tkey in computed){
				if (!(tkey in opts)){
					opts[tkey]=computed[tkey];
				}
			}
			
			showInput(opts);
		}
	};
	
	
	function showSelect(opts){
		var top=opts.top;
		var left=opts.left;
		
		var html=opts.html;
		if (opts.options && opts.options.length>5){
			html="<div class='ie-filter'> " +Render.render('search', {filter: "#board-ie .opt" , placeholder: "Filter options" }, '')+ ''+html;
		}
		
		var data = '';
		if (opts.data){
			for (var key in opts.data){
				data+="<input type='hidden' name='"+(key)+"' value='"+(opts.data[key])+"'/>";
			}
		}
		
		html="<div class='dd-scrollbox'> <form method='POST' action='"+(opts.action)+"'> "+(html)+" <div class='hidden'> <input type='hidden' name='key' value='"+(opts.position.col)+"'/> <input type='hidden' name='value' value='"+(opts.value||'')+"'/> "+(data)+" </div> </form> </div>";
		
		$("#board-ie").html("<div class='ie' style='top:"+(top)+"px; left:"+(left)+"px'>"+(html)+"</div>").show().data("ref_id", opts.ref_id);
		makeVisible("#board-ie");
		Render.finish();
	};
	
	function showInput(opts){
		var top=opts.top;
		var left=opts.left;
		var data = '';
		if (opts.data){
			for (var key in opts.data){
				data+="<input type='hidden' name='"+(key)+"' value='"+(opts.data[key])+"'/>";
			}
		}
		
		var val = opts.value||'';
		
		if (val && opts.tag){
			var u = People.get(val);
			if (u && !u.error){
				val='@'+u.username;
			}
		}
		
		
		var html="<form method='POST' action='"+(opts.action)+"'> <div class='textarea'> <textarea placeholder='"+(opts.placeholder)+"' data-role='"+(opts.tag?'tag':'')+"' name='value' data-value='"+(val)+"' data-col='"+(opts.position.col)+"' data-row='"+(opts.position.row)+"'></textarea> </div> <div class='hidden'> <input type='hidden' name='key' value='"+(opts.position.col)+"'/> "+(data)+" </div> <div class='actions'> <div class='action js-ib save url' data-url='::super/table/inline-save'><span>&#10003;</span> LÆ°u</div> <div class='action js-ib cancel url' data-url='::super/table/inline-cancel'><span>&#10006;</span> Há»§y</div> </div> </form>";
		
		$("#board-ie").html("<div class='ie' style='top:"+(top)+"px; left:"+(left)+"px'><div class='ibox' style='width:"+(opts.width)+"px'>"+(html)+"</div></div>").show().data("ref_id", opts.ref_id);
		makeVisible("#board-ie");
		Form.render("#board-ie .textarea");
		
		$("#board-ie textarea").focus().val(val).enter(function(){
			SuperTable.inline.trigger("inline-save", this);
		});
	};
	
	
	
	
	function getHeader(key){
		return ARR.single(SuperTable.mdefs, function(e){
			return e.id == key;
		});
	};
	
	function getHeaderByRef(ref){
		var $cell=$(ref).closest(".super-cell-wrapper");
		var cell_index = $cell.index();
		var $header_cell = $(ref).closest(".super-table").find(".thead").find(".th:nth-child("+(cell_index+1)+")");
		
		if (!$header_cell.length){
			return;
		}
		
		var key=$header_cell.data("id");
		return getHeader(key);
	};
	
	
	function initContextMenu(canvas){
		$(canvas+" .tbody").on("contextmenu", function(e){
			if (e.ctrlKey){
				return;
			}
			
			e.preventDefault();
			
			var $row=$(e.target).closest(".js-row");
			var obj=AP.array.findObj(Board.table.opts.rows, $row.data("id"));
			
			if (obj){
				Board.context(obj, getPosition(e));	
			}
		});
	};
	
	
	function makeVisible(box){
		var $canvas = $(box).closest(".super-table-canvas");
		var $ie = $(box).find(".ie");
		var top = $ie.position().top;
		var height = $ie.find("form").height();
		var sh = $canvas.find(".super-table-wrapper")[0].scrollHeight;
		
		if (top + height > sh){
			top = sh - height;
			$ie.css({"top": top});
		}
		
		return;
	};
	
	
	function closeIE(){
		$("#board-ie").hide().data("ref_id", 0);
		$("#board-ie").closest(".super-table-canvas").find(".super-row").removeClass("-selected");
	};
	
};




// SELECTION
SuperTable.selection = new function __SuperTableSelection(){
	this.get = function(){
		var model = SuperTable.cache.model;
		var data = SuperTable.cache.data;
		
		var r = {
			model: model,
			ids: [],
			items: []
		};
		
		var $items = $("#"+model.canvas_id+" .super-row.-is-selected");
		$items.each(function(){
			var id = $(this).data("id");
			if (data){
				var obj = ARR.findObj(data, id);
				if (obj){
					r.items.push(obj);
				}
			}
			
			if (id){
				r.ids.push(id);	
			}
		});
		
		
		return r;
	};
	
	
	this.clicked = function(context, ref){
		var $row = $(ref).closest(".super-row");
		$row.toggleClass("-is-selected");
		
		// Get total counts
		var count = $row.closest(".tbody").find(".-is-selected").length;
		var model = SuperTable.cache.model;
		if (model && model.selection){
			var $button = $(model.selection);
			if ($button.length){
				if (count>0){
					$button.find('.-js-scount').html("<b>("+(count)+")</b>");
					$button.show();
				}else{
					$button.hide();
				}
			}
		}
	};
};


Rewrite.on("::super/{entity}/{action}", function(qs){
	if (qs.entity == "table"){
		
		if (qs.action=="inline-edit" || qs.action=="inline-save" || qs.action=="inline-cancel" || qs.action=="inline-opt"){
			return SuperTable.inline.trigger(qs.action, this, qs);
		}
		
		if (qs.action == "selected"){
			return SuperTable.selection.clicked(qs, this, qs);
		}
		
	}
});




var SuperEditor = new function __SuperEditor(){
	var __init = false;
	
	this.reset = function(){
		__init = false;
	};
	
	
	this.init = function($elem){
		SuperEditor.bindCommands($elem.find(".super-command"));
		$elem.find(".js-content").sortable({
			handle: ".ss-side",
			axis: 'y',
			containment: 'parent'
		});
	};
	
	/**
	 * @desc Get the content of the super editor, return a structure (block)
	 */
	this.getContent = function(elem){
		var blocks = [];
		$(elem).find(".se-section").each(function(){
			var id= $(this).data("id");
			var type = $(this).data("type");
			var value = $("*[name="+id+"]").val();
			blocks.push({
				type: type,
				value: value,
			});
		});
		
		return blocks;
	};
	
	
	this.bindCommands = function($elem){
		if (!__init){
			__init = true;
			buildCommands("#"+$elem.attr("id"));
		}
		
		var $input = $elem.find("input");
		
		$input.focus(function(){
			showCommands("#"+$elem.attr("id"));
		}).blur(function(){
			$(this).addClass("-blur");
			setTimeout(function(){
				hideCommands();
			}, 200);
		}).on("input", function(){
			var val = $(this).val();
			if (!val || !val.length){
				$("#js-se-fcommands .se-commands .se-command").show();
			}else{
				$("#js-se-fcommands .se-commands .se-command").each(function(){
					var txt = $(this).text();
					if (AP.word.fulltextMatch(txt, val)){
						$(this).show();
					}else{
						$(this).hide();
					}
				});
			}
		});
		
		$input.updown('#js-se-fcommands .se-commands .se-command', function(ref, index){
			$("#js-se-fcommands").trigger("commanded", $(ref).data("command"));
			$(this).val("");
		});
	};
	
	
	this.addSection = function(command, elem){
		var $canvas = $(elem).closest(".super-editor");
		var sid = AP.uuid();
		
		if (command == 'editor'){
			$canvas.find(".js-content").append("  " +Render.render('super_editor_section', {id:sid, type: "editor" , label: "ED" , icon: "se_editor" }, '' +Render.render('form_input', {_name:sid, height: "300" , placeholder: "Type here" , editor:1, autogrow:1}, '')+ '')+ '');
			
			$("#"+sid).find(".ql-editor").focus();
			return;
		}
		
		if (command == 'markdown'){
			$canvas.find(".js-content").append("  " +Render.render('super_editor_section', {id:sid, type: "markdown" , label: "MD" , icon: "se_markdown" }, '' +Render.render('form_input', {_name:sid, height: "300" , placeholder: "Type here" , markdown:1, autofocus:1}, '')+ '')+ '');
			
			return;
		}
	};
	
	
	
	
	
	function buildCommands(id){
		if ($("#js-se-fcommands").length){
			$("#js-se-fcommands").remove();	
		}
		
		var html = "<div id='js-se-fcommands' class='super-editor-float-commands'><div class='se-commands scroll-y forced-scroll'> " +Render.render('super_editor_command_opt', {command: "editor" , _name: "Editor block" , desc: "Standard text with editor" , icon: "se_editor" }, '')+ " " +Render.render('super_editor_command_opt', {command: "markdown" , _name: "Markdown" , desc: "Create a markdown block" , icon: "se_markdown" }, '')+ " " +Render.render('super_editor_command_opt', {command: "filebox" , _name: "Photo collection" , desc: "Photo collections" , icon: "se_photos" }, '')+ " " +Render.render('super_editor_command_opt', {command: "filebox" , _name: "File collection" , desc: "Create a collection of files" , icon: "se_files" }, '')+ " " +Render.render('super_editor_command_opt', {command: "base-uikit" , _name: "Base UIkit def" , desc: "Create a UI kit definition" , icon: "se_embed" }, '')+ " " +Render.render('super_editor_command_opt', {command: "base-ba" , _name: "Base BA feature" , desc: "Create a UI kit definition" , icon: "se_embed" }, '')+ " " +Render.render('super_editor_command_opt', {command: "embed-doc" , _name: "Embeded doc" , desc: "Embedded another document" , icon: "se_embed" }, '')+ " " +Render.render('super_editor_command_opt', {command: "embed-wework" , _name: "Embeded project" , desc: "Embedded another project" , icon: "se_embed" }, '')+ "</div> </div>";
		
		$(html).appendTo(document.body);
		alignTo(id);
		
		$("#js-se-fcommands").on("commanded", function(event, command){
			hideCommands();
			
			var _that = $(this);
			setTimeout(function(){
				SuperEditor.addSection(command, _that.data("bind_to"));
			});
		})
	};
	
	
	function hideCommands(){
		$("#js-se-fcommands").hide();
	};
	
	
	function showCommands(bind_to){
		$("#js-se-fcommands").show();
		$("#js-se-fcommands").data("bind_to", bind_to).removeClass("-blur");
		
		alignTo(bind_to);
	};
	
	
	function alignTo(id){
		var top = $(id).offset().top+$(id).height()+5;
		if (top + $("#js-se-fcommands").height() > $(window).height()){
			top = top - $(id).height() - $("#js-se-fcommands").height()-25; 
		}
		
		$("#js-se-fcommands").css("left", $(id).offset().left);
		$("#js-se-fcommands").css("top", top);
	};
};

AP.sys.on(AP.EVENTS.PAGE.AFTERLOAD, function(){
	SuperEditor.reset();
});


SVG.extends({
	se_editor: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48' width='48px' height='48px'><path d='M 13.5 10 A 1.50015 1.50015 0 1 0 13.5 13 L 42.5 13 A 1.50015 1.50015 0 1 0 42.5 10 L 13.5 10 z M 5.5 23 A 1.50015 1.50015 0 1 0 5.5 26 L 42.5 26 A 1.50015 1.50015 0 1 0 42.5 23 L 5.5 23 z M 20.5 36 A 1.50015 1.50015 0 1 0 20.5 39 L 41.5 39 A 1.50015 1.50015 0 1 0 41.5 36 L 20.5 36 z'/></svg>",
	se_markdown: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 12 3 L 10 21 L 12 21 L 14 3 L 12 3 z M 5.7070312 6.2929688 L 0 12 L 5.7070312 17.707031 L 7.1210938 16.292969 L 2.828125 12 L 7.1210938 7.7070312 L 5.7070312 6.2929688 z M 18.292969 6.2929688 L 16.878906 7.7070312 L 21.171875 12 L 16.878906 16.292969 L 18.292969 17.707031 L 24 12 L 18.292969 6.2929688 z'/></svg>",
	se_photos: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 3 3 C 1.9069372 3 1 3.9069372 1 5 L 1 15 C 1 16.093063 1.9069372 17 3 17 L 16 17 C 17.093063 17 18 16.093063 18 15 L 18 5 C 18 3.9069372 17.093063 3 16 3 L 3 3 z M 3 5 L 16 5 L 16 15 L 3 15 L 3 5 z M 20 7 L 20 19 L 5 19 L 5 21 L 20 21 C 21.093063 21 22 20.093063 22 19 L 22 7 L 20 7 z M 11.556641 8.3320312 L 8.7617188 11.982422 L 6.7265625 9.5332031 L 4 13 L 15 13 L 11.556641 8.3320312 z'/></svg>",
	se_files: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 5 1 C 3.9 1 3 1.9 3 3 L 3 17 L 5 17 L 5 3 L 17 3 L 17 1 L 5 1 z M 9 5 C 7.9 5 7 5.9 7 7 L 7 21 C 7 22.1 7.9 23 9 23 L 20 23 C 21.1 23 22 22.1 22 21 L 22 10 L 17 5 L 9 5 z M 9 7 L 16 7 L 16 11 L 20 11 L 20 21 L 9 21 L 9 7 z M 11 13 L 11 15 L 18 15 L 18 13 L 11 13 z M 11 17 L 11 19 L 18 19 L 18 17 L 11 17 z'/></svg>",
	se_embed: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24px' height='24px'><path d='M 5 3 L 5 5 L 20 5 L 20 17 L 22 17 L 22 5 C 22 3.9069372 21.093063 3 20 3 L 5 3 z M 3 7 C 1.9069372 7 1 7.9069372 1 9 L 1 19 C 1 20.093063 1.9069372 21 3 21 L 16 21 C 17.093063 21 18 20.093063 18 19 L 18 9 C 18 7.9069372 17.093063 7 16 7 L 3 7 z M 3 9 L 16 9 L 16 19 L 3 19 L 3 9 z'/></svg>",
})


Render.on("super-editor", function(){
	return "<div class='super-editor' "+(this.show('id'))+"> <div class='js-content'></div> " +Render.render('super_editor_command', {placeholder: "Type to create a block" }, '')+ " " +Render.render('sep', {value: 150}, '')+ "</div>";
}, function(params){
	SuperEditor.init($(this), params);
	$(this).clickOut(function(){
		$(".-x-focus").removeClass("-x-focus");
	});
});


Render.on("super-editor-command", function(){
	return "<div class='super-command' "+(this.show('id'))+"'> <input placeholder='"+(this.placeholder)+"' type='text'/> </div>";
});


Render.on("super-editor-command-opt", function(){
	return "<div class='se-command' data-command='"+(this.command)+"'> " +Render.render('icon', {icon:this.icon||'form_edit', size: "24" }, '')+ "<div class='seco-title'>"+(this._name)+"</div> <div class='seco-desc'>"+(this.desc)+"</div> </div>";
});


Render.on("super-editor-section", function(){
	return "<div class='se-section' data-type='"+(this.type)+"' data-id='"+(this.id)+"' id='"+(this.id)+"'> <div class='-se-wrapper'> <div class='ss-header'> <div class='ss-type'><em class='url' data-url=':collapse/4'>"+(this.type)+"</em></div> " +Render.render('button_dd', {sm:1, dd:1}, '' +Render.render('cmenu', {sm:1}, '' +Render.render('cmenu_item', {label: "Remove block" , url: ":super-editor/remove-block" }, '')+ " " +Render.render('cmenu_item', {label: "Show / hide" , url: ":collapse/6" }, '')+ '')+ '')+ "</div> <div class='ss-side'> " +Render.render('icon', {icon:this.icon, tt:this.type, url: ":collapse/3" }, '')+ "<div class='c url' title='Show / hide' data-url=':collapse/3'></div> </div> <div class='ss-content'>"+(this.content)+"</div> </div> </div>";
});




Render.ui.pickLabel = new function __RenderUIPickLabel(){
	
	this.itemPicked = function(ref){
		var r = getValue(ref);
		$(ref).closest(".pick-labels").trigger("pick-change", [r]);
	};
	
	
	this.picked = function(ref){
		var r = getValue(ref);
		$(ref).closest(".pick-labels").trigger("picked", [r]);
	};
	
	
	function getValue(ref){
		var $items = $(ref).closest(".pick-labels");
		var r = [];
		
		$items.find(".pl-item").each(function(){
			if ($(this).hasClass("-picked")){
				r.push($(this).data("value"));
			}
		});
		
		return r;
	};
};


Render.on("picked-labels", function(){
	var input = '';
	if (this._name){
		input = "<input type='hidden' name='"+(this._name)+"' />";
	}
	
	var values = '';
	var values_text = '';
	var that = this;
	
	if (this.value){
		values = AP.render(this.value, function(e){
			var obj = ARR.findObj(that.options, e);
			if (!obj){
				return "";
			}
			
			values_text+=obj.id+", ";
			return "  " +Render.render('tag', {color:obj.color, sm:1}, ""+(obj.name)+"")+ '';
		});
		
		if (input){
			input = "<input type='hidden' name='"+(this._name)+"' value='"+(values_text)+"'/>";
		}
	}
	
	if (!values){
		values = "<div class='-ph'>"+(this.placeholder||'')+"</div>";
	}
	
	return "<div "+(this.showURL())+" class='picked-labels "+(this.get('class'))+"'> "+(input)+" <div class='-value'>"+(values)+"</div> </div>";
});


Render.on("pick-labels", function(){
	var items = AP.render(this.options, function(e){
		return "<div class='pl-item' data-value='"+(e.id||e.value)+"'> " +Render.render('tag', {color:e.color, sm:1}, ""+(e.name)+"")+ "</div>";
	});
	
	return "<div class='pick-labels picker-box unselectable' "+(this.show('id'))+"> <div class='pick-header'> <div class='ph-title'>Pick labels</div> <div class='ph-done js-done'>OK</div> </div> <div class='pl-items'>"+(items)+"</div> </div>";
	
}, function(params){
	if (params.inline){
		$(this).css("width", $(this).parent().width()+"px").addClass("-inline-style");
	}
	
	$(this).find(".pl-items").on("click", ".pl-item", function(){
		$(this).toggleClass("-picked");
		Render.ui.pickLabel.itemPicked(this);
	});
	
	$(this).find(".js-done").on("click", function(){
		Render.ui.pickLabel.picked(this);
	});
	
});










Render.on("code", function(){
	var content = this.content;
	if (this.encoded){
		content = Base64.decode(content);
	}
	return "<div class='base-code-hl language-html "+(this.get('class'))+"' "+(this.show('id'))+">"+(Render.helper.escape(content))+"</div>";
}, {
	done: function(){
		Render.helper.showCode(this);
	}
});



Render.on("json", function(){
	return "<div class='base-flatten-json'> <div class='-wrapper'> <div class='title'>"+(this.title||this.label)+"</div> <div class='content'> <pre>"+(JSON.stringify(this.obj, null, 2))+"</pre> </div> </div> </div>";
});


Render.on("user", function(){
	var user = this.user;
	
	if (!user){
		user = People.get(this.user_id);
	}
	
	if (user.error && this.inline){
		if (this.user_id && AP.data.isInt(this.user_id)){
			return "  " +Render.render('none', {inline:1}, ""+(this.es||'--')+"")+ '';
		}else{
			return "  " +Render.render('none', {inline:1}, ""+(this.es||'--')+"")+ '';			
		}
	}
	
	if (this.inline){
		return "<span class='url' data-username='"+(user.username)+"'>"+(user.name)+"</span>";
	}
	
	this.addSizingClass();

	if (this.compact){
		this.addClass("-compact");
	}
	
	if (this.focus){
		this.addClass("-focus");
	}
	
	var tc=(this.tc||this.fit)?'ap-xdot':'';
	if (this.no_avatar){
		this.addClass("-no-avatar");
	}
	
	var name = user.name;
	if (this.first_name || this.first_name_only){
		name= user.first_name;
	}else if (this.name_only){
		name= user.name;
		return "<span class='js-user base-user-no url "+(this.get('class'))+"' data-username='"+(user.username)+"'>"+(name)+"</span>";
	}
	
	var content="<div class='base-user-avatar'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> <div class='base-user-name "+(tc)+"'>"+(name)+"</div> <div class='base-user-info "+(tc)+"'>"+(user.title)+"&nbsp;</div>";

	
	if (this.url){
		return "<div class='base-user url' data-url='"+(this.url)+"'> "+(content)+" </div>";
	}
	
	return "<div class='base-user url "+(this.get('class'))+"' data-username='"+(user.username)+"'> "+(content)+" </div>";
});


Render.on("users", function(){
	var action_manager;
	var that = this;
	
	if (this.action_manager || this.am){
		action_manager= Render.helper.getFunction(this.action_manager||this.am);
	}
	
	var d_count = 0;
	
	if (this.employees && AP.data.isArray(this.employees)){
		var html = AP.render(this.employees, function(emp){
			var opts=null;
			if (action_manager){
				opts=action_manager(emp, that);
			}else{
				var am = new ActionManager();
				
				if (emp.user){
					am.add("User profile", "::base/user?username="+(emp.user.username)+"");	
				}
				
				if (Client.base && Client.base.app == "hrm"){
					am.add("View employee profile", ":employee/"+(emp.id)+"/show");
				}
				
				opts = am;
			}
			
			return "  " +Render.render('list_item', {avatar:AP.thumb(emp.avatar)}, '' +Render.render('title', {url: ":employee/"+(emp.id)+"/show" , thick:1}, ""+(emp.name)+"")+ " " +Render.render('info', {}, ""+(emp.code)+" &middot; "+(emp.title||'No title')+"")+ " " +Render.render('side', {}, '' +Render.render('button_dd', {}, '' +Render.render('cmenu', {options:opts}, '')+ '')+ '')+ '')+ '';
		
		});
	}else{
		var names_only = '';
		var _render = null;
		
		if (this.render){
			if (AP.data.isFunction(this.render)){
				_render = this.render;
			}else{
				_render = Render.def(this.render)||null;
			}
		}
		
		var html = AP.render(this.users, function(username){
			var _content = "";
			var u = username;
			
			if (_render){
				return _render(u);
			}else{
				if (AP.data.isString(username) || AP.data.isInt(username)){
					u = People.get(username);	
				}
				
				if (!u || u.error){
					if (that.hide_deactivated){
						d_count++;
						return '';
					}
				}
				
				var opts=null;
				if (action_manager){
					opts=action_manager(u, that);
				}else{
					var am = new ActionManager();
					am.add("User profile", "::base/user?username="+(u.username)+"");
					if (Client.base && Client.base.app == "hrm"){
						var emp = Employee.getByUserID(u.id) || {};
						am.add("View employee profile", ":employee/"+(emp.id)+"/show");
					}
					
					opts = am;
				}
				
				if (that.names_only || that.name_only){
					names_only += ", <span class='url' data-username='"+(u.username)+"'>"+(u.name)+"</span>";
				}
				
				_content = "  " +Render.render('title', {}, '' +Render.render('url', {username:u.username}, ""+(u.name)+"")+ '')+ " " +Render.render('info', {}, ""+(u.title||'No title')+"")+ " " +Render.render('side', {}, '' +Render.render('button_dd', {}, '' +Render.render('cmenu', {options:opts}, '')+ '')+ '')+ '';
			}
			
			
			return "  " +Render.render('list_item', {avatar:AP.thumb(u.gavatar)}, ""+(_content)+"")+ '';
		});
		
		if (that.names_only){
			if (names_only && names_only.length){
				names_only = names_only.substr(2);
			}else{
				names_only = "<span class='non-one'>no one</span>";
			}
			
			return "<span class='base-users-names-only'>"+(names_only)+"</span>";
		}
	}
	
	
	var d_html = '';
	if (d_count){
		if (d_count>1){
			d_html = "<div class='d-count'>"+(d_count)+" deactivated users are hidden</div>";
		}else{
			d_html = "<div class='d-count'>"+(d_count)+" deactivated user is hidden</div>";	
		}
		
	}
	
	if (this.dialog){		
		html = "<div class='base-users "+(this.get('class'))+"' "+(this.show('id'))+"> " +Render.render('list', {borderless:1}, ""+(html)+"")+ "</div>";
		return "  " +Render.render('dialog', {width: "500" , title:this.title, id:this.id}, ""+(html)+"")+ '';
	}else{
		return "<div class='base-users "+(this.get('class'))+"' "+(this.show('id'))+"> " +Render.render('list', {borderless:this.borderless}, ""+(html)+"")+ ""+(d_html)+"</div>";
	}
	
	
}, {
	done: function(params){
		if (params.limit){
			$(this).find(".base-list").shortlist({
				max: params.limit
			});
		}
	}
});




Render.on("u2u", function(){
	
	var f = this.from_id || this.from;
	var t = this.to_id || this.to;
	
	if (AP.data.isInt(f) || AP.data.isString(f)){
		f = People.get(f);
	}
	
	if (AP.data.isInt(t) || AP.data.isString(t)){
		t = People.get(t);
	}
	
	if (!f){
		f= {};
	}
	
	if (!t){
		t= {};
	}
	
	return "<div class='base-u2u'><div class='-bu-inner'> <div class='base-u base-u1 url' data-username='"+(f.username)+"'> " +Render.render('avatar', {user:f, sm:1}, '')+ "<div class='uname'>"+(f.first_name)+"</div> </div> <div class='base-u base-u2 url' data-username='"+(f.username)+"'> " +Render.render('avatar', {user:t, sm:1}, '')+ "<div class='uname'>"+(t.first_name)+"</div> </div> </div></div>";
	
});


Render.on("user-groups", function(){
	if (!this.groups || !this.groups.length){
		return "<div class='base-user-groups'> " +Render.render('none', {}, ""+(this.es||'No group')+"")+ "</div>";	
	}
	
	var gs = AP.render(this.groups, function(e){
		var g = UserGroup.get(e);
		if (!g){
			return '';
		}
		
		return "  " +Render.render('tag', {title: "User group" , edge:1}, ""+(g.name)+"")+ '';
	});
	
	return "<div class='base-user-groups'> " +Render.render('tags', {}, ""+(gs)+"")+ "</div>";
});


Render.on("user-add", function(){
	return "<div class='base-user-add url' data-url='"+(this.url)+"'> <div class='ua-icon'> <span class='ap icon-plus2'></span> </div> <div class='ua-label'>"+(this.title||this.label)+"</div> </div>";
});




Render.on("faces", function(){
	var content = '';
	if (this.users){
		content = AP.render(this.users, function(e){
			return "  " +Render.render('face', {src:AP.thumb(e.gavatar), url: '' }, '' +Render.render('title', {}, ""+(e.name)+"")+ " " +Render.render('info', {}, ""+(e.title||'No title')+"")+ '')+ '';
		});
	}
	
	if (this.employees){
		content = AP.render(this.employees, function(e){
			return "  " +Render.render('face', {src:AP.thumb(e.avatar), url: ":employee/"+(e.id)+"/show" }, '' +Render.render('title', {}, ""+(e.name)+"")+ " " +Render.render('info', {}, ""+(e.title||'No title')+"")+ '')+ '';
		});
	}
	
	this.col = this.col||5;
	
	return "<div class='base-faces -cols-"+(this.col)+"' "+(this.show('id'))+"> <div class='base-faces-inner clear-fix'> "+(content)+" "+(this.content)+" </div> </div>";
}, {
	done: function(params){
		if (params.limit){
			$("#"+params.id+" .base-faces-inner").shortlist({
				max: params.limit
			});
		}
	}
});


Render.on("face", function(){
	return "<div class='base-face url' data-url='"+(this.url)+"'> <div class='image'><div class='imgw'> <div class='img'><img src='"+(this.src)+"'></div> </div></div> <div class='face-content'> "+(this.content)+" </div> </div>";
});


Render.on("comment", function(){
	if (this.dark){
		this.addClass("-darkmode");
	}
	
	if (this.disabled && parseInt(this.disabled)){
		return "<div class='base-comments-area -disabled "+(this.get('class'))+" -disabled' "+(this.show('id'))+"> <div class='box comments'> <div class='disabled'> <div class='inner'> " +Render.render('icon', {icon: "base_lock" }, '')+ "Comment is disabled </div> </div> </div> </div>";
	}
	
	return "<div class='base-comments-area "+(this.get('class'))+"' "+(this.show('id'))+">"+(this.content)+"</div>";
}, {
	done: function(opts, obj){
		// INIT COMMENT
		
		if (opts.disabled && parseInt(opts.disabled)){
			return;
		}
		
		if (obj.obj){
			Comment.v2({
				canvas: "#"+opts.id,
				origin: {hid: obj.obj.hid, token: obj.obj.token, stats: obj.obj.stats},
				header: opts.with_comment||false,
				form: this.form||"top",
				coc: opts.coc,
				placeholder: opts.placeholder||"Viáº¿t bĂ¬nh luáº­n cá»§a báº¡n",
				preload: obj.preload||null
			});
			
			return;
		}
		
		Comment.v2({
			canvas: "#"+opts.id,
			origin: {hid: opts.hid, token: opts.token},
			header: opts.with_comment||false,
			form: "top",
			coc: opts.coc,
			placeholder: opts.placeholder||"Viáº¿t bĂ¬nh luáº­n cá»§a báº¡n"
		});
	}
});









Render.on("post", function(){
	if (this.dark){
		this.addClass("-dark");
	}
	
	return "<div class='base-posts js-base-posts "+(this.get('class'))+"' "+(this.show('id'))+">"+(this.content)+"</div>";
}, {
	done: function(opts, obj){
		// INIT POST
		
		if (obj.obj){
			Post.auto("#"+opts.id, obj.obj, {poll: 0, layout: "modern", dark: this.dark?parseInt(this.darl):0});
			return;
		}
		
	}
});






Render.helper._calendarInit = function(obj, render_engine){
	var dates=["Thá»© 2", "Thá»© 3", "Thá»© 4", "Thá»© 5", "Thá»© 6", "Thá»© 7", "Chá»§ nháº­t"];
	var sdates=["M", "T", "W", "T", "F", "S", "S"];
	
	var ts = obj.ts;
	
	ts = AP.time.beginOfMonth(parseInt(ts));
	
	var start = AP.time.beginOfWeek(ts);
	var end = AP.time.beginOfWeek(AP.time.endOfMonth(ts));
	
	var bom=AP.time.beginOfMonth(ts);
	var eom=AP.time.endOfMonth(ts);
	
	start = AP.time.beginOfDay(start);
	end = AP.time.beginOfDay(end);
	
	var num_weeks = (end-start)/(7*24*3600)+1;
	
	var html='';
	var wh = 100/num_weeks;
	
	
	for (var i=0; i<num_weeks; i++){
		var week_html='';
		for (var j=0; j<7; j++){
			var temp = start+i*7*24*3600+j*24*3600;
			var dow=AP.time.time('%D', temp);
			
			var ec = [];
			if (temp<bom){
				ec.push("-past-month");
			}else if (temp > eom){
				ec.push("-next-month");
			}else{
				ec.push("-current-month");
			}
			
			
			if (temp == AP.time.beginOfDay(AP.time.now())){
				ec.push("-is-today");
			}
			
			
			var d = AP.time.time('%d/%m', temp);
			if (obj.compact){
				d = AP.time.time('%d', temp);
			}
			
			var _html = '';
			var _r = render_engine(temp);
			
			if (AP.data.isObject(_r)){
				_html = _r.html;
				ec.push(_r.style);
			}else{
				_html = _r;
			}
			
			ec=ec.join(' ');
			
			week_html+="<div class='date -"+(dow.toLowerCase())+" "+(ec)+"'> <div class='date-label'><span>"+(d)+"</span></div> <div class='inner js-ts-"+(temp)+"'>"+(_html)+"</div> </div>";
		}
		
		week_html="<div class='week clear-fix'>"+(week_html)+"</div>";
		html+=week_html;
	}
	
	var headers = AP.render(range(0,6), function(i){
		var d = dates[i];
		if (obj.compact){
			d = sdates[i];
		}
		
		return "<div class='date'><div class='-txt'>"+(d)+"</div></div>";
	});
	
	var caption = "<div class='txt'>"+(AP.time.time('%m/%Y', ts))+"</div> " +Render.render('side', {}, '' +Render.render('button', {icon: "ap chevron-left22" , label: "TrÆ°á»›c" , urlparam: "ts" , value:bom-24*3600}, '')+ " " +Render.render('button', {url: ":xrefresh" }, ""+(AP.time.time('%m/%Y', ts))+"")+ " " +Render.render('button', {right_icon: "ap chevron-right22" , label: "Sau" , urlparam: "ts" , value:eom+24*3600}, '')+ '')+ "";
	
	if (obj.compact){
		caption = "<div class='txt center'>"+(AP.time.time('%m/%Y', ts))+"</div> " +Render.render('icon', {icon: "ap chevron-left22" , urlparam: "ts" , value:bom-24*3600, _class: "nav left" , icon_only:1, sm:1, borderless:1}, '')+ " " +Render.render('icon', {icon: "ap chevron-right22" , urlparam: "ts" , value:eom+24*3600, _class: "nav right" , icon_only:1, sm:1, borderless:1}, '')+ "";
	}
	 
	html = "<div class='cal-caption "+(obj.compact?' -compact':'')+"'>"+(caption)+"</div> <div class='cal-wrapper'> <div class='cal-header'>"+(headers)+"</div> <div class='cal-body'>"+(html)+"</div> <div class='cal-footer'></div> </div>";
	
	return html;
};



Render.on("monthly-calendar", function(){
	var html=  Render.helper._calendarInit(this, Render.helper.getFunction(this.render));
	if (this.compact){
		this.addClass("-compact");
	}
	
	return "<div class='base-monthly-calendar "+(this.get('class'))+"' "+(this.show('id'))+">"+(html)+"</div>";
}, function(params, obj){
	if (params.fit){
		$(this).addClass("-abs-fit").css({position: "absolute"});
		
		$(this).find(".cal-wrapper").css({
			position: "absolute",
			top: $(this).find(".cal-caption").outerHeight(),
			left: 0,
			right: 0,
			bottom: 0
		});
		
		$(this).find(".cal-body").css({
			position: "absolute",
			top: $(this).find(".cal-header").height(),
			left: 0,
			right: 0,
			bottom: 0
		});
		
		var nw = $(this).find(".cal-body .week").length;
		var h = 100.0/nw;
		
		$(this).find(".cal-body .week").css({
			height: h+"%"
		});
	}
});


Render.on("files", function(){
	var cx = this.get('class');
	if (!this.files || !this.files.length){
		this.addClass("-no-files");
	}
	
	if (this.inline){
		return "<div class='base-files-inline "+(this.get('class'))+"'>"+(UI.file.listCompact(this.files))+"</div>";
	}else{
		if (!this.files || !this.files.length){
			return "<div class='base-list-files -empty'> " +Render.render('empty', {icon: "document" , sm:1}, ""+(this.es||'KhĂ´ng cĂ³ file Ä‘á»ƒ hiá»ƒn thá»‹')+"")+ "</div>";
		}
		
		var that = this;
		var action_manager=null;
		if (this.action_manager){
			action_manager= Render.helper.getFunction(this.action_manager);
		}
		
		if (this.list){
			var files=AP.render(this.files, function(e){
				return Render.helper.getFile(e, action_manager, that);
			});
			
			return "  " +Render.render('list', {_class: "base-list-files "+(cx)+"" , style:this.style, borderless:this.borderless||''}, ""+(files)+"")+ '';	
		}
		
		
		var files=AP.render(this.files, function(e){
			return Render.helper.getEmbededFile(e, action_manager, that);
		});
	
		return "<div class='base-files display-files "+(cx)+"' "+(this.css())+">"+(files)+"</div>";
	}
});


Render.on("file-preview", function(){
	if (mobile()){
		return "<div class='file-preview-mobile url' data-url=':file' data-file='"+(this.file.url)+"'> " +Render.render('icon', {icon: "ap attach_file" }, '')+ "<div class='-label'>Click to preview this file</div> </div>";
	}
	
	return Base.file.getHTML(this.file.url);
});


Render.helper.getFile = function(e, action_manager, comp){
	var doc = {};
	var opts_html='';
	
	if (action_manager){
		opts=action_manager(e, comp);
		if (opts && AP.data.isObject(opts) && !AP.data.isArray(opts)){
			opts_html = opts.inline();
		}
	}
	
	var ficon = UI.file.icon(e.fid); 
	var extra = '';
	if (e.drive && parseInt(e.drive)){
		extra=' &middot; Base drive';
	}
	
	return "  " +Render.render('list_item', {avatar:1}, "<div class='base-icon' style='left:4px; top:12px'><img src='"+(Client.share_url)+"/m4/"+(ficon)+".svg' style='width:32px; height:32px'/></div> " +Render.render('title', {style: "margin-right:16px" }, "<span class='url' data-url=':file' data-file='"+(e.url)+"'>"+(e.name)+"</span>")+ " " +Render.render('info', {}, ""+(UI.file.kb(e.size))+" &middot; " +Render.render('text_datetime', {}, ""+(e.since)+"")+ ""+(extra)+"")+ " " +Render.render('side', {}, '' +Render.render('action', {dd:1}, '' +Render.render('cmenu', {}, '' +Render.render('cmenu_item', {url:Base.file.download(e.name, e.fid)}, "Download")+ " " +Render.render('cmenu_item', {url: ":file" , data_file:e.url}, "Xem trĂªn há»™p thoáº¡i má»›i")+ ""+(opts_html)+"")+ '')+ '')+ '')+ '';
};




Render.helper.getEmbededFile = function(e, action_manager, comp){
	var doc = {};
	var opts_html='';
	
	if (action_manager){
		opts=action_manager(e, comp);
		if (opts && AP.data.isObject(opts) && !AP.data.isArray(opts)){
			opts_html = opts.inline();
		}
	}
	
	return "<div class='file'> <div class='fileheader'> <div class='name'>"+(e.name)+"</div> <div class='info'>"+(UI.file.kb(e.size))+" &middot; @"+(e.username)+"</div> " +Render.render('actions', {}, '' +Render.render('action', {url:Base.file.download(e.name, e.fid)}, "Download")+ " " +Render.render('action', {more:1}, '' +Render.render('cmenu', {}, '' +Render.render('cmenu_item', {url:Base.file.download(e.name, e.fid)}, "Download")+ " " +Render.render('cmenu_item', {url: ":file" , data_file:e.url}, "View in popup")+ ""+(opts_html)+"")+ '')+ '')+ "</div> <div class='filedisplay'>"+(Base.file.getHTML(e.url))+"</div> </div>";
};



   
Render.on("followers", function(){
	this.layout = this.layout || "list";
	
	if (this.compact){
		this.addClass("-compact");
		this.layout = "compact";
	}
	
	if (this.inline){
		this.addClass("-inline");
		this.layout = "inline";
	}
	
	if (this.dark){
		this.addClass("-darkmode");
	}
	
	var html = Follow.html({
		click: true,
		followers: this.obj.followers,
		admin: this.admin?1:0,
		users: Client.people,
		endpoint: this.endpoint||this.action||'api/follow',
		data:{
			obj_id: this.obj.id,
			obj_token: this.obj.token,
			obj_type: this.obj.type,
		},
		style: this.layout,
		icon: this.icon||''
	});
	
	var opts = {
		style: this.layout,
		data: {obj_id: this.obj.id, obj_type: this.obj.type, obj_token: this.obj.token},
		endpoint: this.endpoint||this.action||'api/follow',
		admin: this.admin?1:0,
		icon: this.icon||''
	};
	
	var encoded_opts = JSON.stringify(opts);
	if (this.icon){
		this.addClass('-with-icon');
	}
	
	return "<div class='base-followers jsapi-follow "+(this.get('class'))+"' data-opts='"+(encoded_opts)+"' "+(this.show('id'))+">"+(html)+"</div>";
	
}, {
	done: function(params){
		if (params.admin){
			$("#"+this.id).find(".js-user").each(function(){
				$(this).data("context.items", [{label: "Remove follower", icon:"blocked", username: $(this).data("username"), action: function(opt, ref){
					Follow.setUnfollow(opt.username, this);
				}}]);
			});
		}
	}
});


Render.on("dialog", function(){
	var header = '';
	if (this.title){
		header = "<div class='bd-header "+((this.title_fill||this.fill_title)?' -fill':'')+"'> <div class='bd-title'>"+(this.title)+"</div> <div class='bd-close' onclick=\"AP.hideCustomDialog('#"+(this.id)+"', true)\"><span class='-ap icon-close'></span></div> </div>";
	}
	
	if (this.gray){
		this.addClass('-gray');
	}
	
	if (this.fit){
		this.addClass("-fit");
	}
	
	var w = this.width||800;
	
	if (mobile()){
		var mw = $(window).width();
		if (w>mw){
			w = mw;
		}
	}
	
	var content = "<div class='baseui-dialog "+(this.get('class'))+"' style='width:"+(w)+"px'> "+(header)+" <div class='bd-body js-dx-body'>"+(this.content)+"</div> </base-dialog>";
	
	if (mobile()){
		this.addClass("-is-mobile");
	}
	
	AP.customDialog(content, {
		id: this.id,
		closable: false,
		fs: 1
	}).addClass("-baseui-fit").addClass(this.get('class')).show();
	
	
	var id = this.id;
	setTimeout(function(){
		AP.balanceDialog(id);
	});
	
	return "";
});


Render.on("task", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	return "<div class='base-task-comp' "+(this.show('id'))+"><div class='base-task-area'>"+(this.content)+"</div></div>";
}, {
	done: function(params, obj){		
		// INIT COMMENT
		Base.task.embed(obj.obj, {
			canvas: "#"+params.id+" .base-task-area",
			header: false
		});
	}
});


// FIXED

AP.gb.register(function(){
	Render.esign.signAllCallback(null);
});


Render.esign = new function __RenderEsign(){
	var __callback;
	var __requests;
	var __cached_origin;
	
	var office_doctypes, office_storages, office_offices; 
	var office_inited = false;
	
	
	/**
	 * @desc Propose signing a file
	 */
	this.propose = function(obj, ref, callback){
		var rows = [
			{label: "Chá»n file *", type: "file", name: "file", extra: "Cháº¥p nháº­n Ä‘á»‹nh dáº¡ng: PDF, DocX"},
			{label: "TrĂ¬nh kĂ½ Ä‘áº¿n (chá»n thĂ nh viĂªn) *", placeholder: "GĂµ @ Ä‘á»ƒ tag", name: "signers", role: "tag"},
			
			{placeholder: "Request counter and storage (Base Office)", type: "checkbox", name: "office"},
			
			{label: "Document type *", name: "doctype_id", type: "select", options: []},
			
			[
				{label: "Storage *", name: "storage_id", type: "select", options: []},
				{label: "Book *", name: "book_id", type: "select", options: []},
			]
		];
		
		
		Form.v2({
			title: "TrĂ¬nh kĂ½ vÄƒn báº£n má»›i",
			action: "api/esign/request",
			data: {id: obj.obj.id, hid: obj.obj.hid, token: obj.obj.token},
			rows: rows,
			buttons: Form.button(":submit").button(":cancel"),
			
			render: function(){
				signRender(this);
			}
		});
	};
	
	
	
	/**
	 * @desc Submitting esign data
	 */
	this.submit = function(data){
		AP.ajaxShow();
		AP.post("api/esign/submit", data, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Signed and synced successfully");
			
			var sign_all_context = $("#js-sign-all-requests").length?true:false;
			if (sign_all_context && __requests){
				AP.hideCustomDialog("#js-sign-all-requests", true);
				
				if (__cached_origin){
					code.request.cached_origin = __cached_origin;
				}
				
				__requests = ARR.updateByID(__requests, code.request);
				Render.esign.signAll(__requests);
				if (alreadySignedAll(__requests)) {
					AP.hideCustomDialog("#js-sign-all-requests", true);
				}
				return;
			}

			AP.xRefresh();
		});
	};

	/**
	 * @desc update requests after signing
	 */
	this.signed = function(request){
		
		UI.flash("Signed and synced successfully");
			
		var sign_all_context = $("#js-sign-all-requests").length?true:false;
		if (sign_all_context && __requests){
			AP.hideCustomDialog("#js-sign-all-requests", true);
			
			if (__cached_origin){
				request.cached_origin = __cached_origin;
			}
			
			__requests = ARR.updateByID(__requests, request);
			Render.esign.signAll(__requests);
			if (alreadySignedAll(__requests)) {
				AP.hideCustomDialog("#js-sign-all-requests", true);
			}
			return;
		}

		AP.xRefresh();
	}
	
	
	
	/**
	 * @desc Remove a request
	 */
	this.remove = function(context){
		Form.confirm({
			message: "Please confirm to remove this e-sign request.",
			action: "api/esign/remove",
			data: {request_id: context.request_id, hid: context.hid, token: context.token, action: "remove"},
			success: function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.xRefresh();
			}
		});
	};

	/**
	 * @desc sync esign counter
	 */
	this.syncCounter = function(context){
		Form.confirm({
			message: "Please confirm to sync this e-sign request to request counter.",
			action: "api/esign/counter.sync",
			data: {request_id: context.request_id, hid: context.hid, token: context.token},
			success: function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				UI.flash(code.message);
				AP.xRefresh();
			}
		});
	};
	
	
	/**
	 * @desc Add more signers for the request
	 */
	this.addSigners = function(context){
		var rows = [
			{label: "Chá»n thĂªm ngÆ°á»i Ä‘á»ƒ kĂ½", placeholder: "GĂµ @ Ä‘á»ƒ tag", role: "tag", name: "signers", focus: 1}
		];
		
		Form.v2({
			action: "api/esign/signers.add",
			title: "ThĂªm ngÆ°á»i kĂ½",
			rows: rows,
			data: {request_id: context.request_id, hid: context.hid, token: context.token, action: "remove"},
			buttons: Form.button(":submit").button(":cancel")
		});
	};
	
	

	/**
	 * @desc Remove signers from the request
	 */
	this.removeSigners = function(context){
		var rows = [
			{label: "Bá» ngÆ°á»i Ä‘á»ƒ kĂ½", placeholder: "GĂµ @ Ä‘á»ƒ tag", role: "tag", name: "signers", focus: 1}
		];
		
		Form.v2({
			action: "api/esign/signers.remove",
			title: "XĂ³a ngÆ°á»i kĂ½",
			rows: rows,
			data: {request_id: context.request_id, hid: context.hid, token: context.token, action: "remove"},
			buttons: Form.button(":submit").button(":cancel")
		});
	};
	
	
	/**
	 * @desc Quickly sign all documents
	 */
	this.signAll = function(requests, callback){
		// return AP.alertError("SignAll function is temporarily disabled");
		
		if (callback){
			this.signAllCallback(callback);
		}
		
		if (alreadySignedAll(requests)){
			if (__callback){
				__callback();
				return;
			}
		}
		
		__requests = requests;
		if (requests.length){
			__cached_origin = requests[0].cached_origin;
		}
		
		var w = $(window).width();
		var h = $(window).height();
		if (!mobile()){
			w = Math.max(w*0.85, 1000);
			h = Math.max(h*0.9-80, 500);
		}
		
		var dialog = "  " +Render.render('dialog', {title: "Sign all files" , width:w, fit:1, fill_title:1}, "<div id='js-sign-all-requests' class='esign-all'> <div class='esa-side' style='height:"+(h)+"px'> <div class='title'>Sign requests ("+(requests.length)+")</div> <div class='esa-slide' data-autoscroll='1' data-autohide='1'> <div class='esa-list'></div> </div> </div> <div class='esa-main'  style='height:"+(h)+"px'></div> </div>")+ '';
		
		Render.finish();
		
		var side = AP.render(requests, function(e){
			if (!ARR.single(e.signers, function(es){
				return es == Client.viewer.username;
			})){
				return '';
			}
			if(e.has_counter == 1 && e.counter_status != 1){
				return '';
			}
			
			if(e.has_counter == 1 && e.esign_object.code_inserted && e.esign_object.code_inserted != 1){
				return '';
			}
			
			var ec = '';
			var icon = 'ap ion-ios-checkmark-outline';
			var icon_color = '';
			var done  = '';
			var object_data = Base64.encode(JSON.stringify({
				request_id: e.id,
				to_sign_token: e.cached_origin.to_sign_token || ''
			}));
			
			var event_sign_url = 'v1';
			var sign_url = Base.exchange.embedURL({
				event: "baseapi.sign.doc", // User defined
				app: "sign", // API app key
				endpoint: "signapi",
				width: 1200,
				title: "File signer",
				data: {
					id: e.cached_origin.id,
					hid: e.cached_origin.hid,
					token: e.cached_origin.token,
					request_id: e.id,
					refresh: 0
				},
				params: {
					fid: e.raw.fid,
					file_type: UI.file.ext(e.raw.fid),
					file_name: e.filename,
					origin_name: e.origin_export.name,
					origin_link: e.origin_export.link,
					client_key: Client.base.app,
					object_data: object_data
				}
			});
			
			if (e.esign_id && parseInt(e.esign_id) && e.esign_object && e.esign_object.id) {
				event_sign_url = 'v2';
				var esign_object = e.esign_object;
				sign_url = Base.exchange.embedURL({
					event: "baseapi.signv2", // User defined
					app: "sign", // API app key
					endpoint: "signapi/v2",
					width: 1200,
					title: "File signer",
					data: {
						id: e.cached_origin.id,
						hid: e.cached_origin.hid,
						token: e.cached_origin.token,
						request_id: esign_object.id,
						refresh: 0
					},
					params: {
						document_id: esign_object.id
				   }
				});
			}
			
			
			if (ARR.single(e.sequences, function(es){
				return es.username == Client.viewer.username;
			})){
				done = '1';
				ec= '-done';
				icon = 'ap ion-ios-checkmark';
				icon_color='success';
			}else{
				ec='-pending';
			}
			
			// if(event_sign_url =='v1'){
				return "  " +Render.render('list_item', {_class: "js-ereq-"+(e.id)+" "+(ec)+"" , icon:icon, icon_color:icon_color, data_signurl:sign_url, data_done:done, url: "::esign/focus" , padding:1}, '' +Render.render('title', {thick:1}, ""+(e.filename)+"")+ " " +Render.render('info', {}, ""+(e.name)+"")+ '')+ '';
			// }else{
			// 	return "  " +Render.render('list_item', {_class: "js-ereq-"+(e.id)+" "+(ec)+"" , icon:icon, icon_color:icon_color, data_done:done, url: "::esign/focus" , padding:1, ${sign_url}:1}, "// " +Render.render('title', {thick:1}, ""+(e.filename)+"")+ "// " +Render.render('info', {}, ""+(e.name)+"")+ "//")+ '';
			// }
			
		});
		
		$("#js-sign-all-requests .esa-side .esa-list").html("  " +Render.render('list', {comfort:1}, ""+(side)+"")+ '');
		Layout.scrollable("#js-sign-all-requests .esa-side .esa-slide");
		
		AP.dialog.get("#js-sign-all-requests").balance();
		
		if (requests.length){
			var $first = $("#js-sign-all-requests .esa-side .list-item.-pending").first();
			if ($first && $first.length){
				this.signFocus($first);
				UI.scrollVisible($first);
			}else if (alreadySignedAll(requests)){
				if (__callback){
					__callback();
					return;
				}
			}
		}
	};
	
	
	/**
	 * @desc Register signAllCallback
	 */
	this.signAllCallback = function(fn){
		if (!fn){
			__callback = null;
		}else{
			__callback = fn;
		}
		
	};
	
	
	this.signFocus = function(ref, qs){
		$(ref).addClass("active");
		$(ref).siblings().removeClass("active");
		
		var sign_url = $(ref).data("signurl");
		
		if (sign_url == ':done'){
			$("#js-sign-all-requests .esa-main").html("<div class='esa-embed'> " +Render.render('empty', {icon: "base_certified" , icon_color: "success" , title: "You already signed this file" }, '')+ "</div>");	
			
			return;
		}
		
		$("#js-sign-all-requests .esa-main").html("<div class='esa-embed'> <iframe style='width:100%; height:100%' frameborder='none' src='"+(sign_url)+"'></iframe> </div>");
	};
	
	
	/**
	 * @desc Get the signer request
	 */
	this.getRequest = function(e, that){
		e.cached_origin = that.obj;
		
		if (e.esign_id && parseInt(e.esign_id) && e.esign_object && e.esign_object.id){
			return getRequestV2(e, that);
		}
		

		if (parseInt(e.has_counter)){
			return getRequestV2(e, that);
		}
		
		var icon = UI.file.icon(e.raw.fid);
		var signers = AP.render(e.signers, function(uid){
			var u = People.get(uid);
			var signed = ARR.single(e.sequences, function(s){
				return s.username == uid; 
			});
			
			if (signed){
				return "<div class='be-signer -signed'> " +Render.render('tooltip', {width: "200" , comfort:1, inline:1}, ""+(u.name)+" signed at " +Render.render('text_datetime', {}, ""+(signed.since)+"")+ '')+ " " +Render.render('avatar', {user:u, sm:1}, '')+ "</div>";	
			}
			
			return "<div class='be-signer'> " +Render.render('tooltip', {width: "200" , comfort:1, inline:1}, ""+(u.name)+" has not signed")+ " " +Render.render('avatar', {user:u, sm:1}, '')+ "</div>";
		});
		
		
		var latest = e.raw.url;
		if (e.sequences && e.sequences.length){
			latest = e.sequences[e.sequences.length-1].url;
		}

		var percent = 0;
		if (e.signers.length){
			percent = e.sequences.length*100/e.signers.length;
		}
		
		var cta = getSignButton(e, that);
		
		return "<div class='be-file' data-id='"+(e.id)+"'> <div class='file-icon'><img src='"+(Client.share_url)+"/esign/"+(icon)+".png'/></div> <div class='completion'> " +Render.render('percent', {color: "main" , percent:percent, thickness: "2" , size: "40" }, '')+ "</div> <div class='base-title'> <span class='url' data-url=':file' data-file='"+(latest)+"'>"+(e.raw.name)+"</span> </div> <div class='base-info'>ÄĂ£ trĂ¬nh kĂ½ " +Render.render('text_ago', {}, ""+(e.since)+"")+ " by " +Render.render('user', {user_id:e.user_id, inline:1}, '')+ " &middot; <b>"+(e.sequences.length)+"</b>/"+(e.signers.length)+" ngÆ°á»i Ä‘Ă£ kĂ½</div> <div class='base-info'> <div class='be-signers clear-fix'>"+(signers)+"</div> </div> " +Render.render('side', {}, ""+(cta)+"")+ "</div>";
	};
	
	
	
	/**
	 * @desc Get the sign button
	 */
	function getSignButton(e, that){
		var file_id = e.raw.fid;
		var file_extension = UI.file.ext(e.raw.fid);
		var object_data = Base64.encode(JSON.stringify({
			request_id: e.id,
			to_sign_token: e.cached_origin.to_sign_token || ''
		}));
		
		var sign_url = Base.exchange.url({
			event: "baseapi.sign.doc", // User defined
			app: "sign", // API app key
			endpoint: "signapi",
			width: 1200,
			title: "File signer",
			data: {
				id: that.obj.id,
				hid: that.obj.hid,
				token: that.obj.token,
				request_id: e.id,
				refresh: 1
			},
			params: {
				fid: file_id,
				file_type: file_extension,
				file_name: e.filename,
				origin_name: e.origin_export.name,
				origin_link: e.origin_export.link,
				client_key: Client.base.app,
				object_data: object_data
		   }
		});

		var sign_usbtoken_url = Base.exchange.url({
			event: "baseapi.sign.usbtoken",
			app: "sign",
			endpoint: "signapi/hsign",
			width: 1200,
			title: "Sign with USB Token",
			data: {
				id: that.obj.id,
				hid: that.obj.hid,
				token: that.obj.token,
				request_id: e.id,
				refresh: 1
			},
			params: {
				fid: file_id,
				file_type: file_extension,
				file_name: e.filename,
				origin_name: e.origin_export.name,
				origin_link: e.origin_export.link,
				client_key: Client.base.app,
				object_data: object_data,
				sign_ext: 1
			}
		});
		
		var me_signed = ARR.single(e.sequences, function(s){
			return s.username == Client.viewer.username; 
		});
		
		var cta = '';
		if (ARR.contain(e.signers, Client.viewer.username)){
			if(!me_signed){
				if(mobile()){
					cta = "<div class='base-button -cta url' "+(sign_url)+">KĂ½ sá»‘</div>";
				}else{
					cta = "  " +Render.render('button', {dd:1, cta:1}, "KĂ½ sá»‘ " +Render.render('cmenu', {}, "<div class='-item url ap-xdot' "+(sign_url)+">Chá»¯ kĂ½ Ä‘iá»‡n tá»­</div> <div class='-item url ap-xdot' "+(sign_usbtoken_url)+">Sign with USB Token</div>")+ '')+ '';
				}
				
			}else{
				if(mobile()){
					cta = "<div class='base-button url -subtle' data-url=':file' data-file='"+(latest)+"'>View</div> <div class='base-button url' "+(sign_url)+">KĂ½ sá»‘</div>";
				}else{
					cta = "<div class='base-button url -subtle' data-url=':file' data-file='"+(latest)+"'>View</div> " +Render.render('button', {dd:1}, "KĂ½ sá»‘ " +Render.render('cmenu', {}, "<div class='-item url ap-xdot' "+(sign_url)+">Chá»¯ kĂ½ Ä‘iá»‡n tá»­</div> <div class='-item url ap-xdot' "+(sign_usbtoken_url)+">Sign with USB Token</div>")+ '')+ '';
				}
				
			}
			// if(!me_signed){
			// 	cta = "<div class='base-button -cta url' "+(sign_url)+">KĂ½ sá»‘</div>";
			// }else{
			// 	cta = "<div class='base-button url -subtle' data-url=':file' data-file='"+(latest)+"'>View</div> // 	<div class='base-button url' "+(sign_url)+">KĂ½ sá»‘</div>";
			// }
		}
		
		var original = e.raw.url;
		var latest = e.raw.url;
		if (e.sequences && e.sequences.length){
			latest = e.sequences[e.sequences.length-1].url;
		}
		
		return ""+(cta)+" " +Render.render('button_dd', {border:1}, '' +Render.render('cmenu', {}, '' +Render.render('cmenu_item', {label: "Xem file gáº§n nháº¥t" , url: ":file" , data_file:latest}, '')+ " " +Render.render('cmenu_item', {label: "Xem file gá»‘c" , url: ":file" , data_file:original}, '')+ " " +Render.render('cmenu_item', {acl:that.admin?1:0, sep:1}, '')+ " " +Render.render('cmenu_item', {acl:that.admin?1:0, label: "ThĂªm ngÆ°á»i kĂ½" , url: "::esign/signers.add?request_id="+(e.id)+"&hid="+(that.obj.hid)+"&token="+(that.obj.token)+"" }, '')+ " " +Render.render('cmenu_item', {acl:that.admin?1:0, label: "XĂ³a ngÆ°á»i kĂ½" , url: "::esign/signers.remove?request_id="+(e.id)+"&hid="+(that.obj.hid)+"&token="+(that.obj.token)+"" }, '')+ " " +Render.render('cmenu_item', {acl:that.admin?1:0, sep:1}, '')+ " " +Render.render('cmenu_item', {acl:that.admin?1:0, label: "XĂ³a file" , url: "::esign/remove?request_id="+(e.id)+"&hid="+(that.obj.hid)+"&token="+(that.obj.token)+"" }, '')+ '')+ '')+ '';
	};
	
	
	
	/**
	 * @desc Getting the request, v2 (with document_id already)
	 */
	function getRequestV2(e, that){
		var esign = e.esign_object;
		
		var icon = UI.file.icon(e.raw.fid);
		var signers = AP.render(esign.followers||[], function(uid){
			var u = People.get(uid);
			var signed = ARR.single(esign.sequences, function(s){
				return s.username == uid; 
			});
			
			if (signed){
				return "<div class='be-signer -signed'> " +Render.render('tooltip', {width: "200" , comfort:1, inline:1}, ""+(u.name)+" signed at " +Render.render('text_datetime', {}, ""+(signed.since)+"")+ '')+ " " +Render.render('avatar', {user:u, sm:1}, '')+ "</div>";	
			}
			
			return "<div class='be-signer'> " +Render.render('tooltip', {width: "200" , comfort:1, inline:1}, ""+(u.name)+" has not signed")+ " " +Render.render('avatar', {user:u, sm:1}, '')+ "</div>";
		});
		
		
		var latest = e.raw.url;
		if(parseInt(esign.has_code) == 1 && parseInt(esign.code_inserted) == 1){
			if(esign.data.url_extsign_file_id){
				latest = esign.data.url_extsign_file_id;
			}
		}
		if (esign.sequences && esign.sequences.length){
			latest = esign.sequences[esign.sequences.length-1].url;
		}

		var percent = 0;
		if (parseInt(esign.num_assigned)){
			percent = parseInt(esign.num_signed)*100/parseInt(esign.num_assigned);
		}
		
		var cta = getSignButtonV2(e, that);
		
		return "<div class='be-file' data-id='"+(e.id)+"'> <div class='file-icon'><img src='"+(Client.share_url)+"/esign/"+(icon)+".png'/></div> <div class='completion'> " +Render.render('percent', {color: "main" , percent:percent, thickness: "2" , size: "40" }, '')+ "</div> <div class='base-title'> <span class='url' data-url=':file' data-file='"+(latest)+"'>"+(e.raw.name)+"</span> </div> <div class='base-info'>ÄĂ£ trĂ¬nh kĂ½ " +Render.render('text_ago', {}, ""+(e.since)+"")+ " by " +Render.render('user', {user_id:e.user_id, inline:1}, '')+ " &middot; <b>"+(esign.sequences ? esign.sequences.length : 0)+"</b>/"+(esign.num_assigned||0)+" ngÆ°á»i Ä‘Ă£ kĂ½</div> <div class='base-info'> <div class='be-signers clear-fix'>"+(signers)+"</div> </div> " +Render.render('side', {}, ""+(cta)+"")+ "</div>";
	};
	
	
	
	
	/**
	 * @desc Get the sign button
	 */
	function getSignButtonV2(e, that){
		var esign = e.esign_object;
		
		var sign_url = Base.exchange.url({
			event: "baseapi.signv2", // User defined
			app: "sign", // API app key
			endpoint: "signapi/v2",
			width: 1200,
			title: "File signer",
			data: {
				id: that.obj.id,
				hid: that.obj.hid,
				token: that.obj.token,
				request_id: e.id,
				refresh: 1
			},
			params: {
				document_id: e.esign_object.id
			}
		});

		var sign_usbtoken_url = Base.exchange.url({
			event: "baseapi.sign.usbtoken",
			app: "sign",
			endpoint: "signapi/hsign",
			width: 1200,
			title: "Sign with USB Token",
			data: {
				id: that.obj.id,
				hid: that.obj.hid,
				token: that.obj.token,
				request_id: e.id,
				refresh: 1
			},
			params: {
				document_id: e.esign_object.id,
				sign_ext: 1
			}
		});

		var insert_code_url = Base.exchange.url({
			event: "baseapi.sign.code", // User defined
			app: "sign", // API app key
			endpoint: "signapi/code",
			width: 1200,
			title: "Insert document code",
			data: {
				id: that.obj.id,
				hid: that.obj.hid,
				token: that.obj.token,
				request_id: e.id,
				refresh: 1
			},
			params: {
				document_id: e.esign_object.id
		   }
		});
		var suggest_sign_url = Base.exchange.url({
			event: "baseapi.sign.suggest", // User defined
			app: "sign", // API app key
			endpoint: "signapi/position",
			width: 1200,
			title: "Suggest position",
			data: {
				id: that.obj.id,
				hid: that.obj.hid,
				token: that.obj.token,
				request_id: e.id,
				refresh: 1
			},
			params: {
				document_id: e.esign_object.id
		   }
		});
		
		var can_sign = ARR.single(esign.followers, function(s){
			return s == Client.viewer.username; 
		});

		var me_signed = ARR.single(esign.sequences, function(s){
			return s.username == Client.viewer.username; 
		});
		
		var latest = e.raw.url;
		if (esign.sequences && esign.sequences.length){
			latest = esign.sequences[esign.sequences.length-1].url;
		}

		var valid_code = parseInt(esign.has_code) == 0 || esign.num_signed > 0 || (parseInt(esign.has_code) == 1 && parseInt(esign.code_inserted) == 1);
		
		var more_item = '';
		if (can_sign && valid_code){
			if(!me_signed){
				if(mobile()){
					cta = "<div class='base-button -cta url' "+(sign_url)+">KĂ½ sá»‘</div>";
				}else{
					cta = "  " +Render.render('button', {dd:1, cta:1}, "KĂ½ sá»‘ " +Render.render('cmenu', {}, "<div class='-item url ap-xdot' "+(sign_url)+">Chá»¯ kĂ½ Ä‘iá»‡n tá»­</div> <div class='-item url ap-xdot' "+(sign_usbtoken_url)+">Sign with USB Token</div>")+ '')+ '';
				}
				
			}else{
				if(mobile()){
					cta = "<div class='base-button url -subtle' data-url=':file' data-file='"+(latest)+"'>View</div> <div class='base-button url' "+(sign_url)+">KĂ½ sá»‘</div>";
				}else{
					cta = "<div class='base-button url -subtle' data-url=':file' data-file='"+(latest)+"'>View</div> " +Render.render('button', {dd:1}, "KĂ½ sá»‘ " +Render.render('cmenu', {}, "<div class='-item url ap-xdot' "+(sign_url)+">Chá»¯ kĂ½ Ä‘iá»‡n tá»­</div> <div class='-item url ap-xdot' "+(sign_usbtoken_url)+">Sign with USB Token</div>")+ '')+ '';
				}
				
			}
			if(e.user_id==Client.viewer.id){
				more_item = "<div class='-item url ap-xdot' "+(suggest_sign_url)+">Suggest sign</div>";
			}
			// cta = "<div class='base-button -cta url' "+(sign_url)+">KĂ½ sá»‘</div>";
		}else{
			if(e.user_id==Client.viewer.id || can_sign){
				if(parseInt(esign.has_code) == 1 && parseInt(esign.code_inserted) == 0 && esign.doc_code){
					cta = "<div class='base-button url' "+(insert_code_url)+">Insert code</div>";
					if(e.user_id==Client.viewer.id){
						more_item = "<div class='-item url ap-xdot' "+(suggest_sign_url)+">Suggest sign</div>";
					}
				}else{
					if(e.counter_status==1){
						cta = "<div class='base-button -cta url' "+(suggest_sign_url)+">Suggest sign</div>";
						more_item = "<div class='-item url ap-xdot' data-url=':file' data-file='"+(latest)+"'>View</div>";
					}else{
						cta = "<div class='base-button url -subtle' data-url=':file' data-file='"+(latest)+"'>View</div>";
					}
					
				}
			}else{
				cta = "<div class='base-button url -subtle' data-url=':file' data-file='"+(latest)+"'>View</div>";
			}
			
		}
		
		var item = "  " +Render.render('cmenu_item', {label: "ESign: View or manage" , url: "base-sign://detail/"+(e.esign_object.id)+"" }, '')+ '';
		if (!parseInt(e.esign_id)){
			item = "  " +Render.render('cmenu_item', {label: "XĂ³a" , url: "::esign/remove?request_id="+(e.id)+"&hid="+(that.obj.hid)+"&token="+(that.obj.token)+"" }, '')+ '';
		}
		if(e.user_id==Client.viewer.id && parseInt(esign.has_code) == 1 && parseInt(e.status) == 1){
			item += "  " +Render.render('cmenu_item', {label: "Sync back to request counter" , url: "::esign/counter.sync?request_id="+(e.id)+"&hid="+(that.obj.hid)+"&token="+(that.obj.token)+"" }, '')+ '';
		}
		item += more_item;
		
		return ""+(cta)+" " +Render.render('button_dd', {border:1}, '' +Render.render('cmenu', {}, ""+(item)+"")+ '')+ '';
	};
	
	
	
	/**
	 * @desc Sign render (connect to office)
	 */
	function signRender(f){
		if (!Base.appEnabled("office")){
			f.findRow("office").hide();
		}
		
		f.find("office").on("change", function(){
			if (!$(this).is(":checked")){
				f.findRow("doctype_id").hide();
				f.findRow("storage_id").hide();
			}else{
				getOfficeConfig(function(code){
					f.findRow("doctype_id").show();
					f.findRow("storage_id").show();
					
					if (!office_inited){
						office_inited = true;
						
						f.find("doctype_id").replaceWith("  " +Render.render('form_input', {_name: "doctype_id" , options:code.doctypes, _default: "-- Vui lĂ²ng chá»n --" , select:1}, '')+ '');
						f.find("storage_id").replaceWith("  " +Render.render('form_input', {_name: "storage_id" , options:code.storages, _default: "-- Vui lĂ²ng chá»n --" , select:1}, '')+ '');
						
						f.find("storage_id").on("change", function(){
							var v = $(this).val();
							var s = ARR.findObj(office_storages, v);
							if (!s){
								f.find("book_id").replaceWith("  " +Render.render('form_input', {_name: "storage_id" , options: "[]" , _default: "-- Vui lĂ²ng chá»n --" , select:1}, '')+ '');
							}else{
								f.find("book_id").replaceWith("  " +Render.render('form_input', {_name: "storage_id" , options:s.cached_books, _default: "-- Vui lĂ²ng chá»n --" , select:1}, '')+ '');
							}
						});
					}
					
				});
			}
		}).trigger("change");

	};
	
	
	function getOfficeConfig(callback){
		if (office_doctypes && office_storages){
			return callback();
		}
		
		UI.ajaxShow();
		AP.post(Base.domain("office")+"/ajax/api/esign/config", {}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			office_doctypes = code.doctypes;
			office_storages = code.storages;
			return callback(code);
		});
	};
	
	
	function alreadySignedAll(requests){
		var new_requests = [];
		
		for (var i=0; i<requests.length; i++){
			if(requests[i].has_counter == 1) {
				if(requests[i].counter_status == 1) {
					if(requests[i].esign_object && requests[i].esign_object.code_inserted) {
						if(requests[i].esign_object.code_inserted == 1){
							new_requests.push(requests[i]);
						}else{
							continue;
						}
						
					}else{
						new_requests.push(requests[i]);
					}					
				}else{
					continue;
				}
			}else{
				new_requests.push(requests[i]);
			}
		}
		

		for (var i=0; i<new_requests.length; i++){

			if (!ARR.single(new_requests[i].signers, function(es){
				return es == Client.viewer.username;
			})){
				continue;
			}
			
			if (!ARR.single(new_requests[i].sequences, function(es){
				return es.username == Client.viewer.username;
			})){
				return false;
			}
		}
		
		return true;
	}
	
};



Base.exchange.on("baseapi.sign.doc", function(response){
	if (parseInt(response.status) === 1 && response.fid){
		response.data.fid = response.fid;
		if(response.sendback_data){
			if(response.data.refresh){
				AP.xRefresh();
			}else{
				Render.esign.signed(response.sendback_data);
			}
		}else{
			Render.esign.submit(response.data);
		}
		
	}else{
		return AP.alertError(response.message);
	}
});

Base.exchange.on("baseapi.signv2", function(response){
	if (parseInt(response.status) == 1){
		if(response.data.refresh && !response.continue){
			AP.xRefresh();
		}else{
			if(!response.continue){
				Render.esign.signed(response.sendback_data);
			}
		}
	}else{
		return AP.alertError(response.message);
	}
});
Base.exchange.on("baseapi.sign.code", function(response){
	if (parseInt(response.status) == 1){
		AP.xRefresh();
	}else{
		return AP.alertError(response.message);
	}
});
Base.exchange.on("baseapi.sign.suggest", function(response){
	if (parseInt(response.status) == 1){
		AP.xRefresh();
	}else{
		return AP.alertError(response.message);
	}
});
Base.exchange.on("baseapi.sign.usbtoken", function(response){
	if (parseInt(response.status) == 1){
		AP.xRefresh();
	}else{
		return AP.alertError(response.message);
	}
});


Rewrite.on("::esign/{action}", function(qs){
	if (qs.action == 'remove'){
		return Render.esign.remove(qs);
	}
	
	if (qs.action == 'signers.add'){
		return Render.esign.addSigners(qs);
	}
	
	if (qs.action == 'signers.remove'){
		return Render.esign.removeSigners(qs);
	}
	
	if (qs.action == "focus"){
		return Render.esign.signFocus(this, qs);
	}
	
	if (qs.action == 'counter.sync'){
		return Render.esign.syncCounter(qs);
	}
	
//	if (qs.action == "all"){
//		return Render.esign.signAll(Client.tempData.requests);
//	}
});




Render.on(["esigns", "esign"], function(){
	var that = this;
	
	var files = AP.render(this.requests, function(e){
		return Render.esign.getRequest(e, that);
	});
	
	var propose = "<div class='base-esign-proposal'> <div class='be-button clear-fix'> " +Render.render('action', {icon: "base_plus" , _class: "js-propose" }, "TrĂ¬nh kĂ½ vÄƒn báº£n má»›i")+ "</div> </div>";
	
	if (!this.admin){
		propose = '';
	}
	
	return "<div id='base-esign-wrapper'> <div class='base-esign-canvas' "+(this.show('id'))+"> <div class='base-esign-files'>"+(files)+"</div> "+(propose)+" </div> </div>";
}, function(params, obj){
	$(this).find(".base-action.js-propose").click(function(){
		Render.esign.propose(obj, this);
	});
	
	$(this).find(".js-sign-cta").click(function(){
		
	});
});


Render.ui.logUI = new function __RULogUI(){
	this.showChanges = function(ref){
		var changes = $(ref).closest(".js-base-log").data("changes");
		
		var rows = AP.render(changes, function(c){
			return "  " +Render.render('table_row', {}, '' +Render.render('cell', {lead:1}, ""+(c.k)+"")+ " " +Render.render('cell', {}, ""+(c.o)+"")+ " " +Render.render('cell', {}, ""+(c.n)+"")+ '')+ '';
		});
		
		var html = "  " +Render.render('table', {compact:1}, '' +Render.render('table_header', {sm:1}, '' +Render.render('cell', {width: "25%" , lead:1}, "Key")+ " " +Render.render('cell', {width: "40%" , lead:1}, "GiĂ¡ trá»‹ cÅ©")+ " " +Render.render('cell', {width: "35%" , lead:1}, "GiĂ¡ trá»‹ má»›i")+ '')+ "<tbody>"+(rows)+"</tbody>")+ '';
		
		return "  " +Render.render('dialog', {width: "500" , title: "Changed values" }, ""+(html)+"")+ '';
	};
};


Render.on("logs", function(){
	var that = this;
	
	var logs = AP.render(this.logs, function(log){
		return "  " +Render.render('log', {compact:that.compact||0, log:log}, '')+ '';
	});
	
	return "<div class='base-logs' "+(this.show('id'))+">"+(logs)+"</div>";
	
}, function(params, obj){
	
	if (params.limit){
		$(this).shortlist({
			max: params.limit
		});
	}
	
});


Render.on("log", function(){
	var date = AP.i18n.date(this.log.since);
	if (this.compact){
		date = AP.time.time("%d/%m<em>%Y</em>", this.log.since);
	}
	
	if (AP.time.sameYear(this.log.since, AP.time.now()) && 1==2){
		date = AP.time.time("%V, %d/%m", this.log.since);
		if (this.compact){
			date = AP.time.time("%d/%m", this.log.since);	
		}
	}
	
	var icon = '';
	var color = '';
	
	if (this.log.data && this.log.data.icon){
		icon = "  " +Render.render('iconbox', {icon:this.log.data.icon, color:this.log.data.icon_color||'main', edge: "3" , el:1}, '')+ '';
		color = this.log.data.icon_color;
		
		if (this.log.data.icon_fill){
			color = this.log.data.icon_fill;
			icon = "  " +Render.render('iconbox', {icon:this.log.data.icon, color:this.log.data.icon_fill||'main', el:1, solid:1}, '')+ '';
		}	
	}else if ('icon' in this.log){
		
	}else{
		this.addClass("-no-icon");
	}
	
	
	
	var link = '';
	var url = '';
	if (this.log.data && this.log.data.url){
		link = " &middot; <em class='url' data-url='"+(this.log.data.url)+"'>View</em>";
		url = this.log.data.url;
	}else if ('url' in this.log){
		url = this.log.url;
	}
	
	var msg = this.log.message || '';
	var change = '';
	
	if (this.log.changes){
		change = " &middot; <span class='url' onclick='Render.ui.logUI.showChanges(this);'>View changes</span>";
	}
	
	var since = " &middot; " +Render.render('text_datetime', {}, ""+(this.log.since)+"")+ '';
	if (this.compact){
		since = '';
		this.addClass("-compact");
	}
	
	return "<div class='base-log js-base-log "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='-bl-date'>"+(date)+"</div> <div class='-bl-dot'></div> <div class='-bl-icon'> "+(icon)+" </div> <div class='-bl-message'> <div class='url' data-url='"+(url)+"'>"+(Block.decode.text(msg))+"</div> </div> <div class='-bl-info'> " +Render.render('special_tag', {color:color, edge:1, subtle:1, sm:1}, ""+(this.log.event)+"")+ " &nbsp; &middot; " +Render.render('icon', {icon: "fa user-circle" , inline:1}, '')+ "&nbsp; " +Render.render('user', {user_id:this.log.user_id, inline:1}, '')+ " "+(since)+" "+(change)+" "+(link)+" </div> </div>";
}, function(params, obj){
	$(this).data("changes", obj.log.changes);
});


Render.on("livechat", function(){
	return "<div class='js-live-chat livechat' "+(this.show('id'))+"></div>";
}, function(params, obj){
	LiveChat.init(obj.obj.room, "#"+params.id);
});


Render.on("webhook-traces", function(){
	var footer = '';
	if (this.pagination){
		footer = "<div class='wt-footer'> " +Render.render('pagination', {}, '')+ "</div>";
	}
	
	var items = '';
	var admin = this.admin||0;
	
	if (this.traces){
		items = AP.render(this.traces, function(e){
			return "  " +Render.render('webhook_trace', {trace:e, admin:admin}, '')+ '';
		});
	}
	
	return "<div class='webhook-traces "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='-wrapper'> <div class='wt-items'>"+(items)+""+(this.content)+"</div> "+(footer)+" </div> </div>";
});



Render.on("webhook-trace", function(){
	var actions = '';
	if (!parseInt(this.trace.status)){
		actions = "<div class='trace-status'> " +Render.render('special_tag', {color: "blue" , circled:1, inverse:1}, "Sending")+ "</div>";
		
		if (AP.time.now() - parseInt(this.trace.last_run) >= 5*60){
			actions += "  " +Render.render('button', {_class: "js-run" , icon: "ap controller-play" , sm:1}, "Re-run")+ '';
		}
	}else if (parseInt(this.trace.status) == 1){
		actions = "<div class='trace-status'> " +Render.render('special_tag', {color: "success" }, "Received")+ "</div>";
	}else if (parseInt(this.trace.status) == -1){
		actions = "<div class='trace-status'> " +Render.render('special_tag', {color: "error" }, "Failed")+ "</div>";
	}
	
	return "<div class='webhook-trace' "+(this.show('id'))+" data-id='"+(this.trace.id)+"'> " +Render.render('avatar', {user_id:this.trace.user_id}, '')+ " " +Render.render('title', {}, ""+(this.trace.name)+"")+ " " +Render.render('info', {}, ""+(this.trace.event)+" &middot; " +Render.render('text_datetime', {ts:this.trace.since}, '')+ '')+ " " +Render.render('side', {}, ""+(actions)+"")+ "</div>";
}, function(params){
	$(this).find(".base-button.js-run").click(function(){
		var id = $(this).closest(".webhook-trace").data("id");
		if (id){
			AP.confirm("Please confirm to force re-running this webhook trigger. It may cause side-effects.", function(){
				UI.ajaxShow();
				AP.post("api/webhook/rerun", {id: id}, function(code){
					UI.ajaxHide();
					
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					UI.flash("Force re-run successfully");
					AP.xRefresh();
				});
			});
		}
	});
});


Render.on("platform-insight", function(){
	return "<div class='platform-insight'> <div class='-pi-wrapper'> " +Render.render('icon', {size: "24" , icon: "platform_api" , color: "success more" }, '')+ "<div class='pi-header'> " +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('info', {}, ""+(this.subtitle)+"")+ "</div> <div class='pi-body'>"+(this.content)+"</div> </div> </div>";
});

Render.on("platform-insight-api", function(){
	var api = this.endpoint.replace(/\:([a-z0-9]+)/g, function(m){
		return "<b>"+(m.substr(1))+"</b>";
	});
	
	var extra = '';
	if (this.alternative){
		var alt = this.alternative.replace(/\:([a-z0-9]+)/g, function(m){
			return ""+(m)+"";
		});
		
		extra = "<div class='ae -extra'> <div class='label'>Alternative</div> " +Render.render('text_code', {}, ""+(alt)+"")+ "<div class='copy url' data-url='::base/copy' data-copy='"+(alt)+"'>Copy</div> </div>";
	}
	
	return "<div class='api-endpoint'> <div class='ae'> <div class='label'>Endpoint</div> " +Render.render('text_code', {}, ""+(api)+"")+ "<div class='copy url' data-url='::base/copy' data-copy='"+(api)+"'>Copy</div> </div> "+(extra)+" </div>";
});


Render.on("platform-params", function(){
	var extra = '';
	if (this.none){
		extra = 'No additional parameter';
		this.addClass("-empty");
	}
	
	return "<div class='pi-params "+(this.get('class'))+"'> <div class='pip-label'>"+(this.title||'Parameters')+"</div> <div class='pip-extra'>"+(extra)+"</div> <div class='pip-items'>"+(this.content)+"</div> </div>"
});


Render.on("platform-param", function(){
	var extra = '';
	if (this.accepted){
		extra = "<div class='accepted'><em>Accepted:</em> <span>"+(this.accepted)+"</span></div>";
	}
	
	return "<div class='pi-param'> <div class='param'>"+(this.param)+"</div> "+(this.content)+" "+(extra)+" </div>";
});




Render.baseAPI = new function __RenderBaseAPI(){
	
	this.url = function(url){
		var extra = "exchange_token="+(Query.get('exchange_token'))+"&__local_apitoken="+(Query.get('__local_apitoken'))+"&postback="+(Query.get('postback'))+"";
		
		if (url.indexOf("?")==-1){
			return url+`?${extra}`;
		}else{
			return url+`&${extra}`;
		}
	};
	
	
	/**
	 * @desc Set title
	 */
	this.setTitle = function(title){
		Base.exchange.sendBack({
			intent: "safe-set-title",
			title: title,
			silent: 1
		});
	};
	
	/**
	 * @desc Close the dialog
	 */
	this.close = function(){
		Base.exchange.sendBack({
			intent: "safe-close",
			silent: 1
		});
	};
	
};


Render.on("api-list", function(){
	var items = "";
	if (this.items){
		var fn = Render.def("api-list");
		items = AP.render(this.items, function(e){
			return fn(e);
		});
	}
	
	return "<div class='api-list' "+(this.show('id'))+"> <div class='al-canvas'> <div class='al-title'>"+(this.title)+"</div> <div class='al-header'> " +Render.render('search', {placeholder:this.filter, filter: "#"+(this.id)+" .api-item" , lg:1}, '')+ "</div> <div class='al-body'>"+(items)+""+(this.content)+"</div> </div> </div>";
});



Render.on("api-item", function(){
	return "<div class='api-item url "+(this.get('class'))+"' "+(this.show('id'))+" data-url='"+(Render.baseAPI.url(this.url))+"'> <div class='ai-inner'> "+(this.content)+" <div class='api-next'>Chá»n</div> </div> </div>";
});


Render.on("api-note", function(){
	return "<div class='api-note'>"+(this.content)+"</div>";
})


Render.on("app-form", function(){
	var back = '';
	if (this.back){
		back = "  " +Render.render('app_back', {url:this.back}, '')+ '';
	}
	
	var header = '';
	if (this.title){
		header = "<div class='af-header'> "+(back)+" <div class='af-title'>"+(this.title)+"</div> <div class='af-subtitle'>"+(this.subtitle)+"</div> </div>";
	}
	
	return "  " +Render.render('form', {action:this.action, id:this.id}, "<div class='app-form'> "+(header)+" <div class='af-body'>"+(this.content)+"</div> </div>")+ '';
});



Render.on("app-back", function(){
	return "<div class='app-back url' data-url='"+(Render.baseAPI.url(this.url))+"'> <span class='-ap icon-arrow-left2'></span> </div>";
});



Render.on("app-complete", function(){
	return "<div class='app-complete'> <div class='ap-icon'> " +Render.render('icon', {icon_color: "success" , icon: "base_certified" , xl:1}, '')+ "</div> <div class='ap-title'>"+(this.title)+"</div> <div class='ap-body'>"+(this.content)+"</div> </div>";
});


Render.on("api-canvas", function(){
	return "<div class='api-canvas'>"+(this.content)+"</div>";
});

Render.on("api-header", function(){
	var items = '';
	if (this.items){
		var opts = AP.render(this.picker, function(e){
			return "<option value='"+(e.id)+"'>"+(e.name)+"</option>";
		});
		
		var val = '';
		if (this.cache){
			val = Base.pref().get("api-"+this.cache);
			val = val||'';
		}
		
		items = "<div class='select'> " +Render.render('form_input', {_name: "picker" , options:this.items, value:val, select:1, improved:1}, '')+ "</div>";
	}
	
	return "<div class='api-header' "+(this.show('id'))+"> <div class='title'>"+(this.title)+"</div> <div class='content'> "+(items)+""+(this.content)+" </div> </div>";
	
}, function(params){
	if (params.picked){
		var fn = getFunctionByName(params.picked);
		
		$(this).find("select").on("change", function(){
			fn($(this).val());
			if (params.cache){
				Base.pref().set("api-"+params.cache, $(this).val());
			}
		})
	}
});


Render.on("api-main", function(){
	var placeholder = '';
	if (this.placeholder){
		placeholder = "<div class='placeholder'>"+(this.placeholder)+"</div>";
	}
	return "<div class='api-main' "+(this.show('id'))+"> "+(placeholder)+" "+(this.content)+" </div>";
});



Render.on("api-submit", function(){
	var cancel = '';
	if (this.with_cancel){
		cancel = "<div class='api-cancel' onclick='Render.baseAPI.close()'>Há»§y</div>";
		this.addClass("-with-cancel");
	}
	
	return "<div class='api-submit-wrapper "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='wrapper'> "+(cancel)+" <div class='api-submit'>"+(this.label)+"</div> </div> </div>";
});




Render.on("layout-focus", function(){
	this.addSizingClass();
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	return "<div class='layout-focus "+(this.get('class'))+"' "+(this.show('id'))+"> <div class='layout-internal'>"+(this.content)+"</div> </div>";
});



// @desc Layout with sidebar and main
Render.on("layout-multi", function(){
	this.addSizingClass();
	if (this.borderless){
		this.addClass("-borderless");
	}
	
	return "<div class='layout-multi "+(this.get('class'))+"' "+(this.show('id'))+"> "+(this.content)+" </div>";
});

Render.on("layout-main", function(){
	return "<div class='layout-main'>"+(this.content)+"</div>";
});

Render.on("layout-sidebar", function(){
	return "<div class='layout-sidebar'>"+(this.content)+"</div>";
});


Render.on("menu", function(){
	if (this.auto_active){
		this.addClass('auto-active-url');
	}
	
	if (this.hidden){
		this.addClass("hidden");
	}
	
	this.addSizingClass();
	
	var title=this.title?("<div class='title'>"+(this.title)+"</div>"):'';
	var subtitle=this.subtitle?("<div class='subtitle'>"+(this.subtitle)+"</div>"):'';
	
	var header='';
	if (title || subtitle){
		header="<div class='header'>"+(title)+""+(subtitle)+"</div>";
	}
	
	return "<div class='base-menu "+(this.get('class'))+"' "+(this.show('id'))+"> "+(header)+" <div class='menu-body'>"+(this.content)+"</div> </div>";
	
}, {
	done: function(attrs){
		if (attrs.param){
			$(this).find(".menu-item").data("urlparam", attrs.param);
		}else if (attrs.urlparam){
			$(this).find(".menu-item").data("urlparam", attrs.urlparam);
		}
		
		if (attrs.auto_active){
			if (attrs.param){
				$(this).find(".menu-item").addClass("url").data("urlparam", attrs.param);
				$(this).find(".menu-item").setActiveURLParam(attrs.param, {fallback: ''});
				return;
			}
			
			$(this).find(".menu-item").setActiveURL();
		}
	}
});



Render.on("menu-section", function(){
	if (!Render.acl(this)){
		return '';
	}
	
	var title='';
	if (this.title){
		title="<div class='ms-title'>"+(this.title)+"</div>";
	}
	
	return "<div class='menu-section'>"+(title)+""+(this.content)+"</div>";
});

Render.on("menu-item", function(){
	if ('acl' in this && !Render.helper.acl(this.acl)){
		return '';
	}
	
	if (this.hidden){
		this.addClass("hidden");
	}
	
	if (this.sep){
		return "<div class='menu-item-sep'></div>";
	}
	
	if (this.active){
		this.addClass("active");
	}
	
	var icon='';
	if (this.icon){
		icon = "<div class='-mi-icon'>"+(Render.helper.getIcon(this))+"</div>";
		this.addClass("-picon");
	}
	
	if (this.checked){
		icon = "<div class='-mi-icon'> " +Render.render('icon', {icon: "icon_fill_check" , icon_color: "success" }, '')+ "</div>";
		this.addClass("-picon");
	}
	
	if (! ('url' in this)){
		this.url = '';
	}
	
	return "<div class='menu-item url "+(this.get('class'))+"' "+(this.show('url'))+" "+(this.show('id'))+" "+(this.showData('value'))+" "+(this.showAllData())+"> "+(icon)+" <div class='-mi-label'>"+(this.label||'')+""+(this.content)+"</div> </div>";
}, {
	
});
Form.on("input-table", function(opts){
	var headers = Form.ui.table.getHeaders(opts.placeholder);

	return "<div class='input-table'> <div class='hidden'><textarea class='js-primary' id='"+(opts.id)+"' name='"+(opts.name)+"'></textarea></div> <div class='visible-custom-table'> "+(Form.ui.table.getTable(headers, opts))+" </div> </div>";

}, function(input, value){
	var headers = Form.ui.table.getHeaders(this.options.placeholder);

	var $canvas = $(input).closest(".input-table");

	$canvas.find(".js-add-more").click(function(){
		Form.ui.table.addRow(this, headers);
	});

	$canvas.on("click", ".-remove", function(){
		$(this).closest("tr").remove();
		Form.ui.table.updateFinalValue($canvas.find(".visible-custom-table"));
	});

	if (value){
		Form.ui.table.setRows($canvas, headers, value);
	}
});



Form.on("input-objects", function(opts){
	var tw = 0;
	for (var i=0; i<opts.options.length; i++){
		if (!opts.options[i].width){
			opts.options[i].width = 10;
		}
		
		tw+= opts.options[i].width; 
	}
	
	if (!tw){
		return '';
	}
	
	var headers = AP.render(opts.options, function(e, index){
		var w = e.width*100/tw;
		e.computed_width = w;
		
		var _w = ""+(w)+"%";
		
		if (index == 0){
			_w = '';
		}
		
		return "  " +Render.render('cell', {width:_w, lead:1}, ""+(e.label||e.name)+"")+ '';
	});
	
	
	var wrapped_title = '';
	if (opts.placeholder){
		wrapped_title="<div class='iow-title'> <span>"+(opts.placeholder)+"</span> </div>";
	}
	
	return "<div class='input-objs'> <div class='io-wrapper "+(opts.placeholder?'-wrapped':'')+"'> "+(wrapped_title)+" <div class='hidden'><input type='hidden' class='js-primary' name='"+(opts.name)+"' id='"+(opts.id)+"'></div> <div class='input-opts-table'> <div class='iot'> " +Render.render('table', {}, '' +Render.render('table_header', {sm:1}, ""+(headers)+" " +Render.render('cell', {width: "40" }, "&nbsp;")+ '')+ "<tbody></tbody>")+ "<div class='input-add-more'> " +Render.render('label', {_class: "js-add-more" , icon: "fa plus-circle" }, "ThĂªm dĂ²ng má»›i")+ " </div> </div> </div> </div> </div>";
	
}, function(input, value){
	var $canvas = $(input).closest(".input-objs");
	var that = this;
	var $cta = $canvas.find(".js-add-more");
	
	Form.ui.ios.addRow($cta, that);
	
	$cta.click(function(){
		Form.ui.ios.addRow(this, that, true);
	});
	
	$canvas.on("click", ".js-remove", function(){
		$(this).closest("tr").remove();
		Form.ui.ios.updateFinalValue($canvas);
	});

	if (value){
		Form.ui.ios.setRows($canvas, that, value);
	}
})




// Advanced object
Form.on("input-advanced-objects", function(opts){	
	var wrapped_title = '';
	
	return "<div class='input-objs'> <div class='io-wrapper "+(opts.placeholder?'-wrapped':'')+"'> "+(wrapped_title)+" <div class='hidden'><input type='hidden' class='js-primary' name='"+(opts.name)+"' id='"+(opts.id)+"'></div> <div class='input-row-wrapper'> <div class='input-rows js-input-rows'></div> <div class='input-add-more'> " +Render.render('label', {_class: "js-add-more" , icon: "fa plus-circle" }, "ThĂªm dĂ²ng má»›i")+ " </div> </div> </div> </div>";
	
}, function(input, value, org){
	$.log(org);
	$.log(that);
	
	var $canvas = $(input).closest(".input-objs");
	var that = this;
	var $cta = $canvas.find(".js-add-more");
	
	Form.ui.iao.addRow(that, org.render, $cta);
	
	$cta.click(function(){
		Form.ui.iao.addRow(that, org.render, this, true);
	});
	
	$canvas.on("click", ".js-remove", function(){
		$(this).closest(".js-input-row").remove();
		Form.ui.iao.updateFinalValue($canvas);
	});

	if (value){
		Form.ui.iao.setRows($canvas, that, value);
	}
})



Form.on("input-formula", function(params){
	return "<div class='input-formula'> <div class='hidden'><input type='hidden' class='js-primary' id='js-fx-"+(this.id)+"' name='"+(this._name)+"'/></div> <div class='if-display'> " +Render.render('icon', {icon: "base_fx" }, '')+ ""+(params.placeholder)+" </div> </div>";
});



Form.on("input-rating", function(params){
	var max = parseInt(params.placeholder);
	var opts = '';
	for (var i=1; i<=max; i++){
		opts+="<div class='ir-opt' data-value='"+(i)+"' style='width: "+(100/max)+"%'> <span>"+(i)+"</span> </div>";
	}	
	
	opts = "<div class='ir-opts-list clear-fix'>"+(opts)+"</div>";
	
	return "<div class='input-rating'> <div class='hidden'><input type='hidden' class='js-primary' id='"+(this.id)+"' name='"+(this._name)+"'/></div> <div class='ir-opts'> "+(opts)+" </div> </div>";
}, function(input, value){
	var $box = $(input).closest(".input-rating");
	
	$box.find(".ir-opt").on("click", function(){
		$(this).siblings().removeClass("-selected");
		$(this).addClass("-selected");
		
		var val = $(this).data("value");
		$(input).val(val);
	});
	
	if (value){
		$(input).val(params.value);
		$box.find(".ir-opt").each(function(){
			if (safeEquals($(this).data("value"), value)){
				$(this).addClass("-selected");
			}
		});
	}
});





Form.on("input-editor", function(opts){
	return "<div class='input-editor'> <textarea class='js-primary-editor' id='"+(opts.id)+"' name='"+(opts.name)+"' placeholder='"+(opts.placeholder||opts.name)+"'></textarea> </div>";
	
}, function(input, value){
	var mh=200;
	
	$(input).css("min-height", mh);
	
	UI.editor(input, {
		panel: "bottom",
		minHeight: mh
	});
	
	if (value && AP.config && AP.config.editor=="quill"){
		UI.editorValue(input, Base64.decode(value));
	}
});




Form.on("input-percent", function(opts){
	return "<div class='input-percent-canvas'> <div class='input-percent'> <div class='hidden'><input type='text' id='"+(opts.id)+"' name='"+(opts.name)+"'/></div> <div class='current-update'><b></b>%</div> <div class='input-dragger'></div> </div> <div class='input-percent-extra'>"+(opts.placeholder)+"</div> </div>";
}, function(input, value){
	var $canvas = $(input).closest(".input-percent-canvas");
	var $s = $canvas.find(".input-dragger");
	
	$s.slider({
		value: value,
		range: "min",
		change: function(event, ui){
			var v = ui.value;
			$(input).val(v);
			$canvas.find(".current-update b").html(AP.data.numberFormat(v));
		},
		slide: function(event, ui){
			var v = ui.value;
			$(input).val(v);
			$canvas.find(".current-update b").html(AP.data.numberFormat(v));
		},
		stop: function(event, ui){
			$(input).trigger("change");
		}
	}).trigger("change");
	
	if (isset(value)){
		$canvas.find(".current-update b").html(AP.data.numberFormat(value));
		$(input).val(value);
	}
});





Render.on(["input-percent", "fi-percent"], function(opts){
	return "<div class='input-percent-canvas' "+(this.show('id'))+"> <div class='input-percent'> <div class='hidden'><input type='text' name='"+(this._name)+"'/></div> <div class='current-update'><b></b>%</div> <div class='input-dragger'></div> </div> <div class='input-percent-extra'>"+(this.placeholder||'')+"</div> </div>";
}, function(params){
	var $canvas = $(this);
	var $input = $canvas.find("input");
	var $s = $canvas.find(".input-dragger");
	
	$s.slider({
		value: params.value||'',
		range: "min",
		change: function(event, ui){
			var v = ui.value;
			$input.val(v).trigger("change");
			$canvas.find(".current-update b").html(AP.data.numberFormat(v));
		},
		slide: function(event, ui){
			var v = ui.value;
			$input.val(v).trigger("change");
			$canvas.find(".current-update b").html(AP.data.numberFormat(v));
		},
		stop: function(event, ui){
			$input.trigger("change");
		}
	}).trigger("change");
	
	if ('value' in params){
		$canvas.find(".current-update b").html(AP.data.numberFormat(params.value));
		$input.val(params.value);
	}
});



Render.on("fi-table", function(){
	var headers = Form.ui.table.getHeaders(this.defs||this.placeholder);

	var html = "<div class='input-table "+(this.dark?'-dark':'')+"'> <div class='hidden'> <textarea class='js-primary js-input' id='js-textarea-"+(this.id)+"' name='"+(this._name)+"'></textarea> </div> <div class='visible-custom-table'> "+(Form.ui.table.getTable(headers, this.defs||this.placeholder))+" </div> </div>";

	return "<div class='fi-table' id='"+(this.id)+"'> "+(html)+" </div>";
	
}, function(params, obj){
	var input = $(this).find(".js-primary");
	
	var value = obj.value;
	var headers = Form.ui.table.getHeaders(obj.defs||obj.placeholder);
	var $canvas = $(input).closest(".input-table");

	$canvas.find(".js-add-more").click(function(){
		Form.ui.table.addRow(this, headers);
	});

	$canvas.on("click", ".-remove", function(){
		$(this).closest("tr").remove();
		Form.ui.table.updateFinalValue($canvas.find(".visible-custom-table"));
	});

	if (value){
		Form.ui.table.setRows($canvas, headers, value);
	}
});


Render.on("fi-editor", function(){
	return "<div class='input-editor'> <textarea class='js-input' id='"+(this.id)+"' name='"+(this._name)+"' placeholder='"+(this.placeholder)+"'></textarea> </div>";
	
}, function(params, obj){	
	var mh=200;
	
	$(this).css("min-height", mh);
	
	UI.editor(this, {
		panel: "bottom",
		minHeight: mh
	});
	
	var value = params.value;
	
	if (value && AP.config && AP.config.editor=="quill"){
		UI.editorValue(this, Base64.decode(value));
	}
});




Render.on("fi-rating", function(){
	var max = parseInt(this.placeholder||this.max);
	var opts = '';
	
	for (var i=1; i<=max; i++){
		opts+="<div class='ir-opt' data-value='"+(i)+"' style='width: "+(100/max)+"%'> <span>"+(i)+"</span> </div>";
	}	
	
	opts = "<div class='ir-opts-list clear-fix'>"+(opts)+"</div>";
	
	return "<div class='input-rating'> <div class='hidden'><input type='hidden' class='js-primary js-input' id='"+(this.id)+"' name='"+(this._name)+"'/></div> <div class='ir-opts'> "+(opts)+" </div> </div>";
}, function(params, obj){
	var $input = $(this);
	var $box = $input.closest(".input-rating");
	
	$box.find(".ir-opt").on("click", function(){
		$(this).siblings().removeClass("-selected");
		$(this).addClass("-selected");
		
		var val = $(this).data("value");
		$input.val(val);
	});
	
	if (params.value){
		$input.val(params.value);
		$box.find(".ir-opt").each(function(){
			if (safeEquals($(this).data("value"), params.value)){
				$(this).addClass("-selected");
			}
		});
	}
});




Form.ui.table = new function __FormUITable(){
	
	var _id;
	
	/**
	 * @desc Display a table with configed row_def and encoded values
	 */
	this.display = function(row_def, encoded_values){
		var values = Base64.decode(encoded_values);

		if (!values){
			values = [];
		}else{
			values = AP.json.parse(values);
			if (!values || !AP.data.isArray(values)){
				return encoded_values;
			}
		}

		var headers = this.getHeaders(row_def.placeholder);

		var tw = 0;
		var cells = AP.render(headers, function(e){
			tw += e.w;

			if (e.adaptive_w){
				return "  " +Render.render('cell', {width:e.adaptive_w, fit:1}, ""+(e.name)+"")+ '';
			}

			return "  " +Render.render('cell', {lead:1, fit:1}, ""+(e.name)+"")+ '';
		});

		cells = "  " +Render.render('cell', {width: "45px" , lead:1}, "#")+ " "+(cells)+"";

		var rows = AP.render(values, function(row, index){
			if (!row || !AP.data.isArray(row)){
				return '';
			}

			var row_vals = AP.render(row, function(v, v_index){
				if (v_index >= headers.length){
					return '';
				}

				return "  " +Render.render('cell', {lead:1}, ""+(safe(v))+"")+ '';
			});

			return "  " +Render.render('table_row', {}, '' +Render.render('cell', {index:1, first:1}, '' +Render.render('text_index', {index:index+1}, '')+ '')+ ""+(row_vals)+"")+ '';
		});

		var html = "  " +Render.render('table', {_class: "input-custom-table" , inline:1}, '' +Render.render('table_header', {sm:1}, ""+(cells)+"")+ "<tbody>"+(rows)+"</tbody>")+ "";

		if (tw >5){
			html = "<div class='input-table-master-wrapper scroll-ready' style='width:100%; overflow-y:hidden; overflow-x: auto; padding-bottom:10px;'> <div class='input-table-master relative' style='width: "+(tw*100+45)+"px'> "+(html)+" </div> </div>";
		}

		return html;

	};



	/**
	 * @desc Display a table-struct data in plain view, best for printing layout
	 */
	this.displayPlain = function(row_def, encoded_values){
		var values = Base64.decode(encoded_values);
		if (!values){
			values = [];
		}else{
			values = AP.json.parse(values);

			if (!values || !AP.data.isArray(values)){
				return encoded_values;
			}
		}

		var headers = this.getHeaders(row_def.placeholder);

		var rows = AP.render(values, function(row, row_index){
			if (!row || !AP.data.isArray(row)){
				return '';
			}

			var row_vals = AP.render(row, function(v, v_index){
				if (v_index >= headers.length){
					return '';
				}

				return "<div class='it-row-line'><em>"+(headers[v_index].name)+"</em> "+(safe(v))+"&nbsp;</div>";
			});

			return "<div class='it-row'> <div class='it-index'>"+(AP.data.zeroPrefix(row_index+1))+"</div> <div class='it-row-lines'> "+(row_vals)+" </div> </div>";
		});

		return "<div class='input-table-plain-master'> "+(rows)+" </div>";

	};




	/**
	 * @desc Get the headers from hash/header string
	 */
	this.getHeaders = function(hstring){
		if (hstring.contains(" ") || hstring.contains("--br--")) {
			return getHeadersDeprecated(hstring);
		}
		
		var parts = AP.json.parse(Base64.decode(hstring));
		var headers = [];
		
		if (!parts || !parts.length){
			return getHeadersDeprecated(hstring);
			// return [];
		}
		
		for (var i=0; i<parts.length; i++){
			var p = parts[i];
			var w = p.width||1;
			var opts = null;

			headers.push({
				name: p.name,
				w: w,
				adaptive_w: w*100+"px",
				opts: p.options||null,
				type: p.type
			});
		}

		var tw = 0;
		for (var i=0; i<headers.length; i++){
			tw+=headers[i].w;
		}

		if (tw<=5){
			for (var i=1; i<headers.length; i++){
				headers[i].adaptive_w = (90*headers[i].w/(tw))+"%";
			}

			headers[0].adaptive_w = null;
		}

		return headers;
	};


	this.getTable = function(headers, opts){
		var tw = 0;
		var cells = AP.render(headers, function(e){
			tw += e.w;
			if (e.adaptive_w){
				return "  " +Render.render('cell', {width:e.adaptive_w, fit:1}, ""+(e.name)+"")+ '';
			}

			return "  " +Render.render('cell', {lead:1, fit:1}, ""+(e.name)+"")+ '';
		});

		cells = "  " +Render.render('cell', {width: "40px" , lead:1}, "#")+ " "+(cells)+"";

		var html;

		if (tw >5){
			html = "<div class='input-table-master-wrapper scroll-ready scroll-x' style='width:100%; overflow-y:hidden; padding-bottom:10px;'> <div class='input-table-master relative' style='width: "+(tw*100+40)+"px'> " +Render.render('table', {_class: "input-custom-table" , inline:1}, '' +Render.render('table_header', {sm:1}, ""+(cells)+"")+ "<tbody> </tbody>")+ "<div class='input-add-more'> " +Render.render('label', {icon: "fa plus-circle" , _class: "js-add-more" }, "ThĂªm dĂ²ng má»›i")+ "</div> </div> </div>";
		}else{
			html = "<div class='input-table-master-wrapper'> " +Render.render('table', {_class: "input-custom-table" , inline:1}, '' +Render.render('table_header', {sm:1}, ""+(cells)+"")+ "<tbody> </tbody>")+ "<div class='input-add-more'> " +Render.render('label', {icon: "fa plus-circle" , _class: "js-add-more" }, "ThĂªm dĂ²ng má»›i")+ "</div> </div>";
		}

		return html;

	};


	this.setRows = function($canvas, headers, encoded_values){
		var values = AP.json.parse(Base64.decode(encoded_values));
		if (!values || !AP.data.isArray(values)){
			return;
		}

		var html = AP.render(values, function(e){
			return getRow(headers, e);
		});

		$canvas.find("tbody").html(html);

		rebind($canvas);
		Form.ui.table.updateFinalValue($canvas.find("table"));
	};


	/**
	 * @desc Add a new row
	 */
	this.addRow = function(ref, headers){
		var row = getRow(headers, null);
		var $canvas = $(ref).closest(".input-table");
		$canvas.find("tbody").append(row);
		$canvas.find("tbody tr:last").find(":input").first().focus();
		rebind($canvas);
		
		Form.render("#"+_id);
	};



	this.updateFinalValue = function(ref){
		var $canvas = $(ref).closest(".input-table");
		var values = [];

		$canvas.find("tbody tr").each(function(){
			var r = [];
			$(this).find(":input").each(function(){
				r.push($(this).val());
			});

			values.push(r);
		});

		var fv = JSON.stringify(values);
		fv = Base64.encode(fv);

		$canvas.find(".hidden textarea.js-primary").val(fv);
	};



	function getRow(headers, values){
		_id = AP.uuid();
		
		var html = AP.render(headers, function(e, index){
			var v = '';
			if (values && AP.data.isArray(values) && index < values.length){
				var real_val = values[index];
				if (AP.data.isString(real_val) || AP.data.isInt(real_val) || AP.data.isNumber(real_val)) {
					v = safe(""+real_val+"").replace(/\'/g, "&apos;");
				}
			}

			var role = '';
			if (e.type && e.type == 'number'){
				role = "data-role='int'";
			}
			
			var ip = "<input type='text' "+(role)+"/>";
			
			if (e.opts){
				var opts = AP.render(e.opts, function(v){
					return "<option value='"+(v)+"'>"+(v)+"</option>";
				});

				ip = "<select> <option value=''>--Vui lĂ²ng chá»n--</option> "+(opts)+" </select>"
			}

			return "  " +Render.render('cell', {lead:e.w?1:'', _class: "-fx" }, "<div class='js-ip' data-value='"+(v)+"'>"+(ip)+"</div>")+ '';
		});


		return "  " +Render.render('table_row', {id:_id}, '' +Render.render('cell', {}, "<div class='input-tr-action'> <div class='-index'></div> <div class='-remove hidden' onclick='Remove this row'><span class='-ap icon-ion-android-close'></span></div> </div>")+ ""+(html)+"")+ '';
	};


	function rebind($canvas){
		$canvas.find("tbody tr").each(function(index){
			$(this).find(".-index").html(AP.data.zeroPrefix(index+1));
		});

		$canvas.find("tbody :input").each(function(){
			if ($(this).hasClass("__binded")){
				return;
			}

			bindInput(this);
		});
	};


	function bindInput(ip){
		$(ip).on("change", function(){
			$(ip).closest(".js-ip").data("value", null);
			Form.ui.table.updateFinalValue(this);
		});

		var dv = $(ip).closest(".js-ip").data("value");
		if (dv !=null && dv!="" && typeof dv!="undefined"){
			$(ip).val(dv);
		}
	};
	
	
	
	function getHeadersDeprecated(hstring){
		var parts = hstring.split('--br--');
		parts = ARR.filter(parts, function(e){
			return e && e.length;
		});

		var headers = [];
		for (var i=0; i<parts.length; i++){
			var p = parts[i];
			var w = 1;
			var opts = null;

			p = p.replace(/\(([0-9\.]+)\)$/, function(m, p1){
				w = parseFloat(p1);
				return '';
			});

			p = $.trim(p);

			p = p.replace(/\[(.*)\]$/, function(m, p1){
				opts = p1.split(",");
				opts = ARR.filter(opts, function(e){
					return e && e.length;
				});

				opts = ARR.select(opts, function(e){
					return $.trim(e);
				});

				return '';
			});

			headers.push({
				name: safe(p),
				w: w,
				adaptive_w: w*100+"px",
				opts: opts,
			});
		}

		if (!headers.length){
			return [];
		}
		
		var tw = 0;
		for (var i=0; i<headers.length; i++){
			tw+=headers[i].w;
		}

		if (tw<=5){
			for (var i=1; i<headers.length; i++){
				headers[i].adaptive_w = (90*headers[i].w/(tw))+"%";
			}

			headers[0].adaptive_w = null;
		}

		return headers;
	};



};


Form.ui.ios = new function __FormUIInputObjects(){
	var _id;

	
	this.setRows = function($canvas, ui, values){
		var headers = ui.options;
		
		var html = AP.render(values, function(e){
			return getRow(headers.options, e);
		});

		$canvas.find("tbody").html(html);

		rebind($canvas);
		Form.ui.ios.updateFinalValue($canvas.find("table"));
	};


	/**
	 * @desc Add a new row
	 */
	this.addRow = function(ref, ip, set_focus){
		var row = getRow(ip.options.options, null);
		var $canvas = $(ref).closest(".input-opts-table");
		$canvas.find("tbody").append(row);
		
		if (set_focus){
			$canvas.find("tbody tr:last").find(":input").first().focus();	
		}
		
		rebind($canvas);
		Form.render("#"+_id);
	};



	this.updateFinalValue = function(ref){
		var $canvas = $(ref).closest(".input-objs");
		var values = [];

		$canvas.find("tbody tr").each(function(){
			var r = {};
			$(this).find(":input").each(function(){
				if ($(this).attr("type")=="checkbox"){
					r[$(this).data("name")] = $(this).is(":checked")?1:0;
				}else{
					r[$(this).data("name")] = safe($(this).val());	
				}
			});

			values.push(r);
		});

		var fv = JSON.stringify(values);
		fv = Base64.encode(fv);

		$canvas.find(".hidden .js-primary").val(fv);
	};


	
	function getRow(headers, value){
		if (!headers.length){
			return '';
		}
		
		var html = AP.render(headers, function(e, index){
			var v = '';
			if (value && AP.data.isObject(value) && value[e.name]){
				var real_val = value[e.name];
				
				if (AP.data.isString(real_val) || AP.data.isInt(real_val) || AP.data.isNumber(real_val)){
					v = safe(""+real_val+"").replace(/\'/g, "&apos;");
				}
				
				if (real_val && AP.data.isArray(real_val) && real_val.length){
					v = real_val.join(", ");
				}
			}

			var role = '';
			if (e.role && e.role == 'tag'){
				role = "data-role='tag'";
			}
			
			if (e.role && e.role == 'date'){
				role = "data-role='date'";
			}
			
			if (e.role && e.role == 'int'){
				role = "data-role='int'";
			}
			
			var ip = "<input data-name='"+(e.name)+"' type='text' placeholder='"+(e.placeholder||e.label)+"' "+(role)+"/>";
			
			if (e.type == "select" && e.options){
				var opts = AP.render(e.options, function(opt){
					if (AP.data.isObject(opt)){
						return "<option value='"+(opt.id||opt.value)+"'>"+(opt.name||opt.label)+"</option>";
					}
					return "<option value='"+(opt)+"'>"+(opt)+"</option>";
				});

				ip = "<select data-name='"+(e.name)+"' data-value='"+(v)+"'> "+(opts)+" </select>"
			}

			var width = ""+(e.computed_width)+"%";
			if (index == 0){
				width = '';
			}
			
			return "  " +Render.render('cell', {width:width, _class: "-fx" , lead:1}, "<div class='js-ip' data-value='"+(v)+"'>"+(ip)+"</div>")+ '';
		});

		_id = AP.uuid();

		return "  " +Render.render('table_row', {id:_id}, ""+(html)+" " +Render.render('cell', {width: "40" }, "<div class='io-icon'> " +Render.render('icon', {_class: "js-remove" , html_title: "ÄĂ³ng" , icon: "ap ion-android-close" }, '')+ "</div>")+ '')+ '';
	};


	function rebind($canvas){
		$canvas.find("tbody :input").each(function(){
			if ($(this).hasClass("__binded")){
				return;
			}

			bindInput(this);
		});
		
	};


	function bindInput(ip){
		$(ip).on("change", function(){
			$(ip).closest(".js-ip").data("value", null);
			Form.ui.ios.updateFinalValue(this);
		});

		var dv = $(ip).closest(".js-ip").data("value");
		
		if (dv !==null && dv !== "" && typeof dv!="undefined"){
			$(ip).val(dv);
		}
	};

};








Form.ui.locationPicker = null;

Base.exchange.on("location.pickerv2", function(data){
	Base.api.closeDialog();
	
	var latlng=data.latlng;
	if (!latlng){
		return;
	}
	
	if (!data.name){
		data.name = "("+(latlng[0])+","+(latlng[1])+")";
	}
	
	var id = data.data.id;
	var $p = $("#"+id).parent().parent();
	$p.find(".input-latlng").html("  " +Render.render('icon', {icon: "form_check_fill" , icon_color: "success" }, '')+ "<span class='real-loc'>"+(safe(data.name))+"</span>").addClass("-done");
	
	$p.find(".js-name").val(data.name);
	$p.find(".js-lat").val(data.lat);
	$p.find(".js-lng").val(data.lng);
});


Form.on("input-location", function(opts){
	
	var embed_url = Base.exchange.embedURL({
		data: {
			id: opts.id,
			name: opts.name
		},
		event: "location.pickerv2",
		app: "api",
		endpoint: "loc/choose?event=location.pickerv2&sticky=1"
	});
	
	return "<div class='input-location-canvas'> <div class='input-location'> <div class='hidden'> <input type='text' class='js-name' id='"+(opts.id)+"' name='"+(opts.name)+"'/> <input type='text' class='js-lat' name='"+(opts.name)+"-lat'/> <input type='text' class='js-lng' name='"+(opts.name)+"-lng'/> </div> <div class='input-latlng'> " +Render.render('icon', {icon: "base_marker" , icon_color: "#aaa" }, '')+ "<span class='real-loc'>Please choose a location below</span> </div> </div> <div class='input-location-map'> <iframe src='"+(embed_url)+"' frameborder='0' height='400' width='100%'/> </div> </div>";
}, function(input, value, params){
	
});
var M=new function __M(){
	this.init=function(){
		this.canvas.init();
	};
	
};
 
  

$(document).ready(function(){
	M.drawer.initSwipe();
	setTimeout(function() {window.scrollTo(0, 1)}, 100)
});

AP.sys.on("page.pre.transition", function(data){
	M.drawer.hide();
	M.sidebar.hide();
});


AP.sys.on("page.post.transition", function(data){
	M.drawer.initSwipe();
	$("#body").css("min-height", $(document).height()-$("#header").height()-$("#footer").height());
	M.canvas.fix();
});




M.canvas = new function __MCanvas(){
	this.init=function(){
		if (M.vendor.ms()){
			$(document.body).addClass("-vd-ms");
			$("html").addClass("-vd-ms");
		}
		
		if (M.vendor.bb()){
			$(document.body).addClass("-vd-bb");
		}
		
		this.fix();
	};
	
	this.fix=function(){
		var pt=gh("#header")+gh("#search");
		$("#body").css("padding-top", pt);
		
		setTimeout(function(){
			$("#body").css("min-height", $(document).height()-pt-$("#footer").height()).css("padding-bottom",$("#footer").height());
		}, 500);
	};
	
	
	function gh(selector){
		if (!$(selector).length){
			return 0;
		}
		
		return $(selector).height();
	};
};


M.drawer = new function __Drawer(){
	this.__flag=false;
	
	this.show=function(){
		if (M.drawer.__flag){
			return;
		}
		
		M.drawer.__flag=true;
		
		$("#drawer .mask").hide();
		$("#drawer").show();
		$(document.body).addClass("xo");
		$("#drawer .mask").fadeIn(100);
		$("#drawer .drawer").velocity({left: 0}, {duration: 250, easing: 'easeOutSine', complete: function(){
			M.drawer.__flag=false;
		}}); 
	};
	
	this.hide=function(){
		if (M.drawer.__flag){
			return;
		}
		
		M.drawer.__flag=true;
		$(document.body).removeClass("xo");
		
		$("#drawer .mask").fadeOut(150);
		$("#drawer .drawer").velocity({left: "-100%"}, {duration: 250, easing: 'easeInSine', complete: function(){
			M.drawer.__flag=false;
			$("#drawer").hide();
		}}); 
	};
	
	this.toggle=function(){
		
	};

	this.visible=function(){
		return $("#drawer").is(":visible");
	};
	
	
	this.initSwipe=function(){
		return;
		
		this.__flag=false;
		var mx=$("#body")[0];
		var mc = new Hammer(mx);
		mc.on("swiperight", function(e){
			if (!e.changedPointers.length){
				return;
			}
			var endPoint = e.changedPointers[0].pageX;
		    var distance = e.distance;
		    var origin = endPoint - distance;
		    
		    if (origin>0 && origin<50 && !M.drawer.visible()){
		    	M.drawer.show();
                return false;
		    }
		});
		
	};
	
	function isShow(){
		
	};
};









M.sidebar = new function __MSidebar(){
	this.__flag=false;
	
	this.show=function(){
		if (M.sidebar.__flag){
			return;
		}
		
		M.sidebar.__flag=true;
		
		$("#sidebar .mask").hide();
		$("#sidebar").show();
		$(document.body).addClass("xo");
		$("#sidebar .mask").fadeIn(100);
		
		$("#sidebar .sidebar").velocity({right: 0}, {duration: 250, easing: 'easeOutSine', complete: function(){
			M.sidebar.__flag=false;
		}}); 
	};
	
	this.hide=function(){
		if (M.sidebar.__flag){
			return;
		}
		
		M.sidebar.__flag=true;
		$(document.body).removeClass("xo");
		
		$("#sidebar .mask").fadeOut(150);
		$("#sidebar .sidebar").velocity({right: "-100%"}, {duration: 250, easing: 'easeInSine', complete: function(){
			M.sidebar.__flag=false;
			$("#sidebar").hide();
		}}); 
	};
	
	this.toggle=function(){
		
	};

	this.visible=function(){
		return $("#sidebar").is(":visible");
	};
	
};


M.header=new function __MHeader(){
	this.bindSearch=function(){
		$("#header .js-search").click(function(){
			$("#header").addClass("searching");
			$("#header .hsearch input").focus();
		});
		
		$("#header .hsearch input").val(Query.get("q"));
		if (Query.get("q")){
			$("#header").addClass("searching");
			$("#header .hsearch input").autofocus();
		}
		
		$("#header .hsearch input").enter(function(){
			applySearch();
		});
		
		$("#header .hsearch .submit").click(function(){
			applySearch();
		});
		
		$("#header .hsearch .cancel").click(function(){
			AP.setURLParams({q: null}, true)	
		});
	};
	
	
	function applySearch(){
		var val=purify($("#header .hsearch input").val());
		if (!val || !val.length){
			val=null;
		}
		
		AP.setURLParams({q: val}, true);
		
		if (val==null || !val){
			$("#header").removeClass("searching");
		}
	};
};











M.vendor=new function __MVendor(){
	this.ms=function(){
		if(navigator.userAgent.match(/Windows Phone/i)){
		    return true;
		}

		return false;
	};
	
	this.bb=function(){
		return false;
	};
};


M.render=new function __MRender(){
	this.avatar=function(obj){
	};
	
	this.date=function(ts){
		
	};
	
	this.datetime=function(ts){
		return "<div class='dt-box'>" +
			"<div class='dt-t'>"+AP.time.time("%H:%i", ts)+"</div>" +
			"<div class='dt-w'>"+AP.time.time("%V", ts)+"</div>" +
			"<div class='dt-d'>"+AP.time.time("%d/%m", ts)+"</div>" +
		"</div>";
	};
	
	this.avatar=function(url, size){
		if (!size){
			size=48;
		}
		
		return "<div class='user avatar avatar-"+size+" -circled'><div class='image'><img src='"+AP.thumb(url)+"'/></div></div>";
	}
	
	this.users=function(users, size){
		if (!size){
			size=24;
		}
		
		return AP.render(users, function(e){
			var username=e;
			if (e.username){
				username=e.username;
			}
			
			var u=People.get(username);
			return "<div class='user avatar avatar-"+size+" -circled'><div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div></div>";
		});
	};
};



M.screen=new function __MobileScreen(){
	this.pop=function(id, html){
		if ($("#"+id).length){
			$("#"+id).empty().html(html);
		}else{
			$("<div id='"+id+"' class='__temp mobile-full-screen'>"+html+"</div>").appendTo(document.body);
		}
		
		$(document.body).addClass("xo");
		
		if ($("#"+id+" .screen-tabs").length){
			$("#"+id+" .screen-tabs .tab").click(function(){
				var tab=$(this).data("tab");
				$(this).addClass("active");
				$(this).siblings().removeClass("active");
				
				$("#"+id+" .screen-page").each(function(){
					var ctab=$(this).data("tab");
					if (ctab==tab){
						$(this).addClass("active");
					}else{
						$(this).removeClass("active");
					}
				})
			});
			
			$("#"+id+" .screen-tabs .tab").each(function(){
				if ($(this).data("default")){
					$(this).click();
				}
			})
		}
	};
	
	this.close=function(id){
		$("#"+id).remove();
		$(document.body).removeClass("xo");
	};
};


/*!
 * jQuery UI Touch Punch 0.2.3
 *
 * Copyright 2011â€“2014, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */
!function(a){function f(a,b){if(!(a.originalEvent.touches.length>1)){/**a.preventDefault();*/var c=a.originalEvent.changedTouches[0],d=document.createEvent("MouseEvents");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(d)}}if(a.support.touch="ontouchend"in document,a.support.touch){var e,b=a.ui.mouse.prototype,c=b._mouseInit,d=b._mouseDestroy;b._touchStart=function(a){var b=this;!e&&b._mouseCapture(a.originalEvent.changedTouches[0])&&(e=!0,b._touchMoved=!1,f(a,"mouseover"),f(a,"mousemove"),f(a,"mousedown"))},b._touchMove=function(a){e&&(this._touchMoved=!0,f(a,"mousemove"))},b._touchEnd=function(a){e&&(f(a,"mouseup"),f(a,"mouseout"),this._touchMoved||f(a,"click"),e=!1)},b._mouseInit=function(){var b=this;b.element.bind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),c.call(b)},b._mouseDestroy=function(){var b=this;b.element.unbind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),d.call(b)}}}(jQuery);



AP.rewrite(":mobile/-/([a-zA-Z0-9\-\._]+)", "mobile?action=$1", function(qs){
	if (qs.action=="menu"){
		return M.drawer.show();
	}
});AP.rewrite('task/([0-9]+)', 'taskview?id=$1', function(qs){
	return Task.display(qs.id);
});

AP.rewrite('^milestone/([0-9]+)', 'milestoneview?id=$1', function(qs){
	return Milestone.display(qs.id);
});

AP.rewrite('showtopic/([0-9]+)', 'topicview?id=$1', function(qs){
	return Topic.display.show(qs.id);
});

AP.rewrite('project/tasklist/create', 'project/action/tasklist', function(qs){
	return TaskList.create();
});

AP.rewrite('project/task/create', 'project/action/task', function(qs){
	return Project.tform.dialog();
});

AP.rewrite('projects/tasklist/([a-zA-Z0-9]+)', 'project/tasklist?id=$1', function(qs){
	if (!qs.id){
		return;
	}
	
	return Project.tasklist.display(qs.id);
});


AP.rewrite('myteam/user/([a-zA-Z0-9]+)', 'user?username=$1', function(qs) {
	var url = 'user/' + qs.username;
	var list_params = ["stime", "etime", "project", "group"];
	var f_flag = false;
	var constr = '&';
	for (x in list_params) {
		if (Query.get(list_params[x])) {
			if (!f_flag) {
				f_flag = true;
				constr = '?';
			} else {
				constr = '&';
			}
			url += constr + list_params[x] + '=' + encodeURIComponent(Query.get(list_params[x]));
		}
	}

	return AP.toURL(url);
});


Rewrite.on(":project/-/{action}", function(qs){
	var act = qs.action;

	if (act == "create") {
		return Project.form.create();
	}

	if (act == "import") {
		return Project.form.import();
	}

	if (act == "download.template") {
		AP.toURL(Client.static_url + "/samples/import.projects.xlsx");
	}

	if (act == "update.multi.priority") {
		return Project.manage.updateMultiPriority();
	}
});

Rewrite.on(":team/-/{action}", function(qs){
	var act = qs.action;

	if (act == "create") {
		return Team.form.create();
	}

	if (act == "import") {
		return Team.form.import();
	}

	if (act == "download.template"){
		AP.toURL(Client.static_url + "/samples/import.teams.xlsx");
	}
});

Rewrite.on(":dept/-/{action}", function(qs){
	var act = qs.action;

	if (act == "create") {
		return Dept.create();
	}
});

Rewrite.on(":topic/-/{action}", function(qs){
	var act = qs.action;

	if (act == "create") {
		return Topic.create();
	}
});

Rewrite.on(":tool/-/{action}", function(qs){
	var act = qs.action;

	if (act == "export.tasks") {
		return Tool.export.multipleProjects();
	}

});AP.sys.on("page.pre.transition", function(data){
	$("#ptransit").show();
	loadBar("#ptransit", true);
});

AP.sys.on("page.post.transition", function(data){
	setTimeout(function(){
		loadBar("#ptransit", false);
	},500);
	
	Context.hide();
	Context.gen.hide();
});


AP.sys.on("form.pre.submit", function(selector){
	if (Client.pageData.event && Client.pageData.event.id){
		$(selector).append("<input type='hidden' name='__event' value='"+Client.pageData.event.id+"'/>");
	}
});


AP.adaptive=function(u1, u2){
	return true;
};




function documentInit(){
	AP.initPageData();
	Client.title=document.title;
	
	if (!Client.viewer || !Client.viewer.id){
	}else{
		Layout.start();
	}
};


function nsUpdate(){
};




function ap_update(selector, data){
	$(selector).html(data);
	AP.setContinuousRequest(selector);
	AP.html.init(selector);
};




function reset_page(callback){
	$("#page").children().remove();
	$("#page").empty().html("&nbsp;");
	$(".note-popover").remove();
	$(".date-picker-wrapper").remove();
	
	// SPECIAL FIX
	$("#document").removeClass("dark wbg");
	$("#background").remove();
	TaskDisplay.last_scroll=-1;
	
	// Clear lock
	
	AP.__lock=false;
	Board.data.model=null;
	Board.data.period_by=null;
	
	AP.resetPageData();
	// AP.sys.fire("page.pre.transition");
	
	if (callback){
		callback();
	}
};

function update_page(data){
	$('#master').removeClass();
	$("#document").removeClass("wbg");
	$("#background").remove();
	
	ap_update("#page", data);
	
	window.scrollTo(0,0);
	$("#ap-data").empty();
	
	documentInit();
	
	AP.sys.fire("page.post.transition");
	AP.sys.fire(AP.EVENTS.PAGE_UNLOAD);
	
	
	if (AP.isset('FB')){
		try{
	        FB.XFBML.parse(); 
	    }catch(ex){};	
	}
};










function loadBar(canvas, status){
	if (!status){
		$(canvas).hide();
		$(canvas).data("lock", false);
		stopBar(canvas, 4)
	}else{
		$(canvas).data("lock", true);
		loadBarAnimation(canvas);
	}
};

function stopBar(canvas, len){
	for (var i=0; i<len; i++){
		$(canvas).find('.bar:eq('+i+') .anim').css({width: 0});			
	}
	
	for (var i=0; i<len; i++){
		$(canvas).find('.bar-'+i).appendTo(canvas);
	}
	
	$(canvas).data("ab",0);
}

function loadBarAnimation(canvas){
	var c=['#F03C32','#09A5E3','FFD726','#08D119'];
	var len=c.length;
	
	if (!$(canvas).data('__bars')){
		for (var i=0; i<len; i++){
			$(canvas).append("<div class='bar bar-"+i+"'><div  style='background-color:"+c[i]+"' class='anim'></div></div>");
		}
	}

	$(canvas).data('__bars',1);
	
	$(canvas).find('.bar:eq(0) .anim').show().css("width","100%");
	$(canvas).data('lock', true);
	$(canvas).show();
	
	animateBar(canvas, len);
};

function animateBar(canvas, len){
	var lock=$(canvas).data("lock");
	if (!lock){
		return;
	}
	
	var index=$(canvas).data("ab");
	if (!index){
		index=0;
	}
	index++;
	
	if (index>=len){
		index=0;
		
		for (var i=0; i<len-1; i++){
			$(canvas).find('.bar:eq('+i+') .anim').css({width: 0});			
		}
		$(canvas).find('.bar:last').prependTo(canvas);
		index++;
	}
	

	$(canvas).data("ab",index)
	$(canvas).find('.bar:eq('+index+') .anim').animate({'width':'100%'},800, function(){
		if (!$(canvas).data("lock")){
			stopBar(canvas, 4);
			return;
		}else{
			animateBar(canvas, len);
		}
	});
};// Require Configuration [Required]
AP.config.dialog={};
AP.config.dialog.engine=WTDialogEngine;
AP.config.alertDialogEngine=WTDialogEngine;
AP.config.uploadDialogEngine=UploadDialogEngine;
AP.config.ajaxAlertDialogEngine=WTAjaxDialogEngine;
AP.config.theme=0;
AP.config.editor = "quill";


// Translate error messages [Required]
AP.error.messages=AP.data.assoc()
	.add(AP.error.code.CONFLICT_DATA, "Bad input. Please try again")
	.add(AP.error.code.INVALID_DATA, "Invalid data. Please try again.")
	.add(AP.error.code.INCOMPLETE_DATA, "Your submitted data is incomplete. Please try to complete all required fields.")
	.add(AP.error.code.INVALID_USER, "Authentication error. You may not be able to perform this action.")
	.add(AP.error.code.INVALID_AUTHENTICATION, "Invalid authentication. Please try again.")
	.add(AP.error.code.LOGIN_REQUIRED, "Please login to perform this action.")
	.add(AP.error.code.DB_ERROR, "Unexpected error (1). Please contact us for further information.")
	.add(AP.error.code.SV_ERROR, "Unexpected error (2). Please contact us for further information.")
	.add(AP.error.code.INVALID_PASSWORD, "Invalid password. Please try again.")
	.add(AP.error.code.INVALID_EMAIL, "Invalid or empty email. Please try again.")
	.add(AP.error.code.INVALID_USERNAME, "Invalid username. Please try again.")
	.add(AP.error.code.INVALID_CHARACTER, "Some characters you enter are not allowed. Please try again.")
	.add(AP.error.code.INVALID_CAPTCHA, "Invalid captcha security code. Please try again.")
	.add("BAD_XCODE","Your session was expired. Please refresh the page (press F5) to continue.")
	.add("FORCE_REDIRECT","Your session was expired. Please refresh the page (press F5) to continue.")
	.add("DUPLICATED EMAIL","Email bá»‹ trĂ¹ng láº·p vĂ¬ Ä‘Ă£ Ä‘Äƒng kĂ½ trong há»‡ thá»‘ng trÆ°á»›c Ä‘Ă³.")
	.add("YOU_CANNOT_CREATE_TASK_HERE","Báº¡n khĂ´ng cĂ³ quyá»n táº¡o cĂ´ng viá»‡c má»›i trong dá»± Ă¡n nĂ y")
	.assoc();



AP.pageConfig.init({
	hide_all_subtasks: 0,
	project_subtasks: 'one_level' // ONE LEVEL NESTED, could be {fully_nested, main_task_only}
});


Color.register("review", "#5d3bf5");
Color.register("late", "#f7e015");
Color.register("overdue", "#f54e3b");
Color.register("doing", "#389dd9");
Color.register("todo", "#82c3f5");
Color.register("review", "#751de0");


Color.register("ontrack", "#1fb53a");
Color.register("offtrack", "#edcb21");
Color.register("atrisk", "#c92e2e");

Color.register("canceled", "#a1a1a1");
Color.register("failed", "#4f2d2d");
Color.register("success", "#3b7847");







$(document).ready(function(){
	AP.add('ap-root','ap-temp', 'ap-apps','overlay','alert','ap-data');
	$("<div id='ap-invs'></div>").appendTo(document.body);
	AP.initContinuousRequest();
	AP.setContinuousRequest();
	AP.html.init();
	documentInit();
	
	if (Client.people){
		for (var i=0; i<Client.people.length; i++){
			Client.people[i].value="@"+Client.people[i].username;
			Client.people[i].sub=Client.people[i].first_name+" "+Client.people[i].last_name;
		}
	}
	
});


function mapready(){
	AP.sys.release('mapready');
};Base.config={
	file_preview:1
};SVG.extends({
    night: "<svg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 480 480' style='enable-background:new 0 0 480 480;' xml:space='preserve'><g><g><path d='M459.782,347.328c-4.288-5.28-11.488-7.232-17.824-4.96c-17.76,6.368-37.024,9.632-57.312,9.632c-97.056,0-176-78.976-176-176c0-58.4,28.832-112.768,77.12-145.472c5.472-3.712,8.096-10.4,6.624-16.832S285.638,2.4,279.078,1.44C271.59,0.352,264.134,0,256.646,0c-132.352,0-240,107.648-240,240s107.648,240,240,240c84,0,160.416-42.688,204.352-114.176C464.55,360.032,464.038,352.64,459.782,347.328z'/></g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>",
    sunrise: "<svg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 512 512' style='enable-background:new 0 0 512 512;' xml:space='preserve'><g><g><path d='M496,416H326.624l-59.328-59.328c-6.24-6.24-16.384-6.24-22.624,0L185.376,416H16c-8.832,0-16,7.168-16,16c0,8.832,7.168,16,16,16h176c4.256,0,8.32-1.696,11.328-4.672L256,390.624l52.672,52.672C311.68,446.304,315.744,448,320,448h176c8.832,0,16-7.168,16-16C512,423.168,504.832,416,496,416z'/></g></g><g><g><path d='M256,160c-88.32,0-160,71.68-160,160c0,22.752,4.928,44.352,13.472,64h62.656l49.952-49.952c18.72-18.752,49.152-18.752,67.872,0L339.872,384h62.656C411.072,364.352,416,342.752,416,320C416,231.68,344.32,160,256,160z'/></g></g><g><g><path d='M256,64c-8.832,0-16,7.168-16,16v32c0,8.832,7.168,16,16,16c8.832,0,16-7.168,16-16V80C272,71.168,264.832,64,256,64z'/></g></g><g><g><path d='M48,304H16c-8.832,0-16,7.168-16,16c0,8.832,7.168,16,16,16h32c8.832,0,16-7.168,16-16C64,311.168,56.832,304,48,304z'/></g></g><g><g><path d='M496,304h-32c-8.832,0-16,7.168-16,16c0,8.832,7.168,16,16,16h32c8.832,0,16-7.168,16-16C512,311.168,504.832,304,496,304z'/></g></g><g><g><path d='M120.224,161.6L97.6,139.008c-6.24-6.24-16.384-6.24-22.624,0s-6.24,16.384,0,22.624L97.6,184.224c3.136,3.136,7.232,4.672,11.328,4.672c4.096,0,8.192-1.536,11.296-4.672C126.464,177.984,126.464,167.84,120.224,161.6z'/></g></g><g><g><path d='M437.024,139.008c-6.24-6.24-16.384-6.24-22.624,0L391.776,161.6c-6.24,6.24-6.24,16.384,0,22.624c3.136,3.136,7.232,4.704,11.328,4.704s8.192-1.568,11.328-4.672l22.592-22.624C443.264,155.392,443.264,145.248,437.024,139.008z'/></g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>",
    table: "<svg enable-background='new 0 0 24 24' height='512' viewBox='0 0 24 24' width='512' xmlns='http://www.w3.org/2000/svg'><path d='m21 1h-18c-1.654 0-3 1.346-3 3v16c0 1.654 1.346 3 3 3h18c1.654 0 3-1.346 3-3v-16c0-1.654-1.346-3-3-3z' fill='#cfd8dc'/><path d='m3 1h18c1.657 0 3 1.343 3 3v3.5h-24v-3.5c0-1.657 1.343-3 3-3z' fill='#2196f3'/><g fill='#fff'><path d='m11 12h-3.5v-2.5h3.5z'/><path d='m5.5 12h-3.5v-2.5h3.5z'/><path d='m5.5 14v2.5h-3.5v-2.5z'/><path d='m7.5 14h3.5v2.5h-3.5z'/><path d='m11 18.5v2.5h-3.5v-2.5z'/><path d='m2 20v-1.5h3.5v2.5h-2.5c-.551 0-1-.449-1-1z'/></g><path d='m3 21c-.551 0-1-.449-1-1v-1.5h3.5v2.5zm4.5 0v-2.5h3.5v2.5zm-5.5-4.5v-2.5h3.5v2.5zm5.5 0v-2.5h3.5v2.5zm-5.5-4.5v-2.5h3.5v2.5zm5.5 0v-2.5h3.5v2.5zm-7.5-8v16c0 1.654 1.346 3 3 3h9v-15.5h-12z' fill='#b0bec5'/><path d='m12 1h-9c-1.657 0-3 1.343-3 3v3.5h12z' fill='#1e88e5'/><path d='m11 9.5h-3.5v2.5h3.5z' fill='#dedede'/><path d='m5.5 9.5h-3.5v2.5h3.5z' fill='#dedede'/><path d='m5.5 14h-3.5v2.5h3.5z' fill='#dedede'/><path d='m11 14h-3.5v2.5h3.5z' fill='#dedede'/><path d='m11 18.5h-3.5v2.5h3.5z' fill='#dedede'/><path d='m5.5 18.5h-3.5v1.5c0 .551.449 1 1 1h2.5z' fill='#dedede'/><g fill='#fff'><path d='m13 9.5h3.5v2.5h-3.5z'/><path d='m13 18.5h3.5v2.5h-3.5z'/><path d='m13 14h3.5v2.5h-3.5z'/><path d='m18.5 14h3.5v2.5h-3.5z'/><path d='m18.5 9.5h3.5v2.5h-3.5z'/><path d='m21 21h-2.5v-2.5h3.5v1.5c0 .551-.449 1-1 1z'/></g></svg>",
    report_people: "<svg width='28' height='28' viewBox='0 0 28 28' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M14 14C16.8995 14 19.25 11.6495 19.25 8.75C19.25 5.85051 16.8995 3.5 14 3.5C11.1005 3.5 8.75 5.85051 8.75 8.75C8.75 11.6495 11.1005 14 14 14Z' fill='black'/><path d='M14 15.75C8.19875 15.75 3.5 18.0985 3.5 21V24.5H24.5V21C24.5 18.0985 19.8013 15.75 14 15.75Z' fill='black'/></svg>",
    report_download: "<svg width='12' height='12' viewBox='0 0 12 12' xmlns='http://www.w3.org/2000/svg'><path fill-rule='evenodd' clip-rule='evenodd' d='M0.580645 8.3727C0.259964 8.3727 -2.8035e-08 8.63272 0 8.95335L1.49516e-07 10.6636C2.14039e-07 11.4017 0.606583 12 1.35484 12H10.6451C11.3934 12 12 11.4017 12 10.6636V8.95335C12 8.63272 11.74 8.3727 11.4193 8.3727C11.0986 8.3727 10.8387 8.63272 10.8387 8.95335V10.6636C10.8387 10.7691 10.7521 10.8545 10.6451 10.8545H1.35484C1.24795 10.8545 1.16129 10.7691 1.16129 10.6636V8.95335C1.16129 8.63272 0.901328 8.3727 0.580645 8.3727ZM8.70833 4.44793L6.58064 6.33675V0L5.41936 1.01523e-07V6.33675L3.29166 4.44793L2.5148 5.29934L5.61157 8.0484C5.83316 8.24512 6.16684 8.24512 6.38843 8.0484L9.48518 5.29934L8.70833 4.44793Z' /></svg>",
  
});




SVG.edges({
	box_empty: "<svg xmlns='http://www.w3.org/2000/svg' height='16' viewBox='0 0 16 16' width='16'><g stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10'><path d='M14.5 12.5h-13v-5l3-4h7l3 4z'></path><path d='M1.5 7.5h4v2h5v-2h4'></path></g></svg>",
	task: "<svg xmlns='http://www.w3.org/2000/svg' height='16' viewBox='0 0 16 16' width='16'><g stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10'><path d='M1.5 1.5h5v5h-5zM9.5 1.5h5v5h-5zM1.5 9.5h5v5h-5zM9.5 9.5h5v5h-5z'></path></g></svg>",
    report_project: "<svg xmlns='http://www.w3.org/2000/svg' height='16' viewBox='0 0 16 16' width='16'><g stroke-linecap='round' stroke-linejoin='round' stroke-miterlimit='10'><path d='M1.5 1.5h5v5h-5zM9.5 1.5h5v5h-5zM1.5 9.5h5v5h-5zM9.5 9.5h5v5h-5z'></path></g></svg>"
});var Layout= new function __Layout(){
	this.init=function(){
		Layout.scrollable('.scrollable');
		
		$(window).blur(function(){
			AP.fire("PAGE.UNFOCUS");
		});
		
		$(window).focus(function(){
			AP.fire("PAGE.FOCUS");
		});
		
		$("#pagescroll > .scrollin").on("scroll", function(){
			var h=$(this)[0].scrollHeight-$(this).scrollTop()-$(this).outerHeight();
			if (h<=50){
				AP.fire("PAGE.OVERSCROLL");
			}
			
			AP.fire("PAGE.SCROLL", [$(this).scrollTop(), $(this)[0].scrollHeight]);
		});
		
		AP.html.resize(function(){
			Layout.checkWidth();
		}, true);
		
		
		AP.sys.fire("system.init");
		
		var opt=Base.pref().get("collapse");
		if (opt){
			$(document.body).addClass("screen-full");
		}
	};
	
	
	this.checkWidth=function(){
		$("#document").removeClass("screen-hd screen-sd screen-md screen-ld");
		
		if ($(window).width()<1100){
			$("#document").addClass("screen-ld");
		}else if ($(window).width()<1280){
			$("#document").addClass("screen-md");
		}else if ($(window).width()<1500){
			$("#document").addClass("screen-sd");
		}else{
			$("#document").addClass("screen-hd");
		}
		
	};
	
	
	this.start=function(){
		if (mobile()){
			$("#document").height($(window).height());
			$(document.body).removeClass();
		}
		
		Layout.scrollable('.scrollable');
		$("#page").removeClass();
		
		this.checkWidth();
		$("#document").removeClass('extented');
		$("#floatview").empty().hide();
		
		
		// this.startCountdown("#document");
//		AP.html.resize(function(){
//			if ($("#page .display.-double").length){
//				$("#page .display.-double").css("min-height", $(window).height()-48);
//				var w=$("#page").width();
//				if (w>1370){
//					$("#page .display.-double").addClass("-equal");
//				}else{
//					$("#page .display.-double").removeClass("-equal");
//				}	
//			}
//		});
		
		AP.sys.fire("system.start");
		if (mobile()){
			$("#project-sidebar-canvas").remove();
			TaskDisplay.close();
		}else{
			TaskDisplay.close();
			Topic.display.close();
		}
		
	};
	
	
	
	this.setColor=function(color){
		$("#document").removeClass().addClass("document-"+color);
	};


	this.ext=function(){
		$(document.body).toggleClass("screen-full");
			
		if ($(document.body).hasClass("screen-full")){
			Base.pref().set("collapse", 1);
		}else{
			Base.pref().set("collapse", 0);
		}
	};
	
	
	this.scrollable=function(box){
		if (Client.native){
			return;
		}
		
		$(box).each(function(){
			if ($(this).hasClass('__set')){
				return;
			}
			
			if (mobile()){
				$(this).addClass("scroll-y");
				return;
			}
			
			
			$(this).addClass('__set');
			$(this).wrapInner("<div class='scrollin absolute'></div>");
			$(this).find(".scrollin").css({"right":-$.sbWidth(), top:0, left:0, bottom:0});
			AP.scrollBar($(this).find('.scrollin')).init();
		});
	};
	
	
	this.updateScroll=function(canvas){
		if (Client.native){
			return;
		}
		
		$(canvas).find(".scrollin").each(function(){
			$(this).css({"right":-$.sbWidth(), top:0, left:0, bottom:0});
			$(this).scroll();
		});
	};
	
	
	this.scrollDown=function(box){
		var h=$(".__apscrollbar_wrap", box).height();
		$(".scrollin", box).animate({scrollTop: h}, 1000);
	};
	
	this.scrollTo=function(box, offset, anim_time){
		if (!offset){
			offset=0;
		}
		if (typeof anim_time=="undefined"){
			anim_time=500;
		}
		
		var $box=$(box);
		if (!$box.length){
			return;
		}
		
		var $p=$box.closest('.scrollin');
		var h=$box.position().top;
		$p.animate({scrollTop: h-offset}, anim_time);
	};

	
	
	this.scrollTop=function(box){
		if (!box){
			$("#pagescroll > .scrollin").animate({scrollTop: 0}, 500);
			return;
		}
		var $p=$(box).closest('.scrollin');
		$p.animate({scrollTop: 0}, 500);
	};
	
	
	this.hideSide=function(){
		$('#appdialog').hide();
	};
	
	
	this.bcanvas=function(){
		$('#appdialog').hide();
		$("#bcanvas").show();
		$("#bcanvas .full").hide();
		// $("#bside").css("height", $("#bside").parent().height());
		Layout.updateScroll("#bcanvas");
	};
};var BC=new function __BC(){
	this.title=function(title){
		$("#bcanvas .__title").html(title);
	};
	
	this.side=function(side){
		$("#bcanvas .__side").html(side);
	};
	
	
	this.main=function(content){
		$("#bcanvas .__canvas").html(content);
	};
	
	this.show=function(){
		$("#bcanvas").show().removeClass("__simple").addClass("__ontop");
		this.normal();
		
		if (!$("#bcanvas").hasClass('__init')){
			$("#bcanvas").addClass('__init');
			Layout.scrollable("#bside");
		}else{
			$("#bside").find(".scrollin").height("100%").css("width", $("#bside").width()+$.sbWidth());
		}
	};
	
	
	this.noSide=function(){
		$("#bcanvas").show().addClass("__simple");
	};
	
	this.hide=function(){
		$("#bcanvas").find(".__canvas").html("");
		$("#bcanvas").find(".__side").html("");
		$("#bcanvas").find(".__postbottom").html("");
		$("#bcanvas").fadeOut(200);
	};
	
	
	
	this.extend=function(){
		$("#bcanvas").addClass("extended");
	};
	
	this.unextend=function(){
		$("#bcanvas").removeClass("extended");
	};
	
	this.normal=function(){
		$("#bcanvas").removeClass("extended");
	};
};




BC.ui=new function __BCUIx(){
	this.followers=function(obj){
		if (obj.followers.length<=6){
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}else{
			return "<div class='list users'> <div class='li-title'>Followers</div> <div class='items'>"+AP.render(obj.followers, followerHTML)+"</div></div>";
		}
	};
	
	
	
	
	function followerHTML(user){
		return "<div class='li url' data-username='"+user.username+"'><div class='avatar avatar-40 rounded xo'>" +
				"<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
			"</div></div>";
	}
};var Menu = new function __Menu() {

	this.init = function() {

		this.build();
		
		$("#navigator .js-menu").each(function() {

			var type = $(this).data("name");
			
			var collapse = AP.log.getValue("collapse-menu-" + type);
			if (collapse == 'open') {
				collapse = '';
				$(this).find(".boards").css({"display": "block"});
			}

			if (collapse == 'close') {
				collapse = 'collapsed';
				$(this).find(".boards").css({"display": "none"});
			}

			$(this).addClass(collapse);
		});

		AP.sys.on("system.start", function() {
			focus();
		});
		
		$("#navigator .box .title .label").click(function() {

			var $box = $(this).closest(".box");
			var key = purifyStrict($box.data("name"));
			
			var f = '';
			if ($box.hasClass("collapsed")) {
				$box.removeClass("collapsed");
				$box.find(".boards").slideDown(200);
				var f = 'open';
			} else {
				$box.addClass("collapsed");
				$box.find(".boards").slideUp(200);
				var f = 'close';
			}

			AP.log.setValue("collapse-menu-" + key, f);
		});
	};


	this.bindSearch = function() {

		var ps = Client.projects.slice(0);
		for (var i = 0; i < ps.length; i++) {
			ps[i].value = ps[i].keywords;
		}

		$("#js-proj-menusearch").livesearch(ps, {
			render: function(e) {
				return "<a>"+e.name+"</a>";
			},
			select: function(e) {
				AP.toURL(e.path);
				setTimeout(function() {
					$("#js-proj-menusearch").val("");
				}, 200);
			},
			filter: function(q, e) {
			}
		});
	};
	
	
	this.build = function() {

		$("#js-fav-projects").html(AP.render(Client.projects, function(e) {
			if (UI.fav.isFav(e.id, Client.favs)) {
				return getHTML(e);
			}

			return "";
		}));

		var depts = getDepts(Client.projects, true);
		$("#js-x-projects").html(renderDepts(depts));
		
		focus();
		
		$("#js-x-projects").sortable2({
			axis: 'y',
			items: '.box',
			handle: '.title .label',
			stop: function(event, ui) {
				saveDeptOrders();
			}
		});
		
		$("#js-x-projects .boards").each(function() {
			$(this).sortable2({
				axis: 'y',
				items: '.li',
				stop: function(event, ui) {
					var prev_id = 0;
					var $prev = $(ui.item).prev();
					if ($prev.length) {
						prev_id = $prev.data("id");
					}
					
					saveProjectOrder($(ui.item).data("id"), prev_id);
				}
			});
		});
		
		Base.url2a("#navigator");
	};

	
	function getDepts(projects) {

		projects = AP.array.uniqueObjects(projects);
		var depts = {"none": {"label":"ChÆ°a phĂ¢n loáº¡i", "id": 0, items: []}, "starred": {"label":"ÄĂ¡nh dáº¥u", "id": 1000000, items: []}};
		
		for (var i = 0; i < projects.length; i++) {
			if (UI.fav.isFav(projects[i].id, Client.favs)) {
				depts["starred"].items.push(projects[i]);
				continue;
			}

			var dept_id = projects[i].dept_id;
			var dept = null;
			
			if (parseInt(dept_id)) {
				dept = Dept.fromContext(dept_id);	
			}
			
			if (!dept) {
				depts["none"].items.push(projects[i]);
			} else {
				if (depts["d-"+dept.id]) {
					depts["d-"+dept.id].items.push(projects[i]);
				} else {
					depts["d-"+dept.id] = {label: dept.name, id: dept.id, items: [projects[i]], dept: dept};
				}
			}
		}

		var r = [];
		for (var key in depts) {
			depts[key].key = key;
			depts[key].__order = 1 + AP.array.indexOf(Client.dept_orders, depts[key], function(e, f) {
				return parseInt(e) == parseInt(f.id);
			});
			
			r.push(depts[key]);
		}

		r.sort(function(e, f) {
			if (e.__order && f.__order) {
				return e.__order - f.__order;
			}
			
			if (!e.__order && !f.__order) {
				return f.id - e.id;
			}
			
			if (!f.__order) {
				return -1;
			}
			
			if (!e.__order) {
				return 1;
			}
		});
		
		return r;
	};
	
	
	function renderDepts(groups) {

		return AP.render(groups, function(e) {

			if (e.key == "starred") {
				return "";
			}
			
			var key = purifyStrict(e.key);

			var items = AP.render(e.items, function(e) {
				return getHTML(e);
			});
			
			return "<div class='box js-menu' data-name='"+(key)+"' data-id='"+(e.id)+"'> <div class='title'> <div class='label ap-xdot' title='"+(e.label)+"'>"+(e.label)+"</div> <div class='icons'> <div class='icon js-project-create' onclick='Project.create({category: \""+(e.id)+"\"});'> <span class='-ap icon-uniF100'></span> </div> </div> </div> <div class='boards'>"+(items)+"</div> </div>";
		});
	};
	

	function getHTML(e) {

		if (parseInt(e.status) == -1) {
			return  "";
		}

		// var icon = "<span class='image'><img src='"+(Client.image_url)+"/icons/project.png'/></span>";
		var icon = "<span class='icon-project -bg-alt"+(e.color)+"'><em>"+(purifyStrict(e.path).charAt(0))+"</em></span>";
		
		if (isFav(e.id)) {
			// icon="<span class='image'><img src='"+(Client.image_url)+"/icons/star.png'/></span>"; 
		}
		
		if (e.metatype == "team") {
			// icon="<span class='image'><img src='"+(Client.image_url)+"/icons/team.png'/></span>";
			icon = "<span class='icon-team -bg-alt"+(e.color)+"'><em>"+(purifyStrict(e.path).charAt(0))+"</em></span>";
		}

		if (parseInt(e.icon)) {
			icon = "<span class='image'><img src='"+(Client.share_url)+"/fav_icons/"+(e.icon)+".png'/></span>";
		}
		
		return "<div class='li url proj proj-"+(e.id)+"' data-id='"+(e.id)+"' title='"+(e.name)+"' data-url='"+(e.path)+"' data-href='"+(e.path)+"' data-kw='"+(e.keywords)+"'> <span class='sorder' title='Sort project/team'></span> <span class='icon'>"+(icon)+"</span> <span class='name ap-xdot'>"+(e.name)+"</span> </div>";
	};


	function focus() {
		if (Client.pageData.context) {
			$("#navigator .li").setActive(".proj-" + Client.pageData.context.id);
			return;
		}

		$("#navigator .proj").removeClass("active");
		$("#navigator .li").setActiveURL({fallback: "tasks"});
	};

	
	function isFav(id) {
		if (UI.fav.isFav(id, Client.favs)) {
			return true;
		}
		
		return false;
	};
	
	
	function saveDeptOrders() {

		var r = [];

		$("#js-x-projects .box").each(function() {
			var id = $(this).data("id");
			if (id && parseInt(id)) {
				r.push(id);
			}
		});
		
		UI.ajaxShow();
		AP.post("api/pref/dept.orders", {orders: r.join(",")}, function(code) {
			UI.ajaxHide();
			
			if (!code.good()) {
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully");
		});
	};
	
	
	/**
	 * @desc Setting position of a project
	 */
	function saveProjectOrder(project_id, prev_id) {
		UI.ajaxShow();
		AP.post("api/project/reorder", {project_id: project_id, prev_id:prev_id, sorter: "prev"}, function(code) {
			UI.ajaxHide();
			
			if (!code.good()) {
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully");
		});
	};
	
};














var Topic = new function __Base_Topic(){
	this.get=function(topic_id, callback){
		UI.ajaxShow();
		AP.post("api/base/topic/get", {topic_id: topic_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.topic);
		});
	};
	
	
	/**
	 * @desc Get all topics of a particular user
	 */
	this.getPage=function(page_id, callback){
		if (!Channel.channel){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/topic/page", {channel_id: Channel.channel.id, page: page_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.topics);
		});
	};
	
	
	
	this.create=function(origin){
		if (!origin){
			origin=Client.pageData.context;
		}
		
		if (!origin){
			Project.pick(function(project){
				createTopicForm(project);	
			}, "Select a team/project");
		}else{
			createTopicForm(origin);
		}
	};
	
	
	
	this.submit=function(ref){
		AP.ajaxShow();
		Form.submitFrom(ref, function(code){
			AP.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// AP.toURL(code.topic.link);
			AP.xRefresh();
		});
	};
	

	
	this.url=function(topic){
		return "r/topic/"+topic.channel_id+"/"+topic.id;
	};
	
	
	this.burl=function(box){
		return "r/topicbox/"+box.channel_id+"/"+box.id;
	};
	
	this.extendEditor = function(ref){
        $(ref).hide();
        $('#topic-editor-wrapper').find('.trumbowyg-box').attr('style', 'min-height: 500px');
        $('#topic-editor-wrapper').find('.trumbowyg-editor').attr('style', 'min-height: 500px');
    };
    
    
    
    
    function createTopicForm(origin){
        for (var i=0; i<origin.owners.length; i++){
            if (origin.owners[i].username == Client.viewer.username) {
                var isOwners = true;
            }
        }

        content_html = '';
        if (isOwners) {
            var content_html = "<h6>Gá»­i ná»™i dung tháº£o luáº­n qua email</h6>" +
                "<select name='sendemail' id='report-via-email'>" +
                "<option value='1'>CĂ³</option>" +
                "<option value='0' selected>KhĂ´ng</option></select>";
        }

        var tracking_topic_created = "";
        if (origin.metatype == "project") {
			tracking_topic_created = "data-feature='wework:wework_project_topic_created:project'";
		} else if (origin.metatype == "team") {
			tracking_topic_created = "data-feature='wework:wework_team_topic_created:project'";
		} else if (origin.metatype == "private") {
			tracking_topic_created = "data-feature='wework:wework_private_topic_created:project'";
		}

    	var html="<div class='-close -wrap' onclick='AP.closeDialog(this);'></div> <h2>ThĂªm tháº£o luáº­n má»›i</h2>" +
		"<p>Tháº£o luáº­n (topic) giĂºp báº¡n vĂ  Ä‘á»“ng nghiá»‡p cĂ¹ng bĂ n vá» má»™t váº¥n Ä‘á» chuyĂªn sĂ¢u. Báº¡n cĂ³ thá»ƒ trao Ä‘á»•i, bĂ¬nh luáº­n, thĂªm files trong má»—i tháº£o luáº­n nĂ y. &mdash; <em>"+origin.name+"</em></p>" +
		"<form action='api/base/topic/create' id='topic-create-fly'>" +
		"	<input type='hidden' name='id' value='"+origin.id+"'/>" +
		"	<input type='hidden' name='token' value='"+origin.token+"'/>" +
			"<h6>TiĂªu Ä‘á» tháº£o luáº­n</h6>" +
			"<input type='text' name='name' placeholder='TĂªn tháº£o luáº­n' />" +
            "<h6>NgÆ°á»i theo dĂµi</h6>" +
            "<input type='text' name='followers' data-role='tag' placeholder='GĂµ @ Ä‘á»ƒ báº¯t Ä‘áº§u tag ngÆ°á»i theo dĂµi' id='topic-create-tagging'/>" +
			// "<h6>Chá»§ Ä‘á»</h6>" +
			// "<select name='cat_id' id='topic-cat_id'></select>" +
            content_html +
			"<h6>Ná»™i dung tháº£o luáº­n <!--<span class='right normal a std ap-f13' onclick='Base.topic.extendEditor(this);'>Extend editor</span>--></h6>" +
			"<div class='textarea relative stroked' id='topic-editor-wrapper'><textarea name='content' placeholder='MĂ´ táº£ ngáº¯n' id='topic-create-content' style='height:100px'></textarea></div>" +
			"<div class='buttons -two'>" +
			"	<div class='button -first -passive-2 -rounded' onclick='AP.closeDialog(this);'>Há»§y</div>" +
			"	<div class='button -second -success -rounded url' onclick='Topic.submit(this);'" + tracking_topic_created + ">Táº¡o tháº£o luáº­n má»›i</div>" +
			"</div>" +
		"</form>" +
		"";


		AP.customDialog(html).closable(false)
			.width(700)
			.show();
		
		Tag.user("#topic-create-tagging", Client.people);
		$("#topic-create-fly input[name=name]").focus();
		UI.editor("#topic-editor-wrapper textarea",{
			fit: true,
			border: true,
			pannel: 'bottom'
		});
		
		$("#topic-cat_id").html("<option value='0'>ChÆ°a phĂ¢n loáº¡i</option>"+AP.render(Client.pageData.boxes, function(e){
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		}));
    };
};


Topic.fav=new function __TopicFav(){
    this.toggle = function(ref) {
        var id=$(ref).data("topic");
        UI.fav.update("api/base/topic/fav", {
            target: {id: id},
            list: [],
        }, function(fav, list, code){
            Client.pageData.favs=list;
            AP.xRefresh();
        });

        return;
    };

    this.isFav=function(id){
        return UI.fav.isFav(id, Client.pageData.favs);
    };

};



Topic.display=new function __BaseTopicDisplay(){
	this.visible=function(){
		return $("#topic-display").length && $("#topic-display").is(":visible");
	};
	
	this.show=function(topic_id){
		// project-sidebar
		
		initCanvas();
		if (TaskDisplay.visible()){
			TaskDisplay.close();
		}
		$("#project-master").addClass("showing-task");
		$("#base-canvas").addClass("showing-task");
		
		AP.loadInlineURL("discussions/topic/"+topic_id,{}, "#project-sidebar", {
			start: function(){
				$("#project-sidebar-canvas").show();
			},
			end: function(code){
				AP.setURLParams({"topic": topic_id});
				$("#topics .item").setActive(".topic-"+topic_id);
				if (mobile()){
					$(document.body).removeClass("xo");	
				}
			}
		});
		
//		Topic.get(topic_id, function(topic){
		
//		});
	};
	
	this.close=function(){
		$(document.body).removeClass("xo");
		$("#project-sidebar-canvas").remove();
		$("#project-master").removeClass("showing-task");
		$("#base-canvas").removeClass("showing-task");
		
		AP.setURLParams({topic: null});
		$("#topics .item").removeClass("active");
	};
	
	
	this.update=function(topic){
		Client.tempData.topic=topic;
		$("#topic-main").html(getMain(topic));
	};
	
	/**
	 * @desc Render a topic display
	 */
	this.render = function(topic) {

		$("#topic-display").html("<div id='topic-main'>"+(getMain(topic))+"</div> <div id='topic-followers'></div> <div id='topic-posts'></div>").addClass("scroll-y forced-scroll");
		
		Follow.auto("#topic-followers",{
			followers: topic.followers, 
			owners: [topic.username],
			users: Project.getPeople(Project.inspect()),
			endpoint: "api/base/topic/follow",
			data: {
				topic_id: Client.tempData.topic.id,
				topic_token: Client.tempData.topic.token
			}
		});
		
		
		var ns=Project.getLocal(topic.ns_id);
		if (ns){
			$("#js-topic-nav").html("" +
				"	<span class='-ap icon-home'></span>&nbsp; " +
				"	<span class='item url' data-url='"+ns.path+"'>"+ns.name+"</span>" +
				"	&nbsp; <span class='r'><span class='-ap icon-triangle-right'></span></span> &nbsp;" +
				"	<span class='item url' data-url='"+ns.path+"/discussions'>Tháº£o luáº­n</span>" +
			"");
		}
	};
	
	
	
	function initCanvas(){
		if (mobile()){
			$(document.body).addClass("xo");
			
			if (!$("#project-sidebar").length){
				$("#page").before("<div id='project-sidebar-canvas' class='hidden'>" +
					"<div class='scrollable' data-autoscroll='1' data-autohide='1'>" +
						"<div class='project-sidebar-close' onclick='Topic.display.close();'><span class='-ap icon-close'></span></div>" +
						"<div id='project-sidebar'></div>" +
					"</div" +
				"</div>");
				Layout.scrollable("#project-sidebar-canvas .scrollable");
			}
			
			return;
		}
		
		if ($("#project-master").length){
			if (!$("#project-sidebar").length){
				$("#project-master").before("<div id='project-sidebar-canvas' class='hidden'>" +
						"<div id='project-sidebar'></div>" +
				"</div>");
				// Layout.scrollable("#project-sidebar-canvas .scrollable");
			}
		}
		
		if ($("#base-canvas").length){
			if (!$("#project-sidebar").length){
				$("#base-canvas").before("<div id='project-sidebar-canvas' class='hidden'>" +
					"<div id='project-sidebar'></div>" +
				"</div>");
				// Layout.scrollable("#project-sidebar-canvas .scrollable");
			}
		}
	};
	
	
	function getMain(topic){
		var u=People.get(topic.username);
		
		return "<div class='canvas'>" +
		"	<div class='title'><span class='url' data-xurl='showtopic/"+topic.id+"'>"+topic.name+"</span></div>" +
		"	<div class='info'>Táº¡o bá»Ÿi <span class='url' data-username='"+u.username+"'>"+u.name+"</span> lĂºc "+AP.time.ago(topic.since)+"</div>" +
		"	<div class='content text-editor'>"+topic.content+"</div>" +
		"	<div class='files'>"+getFiles(topic.files)+"</div>" +
		"</div>";
	};
	
	
	
	function getFiles(files){
		if (!files || !files.length){
			return "";
		}
		
		return AP.render(files, function(e){
			return getFile(e);
		});
	};
	
	
	function getFile(e){
		var icon=UI.file.icon(e.name);
		var url=e.url;
		return "<div class='file' id='"+e.id+"'>" +
				"	<div class='ficon'><img src='"+Client.share_url+"/mimex/"+icon+".png'/></div>" +
				"	<div class='fname'><span onclick=\"Base.file.preview('"+url+"');\">"+e.name+"</span></div>" +
				"	<div class='finfo'>@"+e.username+" &middot; "+AP.time.ago(e.since)+" &middot; "+UI.file.kb(e.size)+"</div>" +
				"	<div class='actions'>" +
				"		<span class='action' onclick=\"Topic.manage.removeFile('"+e.id+"');\">" +
				"			<span class='-ap icon-uniF11F' title='XĂ³a file'></span>" +
				"		</span>" +
				"   </div>" +
			"</div>";
	};
	
	
};


Topic.board=new function __BaseTopicBoard(){
	this.display=function(){
		var favorite = '';	
		var normal = '';
		for (var i=0; i<Client.pageData.topics.length; i++){
			var t=Client.pageData.topics[i];
			if (Topic.fav.isFav(t.id, Client.pageData.favs)){
				favorite += render(t);
			} else {
				normal += render(t);
			}
		}

		var html = favorite + normal;
		$("#topics").append(html);
		
		if (Query.get("topic")){
			Topic.display.show(Query.get("topic"));
		}
	};
	
	
	this.initSorter=function(){
		$("#js-topic-sort .li").click(function(){
			AP.setURLParams({sort: $(this).data("sort")}, true);
		}).each(function(){
			var q=Query.get("sort");
			var cq=$(this).data("sort");
			
			if ((q && cq && q==cq) || (!q && cq=="std")){
				$(this).addClass("selected");
				$(this).siblings().removeClass("selected");
			}else{
				
			}
		});
	};
	
	
	
	function render(topic){
		var tags=[];
		
		var project=Project.getLocal(topic.ns_id);
		if (!project){
			return "";
		}
		
		if (!Client.pageData.context){
			tags.push({name: project.name, url: project.path+"/discussions", style: "tag-alt"+project.color+"-more"})
		}
		
		var u=People.get(topic.username);
		var preview=safe(topic.overview);
		if (!preview || !preview.length){
			preview="No preview available";
		}
		
		var tags_html=AP.render(tags, function(e){
			return "<span class='tag "+e.style+" url' data-url='"+e.url+"'>"+e.name+"</span>";
		});
		
		if (tags_html && tags_html.length){
			tags_html+="<span class='sep'></span>";
		}

		var star_icon = "<div class='star url' data-topic='"+topic.id+"' data-xurl='action/"+topic.id+"/topicstar' title='ÄĂ¡nh dáº¥u Æ°u tiĂªn'><span class='-ap icon-uniF186'></span></div>";
		if (Topic.fav.isFav(topic.id, Client.pageData.favs)){
			star_icon = "<div class='star -star url' data-topic='"+topic.id+"' data-xurl='action/"+topic.id+"/topicstar' title='ÄĂ¡nh dáº¥u Æ°u tiĂªn'><span class='-ap icon-star-full'></span></div>";
		}
		
		return "<div class='item -topic topic-"+topic.id+"'>" +
			"<div class='key'>" +
			"	<div class='avatar'><img src='"+AP.thumb(u.gavatar)+"'></div>" +
			"</div>" +
			"<div class='name'>" +
			"	<span class='url' data-url='showtopic/"+topic.id+"'>"+topic.name+"</span>" +
			"</div>" +
			"<div class='content'>"+preview+"</div>" +
			"<div class='info ap-xdot'>" +
				tags_html +
			"	<span class='url username' data-username='"+u.username+"'>"+u.name+"</span> " +
			"	<span class='sep'></span>" +
			"	<span class=''><span class='-ap icon-bubble3'></span>&nbsp; "+topic.stats.total+" tháº£o luáº­n</span>" +
			"	<span class='sep'></span>" +
			"	Created "+AP.time.ago(topic.since)+" &middot; " +
			"	Last updated "+AP.time.ago(topic.last_update)+
			"</div>" +
			"<div class='side'>" +
			"	<div class='box' data-box_id='{$topic->box_id}'></div>" +
			"</div>" +
			"<div class='followers'>" +
			"	<div class='label'></div>" +
			"	<div class='users clear-fix'>"+getFollowers(topic)+"</div>" + star_icon +
			"</div></div>";
	};

	function getFollowers(topic){
		var total = topic.followers.length;
		var html = "";
		
		for (i = 0; i < topic.followers.length; i++){
			var u=People.get(topic.followers[i].username);
			if (i < 3) {
				html += "<div class='avatar avatar-24 -circled url' data-username='"+topic.followers[i].username+"'>" +
					"<div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div>"+
					"</div>";
			}
		}

		if (i < 3){
			return html;
		}

		return html + "<div class='avatar avatar-24 -circled -infow'>" +
			"<span class='-infobox -up -w200'><span class='-box block normal'>"+(total - 2)+" ngÆ°á»i khĂ¡c</span></span>" +
			"<div class='more'><span>"+(total - 2)+"</span></div>" +
			"</div>";

	};
};


Topic.manage=new function __TopicManager(){
	this.remove=function(){
		var topic=Client.tempData.topic;
		if (!topic){
			return;
		}
		
		AP.confirm("Are you sure that you want to remove this topic?", function(){
			UI.ajaxShow();
			AP.post("api/base/topic/remove",{topic_id: topic.id}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				if (Client.pageData.context){
					AP.toURL(Client.pageData.context.path+"/discussions");
				}else{
					AP.toURL("wework/discussions");
				}
			});
		});
	};

    this.removeFile=function(id){
        var topic=Client.tempData.topic;
        AP.confirm("Báº¡n cĂ³ muá»‘n xĂ³a tĂ i liá»‡u nĂ y khĂ´ng ?", function(){
            UI.ajaxShow();
            AP.post("api/base/topic/remove-file",{topic_id: topic.id, id : id}, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message);
                }

                $("#"+id).remove();
            });
        });
    };
	
	this.edit=function(){
		var topic=Client.tempData.topic;
		if (!topic){
			return;
		}
		
		
		var data = {topic_id: topic.id};
	        
		var form = Form.create('fly-topic-fx',{'action': "api/base/topic/edit"})
		.row(
		    Form.label({label: "TĂªn topic"}),
		    Form.input({name: 'name', "placeholder":"TĂªn topic"}).value(topic.name).autoSubmit()
		)
		.row(
		    Form.label({label: "Ná»™i dung topic"}),
		    Form.input({name: 'content', "placeholder":"Ná»™i dung topic", role:"editor", type:"textarea"}).value(topic.content)
		)
		.row(
		    Form.label({label: "TĂ i liá»‡u Ä‘Ă­nh kĂ¨m"}),
		    Form.input({name: 'file-1', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-2', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-3', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-4', "placeholder":"", type:"file"})
		)
		.rowHidden(
		    Form.label({label: "&nbsp;"}),
		    Form.input({name: 'file-5', "placeholder":"", type:"file"})
		)
		.render(function(){
			$("#fly-topic-fx input[type=file]").on("change", function(){
				var next=$(this).closest(".row").next(".row");
				if (next && next.length){
					next.show();
				}
			});
		})
		.buttons([
		     {label: "Chá»‰nh sá»­a", action: function(){
		         Form.submit("#fly-topic-fx", function(code){
		             if (!code.good()){
		                 return AP.alertError(code.message);
		             }
		             
		             Form.hide("fly-topic-fx");
		             UI.flash("ÄĂ£ lÆ°u thĂ nh cĂ´ng ...");
		             AP.xRefresh();
		         })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Há»§y", action: function(){
		         Form.hide("fly-topic-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 600, label: 'Chá»‰nh sá»­a topic', layout: "flat"}).setForm(form).show().focus('name');
		
	};
	
	
};




var Act=new function __ACT(){
	
};


Act.board=new function __ACTBoard(){
	this.display=function(){
		var html=AP.render(Client.pageData.activities, function(e){
			return getActHTML(e);
		});
		
		if (!Client.pageData.activities || !Client.pageData.activities.length){
			html="<div class='no-act'>No activity logged recently</div>";
		}
		
		$("#acts").html(html);
	};
	
	
	this.onclick=function(ref){
		$(ref).addClass("active");
		$(ref).siblings().removeClass("active");
	};
	
	
	this.getHTML=function(act){
		return getActHTML(act);
	};
	
	
	
	function getActHTML(act){
		var content=act.content;
		if (!content || !content.length){
			content=act.sub;
		}
		
		return "<div class='act -unread url' data-url='"+act.link+"' data-feature='wework:wework_task_show:task' onclick='Act.board.onclick(this);'>" +
			"<div class='subtitle ap-xdot'>" + Act.origin.display(act.origin_export, act) + "</div>" +
			"<div class='title'>"+act.name+"</div>" +
			"<div class='content'>"+content+"</div>" +
			"<div class='events'>" +
				getEvents(act)+
			"</div>" +
		"</div>";
	};
	
	
	
	function getEvents(act, engine){
		return AP.render(act.events, function(e){
			var u=People.get(e.username);
			var icon="<img src='"+AP.xthumb(u.gavatar)+"'/>";
			if (e.icon && e.icon.color && e.icon.icon){
				icon="<div class='c -bg-alt"+e.icon.color+"'><span class='-ap icon-"+e.icon.icon+"'></span></div>";
			}
			
			var content="<div class='note'>"+e.content+"</div>";
			
			return "<div class='event'>" +
				"<div class='icon'>"+icon+"</div>" +
				"<div class='label'>"+e.name+" <span class='time'>"+AP.time.ago(e.since)+"</span></div>" +
				content +
			"</div>";
		})
	};
	
};


Act.origin=new function __ACTOrigin(){
	this.display=function(origin, act){
		
		if (!origin || !origin.type){
			return "Unknown activity";
		}
		
		var type=origin.type.toLowerCase();
		if (type=="projecttopics" || type=="message.topic"){
			return "<span class='icon'><span class='-ap icon-uniF1D7'></span></span> Tháº£o luáº­n trong <span class='tag'>"+origin.name+"</span>";
		}
		
		
		if (origin.type=="projecttasks"){
			var p=Project.getLocal(act.ns_id);
			if (p){
				return "<span class='icon'><span class='-ap icon-uniF10E'></span></span> CĂ´ng viá»‡c trong <span class='tag'>"+p.name+"</span>";
			}	
		}
		
		return "<span class='icon'><span class='-ap icon-uniF10E'></span></span> Hoáº¡t Ä‘á»™ng trong <span class='tag'>"+origin.name+"</span>";
	}
};




Base.template = new function __BaseTemplate() {

    /**
     * @desc Export template
     * @returns
     */
    this.export = function (project) {

        var valid_system = Client.system.id == 1 || Client.system.id == 79 || (ARR.contain([2290, 2297, 2289, 2298, 2332], Client.system.id) && Client.domain == 'base.com.vn');
        if (!valid_system || !project) {
            return;
        }

        var warning = 'Báº¡n cĂ³ muá»‘n lÆ°u máº«u cá»§a dá»± Ă¡n nĂ y ?';

        if (project.metatype == 'team') {
            warning = 'Báº¡n cĂ³ muá»‘n lÆ°u máº«u cá»§a phĂ²ng ban nĂ y ?';
        }

        AP.confirm(warning, function () {
            window.open(""+(Client.url)+"/template/project/export?id="+(project.id)+"", '_blank');
        });
    };


    this.import = function () {

        pick({
            app: "base_wework",
            feature: "template_picker",
            multi: 0,
            title: "Select a template",
            callback: function(response) {

                if (response.items.length != 1) {
                    return;
                }

                var template = response.items[0];
                Base.template.form.import(template);
            }
        });
    };


    /**
     * @desc Pick template
     */
    function pick(opts) {

        Base.exchange.picker({
			app: "connect",
			action: "picker/template/"+(opts.app)+"/"+(opts.feature)+"",
			callback: opts.callback,
			title: opts.title,
			multi: opts.multi,
            width: 1080
		});
    };
};


Base.template.form = new function __BaseTemplateForm() {

	this.import = function (template) {

		var form_id = 'import-template';

		var decode_data = decodeHashData(template.data);

		if (!decode_data) {
			return AP.alertError('Invalid template data');
		}

		var advanced_options = advanceOptions(decode_data);

		var btn_text = 'ThĂªm dá»± Ă¡n';
		var name_text = 'TĂªn dá»± Ă¡n';
		var title_text = 'Táº¡o dá»± Ă¡n tá»« máº«u';
		var warning_text = 'NgÆ°á»i táº¡o dá»± Ă¡n sáº½ Ä‘Æ°á»£c máº·c Ä‘á»‹nh thiáº¿t láº­p lĂ  ngÆ°á»i quáº£n lĂ½ dá»± Ă¡n. Báº¡n cĂ³ thá»ƒ sá»­a táº¡i má»¥c <b>CĂ i Ä‘áº·t nĂ¢ng cao</b> hoáº·c má»¥c <b>TĂ¹y chá»‰nh</b> sau khi táº¡o';

		if (decode_data.metatype == 'team') {
			btn_text = 'ThĂªm phĂ²ng ban';
			name_text = 'TĂªn phĂ²ng ban';
			title_text = 'Táº¡o phĂ²ng ban tá»« máº«u';
			warning_text = 'NgÆ°á»i táº¡o phĂ²ng ban sáº½ Ä‘Æ°á»£c máº·c Ä‘á»‹nh thiáº¿t láº­p lĂ  ngÆ°á»i quáº£n lĂ½ phĂ²ng ban. Báº¡n cĂ³ thá»ƒ sá»­a táº¡i má»¥c <b>CĂ i Ä‘áº·t nĂ¢ng cao</b> hoáº·c má»¥c <b>TĂ¹y chá»‰nh</b> sau khi táº¡o';
		}

		var rows = [
			{ label: ""+(name_text)+" *", name: "name", type: "text", classes: "-big", value: decode_data.name ? decode_data.name : '' },
			{ label: "Máº«u", type: 'fake', name: 'fake_template', value: template.name },
			{ type: "import", rows: advanced_options },
			{html: "  " +Render.render('flag_message', {icon: "ap exclamation" , color: "warning" , _class: "sample-note" }, ""+(warning_text)+"")+ '', type: 'html'}
		];

		Form.v2({
			id: form_id,
			data: { template_id: template.id, template_data: template.data},
			rows: rows,
			buttons: Form.button({
				label: btn_text,
				style: "ok",
				action: function () {

					Form.v2.submit(function (code) {

						if (!code.good()) {
							return AP.alertError(code.message);
						}

						UI.flash("Imported successfully");
						Form.v2.hide(form_id);

						AP.redirect(code.project.path);
					}, "#"+(form_id)+"")
				}
			}).button(":cancel"),
			title: title_text,
			action: "api/template/project/import",
			width: 480,
			render: function () {

				Form.improveSelect(this.find('dept_id'));
			}
		});
	};


	function advanceOptions(data) {

		var managers_text = 'Quáº£n lĂ½ dá»± Ă¡n *';
		var members_text = 'ThĂ nh viĂªn thá»±c hiá»‡n dá»± Ă¡n';

		if (data.metatype == 'team') {
			managers_text = 'Quáº£n lĂ½ phĂ²ng ban *';
			members_text = 'ThĂ nh viĂªn phĂ²ng ban';
		}

		var rows = [
			{ type: "open", label: "CĂ i Ä‘áº·t nĂ¢ng cao", id: "js-advanced-options" },
			{ type: "text", role: "tag", name: "owners", placeholder: 'GĂµ @ Ä‘á»ƒ tag', label: managers_text, value: [Client.viewer.username] },
			{ type: "textarea", role: "tag", name: "followers", placeholder: 'GĂµ @ Ä‘á»ƒ tag', quick_tag: true, label: members_text },
			{ type: "select", label: "Department", name: "dept_id", options: Form.convert(Client.depts), empty: { label: "ChÆ°a xĂ¡c Ä‘á»‹nh", value: 0 } },
			data.metatype == 'project' && { type: "text", role: "date", name: "stime", label: "NgĂ y báº¯t Ä‘áº§u"},
			data.metatype == 'project' && { type: "text", role: "date", name: "etime", label: "NgĂ y káº¿t thĂºc"},
			{ type: "close" }
		];

		rows = ARR.filter(rows, function (e) {
			return e;
		});

		return rows;
	};


	function decodeHashData(data) {

		try {
			var decode_data = Base64.decode(data);
			decode_data = AP.json.parse(decode_data);
			return decode_data;
		} catch (err) {

			return false;
		}
	}
};



Rewrite.on(':template/-/{action}', function(qs) {

	var act = qs.action

	if (act == "import") {
		return  Base.template.import();
	}
});




Base.webhooklogs = new function __BaseWebhooklogs() {

	this.list = function() {
		$canvas = $('#container-webhooklogs .webhooklogs-list');

		for (var i = 0; i < Client.pageData.webhooklogs.length; i++) {
			var log = Client.pageData.webhooklogs[i];

			var date_class = ".js-date-" + AP.time.time("%d%m%Y", log.since);
			var $box = $canvas.find(date_class);

			if (!$box.length) {
				$canvas.append("<div class='dgroup js-date-"+(AP.time.time('%d%m%Y', log.since))+"'> <div class='dgroup-title'>"+(AP.time.time('%d/%m/%Y', log.since))+"</div> <div class='dgroup-items'></div> </div>");
			}

			$canvas.find(date_class + " .dgroup-items").append(getHTML(log));
		}
	};


	function getSourceInfo(log) {
		var object_link = log.data.source_object_link ? "data-url='"+(log.data.source_object_link)+"'" : log.data.source_object_link;
		var container_link = "data-url='"+(log.data.source_container_link)+"'";

		var origin = false;
		var container = Client.pageData.context;
		if (container) {
			origin = parseInt(log.source_container_id) == parseInt(container.id) && log.source_appkey == Client.base.app;
		} else {
			origin = log.source_appkey == Client.base.app;
		}

		if (log.source_appkey == Client.base.app && log.data.source_object_link) {
			var array_source_object_link = AP.word.split(":/", log.data.source_object_link);
			if (array_source_object_link.length) {
				object_link = "onclick='Base.webhook.openNewTab(\""+(array_source_object_link[1])+"\")'";
			}

			var array_source_container_link = AP.word.split(":/", log.data.source_container_link);
			if (array_source_container_link.length) {
				container_link = "onclick='Base.webhook.openNewTab(\""+(array_source_container_link[1])+"\")'";
			}
		}


		return {
			object_link: object_link,
			container_link: container_link,
			object_name: log.data.source_object_name,
			container_name: log.data.source_container_name,
			appkey: log.source_appkey,
			origin: origin,
			object_type: log.source_object_type,

		};
	};


	function getWebhookInfo(log) {
		var object_link = log.data.webhook_object_link ? "data-url='"+(log.data.webhook_object_link)+"'" : '';
		var container_link = "data-url='"+(log.data.webhook_container_link)+"'";

		var origin = false;
		var container = Client.pageData.context;
		if (container) {
			origin = parseInt(log.webhook_container_id) == parseInt(container.id) && log.webhook_appkey == Client.base.app;
		} else {
			origin = log.webhook_appkey == Client.base.app;
		}

		if (log.webhook_appkey == Client.base.app && log.data.webhook_object_link) {
			var array_webhook_object_link = AP.word.split(":/", log.data.webhook_object_link);
			if (array_webhook_object_link.length) {
				object_link = "onclick='Base.webhook.openNewTab(\""+(array_webhook_object_link[1])+"\")'";
			}

			var array_webhook_container_link = AP.word.split(":/", log.data.webhook_container_link);
			if (array_webhook_container_link.length) {
				container_link = "onclick='Base.webhook.openNewTab(\""+(array_webhook_container_link[1])+"\")'";
			}
		}


		return {
			object_link: object_link,
			container_link: container_link,
			object_name: log.data.webhook_object_name,
			container_name: log.data.webhook_container_name,
			appkey: log.webhook_appkey,
			origin: origin,
			object_type: log.webhook_object_type,
		};
	};


	/**
	 * @desc Get Changelog action HTML
	 */
	function getHTML(log) {
		var source_info = getSourceInfo(log);
		var webhook_info = getWebhookInfo(log);

		var source_origin_icon = source_info.origin ? "<span class='-ap icon-uniF136'></span>&nbsp;" : '';
		var source_origin = source_info.origin ? 'origin' : '';
		var source_object_title = source_info.object_name ? "<div class='name url' "+(source_info.object_link)+" title='"+(source_info.object_name)+"'><b>"+(source_info.object_name)+"</b></div>" : "<div class='name'>UNKNOWN TARGET</div>";
		var source_container_title = source_info.container_name ? source_info.container_name : "INVALID CONTAINER";


		var webhook_origin_icon = webhook_info.origin ? "<span class='-ap icon-uniF136'></span>&nbsp;" : '';
		var webhook_origin = webhook_info.origin ? 'origin' : '';
		var webhook_object_title = webhook_info.object_name ? "<div class='name url' "+(webhook_info.object_link)+" title='"+(webhook_info.object_name)+"'><b>"+(webhook_info.object_name)+"</b></div>" : "<div class='name'>UNKNOWN TARGET</div>";
		var webhook_container_title = webhook_info.container_name ? webhook_info.container_name : "INVALID CONTAINER";

		if (parseInt(log.status)) {
			return "<div class='li' id='js-kr-"+(log.id)+"'> <div class='time'> <span class='d'>"+(AP.time.time('%M %d', log.since))+"</span> <span class='h'>"+(AP.time.time('%H:%i', log.since))+"</span> </div> <div class='icon -good'><span class='-ap icon-done'></span></div> <div class='info-wrapper'> <div class='source'> "+(source_object_title)+" <div class='info url' "+(source_info.container_link)+" title='"+(source_container_title)+"'><span class='text'>["+(AP.word.upper(source_info.appkey))+"] "+(source_container_title)+"</span></div> </div> <div class='webhook'> <div class='forward'><span class='-ap icon-chevron-thin-right'></span></div> "+(webhook_object_title)+" <div class='info url' "+(webhook_info.container_link)+" title='"+(webhook_container_title)+"'><span class='text'>["+(AP.word.upper(webhook_info.appkey))+"] "+(webhook_container_title)+"</span></div> </div> </div> </div>";
		}

		return "<div class='li' id='js-kr-"+(log.id)+"'> <div class='time'> <span class='d'>"+(AP.time.time('%M %d', log.since))+"</span> <span class='h'>"+(AP.time.time('%H:%i', log.since))+"</span> </div> <div class='icon -bad'><span class='-ap icon-close'></span></div> <div class='info-wrapper failed'> <div class='source'> "+(source_object_title)+" <div class='info url' "+(source_info.container_link)+" title='"+(source_container_title)+"'> <span class='text'>["+(AP.word.upper(source_info.appkey))+"] "+(source_container_title)+"</span></div> </div> <div class='webhook'> <div class='forward'><span class='-ap icon-chevron-thin-right'></span></div> <div class='name' title='"+(log.data.webhook_failed_reason)+"'>LĂ½ do tháº¥t báº¡i: "+(log.data.webhook_failed_reason)+"</div> <div class='info url' "+(webhook_info.container_link)+" title='"+(webhook_container_title)+"'> <span class='text'>["+(AP.word.upper(webhook_info.appkey))+"] "+(webhook_container_title)+"</span></div> </div> </div> </div>";
	};


	this.initFilters = function() {
		var apps = [
			{value: 'wework', label: 'Wework' }, 
			{value: 'workflow', label: 'Workflow' }, 
			{value: 'request', label: 'Request' },
		];

		var app_options = AP.render(apps, function(app) {
			return "<option value='"+(app.value)+"'>"+(app.label)+"</option>";
		});

		app_options = "<option value=''>Táº¥t cáº£</option>"+(app_options)+"";

		$('.js-target-apps select').html(app_options);
		$('.js-source-apps select').html(app_options);

		var array_containers = Client.pageData.projects;
		var container_options = AP.render(array_containers, function (container) {
			return "<option value='"+(container.id)+"'>"+(container.name)+"</option>";
		});

		container_options = "<option value=''>Táº¥t cáº£</option>"+(container_options)+"";

		$('.js-target-container select').html(container_options);
		$('.js-source-container select').html(container_options);

		var target_container_id = '';
		if (Query.get('target_container_id')) {
			target_container_id = Query.get('target_container_id');
		}
		Form.select.improve($("#js-master-filters .js-target-container select"),{
			value: target_container_id
		});

		var source_container_id = '';
		if (Query.get('source_container_id')) {
			source_container_id = Query.get('source_container_id');
		}
		Form.select.improve($("#js-master-filters .js-source-container select"),{
			value: source_container_id
		});
	};
};
var Project = new function __Project() {

	this.get_max = {'stack': 1500, 'priority': 300};

	this.inspect = function(){
		if (Client.tempData && Client.tempData.context) {
			return Client.tempData.context;
		}

		if (Client.pageData.context) {
			return Client.pageData.context;
		}

		return null;
	};

	/**
	 * @desc Context-aware getting project from its ID
	 */
	this.fromContext=function(id){
		return this.getLocal(id);
	};
	

	/**
	 * @desc Alias of fromContext()
	 */
	this.getLocal = function(id){
		if (Client.pageData.context) {
			if (parseInt(id) == Client.pageData.context.id) {
				return Client.pageData.context;
			}
		}
		
		if (Client.tempData && Client.tempData.context) {
			if (parseInt(id) == Client.tempData.context.id) {
				return Client.tempData.context;
			}
		}
		
		if (Client.pageData.projects){
			var tobj = AP.array.findObj(Client.pageData.projects, id);
			if (tobj) {
				return tobj;
			}	
		}
		
		
		var obj = AP.array.findObj(Client.projects, id);
		if (obj) {
			return obj;
		}

		return null;
	};


	/**
	 * @desc Check context-aware that the user is the manager of the current project
	 * @return boolean
	 */
	this.isManager = function(user) {
		if (!user) {
			user = Client.viewer;
		}
		
		var project=Project.inspect();
		if (!project){
			return false;
		}
		
		return AP.array.indexOf(project.owners, user, function (a, b) {
			return a.username == b.username;
		}) != -1;
	};

	
	/**
	 * @desc Check context-aware that the user is the member of the current project
	 * @return boolean
	 */
	this.isMember = function (user){
		if (!user) {
			user = Client.viewer;
		}
		
		var project=Project.inspect();
		if (!project){
			return false;
		}
		
		return AP.array.indexOf(project.followers, user, function (a, b) {
			return a.username == b.username;
		}) != -1;
	};


	
	this.tasklists = function(){
		return Board.data.init();
		// alert("DEPRECATED");
	};



	this.getPeople = function (project) {
		if (!project) {
			return Client.people;
		} else {
			return AP.array.filter(Client.people, function (e) {
				if (AP.array.contain(project.owners, e, function (a, b) {
					return a.username == b.username;
				})) {
					return true;
				}

				if (AP.array.contain(project.followers, e, function (a, b) {
					return a.username == b.username;
				})) {
					return true;
				}

				return false;
			});
		}
	};


	/**
	 * @desc Pick a project
	 */
	this.pick = function (callback, title) {
		if (!Client.projects || !Client.projects.length) {
			return;
		}

		var options = [];
		for (var i = 0; i < Client.projects.length; i++) {
			var p = Client.projects[i];
			if (p.status == 0) {
				options.push({label: p.name, icon: "uniF106", data: p});
			}
		}

		AP.selectAction(options, function (e) {
			callback(e.data);
		}, {
			title: title,
			filter: true
		});
	};


	/**
	 * @desc Get item by a given id, handler with callback
	 */
	this.get = function (id, callback) {
		UI.ajaxShow();
		AP.post("api/project/get", {'id': id}, function (code) {
			UI.ajaxHide();

			if (!code.good()) {
				return AP.alertError(code.message);
			}

			callback(code.project);
		});
	};

	this.create = function () {
		return Project.form.create();
	};

	
	

	this.addItem = function () {
		return this.form.addItem();
	};


	this.addTask = function (tasklist_id) {
		var tasklist = AP.array.findObj(Client.pageData.tasklists, tasklist_id);
		if (!tasklist) {
			return;
		}

		Task.dialog.add(Client.pageData.project, tasklist);
	};

	this.getTableFields = function(project) {
		var table_fields = [];
		for (var i = 0; i < project.form.length; i++) {
			var custom_field = project.form[i];
			if (custom_field.type == 'input-table') {
				var item = {};
				item.name = custom_field.name;
				item.id = custom_field.id;
				table_fields.push(item);
			}
		}

		return table_fields;
	};

	this.addTaskSelect = function () {
		Task.dialog.add(Client.pageData.project);
		return;

		var options = AP.select(Client.pageData.tasklists, function (e) {
			return {"id": e.id, "label": e.name, "object": e, sublabel: e.content, icon: "list-unordered"};
		});

		options.push({label: "<b>ThĂªm nhĂ³m cĂ´ng viá»‡c má»›i</b>", type: "create"});

		AP.selectAction(options, function (obj) {
			if (obj.type == "create") {
				return TaskList.create(Client.pageData.project);
			}

			Task.dialog.add(Client.pageData.project, obj.object);
		}, {title: "Lá»±a chá»n NhĂ³m cĂ´ng viá»‡c", filter: true, icon: true});
	};

	
};



Project.header = new function __ProjectHeader() {

	this.init = function() {

		Project.fav.init();
		if (!Client.pageData.project) {
			return;
		}
		
		if (Client.pageData.task_view) {
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.task_view);	
		} else if (Client.pageData.project.options) {
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.project.options.style);
		}
		
		$("#header .tab.is-home .sub").html($("#header .tab .-cmenu .-item.active").text());
		
		if (Client.pageData.task_view == "table" || Client.pageData.task_view == "board") {

			if (Client.pageData.project.metatype == "team" && Client.pageData.task_view == "board") {
				Team.filter.init();
			}

			if (Client.pageData.project.metatype == "private" && Client.pageData.task_view == "board") {
				Team.filter.init();
			}
			
			$("#project-filters").addClass("onboard").prependTo("#header .side").css({'float': 'left'});
		}
		
		if (Client.pageData.project.metatype != "project") {
			AP.bindSearch("#js-side-search .input input");
		} else {
			initLiveQueryFilter();
		}
	};
	
	
	/**
	 * @desc Applying a filter
	 */
	this.applyFilter=function(filter){
		$("#js-side-search input").val(filter+" ").select().trigger("input");
	};
	
	
	/**
	 * @desc Cleaning up filter
	 */
	this.clearSearch=function(){
		
	};
	
	
	function initLiveQueryFilter(){
		Tag.user("#js-side-search .input input", Project.getPeople());
		
		var delay_timer=0;
		$("#js-side-search .input input").on("input",function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var q=$this.val();
				executeFilter(q);
			}, 300);
		});
	};
	
	
	function executeFilter(q) {
		if (!q) {
			q = "";
		}
		
		q = $.trim(q).toLowerCase();
		q = purifyStrict(q);
		$.log(q);
		
		var view = Client.pageData.task_view;
		if (view == "list"){
			$("#tasklists .task-wrapper.js-task").each(function() {
				if (!q) {
					if ($(this).hasClass("search_hidden")) {
						$(this).removeClass('search_hidden');
					}
				} else {
					if (matched(this, q)) {
						$(this).removeClass("search_hidden");
					} else {
						$(this).addClass("search_hidden");
					}
				}
			});
		}
		
		if (view == "board" || view == "people") {
			if (!q){
				$("#main-board .js-task").removeClass("search_hidden");
				return;
			}
			
			$("#main-board .js-task").each(function(){
				if (matched(this, q)){
					$(this).removeClass("search_hidden");
				}else{
					$(this).addClass("search_hidden");
				}
			});
		}

		if (view == "table") {
			var select_tasks =  $("#js-main-table .js-task");

			select_tasks.each(function(index) {
				var task_id = $(this).data("id");
				if (!q) {
					if ($(this).hasClass("search_hidden")) {
						$(this).removeClass("search_hidden");
						$('#js-gantt-table .ancestor-' + task_id).removeClass("search_hidden");
						$('#js-main-table .tr.ancestor-' + task_id).removeClass("search_hidden");
						$('#js-custom-table .tr.ancestor-' + task_id).removeClass("search_hidden");
					}
				} else {
					if (matched(this, q)) {
						$(this).removeClass("search_hidden");
						$('#js-gantt-table .ancestor-' + task_id).removeClass("search_hidden");
						$('#js-main-table .tr.ancestor-' + task_id).removeClass("search_hidden");
						$('#js-custom-table .tr.ancestor-' + task_id).removeClass("search_hidden");
					} else {
						$(this).addClass("search_hidden");
						$('#js-gantt-table .ancestor-' + task_id).addClass("search_hidden");
						$('#js-main-table .tr.ancestor-' + task_id).addClass("search_hidden");
						$('#js-custom-table .tr.ancestor-' + task_id).addClass("search_hidden");
					}
				}
			});
		}

		if (view == "calendar") {
			$("#js-calendar .item.js-task-calendar").each(function(){
				if (!q){
					if ($(this).hasClass("search_hidden")){
						$(this).removeClass('search_hidden');
					}

				}else{
					if (matched(this, q)){
						$(this).removeClass("search_hidden");
					}else{
						$(this).addClass("search_hidden");
					}
				}
			});
		}
	};
	

	

	function matched(elem, q) {
		var keywords = purifyStrict($(elem).data("keywords"));
		return keywords.indexOf(q)!=-1;
	};
};


AP.sys.on("subtask.created", function(task){
	Project.on.taskCreated(task);
});


AP.sys.on("subtask.updated", function(task){
	Project.on.taskUpdated(task);
});




AP.rewrite('paction/([0-9]+)/([a-z\.]+)', 'projectact?id=$1&action=$2', function(qs) {

	if (qs.action == "removeicon") {
		AP.confirm("Confirm to remove fav icon", function() {
			UI.ajaxShow();
			AP.post("api/project/remove.icon", {id: qs.id}, function(code) {
				UI.ajaxHide();
				
				if (!code.good()) {
					return AP.alertError(code.message);
				}
				
				AP.refresh();
			});
		});
	}
	
	
	if (qs.action == "stage") {
		var current = [$(this).data("stage")];
		Form.inlineLabelTagger(this, function(item) {
			Project.manage.fix("stage", $(item).data("id"), function(code) {
				Side.overview.display();
				AP.refresh();
			});
		}, {
			labels: Project.option.statuses(),
			position: {
				right: 1,
			},
			click: true,
			selected: current
		});
	};
	
	if (qs.action == "time") {
		Project.manage.fixTime(function(project) {
			Client.pageData.project = project;
			Client.pageData.context = project;
			Side.overview.display();
		});
	}
	
	if (qs.action == "status") {
		var id = qs.id;
		
		var project = AP.array.findObj(Client.pageData.projects, id);
		if (!project) {
			project = Client.pageData.context;
		}
		
		if (!project) {
			return;
		}
		
		if (Me.isOwner(project) || Me.isSystemOwner()) {
			Project.status.update(project);
		}
	}
	
	if (qs.action == "edit") {
		var id = qs.id;
		var project = Project.fromContext(id);
		if (!project) {
			return;
		}
		
		return Project.form.edit(project);
	}
	
	if (qs.action == "tags") {
		Base.tagManager.init(Client.pageData.context);
		Base.tagManager.dialog();
	}
	
	if (qs.action == "tasklist.toggle") {
		return Board.list.toggleTasklist($(this).data("id"), this);
	}

	if (qs.action == "metatype") {
		var id = qs.id;
		var project = Project.fromContext(id);
		if (!project) {
			return;
		}
		
		return Project.manage.changeMetatype(project.id);
	}

	if (qs.action == "removepriority") {

		var id = qs.id;
		
		var project = AP.array.findObj(Client.pageData.projects, id);
		if (!project) {
			return;
		}
		
		return Project.manage.removePriority(project);
	}

	if (qs.action == "addpriority") {

		var id = qs.id;
		
		var project = AP.array.findObj(Client.pageData.projects, id);
		if (!project) {
			return;
		}
		
		return Project.manage.addPriority(project);
	}

	if (qs.action == "removealert") {

		var id = qs.id;
		
		var project = AP.array.findObj(Client.pageData.alert_projects, id);
		if (!project) {
			return;
		}
		
		return Project.manage.removeAlert(project);
	}

	if (qs.action == "alerttopriority") {

		var id = qs.id;
		
		var project = AP.array.findObj(Client.pageData.alert_projects, id);
		if (!project) {
			return;
		}
		
		return Project.manage.alertToPriority(project);
	}
});

Rewrite.on("paction/-/{action}", function(qs) {

	if (qs.action == "showmore.alert") {

		return MyTask.side.showMore();
	}
});



AP.rewrite('action/filter/([a-z0-9]+)', 'taskfilter?action=$1', function(qs) {
	if (Client.pageData.context) {
		Board.filter.live("filter", qs.action);
	} else {
		Board.filter.live("filter", qs.action);
		// MT.filter.set(qs.action);
	}
});




AP.rewrite('groupaction/([a-zA-Z0-9]+)/([a-zA-Z\.0-9]+)/([a-zA-Z0-9]+)', 'groupaction?metatype=$1&id=$2&action=$3', function(qs) {
	
	var action = qs.action;
	
	if (action == "taskinlinecreate") {

		$(this).toggleClass("active");

		var $group_canvas = $(this).closest(".js-group");
		$group_canvas.find(".bform-wrapper").toggleClass("active");
		
		if ($(this).hasClass("active")) {
			$group_canvas.find(".bform-wrapper *[name=name]").focus();
		}

		Tag.user($group_canvas.find(".task-iform").find("input[name=name]"), Project.getPeople());

		// if ($group_canvas.find(".action.-js-avatar").hasClass("-readonly")) {

		// } else {
		// 	Form.inlineTagger($group_canvas.find(".action.-js-avatar"), {
		// 		title: "NgÆ°á»i thá»±c hiá»‡n",
		// 		select: function(user){
		// 			setUser($(this).closest(".task-iform"), user);
		// 		},	
		// 		filter: function(user){
		// 			return Project.isMember(user);
		// 		},
		// 		position:{
		// 			top:35
		// 		},
		// 		more: "People outside project/team",
		// 		remove: function(){
		// 			$(this).closest(".task-iform").find("input[name=assign]").val("");
		// 			$(this).closest(".task-iform").find(".action.-js-avatar .avatar-add").html("<div class='ph'><span class='-ap icon-uniF13B'></span></div>");
		// 			$(this).closest(".task-iform").find(".action.-js-avatar em.v").html("Giao cho");
		// 		}
		// 	});
		// }

		// Form.inlineTagger($group_canvas.find(".action.-js-delegator"), {
		// 	title: "NgÆ°á»i giao",
		// 	select: function(user){
		// 		setDelegator($(this).closest(".task-iform"), user);
		// 	},	
		// 	filter: function(user){
		// 		var delegators = Client.delegators;
		// 		return AP.array.indexOf(delegators, user, function (a, b) {
		// 			return a.delegator_username == b.username;
		// 		}) != -1;
		// 	},
		// 	position:{
		// 		top:35
		// 	},
		// 	remove: function(){
		// 		$(this).closest(".task-iform").find("input[name=delegator]").val("");
		// 		$(this).closest(".task-iform").find(".action.-js-delegator .avatar-add").html("<div class='ph'><span class='-ap icon-uniF13B'></span></div>");
		// 		$(this).closest(".task-iform").find(".action.-js-delegator em.v").html("NgÆ°á»i giao");
		// 	}
		// });

		Form.inlineDatePicker($group_canvas.find(".action.-js-start-date"), function(date) {
			$(this).closest(".task-iform").find("input[name=start_time]").val(AP.time.time("%d/%m/%Y", date));
			$(this).closest(".task-iform").find(".action.-js-start-date em.v").html(AP.time.time("%d/%m/%Y", date));
		}, {
			position: {
				top: 32,
				left: -40
			}
		});
		
		Form.inlineDatePicker($group_canvas.find(".action.-js-deadline"), function(date) {
			$(this).closest(".task-iform").find("input[name=deadline]").val(AP.time.time("%d/%m/%Y", date));
			$(this).closest(".task-iform").find(".action.-js-deadline em.v").html(AP.time.time("%d/%m/%Y", date));
		}, {
			position: {
				top: 32,
				left: -40
			}
		});


		// Disable toggle status when create task
		$group_canvas.find(".bform-wrapper").find('.task-cb').addClass('-locked');
		$group_canvas.find(".bform-wrapper").find('.task-cb > .task-status').addClass('-xdone');

		return;
	}
	
	return Project.tform.dialog(assoc(qs.metatype, qs.id));	
	
});






AP.rewrite('tlaction/([0-9]+)/([a-z]+)', 'tlaction?id=$1&action=$2', function(qs){
	var action=qs.action;
	if (action=="edit"){
		return TaskList.edit(qs.id);
	}
	
	if (action=="reviewer"){
		return TaskList.manage.setReview(qs.id);
	}
	
	if (action=="remove"){
		return TaskList.manage.remove(qs.id);
	}
	
	if (action=="close"){
		return TaskList.manage.close(qs.id);
	}
});




AP.rewrite('mlaction/([0-9]+)/([a-z]+)', 'mlaction?id=$1&action=$2', function(qs){
	var action=qs.action;
	if (action=="edit"){
		return Milestone.edit(qs.id);
	}
	
	if (action=="remove"){
		return Milestone.remove(qs.id);
	}
});

Rewrite.on('mlaction/-/{action}', function(qs) {

	if (qs.action == "homepage.showmore") {
		return Side.milestone.showMore();
	}
});





AP.rewrite('action/([0-9]+)/([a-z]+)', 'taskinline?id=$1&action=$2', function(qs){	
	var acl=$(this).data("acl");
	if (!acl){
		acl=0;
	}else{
		acl=parseInt(acl);
	}
	
	var $box=$(this).closest(".js-task");
	if ($box.hasClass("focus")){
		// $box.removeClass("focus").siblings().removeClass("focus");
		// return;
	}else{
		// $box.addClass("focus").siblings().removeClass("focus");
	}
	
	var action=qs.action;
	var value=$(this).data("value");

	if (action=="mask"){
		$(this).closest(".li").removeClass("editing focus").find(".activated").removeClass("activated"); 
	}
	
	if (action=="edit"){
		Board.list.editing(this);
	}
	
	if (action=="star"){
		Task.fav.toggle(this);
	}

	if (action=="topicstar"){
		Topic.fav.toggle(this);
	}

	if (action=="check"){
		if (!acl){
			return;
		}
		
		var done=$(this).data("status");
		if (parseInt(done)){
			AP.confirm("Báº¡n cĂ³ muá»‘n bá» hoĂ n thĂ nh cĂ´ng viá»‡c nĂ y?", function () {
				Task.setStatus(qs.id, 0, this);	
			});

		}else{
			Task.setStatus(qs.id, 1, this);
		}
	}
	
	if (action=='tasklist') {

		return Task.ie.init(this, qs.id, "tasklist");
	}
	
	
	if (action=="remove"){
		Task.inline.remove(qs.id, this);
	}
	
	
	if (action=="gedit"){
		return Task.dialog.edit(Project.inspect(), Task.fromContext(qs.id));
	}
	
	if (action == "fedit"){
		return Task.inline.editCustomField(Task.fromContext(qs.id), $(this).data("fid"), this);
	}

	if (action == "expandfedit") {
		return Task.inline.extendEditCustomField(Task.fromContext(qs.id), $(this).data("fid"));
	}

	if (action == "popuptable"){
		var fid = $(this).data("fid");
		var task = Task.fromContext(qs.id);

		return TaskDisplay.popupCustomTable(task, fid);
	}

	if (action == "importtable") {
		var table_field = $(this).data("field");
		var task = Client.tempData.task;
		var project = Client.tempData.context || Client.tempData.project;

		return Task.action.importTable(project, task, table_field);
	}

	if (action == "exporttable") {
		var table_field = $(this).data("field");
		var task = Client.tempData.task;
		var project = Client.tempData.context || Client.tempData.project;
		
		return Task.action.exportTable(project, task, table_field);
	}
	
	if (action=="duration"){
		return Task.ie.init(this, qs.id, "duration");
	};
	
	
	if (action=="startdate" || action=="starttime"){
		if (!acl || !parseInt(acl)){
			return;
		}
		
		return Task.ie.init(this, qs.id, "starttime");
	};
	
	if (action=="startnow"){
		if (!acl || !parseInt(acl)){
			return;
		}
		
		Task.inline.fix(qs.id, "starttime", AP.time.now());
	};

	
	if (action == 'startdate-remove' || action == 'starttime-remove'){
		Task.ie.close();
		
		AP.confirm("XĂ¡c nháº­n xĂ³a thá»i gian báº¯t Ä‘áº§u cá»§a cĂ´ng viá»‡c?", function(){
			UI.ajaxShow();
			AP.post("api/task/fix",{id: qs.id, key:'starttime.remove'}, function(code){
				UI.ajaxHide();
				AP.hideAlert();

				if (!code.good()){
					return AP.alertError(code.message);
				}

				UI.flash("Update successfully");
				Task.update(code.task);
			});
		});
	};
	
	
	if (action == 'deadline-remove'){
		Task.ie.close();
		
		AP.confirm("XĂ¡c nháº­n xĂ³a thá»i háº¡n cá»§a cĂ´ng viá»‡c?", function(){
			Task.inline.fix(qs.id, 'deadline.remove', 1);
		});
	}
	
	
	if (action=="deadline"){
		if (!acl){
			return;
		}
		
		return Task.ie.init(this, qs.id, "deadline");
	}
	
	
	if (action=="urgent"){
		if (!acl){
			return;
		}
		
		var value=parseInt($(this).data("value"));
		if (value==1){
			value=0;
		}else{
			value=1;
		}
		
		Task.inline.edit(qs.id, {key: "urgent", value: value}, this);
		return;
	}
	
	
	if (action=="important"){
		if (!acl){
			return;
		}
		
		var value=parseInt($(this).data("value"));
		if (value==1){
			value=0;
		}else{
			value=1;
		}
		
		Task.inline.edit(qs.id, {key: "important", value: value}, this);
		return;
	}
	
	
	if (action=="addtocalendar"){
		return Task.calendar.add(qs.id);
	}

	if (action == "review") {
		var detail = $(this).data("detail");
		var assignee = $(this).data("assignee");
		if (detail) {
			var top = 48;// Select in task detail
		} else {
			var top = 20;// Select in tasks list
		}
		
		var labels = Task.option.reviews(assignee);
		var task = Task.fromContext(qs.id);
		// if (task.metatype != "undefined") {
		// 	if (task.metatype == "subtask") {
		// 		labels = AP.array.filter(labels, function(e){
		// 			return parseInt(e.id)!=0;
		// 		});
		// 	}
		// }

		Form.inlineLabelTagger(this, function(item){
			var id=$(this).closest(".js-task").data("id");
			var v=$(item).data("id");
			Task.inline.edit(id, {key: "review", value: v}, this);
		}, {
			labels: labels,
			position:{
				left: -1,
				top:top
			},
			click: true,
			selected: [parseInt(value)]
		});

		$("#js-task-display .task-cta .ap-inline-tagger-wrap .ap-inline-tagger .api-tags").find("[data-id='1']").addClass("url").attr("data-feature","wework:wework_task_confirm_done:task");
	}
	
	
	if (action=="tags"){
		Task.ie.init(this, qs.id, "tags");
		return;
	}
	
	if (action=="milestone"){
		Task.ie.init(this, qs.id, "milestone");
		return;
	}
	
	
	if (action=="assign"){
		Task.ie.init(this, qs.id, "assign");
		return;
	}
	
	
	if (action=="custom"){
		if (parseInt($(this).data("acl"))){
			Board.table.showInlineForm(this);	
		}
	}
	
	if (action=="submitinline"){
		Form.submitFrom(this, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("CĂ´ng viá»‡c Ä‘Ă£ Ä‘Æ°á»£c cáº­p nháº­t ...");
			$("#js-project-task .js-task-content").removeClass("editing");
			Project.on.taskUpdated(code.task);
		});
	}
	
	
	if (action=="submitcancel"){
		$(this).closest(".edit-box").removeClass("editing");
		$("#js-task-display .item-top .actions").css("display", "block");
	};
	
	if (action=="submitnow"){
		$("#js-project-task .edit-task-name .edit-form textarea").triggerEnter();
		return;
	}
	
	
	if (action=="follow"){
		Task.action.follow(1);
	}
	
	if (action=="unfollow"){
		Task.action.follow(0);
	}
	
	if (action=="addfollower"){
		Form.inlineTagger(this, {
			title: "ThĂªm ngÆ°á»i theo dĂµi",
			search: true,
			users: Project.getPeople(Project.inspect()),
			select: function(user){
				Task.action.setFollow(user);
			},
			position:{
				left:-60,
			},
			width: 250,
			click: true
		});
	}
	
	
	if (action=="extfollower"){
		Form.inlineTagger(this, {
			title: "ThĂªm ngÆ°á»i theo dĂµi tá»« ngoĂ i",
			search: true,
			users: Client.people,
			select: function(user){
				Task.action.setFollow(user);
			},
			position:{
				right:1,
			},
			width: 250,
			click: true
		});

		// if(window.location.href.indexOf("calendar") >= 0) {
		//	 $("#js-project-item .js-followers .-close").hide();
		// }
	}
	
	if (action=="checklist"){
		var subaction=$(this).data("action");
		if (subaction=="assign"){
			Form.inlineTagger(this, {
				title: "Giao cho",
				search: true,
				users: Project.getPeople(Project.inspect()),
				select: function(user){
					Checklist.assignItem(qs.id, $(this).data("id"), user, this);
				},
				position:{
					right:1,
				},
				width: 250,
				click: true
			});
		}
	}
	
});











AP.sys.on("tasklist.create", function(item){
	// Simply rebuild the whole board
	Client.pageData.tasklists.push(item);
	Board.build();
});


AP.sys.on("tasklist.move", function(dir, item){
	var $box=$("#tasklist-"+item.gid);
	if (!$box.length){
		return;
	}
	
	if (dir=="down"){
		var $elem=$box.prev();
		if ($elem && $elem.length){
			$box.hide().insertBefore($elem).slideDown(300);
		}
	}else{
		if (dir=="up"){
			var $elem=$box.next();
			if ($elem && $elem.length){
				$box.hide().insertAfter($elem).slideDown(300);
			}
		}
	}
});


AP.sys.on("tasklist.remove", function(item){
	var $box=$("#tasklist-"+item.gid);
	if (!$box.length){
		return;
	}
	
	$box.slideUp(300);
	
	Client.pageData.tasklists = AP.array.remove(Client.pageData.tasklists, item, function(e1, e2){
		return e1.id==e2.id;
	});
	
	Client.pageData.tasks = AP.array.remove(Client.pageData.tasks, item, function(e1, e2){
		return e1.tasklist_id==e2.id;
	});
});



AP.sys.on("tasklist.edit", function(tasklist){
	// Simply rebuild the whole board
	// AP.array.updateByID(Client.pageData.tasklists, tasklist);
	// Board.list.build();
	
	$.log(Client.pageData.tasklists);
});







AP.sys.on("item.update", function(item){
	Board.updateItem(item);
});

AP.sys.on("project.reopen", function(project) {
	return AP.xRefresh();
});

AP.sys.on("project.finish", function(project) {
	return AP.xRefresh();
});





Project.taglist=new function __ProjectTagList(){
	this.__tags=null;
	
	this.reload=function(context_id, tags){
		var __tags={};
		for (var i=0; i<tags.length; i++){
			__tags["t"+tags[i].key]=tags[i];
		}
		
		this.__tags={
			id: context_id,
			tags:__tags
		};
	};
	
	
	this.parse=function(tags, context){
		if (!context){
			context=Client.pageData.context;
		}
		
		if (!context){
			return AP.select(tags, function(e){
				return {name: e, color:0, key: e};
			});
		}
		
		if (this.__tags && this.__tags.id == context.id){
		}else{
			var __tags={};
			for (var i=0; i<context.tags.length; i++){
				__tags["t"+context.tags[i].key]=context.tags[i];
			}
			
			this.__tags={
				id: context.id,
				tags: __tags
			};
		}
		
		
		var r=[];
		for (var i=0; i<tags.length; i++){
			var tag=this.__tags.tags["t"+tags[i]];
			if (tag){
				r.push(tag);
			}
		}
		
		return r;
		
	};
	
	
	
	this.quickCreate=function(project, callback){
		var data={id: project.id};
		
		var form=Form.create('fly-workflow-fx',{'action': project.path+"/api/settings/tags/edit"})
		.row(
			Form.label({label: "Tag"}),
			Form.input({name: 'name', "placeholder":"Tag"}).autoSubmit()
		)
		.row(
			Form.label({label: "&nbsp;",sublabel: ""}),
			Form.input({name: 'color', type:"colors"}).value(AP.data.randomInteger(1,9))
		)
		.buttons([
		     {label: "ThĂªm tag", action: function(){
		    	 Form.submit("#fly-workflow-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 Form.hide("fly-workflow-fx");
		    		 
		    		 project.tags=code.updated_tags;
		    		 Project.taglist.reload(project.id, code.updated_tags);
		    		 callback(code.tag);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Huá»·", action: function(){
		    	 Form.hide("fly-workflow-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			
		});
	
		Form.pop({width: 400, label: 'ThĂªm tag vĂ o '+project.name, layout: 'flat'}).setForm(form).show().focus('name');
	
	};
	
	
};


Project.fav=new function __ProjectFav(){
	this.init=function(){
		if (UI.fav.isFav(Client.pageData.context.id, Client.favs)){
			$("#header .star").addClass("-star");
		}
		
		$("#header .star").click(function(){
			$(this).toggleClass("-star");
			Project.fav.toggle();
		});
	};
    
    
    this.isFav=function(){
    	
    };
    
    
    this.toggle = function() {
    	UI.fav.update("api/project/fav", {
    		target: Client.pageData.context, 
    		list: Client.favs,
    	}, function(fav, list){
    		Client.favs=list;
    		Menu.build();
    	});
    	
    	return;
    };
      
};


Project.header = new function __ProjectHeader() {

	this.init = function() {

		Project.fav.init();
		if (!Client.pageData.project) {
			return;
		}
		
		if (Client.pageData.task_view) {
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.task_view);	
		} else if (Client.pageData.project.options) {
			$("#header .tab .-cmenu .-item").setActiveURLParam("view", Client.pageData.project.options.style);
		}
		
		$("#header .tab.is-home .sub").html($("#header .tab .-cmenu .-item.active").text());
		
		if (Client.pageData.task_view == "table" || Client.pageData.task_view == "board") {

			if (Client.pageData.project.metatype == "team" && Client.pageData.task_view == "board") {
				Team.filter.init();
			}

			if (Client.pageData.project.metatype == "private" && Client.pageData.task_view == "board") {
				Team.filter.init();
			}
			
			$("#project-filters").addClass("onboard").prependTo("#header .side").css({'float': 'left'});
		}
		
		if (Client.pageData.project.metatype != "project") {
			AP.bindSearch("#js-side-search .input input");
		} else {
			initLiveQueryFilter();
		}
	};
	
	
	/**
	 * @desc Applying a filter
	 */
	this.applyFilter=function(filter){
		$("#js-side-search input").val(filter+" ").select().trigger("input");
	};
	
	
	/**
	 * @desc Cleaning up filter
	 */
	this.clearSearch=function(){
		
	};
	
	
	function initLiveQueryFilter(){
		Tag.user("#js-side-search .input input", Project.getPeople());
		
		var delay_timer=0;
		$("#js-side-search .input input").on("input",function(){
			var $this = $(this);
			clearTimeout(delay_timer);
			
			delay_timer = setTimeout(function(){
				var q=$this.val();
				executeFilter(q);
			}, 300);
		});
	};
	
	
	function executeFilter(q) {
		if (!q) {
			q = "";
		}
		
		q = $.trim(q).toLowerCase();
		q = purifyStrict(q);
		$.log(q);
		
		var view = Client.pageData.task_view;
		if (view == "list"){
			$("#tasklists .task-wrapper.js-task").each(function() {
				if (!q) {
					if ($(this).hasClass("search_hidden")) {
						$(this).removeClass('search_hidden');
					}
				} else {
					if (matched(this, q)) {
						$(this).removeClass("search_hidden");
					} else {
						$(this).addClass("search_hidden");
					}
				}
			});
		}
		
		if (view == "board" || view == "people") {
			if (!q){
				$("#main-board .js-task").removeClass("search_hidden");
				return;
			}
			
			$("#main-board .js-task").each(function(){
				if (matched(this, q)){
					$(this).removeClass("search_hidden");
				}else{
					$(this).addClass("search_hidden");
				}
			});
		}

		if (view == "table") {
			var select_tasks =  $("#js-main-table .js-task");

			select_tasks.each(function(index) {
				var task_id = $(this).data("id");
				if (!q) {
					if ($(this).hasClass("search_hidden")) {
						$(this).removeClass("search_hidden");
						$('#js-gantt-table .ancestor-' + task_id).removeClass("search_hidden");
						$('#js-main-table .tr.ancestor-' + task_id).removeClass("search_hidden");
						$('#js-custom-table .tr.ancestor-' + task_id).removeClass("search_hidden");
					}
				} else {
					if (matched(this, q)) {
						$(this).removeClass("search_hidden");
						$('#js-gantt-table .ancestor-' + task_id).removeClass("search_hidden");
						$('#js-main-table .tr.ancestor-' + task_id).removeClass("search_hidden");
						$('#js-custom-table .tr.ancestor-' + task_id).removeClass("search_hidden");
					} else {
						$(this).addClass("search_hidden");
						$('#js-gantt-table .ancestor-' + task_id).addClass("search_hidden");
						$('#js-main-table .tr.ancestor-' + task_id).addClass("search_hidden");
						$('#js-custom-table .tr.ancestor-' + task_id).addClass("search_hidden");
					}
				}
			});
		}

		if (view == "calendar") {
			$("#js-calendar .item.js-task-calendar").each(function(){
				if (!q){
					if ($(this).hasClass("search_hidden")){
						$(this).removeClass('search_hidden');
					}

				}else{
					if (matched(this, q)){
						$(this).removeClass("search_hidden");
					}else{
						$(this).addClass("search_hidden");
					}
				}
			});
		}
	};
	

	

	function matched(elem, q) {
		var keywords = purifyStrict($(elem).data("keywords"));
		return keywords.indexOf(q)!=-1;
	};
};


Project.subheader=new function __ProjectSubheader(){
	/**
	 * @desc Init header form
	 */
	this.init=function(){
		initHeader();
	};
	
	
	function initHeader(){
		if (!Client.pageData.project){
			return;
		}
		
		var html="<div class='title'> Danh sĂ¡ch cĂ´ng viá»‡c </div>";

		var task_create_html = '';
		var tasklist_create_html = '';
		var separate = '';
		
		if (!Client.pageData.project.acl.task_create && !Client.pageData.project.acl.tasklist_create){
			
		}else{
			if (Client.pageData.project.acl.task_create) {
				task_create_html = "<span class='action' onclick='Project.tform.dialog();'>Táº¡o cĂ´ng viá»‡c</span>";
			}

			if (Client.pageData.project.acl.tasklist_create) {
				tasklist_create_html = "<span class='action' onclick='TaskList.create()'>Táº¡o nhĂ³m cĂ´ng viá»‡c má»›i</span>";
			}

			if (Client.pageData.project.acl.task_create && Client.pageData.project.acl.tasklist_create) {
				separate = "hoáº·c";
			}

			html="<div class='task-user-add'> <div class='avatar'><img src='"+(AP.xthumb(Client.viewer.gavatar))+"'></div> <div class='icon'><span class='-ap icon-plus2'></span></div> <div class='mask url' onclick='Project.tform.dialog();'></div> <div class='txt'> "+(task_create_html)+" "+(separate)+" "+(tasklist_create_html)+" </div> </div>";
		}
		
		$("#js-project-header").html(html); 
	};
	
};


Project.option=new function __ProjectOption(){	
	this.statuses=function(){
		if (!Client.pageData.project || Client.pageData.project.metatype == 'project') {
			return [
				{value: "ontrack", label:"Trong kiá»ƒm soĂ¡t", name: "Trong kiá»ƒm soĂ¡t", color: "0", "id": "ontrack"},
				{value: "accelerated", label:"TÄƒng tá»‘c", "name":"TÄƒng tá»‘c", color: "0", id: "accelerated"},
				{value: "postponed", label:"Táº¡m dá»«ng", name:"Táº¡m dá»«ng", color: 4, "id":"postponed"},
				{value: "late", label:"Dá»± Ă¡n trá»…", name:"Dá»± Ă¡n trá»…", color: 8, id: "late"}
			];
		} else if (Client.pageData.project.metatype == 'team') {
			return [
				{value: "running", label:"Äang cháº¡y", "name":"Äang cháº¡y", color: "0", id: "running"},
				{value: "closed", label:"ÄĂ£ Ä‘Ă³ng", name:"ÄĂ£ Ä‘Ă³ng", color: 8, id: "closed"}
			];
		}
	};
	
	this.showPrinter=function(){
		AP.alertSuccess("Press <code>CTLR + P</code> to print the task list (LIST VIEW only)");
	};
	
	
	
	this.tasklist=function(tasklist){
		var ab=new ActionManager({icon: false});
		
		if (!tasklist.id){
			return ab;
		}
		
		
		ab.add({label: "Chá»‰nh sá»­a nhĂ³m cĂ´ng viá»‡c", "url": "tlaction/"+(tasklist.id)+"/edit"});
		ab.add({label: "Cáº­p nháº­t ngÆ°á»i Ä‘Ă¡nh giĂ¡", "url": "tlaction/"+(tasklist.id)+"/reviewer"});
		
		if (Client.pageData.project.metatype!="project"){
			if (TaskList.isClosed(tasklist)){
				ab.add({label: "Má»Ÿ láº¡i nhĂ³m cĂ´ng viá»‡c", "url": "tlaction/"+(tasklist.id)+"/open"});	
			}else{
				ab.add({label: "Táº¡m Ä‘Ă³ng nhĂ³m cĂ´ng viá»‡c", "url": "tlaction/"+(tasklist.id)+"/close"});
			}
			
		}
		
		ab.add("---");
		ab.add({label: "XĂ³a nhĂ³m cĂ´ng viá»‡c", "url": "tlaction/"+(tasklist.id)+"/remove", style:"red"});
		
		return ab;
	};
	
	
	this.milestone=function(m){
		var ab=new ActionManager({icon: false});
		ab.add({label: "Edit milestone", "url": "mlaction/"+(m.id)+"/edit"});
		ab.add("---");
		ab.add({label: "Delete milestone", "url": "mlaction/"+(m.id)+"/remove", style:"red"});
		
		return ab;
	};
	
	
};


Project.status=new function __ProjectStatus(){
	this.closed_statuses=[
		{value:"success", label: "Dá»± Ă¡n thĂ nh cĂ´ng"},
		{value:"failed", label: "Dá»± Ă¡n tháº¥t báº¡i"},
		{value:"canceled", label: "Dá»± Ă¡n bá»‹ há»§y"}
	];
	
	
	this.statuses=[
		{value:"ontrack", label: "ÄĂºng tiáº¿n Ä‘á»™"},
		{value:"offtrack", label: "Cháº­m tiáº¿n Ä‘á»™"},
		{value:"atrisk", label: "CĂ³ rá»§i ro cao"}
	];
	
	this.exportLabels=function(){
		var lbs=[];
		
		for (var i=0; i<this.statuses.length; i++){
			lbs.push(this.statuses[i].label);
		}
		
		return lbs;
	};
	
	this.getLabel=function(key){
		for (var i=0; i<this.statuses.length; i++){
			var s=this.statuses[i];
			if (purifyStrict(s.value)==purifyStrict(key) || purifyStrict(s.label)==purifyStrict(key)){
				return s.label;
			}
		}
		
		for (var i=0; i<this.closed_statuses.length; i++){
			var s=this.closed_statuses[i];
			if (purifyStrict(s.value)==purifyStrict(key) || purifyStrict(s.label)==purifyStrict(key)){
				return s.label;
			}
		}
		
		return "ÄĂºng tiáº¿n Ä‘á»™";
	};
	
	
	this.getKey=function(key){
		for (var i=0; i<this.statuses.length; i++){
			var s=this.statuses[i];
			if (purifyStrict(s.value)==key || purifyStrict(s.label)==key){
				return s.value;
			}
		}
		
		for (var i=0; i<this.closed_statuses.length; i++){
			var s=this.closed_statuses[i];
			if (purifyStrict(s.value)==key || purifyStrict(s.label)==key){
				return s.value;
			}
		}
		
		return "ontrack";
	};
	
	
	this.getShortLabel=function(key){
		var label=this.getLabel(key);
		var paths=label.split("|");
		if (paths && paths.length){
			return paths[0];	
		}
		
		return label;
	};
	
	
	this.update=function(project){
		if (AP.data.isInt(project)){
			project=Project.fromContext(project);
		}
		
		if (!project){
			project=Client.pageData.project;
		}
		
		if (!project){
			return;
		}	
		
		var data={id: project.id, hid: project.hid, token: project.token};
		var opts=this.statuses;
		if (parseInt(project.status)){
			opts=this.closed_statuses;
		}

		var form=Form.create('fly-tasklist-fx',{'action': "api/project/status"})
		.row(
			Form.label({label: "Dá»± Ă¡n/phĂ²ng ban *"}),
			Form.inputGroup([
				Form.input({name: 'name', placeholder: "Dá»± Ă¡n/phĂ²ng ban", type: "fake"}).value(project.name)
			])
		)
		.row(
			Form.label({label: "Giai Ä‘oáº¡n"}),
			Form.input({name: 'stage', type:"select", options: opts}).value(project.status_obj.stage)
		)
		.row(
			Form.label({label: "MĂ´ táº£"}),
			Form.input({name: 'note', type:"textarea", placeholder: "MĂ´ táº£ thĂªm vá» tĂ¬nh tráº¡ng dá»± Ă¡n/phĂ²ng ban hiá»‡n táº¡i"}).value(project.status_obj.note)
		)
		.buttons([
			 {label: "Cáº­p nháº­t", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Update successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Huá»· bá»", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Cáº­p nháº­t tráº¡ng thĂ¡i', layout: 'flat', closable: false}).setForm(form).show();
	};
	
	
	this.history=function(context){
		if (context.data.stage_history) {
			var html= AP.render(context.data.stage_history, function(e){
				var user=People.get(e.username);
				return "<div class='item'> <div class='dot' style='background-color:"+(getColor(e.stage))+"'></div> <div class='line' style='background-color:"+(getColor(e.stage))+"'></div> <div class='header'> <div class='stage' style='color: "+(Color.adjust(getColor(e.stage),20,20))+";'>"+(e.stage)+"</div> <div class='date'>"+(AP.i18n.date(e.time))+"</div> <div class='info'><span class='image'><img src='"+(AP.xthumb(user.gavatar))+"'/></span> <span class='url username'>"+(user.name)+"</span></div> </div> <div class='content'>"+(e.note)+"</div> </div>";
			});
			
			return "<div class='items'>"+(html)+"</div>";
		}
		
		return "";
	};
	
	
	this.color=function(stage){
		return getColor(stage);
	};
	
	
	function getColor(stage){
		var key=Project.status.getKey(stage);
		
		if (key=="ontrack"){
			return Color.get("ontrack");
		}
		
		if (key=="offtrack"){
			return Color.get("offtrack");
		}
		
		if (key=="atrisk"){
			return Color.get("atrisk");
		}
		
		if (key=="success"){
			return Color.get("success");
		}
		
		if (key=="failed"){
			return Color.get("error");
		}
		
		if (key=="canceled"){
			return "#a1a1a1";
		}
		
		return "#999999";
	};
	

	
};


Project.webhook=new function __ProjectWebhook(){
	this.init=function(){
		if (!Project.isManager(Client.viewer)){
			return AP.alertError("Only project manager can manage webhooks");
		}
		
		Base.webhook.manage({
			origin: Client.pageData.context,
			events: ["taskCreated", "taskDone", "taskStatusUpdated", "subtaskCreated", "subtaskDone", "subtaskStatusUpdated"],
			multi: 0,
			create: "create/"+Client.pageData.context.incoming_webhook
		});

	};
};


Project.tform=new function __ProjectTForm(){
	this.build=function(options){
		var project=options.project;
		if (!project){
			project=Client.pageData.project;
		}
		
		if (!project){
			return;
		}
		
		if (!project.acl.task_create) {
			return "";
		}
		
		var canvas=options.canvas;
		if (!canvas){
			canvas="#js-create-form-"+options.group.id; 
		}
		
		options.cform_id=AP.uuid();
		
		var html=getInlineForm(project, options);
		$(canvas).html(html).addClass("js-tform");
		
		// Bind events
		Form.render(canvas+" form");
		$(canvas).find("textarea[name=name]").autofocus();
		
		$(canvas+" .js-add-tags").click(function(){
			$(this).closest(".formbox").find(".frow.js-tags").toggle();
			
			if ($(this).closest(".formbox").find(".frow.js-tags").is(":visible")){
				$(this).closest(".formbox").find(".frow.js-tags").find("input").focus();
			}
		});
		
		$(canvas).find(".frow.js-tags").find("input").scomplete(AP.select(project.tags, function(e){
			return e.name;
		}));
		
		$(canvas+" .js-add-followers").click(function(){
			$(this).closest(".formbox").find(".frow.js-followers").toggle();
			if ($(this).closest(".formbox").find(".frow.js-followers").is(":visible")){
				$(this).closest(".formbox").find(".frow.js-followers").find("input").focus();
			}
		});

		Form.improveSelect($('#js-tform-dialog select[name="tasklist_id"]'));
		$('#js-tform-dialog select[name="tasklist_id"]').closest('.frow').addClass('custom-select');

		Form.improveSelect($('#js-tform-dialog select[name="milestone_id"]'));
		$('#js-tform-dialog select[name="milestone_id"]').closest('.frow').addClass('custom-select');

		if (project.form && project.form.length){
			var project_form = [];
			for (var i = 0; i < project.form.length; i++){
				project_form.push(shallowClone(project.form[i]));
			}

			for (var i = 0; i < project_form.length; i++){
				if (project_form[i].type != "select") {
					project_form[i].value = "";
				}
			}

			cForm.attachInline(project.form, "#" + options.cform_id, project_form);

			$("#" + options.cform_id).show().prepend("<div class='cform-title url' data-url=':collapse:parent'>TrÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh</div>");

			Form.select.improve($("#js-tform-dialog .row .input select:not([multiple])"));

			displayPlaceholder();
		}
		
		recountFiles(canvas+" .atts");
		
		AP.pickable(canvas+" .js-add-file", {
			name: "file[]",
			callback: function(name, input){
				var $canvas=$(this).closest(".js-tform");
				var fid=AP.uuid();
				var html="<div class='att' id='"+(fid)+"' title='"+(name)+"'> <div class='attname'><div class='ap-xdot'>"+(name)+"</div></div> <span class='remove' onclick='Project.tform.removeInputFile(this)'><span class='-ap icon-close'></span></span> <div class='hidden'></div> </div>";
				
				$(canvas+" .atts").append(html);
				$(input).appendTo("#"+fid+" .hidden");
				recountFiles($canvas.find(".atts"));
			}
		});
		
		AP.pickable(canvas+" .js-add-drive", {
			name: "file[]",
			drive: 1,
			multi: 1,
			callback: function(files){
				for (var i=0; i<files.length; i++){
					var fid=AP.uuid();
					var html="<div class='att' id='"+(fid)+"' title='"+(files[i].name)+"'> <div class='attname'><div class='ap-xdot'>"+(files[i].name)+"</div></div> <span class='remove' onclick='Project.tform.removeInputFile(this)'><span class='-ap icon-close'></span></span> <div class='hidden'></div> </div>";
					
					$(canvas+" .atts").append(html);
					$(files[i]._html).appendTo("#"+fid+" .hidden");
					recountFiles($(canvas).find(".atts"));	
				}
			}
		});
		
		// OTHER EVENTS
		$(canvas).each(function(){
			$(this).find(".board-add").click(function(){
				$(this).closest(".board-add-wrap").addClass("active");
				$(this).closest(".board-add-wrap").find("*[name=name]").focus();
			});
			
			var $this=$(this);

			if (options.multi_people) {
				$this.find(".submit").click(function(){
					addInlineMultiPeople(this);
				});
			} else {
				$this.find(".submit").click(function(){
					addInline(this);
				});
			}
			
			$this.find("textarea").enter(function(){
				addInline(this);
			});
			
			$this.find(".cancel").click(function(){
				Project.tform.hide(this);
			});
		});
		
		// Set default
		if (options.group){
			if (Board.data.model.metatype=="tasklist"){
				$(canvas).find("*[name=tasklist_id]").val(options.group.id);
			}
			
			if (Board.data.model.metatype=="milestone"){
				$(canvas).find("*[name=milestone_id]").val(options.group.id);
			}
			
			if (Board.data.model.metatype=="user" && options.group.id && parseInt(options.group.id)>0){
				$(canvas).find("*[name=assign]").val("@"+options.group.username);
			}
		}
	};
	
	/**
	 * @caonguyen
	 * Clone build function but only render after clicking
	 * Optimize for performance
	 */
	this.buildInlineForm = function(options){
		var project=options.project;
		if (!project){
			project=Client.pageData.project;
		}
		
		if (!project){
			return;
		}
		
		if (!project.acl.task_create) {
			return "";
		}
		
		var canvas=options.canvas;
		if (!canvas){
			canvas="#js-create-form-"+options.group.id; 
		}
		
		options.cform_id=AP.uuid();
		
		var html=getInlineForm(project, options);
		$(canvas).html(html).addClass("js-tform");

		Form.improveSelect($(canvas).find('select[name="tasklist_id"]'));
		$(canvas).find('select[name="tasklist_id"]').closest('.frow').addClass('custom-select');

		Form.improveSelect($(canvas).find('select[name="milestone_id"]'));
		$(canvas).find('select[name="milestone_id"]').closest('.frow').addClass('custom-select');
		

		$(canvas).find(".board-add").click(function() {
			// Bind events
			Form.render(canvas+" form");
			$(canvas).find("textarea[name=name]").autofocus();

			$(canvas+" .js-add-tags").click(function(){
				$(this).closest(".formbox").find(".frow.js-tags").toggle();
				
				if ($(this).closest(".formbox").find(".frow.js-tags").is(":visible")){
					$(this).closest(".formbox").find(".frow.js-tags").find("input").focus();
				}
			});

			$(canvas).find(".frow.js-tags").find("input").scomplete(AP.select(project.tags, function(e){
				return e.name;
			}));

			$(canvas+" .js-add-followers").click(function(){
				$(this).closest(".formbox").find(".frow.js-followers").toggle();
				if ($(this).closest(".formbox").find(".frow.js-followers").is(":visible")){
					$(this).closest(".formbox").find(".frow.js-followers").find("input").focus();
				}
			});

			if (project.form && project.form.length){
				var project_form = [];
				for (var i = 0; i < project.form.length; i++){
					project_form.push(shallowClone(project.form[i]));
				}

				for (var i = 0; i < project_form.length; i++){
					if (project_form[i].type != "select") {
						project_form[i].value = "";
					}
				}

				cForm.attachInline(project.form, "#" + options.cform_id, project_form);

				$("#" + options.cform_id).show().prepend("<div class='cform-title url' data-url=':collapse:parent'>TrÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh</div>");

				Form.select.improve($("#js-tform-dialog .row .input select:not([multiple])"));

				displayPlaceholder();
			}

			recountFiles(canvas+" .atts");

			AP.pickable(canvas+" .js-add-file", {
				name: "file[]",
				callback: function(name, input){
					var $canvas=$(this).closest(".js-tform");
					var fid=AP.uuid();
					var html="<div class='att' id='"+(fid)+"' title='"+(name)+"'> <div class='attname'><div class='ap-xdot'>"+(name)+"</div></div> <span class='remove' onclick='Project.tform.removeInputFile(this)'><span class='-ap icon-close'></span></span> <div class='hidden'></div> </div>";
					
					$(canvas+" .atts").append(html);
					$(input).appendTo("#"+fid+" .hidden");
					recountFiles($canvas.find(".atts"));
				}
			});

			AP.pickable(canvas+" .js-add-drive", {
				name: "file[]",
				drive: 1,
				multi: 1,
				callback: function(files){
					for (var i=0; i<files.length; i++){
						var fid=AP.uuid();
						var html="<div class='att' id='"+(fid)+"' title='"+(files[i].name)+"'> <div class='attname'><div class='ap-xdot'>"+(files[i].name)+"</div></div> <span class='remove' onclick='Project.tform.removeInputFile(this)'><span class='-ap icon-close'></span></span> <div class='hidden'></div> </div>";
						
						$(canvas+" .atts").append(html);
						$(files[i]._html).appendTo("#"+fid+" .hidden");
						recountFiles($(canvas).find(".atts"));	
					}
				}
			});

			$(this).closest(".board-add-wrap").addClass("active");
			$(this).closest(".board-add-wrap").find("*[name=name]").focus();
			// OTHER EVENTS
			$(canvas).each( function(){ 
				var $this=$(this);

				if (options.multi_people) {
					$this.find(".submit").click(function(){
						addInlineMultiPeople(this);
					});
				} else {
					$this.find(".submit").click(function(){
						addInline(this);
					});
				}
				
				$this.find("textarea").enter(function(){
					addInline(this);
				});
				
				$this.find(".cancel").click(function(){
					Project.tform.hide(this);
				});
			});

			// Set default
			if (options.group){
				if (Board.data.model.metatype=="tasklist"){
					$(canvas).find("*[name=tasklist_id]").val(options.group.id);
				}
				
				if (Board.data.model.metatype=="milestone"){
					$(canvas).find("*[name=milestone_id]").val(options.group.id);
				}
				
				if (Board.data.model.metatype=="user" && options.group.id && parseInt(options.group.id)>0){
					$(canvas).find("*[name=assign]").val("@"+options.group.username);
				}
			}
		});
		
	};

	
	this.reset=function(){
		
	};
	
	
	this.hide=function(ref){
		if ($(ref).closest("#js-tform-dialog").length){
			AP.dialog("#js-tform-dialog").hide();
			return;
		}
		
		$(ref).closest(".board-add-wrap").removeClass("active");
	};
	
	
	this.dialog=function(opts){
		if (Client.pageData.project){
			return this.trueDialog(Client.pageData.project, opts);
		}
		
		Project.pick(function(p){
			Project.tform.trueDialog(p, opts);
		}, "Chá»n má»™t dá»± Ă¡n/phĂ²ng ban Ä‘á»ƒ táº¡o cĂ´ng viá»‡c");
	};
	
	
	this.trueDialog=function(project, opts){
		var html="<div id='tform-dialog'> <div class='header'> <div class='title'>Táº¡o cĂ´ng viá»‡c má»›i</div> <div class='close' onclick='Project.tform.hide(this);'><span class='-ap icon-close'></span></div> </div> <div id='js-tform-body' class='tform-body'></div> </div>";
		
		AP.customDialog(html, "#js-tform-dialog")
		.width(600)
		.css({right: $.sbWidth()})
		.closable(false)
		.addClass("-full tform-dialog")
		.show();
		
		this.build({
			project: project,
			canvas: "#js-tform-body",
			dialog: 1
		});
		
		if (opts){
			if (opts.tasklist){
				$("#js-tform-body *[name=tasklist_id]").val(opts.tasklist);
			}
			
			if (opts.user && opts.user!="0"){
				$("#js-tform-body *[name=assign]").val("@"+opts.user);
			}
			
			if (opts.milestone){
				$("#js-tform-body *[name=milestone_id]").val(opts.milestone);
			}
			
			if (opts.group){
				if (Board.data.model.metatype=="tasklist"){
					$("#js-tform-body *[name=tasklist_id]").val(opts.group.id);
				}
				
				if (Board.data.model.metatype=="milestone"){
					$("#js-tform-body *[name=milestone_id]").val(opts.group.id);
				}
				
				if (Board.data.model.metatype=="user"){
					$("#js-tform-body *[name=assign]").val("@"+opts.group.username);
				}
			}
		}

		AP.dialog("#js-tform-dialog").balance();
	};


	this.multiPeopleDialog = function(opts) {
		if (Client.pageData.project) {
			var project = Client.pageData.project;

			var html = "<div id='tform-dialog'> <div class='header'> <div class='title'>Giao cĂ´ng viá»‡c cho nhiá»u thĂ nh viĂªn</div> <div class='close' onclick='Project.tform.hide(this);'><span class='-ap icon-close'></span></div> </div> <div id='js-tform-body' class='tform-body'></div> </div>";
			
			AP.customDialog(html, "#js-tform-dialog")
			.width(600)
			.css({right: $.sbWidth()})
			.closable(false)
			.addClass("-full tform-dialog")
			.show();
			
			this.build({
				project: project,
				canvas: "#js-tform-body",
				dialog: 1,
				multi_people: 1
			});

			AP.dialog("#js-tform-dialog").balance();
		}
	};
	
	
	this.removeInputFile=function(ref){
		var $box=$(ref).closest(".atts");
		$(ref).closest(".att").remove();
		recountFiles($box);
	};
	
	
	function addInline(ref){		
		UI.ajaxShow();
		Form.submitFrom(ref, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			// $b.val("").focus();
			
			code.task.visible=1;
			// Board.kb.taskInsert(code.task, {header: header});
			// Project.sync(code.task, "new");
			
			// HOT FIX
			Side.milestone.update(code);
			Project.on.taskCreated(code.task);
			Project.tform.hide(ref);
			
			// AP.xRefresh();
		});
	};


	function addInlineMultiPeople(ref){		
		UI.ajaxShow();
		Form.submitFrom(ref, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.xRefresh();
		});
	};
	
	
	
	function getInlineForm(project, options) {
		var txt="TĂªn cĂ´ng viá»‡c *";	
		var symbol='';
		var mh=80;
		var compact_level=2;
		
		if (options.dialog){
			symbol='+ ';
			mh=100;
			compact_level=1;
		}

		if (!options.multi_people) {
			options.multi_people = 0;
		}
		
		var tasklist='';
		var tasklist_input='';
		
		if (!options.tasklist){
			var list_html=AP.render(options.project.cached_tasklists, function(e){
				if (parseInt(e.id)==0) {
					return "<option value='"+(e.id)+"'>ChÆ°a phĂ¢n loáº¡i</option>";
				} else {
					return "<option value='"+(e.id)+"'>"+(e.name)+"</option>";
				}
			});
			
			tasklist="<div class='frow'> <span class='icon'><span class='-ap icon-uniF11B'></span></span> <div class='relative'> <select name='tasklist_id'>"+(list_html)+"</select> </div> </div>";
		}else{
			tasklist_input="<input type='hidden' name='tasklist_id' value='"+(options.tasklist.id)+"'/>";
		}
		
		var deadline="<div class='input clear-fix'> <div class='w left'> <input type='text' name='deadline-date' placeholder='Thá»i háº¡n' data-role='date'/> </div> <div class='w right'> <input type='text' name='deadline-time' placeholder='Thá»i gian' data-role='time'/> </div> </div>";
		
		if (!parseInt(project.deadline_has_time)){
			deadline="<div class='input'> <input type='text' name='deadline' placeholder='Thá»i háº¡n' data-role='date'/> </div>";
		}
		
		var milestone_ip="<input type='hidden' name=milestone_id' value='0'/>";
		if (Client.pageData.milestones && Client.pageData.milestones.length && Client.pageData.project){
			var milestone_opts=AP.render(Client.pageData.milestones, function(e){
				if (!e.id || !parseInt(e.id)){
					return;
				}
				
				return "<option value='"+(e.id)+"'>Má»¥c tiĂªu "+(AP.i18n.datetime(e.time))+" - "+(e.name)+"</option>";
			});
			
			milestone_ip="<div class='frow'> <span class='icon'><span class='-ap icon-uniF10E'></span></span> <div class='input'> <select name='milestone_id'> <option value='0'>Lá»±a chá»n má»¥c tiĂªu</option> "+(milestone_opts)+" </select> </div> </div>";
		}

		var delegate_list = '';
		if (Client.delegators.length) {
			var delegate_opts = AP.render(Client.delegators, function(e){
				var u = People.get(e.delegator_username);

				if (u && parseInt(u.error)) {
					return;
				}

				var u_name = u.name;
				var u_title = u.title ? " - " + u.title : "";
				
				return "<option value='"+(u.username)+"'>"+(u_name)+""+(u_title)+"</option>";
			});

			delegate_list="<div class='frow'> <span class='icon'><span class='-ap icon-share5'></span></span> <div class='input'> <select name='delegator'> <option value='0'>Chá»n ngÆ°á»i giao viá»‡c</option> "+(delegate_opts)+" </select> </div> </div>";
		}

		var action_api = "api/task/add";
		var assign = "<div class='frow'> <span class='icon'><span class='-ap icon-uniF13B'></span></span> <div class='input'> <input type='text' name='assign' placeholder='GĂ¡n @ Ä‘á»ƒ giao viá»‡c' data-role='tag'/> </div> </div>";

		if (options.multi_people) {
			action_api = "api/task/add.multi.people";
			assign = "<div class='frow'> <span class='icon'><span class='-ap icon-uniF13B'></span></span> <div class='input'> <input type='text' name='assign' placeholder='GĂ¡n @ Ä‘á»ƒ giao viá»‡c cho nhiá»u thĂ nh viĂªn (tá»‘i Ä‘a 10 thĂ nh viĂªn)' data-role='tag'/> </div> </div>";
		}

		return "<div class='board-add-wrap'> <div class='board-add'><span class='-ap icon-plus2'></span> ThĂªm cĂ´ng viá»‡c</div> <div class='inline-form'> <form method='POST' action='"+(action_api)+"'> <div class='formbox'> <input type='hidden' name='id' value='"+(options.project.id)+"'/> <input type='hidden' name='deadline_fulltime' value='"+(project.deadline_has_time)+"'/> "+(tasklist_input)+" <textarea name='name' placeholder='"+(txt)+"' class='-big'></textarea> <div class='sep'></div> <div class='relative'> <textarea name='content' placeholder='MiĂªu táº£ cĂ´ng viá»‡c' data-role='editor' data-dir='bottom' data-compact='"+(compact_level)+"' data-minheight='"+(mh)+"'></textarea> </div> <div class='cform hidden' id='"+(options.cform_id)+"'></div> <div class='frows'> "+(assign)+" "+(tasklist)+" <div class='frow'> <span class='icon'><span class='-ap icon-uniF1072'></span></span> <div class='input'> <input type='text' name='start_time' placeholder='NgĂ y báº¯t Ä‘áº§u' data-role='date'/> </div> </div> <div class='frow'> <span class='icon'><span class='-ap icon-uniF1072'></span></span> "+(deadline)+" </div> "+(milestone_ip)+" "+(delegate_list)+" <div class='frow hidden js-tags'> <span class='icon'><span class='-ap icon-tag2'></span></span> <div class='input'> <input type='text' name='tags' placeholder='Danh sĂ¡ch nhĂ£n'/> </div> </div> <div class='frow hidden js-followers'> <span class='icon'><span class='-ap icon-uniF106'></span></span> <div class='input'> <input type='text' name='followers' placeholder='NgÆ°á»i theo dĂµi' data-role='tag'/> </div> </div> </div> <div class='atts'></div> <div class='sep'></div> <div class='more'> <div class='more-link'> <span class='inline ap-f13' style='vertical-align:2px'>+</span>&nbsp; <span class='action js-add-file'>"+(symbol)+"TĂ i liá»‡u Ä‘Ă­nh kĂ¨m</span> <span class='inline'>&middot;</span> <span class='action js-add-drive'>"+(symbol)+"drive</span> <span class='inline'>&middot;</span> <span class='action js-add-tags'>"+(symbol)+"Danh sĂ¡ch nhĂ£n</span> <span class='inline'>&middot;</span> <span class='action js-add-followers'>"+(symbol)+"NgÆ°á»i theo dĂµi</span> </div> <div class='more-contents'></div> </div> </div> <div class='buttons'> <div class='submit url' data-feature='wework:wework_task_created:task'>ThĂªm cĂ´ng viá»‡c</div> <div class='cancel'><span class='-ap icon-close'></span></div> </div> </form> </div> </div>";
	};
	
	
	function recountFiles(selector){
		var total=$(selector).find(".att").length;
		if (total==0){
			$(selector).hide();
		}else{
			$(selector).show();
		}
	};


	function displayPlaceholder() {

	  	$(".inline-form .cform .row").each(function() {
			if ($(this).find(".label span").html()) {
				var title = $(this).attr('title');
				title = title.replace(/\-\-br\-\-/g, "");
				title = title.replace(/<br\s*[\/]?>/gi, "");
				$(this).attr("title", title);

				var placeholder = $(this).find(".label span").html().replace(/\-\-br\-\-/g, " ");
				placeholder = placeholder.replace(/<br\s*[\/]?>/gi, " ");
				$(this).find(".label span").html(placeholder);
			}
	  	});

	  	$(".inline-form .cform .row .input").find("input").each(function() {
			var placeholder = $(this).attr('placeholder');
			if (placeholder) {
				placeholder = placeholder.replace(/\-\-br\-\-/g, " ");
				placeholder = placeholder.replace(/<br\s*[\/]?>/gi, " ");
		    	$(this).attr("placeholder", placeholder);
		    }
	  	});

	  	$(".inline-form .cform .row .input").find("textarea").each(function() {
			var placeholder = $(this).attr('placeholder');
			if (placeholder) {
				placeholder = placeholder.replace(/\-\-br\-\-/g, "");
				placeholder = placeholder.replace(/<br\s*[\/]?>/gi, "");
		    	$(this).attr("placeholder", placeholder);
		    }
	  	});

	  	$(".inline-form .cform .row .label").each(function() {
			$(this).addClass("ap-xdot");
		});
	};
};



 

Project.form = new function __ProjectForm() {

	this.create = function() {
		var data={metatype: "project"};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/create"})
		.row(
			Form.label({label: "TĂªn dá»± Ă¡n"}),
			Form.input({name: 'name', placeholder: "TĂªn dá»± Ă¡n"})
		).addClass("-big")
		.row(
			Form.label({label: "ThĂ nh viĂªn quáº£n trá»‹ dá»± Ă¡n"}),
			Form.input({name: 'owners', "placeholder":"@ Ä‘á»ƒ tag"}).value("@"+Client.viewer.username+" ")
		).addClass("-big")
		.row(
			Form.label({label: "ThĂ nh viĂªn thá»±c hiá»‡n dá»± Ă¡n"}),
			Form.input({name: 'followers', "placeholder":"@ Ä‘á»ƒ tag thĂ nh viĂªn thá»±c hiá»‡n dá»± Ă¡n"})
		).addClass("-big")
		.rowHidden(
			Form.label({label: "ThĂªm nhanh thĂ nh viĂªn theo teams"}),
			Form.input({name: 'teams', "placeholder":"Nháº­p Ä‘á»ƒ chá»n táº¥t cáº£ cĂ¡c thĂ nh viĂªn vĂ  cĂ¡c nhĂ³m", role: "teams"})
		).addClass("-big")
		.plain("<span class='a' id='js-form-add-teams'>Hoáº·c thĂªm thĂ nh viĂªn tá»« cĂ¡c team ... </span>")
		.row(
			Form.label({label: "Department"}),
			Form.input({name: 'dept_id', "placeholder":"Department", type:"select", empty: {label: "ChÆ°a xĂ¡c Ä‘á»‹nh", value:0}, options: Form.convert(Client.depts)})
		)
		.row(
			Form.label({label: "PhĂ¢n loáº¡i dá»± Ă¡n"}),
			Form.input({name:"external", type:"list", options:[{"label":"Dá»± Ă¡n ná»™i bá»™ cĂ´ng ty", sublabel:"Dá»± Ă¡n ná»™i bá»™ cĂ´ng ty", value: "0"}, {"label":"Dá»± Ă¡n lĂ m viá»‡c vá»›i khĂ¡ch hĂ ng", sublabel: "Báº¡n cĂ³ thá»ƒ thĂªm tĂ i khoáº£n khĂ¡ch hĂ ng vĂ o dá»± Ă¡n", value: "1"}]}).value(0)
		).addClass("-active")
		.row(
			Form.label({label: "Máº«u dá»± Ă¡n"}),
			Form.input({name:"template_id", type:"select", options: Project.template.options()}).value(0)
		).addClass("-active")
		.wrap("CĂ i Ä‘áº·t nĂ¢ng cao","#advopts")
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u"}),
			Form.input({name: 'stime', "placeholder":"NgĂ y báº¯t Ä‘áº§u", role:"date"})
		)
		.row(
			Form.label({label: "NgĂ y káº¿t thĂºc"}),
			Form.input({name: 'etime', "placeholder":"NgĂ y káº¿t thĂºc", role:"date"})
		)
		.row(
			Form.label({label: "Tráº¡ng thĂ¡i hiá»‡n táº¡i"}),
			Form.input({name: 'stage', type:"select", options:Project.status.statuses})
		)
		.row(
			Form.label({label: "MĂ´ táº£",}),
			Form.input({name: 'content', "placeholder":"MĂ´ táº£ ngáº¯n vá» dá»± Ă¡n", type:"textarea"})
		)
		.row(
			Form.label({label: "Chá»n mĂ u Ä‘áº·c trÆ°ng cá»§a dá»± Ă¡n"}),
			Form.input({name: 'color', "placeholder":"Select project color", type:"colors"})
		).addClass("-active")
		.wrap()
		.rowHTML("<span class='link'>+ CĂ i Ä‘áº·t nĂ¢ng cao</span>")
		.buttons([
			 {label: "ThĂªm dá»± Ă¡n má»›i", action: function(){
				 Form.submit("#fly-workflow-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 AP.redirect(code.project.path);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-workflow-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			form.selector(".link").click(function(){
				$("#advopts").toggle();
			})
			
			$("#js-form-add-teams").click(function(){
				form.findRow("teams").show();
				form.find("teams").focus();
				$(this).parent().hide();
			});

			Form.select.improve($("#fly-workflow-fx .row .select select"));

			$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_created:project");
		});

		Form.pop({width: 480, label: 'ThĂªm dá»± Ă¡n má»›i', layout: 'flat', closable : false}).setForm(form).show().focus('name');
		Tag.user(form.find("owners"), Client.people);
		Tag.user(form.find("followers"), Client.people);
	};


	this.duplicate = function(id, name) {
		var data={metatype: "project"};
		var hiddens={id: id};
		var form=Form.create('fly-workflow-fx',{'action': "api/project/duplicate"})
			.row(
				Form.label({label: "TĂªn dá»± Ă¡n"}),
				Form.input({name: 'name', "placeholder":"TĂªn dá»± Ă¡n"}).value('báº£n sao cá»§a ' + name).autoSubmit()
			).addClass("-big")
			.row(
				Form.label({label: "NhĂ¢n báº£n cĂ´ng viá»‡c"}),
				Form.input({name: 'keep_tasks', type:"select", options:[{value:2, label:"NhĂ¢n báº£n táº¥t cáº£ cĂ´ng viá»‡c vĂ  nhĂ³m cĂ´ng viá»‡c"}, {value:1, label:"NhĂ¢n báº£n nhĂ³m cĂ´ng viá»‡c"}, {value:0, label:"KhĂ´ng nhĂ¢n báº£n cĂ´ng viá»‡c vĂ  nhĂ³m cĂ´ng viá»‡c"}]})
			).addClass("-big")
			.row(
				Form.label({label: "Giá»¯ láº¡i thĂ´ng tin ngÆ°á»i giao"}),
				Form.input({name: 'keep_assigner', type:"select", options:[{value:1, label:"CĂ³, giá»¯ nguyĂªn thĂ´ng tin ngÆ°á»i giao viá»‡c"}, {value:0, label:"KhĂ´ng, thiáº¿t láº­p TĂ”I lĂ  ngÆ°á»i giao viá»‡c"}]})
			)
			.row(
				Form.label({label: "Giá»¯ láº¡i thĂ´ng tin ngÆ°á»i nháº­n"}),
				Form.input({name: 'keep_assignee', type:"select", options:[{value:1, label:"CĂ³, giá»¯ nguyĂªn thĂ´ng tin ngÆ°á»i nháº­n viá»‡c"}, {value:0, label:"KhĂ´ng, bá» trá»‘ng thĂ´ng tin ngÆ°á»i nháº­n viá»‡c"}]})
			)
			.row(
				Form.label({label: "Giá»¯ láº¡i thĂ´ng tin ngÆ°á»i theo dĂµi"}),
				Form.input({name: 'keep_followers', type:"select", options:[{value:1, label:"CĂ³, giá»¯ láº¡i táº¥t cáº£ ngÆ°á»i theo dĂµi cĂ´ng viá»‡c"}, {value:0, label:"KhĂ´ng, bá» trá»‘ng thĂ´ng tin ngÆ°á»i theo dĂµi"}]})
			)
			.row(
				Form.label({label: "Giá»¯ láº¡i thĂ´ng tin háº¡n hoĂ n thĂ nh"}),
				Form.input({name: 'keep_deadline', type:"select", options:[{value:1, label:"CĂ³, giá»¯ nguyĂªn thĂ´ng tin háº¡n hoĂ n thĂ nh"}, {value:2, label:"CĂ³, giá»¯ láº¡i vĂ  thay Ä‘á»•i thĂ´ng tin háº¡n hoĂ n thĂ nh"}, {value:0, label:"KhĂ´ng, khĂ´ng thiáº¿t láº­p háº¡n hoĂ n thĂ nh cho cĂ´ng viá»‡c"}]}).value(0)
			)
			.rowHidden(
				Form.label({label: "Äiá»u chá»‰nh háº¡n hoĂ n thĂ nh (theo giá»)"}),
				Form.input({name: 'adjust_hours', type:"text", "placeholder": "Äiá»n sá»‘ giá» Ä‘iá»u chá»‰nh - háº¡n hoĂ n thĂ nh má»›i báº±ng háº¡n hoĂ n thĂ nh cÅ© cá»™ng thĂªm giá» Ä‘iá»u chá»‰nh"})
			)
			.row(
				Form.label({label: "Giá»¯ láº¡i trÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh"}),
				Form.input({name: 'keep_form', type:"select", options:[{value:1, label:"CĂ³, giá»¯ láº¡i trÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh"}, {value:0, label:"KhĂ´ng, xĂ³a háº¿t trÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh"}]})
			)
			.row(
				Form.label({label: "Giá»¯ láº¡i checklist"}),
				Form.input({name: 'keep_checklists', type:"select", options:[{value:1, label:"CĂ³, giá»¯ láº¡i checklist"}, {value:0, label:"KhĂ´ng, xĂ³a háº¿t checklist"}]}).value(0)
			)
			.row(
				Form.label({label: "Giá»¯ láº¡i cĂ´ng viá»‡c con"}),
				Form.input({name: 'keep_subtasks', type:"select", options:[{value:1, label:"CĂ³, giá»¯ láº¡i cĂ¡c cĂ´ng viá»‡c con Ä‘i kĂ¨m"}, {value:0, label:"KhĂ´ng, xĂ³a cĂ¡c cĂ´ng viá»‡c con"}]}).value(0)
			)
			.row(
				Form.label({label: "Giá»¯ láº¡i thĂ´ng tin háº¡n hoĂ n thĂ nh cá»§a cĂ´ng viá»‡c con"}),
				Form.input({name: 'keep_subtasks_deadline', type:"select", options:[{value:1, label:"CĂ³, giá»¯ nguyĂªn thĂ´ng tin háº¡n hoĂ n thĂ nh"}, {value:0, label:"KhĂ´ng, khĂ´ng thiáº¿t láº­p háº¡n hoĂ n thĂ nh cho cĂ´ng viá»‡c con"}]}).value(0)
			)
			.hiddens(hiddens)
			.row(
				Form.label({label: "Bao gá»“m"}),
				Form.input({name: 'options', type:"checkboxes",
					options:[
						{label:"NgÆ°á»i quáº£n trá»‹", value: 'owners'},
						{label:"ThĂ nh viĂªn dá»± Ă¡n", value: 'followers'},
						{label:"PhĂ¢n quyá»n sá»­ dá»¥ng", value: 'acl'},
						{label:"Danh sĂ¡ch nhĂ£n", value: 'tags'}]}
				).value(["owners","followers", "acl","tags"])
			)
			.buttons([
				{label: "NhĂ¢n báº£n dá»± Ă¡n", action: function(){
					Form.submit("#fly-workflow-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						AP.redirect(code.project.path);
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function(){
					Form.hide("fly-workflow-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(form){
				form.find("keep_tasks").on("change", function(){
					var v=$(this).val();
					if (parseInt(v)==2 || parseInt(v)==2){
						form.findRow("keep_assigner").show();
						form.findRow("keep_assignee").show();
						form.findRow("keep_followers").show();
						form.findRow("keep_deadline").show();
						form.findRow("keep_subtasks").show();
						form.findRow("keep_form").show();
						form.findRow("keep_checklists").show();
					}else{
						form.findRow("keep_assigner").hide();
						form.findRow("keep_assignee").hide();
						form.findRow("keep_followers").hide();
						form.findRow("keep_subtasks").hide();
						form.findRow("keep_deadline").hide();
						form.findRow("keep_form").hide();
						form.findRow("keep_checklists").hide();
					}
				}).change();
				
				form.selector(".link").click(function(){
					$("#advopts").toggle();
				})
				
				form.find("keep_deadline").on("change", function(){
					var v=$(this).val();
					if (parseInt(v)==2){
						form.findRow("adjust_hours").show();
					}else{
						form.findRow("adjust_hours").hide();
					}
				}).change();
			});

		Form.pop({width: 480, label: 'NhĂ¢n báº£n dá»± Ă¡n', layout: 'flat', closable : false}).setForm(form).show().focus('name');
	};


	this.download = function(project) {
		var data = {metatype: "project"};
		var fields = project.form;
		var options = [];

		for (var i = 0, len = fields.length; i < len; i++) {
			var item = new Object();
			item.label = fields[i].name;
			item.value = fields[i].id;
			options[i] = item;
		}

		var hiddens = {id: project.id};
		var form = Form.create('fly-workflow-fx',{'action': "api/task/export"})
			.hiddens(hiddens)
			.row(
				Form.label({label: "Tá»« ngĂ y"}),
				Form.input({name: 'start_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  ngĂ y táº¡o dá»± Ă¡n"}).value(project.since)
			)
			.row(
				Form.label({label: "Äáº¿n ngĂ y"}),
				Form.input({name: 'end_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  hĂ´m nay"}).value(AP.time.now())
			)
			.row(
				Form.label({label: 'Xuáº¥t cĂ´ng viá»‡c con ra excel?'}),
				Form.input({name: 'subtask', type:"list",
					options: [
						{label:"CĂ³", value:'1'},
						{label:"KhĂ´ng", value:'0'},
				]}).value(1)
			)
			.row(
				Form.label({label: 'CÄƒn cá»© theo'}),
				Form.input({name: 'type', type:"list",
					options: [
						{label:"Thá»i gian táº¡o", value:'created_time'},
						{label:"Thá»i gian thá»±c hiá»‡n", value:'active_time'},
						{label:"Thá»i háº¡n", value:'deadline'}
					]	
				}).value("created_time")
			);

		if (options.length > 0) {
			form.row(
				Form.label({label: 'ThĂªm trÆ°á»ng tĂ¹y chá»‰nh'}),
				Form.input({name: 'duplicate_field', type:"checkboxes",
					options:options
				})
			)
		}

		form.buttons([
			{label: "Xuáº¥t", action: function() {
				var ps = $("#fly-workflow-fx").serializeArray();
				var fields = "";
				ps = AP.array.filter(ps, function(e) {
					if (e.name == "duplicate_field[]") {
						fields += e.value + ",";
					}
					
					return e.name != "__code" && e.name != "metatype" && e.name != "duplicate_field[]";
				});
				
				ps = $.param(assoc(ps));
				ps += "&fields=" + fields + "&export=1";
				
				var url = Client.url + "/" + Client.pageData.context.path + "/tool/export?" + ps;
				window.open(url);
				
				return;
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function() {
				Form.hide("fly-workflow-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form) {
			form.selector(".link").click(function() {
				$("#advopts").toggle();
			});

			var check_all = "<div class='check-all' data-check='none'>Chá»n táº¥t cáº£</div>";

			form.findRow("duplicate_field[]").find(".label").prepend(check_all);

			form.findRow("duplicate_field[]").find(".label .check-all").click(function () {

				var check_data = $(this).data("check");

				if (check_data == "none") {

					$(this).data("check", "all").addClass("red").html("Bá» chá»n táº¥t cáº£");

					form.findRow("duplicate_field[]").find(".data .list.checkboxes .li.block").each(function() {
						$(this).find("input").prop("checked", true);
				  	});
				} else if (check_data == "all") {

					$(this).data("check", "none").removeClass("red").html("Chá»n táº¥t cáº£");

					form.findRow("duplicate_field[]").find(".data .list.checkboxes .li.block").each(function() {
						$(this).find("input").prop("checked", false);
				  	});
				}
			});

			if (project.metatype == "project") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_export_excel:project");
			} else if (project.metatype == "team") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_export_excel:project");
			} else if (project.metatype == "private") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_private_export_excel:project");
			}
		});

		Form.pop({width: 480, label: 'TrĂ­ch xuáº¥t cĂ´ng viá»‡c', layout: 'flat'}).setForm(form).show().focus('name');
	};


	this.downloadWithTable = function(project) {
		var data = {metatype: "project"};
		var fields = project.form;
		var options = [];
		var table_options = [];

		for (var i = 0, len = fields.length; i < len; i++) {
			var item = new Object();
			item.label = fields[i].name;
			item.value = fields[i].id;
			options.push(item);
			if (fields[i].type == 'input-table') {
				table_options.push(item);
			}
		}

		var hiddens = {id: project.id};
		var form = Form.create('fly-workflow-fx',{'action': "api/task/export"})
			.hiddens(hiddens)
			.row(
				Form.label({label: "Tá»« ngĂ y"}),
				Form.input({name: 'start_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  ngĂ y táº¡o dá»± Ă¡n"}).value(project.since)
			)
			.row(
				Form.label({label: "Äáº¿n ngĂ y"}),
				Form.input({name: 'end_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  hĂ´m nay"}).value(AP.time.now())
			)
			.row(
				Form.label({label: 'Xuáº¥t cĂ´ng viá»‡c con ra excel?'}),
				Form.input({name: 'subtask', type:"list",
					options: [
						{label:"CĂ³", value:'1'},
						{label:"KhĂ´ng", value:'0'},
				]}).value(1)
			)
			.row(
				Form.label({label: 'CÄƒn cá»© theo'}),
				Form.input({name: 'type', type:"list",
					options: [
						{label:"Thá»i gian táº¡o", value:'created_time'},
						{label:"Thá»i gian thá»±c hiá»‡n", value:'active_time'},
						{label:"Thá»i háº¡n", value:'deadline'}
					]	
				}).value("created_time")
			);

		if (options.length > 0) {
			var option_values = ARR.select(options, function (e) {
				return e.value;
			});
			form.row(
				Form.label({label: 'ThĂªm trÆ°á»ng tĂ¹y chá»‰nh'}),
				Form.input({name: 'duplicate_field', type:"checkboxes",
					options:options
				}).value(option_values)
			)
		}

		if (table_options.length > 0) {

			form.row(
				Form.label({label: 'Chá»n trÆ°á»ng dáº¡ng báº£ng báº¡n muá»‘n má»Ÿ rá»™ng', sublabel: 'Báº¡n cáº§n chá»n trong sá»‘ cĂ¡c trÆ°á»ng trong pháº§n export (Tá»‘i Ä‘a 5 trÆ°á»ng)<br/>Má»—i trÆ°á»ng Ä‘Æ°á»£c má»Ÿ rá»™ng tÆ°Æ¡ng á»©ng vá»›i má»™t sheet<br/>Má»—i trÆ°á»ng nĂ y sáº½ Ä‘Æ°á»£c má»Ÿ rá»™ng á»Ÿ phĂ­a cuá»‘i má»—i sheet'}),
				Form.input({name: 'table_fields', type:"checkboxes",
					options:table_options
				})
			);
		}

		form.buttons([
			{label: "Xuáº¥t", action: function() {
				var ps = $("#fly-workflow-fx").serializeArray();
				var fields = "";
				var table_fields = "";
				ps = AP.array.filter(ps, function(e) {
					if (e.name == "duplicate_field[]") {
						fields += e.value + ",";
					}

					if (e.name == "table_fields[]") {
						table_fields += e.value + ",";
					}
					
					return e.name != "__code" && e.name != "metatype" && e.name != "duplicate_field[]" && e.name != "table_fields[]";
				});
				
				ps = $.param(assoc(ps));
				ps += "&fields=" + fields + "&table_fields=" + table_fields + "&export=1";
				
				var url = Client.url + "/" + Client.pageData.context.path + "/tool/export/custom.table?" + ps;
				window.open(url);
				
				return;
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function() {
				Form.hide("fly-workflow-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form) {
			form.selector(".link").click(function() {
				$("#advopts").toggle();
			});

			var check_all = "<div class='red check-all' data-check='all'>Bá» chá»n táº¥t cáº£</div>";

			form.findRow("duplicate_field[]").find(".label").prepend(check_all);

			form.findRow("duplicate_field[]").find(".label .check-all").click(function () {

				var check_data = $(this).data("check");

				if (check_data == "none") {

					$(this).data("check", "all").addClass("red").html("Bá» chá»n táº¥t cáº£");

					form.findRow("duplicate_field[]").find(".data .list.checkboxes .li.block").each(function() {
						$(this).find("input").prop("checked", true);
				  	});
				} else if (check_data == "all") {

					$(this).data("check", "none").removeClass("red").html("Chá»n táº¥t cáº£");

					form.findRow("duplicate_field[]").find(".data .list.checkboxes .li.block").each(function() {
						$(this).find("input").prop("checked", false);
				  	});
				}
			});

			if (project.metatype == "project") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_export_table_excel:project");
			} else if (project.metatype == "team") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_export_table_excel:project");
			} else if (project.metatype == "private") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_private_export_table_excel:project");
			}
		});

		Form.pop({width: 480, label: 'TrĂ­ch xuáº¥t cĂ´ng viá»‡c', layout: 'flat'}).setForm(form).show().focus('name');
	};



	this.downloadMyTasks = function(project) {
		var data = {metatype: "project"};
		var fields = project.form;
		var options = [];

		for (var i = 0, len = fields.length; i < len; i++) {
			var item = new Object();
			item.label = fields[i].name;
			item.value = fields[i].id;
			options[i] = item;
		}

		var hiddens = {id: project.id};
		var form = Form.create('fly-workflow-fx', {'action': "api/task/export.my.tasks"})
			.hiddens(hiddens)
			.row(
				Form.label({label: "Tá»« ngĂ y"}),
				Form.input({name: 'start_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  ngĂ y táº¡o dá»± Ă¡n"}).value(project.since)
			)
			.row(
				Form.label({label: "Äáº¿n ngĂ y"}),
				Form.input({name: 'end_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  hĂ´m nay"}).value(AP.time.now())
			)
			.row(
				Form.label({label: 'CÄƒn cá»© theo'}),
				Form.input({name: 'type', type:"list",
					options: [
						{label:"Thá»i gian táº¡o", value:'created_time'},
						{label:"Thá»i gian thá»±c hiá»‡n", value:'active_time'},
						{label:"Thá»i háº¡n", value:'deadline'}
					]	
				}).value("created_time")
			);

		if (options.length > 0) {
			
			form.row(
				Form.label({label: 'ThĂªm trÆ°á»ng tĂ¹y chá»‰nh'}),
				Form.input({name: 'duplicate_field', type:"checkboxes",
					options: options
				})
			)
		}

		form.buttons([
			{label: "Export", action: function() {
				var ps = $("#fly-workflow-fx").serializeArray();
				var fields = "";
				ps = AP.array.filter(ps, function(e) {
					if (e.name == "duplicate_field[]") {
						fields += e.value + ",";
					}
					
					return e.name != "__code" && e.name != "metatype" && e.name != "duplicate_field[]";
				});
				
				ps = $.param(assoc(ps));
				ps += "&fields=" + fields + "&export=1";
				
				var url = Client.url + "/" + Client.pageData.context.path + "/tool/export/my.tasks?" + ps;
				window.open(url);
				
				return;
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function() {
				Form.hide("fly-workflow-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form) {
			form.selector(".link").click(function() {
				$("#advopts").toggle();
			});

			var check_all = "<div class='check-all' data-check='none'>Chá»n táº¥t cáº£</div>";

			form.findRow("duplicate_field[]").find(".label").prepend(check_all);

			form.findRow("duplicate_field[]").find(".label .check-all").click(function () {

				var check_data = $(this).data("check");

				if (check_data == "none") {

					$(this).data("check", "all").addClass("red").html("Bá» chá»n táº¥t cáº£");

					form.findRow("duplicate_field[]").find(".data .list.checkboxes .li.block").each(function() {
						$(this).find("input").prop("checked", true);
				  	});
				} else if (check_data == "all") {

					$(this).data("check", "none").removeClass("red").html("Chá»n táº¥t cáº£");

					form.findRow("duplicate_field[]").find(".data .list.checkboxes .li.block").each(function() {
						$(this).find("input").prop("checked", false);
				  	});
				}
			});

			if (project.metatype == "project") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_my_tasks_export_excel:project");
			} else if (project.metatype == "team") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_my_tasks_export_excel:project");
			} else if (project.metatype == "private") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_private_my_tasks_export_excel:project");
			}
		});

		Form.pop({width: 480, label: 'TrĂ­ch xuáº¥t cĂ´ng viá»‡c', layout: 'flat'}).setForm(form).show().focus('name');
	};


	this.downloadGanttChart = function(project) {

		var data = {metatype: "project"};
		var fields = project.form;
		var options = [];

		for (var i = 0, len = fields.length; i < len; i++) {
			var item = new Object();
			item.label = fields[i].name;
			item.value = fields[i].id;
			options[i] = item;
		}

		var hiddens = {id: project.id};
		var form = Form.create('fly-workflow-fx',{'action': "api/task/export"})
		.hiddens(hiddens)
		.row(
			Form.label({label: "Tá»« ngĂ y"}),
			Form.input({name: 'start_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  ngĂ y táº¡o dá»± Ă¡n"}).value(project.since)
		)
		.row(
			Form.label({label: "Äáº¿n ngĂ y"}),
			Form.input({name: 'end_time', type:"text", role: "date", placeholder: "Máº·c Ä‘á»‹nh lĂ  hĂ´m nay"}).value(AP.time.now())
		)
		.row(
			Form.label({label: 'Xuáº¥t cĂ´ng viá»‡c con ra excel?'}),
			Form.input({name: 'subtask', type:"list",
				options: [
					{label:"CĂ³", value:'1'},
					{label:"KhĂ´ng", value:'0'},
				]
			}).value(1)
		);

		form.buttons([
			{label: "Export", action: function() {
				var ps = $("#fly-workflow-fx").serializeArray();
				var fields = "";
				ps = AP.array.filter(ps, function(e) {
					return e.name != "__code" && e.name != "metatype";
				});
				
				ps = $.param(assoc(ps));
				ps += "&export=1";
				
				var url = Client.url + "/" + Client.pageData.context.path + "/tool/export/gantt.chart?" + ps;
				window.open(url);
				
				return;
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function() {
				Form.hide("fly-workflow-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form) {
			form.selector(".link").click(function() {
				$("#advopts").toggle();
			});

			if (project.metatype == "project") {
				$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_export_gantt_chart_excel:project");
			}
		});

		Form.pop({width: 480, label: 'Xuáº¥t biá»ƒu Ä‘á»“ Gantt', layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	
	this.edit = function(project) {
		if (!project) {
			return;
		}
		
		var icon=parseInt(project.icon);
		if (!icon){
			icon=true;
		}
		
		var data={id: project.id, hid: project.hid, token: project.token};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/edit"})
		.row(
			Form.label({label: "TĂªn dá»± Ă¡n/phĂ²ng ban",sublabel: ""}),
			Form.input({name: 'name', "placeholder":"TĂªn dá»± Ă¡n/phĂ²ng ban", icon_picker: icon}).value(project.name)
		)
		.row(
			Form.label({label: "Department"}),
			Form.input({name: 'dept_id', "placeholder":"PhĂ¢n nhĂ³m dá»± Ă¡n (cĂ³ thá»ƒ Ä‘á»ƒ trá»‘ng)", type:"select", empty: {label: "ChÆ°a xĂ¡c Ä‘á»‹nh", value:0}, options: Form.convert(Client.depts)}).value(project.dept_id)
		)
		.rowHidden(
			Form.label({label: "NgÆ°á»i quáº£n trá»‹",sublabel: ""}),
			Form.input({name: 'owners', type:"text", role: "tag"}).value(UI.objectsToUsernames(project.owners))
		)
		.rowHidden(
			Form.label({label: "ThĂ nh viĂªn tham gia",sublabel: ""}),
			Form.input({name: 'followers', type:"text", "role": "tag"}).value(UI.objectsToUsernames(project.followers))
		)
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u vĂ  káº¿t thĂºc",sublabel: ""}),
			Form.inputGroup([
				Form.input({name: 'stime', "placeholder":"Chá»n ngĂ y báº¯t Ä‘áº§u", role:"date"}).valueIf(project.stime, project.stime),
				Form.input({name: 'etime', "placeholder":"Chá»n ngĂ y káº¿t thĂºc", role:"date"}).valueIf(project.etime, project.etime)
			])
		)
		.row(
			Form.label({label: "MĂ´ táº£ Dá»± Ă¡n/PhĂ²ng ban",sublabel: ""}),
			Form.input({name: 'content', "placeholder":"MĂ´ táº£ ngáº¯n gá»n vá» dá»± Ă¡n", type:"textarea"}).value(project.content)
		)
		.buttons([
			 {label: "LÆ°u", action: function(){
				 Form.submit("#fly-workflow-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Update successfully");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-workflow-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			Form.select.improve($("#fly-workflow-fx .row .select select"));
		});
	
		Form.pop({width: 480, label: 'Chá»‰nh sá»­a: '+project.name, layout: 'flat'}).setForm(form).show().focus('name');
	};
	
		
	this.removeItem = function(item) {
		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n xoĂ¡ cĂ´ng viá»‡c <b>"+item.name+"</b>? CĂ´ng viá»‡c Ä‘Ă£ xoĂ¡ sáº½ khĂ´ng thá»ƒ khĂ´i phá»¥c.", function(){
			AP.post("api/project/item/remove", {hid: Client.pageData.project.hid, token: Client.pageData.project.token, key: item.key}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				$.log("CĂ´ng viá»‡c Ä‘Ă£ Ä‘Æ°á»£c xĂ³a");
			});
		});
	};
	
	
	this.tick = function(ref) {
		var item=$(ref).closest(".node").data("object");
		AP.post("api/project/item/tick", {hid: Client.pageData.project.hid, token: Client.pageData.project.token, key: item.key}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
		});
	};

	this.import = function() {
		var columns = [
            {label: "TĂªn", name: "name"},
            {label: "Quáº£n trá»‹ dá»± Ă¡n", name: "owners"},
            {label: "ThĂ nh viĂªn thá»±c hiá»‡n dá»± Ă¡n", name: "followers"},
            {label: "ThĂ nh viĂªn theo nhĂ³m ngÆ°á»i dĂ¹ng", name: "teams"},
            {label: "Dept ID", name: "dept_id"},
            {label: "PhĂ¢n loáº¡i dá»± Ă¡n", name: "external"},
            {label: "NgĂ y báº¯t Ä‘áº§u", name: "stime"},
            {label: "NgĂ y káº¿t thĂºc", name: "etime"},
            {label: "Tráº¡ng thĂ¡i hiá»‡n táº¡i", name: "stage"},
            {label: "MĂ´ táº£", name: "content"},
            {label: "MĂ u Ä‘áº·c trÆ°ng cá»§a dá»± Ă¡n", name: "color"},
        ];

        Base.importer.dialog({
            action: "api/project/import/projects",
            rows: [],
            columns: columns,
            data:[],
            title: "Nháº­p dá»± Ă¡n tá»« excel"
        });
	}
};





Project.on=new function __ProjectEventCallback(){
	this.taskCreated=function(task){
		// c.visible=Board.filter.getVisible(c);

		if (Client.pageData.project){
			var c=Board.data.insert(task);
			
			if (Client.pageData.task_view=="stream"){
				Team.stream.rebuild();
			}else if (Client.pageData.task_view=="period"){
				Team.period.rebuild();
			}else{
				Board.display();	
			}
			
			// Calendar.taskCreated(c);
			return;
		}else{
			var c=Board.data.insert(task);
			List.onCreate(c);
		}
	};	
	
	
	this.taskUpdated=function(task, comment){
		if (requireReset(task)){
			Board.data.update(task);
			Board.reset();
			return;
		}
		
		if (!Client.pageData.tasks){
			TaskDisplay.taskUpdated(task);
			Calendar.taskUpdated(task);
			return;
		}
		
		hotfixInlineStatus(task);
		
		var update=Board.data.update(task);
		if (!update){
			TaskDisplay.taskUpdated(task);
			$("#tasklists .js-task").setActive("#task-"+task.id);
			$("#tasklists .js-subtask").setActive("#task-"+task.id);
			return;
		}

		Board.list.taskUpdated(update);
		Board.table.taskUpdated(update);
		Board.kb.taskUpdated(update);
		TaskDisplay.taskUpdated(update);
		// Calendar.taskUpdated(update);

		if (Client.tempData && Client.tempData.task && Client.tempData.task.id==task.id){
			$("#tasklists .js-task").setActive("#task-"+task.id);
			$("#tasklists .js-subtask").setActive("#task-"+task.id);

			if (comment){
				Task.inline.insertComment(comment, task);
			}
		}

		Task.ie.close();
	};
	
	this.taskDeleted=function(task_id){
		// if (tasklist) {
			// $("#tasklist-"+tasklist.id+" .name .istats").html("  â€”  " + tasklist.stats.done+"/" + tasklist.stats.total_display + " hoĂ n thĂ nh");
		// }
		
		Client.pageData.tasks=AP.array.removeByID(Client.pageData.tasks, task_id);
		
		if (Client.pageData.subtasks){
			Client.pageData.subtasks=AP.array.removeByID(Client.pageData.subtasks, task_id);
		}
		
		Board.reset();
	};
	
	
	function requireReset(task){
		if (task.metatype=="subtask" || !Client.pageData.project){
			return;
		}
		
		var old=Board.data.getTask(task);
		if (!old){
			return;
		}
		
		if (Board.data.model.metatype=="tasklist"){
			if (parseInt(old.tasklist_id)!=parseInt(task.tasklist_id)){
				return true;
			}
		}
		
		if (Board.data.model.metatype=="miletone"){
			if (parseInt(old.milestone_id)!=parseInt(task.milestone_id)){
				return true;
			}
		}
		
		if (Board.data.model.metatype=="user"){
			if (parseInt(old.user_id)!=parseInt(task.user_id)){
				return true;
			}
		}
	};
	
	
	function hotfixInlineStatus(task){
		if ($(".sublist #task-"+task.id).length){
			Board.sublist.update(task);
		}
		
		if ($(".js-inline-subtask-"+task.id).length){
			var html=Base.task.exportHTML(task);
			$(".js-inline-subtask-"+task.id).replaceWith(html);
		}
	};
};



var List = new function __BaseInfList() {

	this.init = function(opts) {

		opts = $.extend({show_more: true}, opts);
		
		if (Client.pageData.task_view) {
			Query.set("view", Client.pageData.task_view);	
		}
		
		Project.subheader.init();

		List.opts = opts;
		
		var label = "CĂ¡c cĂ´ng viá»‡c gáº§n Ä‘Ă¢y";
		if (Query.get("order") == "deadline") {
			label = "Sáº¯p xáº¿p cĂ´ng viá»‡c theo thá»i háº¡n";	
		} else if (Query.get("order") == "created") {
			label = "Táº¡o gáº§n Ä‘Ă¢y";	
		}
		
		var ord = '';
		var real_order = '';
		if (Query.get("order")) {
			ord = '&order=' + Query.get('order');
			real_order = Query.get('order');
		}
		
		AP.pageConfig.set("team_order", real_order);
		
		var view_subtasks = 1;
		if (Query.get("subtask") == "hide") {
			view_subtasks = -1;
		}
		
		AP.pageConfig.set("team_subtasks", view_subtasks);
		
		var more = "<div class='load-more' onclick='List.more();'>Táº£i thĂªm cĂ´ng viá»‡c</div>";
		if (!opts.show_more) {
			more = '';
		}
		
		var title = "<div class='group-header'> <div class='title'> <div class='collapse'> <span class='ficon-caret-right'></span> </div> <div class='name'><span class='url' data-xurl='home?view=list"+(ord)+"'>"+(label)+"</span></div> </div> <div class='right' style='max-width:none' id='js-stream-filters'></div> </div>";
		
		if (!Client.pageData.project) {
			title = '';
		}
		
		$("#tasklists").after("<div id='js-list-marker'></div>");
		
		$(opts.canvas).html("<div class='tasklist'> "+(title)+"<div class='tasks js-list-tasks'></div>"+(more)+" </div>");
		
		this.page = 1;

		for (var i = 0; i < Client.pageData.tasks.length; i++) {
			appendTask(Client.pageData.tasks[i]);
		}
	};
	
	
	/**
	 * @desc Fully rebuild the list
	 */
	this.rebuild = function() {

		$("#tasklists .tasks").empty();
		Client.pageData.tasks.sort(Board.filter.streamSort);
		
		for (var i = 0; i < Client.pageData.tasks.length; i++) {
			appendTask(Client.pageData.tasks[i]);
		}
	};

	
	this.onCreate = function(task) {

		if (task.metatype == "task") {
			this.rebuild();	
		} else {
			var pid = task.parent_id;
			if ($(".js-subtasks-p"+(pid)+"").length) {
				$(".js-subtasks-p"+(pid)+"").prepend(List.ui.getHTML(task));
			}
		}
	};
	
	
	this.more = function() {

		this.page++;
		
		var params = Query.release();
		params.page = this.page;
		params.project_id = Client.pageData.project.id;
		
		UI.ajaxShow();
		AP.post("api/project/more.tasks", params, function(code) {
			UI.ajaxHide();
			
			if (!code.good()) {
				return AP.alertError(code.message);
			}
			
			for (var i = 0; i < code.tasks.length; i++) {
				Client.pageData.tasks.push(code.tasks[i]);	
			}
			
			Client.pageData.tasks = AP.array.uniqueObjects(Client.pageData.tasks);
			
			appendTasks(code.tasks);
		});
	};
	
	
	/**
	 * @desc Append a single task
	 */
	function appendTask(task) {

		if ($("#tasklists #task-"+(task.id)+"").length) {
			return;
		}
		
		appendSeperator(task);
		
		var html = List.ui.getHTML(task, {team_view: 1});
		$("#tasklists .tasks").append(html);
	};
	
	
	function appendSeperator(task) {

		var opts = List.opts;
		var id = '';
		var title = '';
		
		var ord = Query.get("order");
		var ts = task.last_update;
		
		if (ord == "created") {
			ts = task.since;
		}
		
		if (ord == "deadline") {
			ts = task.deadline;
		}
		
		if (opts.period == "monthly") {
			id = AP.time.beginOfMonth(ts);
			title = 'ThĂ¡ng ' + AP.time.time("%m/%Y", ts);
		} else {
			id = AP.time.beginOfWeek(ts);
			title = 'Tuáº§n ' + AP.i18n.dateRange(AP.time.beginOfWeek(ts), AP.time.endOfWeek(ts));
		}

		if (ts == 0) {
			id = "x0";
			title = "Others";
		}
		
		if ($("#tasklists").find(".sep-" + id).length) {
			return;
		}
		
		$("#tasklists .tasks").append("<div class='list-sep sep-"+(id)+"'>"+(title)+"</div>");
	};
	
	
	/**
	 * @desc Append a task to the list
	 */
	function appendTasks(tasks) {
		for (var i = 0; i < tasks.length; i++) {
			appendTask(tasks[i]);
		}
	};
	
	
	// STANDARD SUBTASKS
	this.std_subtask_views = "<div class='autohide dd -cmenuw js-auto-filter' data-filter='subtask' data-df='Xem cĂ¡c cĂ´ng viá»‡c con'> <div class='label js-current-filter'>Xem cĂ¡c cĂ´ng viá»‡c con</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='subtask' data-value=''>Xem cĂ¡c cĂ´ng viá»‡c con</div> <div class='-item url' data-urlparam='subtask' data-value='hide'>áº¨n cĂ¡c cĂ´ng viá»‡c con</div> </div> </div>";
};





Project.manage = new function __ProjectManage() {

	var maximum_prioritize_projects = 300;

	// Used for bulk update priority;
	var change_projects = [];
	
	this.fix = function(key, value, callback) {
		UI.ajaxShow();
		AP.post("api/project/fix", {id: Client.pageData.context.id, key: key, value: value}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.pageData.context=code.project;
			Client.pageData.project=code.project;
			
			if (callback){
				callback(code);
			}
		});
	};
	
	
	this.fixTime = function(callback) {
		var data = {id: Client.pageData.context.id};
		
		var form = Form.create('fly-proj-addmember-fx',{'action': Client.pageData.context.path+"/api/settings/edit.period"})
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u"}),
			Form.input({name: 'stime', "placeholder":"NgĂ y báº¯t Ä‘áº§u", role:"date"}).value(Client.pageData.context.stime)
		)
		.row(
			Form.label({label: "NgĂ y káº¿t thĂºc"}),
			Form.input({name: 'etime', "placeholder":"NgĂ y káº¿t Ä‘áº§u", role:"date"}).value(Client.pageData.context.etime)
		)
		.buttons([
			 {label: "Cáº­p nháº­t", action: function(){
				 Form.submit("#fly-proj-addmember-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-proj-addmember-fx");
					 UI.flash("Update successfully ...");
					 
					 if (callback){
						 callback(code.project);
					 }else{
						 AP.xRefresh(); 
					 }
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Bá» qua", action: function(){
				 Form.hide("fly-proj-addmember-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 420, label: 'Sá»­a thá»i gian thá»±c hiá»‡n dá»± Ă¡n', layout: 'flat'}).setForm(form).show();
	};
	
	
	this.memberOptions = function(ref) {
		var namediv = $(".name", $(ref).parent());
		var username = $(namediv).find(".username").data("username");
		var is_owner = $(ref).hasClass("owner");

		var actions = [];
		
		if(is_owner) {
			if(username != Client.viewer.username) {
				actions.push({label: "Bá» quyá»n quáº£n trá»‹ dá»± Ă¡n cá»§a @<b>" + username +"</b>", sublabel: "", icon: "icon-star-empty", action: function() {
					Project.manage.removeOwner(username);
				}});
			}
		} else {
			actions.push({label: "ThĂªm quyá»n quáº£n trá»‹ dá»± Ă¡n cho @<b>" + username +"</b>", sublabel: "", icon: "icon-star", action: function() {
				Project.manage.addOwner(username);
			}});
		}
		
		return Context.menu(ref, {top: 30, left: -250, menu: [
			
		].concat(actions)});
	};
	
	
	this.addOwner = function(username) {
		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n trao quyá»n quáº£n trá»‹ dá»± Ă¡n nĂ y cho thĂ nh viĂªn @<b>" + username + "</b>?", function() {
			AP.ajaxShow();
			var data = {username: username, project_hid: Client.pageData.project.hid, role: "admin"};
			
			AP.post("api/project/owner/set", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("ÄĂ£ lÆ°u thay Ä‘á»•i");
				AP.xRefresh();
			});
		});
	};
	
	
	this.removeOwner = function(username) {
		Context.close();
		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n bá» quyá»n quáº£n trá»‹ dá»± Ă¡n nĂ y cá»§a thĂ nh viĂªn @<b>" + username + "</b>?", function() {
			AP.ajaxShow();
			var data = {username: username, project_hid: Client.pageData.project.hid, role: "member"};
			
			AP.post("api/project/owner/set", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("ÄĂ£ lÆ°u thay Ä‘á»•i");
				AP.xRefresh();
			});
		});
	};

	
	this.addGuest = function() {
		if (Client.pageData.context.metatype!="project"){
			return;
		}
		
		Guest.addAccount(Client.pageData.context, "wework");
	};


	this.closeProject = function(project) {
		var data = {id: project.id, token: project.token};
		
		var form = Form.create('fly-proj-addmember-fx',{'action': "api/project/close"})
		.warning("Náº¿u Ä‘Ă³ng dá»± Ă¡n/phĂ²ng ban, sáº½ khĂ´ng thá»ƒ thĂªm cĂ´ng viá»‡c")
		.row(
			Form.label({label: "TĂªn dá»± Ă¡n/phĂ²ng ban",sublabel: ""}),
			Form.input({name: 'name_fake', type:"fake"}).value(project.name)
		)
		.row(
			Form.label({label: "Tráº¡ng thĂ¡i Ä‘Ă³ng",sublabel: "Cáº­p nháº­t tráº¡ng thĂ¡i"}),
			Form.input({name: 'stage', type:"select", options:Project.status.closed_statuses})
		)
		.row(
			Form.label({label: "Dá»«ng nháº¯c nhá»Ÿ cĂ´ng viá»‡c",sublabel: "ChĂº Ă½: Náº¿u dá»«ng, sáº½ dá»«ng nháº¯c nhá»Ÿ mĂ£i mĂ£i"}),
			Form.input({name: 'reminder_stop', type:"select", options:["yes", "no"]}).value("no")
		)
		.row(
			Form.label({label: "ThĂ´ng bĂ¡o cáº­p nháº­t",sublabel: "Giáº£i thĂ­ch ngáº¯n gá»n vá» hĂ nh Ä‘á»™ng cá»§a báº¡n"}),
			Form.input({name: 'note', type:"textarea", placeholder:"ThĂ´ng bĂ¡o ngáº¯n gá»n vá» hĂ nh Ä‘á»™ng cáº­p nháº­t"})
		)
		.buttons([
			{label: "Cáº­p nháº­t", action: function(){
				Form.submit("#fly-proj-addmember-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					 
					Form.hide("fly-proj-addmember-fx");
					 
					UI.flash("Update successfully");
					 
					AP.refresh();
				})
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function(){
				Form.hide("fly-proj-addmember-fx");
			}, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 520, label: 'ÄĂ³ng Dá»± Ă¡n/PhĂ²ng ban'}).setForm(form).show();
		return;
	};
	
	
	this.reopenProject = function(project) {
		var data = {id: project.id, token: project.token};
		
		var form = Form.create('fly-proj-addmember-fx',{'action': "api/project/reopen"})
		.row(
			Form.label({label: "TĂªn dá»± Ă¡n/phĂ²ng ban",sublabel: ""}),
			Form.input({name: 'name_fake', type:"fake"}).value(project.name)
		)
		.row(
			Form.label({label: "Tráº¡ng thĂ¡i má»Ÿ",sublabel: "Cáº­p nháº­t tráº¡ng thĂ¡i"}),
			Form.input({name: 'stage', type:"select", options:Project.status.statuses}).value("ontrack")
		)
		.row(
			Form.label({label: "Khá»Ÿi Ä‘á»™ng láº¡i nháº¯c nhá»Ÿ cĂ´ng viá»‡c",sublabel: "Quyáº¿t Ä‘á»‹nh cĂ³ buá»™c khá»Ÿi Ä‘á»™ng láº¡i lá»i nháº¯c nhá»Ÿ cĂ´ng viá»‡c"}),
			Form.input({name: 'reminder_start', type:"select", options:["yes", "no"]}).value("no")
		)
		.row(
			Form.label({label: "ThĂ´ng bĂ¡o cáº­p nháº­t",sublabel: "Giáº£i thĂ­ch ngáº¯n gá»n vá» hĂ nh Ä‘á»™ng cá»§a báº¡n"}),
			Form.input({name: 'note', type:"textarea", placeholder:"ThĂ´ng bĂ¡o ngáº¯n gá»n vá» hĂ nh Ä‘á»™ng cáº­p nháº­t"})
		)
		.buttons([
			{label: "Cáº­p nháº­t", action: function(){
				Form.submit("#fly-proj-addmember-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					 
					Form.hide("fly-proj-addmember-fx");
					UI.flash("Update successfully");
					 
					AP.refresh();
				})
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function(){
				Form.hide("fly-proj-addmember-fx");
			}, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 520, label: 'Má»Ÿ Dá»± Ă¡n/PhĂ²ng ban'}).setForm(form).show();
		return;
	};
	
	
	this.removeProject = function(project) {
		AP.confirmDelete("Báº¡n cĂ³ cháº¯c muá»‘n xoĂ¡ dá»± Ă¡n nĂ y? CĂ¡c cĂ´ng viá»‡c/nhĂ³m cĂ´ng viá»‡c liĂªn quan cÅ©ng sáº½ bá»‹ xoĂ¡ vĂ  KHĂ”NG THá»‚ khĂ´i phá»¥c.", function() {
			AP.ajaxShow();
			var data = {id: project.id, token: project.token};
			
			AP.post("api/project/remove", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				AP.hideAlert();
				UI.flash("ÄĂ£ xoĂ¡ dá»± Ă¡n");
				AP.redirect("home");
			});
		});
	};


	this.removePriority = function(project) {

		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n bá» dá»± Ă¡n nĂ y khá»i danh sĂ¡ch Æ°u tiĂªn?", function() {

			AP.ajaxShow();
			var data = {id: project.id};

			AP.post("api/project/stack/remove.priority", data, function(code) {

				AP.ajaxHide();

				if(!code.good()) {
					return AP.alertError(code.message);
				}

				if (Client.projects) {
					Client.projects = AP.array.removeByID(Client.projects, code.project.id);
					Menu.init();
				}

				AP.hideAlert();
				UI.flash("ÄĂ£ bá» Æ°u tiĂªn dá»± Ă¡n");
				AP.xRefresh();
				AP.requireReset();
			});
		});
	};


	this.addPriority = function(project) {

		if (Client.pageData.stack == "undefined") {
			return;
		}

		var total_priority = Client.pageData.stack.priority.length;
		if (total_priority + 1 > parseInt(Project.get_max.priority)) {

			var data = {new_priority: project.id};

			var form = Form.create('fly-workflow-fx', {'action': "api/project/stack/change.priority"})
			.row(
				Form.label({label: "Chá»n dá»± Ă¡n", "sublabel":"Giá»›i háº¡n sá»‘ dá»± Ă¡n/phĂ²ng ban Æ°u tiĂªn lĂ  300. Chá»n má»™t dá»± Ă¡n Æ°u tiĂªn cÅ© Ä‘á»ƒ thay tháº¿"}),
				Form.input({name:"old_priority", type:"select", options: Form.convert(Client.projects)})
			).addClass("-active")
			.buttons([
				{label: "Chá»n", action: function() {
					Form.submit("#fly-workflow-fx", function(code) {
						if (!code.good()) {
							return AP.alertError(code.message);
						}

						if (Client.projects) {
							Client.projects = AP.array.removeByID(Client.projects, code.old_priority.id);
							AP.array.updateByID(Client.projects, code.new_priority);
							Client.projects = AP.array.sortOnRefIDs(Client.projects, code.priority);
							Menu.init();
						}

						Form.hide("fly-workflow-fx");
						UI.flash("ÄĂ£ thĂªm Æ°u tiĂªn dá»± Ă¡n");
						AP.xRefresh();
						AP.requireReset();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function() {
					Form.hide("fly-workflow-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(form) {
				Form.select.improve($("#fly-workflow-fx .row .select select"));
			});

			Form.pop({width: 480, label: 'Chá»n dá»± Ă¡n Ä‘á»ƒ bá» Æ°u tiĂªn', layout: 'flat', closable : false}).setForm(form).show().focus('name');
		} else {

			AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n thĂªm dá»± Ă¡n nĂ y vĂ o danh sĂ¡ch Æ°u tiĂªn?", function() {
				AP.ajaxShow();
				var data = {id: project.id};

				AP.post("api/project/stack/add.priority", data, function(code) {
					AP.ajaxHide();

					if(!code.good()) {
						return AP.alertError(code.message);
					}

					if (Client.projects) {
						AP.array.updateByID(Client.projects, code.project);
						Client.projects = AP.array.sortOnRefIDs(Client.projects, code.priority);
						Menu.init();
					}

					AP.hideAlert();
					UI.flash("ÄĂ£ thĂªm Æ°u tiĂªn dá»± Ă¡n");
					AP.xRefresh();
					AP.requireReset();
				});
			});
		}
	};


	this.updateMultiPriority = function() {

		change_projects = [];
		var status_options = [
			{value: 'active', label: 'Äang thá»±c hiá»‡n'},
			{value: 'closed', label: 'ÄĂ£ Ä‘Ă³ng'}
		];

		var stage_options = [
			{value: 'all', label: 'Táº¥t cáº£'},
			{value: 'ontrack', label: 'ÄĂºng tiáº¿n Ä‘á»™'},
			{value: 'offtrack', label: 'Cháº­m tiáº¿n Ä‘á»™'},
			{value: 'atrisk', label: 'CĂ³ rá»§i ro cao'}
		];

		var checked_projects = ARR.filter(Client.pageData.projects, function (project) {
			return isPrioritized(project);
		});


		var checked_project_ids = ARR.select(checked_projects, function (project) {
			return project.id;
		});

		var project_options = ARR.select(Client.pageData.projects, function (project) {

			var dept = Dept.fromContext(project.dept_id);
			var dept_text = 'ChÆ°a phĂ¢n loáº¡i';
			if (dept) {
				dept_text = dept.name;
			}

			return {
				name: ""+(project.name)+" - "+(dept_text)+"",
				id: project.id,
				status: project.status,
				dept_id: project.dept_id,
				stage: project.stage
			};
		});

		var dept_options = [
			{id: 'all', name: 'Táº¥t cáº£ departments'},
			{id: '0' , name: 'ChÆ°a phĂ¢n loáº¡i'},
		];

		var depts = ARR.select(Client.depts, function (dept) {
			return {
				name: dept.name,
				id: dept.id,
			}
		});

		dept_options = ARR.merge(dept_options, depts);

		var rows = [
			[
				{label: "TĂ¬m theo department", name: 'filter_dept', type: 'select', options: dept_options, value: 'all'},
				{label: "TĂ¬m theo tráº¡ng thĂ¡i", name: 'filter_status', type: 'select', options: status_options, value: 'active'},
				{label: "TĂ¬m theo giai Ä‘oáº¡n", name: 'filter_stage', type: 'select', options: stage_options, value: 'all'}
			],
			{
				type: "html", html: "<div class='priority-info'> <div class='label'>Chá»n dá»± Ă¡n/phĂ²ng ban báº¡n muá»‘n Æ°u tiĂªn</div> <div class='js-priority-stats priority-stats'> </div> </div>"
			},
			{ type: "html", html: "  " +Render.render('search', {placeholder: "TĂ¬m theo tĂªn" , id: "js-search-project" }, '')+ ''},
			{ name: 'projects', type: 'checkboxes', options: project_options, value: checked_project_ids},
			{ type: "html", html: "<div id='js-change-projects' class='change-project-columns'></div>" },
		];


		Form.v2({
			data: {

			},
			rows: rows,
			buttons: Form.button({
				label: "Cáº­p nháº­t",
				style: "ok",
				action: function() {

					var priority_num = getPrioritizeNum();
					if (priority_num > maximum_prioritize_projects) {
						return AP.alertError('Giá»›i háº¡n sá»‘ dá»± Ă¡n/phĂ²ng ban Æ°u tiĂªn lĂ  300');
					}

					Form.v2.submit(function (code) {
						if (!code.good()) {
							return AP.alertError(code.message);
						}
						AP.refresh();
					});
			}}).button(":cancel"),
			title: "Cáº­p nháº­t hĂ ng loáº¡t Ä‘á»™ Æ°u tiĂªn cá»§a dá»± Ă¡n/phĂ²ng ban",
			action: "api/project/stack/update.multi.priority",
			width: 720,
			render: function() {

				var form = this;

				Form.improveSelect(form.find('filter_dept'), {
					empty: '',
					value: 'all'
				});

				Form.improveSelect(form.find('filter_status'), {
					empty: '',
					value: 'active'
				});

				Form.improveSelect(form.find('filter_stage'), {
					empty: '',
					value: 'all'
				});

				onChangeFilter(form);
				updatePriorityForm(form);

				var priority_num = checked_projects.length;

				$('.js-priority-stats').html("<div class='priority-num'>"+(priority_num)+" dá»± Ă¡n/phĂ²ng ban Æ°u tiĂªn</div>");

				form.findRow('projects[]').find("input").change(function () {

					var project_id = $(this).val();
					if (change_projects.indexOf(project_id) >= 0) {
						change_projects = ARR.filter(change_projects, function (e) {
							return e != project_id;
						});
					} else {
						change_projects.push(project_id);
					}

					updatePriorityForm(form);
				});

            }
		});
	};


	function onChangeFilter(form) {

		$('#js-search-project').on('input change', function() {
			refilter(form);
		});

		form.findRow('filter_dept').find("select[name='filter_dept']").change(function() {
			refilter(form);
		});


		form.findRow('filter_status').find("select[name='filter_status']").change(function() {
			refilter(form);
		});

		form.findRow('filter_stage').find("select[name='filter_stage']").change(function() {
			refilter(form);
		});
	};


	function isPrioritized(project) {
		return AP.array.contain(Client.pageData.stack.priority, project.id)
	};


	function removeChangedProject(form, id) {

		change_projects = ARR.filter(change_projects, function (e) {
			return e != id;
		});

		var input = form.findRow("projects[]").find("input[value='"+(id)+"']");

		if (input.prop("checked")) {
			input.prop("checked", false);
		} else {
			input.prop("checked", true);
		}

		updatePriorityForm(form);
	};


	function getColumns(form) {
		var added_priority_projects = [];

		var removed_priority_projects = [];

		AP.render(change_projects, function (e) {
			var project = Project.fromContext(e);

			if (!project) {
				return;
			}

			if (isPrioritized(project)) {
				removed_priority_projects.push(project);
			} else {
				added_priority_projects.push(project);
			}
		});

		var added_projects_html = AP.render(added_priority_projects, function (p) {
			return getChangeProjectHTML(p, 'added');
		});


		var removed_projects_html = AP.render(removed_priority_projects, function (p) {
			return getChangeProjectHTML(p, 'removed');
		});


		var html = "<div class='columns'> <div class='column box'> <div class='box-header'> <div class='title inline'>ThĂªm Æ°u tiĂªn</div> </div> <div class='box-body'> <div class='scroll-y'> <div class='selections'> "+(added_projects_html)+" </div> </div> </div> </div> <div class='column box'> <div class='box-header'> <div class='title inline'>Bá» chá»n Æ°u tiĂªn</div> </div> <div class='box-body'> <div class='scroll-y'> <div class='selections'> "+(removed_projects_html)+" </div> </div> </div> </div> </div>";

		return html;
	};


	function getChangeProjectHTML(project, type) {

		var input_name = 'removed_projects[]';

		if (type == 'added') {
			input_name = 'added_projects[]';
		}

		var dept = Dept.fromContext(project.dept_id);
		var dept_text = 'ChÆ°a phĂ¢n loáº¡i';
		if (dept) {
			dept_text = dept.name;
		}

		return "<div class='selection ' data-id='"+(project.id)+"'> <div class='selection__name inline' title='"+(project.name)+" - "+(dept_text)+"'>"+(project.name)+" - "+(dept_text)+" <input type='hidden' name='"+(input_name)+"' placeholder='column name' value='"+(project.id)+"'> </div> <div class='selection__delete url inline js-close' data-id='"+(project.id)+"'> <span class='-ap icon-close'></span> </div> </div>";
	};


	function getPrioritizeNum() {
		var priority_num = $("#form-v2-fx input[name='projects[]']:checked").length;
		return priority_num;
	};


	function updatePriorityForm(form) {

		$('#js-change-projects').html(getColumns(form));

		$('#js-change-projects .js-close').click(function () {
			removeChangedProject(form, $(this).data('id'));
		});

		var priority_num = getPrioritizeNum();

		$('.js-priority-stats .priority-num').html(""+(priority_num)+" dá»± Ă¡n/phĂ²ng ban Æ°u tiĂªn");

		if (priority_num > maximum_prioritize_projects) {
			$('.js-priority-stats .priority-num').addClass('anim-showhide-inf msg-warning').attr('title', "Giá»›i háº¡n sá»‘ dá»± Ă¡n/phĂ²ng ban Æ°u tiĂªn lĂ  300");
		} else {
			$('.js-priority-stats .priority-num').removeClass('anim-showhide-inf msg-warning').attr('title', null);
		}

		onChangeFilter(form);
	};


	function refilter(form) {
		
		var status_filter = form.findRow('filter_status').find("select[name='filter_status']").val();
		if (!status_filter) {
			status_filter = 'active';
		}
		var stage_filter = form.findRow('filter_stage').find("select[name='filter_stage']").val();
		if (!stage_filter) {
			stage_filter = 'all';
		}
		var dept_filter = form.findRow('filter_dept').find("select[name='filter_dept']").val();
		if (!dept_filter) {
			dept_filter = 'all';
		}

		var name_filter = $('#js-search-project').val();

		form.findRow('projects[]').find('.list.checkboxes .li.block').each(function () {
			var project = Project.fromContext($(this).data('value'));
			if (!project) {
				return;
			}

			var name_cond = AP.word.fulltextMatch(project.name.toLowerCase(), name_filter.toLowerCase());

			var status_cond = false;
			if (project.status == 0 && status_filter == 'active') {
				status_cond = true;
			}

			if (project.status == 0 && status_filter == 'running') {
				status_cond = true;
			}

			if (project.status == -1 && status_filter == 'closed') {
				status_cond = true;
			}

			var dept_cond = false;
			if (dept_filter == 'all' || dept_filter == project.dept_id) {
				dept_cond = true;
			}

			var stage_cond = false;
			if (stage_filter == "all" || project.stage.indexOf(stage_filter) !== -1) {
				stage_cond = true;
			}
		
			if (name_cond && status_cond && stage_cond && dept_cond) {
				$(this).show();
			} else {
				$(this).hide();
			}
		});

	};


	this.removeAlert = function(project) {
		AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n bá» dá»± Ă¡n nĂ y khá»i danh sĂ¡ch cáº£nh bĂ¡o Æ°u tiĂªn?", function() {
			AP.ajaxShow();
			var data = {id: project.id};
			
			AP.post("api/project/alert/remove", data, function(code) {
				AP.ajaxHide();
				
				if(!code.good()) {
					return AP.alertError(code.message);
				}
				
				AP.hideAlert();
				UI.flash("ÄĂ£ bá» cáº£nh bĂ¡o Æ°u tiĂªn dá»± Ă¡n");
				AP.refresh();
			});
		});
	};


	this.alertToPriority = function(project) {

		if (Client.pageData.stack == "undefined") {
			return;
		}

		var total_priority = Client.pageData.stack.priority.length;
		if (total_priority + 1 > parseInt(Project.get_max.priority)) {

			var data = {new_priority: project.id};
		
			var form = Form.create('fly-workflow-fx', {'action': "api/project/alert/change.priority"})
			.row(
				Form.label({label: "Chá»n dá»± Ă¡n", "sublabel":"Giá»›i háº¡n sá»‘ dá»± Ă¡n Æ°u tiĂªn lĂ  300. Chá»n má»™t dá»± Ă¡n Æ°u tiĂªn cÅ© Ä‘á»ƒ thay tháº¿"}),
				Form.input({name:"old_priority", type:"select", options: Form.convert(Client.projects)})
			).addClass("-active")
			.buttons([
				{label: "Chá»n", action: function() {
					Form.submit("#fly-workflow-fx", function(code) {
						if (!code.good()) {
							return AP.alertError(code.message);
						}
						
						Form.hide("fly-workflow-fx");
						UI.flash("ÄĂ£ thĂªm Æ°u tiĂªn dá»± Ă¡n");
						AP.refresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function() {
					Form.hide("fly-workflow-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(form) {
				Form.select.improve($("#fly-workflow-fx .row .select select"));
			});

			Form.pop({width: 480, label: 'Chá»n dá»± Ă¡n Ä‘á»ƒ bá» Æ°u tiĂªn', layout: 'flat', closable : false}).setForm(form).show().focus('name');
		} else {
			AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n thĂªm dá»± Ă¡n nĂ y vĂ o danh sĂ¡ch Æ°u tiĂªn?", function() {
				AP.ajaxShow();
				var data = {id: project.id};
				
				AP.post("api/project/alert/add.priority", data, function(code) {
					AP.ajaxHide();
					
					if(!code.good()) {
						return AP.alertError(code.message);
					}
					
					AP.hideAlert();
					UI.flash("ÄĂ£ thĂªm Æ°u tiĂªn dá»± Ă¡n");
					AP.refresh();
				});
			});
		}
	};


	this.changeMetatype = function(project_id) {

		var project = Project.fromContext(project_id);
		if (!project) {
			return;
		}

		AP.confirm("Báº¡n cĂ³ cháº¯c cháº¯n muá»‘n chuyá»ƒn metatype cá»§a " + project.metatype + " <b>" + project.name + "</b> ?", function() {
            UI.ajaxShow();
            AP.post("api/project/change.metatype",{id : project_id}, function(code) {
                UI.ajaxHide();
                if (!code.good()) {
                    return AP.alertError(code.message);
                }

                AP.hideAlert();
                UI.flash("Update successfully");
                AP.xRefresh();
            });
        });
	};


	this.advancedSetting = function(project) {
		var advanced = "CĂ i Ä‘áº·t nĂ¢ng cao cho dá»± Ă¡n";
		var remove_project_title = "Quáº£n lĂ½ dá»± Ă¡n cĂ³ thá»ƒ xĂ³a dá»± Ă¡n";
		if (project.metatype != "project") {
			advanced = "CĂ i Ä‘áº·t nĂ¢ng cao cho phĂ²ng ban";
			remove_project_title = "Quáº£n lĂ½ phĂ²ng ban cĂ³ thá»ƒ xĂ³a phĂ²ng ban";
		}

		UI.setting(advanced)
		.add({
			title: remove_project_title,
			options: {"yes": "CĂ³", "no": "KhĂ´ng"},
			value: project.options.remove_project,
			name: "remove_project",
			url: "api/settings/project/custom/"+project.id
		})
		.callback(function(name, value){
			project.options[name]=value;
			AP.requireReset();
		})
		.show();
	};


	this.duplicateProject = function(project) {
		return Project.form.duplicate(project.id, project.name);
	};


	this.download = function(project) {
		return Project.form.download(project);
	};

	this.downloadWithTable = function(project) {
		return Project.form.downloadWithTable(project);
	};

	this.downloadMyTasks = function(project) {
		return Project.form.downloadMyTasks(project);
	};


	this.downloadGanttChart = function(project) {
		return Project.form.downloadGanttChart(project);
	};


	this.downloadCustomFields = function(project) {
		AP.confirm("Báº¡n cĂ³ cháº¯c mĂ¬nh muá»‘n xuáº¥t trÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh cá»§a dá»± Ă¡n nĂ y?", function(code) {
			window.open(Client.url + "/" + project.path + "/tool/export/custom.fields", '_blank');
		});
	};
};


var Compute = new function __Compute() {
	this.percent = function (project) {
		var stats = project.stats;

		var percent = 0;
		if (parseInt(stats.total)) {
			percent = (parseInt(stats.complete) * 100.0 / stats.total).toFixed(1);
		}

		return percent;
	};

	this.color = function (context) {
		context.percent = this.percent(context);
		var color = UI.color.percent(context.percent);
		if (parseInt(context.stime) && parseInt(context.etime)) {
			color = UI.color.progress(context);
		}
		return color;
	};

	this.doneLate = function (task) {
		if (!parseInt(task.deadline) || !parseInt(task.status) || !parseInt(task.completed_time)) {
			return false;
		}

		return parseInt(task.completed_time) > parseInt(task.deadline);
	};
	
	
	this.doneLateAgainst = function (task, deadline) {
		if (!parseInt(deadline) || !parseInt(task.status) || !parseInt(task.completed_time)) {
			return false;
		}

		return parseInt(task.completed_time) > parseInt(deadline);
	};
	
	
	/**
	 * @desc Check if a task is done on time
	 */
	this.doneOntime=function(task){
		return parseInt(task.status) && !this.doneLate(task);
	};
	
	
	/**
	 * @desc Check if the task is lately completed. Alias of donelate
	 */
	this.lateComplete=function(task){
		return this.doneLate(task);
	};
	
	
	this.overdue=function(task){
		if (parseInt(task.status)){
			return false;
		}
		
		if (!parseInt(task.deadline)){
			return false;
		}
		
		return parseInt(task.deadline) < AP.time.now();
	};
	
	
	this.overdueAgainst=function(task, deadline){
		if (parseInt(task.status)){
			return false;
		}
		
		if (!parseInt(task.deadline)){
			return false;
		}
		
		return parseInt(task.deadline) < parseInt(deadline);
	};
	
	
	this.dueToday=function(task){
		if (parseInt(task.status)){
			return false;
		}
		
		return parseInt(task.deadline) && AP.time.sameDay(task.deadline, AP.time.now());
	};
	
};


Compute.overview=new function __ComputeOverview(){
	this.tasks=[];
	
	this.init=function(tasks){
		if (!tasks){
			tasks=[];
		}
		
		this.tasks=tasks;
		this._overview={
			total: 0,
			percent: 0,
			overdue: 0,
			done_ontime: 0,
			done_late: 0,
			active: 0,
			active_todo: 0,
			active_doing: 0,
		};
		
		this._review={
			active: 0,
			review: 0,
			done: 0
		};
		
		this._users={"__unassigned":{tasks: [], total: 0, active: 0, active_todo: 0, active_doing: 0, done_late: 0, done_ontime: 0, late: 0, assigning:0}};
		this._collection={attentions:[], assigned: [], assigning_overdue:[], overdues: [], todos: []};
		
		this.overview();
		return this;
	};
	
	
	this.overview=function(){
		var now=AP.time.now();
		
		for (var i=0; i<this.tasks.length; i++){
			if (this.tasks[i].metatype!="task"){
				continue;
			}
			
			this._overview.total++;
			this.increaseUserReport(this.tasks[i].username, "total", this.tasks[i]);
			this.increaseUserReport(this.tasks[i].creator_username, "assigning", this.tasks[i]);
			
			var status=parseInt(this.tasks[i].status);
			var gs=Task.ui.grandState(this.tasks[i]);
			
			if (status==1){
				this._review.done++;
			}else{
				if (parseInt(this.tasks[i].review)){
					this._review.review++;
				}else{
					this._review.active++;
					// this.increaseUserReport(this.tasks[i], "review");
				}
			}
			
			if (status==0){
				if (parseInt(this.tasks[i].user_id)==parseInt(Client.viewer.id)){
					if (parseInt(this.tasks[i].urgent) || Compute.overdue(this.tasks[i])){
						this._collection.attentions.push(this.tasks[i]);
					}else{
						this._collection.assigned.push(this.tasks[i]);
					}
					
				}else if (parseInt(this.tasks[i].creator_id)==parseInt(Client.viewer.id)){
					if (parseInt(this.tasks[i].urgent) || Compute.overdue(this.tasks[i])){
						this._collection.assigning_overdue.push(this.tasks[i]);
					}
				}
			}
			
			
			if (gs=="todo"){
				this._collection.todos.push(this.tasks[i]);
			}
			
			if (Compute.overdue(this.tasks[i])){
				this._collection.overdues.push(this.tasks[i]);
			}
			
			if (status==1){
				if (Compute.doneOntime(this.tasks[i])){
					this._overview.done_ontime++;
					this.increaseUserReport(this.tasks[i].username, "done_ontime");
				}else{
					this._overview.done_late++;
					this.increaseUserReport(this.tasks[i].username, "done_late");
				}
			}else{
				if (gs=="todo"){
					this._overview.active_todo++;
					this.increaseUserReport(this.tasks[i].username, "active_todo");
				}else if (gs=="doing"){
					this._overview.active_doing++;
					this.increaseUserReport(this.tasks[i].username, "active_doing");
				}
				
				if (Compute.overdue(this.tasks[i])){
					this._overview.overdue++;
				}else{
					this._overview.active++;
				}
			}
		}
		
		
		
		if (this._overview.total){
			this._overview.percent=((this._overview.done_ontime+this._overview.done_late)*100/(this._overview.total)).toFixed(2);
		}
		
		
		this._me={tasks: [], total: 0, active: 0, active_todo:0, active_doing:0, done_late: 0, done_ontime: 0, overdue: 0, assigning:0};
		if (this._users[Client.viewer.username]){
			this._me=this._users[Client.viewer.username];
		}
		
		if (this._me.total){
			this._me.percent=((this._me.done_ontime+this._me.done_late)*100/(this._me.total)).toFixed(2);
		}else{
			this._me.percent=0;
		}
		
		var us=[];
		for (var k in this._users){
			this._users[k].username=k;
			us.push(this._users[k]);
		}
		
		this._users=us;
		this._users.sort(function(a, b){
			return b.total - a.total;
		});
	};
	
	this.people=function(){
	};
	
	this.daily=function(){
	};
	
	this.increaseUserReport=function(username, field, task){
		if (!username){
			username="__unassigned";
		}
		
		if (!this._users[username]){
			this._users[username]={tasks: [], total: 0, active: 0, active_todo:0, active_doing:0, done_late: 0, done_ontime: 0, overdue: 0, assigning:0};
		}
		
		this._users[username][field]++;
		if (field=="total"){
			this._users[username].tasks.push(task);
		}
	};
};



var TaskList=new function __ProjectTaskList(){
	this.fromContext=function(id){
		return AP.array.findObj(Client.pageData.tasklists, id);
	};
	
	this.getOptions=function(tasklists){	
		var opts=[];
		if(tasklists) {
			for (var i=0; i< tasklists.length; i++){
				opts.push({label: tasklists[i].name, value: tasklists[i].id});
			}
		} else {
			for (var i=0; i<Client.pageData.tasklists.length; i++){
				opts.push({label: Client.pageData.tasklists[i].name, value: Client.pageData.tasklists[i].id});
			}
		}

		return opts;
	};
	
	
	this.get=function(id, callback){
		UI.ajaxShow();
		AP.post("api/project/tasklist/get",{id: id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.tasklist);
		});
	};

	this.create=function(project){
		if (!project){
			project=Client.pageData.project;
		}
		
		if (project.status != 0) {
			return AP.alertError("Dá»± Ă¡n Ä‘ang táº¡m Ä‘Ă³ng hoáº·c Ä‘Ă£ hoĂ n thĂ nh.");
		}
		
		var data={id: project.id, hid: project.hid, token: project.token};

		
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/add"})
		.row(
			Form.label({label: "TĂªn nhĂ³m cĂ´ng viá»‡c *"}),
			Form.input({name: 'name', placeholder: "TĂªn nhĂ³m cĂ´ng viá»‡c"}).autoSubmit()
		).addClass("-big")
		// .wrap("TĂ¹y chá»n nĂ¢ng cao","#advopts")
		// .row(
		// 	Form.label({label: "CĂ³ deadline hay khĂ´ng?"}),
		// 	Form.input({name: 'has_deadline', type:"list", options:[{label: "KhĂ´ng Ä‘áº·t deadline", value:0}, {label: "Äáº·t deadline cho nhĂ³m cĂ´ng viá»‡c", value:1}]}).value(0)
		// )
		// .rowHidden(
		// 	Form.label({label: "Äáº·t deadline *"}),
		// 	Form.input({name: 'deadline', "role":"date", placeholder: "Click Ä‘á»ƒ chá»n thá»i háº¡n"})
		// ).addClass("noflat")
		.row(
			Form.label({label: "MĂ´ táº£ thĂªm"}),
			Form.input({name: 'content', type:"textarea", placeholder: "MĂ´ táº£ thĂªm vá» nhĂ³m cĂ´ng viá»‡c nĂ y"}).css({height: 100})
		)
		.buttons([
			 {label: "Táº¡o nhĂ³m cĂ´ng viá»‡c", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("ÄĂ£ thĂªm nhĂ³m cĂ´ng viá»‡c...");
					 Form.hide("fly-tasklist-fx");
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			setTimeout(function(){
				fref.find("name").focus();
			}, 300);

			$("#fly-tasklist-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_tasklist_created:project");
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Táº¡o nhĂ³m cĂ´ng viá»‡c trong: '+project.name, layout: 'flat', closable: false}).setForm(form).show().focus('name');

	};
	
	
	/**
	 * @desc Edit a tasklist
	 */
	this.edit=function(lid){
		var tasklist=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!tasklist){
			return;
		}
		return editForm(tasklist);
	};
	
	
	
	
	/**
	 * @desc Get closed status // 1 means closed; 0 means open
	 */
	this.isClosed=function(tasklist){
		if (!tasklist.id){
			return 0;
		}
		
		if (tasklist.type!="tasklist" && tasklist.type!="project.tasklist"){
			return 0;
		}
		
		var start=AP.time.now();
		var end=AP.time.now();
		
		if (Client.pageData.stack){
			start=Client.pageData.stack.stime;
			end=Client.pageData.stack.etime;
		}else if (Client.pageData.project){
			start=AP.time.now();
			end=AP.time.now();
		}else{
			return 0;
		}
		
		var stime=parseInt(tasklist.cs.stime);
		var etime=parseInt(tasklist.cs.etime);
		
		if (!stime || stime >= end){
			return 0;
		}
		
		// So stime and stime < end
		if (!etime){
			return 1;
		}
		
		if (!etime || etime>start){
			return 1;
		}
		
		return 0;
	};

	
	
	
	
	function editForm(tasklist){
		var project=Client.pageData.project;
		
		if (project.status != 0) {
			return AP.alertError("Dá»± Ă¡n Ä‘ang táº¡m Ä‘Ă³ng hoáº·c Ä‘Ă£ hoĂ n thĂ nh.");
		}

		var data={id: tasklist.id, token: tasklist.token};
	
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/edit"})
		.row(
			Form.label({label: "TĂªn nhĂ³m cĂ´ng viá»‡c *"}),
			Form.input({name: 'name'}).value(tasklist.name).autoSubmit()
		)
		.row(
			Form.label({label: "MĂ´ táº£ thĂªm"}),
			Form.input({name: 'content', type:"textarea", placeholder: "MĂ´ táº£ thĂªm vá» nhĂ³m cĂ´ng viá»‡c nĂ y"}).css({height: 100}).value(tasklist.content)
		)
		.hiddens(data)
		.buttons([
			 {label: "Sá»­a nhĂ³m cĂ´ng viá»‡c", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Chá»‰nh sá»­a thĂ nh cĂ´ng...");
					 Form.hide("fly-tasklist-fx");
					 Board.fire("tasklist.edit", code.tasklist);
					 $("#task-list-name-"+code.tasklist.id).html(code.tasklist.name);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.render(function(fref){
			setTimeout(function(){
				fref.find("name").focus();
			}, 300);
		});
	

		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Sá»­a nhĂ³m cĂ´ng viá»‡c: '+tasklist.name, layout: 'flat'})
		.setForm(form)
		.show()
		.focus('name');
	};
	
};
 

TaskList.manage = new function __TaskListManage(){
	this.options=function(ref){	
		var ab=Project.option.tasklist(tasklist);
		
		AP.actionMenu(ab.context(), {
			title: "TĂ¹y chá»‰nh nhĂ³m cĂ´ng viá»‡c",
			context: ref
		});
	};
	
	
	this.move=function(lid, dir){
		var item=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!item){
			return;
		}
		
		UI.ajaxShow();
		AP.post("api/project/tasklist/move",{action: dir, id: item.id, token: item.token}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Board.trigger("tasklist.move",[dir, item]);
			AP.xRefresh();
		});
	};
	
	/**
	 * @desc Temporarily close a tasklist
	 */
	this.close=function(lid){
		var tasklist=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!tasklist){
			return;
		}
		
		return closeForm(tasklist);
	};
	
	
	/**
	 * @desc Reopen every closed tasklists
	 */
	this.reopen = function () {
		var tasklists = AP.array.filter(Client.pageData.context.cached_tasklists, function(e){
			return e.id && parseInt(e.id);
			// return TaskList.isClosed(e);
		});
		
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/reopen"})
			.row(
				Form.label({label: "NhĂ³m cĂ´ng  viá»‡c *"}),
				Form.input({name: 'tasklist_id', type:'select', options: tasklists}).value()
			)
			.buttons([
				{label: "Má»Ÿ", action: function(){
					Form.submit("#fly-tasklist-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						UI.flash("Update successfully...");
						Form.hide("fly-tasklist-fx");
						AP.xRefresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function(){
					Form.hide("fly-tasklist-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.render(function(fref){
				setTimeout(function(){
					fref.find("name").focus();
				}, 300);
			});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Má»Ÿ láº¡i nhĂ³m cĂ´ng viá»‡c', layout: 'flat'})
			.setForm(form)
			.show()
			.focus('name');
	};
	
	
	this.setReview=function(lid){
		var tasklist=TaskList.fromContext(lid);
		if (!tasklist){
			return;
		}
		
		var project=Client.pageData.project;
		var data={id: project.id, tasklist_id: lid};

		var review=[];
		if (parseInt(tasklist.review.enabled) == 1) {
			review = tasklist.review.users;
			// var reviewer = '@'+review.users[0];
		} else {
			// var reviewer = '';
		}
		
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/review"})
		.row(
			Form.label({label: "Chá»n ngÆ°á»i Ä‘Ă¡nh giĂ¡ *"}),
			Form.input({name: 'user', placeholder: "Chá»n duy nháº¥t má»™t ngÆ°á»i, bá» trá»‘ng Ä‘á»ƒ xĂ³a", role: 'user'}).autoSubmit().value("@"+review)
		).addClass("-big")
		.buttons([
			 {label: "Cáº­p nháº­t", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng ...");
					 Form.hide("fly-tasklist-fx");
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data);
		
		
		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Cáº­p nháº­t ngÆ°á»i Ä‘Ă¡nh giĂ¡ nhĂ³m cĂ´ng viá»‡c', layout: 'flat'}).setForm(form).show().focus('user');
	
	};
	
	
	this.remove=function(lid){
		var tasklist=AP.array.findObj(Client.pageData.tasklists, lid);
		if (!tasklist){
			return;
		}
		
		if (Client.pageData.project.status != 0) {
			return AP.alertError("Dá»± Ă¡n Ä‘ang táº¡m Ä‘Ă³ng hoáº·c Ä‘Ă£ hoĂ n thĂ nh.");
		}
		
		AP.confirmDelete("Báº¡n cĂ³ cháº¯c muá»‘n xoĂ¡ nhĂ³m cĂ´ng viá»‡c <b>"+tasklist.name+"</b>? Táº¥t cáº£ cĂ´ng viá»‡c trong nhĂ³m sáº½ bá»‹ xĂ³a vĂ  nhĂ³m Ä‘Ă£ xoĂ¡ sáº½ khĂ´ng thá»ƒ phá»¥c há»“i.", function(){
			AP.ajaxShow();
			AP.post("api/project/tasklist/remove",{id: tasklist.id, token: tasklist.token}, function(code){
				AP.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.hideAlert();
				UI.flash("NhĂ³m cĂ´ng viá»‡c Ä‘Ă£ xoĂ¡");
				AP.refresh();
			});
		});
	};
	
	
	
	function closeForm(tasklist){
		var project=Client.pageData.project;
		var data={id: tasklist.id, token: tasklist.token};
	
		var form=Form.create('fly-tasklist-fx',{'action': "api/project/tasklist/close"})
		.row(
			Form.label({label: "TĂªn nhĂ³m cĂ´ng viá»‡c"}),
			Form.input({name: 'name', type:"fake"}).value(tasklist.name)
		)
		.row(
			Form.label({label: "Thá»i gian báº¯t Ä‘áº§u*"}),
			Form.input({name: 'cs_stime', "role":"date", placeholder: "Thá»i gian báº¯t Ä‘áº§u"}).valueIf(tasklist.cs.stime, parseInt(tasklist.cs.stime))
		).addClass("noflat")
		.row(
			Form.label({label: "Thá»i gian káº¿t thĂºc*"}),
			Form.input({name: 'cs_etime', "role":"date", placeholder: "Thá»i gian káº¿t thĂºc"}).valueIf(tasklist.cs.etime, parseInt(tasklist.cs.etime))
		).addClass("noflat")
		.hiddens(data)
		.buttons([
			 {label: "LÆ°u thay Ä‘á»•i", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Chá»‰nh sá»­a thĂ nh cĂ´ng...");
					 Form.hide("fly-tasklist-fx");
					 AP.xRefresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		Form.pop({id:'fly-tasklist-dx', width: 480, label: 'Táº¡m Ä‘Ă³ng nhĂ³m cĂ´ng viá»‡c: '+tasklist.name, layout: 'flat'})
		.setForm(form)
		.show()
		.focus('name');
	};

	
	
};




var Board=new function __Board(){
	this.mode="list";
	this.drag_mode='';
	
	this.cached_opts="";
	
	this.getTasks=function(){
		return Client.pageData.tasks;
	};

	
	this.fire = this.trigger = function(event, data){
		AP.sys.fire(event, data);
	};

	
	/**
	 * @desc General display of the board
	 */
	this.display=function(){
		var view=Client.pageData.task_view;
		this.mode=view;
		Board.data.init();
		
		if (view=="std" || view=="list"){
			this.mode="list";
			$("#tasklists").empty();
			Board.list.display(Client.pageData.context);	
		}
		
		if (view=="table"){
			$("#board-table").empty();
			Board.table.display();
		}
		
		if (this.mode=="board"){
			$("#main-board").empty();
			Board.kb.build("#main-board");
		}
		
		if (this.mode=="people"){
			$("#main-board").empty();
			var lists=Board.people.build();
			Board.kb.mode="people";
			Board.kb.build("#main-board", lists, {view:'people'});
		}
		
		Board.dnd();
	};
	
	
	/**
	 * @desc Binding events for new task / updated task
	 */
	this.updateEvents=function(task){
		if (this.drag_mode='drag'){
			if (Client.pageData.task_view=="board"){
				initTaskDraggable("#js-task-"+task.id);	
			}
		}
	};
	
	
	/**
	 * @desc Clear inline events and handlers / helper HTMLs
	 */
	this.clean=function(canvas, target){
		$(canvas+ " .js-task").removeClass("pending_focus");
		$(canvas+ " .activated").each(function(){
			if ($.contains(this, target) || this==target || $(target).closest(".ui-datepicker-header").length){
				$(this).closest(".js-task").addClass("pending_focus");
			}else{
				$(this).removeClass("activated");
			}
		});
		
		$(canvas+ " .js-task").each(function(){
			$(this).removeClass("focus");
			if ($(this).hasClass("pending_focus")){
				$(this).addClass("focus");	
			}
		});
	};
	
	
	
	/**
	 * @desc Make a full display reset
	 */
	this.reset=function(){
		var view=Client.pageData.task_view;
		if (view == "stream"){
			Team.stream.init({canvas: "#tasklists"});
		} else if (view == "period"){
			Team.period.init({canvas: "#tasklists"});
		} else if (Client.pageData.show_viewer==1){
			MyTask.list("#tasklists");
		} else {
			Board.display();
		}
	};
	
	
	
	/**
	 * @desc Init drag and drop task
	 */
	this.dnd=function(){
		this.drag_mode='';
		
		var a = performance.now();
		if (!Project.isManager()){
			// return;
		}else{
			initTasklistSortable();
		}
		var b = performance.now();
		console.log('Render tasklist sortable ' + ((b - a) / 1000).toFixed(4) + ' seconds');
		
		if (!Board.filter.sortEnabled()){
			if (Board.filter.dragEnabled()){
				this.drag_mode='drag';
				return this.draggable();
			}
			return;
		}
		
		this.drag_mode='sort';
		
		var stages_collector='#main-board .js-tasklist';
		var tasks_sortable="#main-board .items.js-set";
		var handler='';
		var axis='';
		
		if (this.mode=="list"){
			stages_collector='#tasklists .tasklist';
			tasks_sortable="#tasklists .tasklist .list.tasks";
			handler='.idx';
			axis='y';
		}
		
		if (this.mode=="table"){
			stages_collector='#js-main-table .js-group-wrapper';
			tasks_sortable="#js-main-table .js-group-wrapper";
			handler='.sbar';
			axis='y';
		}

		
		$(stages_collector).droppable({"tolerance": "pointer", accept: function($d){
			if ($d.hasClass("js-bucket")){
				return false;
			}
			
			var sid=$d.data("sid");
			if (sid== $(this).data("sid")){
				return false;
			}
			
			return true;
		}, 
		hoverClass:"dnd-hover", 
		drop: function(event, ui){
		}, out: function(event, ui){
			
		}});

		var c = performance.now();
		console.log('Render tasklist droppable ' + ((c - b) / 1000).toFixed(4) + ' seconds');
		
		this.cached_opts={set: tasks_sortable, handle: handler, axis: axis};

		initTaskSortAndDrag(tasks_sortable, this.cached_opts);
		var d = performance.now();
		console.log('Render init task sort and drag ' + ((d - c) / 1000).toFixed(4) + ' seconds');
	};
	
	
	/**
	 * @desc Draggable only, without sorting
	 */
	this.draggable = function () {
		var stages_collector = '#main-board .js-tasklist';
		var tasks_sortable = "#main-board .items.js-set .js-task";
		var handler = '';
		var axis = '';

		if (this.mode == "list") {
			stages_collector = '#tasklists .tasklist';
			tasks_sortable = "#tasklists .tasklist .list.tasks";
			handler = '.idx';
			axis = 'y';
		}

		if (this.mode == "table") {
			stages_collector = '#js-main-table .js-group-wrapper';
			tasks_sortable = "#js-main-table .js-group-wrapper";
			handler = '.sbar';
			axis = 'y';
		}


		$(stages_collector).droppable({
			tolerance: "pointer",
			accept: function ($d) {
				if ($d.hasClass("js-bucket")) {
					return false;
				}

				var sid = $d.data("sid");
				if (sid == $(this).data("sid")) {
					return false;
				}

				return true;
			},
			hoverClass: "dnd-hover",
			drop: function (event, ui) {
				moving(ui.draggable, this);
			}
		});

		initTaskDraggable(tasks_sortable);
	};
	
	
	
	
	/**
	 * @desc Init task sorting and moving at the same time
	 */
	function initTaskSortAndDrag(ref, opts){
		// Refresh with sortable("refresh"); <ACCEPT NEW ELEMENT>
		var phase_0 = performance.now();
		if (AP.data.isInt(ref)){
			ref="#js-task-"+ref;
		}
		
		var sortable_opts={
			items: "> .js-task",
			helper: "clone",
			opacity: 0.95,
			tolerance : "pointer",
//				appendTo: '#main-board',
			connectWith: opts.set,
			forcePlaceholderSize: true,
			placeholder: "sortable-placeholder",
			scroll: true,
			start: function(event, ui){
				ui.helper.addClass("sortable-active");
				var last_task_id=0;
				var $last_task=$(ui.placeholder).prev();
				if ($last_task.length){
					last_task_id=$last_task.data("id")
				};
				
				$(ui.item).data("temp_prev_id", last_task_id);
			},
			change: function(event){
				// checkMousePosition(event);
			},
			stop: function(event, ui){
				var task=Query.get("task");
				if (task) {
					return;
				}
				
				var id=$(ui.item).data("id");
				if (!id || !parseInt(id)){
					return;
				}
				
				if ($(ui.item).hasClass(".js-tasklist")){
					// HOT FIX KANBAN
					return;	
				}
				
				var tasklist_id=$(ui.item).closest(".js-tasklist").data("id");
				if (opts.set == "#js-main-table .js-group-wrapper") {
					var tasklist_id=$(ui.item).closest(".js-group-wrapper").data("id");
				}

				if (tasklist_id===false || tasklist_id===null){
					tasklist_id=0;
				}
				
				// moving(ui.draggable, $("#main-board .js-stage-"+sid));
				
				if (Board.kb.mode=="people"){
				}else{
					//Fix bug drag and drop in board view
					
					var prev_id=0;
					var $prev=$(ui.item).prev();
					if ($prev.length && $prev.hasClass("js-task")){
						prev_id=$prev.data("id");
					}
					
					if (prev_id==parseInt($(ui.item).data("temp_prev_id"))){
						return;
					}
					
					Task.action.setOrder(id, prev_id, tasklist_id);
					
					$(ui.item).data("tasklist_id", tasklist_id);
				}
			},
		};
		
		if (opts.handle && opts.handle.length){
			sortable_opts.handle=opts.handle;
		}
		
		if (opts.axis && opts.axis.length){
			sortable_opts.axis=opts.axis;
		}
		var phase_1 = performance.now();
		console.log('Render init task sort and drag sortable opts ' + ((phase_1 - phase_0) / 1000).toFixed(4) + ' seconds');
		
		/**
		 * @caonguyen
		 * Only binding sortable event when catching mousemove event
		 * For boosting loading time in wework list and gantt view
		 */
		var containers = document.querySelectorAll(ref);
		var sortable_array = []

		var drag_event = mobile() ? 'touchmove' : 'mousemove';
		for (var i = 0; i < containers.length; i ++) {
			$(containers[i]).data('sortable-index', i);
			var last_y = 0;
			$(containers[i]).on(drag_event, function (event) {
				// All containers is sortable , so turn off binding event
				if (sortable_array.length == containers.length) {
					$(ref).off(drag_event);
					return;
				}

				var velocity_y = event.pageY - last_y;
				last_y = event.pageY;
				if (last_y == 0) {
					return;
				}

				var current_index = parseInt($(this).data('sortable-index'));

				// If current container is not sortable, so initalize sortable first
				if (!AP.array.contain(sortable_array, current_index)) {
					$(this).sortable2(sortable_opts).disableSelection();
					sortable_array.push(current_index);
					return;
				}

				// If mouse is going up, so initialize sortable for the above containers first
				if (velocity_y < 0) {
					for (let j = current_index - 1; j >= 0; j--) {
						if (!AP.array.contain(sortable_array, j)) {
							$(containers[j]).sortable2(sortable_opts).disableSelection();
							sortable_array.push(j);
							return;
						}
					}
				}

				// If mouse is going down, so initialize sortable for the below containers first
				for (let j = current_index + 1; j < containers.length; j++) {
					if (!AP.array.contain(sortable_array, j)) {
						$(containers[j]).sortable2(sortable_opts).disableSelection();
						sortable_array.push(j);
						return;
					}
				}
			})
		}

		var phase_2 = performance.now();
		console.log('Render init task sort and drag sortable2 ' + ((phase_2 - phase_1) / 1000).toFixed(4) + ' seconds');
	};
	
	
	
	function initTaskDraggable(selector){
		$(selector).draggable({
			helper: "clone", 
			appendTo: '#main-board',
			placeholder: "sortable-placeholder",
			scroll: true,
			start: function(event, ui){
				$(ui.helper).addClass("sortable-active");
				$(ui.helper.context).addClass("sortable-placeholder");
				// $("#main-board .stages .tab").removeClass("inactive");
				// $("#main-board .stages .tab.tab-"+$(this).data("sid")).addClass("inactive");
			},
			drag: function(event, ui){
				// checkMousePosition(event);
			},
			stop: function(event, ui){
				$("#main-board .js-task").removeClass("sortable-placeholder");
			},
		});
	};
	
	
	function initTasklistSortable(){
		// INIT SORTABLE TASKLIST
		if (!mobile() && Board.mode=="board" && Board.data.model.metatype=="tasklist" && Project.isManager()){
			$("#main-board .stages").sortable({
				axis: "x",
				tolerance: "pointer",
				handle: ".name",
				placeholder: "stage-placeholder",
				forcePlaceholderSize: true,
				scroll: true,
				items: ".js-bucket:not(.js-stage-0)",
				start: function(event, ui){			
					ui.helper.addClass("sortable-stage-active");
				},
				stop: function(event, ui){
					$("#main-board .stages .stage").removeClass("sortable-stage-active");
					
					var orders=[];
					$("#main-board .stages .stage").each(function(){
						if ($(this).data("id")){
							orders.push($(this).data("id"));
						}
					});
					
					
					AP.post("api/project/tasklist/reorder", {id: Client.pageData.project.id, orders: orders.join(",")}, function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}
					});
				},
				opacity:0.8
			});
			
			
			$("#main-board .stages .stage").each(function(){
				AP.dnd(this, "api/task/add.upload", {
					id: Client.pageData.context.id,
					tasklist_id: $(this).closest(".js-bucket").data("sid")
				}, function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}

					AP.xRefresh(function(){
						UI.flash("Uploaded successfully");
					});

				});
			});
		}
	};
	
	
	
	function moving(task_selector, group_selector){
		var id=$(task_selector).data("id");
		var task=Task.fromContext(id);
		if (!task){
			return;
		}
		
		var m=Board.data.model.metatype;
		var gid=$(group_selector).data("id");
		
		if (m=="tasklist"){
			if (gid==task.tasklist_id){
				return;
			}
			
			Task.inline.edit(id, {key: "tasklist", value: gid}, task_selector);
		}

		if (m=="milestone"){
			if (gid==task.milestone_id){
				return;
			}
			
			Task.inline.edit(id, {key: "milestone", value: gid}, task_selector);
		}
		
		if (m=="user"){
			if (gid==task.user_id){
				return;
			}
			
			Task.inline.edit(id, {key: "assign", value: gid}, task_selector);
		}
		
		
		// DISPLAY ON UI
		$(task_selector).slideUp(100, function(){
			$(this).prependTo($(group_selector).find(".items")).slideDown(200, function(){				
			});
		});
		
	};
};




Board.data = new function __BoardData() {

	this.model = null;
	this.period_by = null; // TEAM ONLY
	
	this.init = function() {

		if (!Client.pageData.project) {
			return [];
		}

		var phase_0 = performance.now();

		// BUILDING THE TASK RELATIONSHIP
		for (var j = 0; j < Client.pageData.tasks.length; j++) {
			Client.pageData.tasks[j].visible=Project.filter.getVisible(Client.pageData.tasks[j]);
			
			Client.pageData.tasks[j].subtasks = AP.array.filter(Client.pageData.tasks, function(s){
				return parseInt(s.parent_id) == parseInt(Client.pageData.tasks[j].id);
			});
			
			Client.pageData.tasks[j].subtasks=AP.array.realOrder(Client.pageData.tasks[j].subtasks);
			
			Client.pageData.tasks[j].parent=AP.array.findObj(Client.pageData.tasks, Client.pageData.tasks[j].parent_id);
		}

		var phase_1 = performance.now();
		console.log('BUILDING THE TASK RELATIONSHIP ' + ((phase_1 - phase_0) / 1000).toFixed(4) + ' seconds');
		
		// SORT TASKS AGAIN IF IN PROJECT METATYPE IS PROJECT
		if (Client.pageData.context && Client.pageData.context.metatype=="project"){
			Client.pageData.tasks.sort(function (e, f) {
				return Board.filter.computeSort(e, f);
			});
		}else if (Client.pageData.context && Client.pageData.task_view=="period"){
			Client.pageData.tasks.sort(function (e, f) {
				return Board.filter.periodSort(e, f);
			});
		}else if (Client.pageData.context && Client.pageData.task_view=="stream"){
			Client.pageData.tasks.sort(function (e, f) {
				return Board.filter.streamSort(e, f);
			});
		}
		
		var phase_2 = performance.now();
		console.log('SORT TASKS AGAIN IF IN PROJECT METATYPE IS PROJECT ' + ((phase_2 - phase_1) / 1000).toFixed(4) + ' seconds');
		
		// BUILDING TASKLISTS
		AP.array.reorder(Client.pageData.tasklists);
		if (!AP.array.findObj(Client.pageData.tasklists, 0)){
			Client.pageData.tasklists.unshift(getDefaultTasklist());
		}

		var phase_3 = performance.now();
		console.log('BUILDING TASKLISTS ' + ((phase_3 - phase_2) / 1000).toFixed(4) + ' seconds');
		
		// LINK (MAIN) TASKS TO TASKLIST
		for (var i = 0; i < Client.pageData.tasklists.length; i++) {
			Client.pageData.tasklists[i].tasks = AP.array.filter(Client.pageData.tasks, function (e) {
				if (parseInt(e.tasklist_id) == parseInt(Client.pageData.tasklists[i].id) && e.metatype=="task"){
					return e;
				}
				return null;
			});
		}

		var phase_4 = performance.now();
		console.log('LINK (MAIN) TASKS TO TASKLIST ' + ((phase_4 - phase_3) / 1000).toFixed(4) + ' seconds');
		
		// BUILDING MILESTONES
		if (!AP.array.findObj(Client.pageData.milestones, 0)){
			Client.pageData.milestones.push(getDefaultMilestone());
		}
		
		Client.pageData.milestones.sort(function(e, f){
			return parseInt(f.time)-parseInt(e.time);
		});

		var phase_5 = performance.now();
		console.log('BUILDING MILESTONES ' + ((phase_5 - phase_4) / 1000).toFixed(4) + ' seconds');
		
		// LINK (MAIN) MILESTONES TO MILESTONE
		for (var i = 0; i < Client.pageData.milestones.length; i++) {
			Client.pageData.milestones[i].tasks = AP.array.filter(Client.pageData.tasks, function (e) {
				if (parseInt(e.milestone_id) == parseInt(Client.pageData.milestones[i].id) && e.metatype=="task"){
					return e;
				}
				return null;
			});
		}

		var phase_6 = performance.now();
		console.log('LINK (MAIN) MILESTONES TO MILESTONE ' + ((phase_6 - phase_5) / 1000).toFixed(4) + ' seconds');
		
		// BUILD PEOPLE
		var people={};
		for (var i=0; i<Client.pageData.tasks.length; i++){
			if (Client.pageData.tasks[i].metatype=="task"){
				if (people["p"+Client.pageData.tasks[i].username]){
					people["p"+Client.pageData.tasks[i].username].push(Client.pageData.tasks[i]);
				} else {
					people["p"+Client.pageData.tasks[i].username]=[Client.pageData.tasks[i]];
				}	
			}
		}
		
		Client.pageData.people = [];
		for (var key in people){
			var id = key.substr(1);
			var u = shallowClone(People.get(id));
			
			if (!id){
				u = getDefaultUser(u);
			} else if (u && !u.error){
			} else {
				u = getDeactivatedUser(u, people[key][0]);
			}
			
			u.tasks = people[key];
			Client.pageData.people.push(u);
		}

		var phase_7 = performance.now();
		console.log('BUILD PEOPLE ' + ((phase_7 - phase_6) / 1000).toFixed(4) + ' seconds');

		/**
		 * @desc Building model
		 */
		this.buildModel();

		var phase_8 = performance.now();
		console.log('Building model ' + ((phase_8 - phase_7) / 1000).toFixed(4) + ' seconds');
	};

	
	/**
	 * @desc Smartly groups tasks into collections, either by {tasklists, people, milestones}. Tasklist is default
	 * @return object {type, groups}  
	 */
	this.buildModel=function(){
		var groupby=Base.pref().get("pref_groupby_"+Client.pageData.project.id)
		var num_tasks=countTasks(AP.array.filter(Client.pageData.tasks, function(e){
			return e.metatype=="task";
		}));
		
		if (groupby=="tasklist" || !groupby){
			this.model={metatype:"tasklist", groups: Client.pageData.tasklists, num_groups: Client.pageData.tasklists.length, num_tasks: num_tasks, num_task_and_subtasks: Client.pageData.tasks.length};	
		}else if (groupby=="milestone"){
			this.model={metatype:"milestone", groups: Client.pageData.milestones, num_groups: Client.pageData.milestones.length, num_tasks: num_tasks, num_task_and_subtasks: Client.pageData.tasks.length};	
		}else if (groupby=="people"){
			this.model={metatype:"user", groups: Client.pageData.people, num_groups: Client.pageData.people.length, num_tasks: num_tasks, num_task_and_subtasks: Client.pageData.tasks.length};	
		}
		
		this.model.grouped=Board.filter.grouped;
	};
	
	
	/**
	 * @desc Quickly discover object by its id and optionally metatype
	 * @param int id the object id
	 * @param string metatype OPTIONAL, default is Board.data.model.metatype
	 */
	this.fromContext=function(id, metatype){
		if (!metatype){
			metatype=this.model.metatype;
		}
		
		if (metatype=="tasklist"){
			return AP.array.findObj(Client.pageData.tasklists, id);
		}else if (metatype=="user"){
			return AP.array.findObj(Client.pageData.people, id);
		}else if (metatype=="milestone"){
			return AP.array.findObj(Client.pageData.milestones, id);
		}
		
		return null;
	};
	
	
	this.update=function(task){
		if (Client.pageData.tasks){
			// AP.array.updateByID(Client.pageData.tasks, task);
			for (var i=0; i<Client.pageData.tasks.length; i++){
				if (parseInt(Client.pageData.tasks[i].id)==parseInt(task.id)){
					for (var prop in task){
						Client.pageData.tasks[i][prop]=task[prop];
					}
				}
			}
		}
		
		this.init();
		return this.getTask(task);
	};
	
	
	this.insert=function(task){
		if (Client.pageData.tasks){
			AP.array.updateByID(Client.pageData.tasks, task);
		}
		
		this.init();
		return this.getTask(task);
	};
	
	
	/**
	 * @desc Update data model when inserting a list of tasks
	 */
	this.insertList=function(tasks){
		if (Client.pageData.tasks){
			for (var i=0; i<tasks.length; i++){
				AP.array.updateByID(Client.pageData.tasks, tasks[i]);	
			}
		}
		
		this.init();
	};
	

	this.taskMoved=function(task){
		
	};
	
	
	this.getTask=function(task){
		return AP.array.findObj(Client.pageData.tasks, task.id);
	};
	
	
	
	function getDefaultTasklist(){
		return {"tasks": [], "name": "ChÆ°a phĂ¢n loáº¡i", type: "tasklist", df: 1, id: 0, stats: {}};
	};
	
	function getDefaultMilestone(){
		return {"tasks": [], "name": "KhĂ´ng cĂ³ má»¥c tiĂªu", type: "milestone", id: 0, stats: {}, time: 0};
	};
	
	function getDefaultUser(){
		return {"tasks": [], "name": "ChÆ°a giao", type: "user", id: 0, stats: {}, time: 0};
	};
	
	
	function getDeactivatedUser(u, task){
		return {"tasks": [], "name": u.name, type: "user", id: task.user_id, error: 1, stats: {}, time: 0};
	};
	
	
	function countTasks(arr){
		var total=AP.array.count(arr, function(e){
			return parseInt(e.visible);
		});
		
		for (var i=0; i<arr.length; i++){
			if (arr[i].visible){
				total+=countTasks(arr[i].subtasks);
			}
		}
		
		return total;
	}
};


Board.tasklist=new function __BoardTaskList(){
	this.build=function(){
		var tasklists=Project.tasklists();
		
		var r=[];
		for (var i=0; i<tasklists.length; i++){
			r.push({
				type: "tasklist",
				header: tasklists[i],
				items: tasklists[i].tasks,
				tasks: tasklists[i].tasks
			});
		}
		
		return r;
	};
	
	
	this.buildWithTemplate=function(){
		var tasklists=Project.tasklists();
		
		var r=[];
		for (var i=0; i<tasklists.length; i++){
			r.push({
				type: "tasklist",
				metatype: "tasklist",
				header: tasklists[i],
				items: filterActive(tasklists[i].tasks),
				tasks: filterActive(tasklists[i].tasks)
			});
		}
		
		
		return r;
	};
	
	
	
	function getCompletedTasks(){
		return AP.array.filter(Client.pageData.tasks, function(e){
			return parseInt(e.status)==0;
		});
	};
	
	
	function getReviewingTasks(){
		return AP.array.filter(Client.pageData.tasks, function(e){
			return parseInt(e.review) && !parseInt(e.status);
		});
	};
	
	function filterActive(tasks){
		return AP.array.filter(tasks, function(e){
			return !parseInt(e.review) && !parseInt(e.status);
		});
	};
};


Board.people=new function __BoardPeople(){
	this.build=function(){
		var logs={};
		logs.not_assigned={
			header:{
				"name":"ChÆ°a Ä‘Æ°á»£c giao",
				"id":"not_assigned"
			},
			tasks:[]
		};
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			if (!parseInt(Client.pageData.tasks[i].user_id)){
				if (!logs.not_assigned){
					logs.not_assigned={
						header:{
							"name":"ChÆ°a Ä‘Æ°á»£c giao",
							"id":"not_assigned"
						},
						tasks:[Client.pageData.tasks[i]]
					}
				}else{
					logs.not_assigned.tasks.push(Client.pageData.tasks[i]);
				}
				
				continue;
			}
			
			var u=People.get(Client.pageData.tasks[i].username);
			var username=u.username;
			
			if (!logs[username]){
				logs[username]={
					header:u,
					tasks:[Client.pageData.tasks[i]]
				}
			}else{
				logs[username].tasks.push(Client.pageData.tasks[i]);
			}
		}
		
		var r=[];
		for (var key in logs){
			if (logs[key].tasks){
				r.push(logs[key]);
			}
		}
		
		for (var i=0; i<r.length; i++){
			r[i].tasks=r[i].tasks;
			r[i].tasks.sort(function(e, f){
				return Project.filter.computeSort(e, f);
			});
		}
		
		return r;
	};
};


Board.filter = new function __BoardFilter() {
	this.current = "all";
	this.grouped = 1; // GROUP COMPLETED TASK
	this.subtasks = 0;
	this.filter = "all";
	this.sort = "default";
	this.groupby = "tasklist";

	this.init = function () {
		if (AP.pageConfig.get("inited")) {
			return;
		}

		AP.pageConfig.set("inited", 1);

		initProjectSorter();
		initProjectRangeFilter();
		initGCTPref();
		initSubtaskFilter();
		initStatusFilter();
		initProjectGroupBy();
	};


	this.live = function (key, val) {
		if (Client.pageData.project && Client.pageData.project.metatype == "project") {
			Project.header.applyFilter(key + ":" + val + " ");
		} else {
			if (key == "filter") {
				if (val == "important" || val == "urgent" || val == "overdue" || val == "donelate" || val == "today" || val == "todo" || val == "doing" || val == "done") {
					return AP.setURLParams({ status: val }, true);
				} else {
					if (AP.word.prefix(val, "start-") || val == "subtask") {
						return;
					}

					return AP.setURLParams({ q: val }, true);
				}
			}
		}
	};


	this.sortEnabled = function () {
		return Board.filter.sort == "default" && Client.pageData.project && Client.pageData.project.metatype == "project" && Board.data.model.metatype == "tasklist";
	};


	this.dragEnabled = function () {
		if (!Client.pageData.project) {
			return false;
		}

		if (Client.pageData.task_view != "board") {
			return false;
		}

		if (Project.isManager()) {
			return true;
		}

		return true;
	};



	this.removeStartDate = function () {
		AP.setURLParams({ start: null, end: null }, true);
	};


	/**
	 * @desc Compute the order of two 
	 */
	this.computeSort = function (e, f) {
		var sort = this.sort;

		if (sort == "deadline") {
			return sortByDeadline(e, f);
		}

		if (sort == "deadline_reversed") {
			var e1 = parseInt(e.deadline);
			var f1 = parseInt(f.deadline);
			var now = AP.time.now();

			if (!e1) {
				e1 = AP.time.beginOfDay(now);
			}
			if (!f1) {
				f1 = AP.time.beginOfDay(now);
			}

			return e1 - f1;
		}

		if (sort == "alpha") {
			var e1 = AP.purify(e.name);
			var f1 = AP.purify(f.name);

			return e1.localeCompare(f1);
		}

		if (sort == "urgent") {
			var e1 = parseInt(e.urgent);
			var f1 = parseInt(f.urgent);

			return f1 - e1;
		}


		if (sort == "update_time") {
			var e1 = parseInt(e.last_update);
			var f1 = parseInt(f.last_update);

			return f1 - e1;
		}


		if (sort == "id" || (Client.pageData.context && Client.pageData.context.metatype != "project")) {
			return (parseInt(f.id) - parseInt(e.id));
		}

		if (!f.real_order && !e.real_order) {
			return (parseInt(f.id) - parseInt(e.id));
		}

		return (parseInt(f.real_order) - parseInt(e.real_order));
	};



	/**
	 * @desc Sorting on period view
	 */
	this.periodSort = function (e, f) {
		var period = Board.data.period_by;
		if (period == "deadline") {
			return sortByDeadline(e, f);
		}

		return parseInt(f.id) - parseInt(e.id);
	};


	/**
	 * @desc Sorting on stream view
	 */
	this.streamSort = function (e, f) {
		var order = Query.get("order");
		if (order == "deadline") {
			return sortByDeadline(e, f);
		} else if (order == "created") {
			return parseInt(f.id) - parseInt(e.id);
		} else {
			return parseInt(f.last_update) - parseInt(e.last_update);
		}
	};




	/**
	 * @desc Checking to make sure that a task after released is visible. Project only
	 */
	this.getVisible = function (task) {
		if (!Client.pageData.project || Client.pageData.project.metatype != "project") {
			return 1;
		}

		var view = Project.filter.filter;

		if (view == "all") {
			return 1;
		} else if (view == "active") {
			if (parseInt(task.status)) {
				return 0;
			}
		} else if (view == "notreview") {
			if (parseInt(task.status) == 0 && parseInt(task.review) == 0) {
				return 1;
			}
			return 0;
		} else if (view == "review") {
			if (parseInt(task.status) == 0 && parseInt(task.review) == 1) {
				return 1;
			}
			return 0;
		} else if (view == "done") {
			if (!parseInt(task.status)) {
				return 0;
			}
		} else if (view == "starred") {
			if (!Task.fav.isFav(task.id)) {
				return 0;
			}
		} else if (view == "mine") {
			if (parseInt(task.user_id) != parseInt(Client.viewer.id)) {
				return 0;
			}
		} else if (view == "urgent") {
			if (!parseInt(task.urgent)) {
				return 0;
			}
		} else if (view == "important") {
			if (!parseInt(task.important)) {
				return 0;
			}
		} else if (view == "overdue") {
			if (!Compute.overdue(task)) {
				return 0;
			}
		} else if (view == "donelate") {
			if (!Compute.doneLate(task)) {
				return 0;
			}
		} else if (view == "todo") {
			if (Task.ui.grandState(task) == "todo") {
				return 1;
			}
			return 0;
		} else if (view == "doing") {
			if (Task.ui.grandState(task) == "doing") {
				return 1;
			}
			return 0;
		}

		return 1;
	};


	/**
	 * @desc Check matching
	 */
	function match($elem, key) {
		if (key == "all") {
			return true;
		}

		if (key == "mine") {
			if ($elem.data("username") == Client.viewer.username) {
				return true;
			}

			return false;
		}

		if (key == "starred") {
			if (parseInt($elem.data("starred"))) {
				return true;
			}

			return false;
		}

		if (key == "alert") {
			if ($elem.hasClass("-alert")) {
				return true;
			}

			return false;
		}

		if (key == "week") {
			var dl = $elem.data("deadline");
			if (AP.time.sameWeek(dl, AP.time.now())) {
				return true;
			}

			return false;
		}

		if (key == "done") {
			return $elem.hasClass("-done");
		}

		if (key == "overdue") {
			return $elem.hasClass("-overdue");
		}
	};



	/**
	 * @desc Init subtask filter 
	 */
	function initSubtaskFilter() {
		if (!Client.pageData.project) {
			return;
		}

		$("#js-project-view-subtasks").html("<option value='natural'>Nhiá»u cáº¥p cĂ´ng viá»‡c con</option> <option value='flatten'>Táº¥t cáº£ cĂ¹ng cáº¥p</option> <option value='none'>KhĂ´ng hiá»ƒn thá»‹</option>");

		if (Client.pageData.project.metatype == "project") {
			$("#js-project-view-subtasks").html("<option value='natural'>Má»™t cáº¥p cĂ´ng viá»‡c con</option> <option value='nested'>Nhiá»u cáº¥p cĂ´ng viá»‡c con</option> <option value='none'>KhĂ´ng hiá»ƒn thá»‹</option>");
		}

		// Subtasks
		var subtasks_pref = AP.log.getAppCookie("subtasks_pref_" + Client.pageData.project.id);
		if (!subtasks_pref) {
			subtasks_pref = "natural";
		}

		AP.pageConfig.set("subtasks", subtasks_pref);

		$("#js-project-view-subtasks").val(subtasks_pref);

		$("#js-project-view-subtasks").on("change", function () {
			var val = $(this).val();
			AP.log.setAppCookie("subtasks_pref_" + Client.pageData.project.id, val);
			AP.xRefresh();
		});
	};




	/**
	 * @desc Init project internal sorter, project only
	 */
	function initProjectSorter() {
		if (!Client.pageData.project) {
			return;
		}

		var sort = Base.pref().get("pref_sort_" + Client.pageData.project.id);
		if (!sort || sort == "tasklist" || sort == "milestone" || sort == "user") {
			sort = "default";
		}


		Board.filter.sort = sort;
		Base.pref().set("pref_sort_" + Client.pageData.project.id, sort);

		$("#df_sort").val(sort).on("change", function () {
			var val = $(this).val();
			Base.pref().set("pref_sort_" + Client.pageData.project.id, val);
			AP.xRefresh();
		});
	};



	/**
	 * @desc Init project groupby, project only
	 */
	function initProjectGroupBy() {
		if (!Client.pageData.project || Client.pageData.project.metatype != "project") {
			$("#js-mastergroup_pref").parent().hide();
			return;
		}

		$("#js-mastergroup_pref").html("<option value='tasklist'>NhĂ³m cĂ´ng viá»‡c</option> <option value='milestone'>Má»¥c tiĂªu</option> <option value='people'>ThĂ nh viĂªn</option>");

		var g = Base.pref().get("pref_groupby_" + Client.pageData.project.id);
		if (!g) {
			g = "tasklist";
		}

		Board.filter.groupby = g;
		Base.pref().set("pref_groupby_" + Client.pageData.project.id, g);

		$("#js-mastergroup_pref").val(g).on("change", function () {
			var val = $(this).val();
			Base.pref().set("pref_groupby_" + Client.pageData.project.id, val);
			AP.xRefresh();
		});
	};




	/**
	 * @desc Init filters to choose start and end date, project only
	 */
	function initProjectRangeFilter() {
		if (Client.pageData.project.metatype == 'project' && !mobile()) {
			var label = "<span class='js-clickable'>NgĂ y táº¡o <span class='-ap icon-chevron-down2'></span></span>";
			var start_str = AP.time.time("%Y-%m-%d", Client.pageData.context.since);
			var end_str = AP.time.time("%Y-%m-%d", AP.time.now());

			if (parseInt(Client.pageData.params.start) && parseInt(Client.pageData.params.end)) {
				label = "<span class='js-clickable'> NgĂ y táº¡o: <em>"+(AP.i18n.date(Client.pageData.params.start))+"</em> &rsaquo;&nbsp; <em>"+(AP.i18n.date(Client.pageData.params.end))+"</em> </span> &nbsp; &#8942; &nbsp; <span onclick='Board.filter.removeStartDate();' class='-ap icon-close' title='Remove this filter'></span>";
			}

			$("#js-header-startdate").html(label);

			$("#js-header-startdate .js-clickable").dateRangePicker({
				getValue: function () {
					return this.innerHTML;
				},
				setValue: function (s, from, to, from_ts, to_ts, click) {

				},
				onSelect: function (from, to) {
					AP.setURLParams({
						start: encodeURIComponent(AP.time.time("%d-%m-%Y", from)),
						end: encodeURIComponent(AP.time.time("%d-%m-%Y", to)),
					}, true);

					$(this).data('dateRangePicker').close();
				}
			});

			$("#js-header-startdate .js-clickable").data("dateRangePicker").setStart(start_str).setEnd(end_str);
		};
	};



	/**
	 * @desc Init group-completed task pref
	 */
	function initGCTPref() {
		if (!Client.pageData.project) {
			return;
		}

		var grouped = Base.pref().get("pref_grouped_" + Client.pageData.project.id);
		if (!grouped || !parseInt(grouped)) {
			grouped = 1;
		}

		grouped = parseInt(grouped);
		Board.filter.grouped = grouped;

		if (grouped == 1) {
			$("#df-group-done").addClass("checked");
		} else {
			$("#df-group-done").removeClass("checked");
		}

		$("#df-group-done").click(function () {
			var grouped = Board.filter.grouped;
			if (!grouped || !parseInt(grouped)) {
				grouped = 1;
			}

			grouped = -parseInt(grouped);
			Base.pref().set("pref_grouped_" + Client.pageData.project.id, grouped);
			Board.filter.grouped = grouped;

			if (grouped == 1) {
				$("#df-group-done").addClass("checked");
			} else {
				$("#df-group-done").removeClass("checked");
			}

			AP.xRefresh();
		});
	};


	function initStatusFilter() {
		var filter = Base.pref().get("pref_filter" + Client.pageData.project.id);
		if (!filter) {
			filter = "all";
		}

		Board.filter.filter = filter;

		Base.pref().set("pref_filter" + Client.pageData.project.id, filter);


		$("#js-canvas-filter .li").each(function () {
			var f = $(this).data("filter");
			var lb = $(this).data("label");
			if (f == filter) {
				$(this).addClass("selected");
				$("#tasklists").removeClass().addClass("filter-" + f);
				$("#js-canvas-filter em").html(lb);
			}

			$(this).click(function () {
				var f = $(this).data("filter");
				var lb = $(this).data("label");
				Base.pref().set("pref_filter" + Client.pageData.project.id, f);
				Board.filter.filter = f;


				$(this).addClass("selected");
				$(this).siblings().removeClass("selected");

				if (Client.pageData.task_view == "table" || Client.pageData.task_view == "board" || Client.pageData.task_view == "people" || Client.pageData.task_view == "list") {
					Board.display();
				}

				$("#js-canvas-filter em").html(lb);
			});
		});
	};



	function sortByDeadline(e, f) {
		var e1 = parseInt(e.deadline);
		var f1 = parseInt(f.deadline);
		var now = AP.time.now();

		if (!e1) {
			e1 = AP.time.beginOfDay(now) - 1;
		}
		if (!f1) {
			f1 = AP.time.beginOfDay(now) - 1;
		}

		return f1 - e1;
	};

};




Project.filter = Board.filter;




Board.list = new function __BoardList() {

	this.display = function(project) {

		var phase_0 = performance.now();

		this.build(project);

		var phase_1 = performance.now();
		console.log('Board list display build ' + ((phase_1 - phase_0) / 1000).toFixed(4) + ' seconds');

		var p = Me.pref();

		var phase_2 = performance.now();
		console.log('Board list display Me pref ' + ((phase_2 - phase_1) / 1000).toFixed(4) + ' seconds');

		$("#tasklists .tasklist").each(function() {
			var collapsed = p.get([project.id, $(this).data("id"), Board.data.model.metatype]);
			if (collapsed && parseInt(collapsed)) {
				$(this).addClass("-collapsed");
			}
		});
		
		$("#tasklists").click(function(e) {
			Board.clean("#tasklists", e.target);
		});

		var phase_3 = performance.now();
		console.log('Board list display tasklists board clean ' + ((phase_3 - phase_2) / 1000).toFixed(4) + ' seconds');
		
		Board.engine.init();

		var phase_4 = performance.now();
		console.log('Board list display tasklists board engine init ' + ((phase_4 - phase_3) / 1000).toFixed(4) + ' seconds');

		Project.subheader.init();

		var phase_5 = performance.now();
		console.log('Board list display tasklists project subheader init ' + ((phase_5 - phase_4) / 1000).toFixed(4) + ' seconds');
	};
	
	
	/**
	 * @desc Event call when a new task is inserted
	 */
	this.taskInserted = function(task) {
		if (task.metatype == "subtask") {
			if (task.parent_id && parseInt(task.parent_id)) {
				if (!$("#task-" + task.parent_id).length) {
					return;
				}
				
				var $box = $("#task-"+task.origin_export.id).parent().find(".js-subtasks").first();
				$box.removeClass("no-tasks");
				$box.append(Board.ui.renderItem(task));
			}
			return;
		}
		
		var tasklist = TaskList.fromContext(task.tasklist_id);
		Board.list.group.update(tasklist);
	};
	
	
	/**
	 * @desc Event called when a task is updated
	 */
	this.taskUpdated = function(task) {
		if (Board.mode != "list") {
			return;
		}
		
		$("#tasklists #task-"+task.id).replaceWith(Board.ui.getSingleHTML(task));
		// $("#tasklists .js-subtasks-p" + task.id).insertAfter($("#tasklists .li-"+task.id));
		
		Board.list.group.updateStats();
	};

	
	this.build = function(project) {

		var phase_0 = performance.now();

		$("#tasklists").empty();

		for (var i = 0; i < Board.data.model.groups.length; i++) {
			var g = Board.data.model.groups[i];
			var html = Board.list.group.get(g);
			$(html).appendTo("#tasklists");
		}

		var phase_1 = performance.now();
		console.log('Board list display build tasklists ' + ((phase_1 - phase_0) / 1000).toFixed(4) + ' seconds');
		
		Board.list.group.updateStats();

		var phase_2 = performance.now();
		console.log('Board list display build group updateStats ' + ((phase_2 - phase_1) / 1000).toFixed(4) + ' seconds');
		
		$("#tasklists .js-form-wrap").each(function() {
			Task.form.bindEvents(this);
		});

		var phase_3 = performance.now();
		console.log('Board list display build form bindEvents ' + ((phase_3 - phase_2) / 1000).toFixed(4) + ' seconds');
	};


	this.editing=function(ref){
		var li_ref = $(ref).closest(".li");
		if (li_ref.hasClass("js-task") || li_ref.hasClass("js-subtask")) {
			li_ref.toggleClass("editing").siblings().removeClass("editing");
			var $input = li_ref.find("textarea[name=name]");
			
			if (!$input.hasClass("__ap_enter_binded")){
				$input.enter(function(){
					var name=$(this).val();
					var id=$(this).closest(".li").data("id");
					
					Task.inline.edit(id, {"key": "name", value: name}, this);
				});
			}
			
			setTimeout(function(){
				$input.focus();
				var val=$input.val();
				$input.val("").val(val);
			},200);
		}
	};
	
	
	this.toggleTasklist=function(id, ref){
		var $box=$("#tasklist-"+id);
		if (!$box.length || $box.data("id")!=id){
			$(ref).closest(".tasklist").toggleClass("-collapsed");
			return;
		}
		
		$box.toggleClass("-collapsed");
		
		if (Client.pageData.project && Board.data.model){
			if ($box.hasClass("-collapsed")){
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype], 1)
			}else{
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype], 0)
			}	
		}
	};
	
	
	this.togglePending=function(id, ref){
		$box=$(ref).closest(".prev-area");
		$box.toggleClass("-collapsed");
		
		if (Client.pageData.project && Board.data.model){
			if ($box.hasClass("-collapsed")){
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype, "pending"], 1)
			}else{
				Base.pref().set([Client.pageData.project.id, id, Board.data.model.metatype, "pending"], 0)
			}	
		}
	};
	
	
	this.showPerson = function (person) {
		var project = Client.pageData.project;

		Project.display.side(project);
		UI.pageCountdown("#tasklists .countdown", true);
		AP.on("new-task", function (task, log, origin) {
			Project.tasklist.update(origin, task, 'new-task');
		});
		UI.progression(project, "#project-main-graph", {title: false});

		var tasks = Client.pageData.user_tasks;

		$("#user-tasks").html(AP.render(tasks, Todo.html));
		Todo.daySeparation("#tasklist-tasks", function (time){
			
		});
	};
	
	
	
	function getPersonHTML(e){
		var info="Member since "+UI.simpleTime(e.since);
		var person=People.get(e.username);
		
		return "<div class='li -icon-left unselectable url' onclick=\"Project.showPerson('"+e.username+"');\">" +
			"	<div class='inner'>" +
				"	<span class='icon'><span class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></span></span>" +
				"	<div class='text ap-xdot'>" +
				"		<div class='name'>"+person.name+"</div>" +
				"		<b>@"+person.username+"</b>" +
				"		<div class='info text-9'>"+person.title+"</div>" +
				"	</div>" +
			"	</div>" +
			"</div>";
	};
	
};


Board.list.group=new function __BoardListGroup(){
	this.get = function(g){
		// Default tasklist (no ID)
		if (!g.id){
			return "<div class='tasklist js-group -sf' data-id='"+(g.id)+"' id='tasklist-0'> "+(getGroup(g))+" "+(getInlineForm(g))+" <div class='js-tasklist-tasks'>"+(List.ui.getGroup(g))+"</div> </div>";
		}
		
		return "<div class='tasklist js-tasklist js-group cs-"+(TaskList.isClosed(g))+"' data-id='"+(g.id)+"' id='tasklist-"+(g.id)+"'> "+(getGroup(g))+" "+(getInlineForm(g))+" <div class='js-tasklist-tasks'>"+(List.ui.getGroup(g))+"</div> </div>";
	};
	
	
	this.update=function(tasklist){
		if ($("#js-list-marker").length){
			return;
		}
		
		$('#tasklist-' + tasklist.id + " .js-tasklist-tasks").html(getTasksInList(tasklist));
	};
	
	
	this.updateStats=function(){
		$("#tasklists .js-group").each(function(){
			var total=$(this).find(".li.js-task").length;
			var done=$(this).find(".li.js-task.-done").length;
			
			if (total>0){
				$(this).find(".group-header .istats").html("<em>"+(done)+"</em>/"+(total)+"");	
			}
		});
	};
	
	
	
	function getGroup(group){
		var metatype=Board.data.model.metatype;
		
		var name='';
		var info='';
		var actions='';
		var review_flag="";
		
		if (metatype=='tasklist'){
			if (Project.isManager()){
				var ab=Project.option.tasklist(group);
				if (ab.length()){
					actions="<div class='more -cmenuw'> <div class='-cmenu -padding -no-icon'>"+(ab.inline())+"</div> </div>";	
				}
			}
			
			if (group.review && parseInt(group.review.enabled)){
				var exp=explain("This tasklist required review<br>Reviewed by: @"+(group.review.users[0])+"", {icon: false});
				review_flag="<span class='-infow review-flag'>&#10026;"+(exp)+"</span>";
			}
			
			var desc=" &nbsp;&mdash;&nbsp; "+(safe(group.content))+"";
			if (!group.content || !group.content.length){
				desc='';
			}
			
			name="<div class='name ap-xdot'> <span class='url' title='"+(group.name)+" - Id: "+(group.id)+"' id='task-list-name-"+(group.id)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> <span class='desc' title='"+(desc)+"'>"+(desc)+"</span> </div>";
			
			info=""+(actions)+"";
		}
		
		if (metatype=='milestone'){
			if (Project.isManager()){
				var ab=Project.option.milestone(group);
				actions="<div class='more -cmenuw'> <div class='-cmenu -padding -no-icon'>"+(ab.inline())+"</div> </div>";
			}
			
			if (group.id){
				var u=People.get(group.user_id);
				
				name="<div class='name -ext ap-xdot'> <div class='ext-icon'> <div class='cal'>"+(AP.time.time('<em>%V</em><span>%d/%m</span>', group.time))+"</div> </div> <span class='url' title='"+(group.name)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> <div class='info ap-xdot'><em>"+(AP.time.time('%V, %d/%m',group.time))+"</em> &mdash; "+(u.name)+" &mdash; "+(u.title)+"</div> </div>";
				
				info=""+(actions)+"";	
			}else{
				name="<div class='name ap-xdot'> <span class='url' title='"+(group.name)+"' id='task-list-name-"+(group.id)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> </div>";
			}
			
		}
		
		
		if (metatype=='user'){
			if (group.id && group.gavatar){
				name="<div class='name -ext ap-xdot'> <div class='ext-icon'> <div class='avatar'><img src='"+(AP.xthumb(group.gavatar))+"'/></div> </div> <span class='url' title='"+(group.name)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> <div class='info ap-xdot'>"+(group.title)+"</div> </div>";
				
			}else{
				name="<div class='name ap-xdot'> <span class='url' title='"+(group.name)+"' id='task-list-name-"+(group.id)+"' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'>"+(group.name)+"</span> </div>";
			}
			
		}
		
		
		return "<div class='group-header -"+(metatype)+"' data-metatype='"+(metatype)+"'> <div class='-collapsed-mask url' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'></div> <div class='collapse url' data-url='paction/0/tasklist.toggle' data-id='"+(group.id)+"'><span class='ficon-caret-right'></span></div> <div class='title'> "+(name)+" <div class='right'>"+(info)+""+(getCreateLink(group))+""+(review_flag)+"<span class='istats'></span></div> </div> </div>";
	};


	
	function getCreateLink(group) {
		if (!Client.pageData.context || !parseInt(Client.pageData.context.acl.task_create)){
			return "";
		}
		
		var id=group.id;
		if (Board.data.model.metatype=="user" && group.uid){
			id=group.username;
		}
		
		return "<div class='group-cta url unselectable' data-url='groupaction/"+(Board.data.model.metatype)+"/"+(id)+"/taskinlinecreate'><div class='text js-add-task'>ThĂªm cĂ´ng viá»‡c</div></div>";
	};
	
	
	
	function getInlineForm(group){
		if (!Client.pageData.context || !parseInt(Client.pageData.context.acl.task_create)){
			return "";
		}
		
		var iform=Task.form.getForm({tasklist: group, context: Client.pageData.context});
		
		return "<div class='bform-wrapper js-form-wrap' id='js-taskiform-"+(group.id)+"' data-id='"+(group.id)+"' data-metatype='"+(Board.data.model.metatype)+"'> <div class='fcta'><div class='text js-add-task'>ThĂªm cĂ´ng viá»‡c má»›i</div></div> <div class='aform tasklist-"+(group.id)+"' id='txadd-"+(group.id)+"'>"+(iform)+"</div> </div>";

	};
	
	
};


List.ui = new function __BoardUI() {

	this.getHTML = function(task, opts) {

		return this.renderItem(task, opts);
	};

	
	this.getSingleHTML = function(task, opts) {

		return getInternalHTML(task, opts);
	};
	
	
	this.getGroup = function(group) {

		if (Client.pageData.task_view == "period") {
			return getPeriod(group);
		}
		
		if (Board.data.model.grouped != 1) {
			return "<div class='js-list-section list tasks -all'>"+(getTasksHTML(group.tasks))+"</div>";
		} else {

			var active = getTasksHTML(group.tasks, function(e) {
				return parseInt(e.status) != 1;
			});
			
			var done = getTasksHTML(group.tasks, function(e) {
				return parseInt(e.status) == 1;
			});
			
			return "<div class='js-list-section -normal list tasks'>"+(active)+"</div> <div class='js-list-section -done list tasks'>"+(done)+"</div>";
		}
	};
	
	
	/**
	 * @desc Getting a period with a list of tasks
	 */
	function getPeriod(group) {

		var count = AP.array.count(group.tasks, function(e) {
			return !parseInt(e.status) && !Task.cs.current(e); 
		});
		
		if (count) {
			count = "(<b>"+(count)+"</b>)&nbsp;";
		} else {
			count = '';
		}
		
		var prev_title = "<div class='prev-title url pending-tasks' onclick='Board.list.togglePending("+(group.id)+", this);'>"+(count)+"CĂ´ng viá»‡c chÆ°a hoĂ n thĂ nh tá»« tg trÆ°á»›c</div>";
		var collapsed = '';
		
		if (Client.pageData.project && Base.pref().get([Client.pageData.project.id, group.id, Board.data.model.metatype, "pending"])) {
			collapsed = ' -collapsed';
		}
		
		if (Board.data.model.grouped != 1) {

			var current = getTasksHTML(group.tasks, function(e) {
				return Task.cs.current(e);
			});
			
			var prev = getTasksHTML(group.tasks, function(e) {
				return !parseInt(e.status) && !Task.cs.current(e);
			});
			
			return "<div class='js-list-section list tasks -all'>"+(current)+"</div> <div class='js-list-prev prev-area"+(collapsed)+"'> "+(prev_title)+" <div class='js-list-section list tasks -prev'>"+(prev)+"</div> </div>";
			
		} else {

			var active = getTasksHTML(group.tasks, function(e) {
				return Task.cs.current(e) && parseInt(e.status) != 1;
			});
			
			var done = getTasksHTML(group.tasks, function(e) {
				return Task.cs.current(e) && parseInt(e.status) == 1;
			});
			
			var prev = getTasksHTML(group.tasks, function(e) {
				return !Task.cs.current(e) && !parseInt(e.status);
			});
			
			return "<div class='js-list-section -normal list tasks'>"+(active)+"</div> <div class='js-list-section -done list tasks'>"+(done)+"</div> <div class='js-list-prev prev-area"+(collapsed)+"'> "+(prev_title)+" <div class='js-list-section list tasks -prev'>"+(prev)+"</div> </div>";
		}
	};
	
		
	function getTasksHTML(tasks, filter) {

		var html = "";
		for (var i = 0; i < tasks.length; i++) {

			if (!tasks[i].visible) {
				continue;
			}
			
			if (filter && !filter(tasks[i])) {
			} else {
				html += Board.ui.getHTML(tasks[i]);	
			}
		}
		
		return html;
	};
	
	
	this.renderItem = function(task) {

		var html = getInternalHTML(task);
		var view_options = AP.pageConfig.get("subtasks");
		var subtasks = "";
		
		if (Client.pageData.task_view == "period" || Client.pageData.task_view == "stream") {
			if (Query.get("subtask") == "hide" && task.metatype == "subtask") {
				return '';
			} else {
				view_options = 'natural';
			}
		}
		
		if (view_options == "nested") {

			subtasks = AP.render(task.subtasks, function(e) {
				return List.ui.renderItem(e);
			});
			
			subtasks = "<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(subtasks)+"</div>";
		} else if (view_options == "natural") {

			if (Client.pageData.project && Client.pageData.project.metatype == "project") {
				if (task.metatype == "task" && task.subtasks && task.subtasks.length) {
					subtasks = AP.render(task.subtasks, function(e) {
						return Board.ui.renderItem(e);
					});
					
					subtasks = "<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(subtasks)+"</div>";
				} else if (task.metatype == "task") {
					subtasks = "<div class='js-subtasks subtasks-wrapper no-subtasks'></div>";
				}
			} else {

				if (Client.pageData.project && task.subtasks) {

					subtasks = AP.render(task.subtasks, function(e) {
						return List.ui.renderItem(e);
					});
					
					var more = '';
					if (task.cached_subtasks && task.subtasks.length > task.cached_subtasks.length && task.metatype == "task") {
						more = "<div class='subtask-more url' data-url='task/"+(task.id)+"'>Hiá»ƒn thá»‹ thĂªm CV con</div>";
					}
					
					subtasks = "<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(subtasks)+"</div> "+(more)+"";
				} else {
					if (task.metatype == "task") {
						subtasks = "<div class='js-subtasks subtasks-wrapper js-subtasks-p"+(task.id)+"'>"+(Board.sublist.getCachedSubtasks(task))+"</div>";
					}
				}
			}
		}
		
		html = ""+(html)+""+(subtasks)+"";
		
		if (task.metatype == "task") {

			var sortable = Board.filter.sortEnabled() ? "<div class='sx'><span></span></div>" : '';
			var idx = "";
			
			if (Board.filter.sortEnabled()) {
				idx = "<div class='idx'></div>";
			}
			
			html = "<div class='task-wrapper js-task' data-metatype='"+(task.metatype)+"' data-keywords='"+(task.keywords)+"' data-id='"+(task.id)+"'> "+(sortable)+""+(idx)+""+(html)+" </div>";
		} else {
			html = ""+(html)+"";
		}
		
		return html;
	};

	
	function getInternalHTML(task) {

		var status_class = (parseInt(task.status) ? " -done" : " -xdone");
		if (Compute.doneLate(task)) {
			status_class += ' -late';
		}

		var tracking_task_check = '';
		if (!parseInt(task.status)) {
			tracking_task_check = "data-feature='wework:wework_task_check:task'";
		}
		
		var check = "<div class='check url' data-xurl='action/"+(task.id)+"/check' "+(tracking_task_check)+" data-status='"+(task.status)+"' data-acl='"+(task.acl.status)+"'> <div class='task-status "+(status_class)+"'></div> </div>";
		
		var ec = [];
		if (parseInt(task.status)) {
			ec.push("-done");
		}
		
		if (parseInt(task.acl.review_enabled) || parseInt(task.acl.review_subtask_enabled)) {
			ec.push("-review");
		}
		
		if (!parseInt(task.acl.status)) {
			ec.push("-locked");
		}
		
		var project = null;
		if (task.ns) {
			project = Project.fromContext(task.ns.id);
		}
		
		var icons = Task.ui.icons(task, project);
		var labels = Task.ui.labels(task, project);

		if (Compute.doneLate(task) || Compute.overdue(task)) {
			ec.push("-overdue");
		}

		if (Compute.dueToday(task)) {
			ec.push("-due-today");
		}
		
		var user = null;
		
		var assign = "<div class='assign -unassign url' data-xurl='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"'> <div class='avatar'> <div class='imagew'><div class='user-add'></div></div> </div> <div class='fname ap-xdot -empty'>Giao cho</div> </div>";

		if (task.metatype == "task") {

			user = People.get(task.username);
		
			if (task.username && user) {
				var first_name = user.error ? user.username : user.first_name;
				
				assign = "<div class='assign url -infow' data-xurl='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"'> <div class='avatar'> <div class='image imagew'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> </div> <div class='fname ap-xdot'>"+(first_name)+"</div> "+(explain(user.name + ' @ ' + user.username, true))+" </div>";
			} else if (!parseInt(task.acl.unassign)) {
				assign = "<div class='assign -unassign url'> <div class='avatar'><div class='imagew'><div class='lock ficon-lock'></div></div></div> <div class='fname ap-xdot -empty' title='ChÆ°a giao'>ChÆ°a giao</div> </div>";
			}
		} else {

			user = People.get(task.user_id);

			if (parseInt(task.user_id) && !user.error) {
				assign = "<div class='assign url -infow' data-xurl='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"'> <div class='avatar'> <div class='image imagew'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> </div> <div class='fname ap-xdot'>"+(user.first_name)+"</div> "+(explain(user.name + ' @ ' + user.username, true))+" </div>";
			} else if (!parseInt(task.acl.unassign)) {
				assign = "<div class='assign -unassign url'> <div class='avatar'><div class='imagew'><div class='lock ficon-lock'></div></div></div> <div class='fname ap-xdot -empty' title='ChÆ°a giao'>ChÆ°a giao</div> </div>";
			}
		}
		
		var star_icon = "<div class='icon star url' data-xurl='action/" + task.id + "/star' title='ÄĂ¡nh dáº¥u Æ°u tiĂªn'><span class='-ap icon-uniF186'></span></div>";

		if (UI.fav.isFav(task.id, Client.pageData.favs)) {
			star_icon = "<div class='icon star -star url' data-xurl='action/" + task.id + "/star' title='ÄĂ¡nh dáº¥u Æ°u tiĂªn'><span class='-ap icon-star-full'></span></div>";
			ec.push("-starred");
		}

		var tlabels = AP.render(labels, function(e) {
			if (e.url && e.url.length) {
				return "<span class='label " + e.style + " url' data-xurl='" + e.url + "'>" + e.name + "</span>";
			}
			
			return "<span class='label " + e.style + "' data-xurl='" + e.url + "'>" + e.name + "</span>";
		});
		
		var icons_html = AP.render(icons, function(e) {
			return "<span class='icon url -infow' data-xurl='"+(e.url)+"' data-acl='"+(e.acl)+"' data-value='"+(e.value)+"'> <span class='"+(e.icon)+"'></span> "+(explain(e.title, true))+" </span>";
		});
		
		var review_status = "";
		if (parseInt(task.acl.review_enabled) || parseInt(task.acl.review_subtask_enabled)) {
			review_status = getReviewStatus(task);
		}

		var real_title = "Táº¡o bá»Ÿi @"+(task.creator_username)+" lĂºc "+(AP.i18n.datetime(task.since))+" | Order: "+(task.real_order)+"";
		var content = ""+(Task.ui.getLocalLink(safe(task.content)))+" &middot; ";
		if (!task.content || !task.content.length) {
			content = "ChÆ°a cĂ³ miĂªu táº£ &middot; "
		}
		
		var infos = Task.ui.info(task, project);
		
		var subtask_icon = "";
		if (task.metatype == "subtask" || !task.metatype) {
			subtask_icon = "<div class='subtask-icon'></div>";
		}
		
		var html = "<div id='task-"+(task.id)+"' data-real_order='"+(task.real_order)+"' data-status='"+(task.status)+"' data-keywords='"+(task.keywords)+"' class='js-"+(task.metatype)+" li li-"+(task.id)+" -"+(Task.ui.grandState(task))+" "+(ec.join(' '))+"' data-id='"+(task.id)+"' data-user='"+(task.user_id)+"' data-username='"+(task.username)+"' data-deadline='"+(task.deadline)+"' data-starred='"+(task.starred)+"' data-complete='"+(task.complete)+"'> "+(subtask_icon)+" <div class='r'></div> <div class='rsep'></div> <div class='name'> <div class='ap-xdot url' data-url='task/"+(task.id)+"' data-feature='wework:wework_task_show:task'> <div class='mn'> <span class='url' data-url='task/"+(task.id)+"' data-feature='wework:wework_task_show:task' title='"+(real_title)+"'>"+(task.name)+"</span> "+(infos)+" </div> </div> </div> <div class='xedit'> <textarea name='name' type='text' placeholder='Sá»­a cĂ´ng viá»‡c'>"+(task.name)+"</textarea> <span class='cancel url' data-xurl='action/0/mask'>Há»§y</span> </div> "+(check)+" <div class='sicons'> "+(star_icon)+"</div> <div class='actions'>"+(icons_html)+"</div> <div class='timebox'> <div class='tx duration'>"+(Task.ui.grandDeadline(task))+"</div> </div> "+(assign)+" <div class='desc'> "+(review_status)+" <div class='content'> <div class='ap-xdot'> <div class='labels'>"+(tlabels)+"</div> <span class='inner'> "+(content)+" Táº¡o bá»Ÿi @"+(task.creator_username)+" </span> </div> </div> </div> <div class='keywords' style='display:none'>"+(getKeywords(task))+"</div> </div>";

		return html;
	};
	
	
	this.scrollTop = function() {

		$('#project-canvas .scrollin').animate({scrollTop: 0}, 200);
	};
	

	function getKeywords(item) {
		var kw = "";
		kw += "@" + item.username + " " + item.name;
		
		return kw;
	};
	
	
	function getReviewStatus(task) {

		if (task.metatype == "task") {

			if (parseInt(task.status)) {
				if (parseInt(task.acl.review) && task.metatype == "task") {
					return "<div class='review-status -done url' data-xurl='action/" + task.id + "/review' data-value='" + task.status + "'><span>HoĂ n thĂ nh</span></div>";
				} else {
					return "<div class='review-status -done'><span>HoĂ n thĂ nh</span></div>";
				}	
			}
			
			if (parseInt(task.review)) {
				if (parseInt(task.acl.review) && task.metatype == "task") {
					return "<div class='review-status -review -dx url' data-xurl='action/" + task.id + "/review' data-value='" + task.status + "'><span class='anim-showhide-inf'>ÄĂ¡nh giĂ¡</span></div>";
				}
				
				return "<div class='review-status -review'><span class='anim-showhide-inf'>ÄĂ¡nh giĂ¡</span></div>";
			}
			
			return "<div class='review-status'><span>Äang lĂ m</span></div>";
		} else if (task.metatype == "subtask") {

			if (parseInt(task.status)) {
				return "<div class='review-status -done'><span>HoĂ n thĂ nh</span></div>";
			}
			
			if (parseInt(task.review)) {
				return "<div class='review-status -review'><span class='anim-showhide-inf'>ÄĂ¡nh giĂ¡</span></div>";
			}
			
			return "<div class='review-status'><span>Äang lĂ m</span></div>";
		} else {
			return "<div class='review-status'><span>Äang lĂ m</span></div>";
		}
	};
};


// FIX
Board.ui = List.ui;


Board.engine=new function __BoardEngine(){
	/**
	 * @desc Get all possible inline actions for tasks
	 */
	this.getActions=function(task){
		
	};
	
	
	/**
	 * @desc Init the context menu
	 */
	this.init=function(){
		return;
		
		$("#tasklists").on("contextmenu", function(e){
			if (e.ctrlKey || $("#js-inline-edit").is(":visible")){
				return true;
			}
			
			e.preventDefault();
			$("#js-main-table .tr").removeClass("focused");
			
			var row=$(e.target).closest(".js-task");
			var id=row.data("id");
			
			row.addClass("selected");
			var task=AP.array.findObj(Client.pageData.tasks, id);
			if (!task){
				return;
			}
			
			var u=People.get(task.user_id);
			var content=task.content;
			if (!content){
				content="ChÆ°a cĂ³ miĂªu táº£";
			}
			
			var image="<div class='image'> <img src='"+(AP.xthumb(u.gavatar))+"'/> </div>";
			
			if (!parseInt(task.user_id) || !parseInt(u.uid)){
				image="<div class='image -none'></div>";
			}
			
			var task_html="<div class='task-contextmenu'> "+(image)+" <div class='task-title ap-xdot url' data-url='task/"+(id)+"' data-feature='wework:wework_task_show:task'>"+(task.name)+"</div> <div class='task-info ap-xdot'>"+(safe(content))+"</div> </div>";
			
			var menu=[
				task_html,
				"---",
				{
					label: "Edit task info", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Set duration", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Edit deadline", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Edit start time", 
					icon: "ficon-pencil-square",
					url: "board/"+(row.data('id'))+"/gedit",
					data: {acl: 1}
				},
				{
					label: "Add a new subtask", 
					icon: "ficon-indent",
					url: "board/"+(row.data('id'))+"/subtask",
					data: {acl: 1}
				},
				"---",
				{
					label: "Show task", 
					icon: "ficon-external-link-square",
					url: "task/"+(row.data('id'))+""
				},
				{
					label: "Duplicate task ...", 
					icon: "ficon-copy",
					url: "board/"+(row.data('id'))+"/duplicate",
					data: {acl: 1}
				},
				{
					label: "Duplicate to another project ...", 
					icon: "ficon-copy",
					url: "board/"+(row.data('id'))+"/duplicate.external",
					data: {acl: 1}
				},
				"---",
				{
					label: "Clear task deadline", 
					icon: "ficon-exclamation-circle",
					url: "board/"+(row.data('id'))+"/delete-deadline",
					data: {acl: 1}
				},
				{
					label: "Clear task starting time", 
					icon: "ficon-exclamation-circle",
					url: "board/"+(row.data('id'))+"/delete-startime",
					data: {acl: 1}
				},
				{
					label: "Remove task", 
					icon: "icon-uniF11F",
					url: "action/"+(row.data('id'))+"/remove",
					data: {acl: 1},
					css: "red"
				},
			];
			
			var top=e.pageY+8;
			var left=e.pageX;
			
			return Context.menu({x: left, y: top, type: "click"}, {menu: menu, layout:'compact', close: function(){
				$("#js-main-table .tr").removeClass("focused");
			}});
		});
	};
};


Board.sublist=new function __BoardSublist(){
	this.getCachedSubtasks=function(task){
		if (!task.cached_subtasks){
			return "";
		}
		
		if (AP.pageConfig.get("hide_all_subtasks") || AP.pageConfig.get("team_subtasks")==-1){
			return "";
		}
		
		var html="";
		for (var i=0; i<task.cached_subtasks.length; i++){
			task.cached_subtasks[i].acl={status: getStatus(task.cached_subtasks[i])};
			html+= List.ui.getHTML(task.cached_subtasks[i]);	
		}
		
		return "<div class='sublist'>"+(html)+"</div>";
	};
	
	
	this.update=function(task){
		$(".sublist #task-"+task.id).replaceWith(List.ui.getHTML(task));
	};
	
	function getStatus(task){
		if (task.user_id==Client.viewer.id || task.creator_id==Client.viewer.id){
			return 1;
		}
		
		if (Client.pageData.project && Project.isManager()){
			return 1;
		}
		
		return 0;
	};
};



Board.kb=new function __BoardKB(){
	this.mode="default";
	
	this.build=function(canvas){
		$(canvas).empty().html("<div class='stages clear-fix'></div>");
		var id=AP.uuid();
		var ew=0;
		
		if (Board.data.model.metatype=="tasklist" || Project.isManager()){
			ew=300;
		}
		
		
		var w=Board.data.model.groups.length*280+ew;
		if (w<$(window).width()){
			w=$(window).width();
		}
		
		$(canvas).find(".stages").attr("id", id).css("width", w);
		buildBoard(canvas);
		
		setHeight(canvas);
		AP.html.resize(function(){
			setHeight(canvas);	
		});
		
		$("#project-master").addClass("pboard");
		initBackground();
		
		$("#main-board").click(function(e){
			Board.clean("#main-board", e.target);
		});
		
		Board.kb.group.updateStats();
		
		if (!mobile()){
			$("#main-board").after(getStats());	
		}
		
		if (Client.pageData.project.metatype=="team"){
			initContinuousLoading();
		}
		
		$("#main-board").on("scroll", function(){
			var h=$(this).scrollTop();
			$(this).find(".stage .header").css({top: h+"px"});
			
			if (h>10){
				$(this).find(".stage .header").addClass("scrolled");
			}else{
				$(this).find(".stage .header").removeClass("scrolled");
			}
		});
	};
	
	
	this.refresh=function(){
		$("#main-board .stages").empty();
		buildBoard("#main-board");
		Board.kb.group.updateStats();
		Board.dnd();
	};
	
	
	this.taskUpdated=function(task){
		$("#js-task-"+task.id).replaceWith(getTask(task));
		Board.kb.group.updateStats();
		Board.updateEvents(task);
	};
	

	this.taskInserted=function(task){
		$("#main-board .js-stage-"+task.tasklist_id+" .items").prepend(getTask(task));
		Board.kb.group.updateStats();
	};
	
	
	function setHeight(canvas){
		var max=$(canvas).height()-100;
		$("#main-board .stages .stage").each(function(){
			var h=$(this).height();
			if (h>max){
				max=h;
			}
		});
		
		$(canvas).find(".stage").css("height", max);
	};
	
	
	function buildBoard(canvas){
		for (var i=0; i<Board.data.model.groups.length; i++){
			addStage(canvas, Board.data.model.groups[i]);
		}
		
		
		addCreatingStage(canvas);
	};
	
	function addStage(canvas, group){
		var tasklist_closed = '';
		var metatype=Board.data.model.metatype;
		
		if (metatype == 'tasklist'){
			var start=AP.time.now();
			var end=AP.time.now();
			var tasklist_closed = "cs-" + TaskList.isClosed(group, start, end);
		}	

		
		var stage_html="<div class='stage js-bucket "+(tasklist_closed)+" js-tasklist js-stage-"+(group.id)+"' id='js-stage-"+(group.id)+"' data-id='"+(group.id)+"' data-metatype='"+(metatype)+"'> <div class='r'></div> "+(getHeader(group))+" <div class='body'> <div class='wrap-in'> <div class='create-form'> <div id='js-create-form-"+(group.id)+"'></div> </div> <div class='items js-set'>"+(getTasks(group.tasks))+"</div> </div> </div> </div>";
		
		$(canvas).find(".stages").append(stage_html);
		
		if (parseInt(Client.pageData.project.acl.task_create)){
			buildInlineForm(group);	
		}
		
	};
	
	
	function addCreatingStage(canvas){
		if (Board.data.model.metatype=="tasklist"){
			var html="<div class='stage'> <div class='header' onclick='TaskList.create();'> <div class='name -add' title='Create tasklist'> <div class='gicon'><span class='-ap icon-plus2'></span></div> ThĂªm tasklist má»›i </div> <div class='bar'></div> <div> </div>";
			
			$(canvas).find(".stages").append(html);
		}
		
		
		if (Board.data.model.metatype=="milestone" && Project.isManager()){
			var html="<div class='stage'> <div class='header' onclick='Milestone.create();'> <div class='name -add' title='Táº¡o má»¥c tiĂªu'> <div class='gicon'><span class='-ap icon-plus2'></span></div> ThĂªm má»¥c tiĂªu má»›i </div> <div class='bar'></div> <div> </div>";
			
			$(canvas).find(".stages").append(html);
		}
		
		
		if (Board.data.model.metatype=="user" && Project.isManager()){
			var html="<div class='stage'> <div class='header' onclick='Project.people.add();'> <div class='name -add' title='Add members'> <div class='gicon'><span class='-ap icon-plus2'></span></div> ThĂªm thĂ nh viĂªn má»›i </div> <div class='bar'></div> <div> </div>";
			
			$(canvas).find(".stages").append(html);
		}
	};
	
	
	function getHeader(group){		
		return Board.kb.group.getHTML(group);
	};
	
	
	function getTasks(items){
		if (Board.data.model.grouped==1){
			var active= AP.render(items, function(e){
				if (parseInt(e.status)){
					return "";
				}
				
				return getTask(e);
			});
			
			var done= AP.render(items, function(e){
				if (!parseInt(e.status)){
					return "";
				}
				
				return getTask(e);
			});
			
			if (done.length){
				done="<div class='label-sep'><span>CĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh</span></div>" + done;
			}
			
			return active + done;
		}else{
			return AP.render(items, function(e){
				return getTask(e);
			});
		}
	};
	
	
	function getTask(task){
		if (!task.visible || task.metatype!="task"){
			return "";
		}
		
		return "<div class='item js-task -status-"+(task.status)+"' id='js-task-"+(task.id)+"' data-id='"+(task.id)+"' data-sid='"+(task.tasklist_id)+"' data-keywords='"+(task.keywords)+"'> "+(getTaskInner(task))+" </div>";
	};
	
	
	function getTaskInner(item){
		var u=People.get(item.username);
		
		var assign="<div class='assign -unassign relative url' data-xurl='action/"+item.id+"/assign' data-acl='"+item.acl.assign+"' data-view='board'>"+
		"	<div class='avatar'><span class='user-add'></span></div>" +
		"	<div class='deadline ap-xdot'><span class='none'>Giao cho</span></div>" +
		"</div>";
		
		if (!parseInt(item.acl.assign)){
			assign="<div class='assign -unassign relative url' data-xurl='action/"+item.id+"/assign' data-acl='"+item.acl.assign+"' data-view='board'>"+
			"	<div class='avatar'><span class='c'><span class='lock ficon-lock'></span></span></div>" +
			"	<div class='deadline ap-xdot'><span class='none'>ChÆ°a giao</span></div>" +
			"</div>";
		}
		
		if (u && item.username){

			var first_name = u.error ? u.username : u.first_name;

			assign="<div class='assign relative url' data-xurl='action/1/assign' data-acl='"+item.acl.acl+"' data-view='board'>"+
			"	<div class='avatar'><img src='"+AP.xthumb(u.gavatar)+"'/></div>" +
			"	<div class='deadline ap-xdot' title='"+first_name+"'><span class='none'>"+first_name+"</span></div>" +
			"</div>";
		}
		
		
		var icons=[];
		
		if (parseInt(item.deadline)){
			icons.push({icon: "-ap icon-uniF10B", text: AP.time.time("%d/%m/%Y", item.deadline), url:"action/"+item.id+"/deadline", acl: item.acl.time})
		}else{
			if (parseInt(item.acl.time)){
				// icons.push({icon: "-ap icon-uniF10B", url:"action/"+item.id+"/deadline", acl: item.acl.time})	
			}
		}
		
		if (parseInt(item.urgent)){
			icons.push({icon: "ficon-exclamation-circle text-alt8", url:"action/"+item.id+"/urgent", acl: item.acl.desc})
		}
		
//		if (Task.fav.isFav(item.id)){
//			icons.push({icon: "-ap icon-star-full hl", url:"action/"+item.id+"/star"});
//		}else{
//			icons.push({icon: "-ap icon-star-empty", url:"action/"+item.id+"/star"});
//		}

		var review_class = '';
		var review_title = '';
		if (item.review == 1 && item.status == 0){
			// var review_class = 'review anim-showhide-inf';
			var review_title = "title='CĂ´ng viá»‡c Ä‘ang chá» Ä‘Æ°á»£c Ä‘Ă¡nh giĂ¡ bá»Ÿi ngÆ°á»i giĂ¡m sĂ¡t'";
			icons.push({icon: "ficon-pause-circle anim-showhide-inf text-alt6", url:""})
		}

		var overdue_class = '';
		if (parseInt(item.overdue)){
			var overdue_class = 'kanban-overdue';
		}
		
		var tags_html="";
		var icons_html=AP.render(icons, function(e){
			if (e.text){
				return "<span class='icon url' data-view='board' data-xurl='"+e.url+"' data-acl='"+e.acl+"'><span class='"+e.icon+"'></span><span class='txt "+overdue_class+"'>&nbsp; "+e.text+"</span></span>";
			}else{
				return "<span class='icon url' data-view='board' data-xurl='"+e.url+"' data-acl='"+e.acl+"'><span class='"+e.icon+"'></span></span>";	
			}
		});
		
		
		if (item.__compute.files){
			icons_html="<span class='icon url' data-url='task/"+item.id+"' title='Attachments'><span class='-ap icon-uniF10A'></span><span class='txt'>"+item.__compute.files+"</span></span> "+icons_html;
		}
		
		if (item.__compute.checklists){
			icons_html="<span class='icon url' data-url='task/"+item.id+"' title='Checklists'><span class='-ap icon-uniF10E'></span> <span class='txt'>"+item.__compute.checklists+"</span></span> "+icons_html;
		}
		
		var tags=Project.taglist.parse(item.tags, Client.pageData.context);
		tags_html=AP.render(tags, function(e){
			return "<div class='tag url -bg-alt"+e.color+"-edge' data-xurl='action/filter/"+e.name+"' title='"+e.name+"'><span>"+e.name+"</span></div>";
		});
		
		
		if (tags.length){
			var list_tags = AP.array.select(tags, function(e){
				return e.name;
			});

			tags_html="<div class='tags clear-fix -collapsed url' data-view='board' data-value='"+list_tags.join(",")+"' title='"+list_tags.join(",")+"'>" + tags_html+"</div>";
		}
		
		var check="<div class='cb url "+(parseInt(item.status)?"-done":"")+"' data-status='"+item.status+"' data-xurl='action/"+item.id+"/check' data-acl='"+item.acl.status+"'><div class='task-status'></div></div>";
		
		if (Client.pageData.context && Client.pageData.context.template=="staging"){
			check="";
		}
		
		
		var cover_html="";
		if (item.cover){
			var src = item.cover.link;
			cover_html="<div class='cover url' data-url=':zoom' data-image='"+src+"'><div class='bound'><img src='"+src+"'/></div></div>";
		}

		var desc="<div class='desc'><div class='dr'></div> <div class='ap-xdot'>"+(item.content_short)+"</div> </div>";
		if (!item.content_short || !item.content_short.length){
			desc='';
		}
		
		return "<div class='item-cover'>"+(cover_html)+" "+(tags_html)+"</div> <div class='item-body relative'> "+(check)+" <div class='w url' "+(review_title)+" data-xurl='task/"+(item.id)+"' data-feature='wework:wework_task_show:task'></div> <div class='name "+(review_class)+"'>"+(item.name)+"</div> "+(desc)+" <div class='info'> "+(assign)+" <div class='icons'>"+(icons_html)+"</div> </div> </div>";
	};
	
	
	
	function updateCounter(){
		$("#main-board .stage").each(function(){
			$(this).find(".header .count").html($(this).find(".item").length);
		});
	};
	

	function buildInlineForm(group){
		var options={};
		options.group=group;
		options.project=Client.pageData.project;
		return Project.tform.buildInlineForm(options);
	};
	
	
	function getTasklistIDs(){
		var ids=[];
		$("#main-board .stages .stage").each(function(){
			var sid=$(this).data("sid");
			if (parseInt(sid)){
				ids.push(sid);
			}
		});
		
		return ids;
	};
	
	
	
	function getStats(){
		var total=0, done=0, review=0, overdue=0;
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			var e=Client.pageData.tasks[i];
			total++;
			if (parseInt(e.overdue)){
				overdue++;
			}
			
			
			if (parseInt(e.status)){
				done++;
			}else if (parseInt(e.review)){
				review++;
			}
			
		}
		
		return "<div id='board-stats'><div class='items'>" +
			"<div class='item'><div class='s -bg-main'></div> <em>"+total+"</em> CĂ´ng viá»‡c</div>  " +
			"<div class='item'><div class='s -bg-alt4'></div> <em>"+done+"</em> HoĂ n thĂ nh</div> " +
			"<div class='item'><div class='s -bg-alt6'></div> <em>"+review+"</em> chá» review</div> " +
			"<div class='item'><div class='s -bg-alt8'></div> <em>"+overdue+"</em> QuĂ¡ háº¡n</div>" +
		"</div></div>";
	};
	
	
	
	this.page=0;
	this.onLoadingMore=false;
	
	/**
	 * @desc Init continuous loading of board view
	 */
	function initContinuousLoading(){
		Board.kb.page=1;
		Board.kb.onLoadingMore=false;
		
		$("#main-board").on("scroll", function(){
			var top=$(this).scrollTop();
			var h=$(this).innerHeight();
			var diff=top+h-$(this)[0].scrollHeight;
			
			if (diff>=0 && !Board.kb.onLoadingMore && Client.pageData.tasks.length == 300){
				Board.kb.onLoadingMore=true;
				Board.kb.page++;
				
				var params=Query.release();
				params.page=Board.kb.page;
				params.project_id=Client.pageData.project.id;
				params.view="board";
				
				UI.ajaxShow();
				AP.post("api/project/more.tasks", params, function(code){
					UI.ajaxHide();
					
					if (!code.good()){
						$.log("ERROR");
						return;
					}
					
					if (!code.tasks.length){
					}else{
						setTimeout(function(){
							Board.kb.onLoadingMore=false;
						}, 2000);
					}
					
					Board.data.insertList(code.tasks);
					Board.kb.refresh();
				});
			}
		});
	}
	
	
	
	function initBackground(){
		if (mobile()){
			return;
		}
		
		var index=(parseInt(Client.pageData.context.id)%3)+1;
		var default_bg=Client.image_url+'/bg/'+index+'.jpg';
		if (!Client.pageData.context || !Client.pageData.context.bg){
			return;
		}
		
		var type=Client.pageData.context.bg.type;
		
		var opt=parseFloat(Client.pageData.context.bg.mask);
		if (!opt || opt<0 || opt>100){
			opt=50;
		}
		
		var mask="<div class='wbg-mask' style='opacity: "+(opt/100)+"; filter: alpha(opacity="+(opt)+");'></div>";
		
		if (type=="image"){
			var url=Client.pageData.context.bg.url;
			$("#project-master").addClass("wbg");
			$("#header").addClass("wbg");
			$("#document").addClass("wbg").prepend("<div id='background' class='bg'><div class='fbg' style='background-image: url("+url+"); background-size: cover;'></div>"+mask+"</div>");
			
			var br=(parseInt(Client.pageData.context.bg.blurry)*13/60);
			
			$("#document .fbg").css({"-webkit-filter": "blur("+br+"px)", "filter": "blur("+br+"px)"});
			
		}else if (type=="dark"){
			$("#project-master").addClass("wbg");
			$("#header").addClass("wbg");
			$("#document").addClass("wbg").prepend("<div id='background' class='bg'><div class='fbg' style='background-image: url("+default_bg+"); background-size: cover;'></div>"+mask+"</div>");
		}else if (type=="default" || type=="color"){
			$("#project-master").addClass("wbg").prepend("<div id='background' class='stdfill'><div class='fill'></div>"+mask+"</div>");
			$("#header").addClass("wbg");
		}
	};
	
};


Board.kb.group=new function __BoardKBGroup(){
	this.getHTML=function(group){
		var metatype=Board.data.model.metatype;
		var actions='';
		var ec='';
		
		if (metatype=="tasklist"){
			if (Project.isManager() && group.id){
				ec=' -dd';
				actions="<div class='actions -cmenuw'> <div class='-cmenu -no-icon -padding'>"+(Project.option.tasklist(group).inline())+"</div> </div>";
			}
			
			return "<div class='header "+(ec)+"'> <div class='name ap-xdot' title='"+(group.name)+" - Id: "+(group.id)+"'> <div class='gicon'><span class='-ap icon-list-unordered'></span></div> "+(group.name)+" </div> <div class='count'></div> <div class='bar'><div class='c'></div></div> "+(actions)+" </div>";	
		}
		
		if (metatype=="milestone"){
			if (Project.isManager() && group.id){
				ec=' -dd';
				actions="<div class='actions -cmenuw'> <div class='-cmenu -no-icon -padding'>"+(Project.option.milestone(group).inline())+"</div> </div>";
			}
			
			var name="["+(AP.time.time('%d/%m',group.time))+"] <span class='sub'>"+(group.name)+"</span>";
			if (!group.id || !group.time){
				name=group.name;
			}
			
			return "<div class='header "+(ec)+"'> <div class='name ap-xdot' title='"+(group.name)+"'> <div class='gicon'><span class='icon-base-calendar'></span></div> "+(name)+" </div> <div class='count'></div> <div class='bar'><div class='c'></div></div> "+(actions)+" </div>";	
		}
		
		
		if (metatype=="user"){
			var img="<img src='"+(AP.xthumb(group.gavatar))+"'>";
			var user="<span class='url' data-username='"+(group.username)+"'>"+(group.name)+"</span>";
			
			if (!group.id || typeof group.error != 'undefined'){
				img='';
				user=""+(group.name)+"";
			}
			
			return "<div class='header'> <div class='name -cmenuw' title='"+(group.name)+"'> <div class='gicon'><div class='gimg'>"+(img)+"</div></div> "+(user)+" </div> <div class='count'></div> <div class='bar'><div class='c'></div></div> </div>";	
		}
	};
	
	
	this.updateStats=function(){
		$("#main-board .stages .stage").each(function(){
			var total=$(this).find(".item.js-task").length;
			var done=$(this).find(".item.js-task.-status-1").length;
			
			$(this).find(".header .count").html(""+(done)+"/"+(total)+"");
			var percent=0;
			if (total>0){
				percent=done*100/total;
			}
			
			$(this).find(".header .bar .c").css("width", percent+"%").attr("title", percent.toFixed(2)+"% completed");
		});
	};
	
};







Board.table = new function __BoardTable() {
	this.display = function () {
		Board.mode = "table";

		initCanvas();
		initFooter();

		this.cell = { width: 18, height: 29 };
		var model = Board.data.model;


		this.width = 1200 + getTotalWidth();
		this.height = 50 + getTotalHeight(30);

		if (this.height < $(window).height() - 80) {
			this.height = $(window).height() - 80;
		}

		this.summary = Project.summary.basic();

		var context = Client.pageData.context;
		var header = getCols(context);
		var body = '';

		$("#js-main-table").css("min-height", 1000);
		$("#js-gantt-table").css("min-height", 1000);

		for (var i = 0; i < model.groups.length; i++) {
			body += Board.table.group.getHTML(model.groups[i]);
			body += "<div class='js-group-wrapper' data-id='"+(model.groups[i].id)+"' data-metatype='"+(model.metatype)+"'>";

			var tasks = model.groups[i].tasks;
			for (j = 0; j < tasks.length; j++) {
				if (parseInt(tasks[j].visible)) {
					body += getTaskHTML(tasks[j], j + 1);
				}
			}

			body += '</div>';
		}

		$("#js-main-table .table").html("<div class='thead'>"+(header)+"</div> <div class='tbody'>"+(body)+"</div>");

		this.sdate = this.summary.gantt_start;
		this.edate = this.summary.gantt_end;
		this.range = Math.floor((this.edate - this.sdate) / (24 * 3600));

		var view = Base.pref().get(["gantt_gview", Client.pageData.project.id]);
		if (!view) {
			view = "gantt";
		}

		if (view == "gantt") {
			$("#board-table .section.gantt-table").show();
			Board.gantt.init();
		} else {
			$("#board-table .section.custom-table").show();
			Board.ctable.init();
		}

		initScroller();

		$("#board-table").click(function (e) {
			Board.clean("#board-table", e.target);
		});

		BaseTable.init("#js-main-table .table", {
			height: "auto",
			width: "auto",
			layout: "list",
			events: false
		});

		Board.dnd();

		var start_month = AP.time.time("%m/%Y", Board.table.summary.gantt_start);
		var end_month = AP.time.time("%m/%Y", Board.table.summary.gantt_end - 24 * 3600);
		$("#board-table-footer").find(".js-cur").html(start_month + " - " + end_month);
	};



	this.taskUpdated = function (task) {
		if (!Client.pageData.context) {
			return;
		}

		$("#js-main-table .task-" + task.id).replaceWith(getSingleTaskHTML(task));
		BaseTable.update("#js-main-table .task-" + task.id);
		Board.gantt.taskUpdated(task);
		Board.ctable.taskUpdated(task);
	};


	this.showInlineForm = function (ref) {
	};


	/**
	 * @desc Get column
	 */
	function getCols(context) {
		var std_cols = "<div class='th' data-width='36'><div class='w'><span class='square'></span></div></div> <div class='th stroked' data-width='250'><div class='w'>CĂ´ng viá»‡c</div></div>";
		if (parseInt(context.acl.task_create)) {
			std_cols = "<div class='th' data-width='36'>&nbsp;</div> <div class='th stroked' data-width='250'><div class='w -add' onclick='Project.tform.dialog();'>ThĂªm cĂ´ng viá»‡c má»›i</div> </div>";
		}

		return "<div class='tr cols xo'> <div class='th' data-width='10' style='padding:0; border-right:none'></div> "+(std_cols)+" <div class='th' data-width='50'><div class='w ext-label'>Báº¯t Ä‘áº§u &rsaquo; Thá»i háº¡n</div></div> <div class='th' data-width='50'><div class='w'></div></div> <div class='th' data-width='50'><div class='w ext-label'>HoĂ n thĂ nh</div></div> <div class='th' data-width='64'><div class='w'><div class='ap-xdot'></div></div></div> </div>";
	};


	/**
	 * @desc Add task
	 */
	function addTask(task, index) {
		if (task.acl.view && parseInt(task.acl.view) == 1) {
			$("#js-main-table table").append(getTaskHTML(task, index));
		}
	};


	function getTaskHTML(task, ancestor_id = 0) {
		var subtasks = AP.pageConfig.get("subtasks");

		if (task.metatype == "task") {
			ancestor_id = task.id;
		}

		return getSingleTaskHTML(task, ancestor_id) + AP.render(task.subtasks, function (e) {
			if (subtasks == "natural") {
				return getSingleTaskHTML(e, ancestor_id);
			}

			return getTaskHTML(e, ancestor_id);
		});
	};

	function getSingleTaskHTML(task, ancestor_id) {
		var level = getLevel(task);

		var context = Client.pageData.context;
		var is_active = (Query.getInt('task') !== 0 && Query.getInt('task') === parseInt(task.id)) ? "is-active" : "";

		var ec = [];
		if (parseInt(task.status)) {
			ec.push("-done");
		}

		var assign = "<div class='cu'><div class='avatar'><div class='image'><div class='user-add'></div></div></div> <div class='cu-name text-9'>Giao cho</div>";
		var u = People.get(task.username);
		if (u && u.id) {
			assign = "<div class='cu' title='" + u.name + " / " + u.title + "'><div class='image'><img src='" + AP.xthumb(u.gavatar) + "'/></div> <div class='cu-name ap-xdot'>" + u.first_name + "</div></div>";
		}

		var creator = "<span class='none'>Giao cho</span>";
		var u = People.get(task.creator_username);
		if (u && u.id) {
			creator = "<div class='cu' title='" + u.name + " / " + u.title + "'><div class='image'><img src='" + AP.xthumb(u.gavatar) + "'/></div> <div class='cu-name ap-xdot'>" + u.first_name + "</div></div>";
		}


		var urgent = "<span class='ddb'>BĂ¬nh thÆ°á»ng</span>";
		if (parseInt(task.urgent)) {
			urgent = "<span class='ddb -alert'>Kháº©n cáº¥p</span>";
		}

		var start_time = "<span class='text-a'>--</span>";
		var deadline = "<span class='text-a'>--</span>";
		var completed_time = "<span class='text-a'>--</span>";

		if (parseInt(task.start_time)) {
			start_time = AP.time.time("%d/%m", task.start_time);
		}

		if (parseInt(task.deadline)) {
			deadline = AP.time.time("%d/%m", task.deadline);
		}

		if (parseInt(task.completed_time)) {
			completed_time = AP.time.time("%d/%m", task.completed_time);
		}

		var tracking_task_check = '';
		if (!parseInt(task.status)) {
			tracking_task_check = "data-feature='wework:wework_task_check:task'";
		}

		var sort_handler = (task.metatype == 'task') ? "<div class='sbar'></div>" : '';
		var html = "<div class='tr task js-"+(task.metatype)+" "+(is_active)+" task-"+(task.id)+" ancestor-"+(ancestor_id)+" "+(ec.join(' '))+"' data-id='"+(task.id)+"' data-keywords='"+(task.keywords)+"' id='jsrow-"+(task.id)+"'> <div class='td'>"+(sort_handler)+"</div> <div class='td'> <div class='wrap'> <div class='cb url "+(parseInt(task.status) ? ' -done' : '')+" "+(parseInt(task.acl.status) ? ' -okay' : ' -locked')+"' "+(tracking_task_check)+" data-status='"+(task.status)+"' data-acl='"+(task.acl.status)+"' data-xurl='action/"+(task.id)+"/check'> <div class='task-status'></div> </div> </div> </div> <div class='td'> <div class='wrap'> <div class='std relative url' data-dburl='action/"+(task.id)+"/custom' data-url='task/"+(task.id)+"' data-feature='wework:wework_task_show:task' data-acl='"+(task.acl.name)+"' data-role='name' data-value='"+(task.name)+"' data-id='"+(task.id)+"' data-fid='name' title='"+(task.name)+"'> <div class='level level-"+(level)+"'><div class='ap-xdot'>"+(task.name)+"</div></div> </div> </div> </div> <div class='td'> <div class='wrap relative url -fit' data-url='action/"+(task.id)+"/starttime' data-acl='"+(task.acl.time)+"'> <div class='ap-xdot task-time'>"+(start_time)+"</div> </div> </div> <div class='td'> <div class='wrap relative url -fit' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'> <div class='ap-xdot task-time'>"+(deadline)+"</div> </div> </div> <div class='td'> <div class='wrap relative -locked -fit'> <div class='ap-xdot task-time'>"+(completed_time)+"</div> </div> </div> <div class='td'><div class='wrap'> "+(getCompletion(task))+" </div></div> </div>";

		return html;
	};


	function getLevel(task) {
		var level = 0;
		var p = task.parent;
		while (true) {
			if (!p) {
				break;
			}

			p = p.parent;
			level++;
		}

		return level;
	};




	function getWidth(field) {
		if (field.type == "textarea") {
			return 200;
		}

		if (field.type == "checkbox") {
			return 50;
		}

		if (field.type == "datetime") {
			return 120;
		}

		return 80;
	};

	function getTotalWidth() {
		var total = 0;
		for (var i = 0; i < Client.pageData.context.form.length; i++) {
			total += getWidth(Client.pageData.context.form[i]);
		};
		return total;
	};

	function getTotalHeight() {
		return Board.data.model.num_task_and_subtasks * 30 + Board.data.model.num_groups * 36;
	};


	function countTasks(tasks) {
		var total = tasks.length;
		for (var i = 0; i < tasks.length; i++) {
			total += countTasks(tasks[i].subtasks);
		}

		return total;
	};




	function inRange(ts, task) {
		if (parseInt(task.deadline)) {
			var deadline = parseInt(task.deadline);
			if (parseInt(task.start_time)) {
				var stime = parseInt(task.start_time);
				if (ts >= stime && ts <= deadline) {
					return true;
				}
			} else {
				if (ts >= deadline && ts - deadline < 24 * 3600) {
					return true;
				}
			}
		}

		return false;
	};



	function initFooter() {
		var tabs = "<div class='tabs'> <div class='tab' data-view='gantt'>Xem sÆ¡ Ä‘á»“ Gantt</div> <div class='tab' data-view='fields'>Xem trÆ°á»ng tĂ¹y chá»‰nh</div> </div>";

		var extra = '';
		var view = Base.pref().get(["gantt_gview", Client.pageData.project.id]);
		if (!view) {
			view = "gantt";
		}
		if (view == "gantt") {
			extra = "<div class='extra'> <span class='nav prev' onclick='Board.gantt.prev();'><span class='-ap icon-chevron-left22'></span></span> <span class='label js-cur'></span> <span class='nav next' onclick='Board.gantt.next();'><span class='-ap icon-chevron-right22'></span></span> </div>";
		}

		var html = tabs + extra;

		$("#board-table-footer").html(html);

		$("#board-table-footer .tab").click(function () {
			var view = $(this).data("view");
			Base.pref().set(["gantt_gview", Client.pageData.project.id], view);
			AP.xRefresh();
		}).each(function () {
			var view = Base.pref().get(["gantt_gview", Client.pageData.project.id]);
			if (!view) {
				view = "gantt";
			}

			if (view == $(this).data("view")) {
				$(this).addClass("active");
			} else {
				$(this).removeClass("active");
			}
		});
	};



	function initCanvas() {
		var html = "<div class='board-nav' id='js-board-nav'> <div class='nav-left'><div></div></div> <div class='nav-right'><div></div></div> <div class='clear'></div> </div> <div id='board-table' class='scroll-y forced-scroll'> <div class='section main-table'> <div class='wrapper' id='js-main-table'> <div class='table'></div> </div> </div> <div class='board-scroller'> <div class='section gantt-table hidden'> <div class='wrapper' id='js-gantt-table'> <div class='table'> <div class='table-top'><table></table></div> <div class='inner-grids'></div> <div class='todaymark'></div> <div class='truegrid'></div> </div> </div> </div> <div class='section custom-table hidden'> <div class='wrapper' id='js-custom-table'></div> </div> </div> </div>";

		$("#board-table-wrapper").html(html);
	};



	function initScroller() {
		$("#board-table").css("padding-bottom", $.sbWidth());

		$("#js-board-nav").css("height", $.sbWidth());
		$("#js-board-nav > div.nav-right > div").css("width", (19 * this.range));
		$("#board-table .section.gantt-table .table").css("width", 19 * this.range);

		var w1 = $("#board-table .board-scroller .custom-table .table.js-basetable").width();
		var w2 = $("#board-table .board-scroller .gantt-table .wrapper table").width();

		if (!w1) {
			w1 = 0;
		}

		if (!w2) {
			w2 = 0;
		}


		$("#js-board-nav .nav-right").scroll(function () {
			var left = $(this).scrollLeft();
			$("#board-table .section.gantt-table").css("margin-left", -left);
			$("#board-table .section.custom-table").css("margin-left", -left);
		});

		$("#js-board-nav .nav-right > div").width(Math.max(w1, w2));

		$("#board-table").on("scroll", function () {
			var t = $(this).scrollTop();
			if (t > 0) {
				$("#js-main-table .thead").css({ top: t + "px" });
				$("#js-custom-table .thead").css({ top: t + "px" });
				$("#js-gantt-table .table .table-top").css({ top: t + "px" });
			} else {
				$("#js-main-table .thead").css({ top: 0 });
				$("#js-custom-table .thead").css({ top: 0 });
				$("#js-gantt-table .table .table-top").css({ top: 0 });
			}
		})
	};


	function getCompletion(task) {
		var status = Task.ui.grandState(task);

		var complete = task.complete;
		var c = '';
		var txt = 'Todo';

		if (status == 'done') {
			c = '';
			txt = 'Done';
		}

		if (status == 'doing') {
			c = "<div class='c' style='width:"+(complete)+"%'></div>"
			txt = 'Doing';
			if (parseInt(Client.pageData.project.percent_completion)) {
				txt = ""+(parseFloat(task.complete).toFixed(2))+"%";
			}
		}

		if (status == 'review') {
			c = '';
			txt = 'Review';
		}

		return "<div class='complete-bar is-"+(status)+"'>"+(c)+"<span class='txt'>"+(txt)+"<span></div>";
	};

};


Board.ctable=new function __BoardCTable(){
	this.init=function(){
		var header=getHeader(Client.pageData.project);
		var body='';
		for (var i=0; i<Board.data.model.groups.length; i++){
			body+="<div class='tr group'> <div class='inner'></div> </div>";
			
			for (var j=0; j<Board.data.model.groups[i].tasks.length; j++){
				body+=getTaskHTML(Board.data.model.groups[i].tasks[j]);
			}
		}
		
		$("#js-custom-table").html("<div class='table'>"+(header)+"<div class='tbody'>"+(body)+"</div></div>");
		
		BaseTable.init("#js-custom-table .table", {
			height: "auto",
			width: "auto",
			layout: "list",
			events: false
		});
	};
	
	
	
	this.taskUpdated=function(task){
		$("#js-custom-table .js-task-"+task.id).replaceWith(getSingleTaskHTML(task));
		BaseTable.update("#js-custom-table .js-task-"+task.id);
	};
	
	
	
	function getHeader(context){
		var customs=AP.render(context.form, function(e){
			if (parseInt(e.enabled)) {
				return "<div class='th js-resizable' data-key='"+(e.id)+"' data-width="+(getWidth(e))+" title='"+(e.name)+"'> <div class='wrap'> <div class='ap-xdot'>"+(e.name)+"</div> </div> </div>";
			} else {
				return '';
			}
		});
		
		
		return "<div class='thead'> <div class='tr cols clear-fix'> <div data-width='120' class='th js-resizable' data-key='milestone'> <div class='wrap'><div class='ap-xdot'>Má»¥c tiĂªu</div></div> </div> <div data-width='110' class='th js-resizable' data-key='assignee'> <div class='wrap'><div class='ap-xdot'>Giao cho</div></div> </div> <div data-width='120' class='th js-resizable' data-key='tags'> <div class='wrap'><div class='ap-xdot'>NhĂ£n dĂ¡n</div></div> </div> "+(customs)+" <div data-width='120' class='th js-resizable' data-key='complete_time'> <div class='wrap'><div class='ap-xdot'>TG hoĂ n thĂ nh</div></div> </div> <div data-width='110' class='th js-resizable' data-key='created_by'> <div class='wrap'><div class='ap-xdot'>Táº¡o bá»Ÿi</div></div> </div> <div data-width='120' class='th js-resizable' data-key='created_at'> <div class='wrap'><div class='ap-xdot'>Táº¡o lĂºc</div></div> </div> <div data-width='120' class='th js-resizable' data-key='last_update'> <div class='wrap'><div class='ap-xdot'>Cáº­p nháº­t gáº§n nháº¥t</div></div> </div> </div> </div>";
	};
	
	
	function getTaskHTML(task, ancestor_id = 0) {
		if (!task.visible) {
			return '';
		}
		
		var subtasks = AP.pageConfig.get("subtasks");

		if (task.metatype == "task") {
			ancestor_id = task.id;
		}
		
		return getSingleTaskHTML(task, ancestor_id) + AP.render(task.subtasks, function(e) {
			if (subtasks == "natural") {
				return getSingleTaskHTML(e, ancestor_id);
			}
			
			return getTaskHTML(e, ancestor_id);
		});
	};
	
	
	/**
	 * @desc Rendering task HTML
	 */
	function getSingleTaskHTML(task, ancestor_id) {
		var context=Client.pageData.project;
		
		var custom=AP.render(context.form, function(e){
			if (parseInt(e.enabled)) {
				var dd='';
				if (e.type=='indicator' || e.type=='sindicator' || e.type=='select'){
					dd=' -dd';
				}
				
				return "<div class='td js-custom'> <div class='cell wrap js-custom-field pointer url -dx"+(task.acl.desc)+" "+(dd)+"' data-acl='"+(task.acl.desc)+"' data-url='action/"+(task.id)+"/fedit' data-fid='"+(e.id)+"' data-type='"+(e.type)+"' data-id='"+(task.id)+"'> "+(getCell(task, e))+" </div> </div>";
			} else {
				return '';
			}
		});

		var assign="<div class='user'> <div class='avatar'> <div class='image'><div class='user-add'></div></div> </div> <div class='user-name text-9'>Giao cho</div> </div>";
		
		var u=People.get(task.username);
		if (u && task.username){

			var first_name = u.error ? u.username : u.first_name;

			assign="<div class='user' title='"+(u.name)+" - "+(u.title)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='user-name ap-xdot'>"+(first_name)+"</div> </div>";
		}

		var creator="<span class='none'>Giao cho</span>";
		
		var u=People.get(task.creator_username);
		if (u && u.id){
			creator="<div class='user' title='"+(u.name)+" "+(u.title)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='user-name ap-xdot'>"+(u.first_name)+"</div> </div>";
		}


		var tags=Project.taglist.parse(task.tags);
		var tags_html="";

		if (tags.length){
			tags_html=AP.render(tags, function(e){
				return "<div class='itag'> <div class='iball -bg-alt"+(e.color)+"'></div> <div class='rtag relative'>"+(e.name)+"</div> </div>";
			});

			tags_html="<div class='itags ap-xdot'>"+(tags_html)+"</div>";
		}
		
		var finish = '';

		if (parseInt(task.overdue)){
		} else {
			if (parseInt(task.completed_time)){
				finish = AP.i18n.datetime(task.completed_time);
			} else {
				finish = "";
			}
		}

		
		var acl=parseInt(task.acl.status)+parseInt(task.acl.managed);
		if (acl){
			acl=1;
		}
		
		return "<div class='tr task js-task-"+(task.id)+" ancestor-"+(ancestor_id)+"' data-name='"+(task.name)+"' data-taskgroup='"+(task.parent_id)+"' data-id='"+(task.id)+"' id='jsrow-"+(task.id)+"'> <div class='td'> <div class='wrap url -dx"+(acl)+"' data-url='action/"+(task.id)+"/milestone' data-acl='"+(acl)+"'>"+(Milestone.project.getCellHTML(task))+"</div> </div> <div class='td'> <div class='wrap url -dx"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"' data-view='table'> "+(assign)+" </div> </div> <div class='td'> <div class='wrap url -dx"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/tags' data-acl='"+(task.acl.desc)+"' title='"+(task.tags.join(','))+"'> <div class='xo'>"+(tags_html)+"</div> </div> </div> "+(custom)+" <div class='td'> <div class='wrap text-9' data-role='readonly'> <div class='ap-xdot'>"+(finish)+"</div> </div> </div> <div class='td'> <div class='wrap'>"+(creator)+"</div> </div> <div class='td'> <div class='wrap text-9' data-role='readonly'> <div class='ap-xdot'>"+(AP.i18n.datetime(task.since))+"</div> </div> </div> <div class='td'> <div class='wrap relative text-9' data-role='readonly'> <div class='ap-xdot'>"+(AP.i18n.datetime(task.last_update))+"</div> </div> </div> </div>";
	};
	
	
	
	function getWidth(field){
		if (field.type=="textarea"){
			return 200;
		}
		
		if (field.type=="checkbox"){
			return 60;
		}
		
		if (field.type=="attachment"){
			return 130;
		}
		
		if (field.type=="indicator" || field.type=="sindicator"){
			return 60;
		}

		if (field.type=="datetime"){
			return 120;
		}
		
		return 100;
	};
	
	
	function getCell(task, field){
		var custom_field_text = (field.type == 'text' || field.type == 'textarea') ? 'custom-field ap-xdot' : '';
		return "<div class='js-text-value relative "+(custom_field_text)+"'>"+(Task.field.display(task, field))+"</div>";
	};
	

};


Board.gantt = new function __BoardGantt() {
	this.month_change = 12;

	this.init = function () {
		$("#js-gantt-table").css("height", Board.table.height);
		buildGrid(Board.table.summary.gantt_start, Board.table.summary.gantt_end);
	};


	this.next = function () {
		this.timeSelect(this.month_change);
	};


	this.prev = function () {
		this.timeSelect(-this.month_change);
	};


	this.timeSelect = function (month_change) {
		var time_select = AP.time.now();
		if (Query.getInt("ts")) {
			time_select = Query.getInt("ts");
		}

		var current_date = new Date(time_select * 1000);

		var select_day = new Date(current_date.getFullYear(), current_date.getMonth() + month_change, 1);
		time_select = select_day.getTime() / 1000;

		AP.setURLParams({ ts: time_select });

		var start_day = new Date(current_date.getFullYear(), current_date.getMonth() + month_change / 2 + 1, 1);
		Board.table.summary.gantt_start = start_day.getTime() / 1000;

		var end_day = new Date(current_date.getFullYear(), current_date.getMonth() + month_change * 3 / 2 + 1, 1);
		Board.table.summary.gantt_end = end_day.getTime() / 1000;

		Board.table.range = Math.floor((Board.table.summary.gantt_end - Board.table.summary.gantt_start) / (24 * 3600));
		Board.table.display();
	};


	this.taskUpdated = function (task) {
		if ($("#js-gantt-table .gbarwrapper-" + task.id).length) {
			$("#js-gantt-table .gbarwrapper-" + task.id).replaceWith(getSingleTaskHTML(task));

			$("#js-gantt-table .gbarwrapper-" + task.id + " .gbar.-dx1").resizable({
				grid: 18,
				handles: 'e, w',
				stop: function (event, ui) {
					var left = ui.position.left;
					var width = ui.size.width;

					updateDuration(ui.element, left, width);
				}
			}).draggable({
				axis: 'x',
				grid: [18, 0],
				stop: function (event, ui) {
					var left = ui.position.left;
					var width = $(this).width();
					updateDuration(this, left, width);
				}
			});
		}
	};


	function buildGrid(sdate, edate) {
		var inner_grids = "";

		var mx = "<tr class='months'>";
		var months = getMonths(sdate, edate);

		for (var i = 0; i < months.length; i++) {
			var m = months[i];
			mx += "<td colspan='" + m.span + "'>" + m.name + "</td>";
		}

		mx += "</tr>";

		var header = "<tr class='hdays'>";
		for (var d = sdate; d < edate; d = d + 24 * 3600) {
			var dow = AP.time.time("%D", d).toLowerCase().substr(0, 2);
			var dom = AP.time.time("%d", d);

			header += "<td class='hd -"+(dow)+"'><div class='d'><div class='dom'>"+(dom)+"</div></div></td>";
			inner_grids += "<div class='icol -"+(dow)+"'><div></div></div>";
		}

		header += "</tr>";

		$("#js-gantt-table table").html(mx + header);
		$("#js-gantt-table .inner-grids").html(inner_grids);


		var html = "";
		for (var i = 0; i < Board.data.model.groups.length; i++) {

			html += "<div class='glist'></div>";

			var tasks = Board.data.model.groups[i].tasks;

			for (j = 0; j < tasks.length; j++) {
				if (!parseInt(tasks[j].acl.view) || !parseInt(tasks[j].visible)) {
					continue;
				}

				html += getTaskHTML(tasks[j]);
			}
		}

		$("#js-gantt-table .truegrid").html(html);

		$("#js-gantt-table .truegrid .gbar").hover(function () {
			if (!$(this).hasClass('ui-resizable')) {
				$(this).resizable({
					grid: 18,
					handles: 'e, w',
					stop: function (event, ui) {
						var left = ui.position.left;
						var width = ui.size.width;

						updateDuration(ui.element, left, width);
					}
				}).draggable({
					axis: 'x',
					grid: [18, 0],
					stop: function (event, ui) {
						var left = ui.position.left;
						var width = $(this).width();
						updateDuration(this, left, width);
					}
				});
			}
		});



		var today = (AP.time.beginOfDay() - Board.table.summary.gantt_start) / (24 * 3600);

		if (today > 0) {
			today = today * 18;
			$("#js-gantt-table .todaymark").show().css({ left: today + 5 });

			var left = today - $("#js-gantt-table").width() / 2;

			if (left && left > 0) {
				$("#board-table .section.gantt-table").css("margin-left", -left);

				setTimeout(function () {
					$("#board-table-wrapper .board-nav .nav-right").scrollLeft(left + 10);
				}, 100);

			}
		} else {
			$("#js-gantt-table .todaymark").hide();
		}


	};


	function getTaskHTML(task, ancestor_id = 0) {
		var subtasks = AP.pageConfig.get("subtasks");

		if (task.metatype == "task") {
			ancestor_id = task.id;
		}

		return getSingleTaskHTML(task, ancestor_id) + AP.render(task.subtasks, function (e) {
			if (subtasks == "natural") {
				return getSingleTaskHTML(e, ancestor_id);
			}

			return getTaskHTML(e, ancestor_id);
		});
	};


	function getSingleTaskHTML(task, ancestor_id) {
		var main = "";
		var left = 0;
		var right = 0;

		if (parseInt(task.start_time)) {
			left = (AP.time.beginOfDay(task.start_time) - Board.table.summary.gantt_start) / (24 * 3600);
		}

		if (parseInt(task.deadline)) {
			right = (AP.time.beginOfDay(task.deadline) - Board.table.summary.gantt_start) / (24 * 3600);
		}

		var w = 28;
		if (!left) {
			left = right;
		}

		if (!right) {
			right = left;
		}

		left = left * 18;
		right = (right + 1) * 18;


		var task_info = "<div class='txt'><div class='ap-xdot'>"+(task.name)+" ["+(Task.ui.grandTime(task))+"]</div></div>";
		var user = People.get(task.username);
		if (user && task.username) {
			task_info += "<div class='user'> <div class='image'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> <div class='uname'>"+(user.name)+"</div> </div>";
		} else if (parseInt(task.acl.assign)) {
			task_info += "<div class='user url' data-url='action/"+(task.id)+"/assign'> <div class='user-add'></div> <div class='uname'>Giao cho</div> </div>";
		}

		var extra_class = '';
		if (Compute.overdue(task)) {
			extra_class = '-overdue';
		} else if (Compute.doneLate(task)) {
			extra_class = '-late';
		}

		var w = right - left + 1;
		if (left) {
			var percent = task.complete;
			if (Client.pageData.project && parseInt(Client.pageData.project.percent_completion) && !parseInt(task.status)) {
				main = "<div class='gbar gbar-"+(task.id)+" -dx"+(task.acl.time)+" is-"+(Task.ui.grandState(task))+" "+(extra_class)+"' data-acl='"+(task.acl.time)+"' data-id='"+(task.id)+"' data-deadline='"+(task.deadline)+"' data-start_time='"+(task.start_time)+"' style='left: "+(left - 1)+"px; width: "+(w)+"px'> <div class='td' style='width: "+(percent)+"%'></div> "+(task_info)+" </div>";
			} else {
				main = "<div class='gbar gbar-"+(task.id)+" -dx"+(task.acl.time)+" is-"+(Task.ui.grandState(task))+" "+(extra_class)+"' data-acl='"+(task.acl.time)+"' data-id='"+(task.id)+"' data-deadline='"+(task.deadline)+"' data-start_time='"+(task.start_time)+"' style='left:"+(left - 1)+"px; width: "+(w)+"px'> "+(task_info)+" </div>";
			}
		}

		return "<div class='gbarwrapper gbarwrapper-"+(task.id)+" ancestor-"+(ancestor_id)+"'>"+(main)+"</div>";
	};


	function getMonths(sdate, edate) {
		var ms = [];
		var last = sdate;
		var last_ms = AP.time.time("%m/%Y", last);


		for (var i = sdate; i < edate; i = i + 24 * 3600) {
			var m = AP.time.time("%m/%Y", i);

			if (m != last_ms) {
				ms.push({
					sdate: last,
					edate: i,
					name: AP.time.time("%m - %Y", last),
					span: Math.floor((i - last) / (24 * 3600))
				});
				last = i;
				last_ms = AP.time.time("%m/%Y", i);
			}
		}

		ms.push({
			sdate: last,
			edate: edate,
			name: AP.time.time("%m - %Y", last),
			span: Math.floor((edate - last) / (24 * 3600))
		});


		return ms;
	};


	function updateDuration(ref, left, width) {
		var id = $(ref).data("id");
		var current_deadline = $(ref).data("deadline");
		var current_start_date = $(ref).data("start_date");

		var stime = (Math.ceil(left / Board.table.cell.width)) * (24 * 3600) + Board.table.summary.gantt_start;
		var deadline = stime + Math.floor(width / Board.table.cell.width) * (24 * 3600) - 1;

		Task.inline.editStartTimeDeadline(id, stime, deadline, ref);
	};

};


Board.table.group=new function __BoardTableGroup(){
	this.getHTML=function(group){
		var html="<div class='tr group' data-group='"+(group.id)+"'> <div class='inner'> <div class='dd'><span class='-ap icon-triangle-down'></span></div> <div class='gname ap-xdot' title='"+(group.name)+" - Id: "+(group.id)+"'>"+(group.name)+"</div> </div> </div>";

		if (Board.data.model.metatype=="milestone"){
			var display="["+(AP.i18n.date(group.time))+"] <span class='sub'>"+(group.name)+"</span>";
			if (!group.id){
				display=""+(group.name)+"";
			}
			
			html="<div class='tr group' data-group='"+(group.id)+"'> <div class='inner'> <div class='dd'><div class='icon-base-calendar -dark' style='top:8px; margin-left:-1px;'></div></div> <div class='gname ap-xdot' title='"+(group.name)+" - Id: "+(group.id)+"'>"+(display)+"</div> </div> </div>";
		}
		
		return html;
	};
};




Project.summary=new function __ProjectSummary(){
	this.basic=function(){
		var s={start: parseInt(Client.pageData.context.stime), end: parseInt(Client.pageData.context.etime)};
		
		var tstart=0;
		var tend=0;
		
		for (var i=0; i<Client.pageData.tasks.length; i++){
			var e=Client.pageData.tasks[i];
			
			if (parseInt(e.start_time)){
				if (!tstart || tstart > parseInt(e.start_time)){
					tstart=parseInt(e.start_time);
				}	
			}
			
			if (parseInt(e.deadline)){
				if (!tend || tend < parseInt(e.deadline)){
					tend=parseInt(e.deadline);
				}	
			}
			
		}

        if (!tstart){
            tstart=parseInt(Client.pageData.context.since);
        }	
		
		if (!parseInt(Client.pageData.context.stime)){
			s.start=tstart;
		}

		
		if (!tend || tend < tstart + 30 * 24 * 3600){
			tend=tstart + 30 * 24 * 3600;// #50960 Fix bug gantt chart bi trang
		}

        if (!parseInt(Client.pageData.context.etime)){
            s.end=tend;
        }

		tstart=AP.time.beginOfDay(tstart);
		tend=AP.time.beginOfDay(tend);

		s.task_start=tstart;
		s.task_end=tend;
		
		tstart=tstart-3*24*3600;
		tend=tend+3*24*3600;
		
		// maximum 9 months
		if (tstart + 31 * 9 * 86400 < tend) {
			tstart = tend - 31 * 9 * 86400;
		}
		
		tstart=AP.time.beginOfMonth(tstart);
		tend=AP.time.endOfMonth(tend);
		
		if (tend-tstart < 32*24*3600){
			tend=tend+20*24*3600;
			tstart=tstart-20*24*3600;
		}
		
		var time_select = AP.time.now();
		if (Query.getInt("ts")){
			time_select  = Query.getInt("ts");
		}

		var current_date = new Date(time_select*1000);

		var start_day = new Date(current_date.getFullYear(), current_date.getMonth() - Board.gantt.month_change / 2 + 1, 1);
		s.gantt_start = start_day.getTime()/1000;

		var end_day = new Date(current_date.getFullYear(), current_date.getMonth() + Board.gantt.month_change / 2 + 1, 1);
		s.gantt_end = end_day.getTime()/1000;
		
		return s;
	};
};




Board.printService=new function __BoardList(){
	this.init=function(project){
		this.build(project);
		
		UI.pageCountdown("#tasklists .countdown", true);
		
		$("#tasklists").click(function(e){
			Board.clean("#tasklists", e.target);
		});
	};
	
	
	this.insertTask=function(tasklist, task){
		$("#tasklist-"+tasklist.gid+" .tasks .none").hide();
		$("#tasklist-"+tasklist.gid+" .tasks").append(getTask(task));
	};
	
	
	this.build = function(project){
		Project.tasklists();
		$("#tasklists").empty();
		
		for (var i = 0; i < Client.pageData.tasklists.length; i++){
			var tasklist=Client.pageData.tasklists[i];
			for (var j=0; j<tasklist.tasks.length; j++){
				tasklist.tasks[j].visible=1;
			}
			
			var html = Board.ui.getTaskList(tasklist);
			
			$(html).appendTo("#tasklists");
		}
	};
	
	
	this.collapseSection = function(ref) {
	    var $parent = $(ref).closest('.tasklist');
	    
	    if ($parent.hasClass('-collapsed')) {
	        $parent.removeClass("-collapsed");
	        $('.tasks', $parent).slideDown(300);
	    } else {
	    	$parent.addClass("-collapsed");
            $('.tasks', $parent).slideUp(300);
	    }
	};
	
	
	
	this.editing=function(ref){
		$(ref).closest(".js-task").toggleClass("active").siblings().removeClass("active");
		var $input=$(ref).closest(".js-task").find("input[name=name]");
		
		if (!$input.hasClass("__ap_enter_binded")){
			$input.enter(function(){
				var name=$(this).val();
				var id=$(this).closest(".js-task").data("id");
				
				Task.inline.edit(id, {"key": "name", value: name}, this);
			});
		}
		
		setTimeout(function(){
			$input.focus();
			var val=$input.val();
			$input.val("").val(val);
		},300);
	};
	
	
	this.taskUpdated=function(task, ref){
		$("#tasklists .li-"+task.id).replaceWith(Board.ui.renderItem(task));
	};
	
};


Project.template=new function __ProjectTemplate(){
	this.getTemplates=function(callback){
		
	};	
	
	this.create=function(){
		var project=Client.pageData.context;
		var hiddens={project_id: Client.pageData.context.id};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/template/save"})
			.hiddens(hiddens)
			.row(
				Form.label({label: "TĂªn máº«u"}),
				Form.input({name: 'name', type: "text", placeholder:"TĂªn máº«u"}).value(project.name)
			).addClass("-big")
			.row(
				Form.label({label: "Chia sáº» vá»›i cĂ¡c thĂ nh viĂªn hay phĂ²ng ban"}),
				Form.input({name: 'teams', type: "text", placeholder:"GĂµ @ Ä‘á»ƒ tag", role:"teams"}).value([Client.viewer.username])
			)
			.row(
				Form.label({label: "Dá»±a theo dá»± Ă¡n"}),
				Form.input({name: 'name_fake', type: "fake"}).value('Dá»± Ă¡n: ' + project.name)
			)
			.row(
				Form.label({label: "Bao gá»“m?"}),
				Form.input({name: 'options', type:"checkboxes", options:[
					{label:"NhĂ³m cĂ´ng viá»‡c", value: 'tasklists'},
					{label:"TrÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh", value: 'fields'},
					{label:"CĂ¡c quyá»n vá»›i cĂ´ng viá»‡c", value: 'acls'},
					{label:"Danh sĂ¡ch nhĂ£n", value: 'tags'},
				]}).value(["tasklists", "fields", "acls", "tags"])
			)
			.buttons([
				{label: "LÆ°u", action: function(){
					Form.submit("#fly-workflow-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						Form.hide("fly-workflow-fx");
						AP.alertSuccess("Save template successfully");
						Client.templates.push(code.template);
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function(){
					Form.hide("fly-workflow-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.render(function(form){
			});

		Form.pop({width: 420, label: 'Táº¡o máº«u má»›i tá»« dá»± Ă¡n', layout: 'flat', closable : false}).setForm(form).show();

	};
	
	
	/**
	 * @desc Get options to form select
	 * @return Array
	 */
	this.options=function(){
		var opts=Form.convert(Client.templates);
		opts.unshift({label:"KhĂ´ng chá»n máº«u", value:0})
		
		return opts;
	};

	
};





var Side = new function __Side() {
	
	this.init = function() {
		if (!Client.pageData.tasks) {
			return;
		}
		
		var action = '';
		if (Project.isManager()) {
			action = "<div class='action' onclick='Milestone.create();'>ThĂªm</div>";
		}
		
		$("#project-side-canvas").html("<div id='project-side'> <div class='section js-project-overview'> <div class='overview'> <div id='js-project-overview'></div> </div> </div> <div class='section js-team-tasklists'> <div id='js-team-tasklists'></div> </div> <div class='section js-me-overview'> <div id='js-side-me'></div> </div> <div class='section js-milestones'> <div class='box'> <div class='box-title'>Má»¥c tiĂªu"+(action)+"</div> <div id='js-side-milestones'></div> </div> </div> <div class='section js-project-stats'> <div id='js-side-stats'></div> </div> </div>");
		
		Side.overview.display("#js-project-overview");
		Side.me.init();
		Side.stats.init(); 
		Side.milestone.init();
		
		if (Client.pageData.project.metatype == "project") {
			$("#project-side .js-team-tasklists").hide();
		} else {
			var tasklists = AP.render(Client.pageData.tasklists, function(e) {

				if (!parseInt(e.id)) {
					return '';
				}

				var now = Math.floor(Date.now() / 1000);
				var close_stime = parseInt(e.cs.stime);
				var close_etime = parseInt(e.cs.etime);

				if (close_stime && close_etime && close_stime < now && now < close_etime) {
					return '';
				}
				
				return "<div class='link url' data-urlparam='tasklist' data-value='"+(e.id)+"'> <div class='name ap-xdot'>"+(e.name)+"</div> <div class='icon'><span class='ficon-folder-o'></span></div> </div>";
			});
			
			tasklists = "<div class='link url' data-urlparam='tasklist' data-value=''> <div class='name'>Táº¥t cáº£</div> <div class='icon'><span class='ficon-folder'></span></div> </div>" + tasklists;
			
			var action = Project.isManager() ? "<div class='action' onclick='TaskList.create();'>ThĂªm</div>" : '';
			
			$("#js-team-tasklists").html("<div class='box'> <div class='box-title'>NhĂ³m cĂ´ng viá»‡c"+(action)+"</div> <div class='sidelinks'>"+(tasklists)+"</div> </div>");
			
			$("#js-team-tasklists .link").setActiveURLParam("tasklist", 0);
		}
	};
};


Side.overview=new function __SideOverview(){
	this.display=function(canvas){
		if (!canvas){
			canvas="#js-project-overview";
		}
		
		var context=Client.pageData.context;
		
		var percent=Compute.percent(context);
		var color=Compute.color(context);
		
		var stats=Compute.overview.init(Client.pageData.tasks);
		Side._stats=stats;
		
		var stime=AP.i18n.date(context.stime);
		if (!parseInt(context.stime)){
			stime="<span class='none'>NgĂ y báº¯t Ä‘áº§u</span>";
		}
		
		if (parseInt(context.acl.managed)){
			stime="<span class='url' data-xurl='paction/0/time'>"+stime+"</span>";	
		} else {
			stime="<span class='none'>"+stime+"</span>";
		}
		
		var etime=AP.i18n.date(context.etime);
		if (!parseInt(context.etime)){
			etime="<span class='none'>NgĂ y káº¿t thĂºc</span>";
		}

		if (parseInt(context.acl.managed)) {
			etime="<span class='url' data-xurl='paction/0/time'>"+etime+"</span>";
		} else {
			etime="<span class='none'>"+etime+"</span>";
		}

		var followers = getFollowers(context);
		var number_followers = getNumberFollowers(context);
		var status_history = "<div class='status-history'>"+(Project.status.history(context))+"</div>";
		
		var manage="";
		if (parseInt(context.acl.managed)){
			manage="<div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-cog'></span></div> <div class='title'><span class='url' data-xurl='settings'>Settings</span></div> </div> </div>";
		}
		
		manage='';
		
		var content=context.content;
		if (!content || !content.length){
			content="<span class='text-a'>ChÆ°a cĂ³ miĂªu táº£</span>";
		}
		
		var dept_html='--';
		var d=Dept.fromContext(context.dept_id);
		if (d){
			dept_html="<span class='url' data-url='dept/"+(d.id)+"' title='"+(d.name)+"'>"+(d.name)+"</span>";
		}
		
		var html="<div class='box projinfo'> <div class='projname'>"+(context.name)+"</div> <div class='projdesc'> <span class='icon-desc'></span> "+(content)+" </div> <div class='row'> <span class='ficon-check-square-o icon'></span> "+(stats._overview.done_ontime+stats._overview.done_late)+"/"+(stats._overview.total)+" hoĂ n thĂ nh <div class='v -dd url inline'><b>"+(stats._overview.percent)+"</b>%</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(stats._overview.percent)+"%'></div> </div> <div class='row'> <span class='ficon-bookmark-o icon'></span> <div class='v -full'>"+(stime)+" - "+(etime)+"</div> </div> <div class='row'> <span class='ficon-folder-o icon'></span> Department <div class='v -dd url inline'>"+(dept_html)+"</div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><div class='icon-desc -left' style='width:12px; margin-top:4px;'></div></div> <div class='title -dd url' data-url=':active:parent:parent'>"+(number_followers)+" thĂ nh viĂªn</div> <div class='users'> "+(followers)+" </div> </div> <div class='body'> <div id='js-project-people' class='people'></div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-filter'></span></div> <div class='title url -dd' data-url=':active:parent:parent'>Hoáº¡t Ä‘á»™ng gáº§n Ä‘Ă¢y</div> <div class='side'></div> </div> <div class='body'> <div id='js-project-acts' class='acts'></div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-circle' style='color:"+(Project.status.color(context.stage))+"'></span></div> <div class='title -dd url' data-url=':active:parent:parent'>Tráº¡ng thĂ¡i</div> <div class='side url inline' data-url='paction/"+(context.id)+"/status' style='background-color: "+(Color.rgba(Project.status.color(context.stage),0.1))+"; color:"+(Project.status.color(context.stage))+"'>"+(Project.status.getLabel(context.stage))+"</div> </div> <div class='body'> "+(status_history)+" </div> </div> "+(manage)+"";
		
		$(canvas).html(html);
		Project.people.side.display("#js-project-people", "tasks");
		Side.act.display();
		
	};
	

	function getFollowers(context){

		var followers = AP.array.filter(context.followers, function(e) {
			var u = People.get(e.username);
			return !parseInt(u.error);
		});

		return AP.render(followers, function(e, index){
			var u=People.get(e.username);
	
			
			if (index == 9) {
				return "<div class='avatar avatar-24 -circled relative'> <span class='more'><span style='font-size:11px; font-weight:normal; display:block; padding-top:2px;'>+"+(followers.length - 9)+"</span></span> </div>";
			}
			
			if (index > 9) {
				return '';
			}
			var u = People.get(e.username);
			return "<div class='avatar avatar-24 -circled url' data-username='"+(u.username)+"'> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> </div>";
		});
	};


	function getNumberFollowers(context){
		var followers = AP.array.filter(context.followers, function(e){
			var u=People.get(e.username);
			if (parseInt(u.error)){
				return "";
			}
			
			return e;
		});
		return followers.length;
	};

};


Side.act=new function __SideAct(){
	this.display=function(canvas){
		if (!canvas){
			canvas="#js-project-acts";
		}
		
		getActs(function(acts){
			var html=AP.render(acts, function(e){
				return Act.board.getHTML(e);
			});
			
			$(canvas).append(html);
		});
	};
	
	
	function getActs(callback){
		AP.post("api/activity/get", {id: Client.pageData.context.id}, function(code){
			if (!code.good()){
				// return AP.alertError(code.message);
				if (console){
					console.error(code.message);
				}
				
				return;
			}
			
			callback(code.activities);
		});
	};
};


Side.stats=new function __SideStats(){
	this.init=function(){
		var stats=Side._stats;
		var exp='';
		var users=AP.render(stats._users, function(u){
			return getUserStats(u);
		});
		
		
		var full_stats="<div class='box'> <div class='box-title'>ThĂ´ng tin chung</div> <div class='graph-canvas'> <div class='graph' id='js-project-pie'></div> <div class='stats'> <div class='stat'><span class='s' style='background-color:"+(Color.get(4))+"'></span> <em>"+(stats._overview.done_ontime)+"</em> HT Ä‘Ăºng háº¡n</div> <div class='stat'><span class='s' style='background-color:"+(Color.get(3))+"'></span> <em>"+(stats._overview.done_late)+"</em> HoĂ n thĂ nh muá»™n</div> <div class='stat'><span class='s' style='background-color:"+(Color.get('error'))+"'></span> <em>"+(stats._overview.overdue)+"</em> quĂ¡ háº¡n</div> <div class='stat'><span class='s' style='background-color:"+(Color.get('doing'))+"'></span> <em>"+(stats._overview.active)+"</em> Ä‘ang thá»±c hiá»‡n</div> <div class='stat'><span class='s' style='background-color:"+(Color.get(2))+"'></span> <em>"+(stats._review.review)+"</em> Ä‘ang chá» duyá»‡t</div> </div> </div> <div class='projstats' style='display:none'> <div class='mstats'> <div class='stat'><em>"+(stats._overview.total)+"</em> CĂ´ng viá»‡c</div> <div class='stat'><em>"+(stats._overview.percent)+"<span>%</span></em> Ä‘Ă£ hoĂ n thĂ nh</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(stats._overview.percent)+"%'></div> "+(exp)+" </div> </div> </div> <div class='box burndown' style='height:200px; display:none' id='js-project-burndown'></div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-exclamation-circle red'></span></div> <div class='title url -dd' data-url=':active:parent:parent'>QuĂ¡ háº¡n gáº§n Ä‘Ă¢y</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-project-overdues'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-dot-circle-o -text-orange'></span></div> <div class='title url -dd' data-url=':active:parent:parent'>ChÆ°a báº¯t Ä‘áº§u</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-project-todos'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-filter'></span></div> <div class='title url -dd' data-url=':active:parent:parent'> Thá»‘ng kĂª theo thĂ nh viĂªn </div> </div> <div class='body'> <div class='ustats'>"+(users)+"</div> </div> </div>";
		
		if (!Client.pageData.tasks){
			full_stats='';
		}
		
		$("#js-side-stats").html(full_stats);
		Task.attention.list(Side._stats._collection.overdues, "#js-side-project-overdues", {limit: 10});
		Task.attention.list(Side._stats._collection.todos, "#js-side-project-todos", {limit: 10});
		
		
		/**
		 * @caonguyen
		 * use setTimeout to make hight chart initialization goes after, boosting loading time
		 * Highchart force re render Style computed so it blocks some actions along its intialization
		 */
		setTimeout(function () {
			$('#js-project-pie').highcharts({
				credits:{
					enabled: false
				},
				chart: {
					plotBackgroundColor: null,
					plotBorderWidth: null,
					plotShadow: false,
					type: 'pie',
					backgroundColor:'rgba(255, 255, 255, 0.0)',
				},
				title: {
					text: '',
					style: {fontSize: '13px', fontWeight: 'normal'},
					align: 'center',
					verticalAlign: 'middle',
				},
				tooltip: {
					pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
				},
				plotOptions: {
					pie: {
						allowPointSelect: true,
						cursor: 'pointer',
						dataLabels: {
							enabled: false
						},
						showInLegend: true,
						innerSize: '60%'
					}
				},
				legend:{
					itemStyle:{fontWeight: 'normal', fontSize: '9px'},
					enabled: false,
				},
				series: [{
					name: 'Tasks',
					colorByPoint: true,
					data: [{
						name: "In process ("+(stats._overview.active)+")",
						y: stats._overview.active,
					}, {
						name: "ht Ä‘Ăºng háº¡n ("+(stats._overview.done_ontime)+")",
						y: stats._overview.done_ontime,
						color: "#24ce0e"
					}, {
						name: "HoĂ n thĂ nh muá»™n ("+(stats._overview.done_late)+")",
						y: stats._overview.done_late,
						color: "#cebd0c"
					}, {
						name: "QuĂ¡ háº¡n ("+(stats._overview.late)+")",
						y: stats._overview.late,
						color:"#ce2a0d"
					}]
				}]
			});
		}, 100)
		
//		$('#js-project-burndown').highcharts({
//			title: {
//			  text: 'Total tasks over time',
//			  x: -20, //center,
//			  style: {fontSize: '13px', fontWeight: 'bold'}
//			},
//			colors: ['blue', 'red'],
//			plotOptions: {
//			  line: {
//				lineWidth: 2
//			  },
//			  tooltip: {
//				hideDelay: 200
//			  }
//			},
//			subtitle: {
//			  text: '',
//			  x: -20
//			},
//			xAxis: {
//			  categories: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6',
//						   'Day 7', 'Day 8', 'Day 9', 'Day 10', 'Day 11', 'Day 12']
//			},
//			yAxis: {
//			  title: '',
//			  plotLines: [{
//				value: 0,
//				width: 1
//			  }],
//			  labels: {
//				  enabled: false
//			  }
//			},
//			tooltip: {
//			  valueSuffix: ' hrs',
//			  crosshairs: true,
//			  shared: true
//			},
//			legend: {
//				enabled:false,
//			  layout: 'vertical',
//			  align: 'right',
//			  verticalAlign: 'middle',
//			  borderWidth: 0
//			},
//			series: [{
//			  name: 'Ideal Burn',
//			  color: 'rgba(255,0,0,0.25)',
//			  lineWidth: 1,
//			  data: [110, 100, 90, 80, 70, 60, 50, 40, 30, 20, 10, 0].reverse()
//			}, {
//			  name: 'Actual Burn',
//			  color: 'rgba(0,120,200,0.75)',
//			  marker: {
//				radius: 6
//			  },
//			  data: [100, 110, 125, 95, 64, 76, 62, 44, 35, 29, 18, 2].reverse()
//			}]
//	  });
	};
	
	
	function getUserStats(u){
		var uhtml="<div class='avatar'><span class='-ap icon-uniF1AB'></span></div> <div class='uname'>ChÆ°a giao</div> <div class='uinfo'>"+(u.total)+" CĂ´ng viá»‡c</div>";
		
		if (u.username!='__unassigned'){
			var user=People.get(u.username);
			if (user){
				uhtml="<div class='avatar'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> <div class='uname'>"+(user.name)+"</div> <div class='uinfo ap-xdot'>"+(user.title)+"</div>";
			}
		}
		
		var pdone_ontime, pdone_late, plate=0;
		if (u.total>0){
			pdone_ontime=u.done_ontime*100/u.total;
			pdone_late=u.done_late*100/u.total;
			plate=u.late*100/u.total;
		}
		
		return "<div class='user'> <div class='name'>"+(uhtml)+"</div> <div class='stat'> <div class='label'><em>"+(u.done_late+u.done_ontime)+"</em>/<em>"+(u.total)+"</em></div> <div class='bar'> <div class='c' style='background-color:"+(Color.get(4))+"; width: "+(pdone_ontime)+"%' title='HT Ä‘Ăºng háº¡n: "+(u.done_ontime)+"'></div> <div class='c' style='background-color:"+(Color.get(2))+"; width: "+(pdone_late)+"%' title='HoĂ n thĂ nh muá»™n: "+(u.done_late)+"'></div> <div class='c' style='background-color:"+(Color.get(0))+"; width: "+(plate)+"%' title='QuĂ¡ háº¡n: "+(u.late)+"'></div> </div> </div> </div>";
	};
	
	
};


Side.me=new function __SideMe(){
	this.init=function(){
		var stats=Side._stats;
		var exp=explain('Current completion: '+stats._overview.percent+"%", {icon: false});
		
		var html="<div class='box'> <div class='box-title'>CĂ´ng viá»‡c cá»§a tĂ´i</div> <div class='mstats'> <div class='stat'><em><span class='s d -bg-alt3'></span>"+(stats._me.active_todo)+"</em> Cáº§n lĂ m</div> <div class='stat'><em><span class='s d -bg-alt5'></span>"+(stats._me.active_doing)+"</em> Äang lĂ m</div> <div class='stat'><em><span class='s d -bg-success'></span>"+(stats._me.done_ontime+stats._me.done_late)+"<span></span></em> HoĂ n thĂ nh</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(stats._me.percent)+"%'></div> "+(exp)+" </div> </div> <div class='subsection active'> <div class='subheader'> <div class='icon'><span class='ficon-asterisk red'></span></div> <div class='title -dd url' data-url=':active:parent:parent'><b class='red ap-f15'>Cáº§n lÆ°u Ă½</b></div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-attentions'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-inbox'></span></div> <div class='title -dd url' data-url=':active:parent:parent'>Má»›i Ä‘Æ°á»£c giao</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-assigned'></div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-inbox'></span></div> <div class='title -dd url' data-url=':active:parent:parent'>Giao Ä‘i &amp; QuĂ¡ háº¡n</div> <div class='side'><span class='count'></span></div> </div> <div class='body' id='js-side-assigning-late'></div> </div>";
		
		
		$("#js-side-me").html(html);
		
		Task.attention.list(Side._stats._collection.attentions, "#js-side-attentions", {});
		Task.attention.list(Side._stats._collection.assigned, "#js-side-assigned", {});
		Task.attention.list(Side._stats._collection.assigning_overdue, "#js-side-assigning-late", {});
	};
};


Side.milestone=new function __SideMilestone() {

	this.init = function() {

		if (!Client.pageData.milestones) {
			return;
		}

		Client.pageData.milestones.sort(function(e, f) {
			return parseInt(f.time)-parseInt(e.time);
		});

		var show_milestones = 5;
		var has_empty_milestone = AP.array.findObj(Client.pageData.milestones, 0); // Board.data.init()
		var milestone_count = has_empty_milestone ? Client.pageData.milestones.length - 1 : Client.pageData.milestones.length;
		var milestones = Client.pageData.milestones.slice(0, show_milestones);

		var html = AP.render(milestones, getHTML);

		$("#js-side-milestones").html("<div class='side-milestones'>"+(html)+"</div>");

		if (milestone_count > milestones.length) {
			showMoreBlock("#js-side-milestones .side-milestones", {
				count: milestone_count - milestones.length,
				url: 'mlaction/-/homepage.showmore'
			});
		}
	};


	this.update=function(code){
		var milestone = AP.array.findObj(Client.pageData.milestones, code.task.milestone_id);
		if (milestone) {
			milestone.total = milestone.total + 1;
		}
		Side.milestone.init();
	};


	this.removeTask=function(code){
		var milestone = AP.array.findObj(Client.pageData.milestones, code.task.milestone_id);
		if (milestone) {
			milestone.total = milestone.total - 1;
		}
		Side.milestone.init();
	};


	this.showMore = function() {

		// Show custom dialog for list milestones
		var html = AP.render(Client.pageData.milestones, getHTML);

		var max_height = $(window).height() - 200;
		max_height = max_height < 200 ? 200 : max_height;

		html = "<div class='title'> Má»¥c tiĂªu <div class='-close' onclick='AP.closeDialog(this);'></div> </div> <div class='isearch'> <input type='text' id='selection-filter-ip' placeholder='TĂ¬m nhanh'/> </div> <div class='box' style='max-height:"+(max_height)+"px; overflow-y:auto;'> <div class='side-milestones'> "+(html)+" </div> </div>";

		AP.customDialog(html, "custom-selection").style("-full").width(500).show();
		$("#custom-selection").addClass("more-dialog");


		// Bind search event
		// Custom logic from AP.selectAction
		$("#selection-filter-ip").on("input", function() {
			local_filter($(this).val());
		});

		if (!Client.native){
			$("#selection-filter-ip").autofocus();
		}

		function local_filter(q) {
			$("#custom-selection .milestone").each(function() {
				var matched=false;
				if (!q || !q.length){
					matched=true;
				} else {
					var str=$(this).text();
					matched= AP.word.fulltextMatch(str, q);
				}

				if (matched) {
					$(this).show();
				} else {
					$(this).hide();
				}
			});
		};
	};


	function showMoreBlock(box, options) {

		options = $.extend({}, {label: "Xem thĂªm", count: 1, url: ''}, options);
		$(box).append("<div class='milestone showmore url' data-url='"+(options.url)+"'>"+(options.label)+" ("+(options.count)+")</div>");
	};


	function getHTML(e, index, milestones_length) {

		if (!parseInt(e.id)){
			return '';
		}

		// cmenu direction
		var has_empty_milestone = AP.array.findObj(Client.pageData.milestones, 0); // Board.data.init()
		milestones_length = has_empty_milestone ? milestones_length - 1 : milestones_length;
		var cmenu_direction = index == milestones_length - 1 ? 'up' : '';

		// Hide action if project info not exist
		var has_action = true;
		var milestone = Milestone.fromContext(e.id);
		if (!milestone) {
			has_action = false;
		} else {
			var project = Project.fromContext(milestone.project_id);
			if (!project) {
				has_action = false;
			}
		}

		var ec='';
		if (parseInt(e.time)>AP.time.now()){
			ec='-active';
		}
		
		if (parseInt(e.time)<AP.time.now()-30*24*3600){
			ec='-old';
		}
		
		var u=People.get(e.user_id);

		var user_info='';
		if (u && parseInt(u.uid)){
			user_html="<div class='avatar'><img src='"+(AP.xthumb(u.gavatar))+"'/></div>";
			user_info="<span class='url username'>"+(u.name)+"</span> &nbsp;&middot;&nbsp; ";
		}
		
		return "<div class='milestone "+(ec)+"' data-id='"+(e.id)+"' title='"+(e.name)+" - "+(AP.i18n.date(e.time))+"'> <div class='status-icon'></div> <div class='mdate'>"+(AP.time.time('<em>%v</em><span>%d/%m</span>', e.time))+"</div> <div class='name ap-xdot url' data-url='milestone/"+(e.id)+"'>"+(e.name)+"</div> <div class='subtitle'> "+(user_info)+"<em>"+(e.done)+"/"+(e.total)+"</em> </div> <div class='bar hidden'> <div class='inner'> <div class='c' style='width:"+(e.complete)+"%'> <div class='candy -small -black'></div> </div> <div class='info'> <em>"+(e.done)+"/"+(e.total)+"</em> &mdash; <em>"+(parseFloat(e.complete).toFixed(1))+"</em>% <div class='extra'>"+(AP.time.time('%v, %d/%m/%Y', e.time))+"</div> </div> </div> </div> <div class='mng -cmenuw "+(cmenu_direction)+"'> <span class='-ap icon-dots-two-horizontal'></span> <div class='-cmenu -no-icon -padding'> <div class='-item "+(has_action ? '' : 'hidden')+"' onclick='Milestone.edit("+(e.id)+")'>Chá»‰nh sá»­a</div> <div class='-item' onclick='Milestone.remove("+(e.id)+")'>XĂ³a</div> </div> </div> </div>";
	};
	
};
var Stream=new function __TaskStream(){
	
};




Stream.filter=new function __StreamFilter(){
	this.activate=function(selector){
		$(selector).each(function(){
			var $this=$(this);
			var f=$this.data("filter");
			var df=$this.data("df");
			var prefix=$this.data("prefix");
			
			$(this).find(".url").each(function(){
				$(this).removeClass("selected active");	
				
				var v=$(this).data("value");
				if (v==Query.get(f) || (!Query.get(f) && !v)){
					$(this).addClass("selected active");
					var txt=$(this).text();
					
					if (!v){
						txt=df;
					}else{
						if (prefix){
							txt=""+(prefix)+"<em>"+(txt)+"</em>";
						}
					}
					
					$this.find(".js-current-filter").html(txt);
				} 
			});
		});
	};
	
	
	// STANDARD STATUS
	this.statuses="<div class='autohide dd -cmenuw js-filter-status' data-filter='status' data-df='Tráº¡ng thĂ¡i' data-prefix='Tráº¡ng thĂ¡i: '> <div class='label js-current-filter'>Tráº¡ng thĂ¡i</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='status' data-value=''>Táº¥t cáº£</div> <div class='-item url' data-urlparam='status' data-value='active'>Äang thá»±c hiá»‡n (Cáº§n lĂ m & Äang lĂ m)</div> <div class='-item url' data-urlparam='status' data-value='notreview'>Äang thá»±c hiá»‡n vĂ  chÆ°a Ä‘Ă¡nh giĂ¡</div> <div class='-item url' data-urlparam='status' data-value='todo'>Cáº§n lĂ m</div> <div class='-item url' data-urlparam='status' data-value='doing'>Äang lĂ m</div> <div class='-item url' data-urlparam='status' data-value='done'>HoĂ n thĂ nh</div> <div class='-item url' data-urlparam='status' data-value='review'>Äang chá» Ä‘Ă¡nh giĂ¡</div> <div class='-item-sep'></div> <div class='-item url' data-urlparam='status' data-value='donelate'>HoĂ n thĂ nh muá»™n</div> <div class='-item url' data-urlparam='status' data-value='overdue'>QuĂ¡ háº¡n</div> <div class='-item url' data-urlparam='status' data-value='urgent'>Kháº©n cáº¥p</div> <div class='-item url' data-urlparam='status' data-value='important'>Quan trá»ng</div> </div> </div>";
	
	
	// STANDARD SUBTASKS
	this.subtasks="<div class='autohide dd -cmenuw js-filter-subtask' data-filter='subtask' data-df='Xem cĂ¡c cĂ´ng viá»‡c con'> <div class='label js-current-filter'>Xem cĂ¡c cĂ´ng viá»‡c con</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='subtask' data-value=''>Xem cĂ¡c cĂ´ng viá»‡c con</div> <div class='-item url' data-urlparam='subtask' data-value='hide'>áº¨n cĂ¡c cĂ´ng viá»‡c con</div> </div> </div>";
	
	
	// STANDARD SUBTASKS
	this.orders="<div class='autohide dd -cmenuw js-filter-order' data-filter='order' data-df='Má»›i cáº­p nháº­t' data-prefix='Sáº¯p xáº¿p: '> <div class='label js-current-filter'>Má»›i cáº­p nháº­t</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='order' data-value=''>Má»›i cáº­p nháº­t</div> <div class='-item url' data-urlparam='order' data-value='created'>Thá»i gian táº¡o</div> <div class='-item url' data-urlparam='order' data-value='deadline'>Thá»i háº¡n</div> </div> </div>";
	
};
var Team=new function __ProjectTeam(){
};



Team.form=new function __TeamForm(){
	/**
	 * @desc Create a new team
	 */
	this.create=function(){
		Tag.context(false);
		
		var data={metatype: "team"};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/create"})
		.row(
			Form.label({label: "TĂªn phĂ²ng ban"}),
			Form.input({name: 'name', "placeholder":"TĂªn phĂ²ng ban"})
		).addClass("-big")
		.row(
			Form.label({label: "ThĂ nh viĂªn quáº£n trá»‹"}),
			Form.input({name: 'owners', "placeholder":"Sá»­ dá»¥ng @ Ä‘á»ƒ tag ngÆ°á»i quáº£n trá»‹", role:"tag"}).value("@"+Client.viewer.username+" ")
		).addClass("-big")
		.row(
			Form.label({label: "ThĂ nh viĂªn khĂ¡c"}),
			Form.input({name: 'followers', "placeholder":"ThĂ nh viĂªn lĂ m viá»‡c trong phĂ²ng ban, sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn", role:"tag"})
		)
		.rowHidden(
			Form.label({label: "ThĂªm nhanh thĂ nh viĂªn theo nhĂ³m"}),
			Form.input({name: 'teams', "placeholder":"Nháº­p Ä‘á»ƒ chá»n táº¥t cáº£ cĂ¡c thĂ nh viĂªn vĂ  cĂ¡c nhĂ³m", role: "teams"})
		).addClass("-big")
		.plain("<span class='a' id='js-form-add-teams'>Hoáº·c thĂªm thĂ nh viĂªn tá»« cĂ¡c team ... </span>")
		.row(
			Form.label({label: "MĂ´ táº£ phĂ²ng ban",}),
			Form.input({name: 'content', "placeholder":"MĂ´ táº£ ngáº¯n gá»n vá» phĂ²ng ban", type:"textarea"})
		)
		.row(
			Form.label({label: "Department"}),
			Form.input({name: 'dept_id', "placeholder":"Department", type:"select", empty: {label: "ChÆ°a xĂ¡c Ä‘á»‹nh", value:0}, options: Form.convert(Client.depts)})
		)
		.buttons([
		     {label: "Táº¡o phĂ²ng ban", action: function(){
		    	 Form.submit("#fly-workflow-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 AP.redirect(code.project.path);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Huá»·", action: function(){
		    	 Tag.context(true);
		    	 Form.hide("fly-workflow-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			$("#js-form-add-teams").click(function(){
				form.findRow("teams").show();
				form.find("teams").focus();
				$(this).parent().hide();
			});

			Form.select.improve($("#fly-workflow-fx .row .select select"));

			$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_created:project");
		});
	
		Form.pop({width: 480, label: 'Táº¡o phĂ²ng ban má»›i', layout: 'flat', closable: false}).setForm(form).show().focus('name');
	
	};
	
	
	/**
	 * @desc Edit a team
	 */
	this.edit=function(project){
		var data={hid: project.hid, token: project.token};
		
		if(project.status != 0) {
            return AP.alertError("Dá»± Ă¡n Ä‘ang táº¡m Ä‘Ă³ng hoáº·c Ä‘Ă£ hoĂ n thĂ nh.");
        }
		
		var form=Form.create('fly-workflow-fx',{'action': "api/project/edit"})
		.row(
			Form.label({label: "TĂªn dá»± Ă¡n",sublabel: "TĂªn dá»± Ă¡n"}),
			Form.input({name: 'name', "placeholder":"TĂªn dá»± Ă¡n"}).value(project.name)
		)
		.row(
			Form.label({label: "MĂ´ táº£ dá»± Ă¡n",sublabel: "MĂ´ táº£ ngáº¯n gá»n vá» dá»± Ă¡n"}),
			Form.input({name: 'content', "placeholder":"MĂ´ táº£ ngáº¯n gá»n vá» dá»± Ă¡n", type:"textarea"}).value(project.content)
		)
		.row(
			Form.label({label: "NgÆ°á»i quáº£n trá»‹",sublabel: "NgÆ°á»i quáº£n trá»‹ cĂ³ thá»ƒ táº¡o vĂ  giao viá»‡c cho thĂ nh viĂªn dá»± Ă¡n. Báº¡n máº·c Ä‘á»‹nh lĂ  má»™t ngÆ°á»i quáº£n trá»‹."}),
			Form.input({name: '_owners', type:"fake"}).value(UI.objectsToUsernames(project.owners))
		)
		.row(
			Form.label({label: "ThĂ nh viĂªn dá»± Ă¡n",sublabel: "ThĂ nh viĂªn lĂ m viá»‡c trong dá»± Ă¡n"}),
			Form.input({name: '_followers', type:"fake"}).value(UI.objectsToUsernames(project.followers))
		)
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u",sublabel: "NgĂ y báº¯t Ä‘áº§u dá»± Ă¡n"}),
			Form.input({name: 'stime', "placeholder":"Chá»n ngĂ y báº¯t Ä‘áº§u", role:"date"}).value(UI.inputTime(project.stime))
		)
		.row(
			Form.label({label: "NgĂ y káº¿t thĂºc",sublabel: "NgĂ y káº¿t thĂºc dá»± Ă¡n"}),
			Form.input({name: 'etime', "placeholder":"Chá»n ngĂ y káº¿t thĂºc", role:"date"}).value(UI.inputTime(project.etime))
		)
		.rowHidden(
			Form.label({label: "Tag teams",sublabel: "Teams whose members who can create jobs in this workflow."}),
			Form.input({name: 'teams', "placeholder":"Type team name to start tagging"})
		)
		.buttons([
		     {label: "Chá»‰nh sá»­a dá»± Ă¡n", action: function(){
		    	 Form.submit("#fly-workflow-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    		 
		    		 AP.toURL("project/"+code.project.id);
		    	 })
		     }, style: 'ok -success -rounded bold'},
		     {label: "Huá»·", action: function(){
		    	 Form.hide("fly-workflow-fx");
		     }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form){
			Form.select.improve($("#fly-workflow-fx .row .select select"));
		});
	
		Form.pop({width: 720, label: 'Sá»­a dá»± Ă¡n: '+project.name
		}).setForm(form).show().focus('name');
	
		Tag.team(form.find("teams"));
	};
	

	this.import = function() {
		var columns = [
            {label: "TĂªn", name: "name"},
            {label: "Quáº£n trá»‹ dá»± Ă¡n", name: "owners"},
            {label: "ThĂ nh viĂªn thá»±c hiá»‡n dá»± Ă¡n", name: "followers"},
            {label: "ThĂ nh viĂªn theo nhĂ³m ngÆ°á»i dĂ¹ng", name: "teams"},
            {label: "Dept ID", name: "dept_id"},
            {label: "MĂ´ táº£", name: "content"},
        ];

        Base.importer.dialog({
            action: "api/project/import/teams",
            rows: [],
            columns: columns,
            data:[],
            title: "Nháº­p dá»± Ă¡n tá»« excel"
        });
	}
	
};


Team.filter=new function __TeamFilter(){
	this.init=function(){
		var view=AP.pageConfig.get("project_view");
		if (view=="period"){
			return initPeriodFilters();
		}else{
			return setTimeout(function(){
				initStreamFilters();
			});
		}
	};
	
	
	function initStreamFilters(){
		var ms=AP.render(Client.pageData.milestones, function(e){
			return "<div class='-item url' data-urlparam='milestone' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		});
		
		$('#js-stream-filters').html("<div class='dd -cmenuw js-auto-filter js-assignees' data-filter='assign'> <div class='label js-current-filter'>Giao cho</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='assign' data-value=''>Táº¥t cáº£</div> <div class='-item url' data-urlparam='assign' data-value='me'>Giao cho tĂ´i</div> <div class='-item url' data-urlparam='assign' data-value='assigning'>Giao bá»Ÿi tĂ´i</div> <div class='-item pick-assignee' data-urlparam='assign' data-value='custom'> Lá»±a chá»n thĂ nh viĂªn </div> </div> </div> <div class='dd -cmenuw js-auto-filter' data-filter='milestone' data-df='Táº¥t cáº£ má»¥c tiĂªu' data-prefix='Má»¥c tiĂªu: '> <div class='label js-current-filter'>Táº¥t cáº£ má»¥c tiĂªu</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='milestone' data-value=''>Táº¥t cáº£ má»¥c tiĂªu</div> "+(ms)+" </div> </div> <div class='right' style='width:5px;'></div>");
		
		setActiveFilter($("#js-stream-filters").find(".js-auto-filter"));
		
		$("#js-stream-filters").find(".pick-assignee").on("click", function(){
			UI.user.pick("Chá»n ngÆ°á»i Ä‘Æ°á»£c giao", function(users){
				if (!users.length){
					AP.setURLParams({assign: null});
				} else {
					AP.setURLParams({assign: users.join("-")});
				}
				AP.xRefresh();
			})
		});
		
		if (Query.get("assign")){
			var assignees=Query.get("assign");
			if (assignees=="me" || assignees=="assigning"){
				
			}else{
				var users=People.collect(assignees.split("-"));
				if (users.length){
					$("#js-stream-filters .js-assignees .-item").setActiveURLParam("assign", "custom");
					$("#js-stream-filters .js-assignees .js-current-filter").html("Assigned: "+AP.word.join(users, ", ",function(e){
						return e.name;
					}))
				}
			}
		}
		
		$("#project-filters").html(""+(Stream.filter.statuses)+" "+(Stream.filter.orders)+" "+(Stream.filter.subtasks)+"");
		
		Stream.filter.activate("#project-filters .js-filter-status");
		Stream.filter.activate("#project-filters .js-filter-order");
		Stream.filter.activate("#project-filters .js-filter-subtask");
		
		$("#project-filters .js-filter-order").removeClass("autohide");
		$("#project-filters .js-filter-status").removeClass("autohide");
		
		if (Client.pageData.task_view=="board"){
			initExtraBoardFilter("#project-filters .js-filter-subtask");
		}
	};
	
	
	
	
	function initPeriodFilters(){
		if (!Client.pageData.stack){
			alert("INVALID_PERIOD_FILTER");
			return;
		}
		
		var period_pref=AP.log.getAppCookie("pref_period_"+Client.pageData.project.id);
		if (!period_pref){
			period_pref="created";
		}
		
		Board.data.period_by=period_pref;
		
		
		var stack=Client.pageData.stack;
		var active="";
		if (parseInt(stack.active)){
			active=" <span title='Hiá»‡n táº¡i'>&nbsp;<span class='-ap icon-flag text-success'></span></span>";
		}

		var stack_title = '';
		var stack_prev_title = '';
		var stack_next_title = '';
		if (stack.team_stack=="weekly") {
			stack_title = "Tuáº§n "+(stack.title)+"";
			stack_prev_title = "Tuáº§n "+(stack.prev.title)+"";
			stack_next_title = "Tuáº§n "+(stack.next.title)+"";
		} else {
			stack_title = "ThĂ¡ng "+(stack.title)+"";
			stack_prev_title = "ThĂ¡ng "+(stack.prev.title)+"";
			stack_next_title = "ThĂ¡ng "+(stack.next.title)+"";
		}
		
		var nav="<div class='team-nav js-team-nav'> <div id='js-team-hnav'> <span class='nav nav-left url' data-ts='"+(stack.prev.ts)+"' title='"+(stack_prev_title)+"'> <span class='-ap icon-chevron-left22'></span> </span> &nbsp; <span class='url' data-xurl='home'>"+(stack_title)+" "+(active)+"</span> &nbsp; <span class='nav nav-right url' data-ts='"+(stack.next.ts)+"' title='"+(stack_next_title)+"'> <span class='-ap icon-chevron-right22'></span> </span> </div> </div>";
		
		var order="<div class='filter autohide js-auto-filter' id='js-list-order' data-filter='order' data-prefix='v2.sort_by: '> <div class='js-current-filter'>v2.sort_by: <em>Má»›i cáº­p nháº­t</em></div> <div class='dd'> <div class='li url' data-urlparam='order' data-value=''>Má»›i cáº­p nháº­t</div> <div class='li url' data-urlparam='order' data-value='created'>Thá»i gian táº¡o</div> <div class='li url' data-urlparam='order' data-value='deadline'>Thá»i háº¡n</div> </div> </div>";
		
		
		var display_opts=Team.filter.display_options;
		
		
		$("#project-filters").html(""+(nav)+" "+(Stream.filter.statuses)+" "+(display_opts)+"");
		
		$("#project-filters .js-team-nav .nav").click(function(){
			var ts=$(this).data("ts");
			AP.setURLParams({ts: ts}, true);
		});	
		
		
		setActiveFilter("#project-filters .js-filter-status");
		
		$("#project-filters select").each(function(){
			var key=$(this).data("urlparam");
			var pref=$(this).data("pref");
			var cx=$(this).data("cookie");
			
			if (cx){
				var val=AP.log.getAppCookie("pref_"+cx+"_"+Client.pageData.project.id);
				if (val){
					$(this).val(val);
				}
				
				$(this).on("change", function(){
					var val=$(this).val();
					AP.log.setAppCookie("pref_"+cx+"_"+Client.pageData.project.id, val);
					AP.xRefresh();
				});
				
				return;
			}
			
			
			if (pref){
				var val=Base.pref().get("pref_"+pref+"_"+Client.pageData.project.id);
				if (val){
					$(this).val(val);
				}
				
				$(this).on("change", function(){
					var val=$(this).val();
					Base.pref().set("pref_"+pref+"_"+Client.pageData.project.id, val);
					AP.xRefresh();
				});
				
				return;
			}
			
			
			if (key && key.length && typeof key !="undefined"){
				$(this).on("change", function(){
					var val=$(this).val();
					
					if (!val){
						AP.setURLParams(assoc(key, null), true);	
					}else{
						AP.setURLParams(assoc(key, val), true);
					}
				});
				
				var cval=Query.get(key);
				if (cval){
					$(this).val(cval);
				}else{
					$(this).val("");
				}
			}
		});
		
		initGCTPref();
	};
	
	
	
	function initExtraBoardFilter(canvas){
		$(canvas).replaceWith("<div class='filter autohide'> <em>Hiá»ƒn thá»‹</em> &nbsp; <div class='dd'> <div class='select -no-border'> <div class='label'>NhĂ³m báº±ng</div> <select name='filter-groupby' data-pref='groupby'> <option value='tasklist'>NhĂ³m cĂ´ng viá»‡c</option> <option value='people'>ThĂ nh viĂªn</option> <option value='milestone'>Má»¥c tiĂªu</option> </select> </div> <div class='checkbox' id='df-group-done'> <div class='check'></div> <div class='label'>NhĂ³m cĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh</div> </div> </div> </div>");
		
		$("#project-filters select[name=filter-groupby]").each(function(){
			var pref=$(this).data("pref");
			var val=Base.pref().get("pref_"+pref+"_"+Client.pageData.project.id);
			if (val){
				$(this).val(val);
			}
			
			$(this).on("change", function(){
				var val=$(this).val();
				Base.pref().set("pref_"+pref+"_"+Client.pageData.project.id, val);
				AP.xRefresh();
			});
			
			return;
		});
		
		initGCTPref();
	};
	
	
	
	
	
	
	/**
	 * @desc Init group-completed task pref
	 */
	function initGCTPref(){
		var grouped=Base.pref().get("pref_grouped_"+Client.pageData.project.id);
		if (!grouped || !parseInt(grouped)){
			grouped=1;
		}
		
		grouped=parseInt(grouped);
		Board.filter.grouped=grouped;
		
		if (grouped==1){
			$("#df-group-done").addClass("checked");		
		}else{
			$("#df-group-done").removeClass("checked");
		}
		
		$("#df-group-done").click(function(){
			var grouped=Board.filter.grouped;
			if (!grouped || !parseInt(grouped)){
				grouped=1;
			}
			
			grouped=-parseInt(grouped);
			Base.pref().set("pref_grouped_"+Client.pageData.project.id, grouped);
			Board.filter.grouped=grouped;
			
			if (grouped==1){
				$("#df-group-done").addClass("checked");
			}else{
				$("#df-group-done").removeClass("checked");
			}
			
			AP.xRefresh();
		});
	};
	
	
	
	function setActiveFilter(selector){
		$(selector).each(function(){
			var $this=$(this);
			var f=$this.data("filter");
			var df=$this.data("df");
			var prefix=$this.data("prefix");
			
			$(this).find(".url").each(function(){
				$(this).removeClass("selected active");	
				
				var v=$(this).data("value");
				if (v==Query.get(f) || (!Query.get(f) && !v)){
					$(this).addClass("selected active");
					var txt=$(this).text();
					
					if (!v){
						txt=df;
					}else{
						if (prefix){
							txt=""+(prefix)+"<em>"+(txt)+"</em>";
						}
					}
					
					$this.find(".js-current-filter").html(txt);
				} 
			});
		});
	};
	
	
	
	
	
	this.display_options="<div class='filter autohide'> <em>Hiá»ƒn thá»‹</em> &nbsp; <div class='dd'> <div class='select'> <div class='label'>CĂ´ng viá»‡c con</div> <select name='filter-subtasks' data-urlparam='subtask'> <option value=''>Xem cĂ¡c cĂ´ng viá»‡c con</option> <option value='hide'>áº¨n cĂ¡c cĂ´ng viá»‡c con</option> </select> </div> <div class='select -no-border'> <div class='label'>Thá»i gian dá»±a vĂ o</div> <select name='filter-period' data-cookie='period'> <option value=''>Thá»i gian táº¡o</option> <option value='deadline'>Thá»i háº¡n</option> <option value='last_update'>Má»›i cáº­p nháº­t</option> </select> </div> <div class='select -no-border'> <div class='label'>NhĂ³m báº±ng</div> <select name='filter-groupby' data-pref='groupby'> <option value='tasklist'>NhĂ³m cĂ´ng viá»‡c</option> <option value='people'>ThĂ nh viĂªn</option> <option value='milestone'>Má»¥c tiĂªu</option> </select> </div> <div class='checkbox' id='df-group-done'> <div class='check'></div> <div class='label'>NhĂ³m cĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh</div> </div> </div> </div>";
};


Team.period=new function __TeamPeriod(){
	this.init=function(canvas){
		Board.data.init();
		$("#tasklists").empty();
		Board.list.display(Client.pageData.context);	
	};
	
	this.rebuild=function(){
		$("#tasklists").empty();
		Board.list.display(Client.pageData.context);
	};
};




Team.stream=new function __BaseTeamList(){
	this.init=function(opts){
		Board.data.init();
		// buildModel();
		opts=$.extend({period:'weekly', show_more: true}, opts);
		this.opts=opts;
		
		Query.set("view", Client.pageData.task_view);
		Project.subheader.init();	
		
		var label="CĂ¡c cĂ´ng viá»‡c gáº§n Ä‘Ă¢y";
		if (Query.get("order")=="deadline"){
			label="Sáº¯p xáº¿p cĂ´ng viá»‡c theo thá»i háº¡n";	
		}else if (Query.get("order")=="created"){
			label="Táº¡o gáº§n Ä‘Ă¢y";	
		}
		
		var ord='';
		var real_order='';
		if (Query.get("order")){
			ord='&order='+Query.get('order');
			real_order=Query.get('order');
		}
		
		AP.pageConfig.set("team_order", real_order);
		
		var view_subtasks=1;
		if (Query.get("subtask")=="hide"){
			view_subtasks=-1;
		}
		
		AP.pageConfig.set("team_subtasks", view_subtasks);
		
		
		var more="<div class='load-more' onclick='Team.stream.more();'>Táº£i thĂªm cĂ´ng viá»‡c</div>";
		if (!opts.show_more){
			more='';
		}
		
		var title="<div class='group-header'> <div class='title'> <div class='collapse'> <span class='ficon-caret-right'></span> </div> <div class='name'><span class='url' data-xurl='home?view=stream"+(ord)+"'>"+(label)+"</span></div> </div> <div class='right' style='max-width:none' id='js-stream-filters'></div> </div>";
		
		if (!Client.pageData.project){
			title='';
		}
		
		$(opts.canvas).html("<div class='tasklist'> "+(title)+"<div class='tasks js-list-tasks'></div>"+(more)+" </div>");
		
		this.page=1;
		for (var i=0; i< Client.pageData.tasks.length; i++){
			if (Client.pageData.tasks[i].metatype=="task"){
				appendTask(Client.pageData.tasks[i]);
			}
		}
	};
	
	
	/**
	 * @desc Fully rebuild the list
	 */
	this.rebuild=function(){
		$("#tasklists .tasks").empty();
		for (var i=0; i< Client.pageData.tasks.length; i++){
			if (Client.pageData.tasks[i].metatype=="task"){
				appendTask(Client.pageData.tasks[i]);
			}
		}
	};
	
	
	this.more=function(){
		this.page++;
		
		var params=Query.release();
		params.page=this.page;
		params.project_id=Client.pageData.project.id;
		
		UI.ajaxShow();
		AP.post("api/project/more.tasks", params, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			for (var i=0; i<code.tasks.length; i++){
				Client.pageData.tasks.push(code.tasks[i]);	
			}
			
			Client.pageData.tasks=AP.array.uniqueObjects(Client.pageData.tasks);
			buildModel();
			
			appendTasks(code.tasks);
			Side.overview.display("#js-project-overview");
		});
	};
	
	
	/**
	 * @desc Append a single task
	 */
	function appendTask(task){
		if ($("#tasklists #task-"+(task.id)+"").length){
			return;
		}
		
		appendSeperator(task);
		
		var html=List.ui.getHTML(task,{team_view: 1});
		$("#tasklists .tasks").append(html);
	};
	
	
	function appendSeperator(task){
		var opts=Team.stream.opts;
		var id='';
		var title='';
		
		var ord=Query.get("order");
		var ts=task.last_update;
		
		if (ord=="created"){
			ts=task.since;
		}
		
		if (ord=="deadline"){
			ts=task.deadline;
		}
		
		if (opts.period=="monthly"){
			id=AP.time.beginOfMonth(ts);
			title='ThĂ¡ng '+AP.time.time("%m/%Y", ts);
		}else{
			id=AP.time.beginOfWeek(ts);
			title='Tuáº§n '+AP.i18n.dateRange(AP.time.beginOfWeek(ts), AP.time.endOfWeek(ts));
		}
		
		if (ts==0){
			id="x0";
			title="Others";
		}
		
		if ($("#tasklists").find(".sep-"+id).length){
			return;
		}
		
		$("#tasklists .tasks").append("<div class='list-sep sep-"+(id)+"'>"+(title)+"</div>");
	};
	
	
	/**
	 * @desc Append a task to the list
	 */
	function appendTasks(tasks){
		for (var i=0; i<tasks.length; i++){
			appendTask(tasks[i]);
		}
	};
	
	
	function buildModel(){
		// BUILDING THE TASK RELATIONSHIP
		for (var j = 0; j < Client.pageData.tasks.length; j++) {
			Client.pageData.tasks[j].visible=Project.filter.getVisible(Client.pageData.tasks[j]);
			
			Client.pageData.tasks[j].subtasks = AP.array.filter(Client.pageData.tasks, function(s){
				return parseInt(s.parent_id) == parseInt(Client.pageData.tasks[j].id);
			});

			Client.pageData.tasks[j].subtasks=AP.array.realOrder(Client.pageData.tasks[j].subtasks);
			
			Client.pageData.tasks[j].parent=AP.array.findObj(Client.pageData.tasks, Client.pageData.tasks[j].parent_id);
		}
	};
	

	
	
	// STANDARD SUBTASKS
	this.std_subtask_views="<div class='autohide dd -cmenuw js-auto-filter' data-filter='subtask' data-df='View subtasks'> <div class='label js-current-filter'>View subtasks</div> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='subtask' data-value=''>View subtasks</div> <div class='-item url' data-urlparam='subtask' data-value='hide'>Hide subtasks</div> </div> </div>";
	
};

var MyTask = new function __MyTask() {

	this.list = function (canvas) {
		List.init({
			canvas: "#tasklists",
			show_more: false
		});
		
		$("#tasklists").append("<div class='sep-30'></div> <div id='js-pag' class='center'></div><div class='sep-30'></div><div class='sep-30'></div>");
		
		UI.paginate("#js-pag");
		return;
	};
};


var MT = MyTask;



MyTask.filter = new function __MyTaskFilter() {

	this.init = function() {

		$("#js-filter-add").click(function() {
			MT.filter.create();
		});
		
		Filter.init({	
			"display":"dialog",
			"filters":[ // Optional
				{"key":"ftype", name: "Loáº¡i cĂ´ng viá»‡c", "type":"match",
					options:[
						{label: "CĂ´ng viá»‡c giao cho tĂ´i", value: "assigned"},
						{label: "CĂ´ng viá»‡c Ä‘Æ°á»£c táº¡o bá»Ÿi tĂ´i", value: "created"},
						{label: "CĂ´ng viá»‡c trong cĂ¡c phĂ²ng ban hoáº·c dá»± Ă¡n tĂ´i cĂ³ thá»ƒ xem", value: "all"}
					]
				},
				{"key":"status", name: "Tráº¡ng thĂ¡i cĂ´ng viá»‡c", "type":"match", options:[{"label": "Äang thá»±c hiá»‡n", value: 'active'}, {label: "Äang chá» Ä‘Ă¡nh giĂ¡", value: 'review'}, {label: "HoĂ n thĂ nh", value: 'done'}]},
				{"key":"created", name: "Thá»i gian táº¡o", "type":"number", "role":"date"}, // Search deadline
				{"key":"created_within", name: "Táº¡o trong khoáº£ng", "type":"match", options: getDateRanges()}, // Search deadline
				{"key":"deadline", name: "Thá»i háº¡n", "type":"number", "role":"date"}, // Search deadline
				{"key":"deadline_within", name: "Thá»i háº¡n trong khoáº£ng", "type":"match", options: getDateRanges()}, // Search deadline
				{"key":"start_time", name: "Thá»i gian báº¯t Ä‘áº§u", "type":"number", "role":"date"}, // Search start time
				{"key":"start_time_within", name: "Báº¯t Ä‘áº§u trong khoáº£ng", "type":"match", options: getDateRanges()}, // Search start time
				{"key":"overdue", name: "QuĂ¡ háº¡n", "type":"match", options:[{label: "KhĂ´ng quĂ¡ háº¡n", value: "no"}, {label: "QuĂ¡ háº¡n", value: "yes"}]},
				{"key":"urgent", name: "Kháº©n cáº¥p", "type":"match", options:[{label: "KhĂ´ng kháº©n cáº¥p", value: "no"}, {label: "Kháº©n cáº¥p", value: "yes"}]},
				{"key":"q", name: "TĂªn cĂ´ng viá»‡c", "type":"match"}, // Search full text
				{"key":"tag", name: "NhĂ£n dĂ¡n", "type":"match"},
				{"key":"assign", name: "Giao cho", "type":"match", role:"user"},
				{"key":"creator", name: "NgÆ°á»i giao", "type":"match", role:"user"},
				{"key":"project", name: "PhĂ²ng ban/dá»± Ă¡n", "type":"match", options:getProjectFilters()}
			],
			"search": function(data, url) { // Event call when the filter is set
				AP.toURL("tasks/filter?filter_status=1"+url);
			},
			"save": function() { // Event call when the filter is save
				Filter.save("api/mytask/filter", function(code) {
					Filter.hide();
					AP.redirect("tasks/filter?filter="+code.filter.id+""+code.filter.url);
				}, {
					
				});
			},
			"remove": function() {
				 Filter.remove("api/mytask/filter/remove", function(code) {
					AP.redirect("tasks");
				},{
					
				});	
			}
		});
		
		initList();
	};
	
	
	/**
	 * @desc Show current filter
	 */
	this.showCurrent = function() {

		var filters = AP.render(Client.filters, function(e) {
				return "<div class='-item xo url' data-xurl='tasks/filter?filter="+(e.id)+""+(e.url)+"'> <span class='ficon-circle text-alt"+(e.color)+"'></span> &nbsp; "+(e.name)+" </div>";
		});
		
		var html = "<div class='task-user-add -compact'> <div class='sicon'><span class='ficon-filter'></span></div> <div class='txt'> Bá»™ lá»c tĂ¹y chá»‰nh: <span class='stitle url' data-url='tasks/filter?filter="+(Client.pageData.filter.id)+""+(Client.pageData.filter.url)+"'>"+(Client.pageData.filter.name)+"</span> </div> </div> <div class='side'> <div class='cta-slim hidden'>Xuáº¥t</div> <div class='dd -cmenuw'> <span>Bá»™ lá»c khĂ¡c</span> <div class='-cmenu -padding -no-icon''> "+(filters)+" </div> </div> </div>";
		
		$("#subheader").html(html);
	};
	
	
	this.create = function() {
		Filter.create();
	};
	
	
	this.set = function(key) {

		if (key == "overdue") {
			AP.setURLParams({"overdue": "yes"}, true);
		} else if (key == "urgent") {
			AP.setURLParams({"urgent": "yes"}, true);
		} else if (key == "today") {
			AP.setURLParams({"deadline_within": "1"}, true);
		} else if (key == "after") {
			AP.setURLParams({"after": "yes"}, true);
		} else if (key == "subtask") {
			AP.setURLParams({"subtask": "yes"}, true);
		} else if (key == "important") {
			AP.setURLParams({"important": "yes"}, true);
		} else {
			AP.setURLParams({"tag": key}, true);
		}
	};
	
	
	function getProjectFilters() {
		return AP.array.select(Client.projects, function(e) {
			return {label: "["+e.metatype+"] "+e.name, value: e.id};
		});
	};
	
	
	function getDateRanges() {
		return [
			{label: "1 ngĂ y", value: 1}, 
			{label: "3 ngĂ y", value: 3}, 
			{label: "7 ngĂ y", value: 7}, 
			{label: "15 ngĂ y", value: 15}, 
			{label: "30 ngĂ y", value: 30}
		];
	};
	
	
	function initList() {

		var html = AP.render(Client.filters, function(e) {
			return "<div class='link xo' data-xurl='tasks/filter?filter="+(e.id)+""+(e.url)+"'> <div class='full-mask url' data-xurl='tasks/filter?filter="+(e.id)+""+(e.url)+"'></div> <div class='edit' onclick=\"Filter.edit("+(e.id)+",'"+(e.name)+"','"+(e.url)+"','"+(e.color)+"');\"> <span class='-ap icon-mode_edit'></span> </div> <div class='name'><span class='text-alt"+(e.color)+"'>"+(e.name)+"</span></div> <div class='icon'><span class='ficon-circle-o text-alt"+(e.color)+"'></span></div> </div>";
		});
		
		$("#js-cfilters").append(html);
		
		if (Query.getInt("filter")) {
			$("#project-side .link").setActiveURLParam("filter");	
		} else {
			$("#project-side .link").setActiveURL();
		}
	};
	
};


MyTask.header = new function __MyTaskHeader() {

	this.init = function() {

		Client.pageData.filters = Client.filters;
		
		var cfs = AP.render(Client.filters, function(e) {
			return "<div class='-item url' data-url='tasks/filter?filter="+(e.id)+""+(e.url)+"'>"+(e.name)+"</div>";
		});
		
		if (cfs && cfs.length) {
			cfs += "<div class='-item-sep'></div>";
		}

		cfs += "<div class='-item -add' onclick='MT.filter.create();'>ThĂªm bá»™ lá»c tĂ¹y chá»‰nh</div>";
		
		$("#header .js-header-custom-filters").html(cfs);
	};
	
	
	/**
	 * @desc Init repeated header
	 */
	this.initRepeated = function() {

		// Mytask query filter
		$("#js-mqs").enter(function() {
			var q = $(this).val();
			if (!q || !q.length) {
				q = null;
			}
			
			AP.setURLParams({q: q}, true);
		}).val(Query.get("q"));
		
	
		var html_team = AP.render(Client.projects, function(e) {
			if (e.metatype != "team") {
				return "";
			}
			return "<div class='-item js-project-"+(e.id)+" url' data-urlparam='project' data-value='"+(e.id)+"' data-id='"+(e.id)+"'> <span class='name block ap-xdot'>"+(e.name)+"</span> </div>";
		}); 
		
		var html_projects = AP.render(Client.projects, function(e) {
			if (e.metatype == "team") {
				return "";
			}
			
			return "<div class='-item js-project-"+(e.id)+" url' data-urlparam='project' data-value='"+(e.id)+"'> <span class='name block ap-xdot'>"+(e.name)+"</span> </div>";
		}); 
		
		var html = "<div class='-item-filter'> <input type='text' name='js-search-pfilter' id='js-search-pfilter' placeholder='Bá»™ lá»c Dá»± Ă¡n & PhĂ²ng ban'> </div> <div class='scroll-y' style='max-height:300px; margin:0 -10px; padding:0 10px'> <div class='-item js-project-0 url' data-urlparam='project' data-value=''>Táº¥t cáº£</div> <div class='js-all-projects-filter'> <div class='sub-tt'>PhĂ²ng ban</div> "+(html_team)+" <div class='sub-tt'>Dá»± Ă¡n</div> "+(html_projects)+" </div> </div>";
		
		$("#js-phmenu").html(html).addClass("scroll-y").css("right", -12);
		
		if (Query.get("project")) {
			var p = AP.array.findObj(Client.projects, Query.get("project"));
			if (p) {
				$("#js-mproject .label em").html(p.name);
				$("#js-phmenu .-item").removeClass("checked");
				$("#js-phmenu .js-project-" + p.id).addClass("checked");
			}
		} else {
			$("#js-mproject .js-project-0").addClass("checked");
		}

		$("#js-search-pfilter").quickFilter("#js-mproject .js-all-projects-filter .-item", function($e, q) {
			return AP.word.fulltextMatch($e.text(), q);
		});
	};
};


MT.repeated = new function __MyTaskRepeated() {

	this.init = function() {

		$("#repeated-list .add").click(function() {
			var type = $(this).data("type");
			MT.repeated.create(type);
		});
		
		var weekly = AP.render(Client.pageData.repeated_tasks, function(e) {
			if (e.freq != "weekly") {
				return "";
			}
			
			return getHTML(e);
		});
		
		var monthly = AP.render(Client.pageData.repeated_tasks, function(e) {
			if (e.freq != "monthly") {
				return "";
			}
			
			return getHTML(e);
		});
		
		$("#js-weekly-group").after(weekly);
		$("#js-monthly-group").after(monthly);
		
		$("#repeated-list select").each(function() {
			$(this).val($(this).data("value"));
		}).on("change", function() {
			var val = $(this).val();
			var name = $(this).attr("name");
			
			var $row = $(this).closest(".js-item");
			var id = $row.data("id");
			
			MT.repeated.fix(id, name, val);
		});
		
		Form.inlineTagger("#repeated-list .user", {
			title:"Select user",
			multi: false,
			users: Client.people,
			select: function(user) {
				var $row = $(this).closest(".js-item");
				var id = $row.data("id");
				MT.repeated.fix(id, "assign", user.username);
			}
		});
		
		$("#repeated-list .-item").click(function() {

			var action = $(this).data("action");
			var $row = $(this).closest(".js-item");
			var id = $row.data("id");
			
			if (action == "remove") {
				MT.repeated.remove(id);
			}
			
			if (action == "force-run") {
				MT.repeated.dryRun(id);
			}
			
			if (action == "duplicate") {
				MT.repeated.duplicate(AP.array.findObj(Client.pageData.repeated_tasks, id));
			}
			
			if (action == "edit") {
				var e = AP.array.findObj(Client.pageData.repeated_tasks, id);
				if (e) {
					MT.repeated.edit(e);	
				}
			}

			if (action == "edit-subtask") {
				var e = AP.array.findObj(Client.pageData.repeated_tasks, id);
				if (e) {
					MT.repeated.subtask.editSubtasks(e);
				}
			}

			if (action == "edit-todo") {
				var e = AP.array.findObj(Client.pageData.repeated_tasks, id);
				if (e) {
					MT.repeated.todo.editTodos(e);
				}
			}
		});
	};
	
	
	this.create = function(type) {
		if (!type) {
			type = "weekly";
		}
		
		var data = {
			edit_repeated_task: 1
		};

		var form = Form.create('deliverable-fx', {action: 'api/mytask/repeated/create'})
		.row(
			Form.label({label: "TĂªn cĂ´ng viá»‡c *", "sublabel": "TĂªn cĂ´ng viá»‡c"}),
			Form.input({name: 'name', "placeholder": "TĂªn cĂ´ng viá»‡c *"})
		)
		.row(
			Form.label({label: "Táº§n suáº¥t láº·p láº¡i *", sublabel: "HĂ ng tuáº§n hoáº·c hĂ ng thĂ¡ng"}),
			Form.input({name: 'freq', "placeholder":"", type:"select", options: [{label:"HĂ ng tuáº§n", value: "weekly"}, {label:"HĂ ng thĂ¡ng", value: "monthly"}]}).value(type)
		)
		.row(
			Form.label({label: "CĂ¡c ngĂ y láº·p láº¡i *", sublabel: "Danh sĂ¡ch táº¥t cáº£ cĂ¡c ngĂ y láº·p láº¡i"}),
			Form.input({name: 'weekly_dates', type:"checkboxes", options: dowOptions()})
		)
		.row(
			Form.label({label: "CĂ¡c ngĂ y láº·p láº¡i *", sublabel: "Danh sĂ¡ch táº¥t cáº£ cĂ¡c ngĂ y láº·p láº¡i"}),
			Form.input({name: 'monthly_dates', type: "text", placeholder: "Danh sĂ¡ch ngĂ y, cĂ¡ch báº±ng dáº¥u cĂ¡ch hoáº·c dáº¥u pháº£y"})
		)
		.row(
			Form.label({label: "Dá»± Ă¡n &amp; phĂ²ng ban", "sublabel": "Chá»n dá»± Ă¡n &amp; phĂ²ng ban"}),
			Form.input({name: 'ns_id', "placeholder": "Chá»n dá»± Ă¡n &amp; phĂ²ng ban", type: "select", options: projectOptions()})
		)
		.row(
			Form.label({label: "NhĂ³m cĂ´ng viá»‡c", "sublabel": "Lá»±a chá»n nhĂ³m cĂ´ng viá»‡c"}),
			Form.input({name: 'tasklist_id', type: "select", options: []})
		)
		.row(
			Form.label({label: "Giao cho", "sublabel": "Tag ngÆ°á»i Ä‘Æ°á»£c giao"}),
			Form.input({name: 'assign', "placeholder":"Tag ngÆ°á»i Ä‘Æ°á»£c giao", role:"user"})
		)
		.row(
			Form.label({label: "Thá»i háº¡n", "sublabel":"Sá»‘ giá» cá»™ng thĂªm"}),
			Form.input({name: 'deadline', "placeholder": "VĂ­ dá»¥ 8, 8.5, hay 30.5 Ä‘á»ƒ trá»‘ng náº¿u khĂ´ng cĂ³ deadline", unit: "Giá»"})
		)
		.row(
			Form.label({label: "NgÆ°á»i theo dĂµi", "sublabel":"Danh sĂ¡ch ngÆ°á»i theo dĂµi"}),
			Form.input({name: 'followers', "placeholder":"Tag táº¥t cáº£ ngÆ°á»i cáº§n theo dĂµi cĂ´ng viá»‡c", role:"tag"})
		)
		.row(
			Form.label({label: "MĂ´ táº£ cĂ´ng viá»‡c", sublabel:"MĂ´ táº£ chá»‰ tiáº¿t cĂ´ng viá»‡c"}),
			Form.input({name: 'content', "placeholder":"MĂ´ táº£ cĂ´ng viá»‡c", type:"textarea", role:"editor"}).css({height: 100})
		)
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u", "sublabel":"Chá»n ngĂ y báº¯t Ä‘áº§u chu trĂ¬nh cĂ´ng viá»‡c láº·p láº¡i"}),
			Form.input({name: 'stime', "placeholder":"Chá»n ngĂ y báº¯t Ä‘áº§u", role:"date"}).value(AP.time.now())
		)
		.row(
			Form.label({label: "NgĂ y káº¿t thĂºc", "sublabel":"Chá»n ngĂ y káº¿t thĂºc chu trĂ¬nh cĂ´ng viá»‡c láº·p láº¡i"}),
			Form.input({name: 'etime', "placeholder":"Chá»n ngĂ y káº¿t thĂºc", role:"date"})
		)
		.row(
			Form.label({label: "Tráº¡ng thĂ¡i", "sublabel":"KĂ­ch hoáº¡t hay khĂ´ng kĂ­ch hoáº¡t"}),
			Form.input({name: 'status', "placeholder":"KĂ­ch hoáº¡t hay khĂ´ng kĂ­ch hoáº¡t", type: "select", options: statusOptions()})
		)
		.row(
			Form.label({label: "Danh sĂ¡ch nhĂ£n", sublabel: "Chá»n tá»« nhĂ£n dĂ¡n cá»§a dá»± Ă¡n hoáº·c phĂ²ng ban"}),
			Form.input({name: 'tags', type: "select", multiple: 1, placeholder: "Danh sĂ¡ch nhĂ£n", options: getTagOptions(null)})
		)
		.rowHTML("<div class='link'>TĂ¹y chá»n nĂ¢ng cao</div>")
		.wrap('CĂ´ng viá»‡c con', 'js-subtasks')
		.rowHTML('<div class="items-editor"></div>')
		.wrap()
		.wrap('Checklists', 'js-checklists')
		.rowHTML('<div class="items-editor"></div>')
		.wrap()
		.render(function(form) {

			initForm(form);
			initSubtasks();
			initChecklists();
			initTags(form);

			form.selector(".link").click(function() {
				$(this).hide();
				$("#js-subtasks").show();
				$("#js-checklists").show();
			});
		})
		.hiddens(data)
		.buttons([
			{label: "Táº¡o", action: function() {
				Form.submit("deliverable-fx", function(code) {
					if (!code.good()) {
						return AP.alertError(code.message);
					}
				
					Form.hide("deliverable-fx");
					UI.flash("Táº¡o thĂ nh cĂ´ng ...");
					AP.xRefresh();
				});
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function() {
				Form.hide("deliverable-fx");
			}, style:'-cancel -passive-2 rounded'}
		]);
			
		Form.pop({id:'deliverable-fx-dx', width: 760, label: 'ThĂªm cĂ´ng viá»‡c láº·p láº¡i', layout: 'inline'}).setForm(form).show();
	};
	
	
	this.edit = function(e) {

		var user = People.get(e.assign_to);
		
		var deadline = deadline;
		if (e.deadline && parseFloat(e.deadline) > 0.2) {
			deadline = e.deadline;
		}
		
		var opts = [];
		var project = Project.fromContext(e.ns_id);
		if (project) {
			opts = AP.select(project.cached_tasklists, function(e) {
				return {label: e.name, value: e.id};
			});
		}

		var data = {
			id: e.id,
			edit_repeated_task: 1
		};

		var form = Form.create('deliverable-fx',{action: 'api/mytask/repeated/edit'})
		.row(
			Form.label({label: "TĂªn cĂ´ng viá»‡c *", "sublabel":"TĂªn cĂ´ng viá»‡c"}),
			Form.input({name: 'name', "placeholder":"Task name, báº¯t buá»™c *"}).value(e.name)
		)
		.row(
			Form.label({label: "Táº§n suáº¥t láº·p láº¡i *", sublabel:"HĂ ng tuáº§n hoáº·c hĂ ng thĂ¡ng"}),
			Form.input({name: 'freq', "placeholder":"", type:"select", options: [{label:"HĂ ng tuáº§n", value: "weekly"}, {label:"HĂ ng thĂ¡ng", value: "monthly"}]}).value(e.freq).readOnly()
		)
		.row(
			Form.label({label: "CĂ¡c ngĂ y láº·p láº¡i *", sublabel: "Danh sĂ¡ch táº¥t cáº£ cĂ¡c ngĂ y láº·p láº¡i"}),
			Form.input({name: 'weekly_dates', type:"checkboxes", options: dowOptions()}).value(e.dates)
		)
		.row(
			Form.label({label: "CĂ¡c ngĂ y láº·p láº¡i *", sublabel: "Danh sĂ¡ch táº¥t cáº£ cĂ¡c ngĂ y láº·p láº¡i"}),
			Form.input({name: 'monthly_dates', type:"text", placeholder:"Danh sĂ¡ch ngĂ y, cĂ¡ch báº±ng dáº¥u cĂ¡ch hoáº·c dáº¥u pháº£y"}).value(e.dates.join(", "))
		)
		.row(
			Form.label({label: "Giao cho", "sublabel":"Tag ngÆ°á»i Ä‘Æ°á»£c giao"}),
			Form.input({name: 'assign', "placeholder":"Tag ngÆ°á»i Ä‘Æ°á»£c giao", role:"user"}).value("@"+user.username)
		)
		.row(
			Form.label({label: "Thá»i háº¡n", "sublabel":"Sá»‘ giá» cá»™ng thĂªm"}),
			Form.input({name: 'deadline', "placeholder":"VĂ­ dá»¥ 8, 8.5, hay 30.5 Ä‘á»ƒ trá»‘ng náº¿u khĂ´ng cĂ³ deadline", unit: "Giá»"}).value(deadline)
		)
		.row(
			Form.label({label: "NgÆ°á»i theo dĂµi", "sublabel":"Danh sĂ¡ch ngÆ°á»i theo dĂµi"}),
			Form.input({name: 'followers', "placeholder":"Tag táº¥t cáº£ ngÆ°á»i cáº§n theo dĂµi cĂ´ng viá»‡c", role:"tag"}).value(e.followers)
		)
		.row(
			Form.label({label: "Dá»± Ă¡n &amp; phĂ²ng ban", "sublabel":"Chá»n dá»± Ă¡n &amp; phĂ²ng ban"}),
			Form.input({name: 'ns_id', "placeholder":"Chá»n dá»± Ă¡n &amp; phĂ²ng ban", type: "select", options: projectOptions()}).value(e.ns_id)
		)
		.row(
			Form.label({label: "NhĂ³m cĂ´ng viá»‡c (tasklist)", "sublabel":"Lá»±a chá»n nhĂ³m cĂ´ng viá»‡c"}),
			Form.input({name: 'tasklist_id', "placeholder":"Lá»±a chá»n nhĂ³m cĂ´ng viá»‡c", type: "select", options: opts}).value(e.tasklist_id)
		)
		.row(
			Form.label({label: "MĂ´ táº£ cĂ´ng viá»‡c", sublabel:"MĂ´ táº£ chá»‰ tiáº¿t cĂ´ng viá»‡c"}),
			Form.input({name: 'content', "placeholder":"MĂ´ táº£ cĂ´ng viá»‡c", type:"textarea", role:"editor"}).css({height: 100}).value(e.content)
		)
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u", "sublabel":"Chá»n ngĂ y báº¯t Ä‘áº§u chu trĂ¬nh cĂ´ng viá»‡c láº·p láº¡i"}),
			Form.input({name: 'stime', "placeholder":"Chá»n ngĂ y báº¯t Ä‘áº§u", role:"date"}).value(e.stime)
		)
		.row(
			Form.label({label: "NgĂ y káº¿t thĂºc", "sublabel":"Chá»n ngĂ y káº¿t thĂºc chu trĂ¬nh cĂ´ng viá»‡c láº·p láº¡i"}),
			Form.input({name: 'etime', "placeholder":"Chá»n ngĂ y káº¿t thĂºc", role:"date"}).value(e.etime)
		)
		.row(
			Form.label({label: "Tráº¡ng thĂ¡i", "sublabel":"KĂ­ch hoáº¡t hay khĂ´ng kĂ­ch hoáº¡t"}),
			Form.input({name: 'status', "placeholder":"KĂ­ch hoáº¡t hay khĂ´ng kĂ­ch hoáº¡t", type: "select", options: statusOptions()}).value(e.status)
		)
		.row(
			Form.label({label: "Danh sĂ¡ch nhĂ£n", sublabel: "Chá»n tá»« nhĂ£n dĂ¡n cá»§a dá»± Ă¡n hoáº·c phĂ²ng ban"}),
			Form.input({name: 'tags', type: "select", multiple: 1, placeholder:"Danh sĂ¡ch nhĂ£n", options: getTagOptions(e)}).value(e.tags)
		)
		.rowHTML("<div class='link'>TĂ¹y chá»n nĂ¢ng cao</div>")
		.wrap('CĂ´ng viá»‡c con', 'js-subtasks')
		.rowHTML('<div class="items-editor"></div>')
		.wrap()
		.wrap('Checklists', 'js-checklists')
		.rowHTML('<div class="items-editor"></div>')
		.wrap()
		.render(function(form) {

			initForm(form, e);
			initSubtasks(e);
			initChecklists(e);
			initTags(form, e);

			form.selector(".link").click(function() {
				$(this).hide();
				$("#js-subtasks").show();
				$("#js-checklists").show();
			});
		})
		.hiddens(data)
		.buttons([
			{label: "Chá»‰nh sá»­a", action: function() {
				Form.submit("deliverable-fx", function(code) {
					if (!code.good()) {
						return AP.alertError(code.message);
					}
				
					Form.hide("deliverable-fx");
					UI.flash("HoĂ n thĂ nh chá»‰nh sá»­a");
					AP.refresh();
				});
			}, style: 'ok -success -rounded bold'},
			{label: "Bá» qua", action: function() {
				Form.hide("deliverable-fx");
			}, style:'-cancel -passive-2 rounded'}
		]);
			
		Form.pop({id:'deliverable-fx-dx', width: 720, label: 'Chá»‰nh sá»­a cĂ´ng viá»‡c láº·p láº¡i', layout: 'inline'}).setForm(form).show();
	};
	
	
	this.duplicate = function(e) {

		var user = People.get(e.assign_to);
		
		var deadline = deadline;
		if (e.deadline && parseFloat(e.deadline) > 0.2) {
			deadline = e.deadline;
		}
		
		var opts = [];
		var project = Project.fromContext(e.ns_id);
		if (project) {
			opts = AP.select(project.cached_tasklists, function(e) {
				return {label: e.name, value: e.id};
			});
		}

		var data = {
			id: e.id,
			freq: e.freq,
			edit_repeated_task: 1
		};

		var form = Form.create('deliverable-fx',{action: 'api/mytask/repeated/create'})
		.row(
			Form.label({label: "TĂªn cĂ´ng viá»‡c *", "sublabel":"TĂªn cĂ´ng viá»‡c"}),
			Form.input({name: 'name', "placeholder":"Task name, báº¯t buá»™c *"}).value(e.name+" (Copy)")
		)
		.row(
			Form.label({label: "Táº§n suáº¥t láº·p láº¡i *", sublabel:"HĂ ng tuáº§n hoáº·c hĂ ng thĂ¡ng"}),
			Form.input({name: 'freqx', "placeholder":"", type:"select", options: [{label:"HĂ ng tuáº§n", value: "weekly"}, {label:"HĂ ng thĂ¡ng", value: "monthly"}]}).value(e.freq).readOnly()
		)
		.row(
			Form.label({label: "CĂ¡c ngĂ y láº·p láº¡i *", sublabel: "Danh sĂ¡ch táº¥t cáº£ cĂ¡c ngĂ y láº·p láº¡i"}),
			Form.input({name: 'weekly_dates', type:"checkboxes", options: dowOptions()}).value(e.dates)
		)
		.row(
			Form.label({label: "CĂ¡c ngĂ y láº·p láº¡i *", sublabel: "Danh sĂ¡ch táº¥t cáº£ cĂ¡c ngĂ y láº·p láº¡i"}),
			Form.input({name: 'monthly_dates', type:"text", placeholder:"Danh sĂ¡ch ngĂ y, cĂ¡ch báº±ng dáº¥u cĂ¡ch hoáº·c dáº¥u pháº£y"}).value(e.dates.join(", "))
		)
		.row(
			Form.label({label: "Giao cho", "sublabel":"Tag ngÆ°á»i Ä‘Æ°á»£c giao"}),
			Form.input({name: 'assign', "placeholder":"Tag ngÆ°á»i Ä‘Æ°á»£c giao", role:"user"}).value("@"+user.username)
		)
		.row(
			Form.label({label: "Thá»i háº¡n", "sublabel":"Sá»‘ giá» cá»™ng thĂªm"}),
			Form.input({name: 'deadline', "placeholder":"VĂ­ dá»¥ 8, 8.5, hay 30.5 Ä‘á»ƒ trá»‘ng náº¿u khĂ´ng cĂ³ deadline", unit: "Giá»"}).value(deadline)
		)
		.row(
			Form.label({label: "NgÆ°á»i theo dĂµi", "sublabel":"Danh sĂ¡ch ngÆ°á»i theo dĂµi"}),
			Form.input({name: 'followers', "placeholder":"Tag táº¥t cáº£ ngÆ°á»i cáº§n theo dĂµi cĂ´ng viá»‡c", role:"tag"}).value(e.followers)
		)
		.row(
			Form.label({label: "Dá»± Ă¡n &amp; phĂ²ng ban", "sublabel":"Chá»n dá»± Ă¡n &amp; phĂ²ng ban"}),
			Form.input({name: 'ns_id', "placeholder":"Chá»n dá»± Ă¡n &amp; phĂ²ng ban", type: "select", options: projectOptions(true)}).value(e.ns_id)
		)
		.row(
			Form.label({label: "NhĂ³m cĂ´ng viá»‡c (tasklist)", "sublabel":"Lá»±a chá»n nhĂ³m cĂ´ng viá»‡c"}),
			Form.input({name: 'tasklist_id', "placeholder":"Lá»±a chá»n nhĂ³m cĂ´ng viá»‡c", type: "select", options: opts}).value(e.tasklist_id)
		)
		.row(
			Form.label({label: "MĂ´ táº£ cĂ´ng viá»‡c", sublabel:"MĂ´ táº£ chá»‰ tiáº¿t cĂ´ng viá»‡c"}),
			Form.input({name: 'content', "placeholder":"MĂ´ táº£ cĂ´ng viá»‡c", type:"textarea", role:"editor"}).css({height: 100}).value(e.content)
		)
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u", "sublabel":"Chá»n ngĂ y báº¯t Ä‘áº§u chu trĂ¬nh cĂ´ng viá»‡c láº·p láº¡i"}),
			Form.input({name: 'stime', "placeholder":"Chá»n ngĂ y báº¯t Ä‘áº§u", role:"date"}).value(e.stime)
		)
		.row(
			Form.label({label: "NgĂ y káº¿t thĂºc", "sublabel":"Chá»n ngĂ y káº¿t thĂºc chu trĂ¬nh cĂ´ng viá»‡c láº·p láº¡i"}),
			Form.input({name: 'etime', "placeholder":"Chá»n ngĂ y káº¿t thĂºc", role:"date"}).value(e.etime)
		)
		.row(
			Form.label({label: "Tráº¡ng thĂ¡i", "sublabel":"KĂ­ch hoáº¡t hay khĂ´ng kĂ­ch hoáº¡t"}),
			Form.input({name: 'status', "placeholder":"KĂ­ch hoáº¡t hay khĂ´ng kĂ­ch hoáº¡t", type: "select", options: statusOptions()}).value(e.status)
		)
		.row(
			Form.label({label: "Danh sĂ¡ch nhĂ£n", sublabel: "Chá»n tá»« nhĂ£n dĂ¡n cá»§a dá»± Ă¡n hoáº·c phĂ²ng ban"}),
			Form.input({name: 'tags', type: "select", multiple: 1, placeholder:"Danh sĂ¡ch nhĂ£n", options: getTagOptions(e)}).value(e.tags)
		)
		.rowHTML("<div class='link'>TĂ¹y chá»n nĂ¢ng cao</div>")
		.wrap('CĂ´ng viá»‡c con', 'js-subtasks')
		.rowHTML('<div class="items-editor"></div>')
		.wrap()
		.wrap('Checklists', 'js-checklists')
		.rowHTML('<div class="items-editor"></div>')
		.wrap()
		.render(function(form) {

			initForm(form, e);
			initSubtasks(e);
			initChecklists(e);
			initTags(form, e);

			form.selector(".link").click(function() {
				$(this).hide();
				$("#js-subtasks").show();
				$("#js-checklists").show();
			});
		})
		.hiddens(data)
		.buttons([
			{label: "NhĂ¢n báº£n", action: function() {
				Form.submit("deliverable-fx", function(code) {
					if (!code.good()) {
						return AP.alertError(code.message);
					}
				
					Form.hide("deliverable-fx");
					UI.flash("HoĂ n thĂ nh chá»‰nh sá»­a");
					AP.refresh();
				});
			}, style: 'ok -success -rounded bold'},
			{label: "Bá» qua", action: function() {
				Form.hide("deliverable-fx");
			}, style:'-cancel -passive-2 rounded'}
		]);
		
		Form.pop({id:'deliverable-fx-dx', width: 720, label: 'Duplicate cĂ´ng viá»‡c láº·p láº¡i', layout: 'inline'}).setForm(form).show();
	};
	
	
	this.remove = function(id) {
		AP.confirm("Please confirm that you want to remove this repeated task. This cannot be undone", function() {
			UI.ajaxShow();
			AP.post("api/mytask/repeated/remove", {id: id}, function(code) {
				UI.ajaxHide();
				
				if (!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Removed successfully");
				AP.refresh();
			});
		});
	};
	
	
	this.fix = function(id, key, value) {
		UI.ajaxShow();
		AP.post("api/mytask/repeated/fix", {id: id, key: key, value: value}, function(code) {
			UI.ajaxHide();
			
			if (!code.good()) {
				return AP.alertError(code.message);
			}
			
			UI.flash("Chá»‰nh sá»­a thĂ nh cĂ´ng");
			AP.refresh();
		});
	};
	
	
	this.dryRun = function(id) {
		AP.confirm("Force initializing this repeated task?", function() {
			UI.ajaxShow();
			AP.post("api/mytask/repeated/dryrun", {id: id}, function(code) {
				UI.ajaxHide();
				if (!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Run successfully ("+code.num_tasks+" tasks created)");
			});
		});
	};

	
	/**
	 * @desc Get a HTML to render a repeated tasks
	 */
	function getHTML(task) {

		var p = People.get(task.assign_to);
		var user = "<div class='user'>" +
		"	<div class='avatar avatar-32'><div class='user-add'></div></div>" +
		"	<div class='name'>ChÆ°a Ä‘Æ°á»£c giao</div>" +
		"	<div class='title'>Báº¥m Ä‘á»ƒ giao viá»‡c</div>" +
		"</div>";
		
		if (p && parseInt(p.id)) {
			user = "<div class='user relative' data-value='"+p.id+"' title='"+p.name+"'>" +
			"	<div class='avatar avatar-32 -circled'><div class='image'><img src='"+AP.xthumb(p.gavatar)+"'/></div></div>" +
			"	<div class='name'>"+p.name+"</div>" +
			"	<div class='title absolute xo' style='right:0px; left:40px;'><div class=' ap-xdot'>"+p.title+"</div></div>" +
			"</div>";
		}
		
		var etime = " infinite";
		if (parseInt(task.etime)) {
			etime = AP.i18n.date(task.etime);
		}

		var update_time = (task.data.base_date) ? UI.simpleTime(task.data.base_date) : "";

		var dates_display = getDatesDisplay(task.dates, task.freq);

		var subtasks = "";
		var todos = "";
		if (task.subtasks.length) {
			subtasks = "<div class='extra -item' data-action='edit-subtask'><span class='-ap icon-uniF12A'></span> "+task.subtasks.length+" subtasks &nbsp;</div>";
		}

		if (task.checklists.length) {
			todos = "<div class='extra -item' data-action='edit-todo'><span class='-ap icon-uniF10E'></span> "+task.checklists.length+" todos &nbsp;</div>";
		}

		return "" +
		"<tr class='js-item' data-id='"+task.id+"'>" +
		"	<td>" +
		"		<div class='main -s"+task.status+"'>" +
		"			<div class='name -item ap-xdot' data-action='edit' data-id='"+task.id+"' title='"+task.name+"'>"+task.name+"	</div>" +
				subtasks +
				todos +
		"			<div class='desc ap-xdot' title='"+safe(task.content)+"'>"+safe(task.content)+"&nbsp;</div> " +
		"		</div>" +
		"	</td>" +
		"	<td>" +
		"		<div class='freq'><div class='d -item pointer ap-xdot' data-action='edit' title='"+dates_display+"'>"+dates_display+"</div></div>" +
		"		<div class='duration'>"+AP.i18n.dateRange(task.stime, task.etime)+"</div>" +
		"	</td>" +
		"	<td>" +
		"		<div class='freq'><div class='updated -item pointer'>"+update_time+"</div></div>" +
		"	</td>" +
		"	<td>"+user+"</td>" +
		"	<td>" +
		"		<div class='select'>" +
		"			<select name='ns_id' data-value='"+task.ns_id+"'>"+projectSelections()+"</select>" +
		"		</div>" +
		"	</td>" +
		"	<td>" +
		"		<div class='select'>" +
		"			<select name='status' data-value='"+task.status+"'>" +
		"				<option value='0'>VĂ´ hiá»‡u hĂ³a</option><option value='1'>KĂ­ch hoáº¡t</option>" +
		"			</select>" +
		"		</div>" +
		"	</td>" +
		"	<td>" +
		"		<div class='cta -cmenuw'>" +
		"			<div class='cdot'><span class='-ap icon-dots-three-horizontal'></span></div>" +
		"			<div class='-cmenu -padding -no-icon absolute' style='top:27px; right:0px; width: 175px'>" +
		"				<div class='-item' data-action='edit'>Chá»‰nh sá»­a</div>" +
		"				<div class='-item' data-action='force-run'>Force run</div>" +
		"				<div class='-item' data-action='duplicate'>NhĂ¢n báº£n</div>" +
		"				<div class='-item' data-action='edit-subtask'>Chá»‰nh sá»­a cĂ´ng viá»‡c con</div>" +
		"				<div class='-item' data-action='edit-todo'>Chá»‰nh sá»­a todo</div>" +
		"				<div class='-item' data-action='remove'>XĂ³a</div>" +
		"			</div>" +
		"		</div>" +
		"	</td>" +
		"</tr>";
	};
	
	
	function dowOptions() {
		return [
			{label: "Thá»© 2", value: 2}, 
			{label: "Thá»© 3", value: 3},
			{label: "Thá»© 4", value: 4}, 
			{label: "Thá»© 5", value: 5}, 
			{label: "Thá»© 6", value: 6}, 
			{label: "Thá»© 7", value: 7}, 
			{label: "Chá»§ nháº­t", value: 8}
		];
	};

	
	function statusOptions() {
		return [
			{label: "KĂ­ch hoáº¡t", value: 1}, 
			{label: "VĂ´ hiá»‡u hĂ³a", value: 0}
		];
	};

	
	function projectOptions(change_project) {

		if (Client.pageData.context && !change_project) {
			var project = Client.pageData.context;
			var r = [{label: "["+project.metatype+"] " + project.name, value: project.id}];
			return r;
		} else {
			var r = AP.select(Client.projects, function(e) {
				if (!e.acl || !parseInt(e.acl.task_create) || !e.name || !e.name.length) {
					return "";
				}
				
				return {label: "["+e.metatype+"] " + e.name, value: e.id};
			});
			
			if (Client.pageData.context) {
				var priority_project = AP.array.findObj(Client.projects, Client.pageData.context.id);
				if (!priority_project) {
					var project = Client.pageData.context;
					r.unshift({label: "["+project.metatype+"] " + project.name, value: project.id});
				}
			}
			
			r.unshift({label: "--Chá»n dá»± Ă¡n &amp; phĂ²ng ban--", value: 0});
			
			return r;
		}
	};
	
	
	function projectSelections(change_project) {
		var ps = projectOptions(change_project);
		return AP.render(ps, function(e) {
			return "<option value='"+e.value+"'>"+e.label+"</option>";
		});
	};
	
	
	function getDatesDisplay(dates, freq) {

		if (!dates.length) {
			return "NONE";
		}
		
		if (freq == "weekly") {
			var cn = false;
			var html = AP.render(dates, function(e) {
				e = parseInt(e);
				if (e == 8) {
					cn = true;
					return "";
				} else {
					return "," + e;
				}
			});
			
			if (html.length) {
				html = "T" + html.substr(1);
			}
			
			if (cn) {
				if (html.length) {
					return html + ",CN";
				} else {
					return "CN";
				}
			} else {
				return html;
			}
		} else {
			return dates.join(", ");
		}
	};

	
	function initForm(form, e) {

		form.find("freq").on("change", function() {
			var val = $(this).val();
			if (val == "weekly") {
				form.findRow("weekly_dates[]").show();
				form.findRow("monthly_dates").hide();
			} else {
				form.findRow("monthly_dates").show();
				form.findRow("weekly_dates[]").hide();
			}
		}).change();
		
		if (e && e.ns_id) {
			form.find("ns_id").val(e.ns_id);	
		}

		form.find("ns_id").on("change", function() {

			form.findRow("tasklist_id").find(".improve-select.unselectable").remove();

			var val = $(this).val();
			if (val && parseInt(val)) {

				var project = Project.fromContext(val);
				if (!project) {
					form.find("tasklist_id").html("<option value='0'>-- Lá»±a chá»n --</option>");
				} else {
					var opts = AP.render(project.cached_tasklists, function(e) {
						return "<option value='"+e.id+"'>"+e.name+"</option>";
					});
					
					form.find("tasklist_id").html(opts);

					if (e && e.tasklist_id) {
						var tasklist = AP.array.findObj(project.cached_tasklists, e.tasklist_id);
						if (tasklist && tasklist.id) {
							form.find("tasklist_id").val(tasklist.id);
						}
					}
				}
			} else {
				form.find("tasklist_id").html("<option value='0'>--Lá»±a chá»n --</option>");
			}

			Form.select.improve(form.find("tasklist_id"));
		}).change();

		if (e && e.tasklist_id) {
			form.find("tasklist_id").val(e.tasklist_id);
		}
		
		Form.select.improve(form.find("ns_id"));
	};


	function initSubtasks(obj) {

		var subtasks_length = 0;
		var items = "";

		if (typeof obj != "undefined") {
			var subtasks = obj.subtasks;
			subtasks_length = subtasks.length;
			items = AP.render(subtasks, function(e, index) {
				return getRowSubtask(e, index);
			});
		}

		for (var i = subtasks_length; i < 50; i++) {
			items += getEmptyRowSubtask(i);
		}

		var html = "<table> <thead> <tr> <td style='width:20px'><span class='ficon-hashtag'></span></td> <td>CĂ´ng viá»‡c con *</td> <td style='width:80px'>Giao cho</td> <td style='width:100px'>Thá»i háº¡n (giá»)</td> <td style='width:120px'>MĂ´ táº£</td> <td style='width:120px'>NgÆ°á»i theo dĂµi</td> </tr> </thead> <tbody>"+(items)+"</tbody> </table>";

		$("#js-subtasks .row.-html .items-editor").html(html);

		balanceSubtasks();

		// Improve tag users input
		Tag.singleUser("#js-subtasks input[data-role='tag']", Client.people);

		Tag.user("#js-subtasks textarea[data-role='tag']", Client.people);
	};


	function initChecklists(obj) {

		var checklists_length = 0;
		var items = "";

		if (typeof obj != "undefined") {
			var checklists = obj.checklists;
			checklists_length = checklists.length;
			items = AP.render(checklists, function(e, index) {
				return getRowChecklist(e, index);
			});
		}
		
		for (var i = checklists_length; i < 50; i++) {
			items += getEmptyRowChecklist(i);
		}

		var html = "<table> <thead> <tr> <td style='width:35px'><span class='ficon-hashtag'></span></td> <td>Cáº§n lĂ m *</td> <td style='width:130px'>Giao cho</td> </tr> </thead> <tbody>"+(items)+"</tbody> </table>";

		$("#js-checklists .row.-html .items-editor").html(html);

		balanceChecklists();
		
		Tag.singleUser("#js-checklists input[data-role='tag']", Client.people);
	};


	function balanceSubtasks() {

		$("#js-subtasks .items-editor .js-subtask-empty").each(function() {
			var index = $(this).index(".js-subtask-empty");	
			
			if (index > 1) {
				$(this).hide();
			}

			$(this).on("click", function() {
				var row = $(this).data("row");
				var next = $(this).nextAll().filter(".js-subtask-empty");

				next.each(function() {
					if ($(this).data("row") == row+1) {
						$(this).show();
					}
				});
			});
		});

		$("#js-subtasks .items-editor .description").hide();
		$("#js-subtasks .items-editor .js-description").click(function() {
			var key = $(this).data('name');
			$("textarea[name="+(key)+"]").closest('td.description').toggle();
			setDesLabel(key);
		});

		$("#js-subtasks .items-editor .followers").hide();
		$("#js-subtasks .items-editor .js-followers").click(function() {
			var key = $(this).data('name');
			$("textarea[name="+(key)+"]").closest('td.followers').toggle();
			setDesLabel(key);
		});
	};


	function balanceChecklists() {
		$("#js-checklists .items-editor .js-checklist-empty").each(function() {
			var index = $(this).index(".js-checklist-empty");
			if (index > 0) {
				$(this).hide();
			}
			
			$(this).on("click", function() {
				$(this).next().show();
			});
		});
	};


	/**
	 * Toggle label of description action when description content is empty
	 * @param {*} key 
	 */
	function setDesLabel(key) {
		var value = $("textarea[name="+(key)+"]").val();
		value = safe(value);
		var des_label = value ? 'Chá»‰nh sá»­a' : 'ThĂªm';
		$(".items-editor div[data-name="+(key)+"]").html(des_label);
		if (value) {
			$(".items-editor div[data-name="+(key)+"]").removeClass('-add');
		} else {
			$(".items-editor div[data-name="+(key)+"]").addClass('-add');
		}
	};


	function p2nl(text) {
		return text.replace(/(<\/p>)/g, "\n").replace(/(<p>)/g, "");
	};


	function getRowSubtask(item, index) {

		var deadline = "";
		if (item.deadline) {
			deadline = parseFloat(item.deadline).toFixed(2);
		}
		
		var usernames = AP.word.join(item.users, " ",function(e) {
			return "@" + e;
		});

		var followers = item.followers ? AP.word.join(item.followers, " ", function(e) {
			return "@" + e;
		}) : '';

		var description = item.description ? p2nl(Base64.decode(item.description)) : '';
		var des_label = safe(description) ? 'Chá»‰nh sá»­a' : 'ThĂªm';
		var des_class = safe(description) ? '' : '-add';

		var followers_des_label = safe(followers) ? 'Chá»‰nh sá»­a' : 'ThĂªm';
		var followers_des_class = safe(followers) ? '' : '-add';

		return "<tr class='js-row-"+(index+1)+"'> <td rowspan='3'> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> <input type='hidden' class='thick' name='item-subtask-id-"+(index+1)+"' value='"+(item.key)+"'/> </td> <td> <div class='inner -name'><input name='item-subtask-name-"+(index+1)+"' type='text' placeholder='CĂ´ng viá»‡c con #"+(index+1)+"' value='"+(item.value)+"'/></div> </td> <td> <div class='inner'><input data-role='tag' data-context='global' name='item-subtask-assign-"+(index+1)+"' type='text' placeholder='GĂµ @ Ä‘á»ƒ tag' value='"+(usernames)+"'/></div> </td> <td> <div class='inner'><input name='item-subtask-hours-"+(index+1)+"' type='text' placeholder='Thá»i háº¡n (giá»)' value='"+(deadline)+"'/></div> </td> <td> <div class='inner'><div class='cta url js-description "+(des_class)+"' data-name='item-subtask-description-"+(index+1)+"'>"+(des_label)+"</div></div> </td> <td> <div class='inner'><div class='cta url js-followers "+(followers_des_class)+"' data-name='item-subtask-followers-"+(index+1)+"'>"+(followers_des_label)+"</div></div> </td> </tr> <tr class='js-row-"+(index+1)+"'> <td colspan='5' class='description inner'> <textarea rows='5' name='item-subtask-description-"+(index+1)+"' placeholder='MĂ´ táº£ cá»§a cĂ´ng viá»‡c con'>"+(description)+"</textarea> </td> </tr> <tr class='js-row-"+(index+1)+"'> <td colspan='5' class='followers inner'> <textarea rows='5' data-role='tag' data-context='global' name='item-subtask-followers-"+(index+1)+"' placeholder='Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn theo dĂµi'>"+(followers)+"</textarea> </td> </tr>";
	};

	
	function initTags(form, task) {

		form.findRow('ns_id').find('select').on('change', function() {

			var project = Project.fromContext($(this).val());
			if (!project) {
				return;
			}

			form.findRow('tags').find('.unselectable').remove();
			form.find('tags').html(AP.render(project.tags, function(e) {
				return "<option value='"+(e.key)+"'>"+(e.name)+"</option>"
			}));

			Form.improveSelect(form.find('tags'), {
				multiple: 1,
				empty: '',
				value: task ? task.tags : []
			});
		});
	};


	function getTagOptions(task) {

		var project = null;
		if (task) {
			project = Project.fromContext(task.ns_id);
		}

		if (!project) {
			project = Client.pageData.project;
		}

		if (project && project.tags) {
			return AP.array.select(project.tags, function (tag) {
				return {
					label: tag.name,
					value: tag.key
				};
			});
		}

		return [];
	};

	
	function getEmptyRowSubtask(index) {

		return "<tr class='js-row-"+(index+1)+" js-subtask-empty' data-row='"+(index+1)+"'> <td rowspan='3'> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> </td> <td> <div class='inner -name'><input name='item-subtask-name-"+(index+1)+"' type='text' placeholder='CĂ´ng viá»‡c con #"+(index+1)+"'/></div> </td> <td> <div class='inner'><input name='item-subtask-assign-"+(index+1)+"' type='text' data-role='tag' data-context='global' placeholder='GĂµ @ Ä‘á»ƒ tag'/></div> </td> <td> <div class='inner'><input name='item-subtask-hours-"+(index+1)+"' type='text' placeholder='Thá»i háº¡n (giá»)'/></div> </td> <td> <div class='inner'><div class='cta url js-description -add' data-name='item-subtask-description-"+(index+1)+"'>ThĂªm</div></div> </td> <td> <div class='inner'><div class='cta url js-followers -add' data-name='item-subtask-followers-"+(index+1)+"'>ThĂªm</div></div> </td> </tr> <tr class='js-row-"+(index+1)+" js-subtask-empty' data-row='"+(index+1)+"'> <td colspan='5' class='description inner'> <textarea rows='5' name='item-subtask-description-"+(index+1)+"' placeholder='MĂ´ táº£ cá»§a cĂ´ng viá»‡c con'></textarea> </td> </tr> <tr class='js-row-"+(index+1)+"'> <td colspan='5' class='followers inner'> <textarea rows='5' data-role='tag' data-context='global' name='item-subtask-followers-"+(index+1)+"' placeholder='Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn theo dĂµi'></textarea> </td> </tr>";
	};


	function getRowChecklist(item, index) {

		var usernames = AP.word.join(item.users, " ",function(e) {
			return "@" + e;
		});

		return "<tr class='js-row-"+(index+1)+"'> <td> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> <input type='hidden' name='item-todo-id-"+(index+1)+"' value='"+(item.key)+"'/> </td> <td> <div class='inner -name'><input name='item-todo-name-"+(index+1)+"' type='text' placeholder='Cáº§n lĂ m #"+(index+1)+"' value='"+(item.value)+"'/></div> </td> <td> <div class='inner'><input data-role='tag' data-context='global' name='item-todo-assign-"+(index+1)+"' type='text' placeholder='GĂµ @ Ä‘á»ƒ tag' value='"+(usernames)+"'/></div> </td> </tr>";
	};
	
	
	function getEmptyRowChecklist(index) {
		return "<tr class='js-row-"+(index+1)+" js-checklist-empty'> <td> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> </td> <td> <div class='inner -name'><input name='item-todo-name-"+(index+1)+"' type='text' placeholder='Cáº§n lĂ m #"+(index+1)+"'/></div> </td> <td> <div class='inner'><input name='item-todo-assign-"+(index+1)+"' type='text' data-role='tag' data-context='global' placeholder='GĂµ @ Ä‘á»ƒ tag'/></div> </td> </tr>";
	};
	
};


MT.repeated.subtask = new function __MyTaskRepeatedSubtask() {
	
	/**
	 * @desc Edit subtasks within obj.subtasks - show in dialog
	 */
	this.editSubtasks = function(obj) {

		var endpoint = "api/mytask/repeated/edit.subtask";

		var title = "Chá»‰nh sá»­a cĂ´ng viá»‡c con cá»§a "+(obj.name)+"";
		
		var items = AP.render(obj.subtasks, function(e, index) {
			return getRow(e, index);
		});
		
		for (var i = obj.subtasks.length; i < 50; i++) {
			items += getEmptyRow(i);
		}	
		
		var buttons = "<div class='buttons'> <div class='button ok -success bold' onclick='MT.repeated.subtask.submit(this);'>LÆ°u</div> <div class='button cancel -passive-2' onclick='AP.closeDialog(this);'>Há»§y</div> </div>";
		
		var html = "<div class='-close' onclick='AP.closeDialog(this);'></div> <form action='"+(endpoint)+"'> <input type='hidden' name='id' value='"+(obj.id)+"'/> <input type='hidden' name='edit_repeated_task' value='1'/> <div class='title'>"+(title)+"</div> <div class='items-editor'> <table> <thead> <tr> <td style='width:35px'><span class='ficon-hashtag'></span></td> <td>CĂ´ng viá»‡c con *</td> <td style='width:80px'>Giao cho</td> <td style='width:120px'>Thá»i háº¡n (giá»)</td> <td style='width:120px'>MĂ´ táº£</td> <td style='width:120px'>NgÆ°á»i theo dĂµi</td> </tr> </thead> <tbody>"+(items)+"</tbody> </table> </div> "+(buttons)+" </form>";
		
		AP.customDialog(html, {
			id: "items-editor",
		}).width(760).addClass("-full").show();
		
		balance();

		// Improve tag users input
		Tag.singleUser("#items-editor input[data-role='tag']", Client.people);
		Tag.user("#items-editor textarea[data-role='tag']", Client.people);
	};
	
	
	/**
	 * @desc Submit the edit subtasks form
	 */
	this.submit = function(ref) {
		Form.submitFrom(ref, function(code) {
			if (!code.good()) {
				return AP.alertError(code.message);
			}
			
			AP.refresh();
		});
	};
	
	
	function balance() {
		$("#items-editor .js-empty").each(function() {
			var index = $(this).index(".js-empty");	
			
			if (index > 1) {
				$(this).hide();
			}

			$(this).on("click", function() {
				var row = $(this).data("row");
				var next = $(this).nextAll().filter(".js-empty");

				next.each(function() {
					if ($(this).data("row") == row+1) {
						$(this).show();
					}
				});
			});
		});

		$("#items-editor .description").hide();
		$("#items-editor .js-description").click(function() {
			var key = $(this).data('name');
			$("textarea[name="+(key)+"]").closest('td.description').toggle();

			setDesLabel(key);
		});

		$("#items-editor .followers").hide();
		$("#items-editor .js-followers").click(function() {
			var key = $(this).data('name');
			$("textarea[name="+(key)+"]").closest('td.followers').toggle();
			setDesLabel(key);
		});
	};
	

	/**
	 * Toggle label of description action when description content is empty
	 * @param {*} key 
	 */
	 function setDesLabel(key) {
		var value = $("textarea[name="+(key)+"]").val();
		value = safe(value);

		var des_label = value ? 'Chá»‰nh sá»­a' : 'ThĂªm';
		$(".items-editor div[data-name="+(key)+"]").html(des_label);

		if (value) {
			$(".items-editor div[data-name="+(key)+"]").removeClass('-add');
		} else {
			$(".items-editor div[data-name="+(key)+"]").addClass('-add');
		}
	};


	function p2nl(text) {
		return text.replace(/(<\/p>)/g, "\n").replace(/(<p>)/g, "");
	};


	function getRow(item, index) {

		var deadline = "";
		if (item.deadline) {
			deadline = parseFloat(item.deadline).toFixed(2);
		}
		
		var usernames = AP.word.join(item.users, " ",function(e) {
			return "@" + e;
		});

		var followers = item.followers ? AP.word.join(item.followers, " ",function(e) {
			return "@" + e;
		}) : '';

		var description = item.description ? p2nl(Base64.decode(item.description)) : '';
		var des_label = safe(description) ? 'Chá»‰nh sá»­a' : 'ThĂªm';
		var des_class = safe(description) ? '' : '-add';

		var followers_des_label = safe(followers) ? 'Chá»‰nh sá»­a' : 'ThĂªm';
		var followers_des_class = safe(followers) ? '' : '-add';

		return "<tr class='js-row-"+(index+1)+"' data-row='"+(index+1)+"'> <td rowspan='3'> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> <input type='hidden' name='item-subtask-id-"+(index+1)+"' value='"+(item.key)+"'/> </td> <td> <div class='inner -name'><input name='item-subtask-name-"+(index+1)+"' type='text' placeholder='CĂ´ng viá»‡c con #"+(index+1)+"' value='"+(item.value)+"'/></div> </td> <td> <div class='inner'><input data-role='tag' data-context='global' name='item-subtask-assign-"+(index+1)+"' type='text' placeholder='GĂµ @ Ä‘á»ƒ tag' value='"+(usernames)+"'/></div> </td> <td> <div class='inner'><input name='item-subtask-hours-"+(index+1)+"' type='text' placeholder='Thá»i háº¡n (giá»)' value='"+(deadline)+"'/></div> </td> <td> <div class='inner'><div class='cta url js-description "+(des_class)+"' data-name='item-subtask-description-"+(index+1)+"'>"+(des_label)+"</div></div> </td> <td> <div class='inner'><div class='cta url js-followers "+(followers_des_class)+"' data-name='item-subtask-followers-"+(index+1)+"'>"+(followers_des_label)+"</div></div> </td> </tr> <tr class='js-row-"+(index+1)+"'> <td colspan='5' class='description inner'> <textarea rows='5' name='item-subtask-description-"+(index+1)+"' placeholder='MĂ´ táº£ cá»§a cĂ´ng viá»‡c con'>"+(description)+"</textarea> </td> </tr> <tr class='js-row-"+(index+1)+"'> <td colspan='5' class='followers inner'> <textarea rows='5' data-role='tag' data-context='global' name='item-subtask-followers-"+(index+1)+"' placeholder='Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn theo dĂµi'>"+(followers)+"</textarea> </td> </tr>";
	};
	
	
	function getEmptyRow(index) {
		
		return "<tr class='js-row-"+(index+1)+" js-empty' data-row='"+(index+1)+"'> <td rowspan='3'> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> </td> <td> <div class='inner -name'><input name='item-subtask-name-"+(index+1)+"' type='text' placeholder='CĂ´ng viá»‡c con #"+(index+1)+"'/></div> </td> <td> <div class='inner'><input name='item-subtask-assign-"+(index+1)+"' type='text' data-role='tag' data-context='global' placeholder='GĂµ @ Ä‘á»ƒ tag'/></div> </td> <td> <div class='inner'><input name='item-subtask-hours-"+(index+1)+"' type='text' placeholder='Thá»i háº¡n (giá»)'/></div> </td> <td> <div class='inner'><div class='cta url js-description -add' data-name='item-subtask-description-"+(index+1)+"'>ThĂªm mĂ´ táº£</div></div> </td> <td> <div class='inner'><div class='cta url js-followers -add' data-name='item-subtask-followers-"+(index+1)+"'>ThĂªm</div></div> </td> </tr> <tr class='js-row-"+(index+1)+" js-subtask-empty' data-row='"+(index+1)+"'> <td colspan='5' class='description inner'> <textarea rows='5' name='item-subtask-description-"+(index+1)+"' placeholder='MĂ´ táº£ cá»§a cĂ´ng viá»‡c con'></textarea> </td> </tr> <tr class='js-row-"+(index+1)+"'> <td colspan='5' class='followers inner'> <textarea rows='5' data-role='tag' data-context='global' name='item-subtask-followers-"+(index+1)+"' placeholder='Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn theo dĂµi'></textarea> </td> </tr>";
	};
};


MT.repeated.todo = new function __MyTaskRepeatedTodo() {
	
	/**
	 * @desc Edit todos within obj.todos - show in dialog
	 */
	this.editTodos = function(obj) {

		var endpoint = "api/mytask/repeated/edit.todo";

		var title = "Chá»‰nh sá»­a todos cá»§a "+(obj.name)+"";
		
		var items = AP.render(obj.checklists, function(e, index) {
			return getRow(e, index);
		});
		
		for (var i = obj.checklists.length; i < 50; i++) {
			items += getEmptyRow(i);
		}	
		
		var buttons = "<div class='buttons'> <div class='button ok -success bold' onclick='MT.repeated.todo.submit(this);'>Save</div> <div class='button cancel -passive-2' onclick='AP.closeDialog(this);'>Cancel</div> </div>";
		
		var html = "<div class='-close' onclick='AP.closeDialog(this);'></div> <form action='"+(endpoint)+"'> <input type='hidden' name='id' value='"+(obj.id)+"'/> <div class='title'>"+(title)+"</div> <div class='items-editor'> <table> <thead> <tr> <td style='width:35px'><span class='ficon-hashtag'></span></td> <td>Todo *</td> <td style='width:130px'>Giao cho</td> </tr> </thead> <tbody>"+(items)+"</tbody> </table> </div> "+(buttons)+" </form>";
		
		AP.customDialog(html, {
			id: "items-editor",
		}).width(600).addClass("-full").show();
		
		balance();

		// Improve tag users input
		Tag.singleUser("#items-editor input[data-role='tag']", Client.people);
	};
	
	
	/**
	 * @desc Submit the edit subtasks form
	 */
	this.submit = function(ref) {
		Form.submitFrom(ref, function(code) {
			if (!code.good()) {
				return AP.alertError(code.message);
			}
			
			AP.refresh();
		});
	};
	
	
	function balance() {
		$("#items-editor .js-empty").each(function() {
			var index = $(this).index(".js-empty");
			if (index > 0){
				$(this).hide();
			}
			
			$(this).on("click", function() {
				$(this).next().show();
			});
		});
	};
	
	
	function getRow(item, index) {

		var usernames = AP.word.join(item.users, " ",function(e) {
			return "@" + e;
		});

		return "<tr class='js-row-"+(index+1)+"'> <td> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> <input type='hidden' name='item-todo-id-"+(index+1)+"' value='"+(item.key)+"'/> </td> <td> <div class='inner -name'><input name='item-todo-name-"+(index+1)+"' type='text' placeholder='Todo #"+(index+1)+"' value='"+(item.value)+"'/></div> </td> <td> <div class='inner'><input data-role='tag' data-context='global' name='item-todo-assign-"+(index+1)+"' type='text' placeholder='GĂµ @ Ä‘á»ƒ tag' value='"+(usernames)+"'/></div> </td> </tr>";
	};
	
	
	function getEmptyRow(index) {
		
		return "<tr class='js-row-"+(index+1)+" js-empty'> <td> <div class='inner'><div class='count'>"+(AP.data.zeroPrefix(index+1))+"</div></div> </td> <td> <div class='inner -name'><input name='item-todo-name-"+(index+1)+"' type='text' placeholder='Todo #"+(index+1)+"'/></div> </td> <td> <div class='inner'><input name='item-todo-assign-"+(index+1)+"' type='text' data-role='tag' data-context='global' placeholder='GĂµ @ Ä‘á»ƒ tag'/></div> </td> </tr>";
	};
};


MyTask.form = new function __MTForm() {

	/**
	 * @desc Init subheader form
	 */
	this.init = function() {

		var html = "<div id='subheader'> <div class='task-user-add -compact'> <div class='avatar'></div> <div class='txt'> <span class='action' onclick='Project.tform.dialog();'>Táº¡o cĂ´ng viá»‡c má»›i</span> </div> </div> <div class='side'> "+(this.master_filters)+" "+(this.status_filters)+" <div class='dd -cmenuw' data-param='project'> <em>All projects</em> <div class='-cmenu -padding -no-icon js-projects xo'> <div class='-item-filter'> <input type='text' name='js-search-pfilter' placeholder='Lá»c nhanh'/> </div> <div class='js-all-projects-filter scroll-y' style='max-height:300px; margin:0 -10px; padding:0 10px'> <div class='-item url' data-urlparam='project' data-value=''>Táº¥t cáº£ dá»± Ă¡n</div> </div> </div> </div> "+(this.sort_filters)+" </div> </div>";
		
		$("#js-myform").html(html);
		initProjects();
		initSubtaskFilters();
		bindStates();
		
		return;
	};
	
	
	/**
	 * @desc Init subheader for direct report team view
	 */
	this.initTeam = function() {

		var team_filters = AP.render(Client.pageData.users, function(e) {
			return "<div class='-item url' data-urlparam='user' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		});
		
		var html = "<div class='task-user-add -compact'> <div class='sicon'><span class='ficon-th-large'></span></div> <div class='txt'> <span class='stitle url' data-url='tasks/team'>NhĂ¢n viĂªn cá»§a tĂ´i</span> </div> </div> <div class='side'> <div class='dd -cmenuw' data-param='user'> <em>Táº¥t cáº£</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='user' data-value=''>Táº¥t cáº£</div> "+(team_filters)+" </div> </div> "+(this.status_filters)+" "+(this.sort_filters)+" </div>";
		
		$("#subheader").html(html);
		bindStates();
	};
	
	
	/**
	 * @desc Init subheader for following view
	 */
	this.initFollowing = function() {
		var html = "<div class='task-user-add -compact'> <div class='sicon'><span class='ficon-flash'></span></div> <div class='txt'> <span class='stitle url' data-url='tasks/following'>Äang theo dĂµi</span> </div> </div> <div class='side'> "+(this.following_status_filters)+" "+(this.sort_filters)+" </div>";
		
		$("#subheader").html(html);
		bindStates();
	};
	
	
	/**
	 * @desc Detecting query and set the active url, and active labels
	 */
	function bindStates() {
		$("#subheader .dd").each(function() {

			var $this = $(this);
			var p = $(this).data("param");

			$(this).find(".-item.url").each(function() {

				if ($(this).data("value") == Query.get(p) || (!$(this).data("value") && !Query.get(p))) {

					$(this).addClass("active selected");
					$this.find("em").html($(this).text());
					
					if ($(this).data("value") == Query.get(p) && Query.get(p)) {
						$this.find("em").addClass("active");
					} else {
						$this.find("em").removeClass("active");
					}
				}
			});
		});
	};
	
	
	function initProjects() {

		$("#js-myform .js-projects .js-all-projects-filter").append(AP.render(Client.projects, function(e) {
			return "<div class='-item ap-xdot url' data-urlparam='project' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		}));
		
		$("#js-myform .js-projects input").quickFilter("#js-myform .js-projects .js-all-projects-filter .url", function(e, q) {
			return AP.word.fulltextMatch($(e).text(), q);
		});
	};
	
	
	function initSubtaskFilters() {

		var cf = AP.log.getCookie("mytask_subtasks");
		if (!cf) {
			cf = "flatten";
		}
		
		if (cf == "none" || cf == "flatten") {
			AP.pageConfig.set("hide_all_subtasks", 1);
		}
		
		AP.pageConfig.set("subtasks", cf);
		
		$("#subheader select[name=js-subtask-options]").val(cf).on("change", function() {
			var v = $(this).val();
			AP.log.setCookie("mytask_subtasks", v);
			AP.xRefresh();
		});
	};
	
	
	this.status_filters = "<div class='dd -cmenuw' data-param='status'> <em>Táº¥t cáº£ tráº¡ng thĂ¡i</em> <div class='-cmenu -padding -no-icon'> <div class='-item url js-review-mark' data-urlparam='status' data-value=''>Táº¥t cáº£ tráº¡ng thĂ¡i</div> <div class='-item url' data-urlparam='status' data-value='active'>Äang thá»±c hiá»‡n (Cáº§n lĂ m & Äang lĂ m)</div> <div class='-item url' data-urlparam='status' data-value='notreview'>Äang thá»±c hiá»‡n vĂ  chÆ°a Ä‘Ă¡nh giĂ¡</div> <div class='-item url' data-urlparam='status' data-value='todo'>Cáº§n lĂ m</div> <div class='-item url' data-urlparam='status' data-value='doing'>Äang lĂ m</div> <div class='-item url' data-urlparam='status' data-value='done'>ÄĂ£ hoĂ n thĂ nh</div> <div class='-item url' data-urlparam='status' data-value='review'>Äang chá» Ä‘Ă¡nh giĂ¡</div> <div class='-item-sep'></div> <div class='-item url' data-urlparam='status' data-value='donelate'>HoĂ n thĂ nh muá»™n</div> <div class='-item url' data-urlparam='status' data-value='overdue'>QuĂ¡ háº¡n</div> <div class='-item url' data-urlparam='status' data-value='urgent'>Kháº©n cáº¥p</div> <div class='-item url' data-urlparam='status' data-value='important'>Quan trá»ng</div> </div> </div>";
	
	
	this.following_status_filters = "<div class='dd -cmenuw' data-param='status'> <em>Táº¥t cáº£ tráº¡ng thĂ¡i</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='status' data-value=''>Táº¥t cáº£ tráº¡ng thĂ¡i</div> <div class='-item url' data-urlparam='status' data-value='active'>Äang thá»±c hiá»‡n (Cáº§n lĂ m & Äang lĂ m)</div> <div class='-item url' data-urlparam='status' data-value='done'>ÄĂ£ hoĂ n thĂ nh</div> <div class='-item-sep'></div> <div class='-item url' data-urlparam='status' data-value='overdue'>QuĂ¡ háº¡n</div> </div> </div>";
	
	
	this.master_filters = "<div class='dd -cmenuw' data-param='set'> <em>Created &amp; assigned</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='set' data-value=''>Giao &amp; Ä‘Æ°á»£c giao</div> <div class='-item url' data-urlparam='set' data-value='assigned'>CV Ä‘Æ°á»£c giao</div> <div class='-item url' data-urlparam='set' data-value='created'>CV giao Ä‘i</div> <div class='sep-10'></div> <div class='select'> <select name='js-subtask-options'> <option value='flatten'>CĂ´ng viá»‡c &amp; cĂ´ng viá»‡c con</option> <option value='natural'>Má»™t cáº¥p cĂ´ng viá»‡c con</option> <option value='none'>KhĂ´ng cĂ³ cĂ´ng viá»‡c con</option> </select> </div> </div> </div>";
	
	
	this.sort_filters = "<div class='dd -cmenuw' data-param='order'> <em>Recently updated</em> <div class='-cmenu -padding -no-icon'> <div class='-item url' data-urlparam='order' data-value=''>Thá»i gian cáº­p nháº­t</div> <div class='-item url' data-urlparam='order' data-value='created'>Thá»i gian táº¡o</div> <div class='-item url' data-urlparam='order' data-value='deadline'>Thá»i háº¡n hoĂ n thĂ nh</div> </div> </div>";
};


MyTask.side = new function __MyTaskSide() {

	this.init = function() {

		initCanvas();
		initDirectReports();
		initViewerStats();
		initAlertProjects();
		
		MyTask.filter.init();
		Side.milestone.init();
		
		$("#js-side-milestones .milestone").each(function() {
			$(this).find(".name").addClass("url").data({"url":"milestone/"+$(this).data("id")})
		})
		
		$("#js-side-milestones .milestone .name").setActiveURLParam("milestone");
		
		if (Client.path && Client.path.current == "tasks/following") {
			$("#js-cfilters").parent().parent().hide();
			$("#js-side-milestones").parent().parent().hide();
		}
		
		if (Client.path && Client.path.current == "tasks/team") {
			$("#js-cfilters").parent().parent().hide();
			$("#js-side-milestones").parent().parent().hide();
		}
		
		if (Client.path && Client.path.current == "tasks/filter") {
			$("#js-side-milestones").parent().parent().hide();
		}
	};


	this.showMore = function() {

		// Show custom dialog for list milestones
		var html = AP.render(Client.pageData.alert_projects, getHTML);

		var max_height = $(window).height() - 200;
		max_height = max_height < 200 ? 200 : max_height;

		html = "<div class='title'> Cáº£nh bĂ¡o Æ°u tiĂªn <div class='-close' onclick='AP.closeDialog(this);'></div> </div> <div class='isearch'> <input type='text' id='selection-filter-ip' placeholder='TĂ¬m nhanh'/> </div> <div class='box' style='max-height:"+(max_height)+"px; overflow-y:auto;'> <div class='alert-projects'> "+(html)+" </div> </div>";

		AP.customDialog(html, "custom-selection").style("-full").width(500).show();
		$("#custom-selection").addClass("more-dialog");

		// Bind search event
		// Custom logic from AP.selectAction
		$("#selection-filter-ip").on("input", function() {
			local_filter($(this).val());
		});

		if (!Client.native){
			$("#selection-filter-ip").autofocus();
		}

		function local_filter(q) {
			$("#custom-selection .project").each(function() {
				var matched = false;
				if (!q || !q.length) {
					matched = true;
				} else {
					var str = $(this).text();
					matched = AP.word.fulltextMatch(str, q);
				}

				if (matched) {
					$(this).show();
				} else {
					$(this).hide();
				}
			});
		};
	};


	function getHTML(project) {

		var icon = "<span class='image'><img src='"+(Client.image_url)+"/icons/project.png'/></span>";
		icon = "<span class='icon-project -bg-alt"+(project.color)+"'><em>"+(purifyStrict(project.path).charAt(0))+"</em></span>";

		if (project.metatype == "team") {
			icon = "<span class='icon-team -bg-alt"+(project.color)+"'><em>"+(purifyStrict(project.path).charAt(0))+"</em></span>";
		}

		if (parseInt(project.icon)) {
			icon = "<span class='image'><img src='"+(Client.share_url)+"/fav_icons/"+(project.icon)+".png'/></span>";
		}

		var actions = "<div class='button url success' data-url='paction/"+(project.id)+"/alerttopriority'>ThĂªm Æ°u tiĂªn</div> <div class='button url error' data-url='paction/"+(project.id)+"/removealert'>Bá» qua</div>";

		return "<div class='project url'> <div class='main'> <span class='icon'>"+(icon)+"</span> <b><div class='name ap-xdot' title='"+(project.name)+"'>"+(project.name)+"</div></b> </div> <div class='actions'>"+(actions)+"</div> </div>";
	};


	function initCanvas() {

		var html = "<div class='section'> <div class='overview'> <div class='box projinfo -with-image'> <div class='image'><img src='"+(AP.xthumb(Client.viewer.gavatar))+"'/></div> <div class='projname'>"+(Client.viewer.name)+"</div> <div class='projdesc'> "+(Client.viewer.title)+"&nbsp; </div> <div id='js-me-side-stats'></div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-asterisk'></span></div> <div class='title -dd' title='In the last 07 days'>Má»›i Ä‘Æ°á»£c giao</div> </div> </div> <div class='subsection'> <div class='subheader'> <div class='icon'><span class='ficon-asterisk'></span></div> <div class='title -dd' title='In the last 07 days'>Má»›i giao Ä‘i</div> </div> </div> </div> <div class='section'> <div class='box'> <div class='box-title'>Cáº£nh bĂ¡o Æ°u tiĂªn</div> <div class='alert-projects' id='js-alert-projects'> </div> </div> </div> <div class='section js-milestones'> <div class='box'> <div class='box-title'>Má»¥c tiĂªu</div> <div id='js-side-milestones' class='body'></div> </div> </div> <div class='section'> <div class='box'> <div class='box-title'> Bá»™ lá»c tĂ¹y chá»‰nh <div class='action' id='js-filter-add'>+ ThĂªm</div> </div> <div class='sidelinks' id='js-cfilters'></div> </div> </div> <div class='section'> <div class='box' style='padding-bottom:0px;'> <div class='box-title'>NhĂ¢n viĂªn cá»§a tĂ´i</div> </div> <div class='body'> <div class='items' id='js-cmembers'></div> </div> </div>";
		
		$("#project-side").html(html);
	};
	
	
	function initViewerStats() {

		if (!Client.pageData.show_viewer) {
			return;
		}

		var total = 0;
		var done = 0;
		var urgencies = [];
		
		for (var i = 0; i < Client.pageData.tasks.length; i++) {
			var task = Client.pageData.tasks[i];
			if (task.user_id == Client.viewer.id) {
				if (parseInt(task.status)) {
					done++;
				} else {
					if (parseInt(task.urgent)) {
						urgencies.push(task);
					}
				}
				
				total++;
			}
		};
		
		var w = 0;
		if (total > 0) {
			w = done * 100 / total;
		}
		
		var html = "<div class='row'> <span class='ficon-check-square-o icon'></span> CĂ´ng viá»‡c Ä‘Æ°á»£c giao <div class='v -dd url inline'><b>"+(w.toFixed(2))+"</b>%</div> </div> <div class='bar -infow'> <div class='c' style='background-color: "+(Color.get(4))+"; width:"+(w)+"%'></div> </div> <div class='row -upper'><div class='v -full'>"+(done)+"/"+(total)+" hoĂ n thĂ nh</div></div>";
		
		$("#js-me-side-stats").html(html);
		
	};
	
	
	function initDirectReports() {

		var html = AP.render(Client.people, function(e) {
			if (!Me.isManagerOf(e)) {
				return "";
			}
			
			return "<div class='user url' data-url='user/"+(e.username)+"'> <div class='name'> <div class='main'>"+(e.name)+"</div> <div class='info ap-xdot'>"+(e.title)+"&nbsp;</div> </div> <div class='avatar avatar-32 -circled'><div class='image'><img src='"+(AP.xthumb(e.gavatar))+"'/></div></div> </div>";
		});
		
		$("#js-cmembers").html("<div class='people'><div class='subbox'>"+(html)+"</div></div>");
	};


	function initAlertProjects() {

		if (typeof Client.pageData.alert_projects != "undefined" && Client.pageData.alert_projects.length) {

			var show_alert_projects = 2;
			var alert_count = Client.pageData.alert_projects.length;
			var alert_projects = Client.pageData.alert_projects.slice(0, show_alert_projects);

			var html = AP.render(alert_projects, getHTML);

			$("#js-alert-projects").html(html);

			if (alert_count > alert_projects.length) {
				showMoreBlock("#js-alert-projects", {
					count: alert_count - alert_projects.length,
					url: 'paction/-/showmore.alert'
				});
			}
		} else {

			$("#js-alert-projects").closest(".section").hide();
		}
	};


	function showMoreBlock(box, options) {

		options = $.extend({}, {label: "Xem thĂªm", count: 1, url: ''}, options);
		$(box).append("<div class='project showmore url' data-url='"+(options.url)+"'>"+(options.label)+" ("+(options.count)+")</div>");
	};
};






MT.team = new function __MTTeam() {

	this.list = function() {
		var users = Client.pageData.users;
		users.sort(function(e, f) {
			if (e.stats.total == 0) {
				var e1 = 0;
			}

			if (f.stats.total == 0) {
				var f1 = 0;
			}

			if (parseInt(e.stats.total)) {
				var e1 = parseInt(e.stats.done) * 100 / parseInt(e.stats.total);
			}

			if (parseInt(f.stats.total)) {
				var f1 = parseInt(f.stats.done) * 100 / parseInt(f.stats.total);
			}

			if (Query.get("order") == 'quality') {
				return f1 - e1;
			} else {
				return parseInt(f.stats.total) - parseInt(e.stats.total);
			}
		});
		
		$("#js-users-group").html(AP.render(users, function(e) {
			return getHeader(e) + getProjects(e);
		}));
	};
	
	
	function getHeader(e) {
		var w1 = 0, w2 = 0;
		
		if (parseInt(e.stats.total)) {
			w1 = parseInt(e.stats.done) * 100 / parseInt(e.stats.total);
			w2 = parseInt(e.stats.overdue) * 100 / parseInt(e.stats.total);
		}
		
		return "<tr class='js-user-"+e.id+"'>" +
			"<td class='guser'>" +
			"	<div class='user url' onclick='MT.team.toMember(\""+e.username+"\")'>" +
			"		<div class='avatar avatar-32 -circled'><div class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></div></div>" +
			"		<div class='name'>"+e.name+"</div>" +
			"		<div class='info'>"+e.title+"</div>" +
			"	</div>" +
			"</td>" +
			"<td><b class='bc'>"+e.stats.project+"</b></td>" +
			"<td><b class='bc'>"+e.stats.total+"</b></td>" +
			"<td><b class='bc text-success'>"+e.stats.done+"</b></td>" +
			"<td><b class='bc'>"+e.stats.active+"</b></td>" +
			"<td><b class='bc'>"+e.stats.review+"</b></td>" +
			"<td><b class='bc'>"+e.stats.after+"</b></td>" +
			"<td><b class='bc text-error'>"+e.stats.overdue+"</b></td>" +
			"<td><div class='bar'><div class='p -done' style='width:"+w1+"%'></div> <div class='p -error' style='width:"+w2+"%'></div> </div></td>" +
		"</tr>";
	};


	this.toMember = function(username) {

		var filter = "";
		var variables = ["stime","etime","project","group"];
		var param = [];
		var params = [];
		var separator = "";
		
		for (i = 0; i < variables.length; i++) {
			if (Query.get(variables[i]) != null) {
				param = [];
			  	param["key"] = variables[i];
			  	param["value"] = Query.get(variables[i]);
			  	params.push(param);
			}
		}

		if (params.length) {
			for (i = 0; i < params.length; i++) {
				separator = i == 0 ? "?" : "&";
				filter = filter + separator + params[i]["key"] + "=" + params[i]["value"];
			}
		}

		window.open(Client.url + "/user/" + username + filter, '_blank');
    };

	
	function getProjects(e) {
		return "";
	};
};


MyTask.team.overview = new function __MyTaskTeamOverview() {

	this.filter = function() {

		$("#ut-filter input[name=stime]").data("value", Client.pageData.stime);
		$("#ut-filter input[name=etime]").data("value", Client.pageData.etime);

		if ($("#ut-filter input[name=query]").val()) {
			$("#ut-filter input[name=query]").after("<div class='-remove'><span class='-ap icon-close'></span></div>");
			$("#ut-filter .-remove").click(function() {
				$(this).closest(".input").find("input").val("").change();
			});	
		}
		
		$("#ut-filter .submit").click(function() {
			if ($("#ut-filter input[name=query]").length) {
				$("#ut-filter input[name=query]").change();	
			} else {
				AP.xRefresh();
			}
		});

		$("#js-user-projects").append(AP.render(Client.projects, function(e) {
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		}));

		// $("#ut-filter input[name=project]").setActiveData("value", Query.get("project"));
		
		Form.render("#ut-filter");
		
		$("#ut-filter .js-fx").on("change", function() {

			var val = $(this).val();
			var key = $(this).data("key");
			
			var obj = {};
			obj[key] = val;
			
			if (val == "" || val == 0) {
				obj[key] = null;
				AP.setURLParams(obj, true);
			} else {
				AP.setURLParams(obj, true);
			}
		});
	};
	
	
	this.list = function() {

		var tasks = Client.pageData.tasks;
		var users = Client.pageData.users;

		users = getDataInit(users);
		users = getDataTask(users, tasks);
		users = sortDataByOrder(users);
		
		$("#js-users-group").html(AP.render(users, function(e) {
			return getHTML(e);
		}));
	};


	function getDataInit(users) {

		for (i = 0; i < users.length; i++) {
			users[i].computed_data = {
				total: 0, 
				done: 0,
				overdue: 0,
				project: 0,
				active: 0,
				review: 0,
				done_late: 0
			};
		}

		return users;
	};


	function getDataTask(users, tasks) {

		var now = AP.time.now();

		var array_assignee_tasks = [];

		for (i = 0; i < tasks.length; i++) {

			if (tasks[i].username) {
				if (typeof array_assignee_tasks[tasks[i].username] == "undefined") {
					array_assignee_tasks[tasks[i].username] = [];
				}

				array_assignee_tasks[tasks[i].username].push(tasks[i]);
			}
		}

		for (i = 0; i < users.length; i++) {

			if (typeof array_assignee_tasks[users[i].username] != "undefined") {

				var array_user_assignee_tasks = array_assignee_tasks[users[i].username];

				for (j = 0; j < array_user_assignee_tasks.length; j++) {

					var task = array_user_assignee_tasks[j];

					users[i].computed_data.total++;

					if (task.status == 1) {
						users[i].computed_data.done++;
					}

					if (task.status == 0 && task.review == 0) {
						users[i].computed_data.active++;
					}

					if (task.status == 0 && task.review == 1) {
						users[i].computed_data.review++;
					}

					if (parseInt(task.deadline)) {
						if (task.status == 0 && now > parseInt(task.deadline)) {
							users[i].computed_data.overdue++;
						}
					}

					if (Compute.doneLate(task)) {
						users[i].computed_data.done_late++;
					}
				}
			}
		}

		return users;
	};


	function sortDataByOrder(users) {

		users.sort(function(e, f) {

			if (e.computed_data.total == 0) {
				var e1 = 0;
			}

			if (f.computed_data.total == 0) {
				var f1 = 0;
			}

			if (parseInt(e.computed_data.total)) {
				var e1 = parseInt(e.computed_data.done) * 100 / parseInt(e.computed_data.total);
			}

			if (parseInt(f.computed_data.total)) {
				var f1 = parseInt(f.computed_data.done) * 100 / parseInt(f.computed_data.total);
			}

			if (Query.get("order") == 'quality') {
				return f1 - e1;
			} else {
				return parseInt(f.computed_data.total) - parseInt(e.computed_data.total);
			}
		});

		return users;
	};
	
	
	function getHTML(e) {

		var w1 = 0, w2 = 0;
		
		if (parseInt(e.computed_data.total)) {
			w1 = parseInt(e.computed_data.done) * 100 / parseInt(e.computed_data.total);
			w2 = parseInt(e.computed_data.overdue) * 100 / parseInt(e.computed_data.total);
		}

		var title = e.title ? e.title : "ChÆ°a cĂ³ vá»‹ trĂ­"
		
		return "<tr class='js-user-"+e.id+"'>" +
			"<td class='guser'>" +
			"	<div class='user url' onclick='MT.team.toMember(\""+e.username+"\")'>" +
			"		<div class='avatar avatar-32 -circled'><div class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></div></div>" +
			"		<div class='name'>"+e.name+"</div>" +
			"		<div class='info'>"+title+"</div>" +
			"	</div>" +
			"</td>" +
			"<td><b class='bc'>"+e.computed_data.project+"</b></td>" +
			"<td><b class='bc'>"+e.computed_data.total+"</b></td>" +
			"<td><b class='bc text-success'>"+e.computed_data.done+"</b></td>" +
			"<td><b class='bc'>"+e.computed_data.active+"</b></td>" +
			"<td><b class='bc'>"+e.computed_data.review+"</b></td>" +
			"<td><b class='bc'>"+e.computed_data.done_late+"</b></td>" +
			"<td><b class='bc text-error'>"+e.computed_data.overdue+"</b></td>" +
			"<td><div class='bar'><div class='p -done' style='width:"+w1+"%'></div> <div class='p -error' style='width:"+w2+"%'></div> </div></td>" +
		"</tr>";
	};


	this.toMember = function(username) {

		var filter = "";
		var variables = ["stime", "etime", "project", "group"];
		var param = [];
		var params = [];
		var separator = "";
		
		for (i = 0; i < variables.length; i++) {
			if (Query.get(variables[i]) != null) {
				param = [];
			  	param["key"] = variables[i];
			  	param["value"] = Query.get(variables[i]);
			  	params.push(param);
			}
		}

		if (params.length) {
			for (i = 0; i < params.length; i++) {
				separator = i == 0 ? "?" : "&";
				filter = filter + separator + params[i]["key"] + "=" + params[i]["value"];
			}
		}

		window.open(Client.url + "/user/" + username + filter, '_blank');
    };
	
};
var UT=new function __UT(){
	
};



UT.list=new function __UTList(){
	this.init=function(opts){
		opts=$.extend({stats: true}, opts);
		
		if (opts.stats){
			this.showStats();	
		}
		
		var html="";
		var tasks=Client.pageData.tasks;
		var groups=UT.list.group(tasks, function(e){
			return {id: e.ns.id, name: e.ns.name};
		});
		
		for (var i=0; i<groups.length; i++){
			var g=groups[i];
			g.stats=computeBasicProjectStats(g);
			var tasks_html=AP.render(g.tasks, function(e){
				return Board.ui.getHTML(e);
			});
			
			html+="<div class='tasklist'> <div class='group-header'> <div class='collapse'><span class='-ap icon-triangle-right'></span></div> <div class='title pointer url' data-url='paction/0/tasklist.toggle'> "+(g.name)+" </div> </div> <div class='list tasks'>"+(tasks_html)+"</div> </div>";
		}
		
		
		var phtml=AP.render(groups, function(e){
			if (!e.stats.total){
				return "";
			}
			
			return "<div class='item js-item-"+e.id+"' data-project='"+e.id+"'>" +
				"<div class='ap-xdot label' title='"+e.name+"'>"+e.name+"</div>" +
				"<div class='num'><b>"+e.stats.total+"</b> CĂ´ng viá»‡c</div>" +
			"</div>";
		});
		
		if (Query.get("project")){
			phtml="<div class='item js-item' data-project='0'><div class='label'>Táº¥t cáº£ dá»± Ă¡n - phĂ²ng ban</div></div>"+phtml;
		}
		
		
		$("#js-user-project-links").html(phtml);
		
		$("#js-user-project-links .item").click(function(){
			var id=$(this).data("project");
			if (!id){
				AP.setURLParams({project: null}, true);	
			}else{
				AP.setURLParams({project: id}, true);
			}
		});
		
		$("#tasklists").html(html);
		
		
		$("#tasklists").click(function(e){
			Board.clean("#tasklists", e.target);
		});
	};


	this.mobile = function () {
		return this.showStats();
	};
	
	
	
	this.group=function(objs, group_fn){
		var groups={};
		for (var i=0; i<objs.length; i++){
			var g=group_fn(objs[i]);
			if (groups["__g"+g.id]){
				groups["__g"+g.id].tasks.push(objs[i]);
			}else{
				groups["__g"+g.id]={id: g.id, name: g.name, tasks: [objs[i]]}
			}
		}
		
		var r=[];
		for (var key in groups){
			r.push(groups[key]);
		}
		
		return r;
	};
	
	
	
	this.showStats=function(){
		var time = AP.time.now();
		var etime = Query.get("etime");
		if (etime) {
			etime_array = etime.split("/");
			etime_string = etime_array[1] + "/" + etime_array[0] + "/" + etime_array[2];
			time = AP.time.midnight(new Date(etime_string) / 1000);
		}
		
		var today=getDaily(time);
		
		var percent_todo = today.total ? (100 * today.todo / today.total) : 0;
		var percent_doing = today.total ? (100 * today.doing / today.total) : 0;
		var percent_done = today.total ? (100 * today.done / today.total) : 0;
		var percent_done_late = today.total ? (100 * today.done_late / today.total) : 0;
		var percent_done_ontime = today.total ? (100 * today.done_ontime / today.total) : 0;
		var percent_overdue = today.total ? (100 * today.overdue / today.total) : 0;
		var percent_active = today.total ? (100 * today.active / today.total) : 0;
		
		$("#js-executive-stats").html("<div class='keynum'><b>"+AP.data.numberFormat(today.total)+"</b> <em>CĂ´ng viá»‡c</em></div>" +
		"<div class='visuals'>" +
			"<div class='bar'>" +
			"	<div class='-b a' style='width: "+percent_todo+"%'></div>" +
			"	<div class='-b o' style='width: "+percent_doing+"%'%'></div>" +
			"	<div class='-b s' style='width: "+percent_done+"%'%'></div>" +
			"</div>" +
			"<div class='txt'>" +
			"	<b class='text-main url' data-xurl='action/filter/todo'>"+today.todo+"</b> cáº§n lĂ m &middot; " +
			"	<b class='text-alt6 url' data-xurl='action/filter/doing'>"+today.doing+"</b> Ä‘ang lĂ m &middot; " +
			"	<b class='text-success url' data-xurl='action/filter/done'>"+today.done+"</b> hoĂ n thĂ nh" +
			"</div>" +
		"</div>" +
		"<div class='xsep'></div>" +
		// "<div class='visuals'>" +
		// 	"<div class='bar'>" +
		// 	"	<div class='-b a' style='width: "+percent_active+"%'%'></div>" +
		// 	"	<div class='-b e' style='width: "+percent_overdue+"%'%'></div>" +
		// 	"	<div class='-b o' style='width: "+percent_done_late+"%'></div>" +
		// 	"	<div class='-b s' style='width: "+percent_done_ontime+"%'%'></div>" +
		// 	"</div>" +
		// 	"<div class='txt'>" +
		// 	"	<b class='text-main'>"+today.active+"</b> Ä‘ang thá»±c hiá»‡n &middot; " +
		// 	"	<b class='text-error'>"+today.overdue+"</b> quĂ¡ háº¡n &middot; " +
		// 	"	<b class='text-alt6'>"+today.done_late+"</b> hoĂ n thĂ nh sau háº¡n &middot; " +
		// 	"	<b class='text-success'>"+today.done_ontime+"</b> hoĂ n thĂ nh Ä‘Ăºng háº¡n" +
		// 	"</div>" +
		// "</div>" +
		"<div class='xsep'></div>" +
		"<div class='subnums'>" +
		"	<div class='subnum'><b class='text-alt7'><span class='url' data-xurl='action/filter/overdue'>"+AP.data.numberFormat(today.overdue)+"</span></b> <em>quĂ¡ háº¡n</em></div>" +
		"	<div class='subnum'><b class='text-alt8'><span class='url' data-xurl='action/filter/urgent'>"+AP.data.numberFormat(today.urgent)+"</span></b> <em>kháº©n cáº¥p</em></div>" +
		"</div>" +
		// "<div class='subnums'>" +
		// "	<div class='subnum'><b class='text-alt7'><span class='url' data-xurl='action/filter/reviewing'>"+AP.data.numberFormat(today.review)+"</span></b> <em>chá» Ä‘Ă¡nh giĂ¡</em></div>" +
		// "	<div class='subnum'><b class='text-alt8'><span class='url' data-xurl='action/filter/important'>"+AP.data.numberFormat(today.important)+"</span></b> <em>quan trá»ng</em></div>" +
		// "</div>" +
		"");
		
		
		var stime=parseInt(Client.pageData.cfilter.stime);
		var etime=parseInt(Client.pageData.cfilter.etime);
		
		var totals=[];
		var actives=[];
		var overdues=[];
		var reviews=[];
		var dones=[];
		var dates=[];
		
		for (var i=stime; i<etime; i=i+24*3600){
			var stat=getDaily(i);
			var d=AP.time.time("%d/%m", i);
			dates.push(d);
			
			totals.push([d, stat.total]);
			actives.push([d, stat.active]);
			dones.push([d, stat.done]);
			overdues.push([d, stat.overdue]);
		} 
		
		
		Highcharts.chart('container', {
			chart:{
				height: 190
			},
			title: {
				text: '',
				display: 'none'
			},
		
			yAxis: {
				title: {	
					text: null
				}
			},
			xAxis:{
				categories: dates
			},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'middle',
				itemStyle:{
					fontSize: '10px',
					fontWeight: 'normal'
				},
				itemWidth: 60
			},
			plotOptions: {
				series: {
					label: {
						connectorAllowed: false
					}
				},
			},
		
			series: [{
				name: 'Táº¥t cáº£',
				data: totals,
				type: "area",
				opacity: 0.2
			}, {
				name: 'HoĂ n thĂ nh',
				data: dones,
				color: "#7abd1a",
			}, {
				name: 'QuĂ¡ háº¡n',
				data: overdues,
				color: "rgba(230,40,40,0.8)",
				fillColor: "rgba(230,40,40,0.1)"
			}],
		
			responsive: {
				rules: [{
					condition: {
						maxWidth: 500
					},
					chartOptions: {
						legend: {
							layout: 'horizontal',
							align: 'center',
							verticalAlign: 'bottom'
						}
					}
				}]
			}
		
		});
	};
	
	
	
	function getDaily(ts){
		var total=0;
		var todo=0;
		var doing=0;
		var done=0;
		var done_late=0;
		var done_ontime=0;
		var overdue=0;
		var active=0;
		var urgent=0;
		var important=0;
		var review=0;

		for (var i=0; i<Client.pageData.tasks.length; i++){
			var e = Client.pageData.tasks[i];
			var since_int = parseInt(e.since);
			var status_int = parseInt(e.status);
			var start_time_int = parseInt(e.start_time);
			var completed_time_int = parseInt(e.completed_time);
			var deadline_int = parseInt(e.deadline);
			var urgent_int = parseInt(e.urgent);
			var important_int = parseInt(e.important);
			var review_int = parseInt(e.review);

			if (ts > since_int){
				total++;

				if (!status_int && ((start_time_int > ts) || (!start_time_int)) ){
					todo++;
				}

				if (!status_int && (start_time_int < ts && start_time_int > 0)){
					doing++;
				}
				
				if (status_int){
					done++;
				}

				if (status_int && deadline_int && completed_time_int > deadline_int ){
					done_late++;
				}

				if (status_int && ((deadline_int && completed_time_int < deadline_int) || !deadline_int)){
					done_ontime++;
				}

				if (!status_int && (deadline_int && deadline_int < ts)){
					overdue++;
				}

				if (!status_int && ((deadline_int && deadline_int > ts) || !deadline_int)){
					active++;
				}
				
				if (urgent_int){
					urgent++;
				}

				if (important_int){
					important++;
				}
				
				if (review_int){
					review++;
				}
			}
		}
		
		return {total: total, todo: todo, doing: doing, done:done, done_late: done_late, done_ontime: done_ontime, overdue: overdue, active: active, urgent: urgent, important: important, review: review, ts: ts};
	};
	
	
	
	function computeBasicProjectStats(p){
		var total=0;
		var active=0;
		var overdue=0;
		var done=0;
		var review=0;
		
		for (var i=0; i<p.tasks.length; i++){
			total++;
			if (parseInt(p.tasks[i].status)){
				done++;
			}else if(parseInt(p.tasks[i].review)){
				review++;
			}else{
				active++;
			}
			
			if (parseInt(p.tasks[i].overdue)){
				overdue++;
			}
		}
		
		return {total: total, active: active, overdue: overdue, done:done, review: review}
	};
	
	
};





UT.menu=new function __UTMenu(){
	this.init=function(){
		Online.loaded(function(){
			Wework.people.menu();
		});
	};
};


UT.filter=new function __UTFilter(){
	this.init=function(){
		$("#ut-filter input[name=stime]").data("value", Client.pageData.cfilter.stime);
		$("#ut-filter input[name=etime]").data("value", Client.pageData.cfilter.etime);
		

		if ($("#ut-filter input[name=query]").val()){
			$("#ut-filter input[name=query]").after("<div class='-remove'><span class='-ap icon-close'></span></div>");
			$("#ut-filter .-remove").click(function(){
				$(this).closest(".input").find("input").val("").change();
			});	
		}
		
		$("#ut-filter .submit").click(function(){
			if ($("#ut-filter input[name=query]").length){
				$("#ut-filter input[name=query]").change();	
			}else{
				AP.xRefresh();
			}
		});
		
		$("#js-user-projects").append(AP.render(Client.pageData.user_projects, function(e){
			return "<option value='"+e.id+"'>"+e.name+"</option>";
		}));
		
		Form.render("#ut-filter");
		
		$("#ut-filter .js-fx").on("change", function(){
			var val=$(this).val();
			var key=$(this).data("key");
			
			var obj={};
			obj[key]=encodeURIComponent(val);
			
			if (val=="" || val==0){
				obj[key]=null;
				AP.setURLParams(obj, true);
			}else{
				AP.setURLParams(obj, true);
			}
		});
	
	};
};


UT.side=new function __UTAssign(){
	this.init=function(){
		initCanvas();
		initDirectReports();
		initAssignerDelegation();
		
		// Init milestones
		if (Client.pageData.milestones){
			Side.milestone.init();	
		}else{
			$("#js-side-milestones").parent().hide();
		}
	};
	
	
	function initCanvas(){
		var html="<div class='section'> <div class='overview'> <div class='box projinfo -with-image'> <div class='image'><img src='"+(AP.xthumb(Client.pageData.user.gavatar))+"'/></div> <div class='projname'>"+(Client.pageData.user.name)+"</div> <div class='projdesc'>"+(Client.pageData.user.title)+"&nbsp;</div> </div> </div> <div id='ut-stats'> <div class='box'> <div class='executive' id='js-executive-stats'></div> </div> <div class='box -middle'> <div class='graph'> <div id='js-graph'><div id='container'></div></div> </div> </div> <div class='box'> <div class='title'>PhĂ¢n chia theo dá»± Ă¡n</div> <div class='items scroll-y forced-scroll' id='js-user-project-links'></div> </div> </div> </div> <div class='section js-milestones'> <div class='box'> <div class='box-title'>Má»¥c tiĂªu</div> <div id='js-side-milestones' class='body'></div> </div> </div> <div class='section hidden'> <div class='box'> <div class='box-title'> Bá»™ lá»c tĂ¹y chá»‰nh </div> <div class='sidelinks' id='js-cfilters'></div> </div> </div> <div class='section'> <div class='box' style='padding-bottom:0px;'> <div class='box-title'>NhĂ¢n viĂªn cá»§a tĂ´i</div> </div> <div class='body'> <div class='items' id='js-cmembers'></div> </div> </div> <div class='section'> <div class='box' style='padding-bottom:0px;'> <div class='box-title'>á»¦y quyá»n giao viá»‡c</div> </div> <div class='body'> <div class='items' id='js-delegates'></div> </div> </div>";
		
		$("#project-side").html(html);
	};
	
	
	function initDirectReports(){
		var people = Me.getDirectReports(Client.pageData.user);
		
		var html = AP.render(people, function(e){
			return "<div class='user url' data-url='user/"+(e.username)+"'> <div class='name'> <div class='main'>"+(e.name)+"</div> <div class='info ap-xdot'>"+(e.title)+"&nbsp;</div> </div> <div class='avatar avatar-32 -circled'><div class='image'><img src='"+(AP.xthumb(e.gavatar))+"'/></div></div> </div>";
		});
		
		$("#js-cmembers").html("<div class='people'><div class='subbox'>"+(html)+"</div></div>");
	};


	function initAssignerDelegation(){

		var html = '';

		if (Client.pageData.delegatees.length) {
			var delegate_people = AP.render(Client.pageData.delegatees, function(e){
				var u = People.get(e.username);

				if (u && parseInt(u.error)) {
					return;
				}

				return "<div class='user url' data-url='user/"+(u.username)+"'> <div class='name'> <div class='main'>"+(u.name)+"</div> <div class='info ap-xdot'>"+(u.title)+"&nbsp;</div> </div> <div class='avatar avatar-32 -circled'><div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'/></div></div> </div>";
			});

			html = "<div class='people'><div class='subbox'>"+(delegate_people)+"</div></div>";
		}
		
		$("#js-delegates").html(html);
	};
	
};
var Dept=new function __ProjectDept(){
	this.fromContext=function(id){
		return AP.array.findObj(Client.depts, id);
	};
	
	
	/**
	 * @desc Create a project dept
	 */
	this.create=function(){	
		var data={};
		var form=Form.create('fly-tasklist-fx',{'action': "api/dept/create"})
		.row(
			Form.label({label: "TĂªn department *"}),
			Form.input({name: 'name', placeholder: "TĂªn department"}).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "Quáº£n lĂ½ department"}),
			Form.input({name: 'owners', placeholder: "Quáº£n lĂ½ department cĂ³ thá»ƒ quáº£n lĂ½ má»¥c tiĂªu cá»§a department", role:"tag"})
		).addClass("-big")
		// .row(
		// 	Form.label({label: "Group accesses"}),
		// 	Form.input({name: 'teams', placeholder: "Leave blank to allow accesses for everyone", role:"teams"})
		// )
		.buttons([
			 {label: "Create", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Department created successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: "ThĂªm department má»›i", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Create a project dept
	 */
	this.edit=function(id){
		var dept=Dept.fromContext(id);
		if (!dept){
			return;
		}
		
		var data={id: dept.id};
		var form=Form.create('fly-tasklist-fx',{'action': "api/dept/edit"})
		.row(
			Form.label({label: "TĂªn department *"}),
			Form.input({name: 'name', placeholder: "TĂªn department"}).value(dept.name).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "Quáº£n lĂ½ department"}),
			Form.input({name: 'owners', placeholder: "Quáº£n lĂ½ department cĂ³ thá»ƒ quáº£n lĂ½ má»¥c tiĂªu cá»§a department", role:"tag"}).value(dept.owners)
		).addClass("-big")
		// .row(
		// 	Form.label({label: "Group accesses"}),
		// 	Form.input({name: 'teams', placeholder: "Leave blank to allow accesses for everyone", role:"teams"}).value(dept.teams)
		// )
		.buttons([
			 {label: "Save", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Department updated successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
		});


		Form.pop({id:'fly-tasklist-dx', width: 480, label: "Chá»‰nh sá»­a department", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Remove a department
	 */
	this.remove=function(id){
		// AP.alertError("Currently this function is not supported yet.");
		AP.confirm("Confirm to delete department? Only department without projects and milestones could be removed.", function(){
			UI.ajaxShow();
			AP.post("api/dept/remove",{id: id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Update successfully");
				AP.redirect("depts");
			});
		});
	};
	
	
	/**
	 * @desc Build an array of groups, each containing projects
	 */
	this.build=function(projects){
		if (!projects){
			projects=Client.projects;
		}
		
		var groups=AP.array.group(projects, function(e){
			if (!parseInt(e.group_id)){
				return getEmptyGroup(e);
			}
			
			var g=Project.group.get(e.group_id);
			if (!g){
				return getEmptyGroup(e);
			}
			
			return g;
		});
		
		return groups;
	};
	
	
	
	function getEmptyGroup(e){
		return {id:0, name: "Uncategorized", order: 0}
		
	};
};



Dept.side=new function __DeptSide(){
	this.init=function(){
		var owners=AP.render(Client.pageData.dept.owners, function(e){
			var u=People.get(e);
			if (!u || !parseInt(u.uid)){
				return '';
			}
			
			return "<div class='user url' data-username='"+(u.username)+"'> <div class='avatar avatar-32 -circled''> <div class='image'><img src='"+(AP.xthumb(u.gavatar))+"'></div> </div> <div class='name'> <div class='main'><em class='url username'>"+(u.name)+"</em></div> <div class='info ap-xdot'>"+(u.title)+"</div> </div> </div>";
		});
		
		
		var teams=AP.render(Client.pageData.dept.teams, function(e){
			var u=UserGroup.get(e);
			if (!u){
				return '';
			}
			
			return "<div class='user url'> <div class='avatar avatar-32 -circled'> "+(UI.textAvatar(u.name, 32))+" </div> <div class='name'> <div class='main' style='padding:8px 0 8px 0'> <em class='url username'>"+(u.name)+"</em> </div> </div> </div>";
		});
		
		
		
		$("#js-dept-owners").html("<div class='subheader'> <div class='icon'><span class='ficon-bookmark'></span></div> <div class='title -dd url' data-url=':active:parent:parent'> Quáº£n lĂ½ bá»Ÿi "+(AP.data.zeroPrefix(Client.pageData.dept.owners.length))+" thĂ nh viĂªn </div> </div> <div class='body'> <div class='people'> <div class='subbox'>"+(owners)+"</div> </div> </div>");
		
		
		$("#js-dept-teams").html("<div class='subheader'> <div class='icon'><span class='ficon-bullseye'></span></div> <div class='title -dd url' data-url=':active:parent:parent'> CĂ³ thá»ƒ tiáº¿p cáº­n bá»Ÿi "+(AP.data.zeroPrefix(Client.pageData.dept.teams.length))+" nhĂ³m </div> </div> <div class='body'> <div class='people'> <div class='subbox'>"+(teams)+"</div> </div> </div>");
		
		$("#js-side-projects").html(AP.render(Client.pageData.projects, function(e){
			return getProjects(e);
		}));
		
		$("#js-side-projects .js-complete-sektor").each(function () {
			$(this).angular({
				bg:"#eee",
				arc: true
			});
		});
	};
	
	
	
	function getProjects(e){
		var w=0;	
		if (parseInt(e.stats.total)){
			w=(parseInt(e.stats.complete)*100.0/parseInt(e.stats.total)).toFixed(1);
		}
		
		var content='ChÆ°a cĂ³ miĂªu táº£';
		if (e.content){
			content=e.content;
		}
		return "<div class='proj url' data-url='"+(e.path)+"'> <div class='icon'> <div id='js-status-"+(e.id)+"' class='js-complete-sektor' style='width:28px; height:28px' data-color='"+(Color.get(4))+"' data-stroke='13' data-percent='"+(w)+"'></div> </div> <div class='name'>"+(e.name)+"</div> <div class='bar'> <div class='c' style='width:"+(w)+"%'></div> </div> <div class='info ap-xdot'><em>"+(w)+"</em>% &middot; "+(safe(content))+"</div> </div>";
	};
	
};


Dept.milestone=new function __DeptMilestones(){
	this.list=function(){
		if (!Client.pageData.milestones){
			return;
		}
		
		Client.pageData.milestones.sort(function(e1, e2){
			return parseInt(e2.time)-parseInt(e1.time);
		});
		
		
		var html=AP.render(Client.pageData.milestones, function(e){
			return getHTML(e);
		});
		
		$("#js-dept-milestones").html(html);
		
		
		// Filter
		$("#js-dept-header-search").attr("placeholder", "Lá»c nhanh má»¥c tiĂªu").quickFilter("#collection .li", function($e, q){
			return AP.word.fulltextMatch($e.text(), q);
		});
	};
	
	
	function getHTML(e) {
		var ec = '';
		if (parseInt(e.time) >= AP.time.now()) {
			ec = '-active';
		}
		
		var u = People.get(e.user_id);
		var creator = People.get(e.creator_id);
		var p = Project.fromContext(e.project_id);
		
		if (!p) {
			p = {name: "Project #"+e.project_id, id: e.project_id, path: "project-"+e.project_id};
		}
		
		return "<tr class='tr li js-ms "+(ec)+"'> <td> <div class='ms-time'>"+(AP.time.time('<em>%V</em><span>%d/%m</span>', e.time))+"</div> </td> <td> <div class='ms'> <div class='ms-icon'></div> <div class='ms-title url' data-url='milestone/"+(e.id)+"'>"+(e.name)+"</div> <div class='info'>Táº¡o bá»Ÿi @"+(creator.username)+" lĂºc "+(AP.i18n.datetime(e.since))+"</div> </div> </td> <td> <div class='ms-project'> <span class='url' data-url='"+(p.path)+"'>"+(p.name)+"</span> </div> </td> <td> <div class='ms-bar' title='"+(e.done)+"/"+(e.total)+"'><div class='c' style='width:"+(e.complete)+"%'><div class='candy -black'></div></div></div> </td> <td> <div class='ms-owner url' data-username='"+(u.username)+"'> <div class='img'><img src='"+(AP.xthumb(u.gavatar))+"'/></div> <div class='uname ap-xdot'>"+(u.first_name)+"</div> </div> </td> </tr>";
	};
	
};


Dept.collection=new function __DeptCollection(){
	this.list=function(){
		var depts = AP.array.usort(Client.depts, function(e, f){
            if (e.alias < f.alias) {
             	return -1; 
         	}
		    if (e.alias > f.alias) {
		     	return 1; 
	    	}
		    return 0;
        });

		var html=AP.render(depts, function(e){
			
			var teams = "";
			if (e.teams.length){
				teams=AP.render(e.teams, function(t){
					var team=UserGroup.get(t);
					if (team === null) {
						return '';
					}

					return "<div class='avatar' title='"+(team.name)+"'>"+(UI.textAvatar(team.path, 32))+"</div>";
				});
			}
			
			return "<div class='item -compact'> <div class='w'> <div class='title url' data-url='dept/projects/"+(e.id)+"' title='"+(e.name)+" [ID: "+(e.id)+"]'>"+(e.name)+"</div> <div class='info'>Táº¡o bá»Ÿi @"+(e.username)+" lĂºc "+(AP.i18n.date(e.since))+"</div> <div class='users clear-fix'>"+(teams)+"</div> </div> </div>";
		});
		
		$("#js-depts").html(html);
		
		$("#header .side .search input").quickFilter("#collection .item", function($e, q){
			return AP.word.fulltextMatch($e.text(), q);
		});
	};
};


Dept.projectManager=new function __DeptProjectManager(){
	this.init=function(){
		// Filter
		$("#js-dept-header-search").attr("placeholder", "Lá»c nhanh dá»± Ă¡n - phĂ²ng ban").quickFilter("#list-projects .li", function($e, q){ 
			return AP.word.fulltextMatch($e.text(), q);
		});

		
		$("#list-projects th:eq(2)").hide();
		$("#list-projects tr").each(function(){
			$(this).find("td:eq(2)").hide();
		});
	};
};
var Milestone=new function __Milestone(){
	this.fromContext=function(id){
		if (Client.tempData && Client.tempData.milestone && parseInt(Client.tempData.milestone.id)==parseInt(id)){
			return Client.tempData.milestone;
		}
		
		return AP.array.findObj(Client.pageData.milestones, id);
	};
	
	this.display=function(id){
		return MilestoneDisplay.display(id);
	};
	
	
	/**
	 * @desc Create a new milestone
	 */
	this.create=function(){
		var data={project_id: Client.pageData.project.id};
		var form=Form.create('fly-tasklist-fx',{'action': "api/milestone/create"})
		.row(
			Form.label({label: "Má»¥c tiĂªu *"}),
			Form.input({name: 'name', placeholder: "TĂªn má»¥c tiĂªu"}).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "NgĂ y hoĂ n thĂ nh má»¥c tiĂªu *"}),
			Form.input({name: 'date', placeholder: "NgĂ y hoĂ n thĂ nh cá»§a má»¥c tiĂªu", role:"date"})
		).addClass("-big")
		.row(
			Form.label({label: "NgÆ°á»i chá»‹u trĂ¡ch nhiá»‡m *"}),
			Form.input({name: 'username', placeholder: "ThĂªm ngÆ°á»i chá»‹u trĂ¡ch nhiá»‡m", role:"user"})
		)
		.row(
			Form.label({label: "MĂ´ táº£"}),
			Form.input({name: 'content', placeholder: "MĂ´ táº£ má»¥c tiĂªu", type:"textarea"})
		)
		.row(
			Form.label({label: "LiĂªn káº¿t Ä‘áº¿n dá»± Ă¡n/phĂ²ng ban"}),
			Form.input({name: 'fake', placeholder: "", type:"fake"}).value(Client.pageData.project.name)
		)
		.buttons([
			 {label: "Táº¡o", action: function(){
				 Form.submit("#fly-tasklist-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("Milestone created successfully ...");
					 Form.hide("fly-tasklist-fx");
					 AP.refresh();
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			
		});

		Form.pop({id:'fly-tasklist-dx', width: 600, label: "Táº¡o má»¥c tiĂªu má»›i", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	
	/**
	 * @desc Edit a milestone
	 */
	this.edit=function(id){
		var m=Milestone.fromContext(id);
		if (!m){
			return;
		}
		
		var project=Project.fromContext(m.project_id);
		if (!project){
			return;
		}
		
		var data={project_id: project.id, id: m.id};
		var form=Form.create('fly-tasklist-fx',{'action': "api/milestone/edit"})
		.row(
			Form.label({label: "Má»¥c tiĂªu *"}),
			Form.input({name: 'name', placeholder: "TĂªn má»¥c tiĂªu"}).value(m.name).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "NgĂ y hoĂ n thĂ nh má»¥c tiĂªu *"}),
			Form.input({name: 'date', placeholder: "NgĂ y hoĂ n thĂ nh cá»§a má»¥c tiĂªu", role:"date"}).value(m.time)
		).addClass("-big")
		.row(
			Form.label({label: "NgÆ°á»i chá»‹u trĂ¡ch nhiá»‡m *"}),
			Form.input({name: 'username', placeholder: "ThĂªm ngÆ°á»i chá»‹u trĂ¡ch nhiá»‡m", role:"user"}).value("@"+m.username)
		)
		.row(
			Form.label({label: "MĂ´ táº£"}),
			Form.input({name: 'content', placeholder: "MĂ´ táº£ má»¥c tiĂªu", type:"textarea"}).value(m.content)
		)
		.rowHidden(
			Form.label({label: "Tráº¡ng thĂ¡i"}),
			Form.input({name: 'status', type:"select", options: [{label: "Äang thá»±c hiá»‡n", value:0}, {label: "Inactive", value:-1}]}).value(m.status)
		).addClass("-big")
		.buttons([
			 {label: "Táº¡o", action: function(){
				Form.submit("#fly-tasklist-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					UI.flash("Milestone updated successfully ...");
					Form.hide("fly-tasklist-fx");
					AP.refresh();
				})
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-tasklist-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			fref.find("content").autoExpand();
		});


		Form.pop({id:'fly-tasklist-dx', width: 600, label: "Chá»‰nh sá»­a má»¥c tiĂªu", layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};
	
	
	this.remove=function(id){
		var m=Milestone.fromContext(id);
		if (!m){
			return;
		}
		
		AP.confirmDelete("Confirm to delete this milestone? Task is not deleted but linking with this milestone is lost.", function(){
			UI.ajaxShow();
			AP.post("api/milestone/remove", {id: m.id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Milestone remove successfully ...");
				Form.hide("fly-tasklist-fx");
				AP.refresh();
			});
		});
	};
	
	
	
};







Milestone.project=new function __MileStoneProject(){	
	this.options=function(){
		var ms=null;
		
		if (Client.tempData){
			ms=Client.tempData.milestones;
		}
		
		if (!ms){
			ms=Client.pageData.milestones;
		}
		
		ms.sort(function(e1, e2){
			return parseInt(e2.time)-parseInt(e1.time);
		});
		
		var ts= AP.array.select(ms, function(e){
			if (!e.id){
				return {name: "KhĂ´ng cĂ³ má»¥c tiĂªu", id: 0, color: 0, key: 0};
			}
			
			var c=1;
			if (parseInt(e.time)<AP.time.now()){
				c=0;
			}
			
			return {name: e.name+' ('+AP.i18n.date(e.time)+')', id: e.id, color: c, key: e.id};
		});
		
		
		if (!AP.array.findObj(ts, 0)){
			ts.push({name: 'KhĂ´ng cĂ³ má»¥c tiĂªu', id: 0, color: 0, key: 0});
		}
		
		if (Project.isManager()){
			ts.push({name: 'Táº¡o má»¥c tiĂªu', id: -1, color: 0, key: -1});	
		}
		
		return ts;
	};
	
	
	/**
	 * @desc Get the HTML rendering the milestone of a single task
	 */
	this.getCellHTML=function(task){
		var ms=AP.array.findObj(Client.pageData.milestones, task.milestone_id);
		if (!ms){
			return "<div class='cell relative -dd url' data-url='action/"+(task.id)+"/table' data-field='milestone' data-acl='"+(task.acl.desc)+"' data-type='select' data-value='0'> <div class='ap-xdot'>--</div> </div>";
		}
		
		var now=AP.time.now();
		var time=parseInt(ms.time);
		
		var icon="<span class='ficon-arrow-circle-down text-a'></span>&nbsp; ";
		var name="<span class='text-a'>"+(ms.name)+"</span>";
		
		if (time > now){
			icon="<span class='ficon-arrow-circle-up text-success'></span>&nbsp; ";
			name="<span class='text-success thick'>"+(ms.name)+"</span>";
		}
		
		return "<div class='relative ap-xdot' title='"+(ms.name)+" | "+(AP.i18n.datetime(time))+"'>"+(icon)+" "+(name)+"</div>";
	};
	
};




MilestoneDisplay=new function __MSDisplay(){
	this.display=function(ms_id){
		AP.destroyDialog("#js-milestone-display");
		$("#s-milestone-display").remove();
		UI.ajaxShow();
		
		AP.customDialog("<div id='js-milestone-display'></div>", {id: "js-milestone-wrapper"})
		.width(800)
		.css({right: $.sbWidth()})
		.addClass("-full")
		.closable(false)
		.show();
		
		AP.loadInlineURL("dept/milestone", {id: ms_id}, "#js-milestone-display",{
			start: function(){
			}, end: function(){
				if (mobile()){
					$(document.body).addClass("xo");
					$("#document").hide();
				}
				
				AP.dialog("#js-milestone-display").balance();
			}, error: function(){
				MilestoneDisplay.close();
			}
		});

		Side.milestone.init();
		
		return;
	};
	
	
	/**
	 * @desc Safe close the milestone
	 */
	this.close=function(){
		if (!$("#js-milestone-display").length){
			return;
		}
		
		AP.destroyDialog("#s-milestone-display");
		AP.closeDialog("#js-milestone-display");
	};
	
	
	
	/**
	 * @desc Render a milestone
	 */
	this.render=function(ms){
		ms.stats=getStats(Client.tempData.tasks, ms);
		
		var content=ms.content;
		if (!content){
			content="<div class='-empty'>ChÆ°a cĂ³ miĂªu táº£</div>";
		}
		
		var user=People.get(ms.user_id);
		var creator=People.get(ms.creator_id);
		
		if (parseInt(ms.time)>AP.time.now()){
			left=AP.time.remain(ms.time)+" remained";
		}else{
			left=AP.time.ago(ms.time);
		}

		var links = '';
		if (Client.tempData.dept) {
			links = "<span class='url' data-url='"+(Client.tempData.dept.path)+"'>"+(Client.tempData.dept.name)+"</span> &rsaquo; <span class='url' data-url='"+(Client.tempData.project.path)+"'>"+(Client.tempData.project.name)+"</span>";
		} else {
			links = "<span class='url' data-url=''>ChÆ°a cĂ³ department</span> &rsaquo; <span class='url' data-url='"+(Client.tempData.project.path)+"'>"+(Client.tempData.project.name)+"</span>";
		}
		
		var html="<div class='nav'> <div class='links'> "+(links)+" </div> <div class='side'> <div class='action' onclick='Milestone.edit("+(ms.id)+")'>Chá»‰nh sá»­a</div> <div class='close' onclick='MilestoneDisplay.close();'><span class='-ap icon-close'></span></div> </div> </div> <div class='cover'> <div class='date'> <em>"+(AP.time.time('%V', ms.time))+"</em> <span>"+(AP.time.time('%d/%m/%y', ms.time))+"</span> </div> <div class='visual'> <div id='js-ms-pie' class='chart'></div> <div class='counter'>"+(ms.stats.total)+"<span>cĂ´ng viá»‡c</span></div> </div> <div class='main'> <div class='title'>"+(ms.name)+"</div> <div class='info'>Táº¡o bá»Ÿi <em class='url' data-username='"+(creator.username)+"'>"+(creator.name)+"</em> lĂºc "+(AP.i18n.datetime(ms.since))+" </div> <div class='info'>Thá»i gian: <em>"+(AP.time.time('%V, %d/%m/%Y',e.time))+"</em> &middot; "+(left)+"</div> <div class='info'>Linked project/team: <em class='url' data-url='"+(Client.tempData.project.path)+"'>"+(Client.tempData.project.name)+"</em></div> <div class='info'> <em>"+(ms.stats.total)+"</em> cĂ´ng viá»‡c &middot; <em>"+(ms.stats.done_ontime)+"</em> ht Ä‘Ăºng háº¡n &middot; <em>"+(ms.stats.done_late)+"</em> HoĂ n thĂ nh muá»™n &middot; <em>"+(ms.stats.overdue)+"</em> quĂ¡ háº¡n &middot; <em>"+(ms.stats.in_progress)+"</em> in progress <div class='side'><em>"+(ms.stats.percent.toFixed(2))+"</em>%</div> </div> </div> <div class='bar'> <div class='c' style='width:"+(ms.stats.percent)+"%'></div> </div> <div class='desc -nb'> <div class='title' style='padding:5px 0'>Thá»‘ng kĂª dá»±a trĂªn deadline má»¥c tiĂªu</div> <div class='info'> <em>"+(ms.stats.real_done_ontime)+"</em> ht Ä‘Ăºng háº¡n &middot; <em>"+(ms.stats.real_done_late)+"</em> HoĂ n thĂ nh muá»™n &middot; <em>"+(ms.stats.real_overdue)+"</em> quĂ¡ háº¡n &middot; <em>"+(ms.stats.real_in_progress)+"</em> in progress <em>"+(ms.stats.real_percent.toFixed(1))+"</em>% </div> </div> <div class='desc -nb'> <div class='title' style='padding:5px 0'>NgÆ°á»i chá»‹u trĂ¡ch nhiá»‡m</div> <div class='content user url' data-username='"+(user.username)+"'> <div class='image'><img src='"+(AP.xthumb(user.gavatar))+"'/></div> <div class='name ap-xdot'>"+(user.name)+"</div> </div> </div> <div class='desc'> <div class='title'>MiĂªu táº£ má»¥c tiĂªu</div> <div class='content'> "+(content)+" </div> </div> </div> <div class='section clear-fix'> <div class='header'> <div class='subtitle'>Danh sĂ¡ch cĂ´ng viá»‡c</div> <div class='tabs clear-fix'> <div class='tab active' data-tab='all'><span class='cb -all'></span><em>Táº¥t cáº£</em> ("+(ms.stats.total)+")</div> <div class='tab' data-tab='in_progress'><span class='cb -in_progress'></span><em>Äang xá»­ lĂ½</em> ("+(ms.stats.in_progress)+")</div> <div class='tab' data-tab='overdue'><span class='cb -overdue'></span><em>QuĂ¡ háº¡n</em> ("+(ms.stats.overdue)+")</div> <div class='tab' data-tab='late'><span class='cb -late'></span><em>HoĂ n thĂ nh muá»™n</em> ("+(ms.stats.done_late)+")</div> <div class='tab' data-tab='ontime'><span class='cb -ontime'></span><em>HT Ä‘Ăºng háº¡n</em> ("+(ms.stats.done_ontime)+")</div> </div> </div> <div class='ms-filter'> <div class='input'> <input type='text' id='ms-quick-filter' placeholder='Lá»c nhanh'/> </div> </div> <div class='body'> <div class='js-tasks ms-tasks'></div> </div> </div>";
		
		
		$("#milestone-display").html(html);
		showCharts(ms);
		renderTasks();
		
		$("#milestone-display .tabs .tab").click(function(){
			var v=$(this).data("tab");
			if (v=="all"){
				$(this).siblings().removeClass("active");
				$(this).addClass("active");
			}else{
				$(this).parent().children().first().removeClass("active");
				$(this).toggleClass("active");
			}
			
			filterTasks();
		});
		
		$("#ms-quick-filter").quickFilter("#milestone-display .js-tasks .task", function($e, q){
			var txt=$e.text();
			return AP.word.fulltextMatch(txt, q);
		});
		
		AP.dialog("#js-milestone-wrapper").balance();
	};
	
	
	
	
	function showCharts(ms){
		var stats={active: ms.stats.in_progress, done_ontime: ms.stats.done_ontime, done_late: ms.stats.done_late, overdue: ms.stats.overdue};
		
		$('#js-ms-pie').highcharts({
			credits:{
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true,
					innerSize: '80%'
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '9px'},
				enabled: false,
			},
			series: [{
				name: 'Tasks',
				colorByPoint: true,
				data: [{
					name: "Active (not done, not overdue - "+(stats.active)+")",
					y: stats.active,
				}, {
					name: "ht Ä‘Ăºng háº¡n ("+(stats.done_ontime)+")",
					y: stats.done_ontime,
					color: "#24ce0e"
				}, {
					name: "HoĂ n thĂ nh muá»™n ("+(stats.done_late)+")",
					y: stats.done_late,
					color: "#cebd0c"
				}, {
					name: "QuĂ¡ háº¡n ("+(stats.done_late)+")",
					y: stats.overdue,
					color:"#ce2a0d"
				}]
			}]
		});
	};
	
	
	
	/**
	 * @desc Rendering a list of tasks of a milestone
	 */
	function renderTasks(ms){
		var html=AP.render(Client.tempData.tasks, function(e){
			return getHTML(e);
		});
		
		$("#milestone-display .js-tasks").html(html);
	};
	
	
	function getHTML(e){
		var state=Task.ui.grandState(e);
		if (state=="done"){
			if (Compute.doneLate(e)){
				state="late";	
			}else{
				state="ontime";
			}
		}else{
			if (Compute.overdue(e)){
				state="overdue";
			}else{
				state="in_progress"
			}
		}
		
		
		
		var labels=Task.ui.labels(e);
		
		var u=People.get(e.user_id);
		var img='';
		if (u && parseInt(u.uid)){
			img="<img src='"+(AP.xthumb(u.gavatar))+"'/>";
		}
		
		var contents=[];
		if (e.content && e.content.length){
			contents.push(safe(e.content));
		}
		
		contents.push(AP.render(labels, function(e){
			if (e.role=="milestone"){
				return "";
			}
			return "<span class='tag "+(e.style)+"'>"+(e.name)+"</span>";
		}));
		
		var content=contents.join(' &middot; ');
		if (!content || !content.length){
			content='ChÆ°a cĂ³ miĂªu táº£';
		}
		
		var deadline=AP.time.time('<em>%V</em><span>%d/%m/%Y</span>', e.deadline);
		if (!parseInt(e.deadline)){
			deadline="<div class='none'>No deadline</div>";
		}
		
		return "<div class='task' data-state='"+(state)+"'> <div class='deadline'>"+(deadline)+"</div> <div class='status-wrapper'> <div class='status-icon -"+(state)+"'><span class='r'></span></div> </div> <div class='name url' data-url='task/"+(e.id)+"' data-feature='wework:wework_task_show:task'>"+(e.name)+"</div> <div class='content ap-xdot'>"+(content)+"</div> <div class='assignee'><div class='image'>"+(img)+"</div></div> </div>";
	};
	
	
	
	function getStats(tasks, ms){
		var stats={
			total: 0, in_progress:0, overdue: 0, done_late:0, done_ontime:0,
			real_in_progress:0, real_overdue: 0, real_done_late:0, real_done_ontime:0, real_percent: 0
		};
		
		for (var i=0; i<tasks.length; i++){
			stats.total++;
			if (Compute.doneLate(tasks[i])){
				stats.done_late++;
			}else if (Compute.doneOntime(tasks[i])){
				stats.done_ontime++;
			}else if (Compute.overdue(tasks[i])){
				stats.overdue++;
			}else{
				stats.in_progress++;
			}
			
			if (parseInt(tasks[i].status)){
				if (Compute.doneLateAgainst(tasks[i], ms.time)){
					stats.real_done_late++;
				}else{
					stats.real_done_ontime++;
				}
			}else{
				if (Compute.overdueAgainst(tasks[i], ms.time)){
					stats.real_overdue++;
				}else{
					stats.real_in_progress++;
				}
			}
			
		}
		
		
		
		stats.percent=0;
		if (stats.total){
			stats.percent=100*(stats.done_late+stats.done_ontime)/(stats.total);
			stats.real_percent=100*(stats.real_done_late+stats.real_done_ontime)/(stats.total);
		}
		
		return stats;
	};
	
	
	function filterTasks(){
		var actives=[];
		$("#milestone-display .tabs .tab.active").each(function(){
			actives.push($(this).data("tab"));
		});
		
		$("#milestone-display .js-tasks .task").each(function(){
			var state=$(this).data("state");
			if (actives.indexOf("all")!=-1 || actives.indexOf(state)!=-1){
				$(this).removeClass("search_hidden");
			}else{
				$(this).addClass("search_hidden");
			}
		});
	};
	
};
Project.people=new function __ProjectPeople(){
	this.add=function(){
		return Project.people.side.addMulti('member', Client.pageData.context);
	};
	
	this.context=function(ref, username){
		var edit_by_admin=[];
		
		var user=People.get(username);
		if (!user){
			return;
		}

        var metatype = (Client.pageData.context.metatype == 'project') ? 'Dá»± Ă¡n' : 'team';
        
		if (Project.isManager()){
			if (Project.isManager(user)){
				edit_by_admin=[{'type' :'sep'},
	   		    	{label: 'Bá» quyá»n quáº£n lĂ½ <b> '+metatype+'</b>', icon:"icon-uniF108", action: function(){
	   		    		Project.role.set(user,  "member");
	   		    	}},
	   		    	{type :'sep'},
	   		   		{label: 'XĂ³a <b>'+user.name+'</b> khá»i ' + metatype, icon:"icon-uniF11F", action: function(){
	   		   			Project.role.remove(user);
	   		   		}}
	   			];
			}else{
				edit_by_admin=[{'type' :'sep'},
				    {label: 'Set quyá»n quáº£n lĂ½ <b> '+metatype+'</b>', icon:"icon-star-empty", action: function(){
				    	Project.role.set(user, "owner");
				    }},
	   		    	{type :'sep'},
	   		   		{label: 'XĂ³a <b>'+user.name+'</b> khá»i ' + metatype, icon:"icon-uniF11F", action: function(){
	   		   			Project.role.remove(user);
	   		   		}}
	   			];
			}
			
		}
		
		return Context.menu(ref, {top: 30, left:-240, menu: [
 		    {label: 'Chat vá»›i <b>'+user.name+'</b>', 'icon': 'icon-uniF1D8', action: function(){
 		    	Base.message.peer(username, {'from': 'context'});
		    	Context.hide();
		    }},
		    {label: 'Xem profile cá»§a <b>'+user.name+'</b>', 'icon': 'icon-uniF1AB icm', action: Base.domain("account")+"/user/"+user.username},
		].concat(edit_by_admin)});
	
	};
	
};


Project.people.side=new function __ProjectPeopleSide() {
	this.display=function(canvas, mode) {
		var managed=parseInt(Client.pageData.context.acl.managed);
		var metatype = (Client.pageData.context.metatype == 'project') ? 'Quáº£n lĂ½ dá»± Ă¡n' : 'Quáº£n lĂ½ phĂ²ng ban';

		$(canvas).html("" +
			"<div class='subbox' id='js-sidebox-owners'>" +
			"	<div class='title url'><em>"+metatype+"</em><div class='actions'>" +
			(managed?"<div class='dd'><div class='cta' onclick=\"Project.people.side.addMulti('owner', Client.pageData.context);\">ThĂªm nhiá»u</div></div>":"") +
			"	</div>" +
			"</div>" +
			"	<div class='js-body body'></div>" +
			"</div>" +
			"<div class='subbox' id='js-sidebox-members'>" +
			"	<div class='title'><em>ThĂ nh viĂªn</em><div class='actions'>" +
			(managed?"<div class='dd'><div class='cta' onclick=\"Project.people.side.addMulti('member', Client.pageData.context);\">ThĂªm nhiá»u</div></div>":"") +
			"   </div>" +
			"</div>" +
			"	<div class='js-body body'></div>" +
			"</div>" +
			"<div class='subbox' id='js-sidebox-clients'>" +
			"	<div class='title'><em>Tk KhĂ¡ch</em><div class='actions'>" +
			(managed?"<div class='dd'><div class='cta' onclick=\"Project.people.side.addMulti('guest', Client.pageData.context);\">ThĂªm nhiá»u</div></div>":"") +
			"   </div>" +
			"</div>" +
			"	<div class='js-body body'></div>" +
			"</div>");


		// OWNERS
		var show_owners = 2;
		var owners = getOwners();
		var owners_count = owners.length;
		if (mode == 'tasks') {
			owners = owners.slice(0, show_owners);
		}

		$("#js-sidebox-owners .js-body").html(AP.render(owners, function(e) {
			var u = People.get(e.username);
			return getHTML(u);
		}));

		if (owners_count > owners.length) {
			showMore("#js-sidebox-owners .js-body", {
				count: owners_count - owners.length,
				url: ':people.side/-/owners.show'
			});
		}

		if (parseInt(managed)) {
			placeHolder("#js-sidebox-owners .js-body",{
				label: "ThĂªm " + metatype,
				type: "owner"
			});
		}
	

		// MEMBERS
		var members = getMembers();
		var show_members = 2;
		var members_count = members.length;

		if (mode == 'tasks') {
			members = members.slice(0, show_members);
		}

		$("#js-sidebox-members .js-body").html(AP.render(members, function(e) {
			var u = People.get(e.username);
			return getHTML(u);
		}));
		
		if (!members_count) {
			$("#js-sidebox-members .js-body").html("<div class='none'>KhĂ´ng cĂ³ thĂ nh viĂªn nĂ o</div>");
		}

		if (members_count > members.length) {
			showMore("#js-sidebox-members .js-body", {
				count: members_count - members.length,
				url: ':people.side/-/members.show'
			});
		}

		if (parseInt(managed)) {
			placeHolder("#js-sidebox-members .body",{
				label: "ThĂªm " + "ThĂ nh viĂªn",
				type: "member"
			});	
		}
		
		
		if (parseInt(Client.pageData.context.external)) {
			// GUESTS
			var show_guests = 2;
			var guests = getGuests();
			var guests_count = guests.length;

			if (mode == 'tasks') {
				guests = guests.slice(0, show_guests);
			}

			$("#js-sidebox-clients .js-body").html(AP.render(guests, function(e) {
				var u = People.get(e.username);
				return getHTML(u);
			}));
			
			if (!guests_count) {
				$("#js-sidebox-clients .js-body").html("<div class='none'>KhĂ´ng cĂ³ tĂ i khoáº£n khĂ¡ch hĂ ng nĂ o</div>");
			}

			if (guests_count > guests.length) {
				showMore("#js-sidebox-clients .js-body", {
					count: guests_count - guests.length,
					url: ':people.side/-/clients.show'
				});
			}
			
			if (parseInt(managed)) {
				placeHolder("#js-sidebox-clients .js-body",{
					guest: true,
					label: "ThĂªm " + "tĂ i khoáº£n khĂ¡ch hĂ ng",
					type: "guest"
				});
			}
		}
		else{
			$("#js-sidebox-clients").hide();
		}
		
		
		// Context menu
	};

	this.addMulti = function(role, item) {
		$.log(role);
		var data = {id: item.id, role: role};
		var label = "ThĂªm nhiá»u " + role;

		Tag.context(false);
		var form = Form.create('fly-task-reassign-fx',{'action': "api/settings/role/multi"})
			.row(
				Form.label({label: label}),
				Form.input({name: 'name', type: "textarea", placeholder: "Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂªm thĂ nh viĂªn", role:"tag"})
				.css({height: 100})
				.extra("&rsaquo; <span class='url' onclick='Form.v2.quickTag(this)'>ThĂªm nhanh thĂ nh viĂªn theo nhĂ³m</span>")
			).addClass("-big")
			.buttons([
				{label: "ThĂªm", action: function() {
					Form.submit("#fly-task-reassign-fx", function(code) {
						Tag.context(true);
						if (!code.good()) {
							return AP.alertError(code.message);
						}
						
						Form.hide("fly-task-reassign-fx");
						UI.flash("ÄĂ£ thĂªm thĂ nh cĂ´ng...");
						AP.refresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function() {
					Form.hide("fly-task-reassign-fx");
				}, style:'cancel -passive-2 -rounded'}
			]).hiddens(data);

		Form.pop({id:'fly-edititem-dx', width: 450, label: label, layout: 'flat'}).setForm(form).show().focus('name');

	};


	this.showMore = function(type) {
		var context = Client.pageData.context;
		var users = Client.pageData.context.followers;

		var title = "ThĂ nh viĂªn";
		if (type == 'owners') {
			if (context.metatype == 'project') {
				title = "Quáº£n lĂ½ dá»± Ă¡n";
			} else {
				title = "Quáº£n lĂ½ phĂ²ng ban";
			}

			users = getOwners();
		}


		if (type == 'clients') {
			title = 'Tk KhĂ¡ch'
			users = getGuests();
		}

		if (type == 'members') {
			title = 'ThĂ nh viĂªn'
			users = getMembers();
		}

		return this.list(title, AP.array.select(users, function(u) {
			u = People.get(u.username);
			return u;
		}));
	};


	function getOwners() {
		var context = Client.pageData.context;
		return AP.array.filter(context.owners, function(e) {
			var u = People.get(e.username);
			if (u.id == 0) {
				return false;
			}

			if (parseInt(u.error)) {
				return false;
			}

			if (u) {
				return true;
			}

			return false;
		});
	}


	function getMembers() {
		var context = Client.pageData.context;
		return AP.array.filter(context.followers, function(e) {
			var index_user = AP.array.indexOf(context.owners, e, function(a, b) {
				return a.username == b.username;
			});

			if (index_user != -1) {
				return false;
			}

			var u = People.get(e.username);
			if (u.metatype == "guest" && parseInt(context.external)) {
				return false;
			}

			if (parseInt(u.id) == 0) {
				return false;
			}

			if (parseInt(u.error)) {
				return false;
			}

			if (u) {
				return true;
			}

			return false;
		});
	};


	function getGuests() {
		var context = Client.pageData.context;
		return AP.array.filter(context.followers, function(e) {
			var index_user = AP.array.indexOf(context.owners, e, function(a, b) {
				return a.username == b.username;
			});

			if (index_user != -1) {
				return false;
			}
			
			var u = People.get(e.username);
			if (u.metatype != "guest") {
				return false;
			}

			if (parseInt(u.error)) {
				return false;
			}

			if (u) {
				return true;
			}

			return false;
		});
	};
	

	// Rewrites Users popup list
	this.list=function(title, users) {
		var html=AP.render(users, function(user) {
			var sub=user.title;
			if (!user.title) {
				sub="No job title";
			}
			return "<div class='li item unselectable url"+(sub.length?'':' -no-info')+"'> <div class='image'><div class='avatar "+(user.online?' -online':'')+"'> <img src='"+(AP.xthumb(user.gavatar))+"'/> </div></div> <b>"+(user.name)+"</b> <div class='sub'>@"+(user.username)+" &middot; "+(sub)+"</div> <div class='-ricon'><span class='ficon-angle-right'></span></div> <div class='actions owner' onclick=\"Project.people.context(this, '"+(user.username)+"');\"> <div class='action'><span class='ap icon-dots-three-horizontal'></span></div> </div> </div>";
		});
		
		var mh=$(window).height()-200;
		if (mh<200) {
			mh=200;
		}
		
		html="<div class='title'>"+title+"<div class='-close' onclick='AP.closeDialog(this);'></div></div>" +
				"<div class='rh' style='max-height:"+mh+"px; overflow-y:auto;'><div class='list list-actions with-image -border'>"+html+"</div></div>";
		
		AP.customDialog(html,"custom-selection").style("-full").width(500).show();
		$("#custom-selection").addClass("__canvas");
	};


	function getHTML(user) {
		return "<div class='user'>" +
			"<div class='avatar avatar-32 -circled' data-username='"+user.username+"'>" +
				"<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
			"</div>" +
			"<div class='name'>" +
			"	<div class='main'><em class='url username' data-username='"+user.username+"'>"+user.name+"</em></div>" +
			"	<div class='info ap-xdot'>"+user.title+"</div>" +
			"	<div class='info ap-xdot'>"+user.email+" &middot; "+user.phone+"</div>" +
			"</div>" +
			"<div class='actions owner' onclick=\"Project.people.context(this, '"+user.username+"');\">" +
			"	<div class='action'><span class='ap icon-dots-three-horizontal'></span></div>" +
			"</div>" +
		"</div>";
	};
	

	function showMore(box, options) {
		options=$.extend({}, {label: "Xem thĂªm", count: 1, url: ':people.side/-/owners.show'}, options);
		$(box).append("<div class='show-more url' data-url='"+(options.url)+"'>"+(options.label)+" ("+(options.count)+")</div>");
	};

	
	function placeHolder(box, options) {
		options=$.extend({}, {label: "ThĂªm thĂ nh viĂªn", type: "owner", guest: false}, options);
		
		$(box).data("type", options.type)
		$(box).append("<div class='user -add'>" +
				"<div class='avatar'><div class='add'></div></div>" +
				"<div class='txt'>"+options.label+"</div>" +
			"</div>");

		var position = {
			left: -15,
			top: 50
		};

		Form.inlineTagger($(box).find(".user.-add"), {
			title: options.label,
			select: function(user) {
				var type=$(box).data("type");
				Project.role.set(user, type);
			},
			filter: function(user) {
				if (options.guest) {
					if (user.metatype!="guest") {
						return false;
					}
					
					return true;
				}else{
					if (user.metatype=="guest") {
						return false;
					}
					
					return true;	
				}
				
				
			},
			position:position,
			width: 250
		});
	};
};


Project.role=new function __ProjectRole(){
	this.set=function(user, type){
		UI.ajaxShow();
		var data={id: user.id, role: type};
		
		UI.ajaxShow();
		AP.xpost("api/settings/role/user", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			AP.refresh();
		});
	};
	
	
	this.remove=function(user){
		UI.ajaxShow();
		var data={id: user.id};
		
		UI.ajaxShow();
		AP.xpost("api/settings/role/remove", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			AP.refresh();
		});
	};
};


Rewrite.on(':people.side/-/{action}', function(qs) {
	if (qs.action == 'owners.show') {
		return Project.people.side.showMore('owners');
	}

	if (qs.action == 'members.show') {
		return Project.people.side.showMore('members');
	}

	if (qs.action == 'clients.show') {
		return Project.people.side.showMore('clients');
	}
});


var CommentLogger = new function __CommentLogger() {
	this.list = function() {
		$("#js-commentlogs").html(AP.render(Client.pageData.comments, function(e){
			var link = '';
			var name = '';
			if (typeof e.origin_export.link != "undefined") {
				link = e.origin_export.link;
			}

			if (typeof e.origin_export.name != "undefined") {
				name = e.origin_export.name;
			}
			if (!name && typeof e.origin_export.type != "undefined") {
				name = e.origin_export.type;
			}
			return "<tr> <td>"+(AP.i18n.datetime(e.since))+"</td> <td title='#"+(e.id)+"'>"+(e.content)+"</td> <td>"+(e.origin_export.id)+"</td> <td>"+(e.origin_export.type)+"</td> <td><span class='url a normal' data-url='"+(link)+"' data-blank='1'>"+(name)+"</span></td> <td><span class='url a normal' data-url='me/show.comment.raw/"+(e.id)+"' data-blank='1'>Raw data</span></td> </tr>";
		}));

		$("#js-commentlogs").closest("table").after("<div id='js-pags' style='padding:50px 0'><div class='center'></div></div>");
		UI.paginate("#js-pags .center");
	};
};
var Task = new function __ProjectTask() {
	/**
	 * @desc Smartly detect task by its id 
	*/
	this.fromContext = function (id) {
		if (Client.tempData && Client.tempData.task && parseInt(id) == parseInt(Client.tempData.task.id)) {
			return Client.tempData.task;
		}

		return AP.array.findObj(Client.pageData.tasks, id);
	};


	/**
	 * @desc Update the task 
	 */
	this.update = function (task, comment) {
		return Project.on.taskUpdated(task, comment);
	};



	/**
	 * @desc Get item by a given id, handler with callback
	 */
	this.get = function (id, callback) {
		UI.ajaxShow();
		AP.post("api/task/get", { 'id': id }, function (code) {
			UI.ajaxHide();

			if (!code.good()) {
				return AP.alertError(code.message);
			}

			callback(code.task, code.project, code.tasklists);
		});
	};


	this.itemOptions = function (item_id) {
		Task.get(item_id, function (item, project, tasklists) {
			var options = [];
			var table_fields = Project.getTableFields(project);

			if ((item.state == "active") || (item.state == "overdue") || 1 == 1) {
				if (parseInt(item.acl.managed)) {
					options.push({
						label: "Chá»‰nh sá»­a thĂ´ng tin cĂ´ng viá»‡c", sublabel: "Chá»‰nh sá»­a cĂ¡c thĂ´ng tin chĂ­nh", "icon": "pen", "action": function () {
							return Task.dialog.edit(project, item, tasklists);
						}
					});

					options.push({
						label: "Giao láº¡i cho ngÆ°á»i khĂ¡c", sublabel: "Giao cĂ´ng viá»‡c nĂ y cho ngÆ°á»i khĂ¡c", icon: "user5", action: function () {
							return Task.action.reassign(item);
						}
					});

					options.push({
						label: "ThĂªm nhiá»u ngÆ°á»i theo dĂµi", sublabel: "ThĂªm nhiá»u ngÆ°á»i theo dĂµi", icon: "address-book", action: function () {
							return Task.action.addMulti(item);
						}
					});

					options.push({
						label: "NhĂ¢n báº£n cĂ´ng viá»‡c", sublabel: "NhĂ¢n báº£n cĂ´ng viá»‡c nĂ y", icon: "squared-plus", action: function () {
							return Task.dialog.duplicate(project, item, tasklists);
						}
					});

					options.push({
						label: "NhĂ¢n báº£n cĂ´ng viá»‡c vĂ o dá»± Ă¡n khĂ¡c", sublabel: "NhĂ¢n báº£n cĂ´ng viá»‡c vĂ o dá»± Ă¡n-phĂ²ng ban khĂ¡c", icon: "squared-plus", action: function () {
							return Task.dialog.duplicateExternal(item);
						}
					});

					options.push({
						label: "Lá»‹ch sá»­ webhook", sublabel: "Lá»‹ch sá»­ webhook", icon: "flag2", action: function () {
							return Base.webhook.showLogs(item);
						}
					});
				}
			}

			if (table_fields.length && !mobile()) {
				options.push({
					label: "Xuáº¥t dá»¯ liá»‡u thuá»™c báº£ng", sublabel: "Xuáº¥t dá»¯ liá»‡u tá»« má»™t trÆ°á»ng dá»¯ liá»‡u dáº¡ng báº£ng", "icon": "table", "action": function () {
						return Task.action.exportTable(project, item);
					}
				});
			}

			if ((item.state == "active") || (item.state == "overdue") || 1 == 1) {
				if (parseInt(item.acl.managed) ) {

					if (table_fields.length && parseInt(item.acl.desc) && !mobile()) {
						options.push({
							label: "Nháº­p dá»¯ liá»‡u thuá»™c báº£ng", sublabel: "Nháº­p file excel cĂ³ chá»©a dá»¯ liá»‡u cá»§a trÆ°á»ng dáº¡ng báº£ng", "icon": "table", "action": function () {
								return Task.action.importTable(project, item);
							}
						});
					}

					options.push({
						label: "XĂ³a cĂ´ng viá»‡c", sublabel: "XĂ³a cĂ´ng viá»‡c nĂ y", icon: "delete", action: function () {
							return Task.close(project, item);
						}
					});
				}
			} else {
				return AP.alertError("CĂ´ng viá»‡c khĂ´ng á»Ÿ tráº¡ng thĂ¡i thá»±c thi (Ä‘Ă£ hoĂ n thĂ nh hoáº·c Ä‘Ă£ huá»·).");
			}
			/*
			options.push({label:"<span class='red'>XĂ³a cĂ´ng viá»‡c</span>", "icon":"trash3", "action": function(){
				return AP.alertError("TĂ­nh nÄƒng Ä‘ang Ä‘Æ°á»£c hoĂ n thiá»‡n");
			}});
			*/

			AP.actionMenu(options);
		});
	};



	/**
	 * @desc Display a single item 
	 */
	this.display = function (id) {
		return TaskDisplay.display(id);
	};


	/**
	 * @desc Tick on a list
	 */
	this.setStatus = function (id, status, ref) {
		var action = "check";
		if (!status) {
			action = "uncheck";
		}

		UI.ajaxShow();
		AP.post("api/task/check", { action: action, id: id }, function (code) {
			UI.ajaxHide();

			if (!code.good()) {
				return AP.alertError(code.message)
			};

			UI.flash("ÄĂ£ lÆ°u thay Ä‘á»•i...");
			Project.on.taskUpdated(code.task, code.comment);
		});
	};



	this.setDeliverable = function (id, callback) {
		var data = { id: id };

		var form = Form.create('deliverable-fx', { action: 'api/project/item/submit' })
			.note("CĂ´ng viá»‡c nĂ y yĂªu cáº§u báº¡n pháº£i cáº­p nháº­t káº¿t quáº£ trÆ°á»›c khi Ä‘Ă¡nh dáº¥u hoĂ n thĂ nh")
			.rowHidden(
				Form.label({ label: "TĂªn cĂ´ng viá»‡c *", "subtitle": "TĂªn cĂ´ng viá»‡c" }),
				Form.input({ name: 'name', "placeholder": "TĂªn cĂ´ng viá»‡c" })
			)
			.row(
				Form.label({ label: "MĂ´ táº£ káº¿t quáº£ Ä‘Ă£ thá»±c hiá»‡n", }),
				Form.input({ name: 'content', "placeholder": "MĂ´ táº£ káº¿t quáº£ cĂ´ng viá»‡c", type: "textarea" }).css({ height: 100 })
			)
			.row(
				Form.label({ label: "Gá»­i tĂ i liá»‡u", "sublabel": "Gá»­i tá»‘i Ä‘a 05 tá»‡p káº¿t quáº£" }),
				Form.input({ 'type': 'file', "placeholder": "Lá»±a chá»n tá»‡p Ä‘á»ƒ táº£i lĂªn", name: "file-1" })
			)
			.rowHidden(
				Form.noLabel(),
				Form.input({ 'type': 'file', "placeholder": "Lá»±a chá»n tá»‡p Ä‘á»ƒ táº£i lĂªn", name: "file-2" })
			)
			.rowHidden(
				Form.noLabel(),
				Form.input({ 'type': 'file', "placeholder": "Lá»±a chá»n tá»‡p Ä‘á»ƒ táº£i lĂªn", name: "file-3" })
			)
			.rowHidden(
				Form.noLabel(),
				Form.input({ 'type': 'file', "placeholder": "Lá»±a chá»n tá»‡p Ä‘á»ƒ táº£i lĂªn", name: "file-4" })
			)
			.rowHidden(
				Form.noLabel(),
				Form.input({ 'type': 'file', "placeholder": "Lá»±a chá»n tá»‡p Ä‘á»ƒ táº£i lĂªn", name: "file-5" })
			)
			.render(function (form) {
				$("input[type=file]").change(function () {
					var $row = $(this).closest(".row");
					var $next = $row.next(".row");
					if ($next) {
						$next.show();
					}
				});
			})
			.hiddens(data)
			.buttons([
				{
					label: "Gá»­i káº¿t quáº£ cĂ´ng viá»‡c", action: function () {
						Form.submit("deliverable-fx", function (code) {
							if (!code.good()) {
								return AP.alertError(code.message);
							}

							Form.hide("deliverable-fx");
							UI.flash("ChĂºc má»«ng báº¡n! CĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh");

							// AP.sys.fire("tasklist.incr_done", code.item.tasklist_id);

							if (callback) {
								callback(code.item);
							}
						});
					}, style: 'ok -success -rounded bold'
				},
				{
					label: "Há»§y", action: function () {
						Form.hide("deliverable-fx");
					}, style: '-cancel -passive-2 rounded'
				}
			]);


		Form.pop({ id: 'deliverable-fx-dx', width: 600, label: 'Cáº­p nháº­t káº¿t quáº£ hoĂ n thĂ nh cho cĂ´ng viá»‡c nĂ y' }).setForm(form).show();

	};




	this.close = function (project, item) {
		AP.confirm("Báº¡n cĂ³ cháº¯c mĂ¬nh muá»‘n xĂ³a cĂ´ng viá»‡c nĂ y? Báº¡n khĂ´ng thá»ƒ khĂ´i phá»¥c láº¡i cĂ´ng viá»‡c Ä‘Ă£ bá»‹ xĂ³a", function (code) {
			UI.ajaxShow();
			AP.post("api/task/remove", { id: item.id }, function (code) {
				UI.ajaxHide();
				AP.hideAlert();

				if (!code.good()) {
					return AP.alertError(code.message);
				}

				UI.flash("CĂ´ng viá»‡c Ä‘Ă£ Ä‘Æ°á»£c há»§y :(");
				Side.milestone.removeTask(code);

				if (Client.pageData.context) {
					AP.redirect(Client.pageData.context.path);
				} else {
					AP.setURLParams({ task: null }, true);
				}
			});
		});
	};



	this.reject = function (item) {
		var data = { id: item.id };

		var form = Form.create('fly-item-fx', { 'action': "api/project/item/reject" })
			.row(
				Form.label({ label: "TĂªn cĂ´ng viá»‡c" }),
				Form.input({ name: 'name', type: "fake" }).value(item.name)
			)
			.row(
				Form.label({ label: "Gá»­i tin nháº¯n tá»›i @" + item.username + " *", sublabel: "Gá»­i tin nháº¯n giáº£i thĂ­ch lĂ­ do tá»« chá»‘i thá»±c hiá»‡n cĂ´ng viá»‡c nĂ y" }),
				Form.input({ name: 'message', type: "textarea" }).css({ height: 100 })
			)
			.buttons([
				{
					label: "Tá»« chá»‘i thá»±c hiá»‡n", action: function () {
						Form.submit("#fly-item-fx", function (code) {
							if (!code.good()) {
								return AP.alertError(code.message);
							}

							Form.hide("fly-item-fx");

							UI.flash("CĂ´ng viá»‡c Ä‘Æ°á»£c tá»« chá»‘i...");
						})
					}, style: 'ok -success -rounded bold'
				},
				{
					label: "Há»§y", action: function () {
						Form.hide("fly-item-fx");
					}, style: 'cancel -passive-2 -rounded'
				}
			]).hiddens(data);

		Form.pop({
			width: 600, label: 'Tá»« chá»‘i thá»±c hiá»‡n cĂ´ng viá»‡c nĂ y'
		}).setForm(form).show().focus('message');
	};




	/**
	 * @todo Remake this -- ERROR
	 */
	this.forward = function (item) {
		var data = { id: item.id };

		var form = Form.create('fly-item-fx', { 'action': "api/project/item/forward" })
			.row(
				Form.label({ label: "Chuyá»ƒn tiáº¿p tá»›i *", sublabel: "Lá»±a chá»n thĂ nh viĂªn mĂ  báº¡n muá»‘n chuyá»ƒn giao quyá»n thá»±c hiá»‡n cĂ´ng viá»‡c nĂ y" }),
				Form.input({ name: 'assign_to', "placeholder": "Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn nháº­n chuyá»ƒn giao", role: "tag" })
			)
			.buttons([
				{
					label: "Chuyá»ƒn giao cĂ´ng viá»‡c", action: function () {
						Form.submit("#fly-item-fx", function (code) {
							if (!code.good()) {
								return AP.alertError(code.message);
							}

							Form.hide("fly-item-fx");

							UI.flash("CĂ´ng viá»‡c Ä‘Æ°á»£c chuyá»ƒn giao thĂ nh cĂ´ng...");
						})
					}, style: 'ok -success -rounded bold'
				},
				{
					label: "Há»§y", action: function () {
						Form.hide("fly-item-fx");
					}, style: 'cancel -passive-2 -rounded'
				}
			]).hiddens(data);

		Form.pop({
			width: 420, label: 'Chuyá»ƒn giao cĂ´ng viá»‡c'
		}).setForm(form).show().focus('assign_to');
	};
};




Task.helper = new function __TaskHelper(){
	
	this.matchingForm = function(project_form, task_form) {

		var task_form_array = [];

		for (var i=0; i<task_form.length; i++){
			var form_file_url = "";
			var form_file_name = "";
			var form_file_fid = "";
			if (task_form[i].type == "file") {
				if (typeof task_form[i].file_url !== "undefined") {
					form_file_url = task_form[i].file_url;
				}
				if (typeof task_form[i].file_name !== "undefined") {
					form_file_name = task_form[i].file_name;
				}
				if (typeof task_form[i].file_fid !== "undefined") {
					form_file_fid = task_form[i].file_fid;
				}
			}
			task_form_array[task_form[i].id] = {
				"type": task_form[i].type,
				"value": task_form[i].value,
				"display": task_form[i].display, 
				"file_url": form_file_url, 
				"file_name": form_file_name,
				"file_fid": form_file_fid
			};
		}

		for (var i = 0; i < project_form.length; i++) {
			if (typeof task_form_array[project_form[i].id] !== "undefined") {

				// var task_form_is_table = (task_form_array[project_form[i].id].type == "input-table");
				// var project_form_is_table = (project_form[i].type == "input-table");
				// if ((project_form_is_table && !task_form_is_table) || (!project_form_is_table && task_form_is_table)) {
				// 	project_form[i].value = "";
				// 	project_form[i].display = "";
				// } else {
					project_form[i].value = task_form_array[project_form[i].id].value;
					project_form[i].display = task_form_array[project_form[i].id].display;
					project_form[i].file_url = task_form_array[project_form[i].id].file_url;
					project_form[i].file_name = task_form_array[project_form[i].id].file_name;
					project_form[i].file_fid = task_form_array[project_form[i].id].file_fid;
				// }
			} else {
				project_form[i].value = "";
				project_form[i].display = "";
			}
		}

		return project_form;
    };


    this.displayDurationHours = function(total_seconds) {

		var s = parseInt(total_seconds);
		if (s < 3600) {
			var m = Math.floor(s / 60);
			return "<em>"+(m)+"</em>m";
		}
		
		var h = Math.floor(s / 3600);
		var m = Math.floor((s - h * 3600) / 60);
		return "<em>"+(h)+"</em>h<em>"+(m)+"</em>m";
    };
	
};








Task.dialog=new function __TaskDialog(){
	this.add=function(project, tasklist_id, deadline, user){
		if (!tasklist_id){
			tasklist_id=0;
		}

		if (project.status != 0) {
			return AP.alertError("Dá»± Ă¡n Ä‘Ă£ Ä‘Ă³ng hoáº·c Ä‘Ă£ hoĂ n thĂ nh");
		}

		var data={id: project.id, hid: project.hid, token: project.token};
		
		var form=Form.create('fly-workflow-fx',{'action': "api/task/add"})
		.row(
			Form.label({label: "TĂªn cĂ´ng viá»‡c *"}),//viáº¿t @ Ä‘á»ƒ tag tĂªn ngÆ°á»i thá»±c hiá»‡n
			Form.input({name: 'name', placeholder: "TĂªn cĂ´ng viá»‡c", "role": "tag"}).autoSubmit()
		).addClass("-big")
		.row(
			Form.label({label: "NhĂ³m cĂ´ng  viá»‡c *"}),
			Form.input({name: 'tasklist_id', type:'select', options: TaskList.getOptions(project.cached_tasklists)}).value(tasklist_id)
		);

		if (deadline) {
			form.row(
				Form.label({label: "Thá»i háº¡n cá»§a cĂ´ng viá»‡c?"}),
				Form.input({name: 'has_deadline', type:"list", options:[{label: "KhĂ´ng Ä‘áº·t thá»i háº¡n", value:0}, {label: "Äáº·t thá»i háº¡n cho cĂ´ng viá»‡c", value:1}]}).value(1)
			);
			form.rowHidden(
				Form.label({label: "Äáº·t thá»i háº¡n cho cĂ´ng viá»‡c"}),
				Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click Ä‘á»ƒ chá»n thá»i háº¡n"}).value(deadline)
			)
		} else {
			form.row(
				Form.label({label: "Thá»i háº¡n cá»§a cĂ´ng viá»‡c?"}),
				Form.input({name: 'has_deadline', type:"list", options:[{label: "KhĂ´ng Ä‘áº·t thá»i háº¡n", value:0}, {label: "Äáº·t thá»i háº¡n cho cĂ´ng viá»‡c", value:1}]}).value(0)
			);
			form.rowHidden(
				Form.label({label: "Äáº·t thá»i háº¡n cho cĂ´ng viá»‡c"}),
				Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click Ä‘á»ƒ chá»n thá»i háº¡n"})
			);
		};

		form.wrap("TĂ¹y chá»n nĂ¢ng cao","#item_add_advopts")
		.row(
			Form.label({label: "Má»©c Ä‘á»™ Æ°u tiĂªn?"}),
			Form.input({name: 'urgent', type:"list", options: Task.option.urgencies()}).value(0)
		)
		.row(
			Form.label({label: "Má»©c Ä‘á»™ quan trá»ng?"}),
			Form.input({name: 'important', type:"list", options: Task.option.importances()}).value(0)
		)
		.row(
			Form.label({label: "Danh sĂ¡ch nhĂ£n"}),
			Form.input({name: 'tags', type: "text", placeholder:"Type to select"})
		)
		.rowHidden(
			Form.label({label: "YĂªu cáº§u káº¿t quáº£ cĂ´ng viá»‡c? *"}),
			Form.input({name: 'deliverable', placeholder:"", type:"list", options: [{label:"KhĂ´ng", value:0}, {label:"CĂ³", value:1}]}).value(0)
		);

		if(user) {
			form.row(
				Form.label({label: "Giao cho"}),
				Form.input({name: 'assign', "placeholder":"Sá»­ dá»¥ng @ Ä‘á»ƒ tag ngÆ°á»i thá»±c hiá»‡n", "role":"user"}).value('@'+user.username)
			)
		} else {
			form.row(
				Form.label({label: "Giao cho"}),
				Form.input({name: 'assign', "placeholder":"Sá»­ dá»¥ng @ Ä‘á»ƒ tag ngÆ°á»i thá»±c hiá»‡n", "role":"user"})
			)
		}

		form.row(
			Form.label({label: "ThĂ nh viĂªn theo dĂµi"}),
			Form.input({name: 'followers', "placeholder":"Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn theo dĂµi", "role":"tag"})
		)
		.row(
			Form.label({label: "NgĂ y báº¯t Ä‘áº§u"}),
			Form.input({name: 'start_time', type:"text", role: "date", placeholder: "Default start date is today "})
		)
		.row(
			Form.label({label: "MĂ´ táº£ cĂ´ng viá»‡c"}),
			Form.input({name: 'content', type:"textarea"}).css({height: 100})
		);

		if (project.form){
			for (var i=0; i<project.form.length; i++){
				var row=project.form[i];
				var row_id = "custom_" + row.id;

				if (row.type=="text"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", placeholder: row.placeholder})
					);
				}

				if (row.type=="int"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", role: "int", placeholder: row.placeholder})
					);
				}

				if (row.type=="float"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", role: "float", placeholder: row.placeholder})
					);
				}

				if (row.type=="file"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"file", role: "file", placeholder: row.placeholder, unit:"<em>file</em>"})
					);
				}

				if (row.type=="date"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", role: "date", placeholder: row.placeholder})
					);
				}

				if (row.type=="datetime"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"datetime", role: "date", placeholder: row.placeholder})
					);
				}

				if (row.type=="textarea"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"textarea", placeholder: row.placeholder}).css({height: 120})
					);
				}

				if (row.type=="select"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"list", options: getListOptions(row)})
					).addClass("-active");
				}

				if (row.type=="checkbox"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"list", options: getCheckboxOptions(row)})
					).addClass("-active");
				}
			}
		}
		
		form.wrap()
		.rowHTML("<span class='link advlink'>+ TĂ¹y chá»n nĂ¢ng cao</span>")
		.buttons([
			{label: "ThĂªm cĂ´ng viá»‡c", action: function(){
				Form.submit("#fly-workflow-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					 
					UI.flash("ThĂªm cĂ´ng viá»‡c thĂ nh cĂ´ng...");
					Form.hide("fly-workflow-fx");
					AP.xRefresh();
					// Project.on.taskCreated(code.task);
				})
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function(){
				Form.hide("fly-workflow-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			fref.selector(".advlink").click(function(){
				$("#item_add_advopts").toggle();
			});

			Task.ui.displayPlaceholder();
			
			fref.find("has_deadline").change(function(){
				var val=parseInt($(this).val());
				if (val==1){
					fref.findRow("deadline").show();
				}else{
					fref.findRow("deadline").hide();
					fref.find("deadline").val("");
				}
			}).change();
			
			var tags=project.tags.slice(0);
			tags=AP.array.select(tags, function(e){
				e.label=e.name.toLowerCase();
				return e;
			});
			
			var $input=fref.find("tags");
			AP.UI.tagcloud($input, project.tags, {
				render: function(){
					
				},
			});
			
			setTimeout(function(){
				fref.find("name").focus();
			}, 300);

			Form.improveSelect(form.find("tasklist_id"));
			$('#fly-workflow-fx select[name="tasklist_id"]').closest('.__dialogcontent').addClass('custom-select');

			$("#fly-workflow-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_task_created:task");
		});
		
		Form.pop({id:'fly-workflow-dx', width: 480, label: 'Táº¡o má»›i cĂ´ng viá»‡c trong '+project.name, layout: 'flat', closable: false}).setForm(form).show().focus('name');
	};

	this.editTask = function(){
		var project = Client.tempData.context;
		var task = Client.tempData.task;
		return this.edit(project, task);
	};

	this.editItem = function(item_id) {
		Task.get(item_id, function(item, project){
			return Task.dialog.edit(project, item)
		});
	}

	this.edit = function(project, item) {

		var tasklists=project.cached_tasklists;
		
		var data = {hid: item.hid, token: item.token};
		var currDeadline = AP.time.now();
		if (item.has_deadline == 1) {
			currDeadline = item.deadline;
		}
		
		if(typeof item.start_time == 'undefined' || item.start_time == null) {
			item.start_time = item.since;
		}
		
		var form = Form.create('fly-edititem-fx',{'action': "api/task/edit"})
		.row(
			Form.label({label: "TĂªn cĂ´ng viá»‡c *"}),
			Form.input({name: 'name', placeholder: "TĂªn cĂ´ng viá»‡c"}).value(item.name)
		).addClass("-big")
		.row(
			Form.label({label: "NgÆ°á»i thá»±c hiá»‡n"}),
			Form.input({name: 'assign', "placeholder":"Sá»­ dá»¥ng @ Ä‘á»ƒ tag ngÆ°á»i thá»±c hiá»‡n", "type":"fake"}).value('@'+item.username)
		)

		if (item.metatype == "task") {
			form.row(
				Form.label({label: "NhĂ³m cĂ´ng  viá»‡c *"}),
				Form.input({name: 'tasklist_id', type:'select', options: TaskList.getOptions(tasklists) }).value(item.tasklist_id)
			);
		} else {
			var options = TaskList.getOptions(tasklists);
			var current_tasklist = ARR.find(options, function(e) {
				return e.value == item.tasklist_id;
			});

			var tasklist_name = current_tasklist ? current_tasklist.label : 'ChÆ°a phĂ¢n loáº¡i';

			form.row(
				Form.label({label: "NhĂ³m cĂ´ng  viá»‡c *"}),
				Form.input({name: 'tasklist_id', type:'fake' }).value(tasklist_name)
			);

			// Keep the same tasklist
			data.tasklist_id = item.tasklist_id;
		}

		form.rowHTML("<span class='link advlink'>+ TĂ¹y chá»n nĂ¢ng cao</span>")
		.wrap("TĂ¹y chá»n nĂ¢ng cao","#item_edit_advopts")
		.row(
			Form.label({label: "Má»©c Ä‘á»™ Æ°u tiĂªn?"}),
			Form.input({name: 'urgent', type:"list", options:[{label: "BĂ¬nh thÆ°á»ng", value:0}, {label: "Kháº©n cáº¥p", value:1}]}).value(item.urgent)
		)
		.row(
			Form.label({label: "MĂ´ táº£ cĂ´ng viá»‡c"}),
			Form.input({name: 'content', type:"textarea", placeholder:"MĂ´ táº£ cĂ´ng viá»‡c"}).css({height: 120}).value(Task.ui.p2br(item.content))
		);

		if (project.form){
			var project_form = project.form;
			var task_form = item.form;

			project_form = Task.helper.matchingForm(project_form, task_form);

			for (var i=0; i<project_form.length; i++){
				var row = project_form[i];
				var row_id = "custom_" + row.id;

				if (row.type=="text"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="int"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", role: "int", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="float"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", role: "int", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="file"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"file", role: "file", placeholder: row.placeholder, unit:"<em>file</em>"})
					);
				}

				if (row.type=="date"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"text", role: "date", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="datetime"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"datetime", role: "date", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="textarea"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"textarea", placeholder: row.placeholder}).css({height: 120}).value(row.value)
					);
				}

				if (row.type=="select"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"list", options: getListOptions(row)}).value(row.value)
					).addClass("-active");
				}

				if (row.type=="checkbox"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row_id, type:"list", options: getCheckboxOptions(row)}).value(row.value)
					).addClass("-active");
				}

				if (row.type == "select-m") {
					var input_data = shallowClone(row);
			
					input_data.label = row.name;
					if (parseInt(row.required)){
						input_data.label = input_data.label + " *";
					}

					input_data.name = "custom_" + row.id;
					
					input_data.type = "select";
					input_data.multiple = 1;
					
					input_data.value = AP.word.split(",", row.value).map(function(e) {
						return $.trim(e);
					});
					
					var ip = Form.v2.getIPData(input_data);

					form.row(
						Form.label({label: input_data.label}),
						ip
					).addClass("-active");
				}

				if (row.type=="input-table"){
					var input_data = shallowClone(row);
				
					input_data.label = row.name;
					if (parseInt(row.required)){
						input_data.label = input_data.label + " *";
					}

					input_data.name = row_id;

					input_data.value = row.value ? row.value : "W10=";

					var ip = Form.v2.getIPData(input_data);

					form.row(
						Form.label({label: input_data.label}),
						ip
					).addClass("-active");
				}
			}
		};
		form.wrap()
		.buttons([
			{label: "LÆ°u", action: function(){
				Form.submit("#fly-edititem-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					 
					UI.flash("Cáº­p nháº­t cĂ´ng viá»‡c thĂ nh cĂ´ng...");

					var project = Project.fromContext(code.task.project_id);
					var tasklist = ARR.findObj(project.cached_tasklists, code.task.tasklist_id);
					if (!tasklist) {
						tasklist = {id: 0, name: "ChÆ°a phĂ¢n loáº¡i"};
					}
					Client.tempData.task.tasklist_id = tasklist.id;

					Task.inline.updateTaskList(code.task, tasklist);

					Project.on.taskUpdated(code.task);
					Form.hide("fly-edititem-fx");
					$("#tasklists .li").setActive(".li-"+item.id);
				})
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function(){
				Form.hide("fly-edititem-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(fref){
			fref.selector(".advlink").click(function(){
				$(this).parent().hide();
				$("#item_edit_advopts").show();
			});

			//Task.ui.displayPlaceholder();
			
			if(item.has_deadline == 1) {
				fref.findRow("deadline").show();
			}
			
			fref.find("has_deadline").change(function(){
				var val=parseInt($(this).val());
				if (val==1){
					fref.findRow("deadline").show();
				}else{
					fref.findRow("deadline").hide();
				}
			}).change();

			// Style for table
			$('.visible-custom-table table td .cell').each(function(){
				var title = $(this).html();
				$(this).addClass('ap-xdot');
				$(this).attr('title', title);
			});
			
			setTimeout(function(){
				fref.find("name").focus();
			}, 300);

			Form.improveSelect(form.find("tasklist_id"));
			$('#fly-edititem-dx select[name="tasklist_id"]').closest('.__dialogcontent').addClass('custom-select');
		});
		
		Form.pop({id:'fly-edititem-dx', width: 600, label: 'Chá»‰nh sá»­a cĂ´ng viá»‡c: '+item.name, layout: 'flat'}).setForm(form).show().focus('name');
	};

	this.duplicate = function(project, item, tasklists) {

		var std_tasklists = standardizeTaskLists(tasklists);
		var data = {id: project.id, hid: item.hid, token: item.token};
		var currDeadline = AP.time.now();
		if (item.has_deadline == 1) {
			currDeadline = item.deadline;
		}

		if (typeof item.start_time == 'undefined' || item.start_time == null) {
			item.start_time = item.since;
		}

		var form = Form.create('fly-edititem-fx',{'action': "api/task/duplicate"})
			.row(
				Form.label({label: "TĂªn cĂ´ng viá»‡c *"}),
				Form.input({name: 'name', placeholder: "TĂªn cĂ´ng viá»‡c"}).value('Báº£n sao cá»§a '+item.name)
			).addClass("-big")
			.row(
				Form.label({label: "NgÆ°á»i thá»±c hiá»‡n"}),
				Form.input({name: 'assign', "placeholder":"Sá»­ dá»¥ng @ Ä‘á»ƒ tag ngÆ°á»i thá»±c hiá»‡n", "role":"tag"}).value('@'+item.username)
			)
			.row(
				Form.label({label: "Thá»i háº¡n cá»§a cĂ´ng viá»‡c?"}),
				Form.input({name: 'has_deadline', type:"list", options:[{label: "KhĂ´ng Ä‘áº·t thá»i háº¡n", value:0}, {label: "Äáº·t thá»i háº¡n cho cĂ´ng viá»‡c", value:1}]}).value(item.has_deadline)
			)
			.rowHidden(
				Form.label({label: "Äáº·t thá»i háº¡n cho cĂ´ng viá»‡c"}),
				Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click Ä‘á»ƒ chá»n thá»i háº¡n"}).value(currDeadline)
			)



			if (item.metatype == 'subtask' && item.origin_export.type == "projecttasks") {
				form.row(
					Form.label({label: "NhĂ¢n báº£n cĂ´ng viá»‡c con cá»§a"}),
					Form.input({name: 'subtask_origin', type:'select', options: [{label: item.origin_export.name, value: item.origin_export.id}, {label: "KhĂ´ng, nhĂ¢n báº£n nhÆ° cĂ´ng viá»‡c thĂ´ng thÆ°á»ng", value: 0}]})
				);
			} else {
				form.row(
					Form.label({label: "NhĂ³m cĂ´ng  viá»‡c *"}),
					Form.input({name: 'tasklist_id', type:'select', options: TaskList.getOptions(std_tasklists)}).value(item.tasklist_id)
				)
				.row(
					Form.label({label: "Táº¡o báº£n sao cĂ´ng viá»‡c kĂ¨m theo?"}),
					Form.input({name: 'keep_subtasks', type:'select', options: [{label: "CĂ³", value:1}, {label: "KhĂ´ng", value: 0}]})
				);
			}

			form.rowHTML("<span class='link advlink'>+ TĂ¹y chá»n nĂ¢ng cao</span>")
			.wrap("TĂ¹y chá»n nĂ¢ng cao","#item_edit_advopts")
			.row(
				Form.label({label: "Má»©c Ä‘á»™ Æ°u tiĂªn?"}),
				Form.input({name: 'urgent', type:"list", options:[{label: "BĂ¬nh thÆ°á»ng", value:0}, {label: "Kháº©n cáº¥p", value:1}]}).value(item.urgent)
			)
			.row(
				Form.label({label: "YĂªu cáº§u káº¿t quáº£ cĂ´ng viá»‡c? *"}),
				Form.input({name: 'deliverable', placeholder:"", type:"list", options: [{label:"KhĂ´ng", value:0}, {label:"CĂ³", value:1}]}).value(item.req_deliverable)
			).addClass("-active")
			.row(
				Form.label({label: "ThĂ nh viĂªn theo dĂµi"}),
				Form.input({name: 'followers', "placeholder":"Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂ nh viĂªn theo dĂµi", "role":"tag"}).value(UI.objectsToUsernames(item.followers))
			)
			.row(
				Form.label({label: "MĂ´ táº£ cĂ´ng viá»‡c"}),
				Form.input({name: 'content', type:"textarea"}).css({height: 120}).value(Task.ui.p2br(item.content))
			)
			.row(
				Form.label({label: "NgĂ y báº¯t Ä‘áº§u"}),
				Form.input({name: 'start_time',   role: "date", placeholder: "NgĂ y báº¯t Ä‘áº§u máº·c Ä‘á»‹nh lĂ  hĂ´m nay"}).value(item.start_time)
			);

		if (project.form){
			var project_form = project.form;
			var task_form = item.form;

			project_form = Task.helper.matchingForm(project_form, task_form);

			for (var i=0; i<project_form.length; i++){
				var row = project_form[i];

				if (row.type=="text"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="int"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "int", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="float"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "int", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="file"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"file", role: "file", placeholder: row.placeholder, unit:"<em>file</em>"})
					);
				}

				if (row.type=="date"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"text", role: "date", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="datetime"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"datetime", role: "date", placeholder: row.placeholder}).value(row.value)
					);
				}

				if (row.type=="textarea"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"textarea", placeholder: row.placeholder}).css({height: 120}).value(row.value)
					);
				}

				if (row.type=="select"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getListOptions(row)}).value(row.value)
					).addClass("-active");
				}

				if (row.type=="checkbox"){
					form.row(
						Form.label({label: row.name}),
						Form.input({name: row.id, type:"list", options: getCheckboxOptions(row)}).value(row.value)
					).addClass("-active");
				}

				if (row.type == "select-m") {
					var input_data = shallowClone(row);
			
					input_data.label = row.name;
					if (parseInt(row.required)){
						input_data.label = input_data.label + " *";
					}

					input_data.name = row.id;
					
					input_data.type = "select";
					input_data.multiple = 1;
					
					input_data.value = AP.word.split(",", row.value).map(function(e) {
						return $.trim(e);
					});
					
					var ip = Form.v2.getIPData(input_data);

					form.row(
						Form.label({label: input_data.label}),
						ip
					).addClass("-active");
				}

				if (row.type=="input-table"){
					var input_data = shallowClone(row);
				
					input_data.label = row.name;
					if (parseInt(row.required)){
						input_data.label = input_data.label + " *";
					}

					input_data.name = row.id;

					input_data.value = row.value ? row.value : "W10=";

					var ip = Form.v2.getIPData(input_data);

					form.row(
						Form.label({label: input_data.label}),
						ip
					).addClass("-active");
				}
			}
		};
		form.wrap()
			.buttons([
				{label: "NhĂ¢n báº£n cĂ´ng viá»‡c", action: function(){
					Form.submit("#fly-edititem-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						UI.flash("NhĂ¢n báº£n thĂ nh cĂ´ng...");
						// Project.on.taskCreated(code.task, tasklists);
						Form.hide("fly-edititem-fx");
						AP.setURLParams({"task": code.task.id});
						AP.xRefresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function(){
					Form.hide("fly-edititem-fx");
				}, style:'cancel -passive-2 -rounded'}
			])
			.hiddens(data)
			.render(function(fref){
				fref.selector(".advlink").click(function(){
					$(this).parent().hide();
					$("#item_edit_advopts").show();
				});

				Task.ui.displayPlaceholder();

				if(item.has_deadline == 1) {
					fref.findRow("deadline").show();
				}

				fref.find("has_deadline").change(function(){
					var val=parseInt($(this).val());
					if (val==1){
						fref.findRow("deadline").show();
					}else{
						fref.findRow("deadline").hide();
					}
				}).change();

				// Style for table
				$('.visible-custom-table table td .cell').each(function(){
					var title = $(this).html();
					$(this).addClass('ap-xdot');
					$(this).attr('title', title);
				});

				setTimeout(function(){
					fref.find("name").focus();
				}, 300);

				Form.improveSelect(form.find("tasklist_id"));
				$('#fly-edititem-dx select[name="tasklist_id"]').closest('.__dialogcontent').addClass('custom-select');
			});


		Form.pop({id:'fly-edititem-dx', width: 600, label: 'NhĂ¢n báº£n cĂ´ng viá»‡c: '+item.name, layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Duplicate external
	 */
	this.duplicateExternal=function(task){
		var form = Form.create('deliverable-fx',{action: 'api/task/dup.ext'})
		.row(
			Form.label({label: "Chá»n phĂ²ng ban hoáº·c dá»± Ă¡n"}),
			Form.input({name: 'project_id', type: "select", options: projectOptions()})
		)
		.row(
			Form.label({label: "NhĂ³m cĂ´ng  viá»‡c"}),
			Form.input({name: 'tasklist_id', "placeholder":"NhĂ³m cĂ´ng  viá»‡c", type: "select", options: [], id:"js-tasklist-ip-id"})
		)
		.row(
			Form.label({label: "Thá»i háº¡n cá»§a cĂ´ng viá»‡c"}),
			Form.input({name: 'deadline', type: "text", role: "date", placeholder: "Click Ä‘á»ƒ chá»n thá»i háº¡n"}).value(task.deadline)
		)
		.row(
			Form.label({label: "Giá»¯ láº¡i cĂ´ng viá»‡c con?"}),
			Form.input({name: 'keep_subtasks', type:'select', options: [{label: "CĂ³", value:1}, {label: "KhĂ´ng", value: 0}]})
		)
		.row(
			Form.label({label: "Giá»¯ láº¡i checklist cá»§a cĂ´ng viá»‡c con?"}),
			Form.input({name: 'keep_subtasks_checklists', type:'select', options: [{label: "CĂ³", value:1}, {label: "KhĂ´ng", value: 0}]})
		)
		.row(
			Form.label({label: "Giá»¯ láº¡i thĂ´ng tin háº¡n hoĂ n thĂ nh cá»§a cĂ´ng viá»‡c con?"}),
			Form.input({name: 'keep_subtasks_deadline', type:'select', options: [{label: "CĂ³", value:1}, {label: "KhĂ´ng", value: 0}]})
		)
		.render(function(form){
			initForm(form);
			Form.improveSelect(form.find("project_id"), {empty: 0});
		})	
		.hiddens({id: task.id})
		.buttons([
			 {label: "NhĂ¢n báº£n cĂ´ng viá»‡c", action: function(){
				 Form.submit("#deliverable-fx", function(code){
					 UI.ajaxHide();
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					
					 AP.alertSuccess("NhĂ¢n báº£n thĂ nh cĂ´ng!");
					 Form.hide("deliverable-fx");
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("deliverable-fx");
			 }, style:'-cancel -passive-2 rounded'}
		]);
		
		
		Form.pop({id:'deliverable-fx-dx', width: 480, layout: "flat", label: "NhĂ¢n báº£n cĂ´ng viá»‡c tá»›i dá»± Ă¡n/phĂ²ng ban khĂ¡c", closable: false}).setForm(form).show();

	};

	
	
	
	function getListOptions(row){
		var opts=[];
		for (var i=0; i<row.options.length; i++){
			opts.push({label: row.options[i], value: row.options[i]})
		}
		
		return opts;
	};
	
	function getCheckboxOptions(row){
		return [{label: "CĂ³", value:'yes'}, {label: "KhĂ´ng", value: 'no'}];
	};
	
	
	function initForm(form){
		form.find("project_id").on("change", function(){
			var val=$(this).val();
			if (val && parseInt(val)){
				var project=AP.array.findObj(Client.projects, val);
				if (!project){
					$("#js-tasklist-ip-id").html("<option value='0'>-- Chá»n --</option>");
				}else{
					var opts=AP.render(project.cached_tasklists, function(e){
						return "<option value='"+e.id+"'>"+e.name+"</option>";
					});
					
					$("#js-tasklist-ip-id").html(opts);	
				}
			}else{
				$("#js-tasklist-ip-id").html("<option value='0'>-- Chá»n --</option>");
			}

			// Cleanup previous select tag
			$('#js-tasklist-ip-id ~ .improve-select').remove();
			Form.improveSelect(form.find("tasklist_id"));
			$('#js-tasklist-ip-id').closest('.__dialogcontent').addClass('custom-select');
		}).change();
	};


	function projectOptions() {

		var options = AP.select(Client.projects, function(e) {
			if (!e.acl || !parseInt(e.acl.task_create) || !e.name || !e.name.length) {
				return null;
			}

			return {label: "["+e.metatype+"] "+e.name, value: e.id};
		});

		options.unshift({label: "Chá»n phĂ²ng ban hoáº·c dá»± Ă¡n", value: 0});

		return options;
	};


	function standardizeTaskLists(tasklists) {

		var results = ARR.clone(tasklists);
		var uncategorized = ARR.findObj(results, 0);

		if (!uncategorized) {
			results.unshift({ id: 0, name: 'ChÆ°a phĂ¢n loáº¡i'});
		}

		return results;
	};
};


Task.form = new function __TaskForm() {

	this.__pending = true;
	
	this.setPending = function(flag) {
		this.__pending = flag;
		AP.transition = "BLOCKED";
	};
	
	
	this.getForm = function(opts) {
		var p = 0;
		if (opts.context) {
			p = opts.context.id;
		}
		
		var exp_add = explain('Click hoáº·c Enter Ä‘á»ƒ thĂªm',true);
		var exp_assignee = explain('Click Ä‘á»ƒ giao viá»‡c cho má»™t ngÆ°á»i', true);
		var exp_deadline = explain('Click Ä‘á»ƒ chá»n thá»i háº¡n', true);
		var exp_start_date = explain('Click Ä‘á»ƒ chá»n ngĂ y báº¯t Ä‘áº§u', true);

		var assigner_delegation = '';
		if (Client.delegators.length) {
			var assigner_delegation = "<div class='action -dd -js-delegator -icon -infow'> <div class='icon avatar-add'><div class='ph'><span class='-ap icon-uniF13B'></span></div></div> <em class='v'>NgÆ°á»i giao</em> </div>";
		}
		
		return "<div class='task-iform'> <form method='POST' action='api/task/add'> <div class='hidden'><input type='hidden' name='id' value='"+(p)+"'/></div> <div class='hidden'><input type='hidden' name='milestone_id'/></div> <div class='hidden'><input type='hidden' name='tasklist_id'/></div> <div class='hidden'><input type='hidden' name='status' value='0'/></div> <div class='hidden'><input type='hidden' name='assign'/></div> <div class='hidden'><input type='hidden' name='start_time'/></div> <div class='hidden'><input type='hidden' name='deadline'/></div> <div class='hidden'><input type='hidden' name='tags'/></div> <div class='hidden'><input type='hidden' name='delegator'/></div> <div class='task-cb'><div class='task-status'></div></div> <div class='input'><input name='name' type='text' placeholder='TĂªn cĂ´ng viá»‡c *' autocomplete='off'/></div> <div class='input -desc'><textarea name='content' type='text' placeholder='MiĂªu táº£ cĂ´ng viá»‡c' autocomplete='off'></textarea></div> <div class='submit -infow url' data-feature='wework:wework_task_created:task'> &check; THĂM "+(exp_add)+" </div> <div class='acts clear-fix'> <div class='action -dd -js-avatar -icon -infow'> <div class='icon avatar-add'><div class='ph'><span class='-ap icon-uniF13B'></span></div></div> <em class='v'>Giao cho</em> "+(exp_assignee)+" </div> <div class='action -dd -icon -js-start-date -infow'> <span class='icon ficon-calendar-empty'></span> <em class='v'>NgĂ y báº¯t Ä‘áº§u</em> "+(exp_start_date)+" </div> <div class='action -dd -icon -js-deadline -infow'> <span class='icon ficon-calendar-empty'></span> <em class='v'>Thá»i háº¡n</em> "+(exp_deadline)+" </div> <div class='action -dd -js-tasklist -icon'> <em class='v'>Set tasklist</em> </div> <div class='action -dd -js-milestone -icon'><em class='v'>Chá»n má»¥c tiĂªu</em></div> <div class='action -dd -js-tags -icon'><em class='v'>Chá»n nhĂ£n</em></div> "+(assigner_delegation)+" </div> <div class='more-link'>ThĂªm lá»±a chá»n</div> </form> </div>";
	};
	
	
	/**
	 * @desc Bind events for the form
	 */
	this.bindEvents = function(canvas) {

		var id = $(canvas).data("id");
		var metatype = $(canvas).data("metatype");
		var obj = Board.data.fromContext(id, metatype);
	
		if (metatype == "user") {
			setUser($(canvas), obj, true);
		}
		
		if (metatype == "tasklist") {
			setTasklist($(canvas), obj, true);
		}
		
		if (metatype == "milestone") {
			setMilestone($(canvas), obj, true);
		}
		
		if (metatype == "task") {
			setTask($(canvas), obj, false);
		}
		
		var $canvas = $(canvas);

		$canvas.find(".submit").click(function(){
			submitTask(this);
		});
		
		$canvas.find("input[name=name]").enter(function(){
			submitTask(this);
		});
		
		$canvas.find("input[name=content]").enter(function(){
			submitTask(this);
		});

		// Tag.user($canvas.find(".task-iform").find("input[name=name]"), Project.getPeople());
		$canvas.find(".task-status").click(function() {
			// Don't check status when create new task
			if ($canvas.find('.bform-wrapper')) {
				return;
			}

			var val=parseInt($canvas.find("input[name=status]").val());
			if (val==1){
				val=0;
			}else{
				val=1;
			}
			
			$canvas.find("input[name=status]").val(val);
			if (val){
				$canvas.find(".task-status").addClass("-done");		
			}else{
				$canvas.find(".task-status").removeClass("-done");
			}
			
			$canvas.find("input[name=name]").focus();
		});
		
		if ($canvas.find(".action.-js-avatar").hasClass("-readonly")) {

		} else {
			Form.inlineTagger($canvas.find(".action.-js-avatar"), {
				title: "NgÆ°á»i thá»±c hiá»‡n",
				select: function(user){
					setUser($(this).closest(".task-iform"), user);
				},	
				filter: function(user){
					return Project.isMember(user);
				},
				position:{
					top:35
				},
				more: "People outside project/team",
				remove: function(){
					$(this).closest(".task-iform").find("input[name=assign]").val("");
					$(this).closest(".task-iform").find(".action.-js-avatar .avatar-add").html("<div class='ph'><span class='-ap icon-uniF13B'></span></div>");
					$(this).closest(".task-iform").find(".action.-js-avatar em.v").html("Giao cho");
				}
			});
		}

		Form.inlineTagger($canvas.find(".action.-js-delegator"), {
			title: "NgÆ°á»i giao",
			select: function(user){
				setDelegator($(this).closest(".task-iform"), user);
			},	
			filter: function(user){
				var delegators = Client.delegators;
				return AP.array.indexOf(delegators, user, function (a, b) {
					return a.delegator_username == b.username;
				}) != -1;
			},
			position:{
				top:35
			},
			remove: function(){
				$(this).closest(".task-iform").find("input[name=delegator]").val("");
				$(this).closest(".task-iform").find(".action.-js-delegator .avatar-add").html("<div class='ph'><span class='-ap icon-uniF13B'></span></div>");
				$(this).closest(".task-iform").find(".action.-js-delegator em.v").html("NgÆ°á»i giao");
			}
		});

		// Form.inlineDatePicker($canvas.find(".action.-js-start-date"), function(date) {
		// 	$(this).closest(".task-iform").find("input[name=start_time]").val(AP.time.time("%d/%m/%Y", date));
		// 	$(this).closest(".task-iform").find(".action.-js-start-date em.v").html(AP.time.time("%d/%m/%Y", date));
		// }, {
		// 	position: {
		// 		top: 32,
		// 		left: -40
		// 	}
		// });
		
		// Form.inlineDatePicker($canvas.find(".action.-js-deadline"), function(date) {
		// 	$(this).closest(".task-iform").find("input[name=deadline]").val(AP.time.time("%d/%m/%Y", date));
		// 	$(this).closest(".task-iform").find(".action.-js-deadline em.v").html(AP.time.time("%d/%m/%Y", date));
		// }, {
		// 	position: {
		// 		top: 32,
		// 		left: -40
		// 	}
		// });

		// TAGGING MILESTONES
		if ($canvas.find(".action.-js-milestone").hasClass("-readonly")) {

		} else {
			Form.inlineLabelTagger($canvas.find(".action.-js-milestone"), function(item){
				var mid=$(item).data("id");
				if (mid==-1){
					return addMilestone();
				}
				
				setMilestone($(item).closest(".task-iform"), Milestone.fromContext(mid));
			}, {
				labels: Milestone.project.options(Client.pageData.project),
				position:{top:32, left:-20},
				click: true,
				search: true,
				selected: [],
				title: "LiĂªn káº¿t má»¥c tiĂªu",
				filter: false
			});	

			$canvas.find(".action.-js-milestone").click(function (e) {
				// Prevent clicking event in search button causes close milestone boxes
				if (e.target.tagName != 'INPUT') {
					$(this).toggleClass('activated');
				}
			});

			$canvas.find(".action.-js-milestone .api-tags .js-tagitem").click(function(){
				$canvas.find(".action.-js-milestone").toggleClass('activated');
			});
		}

		// TAGGING TAKLISTS
		if ($canvas.find(".action.-js-tasklist").hasClass("-readonly")) {

		} else {
			Form.inlineLabelTagger($canvas.find(".action.-js-tasklist"), function(item){
				setTasklist($(item).closest(".task-iform"), TaskList.fromContext($(item).data("id")));
			}, {
				labels: Client.pageData.tasklists,
				position:{top:32, left:-20},
				click: false,
				selected: [],
				title: "Set tasklist",
				filter: false
			});
		}

		// TAGGING TAGS
		Form.inlineLabelTagger($canvas.find(".action.-js-tags"), function(item){
			setTimeout(function(){
				setTags(item)
			});
		}, {
			labels: Task.option.tags(Client.pageData.project, true),
			position:{top:32, left:-20},
			click: false,
			selected: [],
			title: "Chá»n nhĂ£n",
			filter: false,
			multi: true
		});
	};
	
	
	/**
	 * @desc Finally submitting task
	 */
	function submitTask(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (code.updated_tags){
				if (Client.pageData.project){
					Client.pageData.project.tags=code.updated_tags;
					Client.pageData.context.tags=code.updated_tags;
					Project.taglist.reload(Client.pageData.project, Client.pageData.project.tags);
				}
			}
			
			var id=$(ref).closest(".js-form-wrap").attr("id");
			Side.milestone.update(code);
			Project.on.taskCreated(code.task);
			
			rebuildForm(id);
		});
	};
	
	
	/**
	 * @desc Set the default user
	 */
	function setUser($canvas, user, readonly){
		if (readonly){
			$canvas.find(".action.-js-avatar").addClass("-readonly");
		}
		
		if (!user){
			$canvas.find("input[name=assign]").val("");
			$canvas.find(".action.-js-avatar .avatar-add").html("");
			$canvas.find(".action.-js-avatar em.v").html("Assign to");
		}
		
		$canvas.find("input[name=assign]").val(user.username);
		$canvas.find(".action.-js-avatar .avatar-add").html("<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div>");
		$canvas.find(".action.-js-avatar em.v").html(user.name);
	};


	/**
	 * @desc Set the default user
	 */
	function setDelegator($canvas, user, readonly){
		
		if (!user){
			$canvas.find("input[name=delegator]").val("");
			$canvas.find(".action.-js-delegator .avatar-add").html("");
			$canvas.find(".action.-js-delegator em.v").html("Assigner");
		}
		
		$canvas.find("input[name=delegator]").val(user.username);
		$canvas.find(".action.-js-delegator .avatar-add").html("<div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div>");
		$canvas.find(".action.-js-delegator em.v").html(user.name);
	};
	
	
	/**
	 * @desc Setting tasklist directly
	 */
	function setTasklist($canvas, tasklist, readonly){
		if (!tasklist){
			return;
		}
		
		if (readonly){
			$canvas.find(".action.-js-tasklist").addClass("-readonly");
		}
		
		$canvas.find(".action.-js-tasklist .api-tag").each(function(){
			if (tasklist.id==$(this).data("id")){
				$(this).addClass("selected");
			}else{
				$(this).removeClass("selected");
			}
		});
		
		$canvas.find("input[name=tasklist_id]").val(tasklist.id);
		$canvas.find(".action.-js-tasklist em.v").html("NhĂ³m cĂ´ng  viá»‡c: <em>"+tasklist.name+"</em>");
	};
	
	
	
	/**
	 * @desc Setting milestone directly
	 */
	function setMilestone($canvas, milestone, readonly){
		if (!milestone){
			return;
		}
		
		if (readonly){
			$canvas.find(".action.-js-milestone").addClass("-readonly");
		}
		
		$canvas.find(".action.-js-milestone .api-tag").each(function(){
			if (milestone.id==$(this).data("id")){
				$(this).addClass("selected");
			}else{
				$(this).removeClass("selected");
			}
		});
		
		$canvas.find("input[name=milestone_id]").val(milestone.id);
		if (milestone.id && parseInt(milestone.id) && parseInt(milestone.id)>0){
			$canvas.find(".action.-js-milestone em.v").html("Má»¥c tiĂªu: <em>["+AP.time.time("%d/%m", milestone.time)+"] "+milestone.name+"</em>");	
		}else{
			$canvas.find(".action.-js-milestone em.v").html("Chá»n má»¥c tiĂªu");
		}
	};
	
	
	
	function setTags(selected){
		var id=$(selected).data("id");
		if (id==-2 || id=="-2"){
			$(selected).removeClass("selected");
			var id=$(selected).closest(".js-form-wrap").attr("id");
			Project.taglist.quickCreate(Client.pageData.project, function(tag){
				AP.xRefresh(function(){
					setTimeout(function(){
						rebuildForm(id);
					}, 300);
				});
			});
			return;
		}
		
		if (id==-1 || id=="-1"){
			$(selected).removeClass("selected");
			AP.confirm("You need to move to another page for this setting. Move anyway?", function(){
				return AP.toURL(Client.pageData.project.path+"/settings?s=tags");
			});
			
			return;
		}
		
		var $list=$(selected).closest(".api-tags");
		var tags=[];
		$list.find(".api-tag.selected").each(function(){
			tags.push($(this).data("id"));
		});
		
		if (tags.length){
			$list.closest(".action").find("em").html("Danh sĂ¡ch nhĂ£n: <em>"+tags.join(", ")+"</em>");	
		}else{
			$list.closest(".action").find("em").html("Chá»n nhĂ£n");
		}
		
		$list.closest(".task-iform").find("input[name=tags]").val(tags.join(", "));
	};
	
	
	
	
	/**
	 * @desc Add a new milestone
	 */
	function addMilestone(){
		AP.confirm("Confirm to add a new milestone? Unsaved inputs may be lost.", function(){
			Milestone.create();
		});
	};
	
	
	function rebuildForm(id){
		$("#"+id).closest(".js-group").find(".group-cta.url").click();
		
		setTimeout(function(){
			$("#"+id).find("input[name=name]").focus();
		}, 200);
	};
	
};


Task.option = new function __TaskOption() {
	this.urgencies = function () {
		return [
			{
				label: "BĂ¬nh thÆ°á»ng",
				value: "0",
				color: "0",
				name: "BĂ¬nh thÆ°á»ng",
				id: 0
			},
			{
				label: "Kháº©n cáº¥p",
				value: "1",
				color: "8",
				name: "Kháº©n cáº¥p",
				id: 1
			}
		];
	};


	this.importances = function () {
		return [
			{
				label: "BĂ¬nh thÆ°á»ng", value: "0", color: "0", name: "BĂ¬nh thÆ°á»ng", id: 0
			},
			{
				label: "Quan trá»ng", value: "1", color: "4", name: "Quan trá»ng", id: 1
			}
		];
	};


	this.reviews = function (assignee) {
		if (assignee) {
			return [
				{
					label: "Chá» review", value: "0", color: "6", name: "Chá» review", id: 0
				},
				{
					label: "Äang lĂ m", value: "2", "color": "7", name: "Äang lĂ m", id: 2
				}
			];
		}
		return [
			{
				label: "Chá» review", value: "0", color: "6", name: "Chá» review", id: 0
			},
			{
				label: "HoĂ n thĂ nh", value: "1", "color": "4", name: "HoĂ n thĂ nh", id: 1
			},
			{
				label: "Äang lĂ m", value: "2", "color": "7", name: "Äang lĂ m", id: 2
			}
		];
	};

	this.tags = function (context, add_button) {
		if (!context) {
			context = Project.inspect();
		}

		if (!context) {
			return [];
		}

		var tags = context.tags;

		var r = AP.select(tags, function (e) {
			e.id = e.key;
			return e;
		});

		if (add_button) {
			r.push({
				label: "ThĂªm nhanh nhĂ£n má»›i",
				name: "ThĂªm nhanh nhĂ£n má»›i",
				value: -2,
				color: 0,
				id: -2,
				icon: "-ap icon-plus3"
			});
			r.push({
				label: "Quáº£n lĂ½ vĂ  sá»­a nhĂ£n",
				name: "Quáº£n lĂ½ vĂ  sá»­a nhĂ£n",
				value: -1,
				color: 0,
				id: -1,
				icon: "-ap icon-price-tag2"
			});
		}

		return r;
	};
};


Task.field=new function __TaskField(){
	this.date=function(val){
		if (!parseInt(val)){
			return "<span class='empty-date'></span>";
		}
		
		return AP.time.time("%d/%m/%Y", val);
	};
	
	
	this.val=function(task, field){
		var row=AP.array.single(task.form, function(e){
			return e.id==field.id;
		});
		
	
		if (!row){
			return "";
		}
		
		if (row.type=="int" || row.type=="float"){
			if (row.value=="false" || row.value===false){
				return "";
			}
		}
		
		return row.value;
	};
	
	
	this.display=function(task, field){
		var row=AP.array.single(task.form, function(e){
			return e.id==field.id;
		});


		if (field.type=="checkbox"){
			if (!row){
				return "<div class='cb -v' data-value=''><div class='task-status relative'></div></div>";
			}

			if (row.value=="yes"){
				return "<div class='cb -done -v' data-value='yes'><div class='task-status custom-done relative'></div></div>";
			}
			
			return "<div class='cb -v'  data-value=''><div class='task-status relative'></div></div>";
		}
		
		if (!row){
			return "";
		}	
		
		if (field.type=="int"){
			if (!AP.data.isInt(row.value)){
				return "";
			}
			return AP.data.numberFormat(row.value);
		}
		
		if (field.type=="date"){
			return row.display;
		}

		if (field.type=="float"){
			return row.value;
		}

		if (field.type=="datetime"){
			if (row.display == row.value) {
				return row.value;
			}
			return row.display;
		}
		
		return row.value;
	};
	
};


Task.inline=new function __TaskInline() {

	this.fix = function(id, key, value, ref) {
		return this.edit(id, {key: key, value: value}, ref);
	};

	this.edit = function(id, kv, ref) {

		UI.ajaxShow();
		AP.post("api/task/fix",{id: id, key: kv.key, value: kv.value}, function(code){
			UI.ajaxHide();	
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Task updated ...");

			if (code.comment) {
				Task.inline.insertComment(code.comment, code.task);
			}

			if (kv.key=="milestone") {
				Side.milestone.update(code);
			}
			
			Task.ie.close();
			Project.on.taskUpdated(code.task);

			if (kv.key == "tasklist") {
				$("#tasklists .li").setActive(".li-"+id);
			}
		});
	};
	
//	
//	this.editDuration=function(id, start, deadline, ref){
//		UI.ajaxShow();
//		AP.post("api/task/fix",{id: id, key: "duration", start: start, deadline: deadline}, function(code){
//			UI.ajaxHide();
//			
//			if (!code.good()){
//				return AP.alertError(code.message);
//			}
//			
//			UI.flash("Task updated ...");
//			Project.on.taskUpdated(code.task);
//		});
//	};
//	
	
	this.editStartTimeDeadline = function(id, start, deadline, ref) {
		UI.ajaxShow();
		AP.post("api/task/fix",{id: id, key: "starttime.deadline", start: start, deadline: deadline}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Task updated ...");
			Project.on.taskUpdated(code.task);
		});
	};
	
	
	this.assign=function(id, uid, ref){
		this.edit(id, {key: "assign", value: uid}, ref);
	};


	this.updateTaskList=function(id, list_id, ref){
		this.edit(id, {key: "tasklist", value: list_id}, ref);
	};


	this.editCustom=function(id, kv, ref){
		this.edit(id, kv, ref);
	};
	
	
	/**
	 * @desc Remove a task
	 */
	this.remove=function(id, ref){
		AP.confirm("Báº¡n cĂ³ cháº¯c cháº¯n muá»‘n xĂ³a cĂ´ng viá»‡c nĂ y?", function(){
			UI.ajaxShow();
			AP.post("api/task/remove",{id: id}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("CĂ´ng viá»‡c Ä‘Ă£ Ä‘Æ°á»£c xĂ³a ...");
				Side.milestone.removeTask(code);
				Project.on.taskDeleted(id);
			});
		});
	};

	
	
	/**
	 * @desc Edit a custom field
	 */
	this.editCustomField = function(task, fid, ref) {

		if (!task) {
			return;
		}

		var project = Client.pageData.project;
		if (typeof project === 'undefined') {
			project = Client.tempData.context;
		}

		var row = AP.array.findObjWithStringID(project.form, fid);
		if (!row) {
			return;
		}

		var field = AP.array.findObjWithStringID(task.form, fid);

		if (field) {
			if (row.type == 'datetime') {
				if (field.display) {
					var display = field.display.split(" ");
					if (display[0].length < display[1].length) {
						field.display = display[1] + " " + display[0];
					}
				}
			}
			value=field.display;
			field.value = field.display;
		} else {
			field = {
				id:row.id, 
				name:row.name, 
				value:"", 
				display:"", 
				type:row.type, 
				options:row.options, 
				placeholder:row.placeholder
			};
		}

		var data = {id: task.id, key: "custom_field", fid:fid};
		
		var form = Form.create('fly-edititem-fx',{'action': "api/task/fix"})
		.row(
			Form.label({label: "TĂªn cĂ´ng viá»‡c *"}),
			Form.input({name: 'name', type:"fake"}).value(task.name)
		).addClass("-big")
		.customForm([row], [field])
		.render(function (form) {

			Task.ui.displayPlaceholder();

			displayFormTable();

			if (row.type == 'input-table') {
				renderExpandButton(form, task, row.id);
			}

			Form.select.improve($("#fly-edititem-fx .row .select select:not([multiple])"));
		})
		.buttons([
			 {label: "LÆ°u", action: function(){
				 Form.submit("#fly-edititem-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 UI.flash("ÄĂ£ sá»­a thĂ nh cĂ´ng...");
					 Form.hide("fly-edititem-fx");
					 
					 Task.update(code.task, code.comment);
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-edititem-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data);
	
		Form.pop({id:'fly-edititem-dx', width: 640, label: "Chá»‰nh sá»­a giĂ¡ trá»‹ trÆ°á»ng tĂ¹y chá»‰nh"}).setForm(form).show().focus('value');
	};


	this.extendEditCustomField = function (task, fid) {

		if (!task) {
			return;
		}

		var project = Client.pageData.project;
		if (typeof project === 'undefined') {
			project = Client.tempData.context;
		}

		var row = AP.array.findObjWithStringID(project.form, fid);
		if (!row && row.type != 'input-table') {
			return;
		}

		var field = AP.array.findObjWithStringID(task.form, fid);

		if (field) {
			value = field.display;
			field.value = field.display;
		} else {
			field = {
				id:row.id,
				name:row.name,
				value:"",
				display:"",
				type:row.type,
				options:row.options,
				placeholder:row.placeholder
			};
		}

		var data = {id: task.id, key: "custom_field", fid:fid};

		var form = Form.create('fly-edititem-fx',{'action': "api/task/fix"})
		.row(
			Form.label({label: "TĂªn cĂ´ng viá»‡c *"}),
			Form.input({name: 'name', type:"fake"}).value(task.name)
		).addClass("-big")
		.customForm([row], [field])
		.render(function (form) {

			renderExpandTable(form, "fly-edititem-dx");
		})
		.buttons([
			 {label: "LÆ°u", action: function(){
				Form.submit("#fly-edititem-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}

					UI.flash("ÄĂ£ sá»­a thĂ nh cĂ´ng...");
					Form.hide("fly-edititem-fx");

					Task.update(code.task, code.comment);
				})
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function() {
				 Form.hide("fly-edititem-fx");
			 }, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data);

		Form.pop({id:'fly-edititem-dx', width: 640, label: "Chá»‰nh sá»­a giĂ¡ trá»‹ trÆ°á»ng tĂ¹y chá»‰nh"}).setForm(form).show().focus('value');
	};


	function renderExpandTable(form, form_id) {

		var table =  ".form.form-dialog .input-custom-table .base-table table";
		var table_wrapper = ".form.form-dialog .input-table-master-wrapper";
		var header = ".form.form-dialog .input-custom-table .base-table thead";
		var body = ".form.form-dialog .input-custom-table .base-table tbody";
		var header_cell = ".form.form-dialog .input-custom-table .base-table thead td";
		var cell = ".form.form-dialog .input-custom-table .base-table tbody td";
		var row = ".form.form-dialog .input-custom-table .base-table tbody tr";

		$(".form.form-dialog .row.-isinput-table .label").css("width", "unset");

		$(header).addClass("thead").css({
			"position": "relative",
			"z-index": 1001
		});

		$(body).addClass("tbody");
		$(header_cell).each(function () {
			$(this).addClass("th").attr("title", $(this).text());
		});
		$(cell).addClass("td");
		$(row).addClass("tr");

		$(header_cell).each(function () {
			$(this).data("width", $(this).css("width"));
		});
		$(table).parent().css({
			"max-height": 500,
			"width": "100%",
			"overflow-y": "auto"
		});

		// Support scroll and fixed left column
		$(table_wrapper).find(".input-table-master").css({"width" : "100%"});
		$(body).find(".input-tr-action").closest("td").addClass('-fl').css({"z-index": 1000});
		$(table_wrapper).removeClass("scroll-x");

		// Update fixed left column when new row is added
		$(".input-add-more .js-add-more").click(function ()  {

			$(table).parent().off('scroll');
			$(body).find(".input-tr-action:last").closest("td").addClass('-fl').css({"z-index": 1000});;
			BaseTable.init(table, {
				height: "auto",
				width: "auto",
				sortable: false,
				padding: 16,
				layout: "normal"
			});
		});

		BaseTable.init(table, {
			height: "auto",
			width: "auto",
			sortable: false,
			padding: 16,
			layout: "normal"
		});

		if (!mobile()) {
			var header_width = $(header).width();
			var window_width = $(window).width() - 60;
			var dialog_width = Math.max(Math.min(1200, header_width), 640);
			dialog_width = Math.min(window_width, dialog_width);
	
			$("#"+(form_id)+"").width(dialog_width);
			$('.__fdialog .__dialogmain').css('max-width', 'unset');

			AP.dialog(form_id).balance();
		}
	};


	function renderExpandButton(form, task, fid) {

		if (mobile()) {
			return;
		}

		form.findRow("custom_"+(fid)+"").append("<div class='url expand-btn' data-fid="+(fid)+" data-url='action/"+(task.id)+"/expandfedit'> <span>Má»Ÿ rá»™ng</span> </div>");
	};


	/**
	 * @desc Safely insert comment
	 */
	this.insertComment = function(comment, origin){
		if (!comment){
			return;
		}
		
		if (comment.metatype=="system"){
			Comment.insertLog("#js-task-logs", comment);
			return;
		}
		
		if (!origin){
			return;
		}
		
		$canvas = $('#task-comments');
		Comment.ui.insert($canvas, origin, comment);
		
		// $canvas.trigger("commentposted", code.task);
		// $canvas.find(".comment-counter-"+origin.gid).html(origin.stats.comments);
		// AP.fire("comment.posted", [origin, comment]);
	};


	/**
	 * @desc Safely update tasklist
	 */
	this.updateTaskList = function(task, new_tasklist) {

		var status=$("#task-"+task.id).data("status");

		if (parseInt(status)){
			$("#task-"+task.id).appendTo("#tasklist-"+new_tasklist.id+" .-done .list.tasks");
		}else{
			$("#task-"+task.id).appendTo("#tasklist-"+new_tasklist.id+" .-normal .list.tasks");
		}

		$("#js-project-task .js-task-main .desc .js-select-tl").html(new_tasklist.name);
	};

	function displayFormTable() {
		$(".row .input-table .visible-custom-table .base-table-wrapper .base-table thead td .cell").each(function(){
            $(this).addClass('ap-xdot');
            $(this).attr('title', $(this).html());
	  	});
	};
	
};


Task.fav=new function __ProjectFav(){
    this.toggle = function(ref) {
		var id=$(ref).closest(".js-task").data("id");
    	UI.fav.update("api/task/fav", {
    		target: {id: id}, 
    		list: [],
    	}, function(fav, list, code){
    		Client.pageData.favs=list;
    		Project.on.taskUpdated(code.task);
    	});
    	
    	return;
    };
    
    this.isFav=function(id){
    	return UI.fav.isFav(id, Client.pageData.favs);
    };
    
};


Task.action = new function __TaskAction() {
	this.follow = function (flag) {
		UI.ajaxShow();
		AP.post("api/task/action", { id: Client.tempData.task.id, flag: flag, user_id: Client.viewer.id, action: "follow" }, function (code) {
			UI.ajaxHide();
			if (!code.good()) {
				return AP.alertError(code.message);
			}

			TaskDisplay.taskUpdated(code.task);
		});
	};


	this.setFollow = function (user) {
		UI.ajaxShow();
		AP.post("api/task/action", { id: Client.tempData.task.id, flag: 1, user_id: user.id, action: "follow" }, function (code) {
			UI.ajaxHide();
			if (!code.good()) {
				return AP.alertError(code.message);
			}

			TaskDisplay.taskUpdated(code.task);

			if (window.location.href.indexOf("calendar") >= 0) {
				$("#js-project-item .actions .-close").hide();
			}
		});
	};


	/**
	 * @desc Setting real order
	 */
	this.setOrder = function (id, prev_id, tasklist_id) {
		UI.ajaxShow();
		AP.post("api/task/reorder", { id: id, prev_id: prev_id, tid: tasklist_id }, function (code) {
			UI.ajaxHide();
			if (!code.good()) {
				return AP.alertError(code.message);
			}
		});
	};


	this.edit = function (id) {

	};


	this.reassign = function (id) {
		if (AP.data.isObject(id)) {
			id = id.id;
		}

		Task.ie.close();
		UI.user.picker({
			title: "Chá»n má»™t ngÆ°á»i Ä‘á»ƒ giao viá»‡c",
			multi: false,
			callback: function (users) {
				if (users.length == 1) {
					Task.inline.assign(id, users[0]);
				}
			}
		});
	};



	this.addMulti = function (item) {
		var role = "followers";
		var data = { id: item.id, role: role };
		var label = "ThĂªm nhiá»u " + "ngÆ°á»i theo dĂµi";
		Tag.context(false);
		var form = Form.create('fly-task-add-multi-followers-fx', { 'action': "api/task/add.multi.followers" })
			.row(
				Form.label({ label: label }),
				Form.input({ name: 'name', type: "textarea", placeholder: "Sá»­ dá»¥ng @ Ä‘á»ƒ tag thĂªm nhiá»u ngÆ°á»i theo dĂµi", role: "tag" })
					.css({ height: 100, resize: 'vertical' })
					.extra("&rsaquo; <span class='url' onclick='Form.v2.quickTag(this)'>ThĂªm nhanh thĂ nh viĂªn theo nhĂ³m</span>")
			).addClass("-big")
			.buttons([
				{
					label: "ThĂªm", action: function () {
						Form.submit("#fly-task-add-multi-followers-fx", function (code) {
							Tag.context(true);
							if (!code.good()) {
								return AP.alertError(code.message);
							}

							Form.hide("fly-task-add-multi-followers-fx");
							UI.flash("ÄĂ£ thĂªm thĂ nh cĂ´ng...");
							AP.refresh();
						})
					}, style: 'ok -success -rounded bold'
				},
				{
					label: "Há»§y", action: function () {
						Form.hide("fly-task-add-multi-followers-fx");
					}, style: 'cancel -passive-2 -rounded'
				}
			]).hiddens(data);

		Form.pop({ id: 'fly-task-add-multi-followers-fx-dx', width: 450, label: label, layout: 'flat' }).setForm(form).show().focus('name');
	};


	this.importTable = function (project, task, table_field) {
		if (!project) {
			return AP.alertError('Invalid project');
		}

		if (!task) {
			return AP.alertError('Invalid task');
		}


		if (!table_field) {
			var table_fields = Project.getTableFields(project);

			if (!table_fields.length) {
				return AP.alertError('There is no table field in the project');
			}

			AP.selectAction(AP.select(table_fields, function (e) {
				return { "id": e.id, "label": e.name, "object": e, label_full: true }
			}), function (obj) {
				importTable(obj.id, task, project);
			}, { title: "Chá»n trÆ°á»ng dá»¯ liá»‡u báº£ng Ä‘á»ƒ nháº­p" });

		} else {
			importTable(table_field, task, project);
		}
	};


	this.exportTable = function (project, task, table_field) {

		if (!table_field) {
			var table_fields = Project.getTableFields(project);

			if (!table_fields.length) {
				return AP.alertError('There is no table field in the project');
			}

			return AP.selectAction(AP.select(table_fields, function (e) {
				return { "id": e.id, "label": e.name, "object": e, label_full: true }
			}), function (obj) {
				Task.action.exportTable(project, task, obj.id);
			}, { title: "Chá»n trÆ°á»ng dá»¯ liá»‡u báº£ng Ä‘á»ƒ xuáº¥t" });
		}

		var field = AP.array.findObj(task.form, table_field);

		if (!field) {
			field = AP.array.findObj(project.form, table_field);
			
			if (field && field.value == undefined) {
				field.value = "";
			}
		}

		if (!field) {
			return AP.alertError("KhĂ´ng tĂ¬m tháº¥y báº£ng nĂ y");
		}

		var values = Base64.decode(field.value);

		if (!isValidJSONString(values)) {
			values = [];
		} else {
			values = JSON.parse(values);
			if (!values || !AP.data.isArray(values)){
				values = [];
			}   
		}

		headers = getTableHeaders(field.placeholder);
		headers = AP.array.select(headers, function (e) {
			return e.name;
		});

		if (!headers || !headers.length) {
			return AP.alertError("KhĂ´ng tĂ¬m tháº¥y header cá»§a báº£ng");
		}

		var rows = [];
		AP.render(values, function (row) {
			if (!row || !AP.data.isArray(row)) {
				return '';
			}

			var row_vals = [];
			AP.render(row, function (v, v_index) {
				if (v_index >= headers.length) {
					return '';
				}

				row_vals.push(safe(v));
			});

			rows.push(row_vals);
		});

		AP.confirm("Xuáº¥t báº£ng nĂ y vĂ o file excel?", function () {
			return Base.io.exp({
				headers: headers,
				rows: rows,
				title: field.name
			});
		});
	}


	function isValidJSONString(str) {
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }


	function importTable(table_field, task, project) {

		var table_field = AP.array.findObj(project.form, table_field);
		if (!table_field) {
			return AP.alertError('TrÆ°á»ng dÅ© liá»‡u báº£ng khĂ´ng há»£p lá»‡');
		}

		var columns = getTableHeaders(table_field.placeholder)
		var data = { id: task.id, table_field: table_field.id };

		Base.importer.dialog({
			action: "api/task/import.table",
			rows: [],
			columns: columns,
			data: [],
			hiddens: data,
			title: "Nháº­p dá»¯ liá»‡u thuá»™c báº£ng "+(table_field.name)+""
		});
	};


	function getTableHeaders(hstring) {
		var parts = hstring.split('--br--');
		parts = ARR.filter(parts, function (e) {
			return e && e.length;
		});

		var headers = [];
		for (var i = 0; i < parts.length; i++) {
			var p = parts[i];

			p = p.replace(/\(([0-9\.]+)\)$/, function (m, p1) {
				return '';
			});

			p = $.trim(p);

			p = p.replace(/\[(.*)\]$/, function (m, p1) {
				return '';
			});

			p = p.replace(/,/g, '');

			p = $.trim(p);

			headers.push({
				name: p,
				label: p
			});
		}

		return headers;
	}
};


Task.file=new function __TaskFile(){

    this.removeAttachment = function (fileId){
        var task = Client.tempData.task;
        var params={task_id: task.id, id: fileId};

        AP.confirm("Báº¡n cĂ³ muá»‘n xĂ³a file nĂ y?", function(){
            UI.ajaxShow();
            AP.post("api/task/delete-file", params, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message);
                }

                UI.flash("File Ä‘Ă£ Ä‘Æ°á»£c xĂ³a ...");
                Project.on.taskUpdated(code.task);
            });
        });
    };


    this.removeResult = function (fileId){
        var task = Client.tempData.task;
        var params={id: task.id, fid: fileId};

        AP.confirm("Are you sure that you want to remove this file? It cannot be undone", function(){
            UI.ajaxShow();
            AP.post("api/task/result.fileremove", params, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message)
                }
                
                UI.flash("File Ä‘Ă£ Ä‘Æ°á»£c xĂ³a ...");
                Project.on.taskUpdated(code.task);
            });
        });
    }; 
};


Task.cs = new function __TaskCS(){
	this.current = function (task) {
		var order = Board.data.period_by;
		if (!order){
			order="created";
		}
		
		var time = 0;
		var stack=Client.pageData.stack;
		
		if (order == "deadline") {
			time = parseInt(task.deadline);
		} else if (order == "created") {
			time = parseInt(task.since);
		}else{
			time = parseInt(task.last_update);
		}

		var stime = parseInt(stack.stime);
		var etime = parseInt(stack.etime);

		if (time >= stime & time <= etime){
			return 1;
		}

		if (order == "deadline" && !time) {
			return 1;
		}

		return 0;
	};

	
	

	this.previous = function (task) {
		return !this.current(task);
	};
};




Task.ie=new function __TaskInlineEditForm(){
	this.init=function(ref, task, key){
		if (AP.data.isInt(task)){
			task=Task.fromContext(task);
		}
		
		if (!task){
			alert("CANNOT_FIND_TASK");
			return;
		}
		
		initCanvas(ref);
		$("#ie-body").css({top:0, left:0});
		if (key=="deadline"){
			$("#ie-body").css({left:-30});
		}
		
		var project=Project.fromContext(task.ns.id);

		if (!project){
			alert("CANNOT_FIND_PROJECT");
			return;
		}
		
		if (key=="duration"){
			return quickTextInline(task, key);
		}
		
		if (key=="tags"){
			return quickTagsInline(task, key, project);
		}

		if (key=="tasklist"){
			return quickTasklistInline(task, project);
		}

		if (key=="milestone"){
			return quickMilestoneInline(task, key, project);
		}

		if (key=="assign"){
			return quickAssignInline(task, key, project, ref);
		}
		
		if (key=="deadline"){
			if (parseInt(project.deadline_has_time)){
				return quickDeadlineAndTimeInline(task, key, project);	
			}
			
			return quickDeadlineDateInline(task, key, project);				
		}
		
		if (key=="starttime"){
			return quickStarttimeInline(task, key, project, ref);
		}
		
		initBody(task, key);
		
	};
	
	
	this.close=function(){
		$("#ie-wrapper-global").remove();
		
		if (mobile()){
			$(document.body).removeClass("xo");
		}
	};
	
	this.hide=function(){
		return this.close();
	};
	
	
	
	function initCanvas(ref){
		if ($("#ie-wrapper-global").length){
			$("#ie-wrapper-global").remove();
		}
				
		var style={};
		var top=$(ref).offset().top+$(ref).outerHeight();
		if (mobile()){
			top=$(ref).offset().top+20;
		}
		
		var left=$(ref).offset().left;
		
		style["padding-top"]=top+"px";
		style["padding-left"]=left+"px";
		
		var html="<div id='ie-wrapper-global' class='ie-wrapper-global'> <div class='ie-close' onclick='Task.ie.close();'></div> <div class='ie-wrapper scroll-y'> <div class='ie-close' onclick='Task.ie.close();'></div> <div class='ie-real-wrapper' style='"+(formatStyle(style))+"'> <div class='ie-close' onclick='Task.ie.close();'></div> <div class='ie-real'> <div id='ie-body' class='ie-body'></div> </div> </div> </div> </div>";
		
		if (mobile()){
			$(document.body).addClass("xo");
		}
		
		$(html).appendTo(document.body);
	};
	
	
	
	function quickTextInline(task, key){
		var html="<div class='white-form'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='"+(key)+"'/> <div class='input'><input name='value' type='text' placeholder='Enter value'></div> <div class='footer'> <div class='cta'>LÆ°u</div> <div class='cancel' onclick='Task.ie.close();'>Há»§y</div> </div> </div>";
		
		$(html).appendTo("#ie-body");
		$("#ie-body input").focus();
		
		$("#ie-body .cta").click(function(){
			var data=getData();
			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Project.on.taskUpdated(code.task);
			})
		});
	};
	
	
	
	function quickTagsInline(task, key, project){
		Form.inlineLabelTagger("#ie-body", function(item){
			var id=task.id;
			var tag=$(item).data("id");
			var $this=$("#ie-body");
			
			if (tag=="-1" || tag==-1){
				return AP.toURL(project.path+"/settings?s=tags");	
			}
			
			if (tag=="-2" || tag==-2){
				Project.taglist.quickCreate(project, function(tag){
					Task.inline.edit(id, {key: "tag", value: tag.name});
				});
				return;
			}
			
			Task.inline.edit(id, {key: "tag", value: tag}, $this);
		}, {
			labels: Task.option.tags(project, true),
			position:{top:2, left:0},
			click: true,
			selected: task.tags,
			title: "Chá»n nhĂ£n"
		});
		
		$("#ie-body").find(".ap-inline-tagger").click(function(){
			Task.ie.close();
		});
	};


	function quickTasklistInline(task, project) {

		var options = [];
		var cached_tasklist = AP.array.findObj(project.cached_tasklists, task.tasklist_id);
		cached_tasklist = cached_tasklist ? cached_tasklist : {id: 0, name: ""};

		// Get inline form options
		ARR.each(project.cached_tasklists, function(tasklist) {
			if (parseInt(tasklist.id) == 0) {
				options.push({name: 'ChÆ°a phĂ¢n loáº¡i', id: tasklist.id, color: 0, key: tasklist.id});
			} else {
				options.push({name: tasklist.name, id: tasklist.id, color: 0, key: tasklist.id});
			}
		});

		// Prevent change tasklist of subtask
		if (task.metatype == "subtask") {
			var tasklist_name = parseInt(cached_tasklist.id) > 0 ? cached_tasklist.name : 'ChÆ°a phĂ¢n loáº¡i';
			options = [{name: tasklist_name, id: cached_tasklist.id, color: 0, key: cached_tasklist.id}];
		}

		// Show inline form pick tasklist
		Form.inlineLabelTagger("#ie-body", function(item) {
			var new_tasklist = {
				id: $(item).data("id"),
				name: $(item).text()
			};

			task.tasklist_id = new_tasklist.id;

			Task.inline.edit(task.id, {key: "tasklist", value: new_tasklist.id});

			Task.inline.updateTaskList(task, new_tasklist);
		}, {
			labels: options,
			position:{top:2, left:-20},
			click: true,
			selected: [task.tasklist_id],
			title: "Chá»‰nh sá»­a nhĂ³m cĂ´ng viá»‡c",
			filter: false,
			search: true,
		});
	};


	function quickMilestoneInline(task, key, project){
		Form.inlineLabelTagger("#ie-body", function(item){
			var id=task.id;
			var tag=$(item).data("id");
			
			if (tag=="-1" || tag==-1){
				return Milestone.create();	
			}

			var old = AP.array.findObj(Client.pageData.milestones, task.milestone_id);
			if (old) {
				old.total = old.total - 1;
			}

			Task.inline.edit(id, {key: "milestone", value: tag});
		}, {
			labels: Milestone.project.options(project),
			position:{top:2, left:-20},
			click: true,
			selected: [task.milestone_id],
			title: "LiĂªn káº¿t má»¥c tiĂªu",
			filter: false,
			search: true,
		});
	};
	
	
	
	/**
	 * @desc Quickly assign a task to another
	 */
	function quickAssignInline(task, key, project, ref){
		var people=Project.getPeople(project);
		var left=0;
		if (ref && $(ref).tagName()=="em"){
			left=-180;
		}
		
		Form.inlineTagger("#ie-body", {
			title: "Giao cho",
			click: true,
			position: {top:5, left:left}, 
			select: function(user){
				var id=task.id;
				Task.inline.assign(id, user.id);
			},
			hide: function(){
				var $box=$(this).closest(".js-task");
				setTimeout(function(){
				}, 150);
			},
			remove: function(){
				var id=task.id;
				UI.ajaxShow();
				AP.post("api/task/delete-assign",{id: id}, function(code){
					UI.ajaxHide();

					if (!code.good()){
						return AP.alertError(code.message);
					}

					UI.flash("ÄĂ£ há»§y giao viá»‡c ...");
					Task.ie.close();
					Task.inline.insertComment(code.comment, code.task);
					Project.on.taskUpdated(code.task);
				});
			},
			footer: "<div onclick='Task.action.reassign("+(task.id)+")'>Giao cho ngÆ°á»i bĂªn ngoĂ i dá»± Ă¡n/phĂ²ng ban</div>",
			users: people
		});
	};
	
	
	
	function quickDeadlineDateInline(task, key, project){
		if (!parseInt(project.deadline_has_time)){
			extra='';
		}
		
		$("#ie-body").html("<div class='cform'> <div class='title'> Chá»n thá»i háº¡n </div> <div class='side'> <span class='action url' title='Remove task deadline' data-url='action/"+(task.id)+"/deadline-remove'>Bá» thá»i háº¡n</span> </div> <div class='relative js-date-picker'></div> </div>");
		
		var value=parseInt(task.deadline);
		Form.inlineDatePicker("#ie-body .js-date-picker", function(date){
			Task.ie.close();
			Task.inline.edit(task.id, {key: "deadline", value: AP.i18n.date(date)}, this);
		}, {
			click: true,
			clickOut: false,
			auto: false,
			position: {top:0, left:0},
			hide: function(){
			},
			value: value
		});
		
		Form.render("#ie-body");
		
		$("#ie-body .save").click(function(){
			var data=getData();
			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.ie.close();
				Task.inline.insertComment(code.comment, code.task);
				Project.on.taskUpdated(code.task);
			});
		});
	};
	
	
	function quickDeadlineAndTimeInline(task, key, project){
		var extra="<div class='extra'> <div class='row' style='padding-right:0px'> <div class='input'> <input type='text' data-role='date' name='deadline-date' placeholder='Chá»n ngĂ y' data-value='"+(task.deadline)+"'/> </div> </div> <div class='sep-10'></div> <div class='row'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='deadline'/> <div class='input'> <input type='text' data-role='time' name='deadline-time' data-value='"+(task.deadline)+"'/> </div> <div class='save'>LÆ°u</div> </div> </div>";
		
		if (!parseInt(project.deadline_has_time)){
			extra='';
		}
		
		$("#ie-body").html("<div class='cform'> <div class='title'> Chá»n thá»i háº¡n </div> <div class='side'> <span class='action url' title='Bá» thá»i háº¡n' data-url='action/"+(task.id)+"/deadline-remove'>Bá» thá»i háº¡n</span> </div> "+(extra)+" </div>");
		
	
		Form.render("#ie-body");
		
		$("#ie-body .save").click(function(){

			var data=getData();
			if (!data["deadline-date"] || !data["deadline-time"]) {
				// Do nothing when data invalid
				return;
			}

			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.ie.close();
				Task.inline.insertComment(code.comment, code.task);
				Project.on.taskUpdated(code.task);
			});
		});
	};
	
	
	
	
	function quickStarttimeInline(task, key, project, ref){
		var left=0;
		var top=0;
		
		if ($(ref).closest(".side-body").length){
			left=-150;
			top=5;
		}
		
		var extra="<div class='extra'> <div class='row' style='padding-right:0px'> <div class='input'> <input type='text' data-role='date' name='starttime-date' placeholder='Chá»n ngĂ y' data-value='"+(task.start_time)+"'/> </div> </div> <div class='sep-10'></div> <div class='row'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='start_time'/> <div class='input'> <input type='text' data-role='time' placeholder='Chá»n giá»' name='starttime-time' data-value='"+(task.start_time)+"'/> </div> <div class='save'>LÆ°u</div> </div> </div>";
		
		
		$("#ie-body").html("<div class='cform'> <div class='title'> Chá»n tgian </div> <div class='side'> <span class='action url' title='XĂ³a' data-url='action/"+(task.id)+"/starttime-remove'>XĂ³a</span> </div> "+(extra)+" </div>").css({left: left, top: top});
		
		Form.render("#ie-body");
		
		$("#ie-body .save").click(function(){
			var data=getData();
			UI.ajaxShow();
			AP.post("api/task/fix", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.ie.close();
				Task.inline.insertComment(code.comment, code.task);
				Project.on.taskUpdated(code.task);
			});
		});
	};
	
	
	
	
	function initBody(task, key){
		
	};
	
	
	
	/**
	 * @desc Get string formatting the element
	 */
	function formatStyle(styles){
		var html='';
		for (var key in styles){
			var value=styles[key];
			if (value===null){
				continue;
			}
			html+=""+(key)+":"+(value)+";";
		}
		
		return html;
	};
	
	
	
	/**
	 * @desc Get data inside the inline edit
	 */
	function getData(){
		var r={};
		var data=$("#ie-body :input").serializeArray();
		for (var i=0; i<data.length; i++){
			r[data[i].name]=data[i].value;
		}
		
		return r;
	};
};


Task.ui=new function __TaskUI(){
	
	this.grandState=function(task){
		if (parseInt(task.status)==1){
			return "done";
		}
		
		var stime=parseInt(task.start_time);
		if (stime && stime <= AP.time.now()){
			return "doing";
		}
		
		return "todo";
	};
	
	
	this.grandDeadline=function(task){
		if (!task.deadline || !parseInt(task.deadline)){
			return '';
		}
		
		var time=AP.time.time('%d/%m/%Y', task.deadline);
		if (Client.pageData.project && parseInt(Client.pageData.project.deadline_has_time)){
			time=AP.time.time('%H:%i %d/%m/%Y', task.deadline);
		}
		
		if (Compute.doneLate(task) || Compute.overdue(task)){
			return "<em class='red url' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'>"+(time)+"</em>";
		}
		
		return "<em class='url' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'>"+(time)+"</em>";
	};
	
	
	
	
	this.grandTime=function(task){
		var html='';
		if (parseInt(task.duration)){
			html=""+(AP.i18n.duration(task.duration, true))+"";
		}
		
		var time=this.grandDuration(task);
		
		if (html && time){
			return ""+(html)+", "+(time)+"";	
		}
		
		return ""+(html)+""+(time)+"";
	};
	
	
	
	this.grandDuration=function(task){
		var time='';
		if (parseInt(task.start_time) && parseInt(task.deadline)){			
			if (AP.time.sameMonth(task.start_time, task.deadline)){
				time="<em>"+(AP.time.time('%d',task.start_time))+"</em>-"+(AP.time.time('<em>%d</em>/%m',task.deadline))+"";
			}else{
				time="<em>"+(AP.time.time('%d/%m',task.start_time))+"</em> &#x203A; <em>"+(AP.time.time('%d/%m',task.deadline))+"</em>";
			}
		}else if (parseInt(task.start_time)){
			time="Started <em>"+(AP.time.time('%d/%m',task.start_time))+"</em>";	
		}else if (parseInt(task.deadline)){
			if (Client.pageData.project && parseInt(Client.pageData.project.deadline_has_time)){
				time=""+(AP.time.time('%H:%i <em>%d/%m</em>',task.deadline))+"";		
			}else{
				time="<em>"+(AP.time.time('%d/%m',task.deadline))+"</em>";	
			}
		}
		
		return time;
	};
	
	
	
	this.icons=function(task, project){
		var icons=[];
		
		if (parseInt(task.acl.name)){
			icons.push({icon: "ficon-pencil-square", title: "Chá»‰nh sá»­a", url:"action/"+task.id+"/edit", value: "", acl: task.acl.name});
		}
		
		if (parseInt(task.acl.time)){
			icons.push({icon: "ficon-calendar", title: "Thá»i háº¡n", url:"action/"+task.id+"/deadline", value: task.deadline, acl: task.acl.time});
			icons.push({icon: "ficon-play-circle", title: "NgĂ y báº¯t Ä‘áº§u", url:"action/"+task.id+"/startdate", value: task.start_time, acl: task.acl.time});
		}
		
		// icons.push({icon: "ficon-calendar", title: "ThĂªm vĂ o lá»‹ch", url:"#", value: "", data: task});
		
		if (parseInt(task.acl.desc)){
			icons.push({icon: "ficon-exclamation-circle", title: "Kháº©n cáº¥p", url:"action/"+task.id+"/urgent", value: task.urgent, acl: task.acl.desc});
			icons.push({icon: "ficon-bookmark", title: "Quan trá»ng", url:"action/"+task.id+"/important", value: task.important, acl:task.acl.desc});
			
			icons.push({icon: "ficon-bell", title: "Má»¥c tiĂªu", url:"action/"+task.id+"/milestone", value: task.milestone_id, acl:task.acl.desc});
			
			if (Client.path.app != 'tasks') {
				icons.push({icon: "ficon-tag", title: "Chá»n nhĂ£n", url:"action/"+task.id+"/tags", value: task.tags.join(",")});
			}
		}
		
		if (parseInt(task.acl.remove)){
			icons.push({icon: "ficon-trash-o", title: "XĂ³a cĂ´ng viá»‡c", url:"action/"+task.id+"/remove", acl: task.acl.remove});
		}
		
		return icons;
	};
	
	
	this.labels = function(task, project) {
		var labels = [];
		
		if (!Client.pageData.context && project) {
			labels.push({name: project.name, style:"tag-alt"+project.color+"-edge js-tag", url:project.path});
		}

		if (task.ns && !project) {
			labels.push({name: task.ns.name, style:"tag-alt"+0+" -no-project js-tag"});
		}
		
		if (Client.pageData.project && Client.pageData.milestones && Client.pageData.milestones.length && parseInt(task.milestone_id)) {
			var ms = Milestone.fromContext(task.milestone_id);
			if (ms) {
				var color = "main";
				labels.push({name: AP.time.time('%d/%m', ms.time)+" &rsaquo; "+ms.name, style:"tag-"+color+"-edge js-tag", url:"action/filter/milestone-"+ms.id, role:"milestone"});	
			}
		}
		
		if (Client.pageData.project && parseInt(Client.pageData.project.percent_completion) && parseInt(task.complete) && parseInt(task.complete) != 100) {
			labels.push({name: task.complete+"%", style: "std js-tag"});
		}
		
		if (parseInt(task.urgent) == 1) {
			labels.push({name: "Kháº©n cáº¥p", style:"x-error js-tag", url:"action/filter/urgent"});
		}
		
		if (parseInt(task.important) == 1) {
			labels.push({name: "Quan trá»ng", style:"x-hl js-tag", url:"action/filter/important"});
		}

		if (task.metatype == "subtask") {
			if (!Client.pageData.project) {
				labels.push({name: "CĂ´ng viá»‡c con cá»§a "+task.origin_export.name, style:"x-edge js-subtag", url:"action/filter/subtask"});	
			} else {
				labels.push({name: "CĂ´ng viá»‡c con", style:"x-edge js-subtag", url:"action/filter/subtask"});
			}
		}

		if (Compute.overdue(task)) {
			labels.push({name: "QuĂ¡ háº¡n", style:"std x-error js-tag", url:"action/filter/overdue"});
		}
		
		if (Compute.doneLate(task)) {
			labels.push({name: "HoĂ n thĂ nh muá»™n", style:"std x-overdue js-tag", url:"action/filter/donelate"});
		}
		
		if (!parseInt(task.status) && parseInt(task.deadline) && AP.time.sameDay(task.deadline, AP.time.now())) {
			labels.push({name: "Háº¿t háº¡n hĂ´m nay", style:"std x-hl js-tag", url:"action/filter/today"});
		}
		
		if (parseInt(task.start_time)) {
			labels.push({name: "<span class='ficon-caret-right'></span> báº¯t Ä‘áº§u "+AP.time.time("%d/%m/%Y", task.start_time), style:"std js-tag", url:"action/filter/start-"+AP.time.time("%d/%m", task.start_time), value: task.start_time});
		}
		
		if (task.tags && task.tags.length) {
			var tags = Project.taglist.parse(task.tags, project);
			for (var i=0; i<tags.length; i++) {
				labels.push({name: tags[i].name, style:"tag-alt"+tags[i].color+" -colorful js-tag", url:"action/filter/"+tags[i].key, role: "tag", color: tags[i].color});
			}
		}
		
		return labels;
	};
	
	
	this.info=function(task, project){
		var info_attachment='';
		var info_checklist='';
		var info_comment='';
		
		if (task.files && task.files.length){
			info_attachment="<span class='istat' title='Attachments'><span class='-ap icon-uniF10A'></span> "+(task.files.length)+"</span>";
		}
		
		if (task.checklists && task.checklists.length){
			info_checklist=Checklist.info(task.checklists);
		}
		
		if (task.stats && task.stats.comments && parseInt(task.stats.comments)){
			info_comment="<span class='istat' title='Comments'><span class='-ap icon-bubble3'></span> "+(task.stats.comments)+"</span>";
		}
		
		return "<span class='istats'>"+(info_comment)+""+(info_attachment)+""+(info_checklist)+"</span>";
	};


	this.displayField = function(form, array_group_forms) {
		var form_display = "&nbsp;";

        if (isFile(form)) {
            form_display = getFile(form);
        } else if (isTable(form)) {
        	form_display = getTable(form, array_group_forms);
        } else if (form.display) {
        	if (form.display == "<p></p>") {
        		form_display = "&nbsp;";
        	} else if (form.display.length) {
        		if (isFloat(form)) {
        			form_display = getFloat(form);
        		} else {
        			form_display = Task.ui.getLocalLink(form.display);
        		}
        	} else {
        		form_display = Task.ui.getLocalLink(form.display) + "&nbsp;";
        	}
        }

        return form_display;
    };


    function getFile(f){
		return "<div class='file-cf'><span class='a normal std' onclick=\"FileX.quickPreview('"+f.file_url+"');\">Xem trÆ°á»›c: "+f.file_name+"</span> OR <span class='a url normal std' data-url='"+Base.domain("api")+"/files/download?fid="+f.file_fid+"&name="+AP.urlEncode(f.file_name)+"'>Download</span></div>";
	}


	function getTable(form, array_group_forms) {

        if (!form.value) {
            form.value = "W10=";
        }

        var values = Base64.decode(form.value);

		if (!isValidJSONString(values)){
            return "&nbsp;";
        } else {
            values = JSON.parse(values);
            if (!values || !AP.data.isArray(values)){
                return "&nbsp;";
            }   
        }

        if (!values.length) {
            return "&nbsp;";
        }

		if (typeof form.placeholder !== 'undefined') {
            var headers = getHeaders(form.placeholder);
        } else if (typeof array_group_forms[form.id] !== 'undefined') {
            var row_def = array_group_forms[form.id];
            var headers = getHeaders(row_def.placeholder);
        }

        if (!headers || headers == []) {
            return "&nbsp;";
        }

		AP.render(values, function (val){
			if (headers.length > val.length) {
				for (let i = 0; i <= headers.length - val.length; i++) {
					val.push("");
				}
			}
		});

        var tw = 0;
        var cells = AP.render(headers, function(e){
            tw += e.w;

            if (e.adaptive_w){
                return "  " +Render.render('cell', {width:e.adaptive_w, fit:1}, "<div class='ap-xdot' title='"+(e.name)+"'>"+(e.name)+"</div>")+ '';    
            }
                
            return "  " +Render.render('cell', {lead:1, fit:1}, ""+(e.name)+"")+ '';
        });
        
        cells = "  " +Render.render('cell', {width: "45px" , lead:1}, "#")+ " "+(cells)+"";
        
        var rows = AP.render(values, function(row, index){
            if (!row || !AP.data.isArray(row)){
                return '';
            }
            
            var row_vals = AP.render(row, function(v, v_index){
                if (v_index >= headers.length){
                    return '';
                }
                
                return "  " +Render.render('cell', {lead:1}, ""+(safe(v))+"")+ '';
            });
            
            return "  " +Render.render('table_row', {}, '' +Render.render('cell', {index:1, first:1}, '' +Render.render('text_index', {index:index+1}, '')+ '')+ ""+(row_vals)+"")+ '';
        });

		var html = "  " +Render.render('table', {id: "input-custom-table" , inline:1}, '' +Render.render('table_header', {sm:1}, ""+(cells)+"")+ "<tbody>"+(rows)+"</tbody>")+ '';
        
        if (tw >5){
            html = "<div class='input-table-master-wrapper scroll-ready' style='width:100%; overflow-y:hidden; overflow-x: auto; padding-bottom:10px;'> <div class='input-table-master relative' style='width: "+(tw*100+45)+"px'> "+(html)+" </div> </div> ";
        }
        
        return html;
    };


    function getHeaders(hstring) {
        var parts = hstring.split('--br--');
        parts = ARR.filter(parts, function(e) {
            return e && e.length;
        });
        
        var headers = [];
        for (var i = 0; i < parts.length; i++) {
            var p = parts[i];
            var w = 1;
            var opts = null;

            p = p.replace(/\(([0-9\.]+)\)$/, function(m, p1){
                w = parseFloat(p1);
                return '';
            });

            p = $.trim(p);
            
            p = p.replace(/\[(.*)\]$/, function(m, p1) {
                opts = p1.split(",");
                opts = ARR.filter(opts, function(e) {
                    return e && e.length;
                });
                
                opts = ARR.select(opts, function(e) {
                    return $.trim(e);
                });
                
                return '';
            });
            
            headers.push({
                name: p,
                w: w,
                adaptive_w: w*100+"px",
                opts: opts,
            });
        }
       
        var tw = 0;
        for (var i=0; i<headers.length; i++){
            tw+=headers[i].w;
        }
        
        if (tw<=5){
            for (var i=1; i<headers.length; i++){
                headers[i].adaptive_w = (90*headers[i].w/(tw))+"%"; 
            }
            
            headers[0].adaptive_w = null;
        }
        
        return headers;
    };


    function isFile(form) {
        return form.type=="file" && form.display;
    };


    function isFloat(form) {
        return form.type == "float";
    };


    function isTable(form) {
        return form.type == "input-table";
    };


    function getFloat(form){
        if (AP.data.isNumber(form.display)) {
            return AP.data.numberFormat(form.display);
        }
        return form.display;
    };


	this.getLocalLink=function(content){
		if (content) {
			return content.toString().replace(/â‘/g,'&#92;').replace(/&#9290;/g, '&#92;');
		} else {
			return "";
		}
	};


	this.p2br=function(content){
		if (content) {
			return content.replace(/<p>/g, "").replace(/<*\/p>/g, "<br>");
		} else {
			return "";
		}
	};


	function isValidJSONString(str) {
        try {
            JSON.parse(str);
        } catch (e) {
            return false;
        }
        return true;
    }


    this.displayPlaceholder = function() {
		// $(".row .label .sublabel").each(function() {
		// 	if ($(this).html()) {
		// 		var sublabel = $(this).html().replace(/\-\-br\-\-/g, "<br>");
		// 		$(this).html(sublabel);
		// 	}
	 //  	});

	  	$(".row .input.data").find("input").each(function() {
			var placeholder = $(this).attr('placeholder');
			if (placeholder) {
				placeholder = placeholder.replace(/\-\-br\-\-/g, " ");
				placeholder = placeholder.replace(/<br\s*[\/]?>/gi, " ");
		    	$(this).attr("placeholder", placeholder);
		    }
	  	});

	  	$(".row .input.data").find("textarea").each(function() {
			var placeholder = $(this).attr('placeholder');
			if (placeholder) {
				placeholder = placeholder.replace(/\-\-br\-\-/g, "");
				placeholder = placeholder.replace(/<br\s*[\/]?>/gi, "");
		    	$(this).attr("placeholder", placeholder);
		    }
	  	});
	};
	
};


Task.attention=new function __TaskAttention(){
	this.list=function(tasks, canvas, opts){
		if (!opts){
			opts={};
		}
		
		opts=$.extend({limit: 10, auto_collapsed: false});
		
		if (!tasks || !tasks.length){
			if (opts.autocollapse){
				$(canvas).parent().hide();
			}
			
			return;
		}
		
		$(canvas).parent().find(".count").html(tasks.length);
		
		
		var html=AP.render(tasks, function(e, index){
			if (index>=opts.limit){
				if (index==opts.limit){
					return "<div class='imore'>"+(tasks.length-opts.limit)+" cĂ´ng viá»‡c khĂ¡c</div>";
				}
				return '';
			}
			
			return getTask(e);
		});
		
		$(canvas).html("<div class='task-elist'>"+(html)+"</div>");
		
		fixOverlap(canvas);
	};
	
	
	function getTask(task){
		var deadline='';
		
		if (parseInt(task.deadline)){
			deadline="<div class='tlabel'>"+(AP.i18n.date(task.deadline))+"</div>";
			if (Compute.overdue(task)){
				deadline="<div class='tlabel -red'>QuĂ¡ háº¡n</div>"
			}
		}
		
		var uc='';
		var icon="<div class='sicon -"+(Task.ui.grandState(task))+"'></div>";
		if (parseInt(task.urgent)){
			uc=' -urgent';
			icon="<div class='sicon -image'><img src='"+(Client.image_url)+"/icons/flag/1.png'/></div>";
		}
		
		return "<div class='itask "+(uc)+" url' data-url='task/"+(task.id)+"' data-feature='wework:wework_task_show:task'> "+(icon)+" <div class='iname'>"+(task.name)+"</div> <div class='iside clear-fix'>"+(deadline)+"</div> </div>";
	};
	
	
	function fixOverlap(canvas){
		$(canvas).find(".itask").each(function(){
			var len=$.trim($(this).find(".iside").text()).length;
			if (len){
				$(this).css({paddingRight: len*5+15});	
			}
		});
	};
};




var TaskDisplay = new function __TaskDisplay() {

	this.last_scroll = -1;
	
	this.display = function(id) {

		$(".note-popover").remove();
		
		if ($("#main-board").length || mobile()) {
			return TaskDisplay.displayDialog(id);
		}
		
		if ($("#js-calendar").length) {
			return TaskDisplay.displayDialog(id);
		}
		
		if (!$("#tasklists").length && !$("#acts").length) {
			return TaskDisplay.displayDialog(id);
		}

		MilestoneDisplay.close();
		
		if (Topic.display.visible()) {
			Topic.display.close();	
		}
		
		if ($("#project-master").length) {
			TaskDisplay.last_scroll = $("#project-master").scrollTop();
		}
		
		var task_canvas = document.getElementById('project-task-canvas');
		if (!task_canvas || task_canvas.style.display == 'none') {
			TaskCanvas.init();
		}

		AP.loadInlineURL("task/display", {id: id, view_token: Query.get("view_token")}, "#js-project-task", {
			start: function() {
				
			}, end: function() {
				if (mobile()) {
					$(document.body).removeClass("xo");
				}

				$(window).resize();
				
				scrollToTask(id);
			}, error: function() {
			}
		});
	};

	
	/**
	 * @desc Display a task in a dialog
	 */
	this.displayDialog = function(task_id) {

		AP.destroyDialog("#js-task-dialog");
		$("#js-task-dialog").remove();
		
		UI.ajaxShow();
		AP.customDialog("<div id='js-project-task'></div>", {id: "js-task-dialog"})
		.width(960)
		.addClass("-task-display")
		.css({right: $.sbWidth()})
		.closable(false) 
		.show();

		AP.loadInlineURL("task/display", {id: task_id, view_token: Query.get("view_token")}, "#js-project-task", {
			start: function() {
			}, end: function() {
				if (mobile()) {
					$(document.body).addClass("xo");
					$("#document").hide();
				}
				
				$("#js-project-task").prepend("<div class='task-dialog-header'> <div class='nav'> <div class='url' data-url='"+(Client.tempData.context.path)+"'> <span class='-ap icon-chevron-left22'></span> "+(Client.tempData.context.name)+" </div> </div> <div class='close' title='ÄĂ³ng' onclick='TaskDisplay.close();'><span class='-ap icon-close'></span></div> </div>");
				AP.dialog("#js-task-dialog").balance();
			}, error: function() {
				AP.destroyDialog("#js-task-dialog");
			}
		});
		
		return;
	};

	
	/**
	 * @desc Handle the case a task is updated on main display
	 */
	this.taskUpdated = function(task, key) {

		if (Client.tempData && Client.tempData.task && parseInt(Client.tempData.task.id) == parseInt(task.id)) {

			if (key) {
				if (key == "checklists") {
					initChecklists(task);
				}
				
				return;
			}
			
			Client.tempData.task = task;

			initMain(task);
			initDesc(task);
			initCTA(task);
			initResult(task);
			initChecklists(task);
			
			TaskDisplay.side.update(task);
		}
	};

	
	/**
	 * @desc Check if there is some task to be displayed
	 */
	this.visible = function() {

		return $("#project-item-canvas").length;
	};
	
	
	/**
	 * @desc Close a task display
	 */
	this.close = function() {

		TaskCanvas.close();
		AP.setURLParams({task: null});
		
		if (mobile()) {
			$(document.body).removeClass("xo");
			$("#document").show();
		};
		
		if ($("#project-master").length && TaskDisplay.last_scroll > 0) {
			$("#project-master").scrollTop(TaskDisplay.last_scroll);
			TaskDisplay.last_scroll = -1;
		}
	};
	
	
	/**
	 * @desc Rendering the task
	 */
	this.render = function() {

		initCanvas(Client.tempData.task);

		initMain(Client.tempData.task);

		initCTA(Client.tempData.task);

		initResult(Client.tempData.task);
		
		initChecklists(Client.tempData.task);

		initDesc(Client.tempData.task);

		initSubtasks(Client.tempData.task);
		
		TaskDisplay.side.init(Client.tempData.task);
		
		// Init comments
		Comment.auto("#js-task-comments", Client.tempData.task, {
			header: 0,
			theme: 'gray',
			autofocus: 0,
			tagdir: 'bottom',
			logs: 1,
			coc: 1
		});
		
		if (!mobile()) {
			$("#tasklists .li").setActive(".li-" + Client.tempData.task.id);
			$("#tasklists .li").removeClass("focusing");
			$("#tasklists .li-" + Client.tempData.task.id).addClass("focusing");	
		}
		
		// Set URLs
		AP.setURLParams({task:Client.tempData.task.id});
		Form.inlineCleaner("#js-project-task");

		$("#js-project-task").click(function(e) {
			Board.clean("#js-project-task", e.target);
		});
	};


	/**
	 * @desc popup the custom form table
	 */
	this.popupCustomTable = function(task, fid) {

		if (mobile()) {
			return;
		}

		var project = Project.fromContext(task.project_id);
		var task_form = task.form;
		var project_form = project.form;

		var array_group_forms = [];
		for (var i = 0; i < project_form.length; i++) {
			array_group_forms[project_form[i].id] = project_form[i];
		}

		var form = Task.helper.matchingForm(project_form, task_form);

		var custom_field = ARR.single(form, function(e) {
			return e.id == fid;
		});

		var html = Task.ui.displayField(custom_field, array_group_forms);

		var window_width = $(window).width();
		var dialog_w = Math.min(1200, window_width);
		
		if (!custom_field.value || custom_field.value == "W10=" ) {
			html = "  " +Render.render('empty', {icon: "table" , title: "Empty table" }, "Báº£ng nĂ y rá»—ng")+ '';
			dialog_w = 800;
		}

		html = "<div class='popup-custom custom-embed'>"+(html)+"</div>";

		Base.load({
			id: "js-popup-custom",
			html: html,
			header: custom_field.name,
			width: dialog_w,
		});

		var table_w = $('#js-popup-custom .input-table-master').css('width');

		if (parseInt(table_w) < dialog_w) {
			$('#js-popup-custom-dialog').css('width', parseInt(table_w));

			var dialog_left = $('#__apdialog_js-popup-custom-dialog .__dialogwrapper').css('left');

			dialog_left = (dialog_w - parseInt(table_w)) / 2 + parseInt(dialog_left);

			$('#__apdialog_js-popup-custom-dialog .__dialogwrapper').css('left', dialog_left);
		}

		var header = $('#js-popup-custom-dialog .base-load-wrapper .bl-header').html();
		var actions = "<div class='action url' data-url='action/"+(task.id)+"/exporttable' data-field='"+(custom_field.id)+"'>Xuáº¥t excel</div>";
		
		if (parseInt(task.acl.desc)) {
			actions += "<div class='action url' data-url='action/"+(task.id)+"/importtable' data-field='"+(custom_field.id)+"'>Nháº­p excel</div>";
		}

		if (mobile()) {
			actions = '';
		}

		header += "<div class='bl-side'>"+(actions)+"</div>";
	
		$('#js-popup-custom-dialog .base-load-wrapper .bl-header').html(header);

		return true;
	};

	
	/**
	 * @desc Initializing the canvas to show task
	 */
	function initCanvas(task) {

		var canvas = "<div class='section js-task-main'> <div class='task-header'></div> <div class='task-main'></div> <div class='task-cta'></div> <div class='task-desc' id='js-task-desc'> <div class='actions'> <div class='action js-edit'>Chá»‰nh sá»­a</div> <div class='action js-checklist' onclick='Checklist.showForm(this, 1);'>Táº¡o checklist</div> </div> <div class='title'>MĂ´ táº£ cĂ´ng viá»‡c</div> <div class='edit-box js-task-content'></div> <div class='js-task-files task-files'></div> </div> </div> <div class='section task-checklists' id='js-checklists'></div> <div class='section task-result' id='js-taskresult'></div> <div class='section' id='js-task-subtasks'> <div class='subtask-title'>CĂ´ng viá»‡c con</div> <div class='subtasks' id='js-subtasks-"+(task.id)+"'></div> </div> <div id='js-task-mobile-fix'></div> <div class='section task-comments'> <div class='top'> BĂ¬nh luáº­n (<span class='comment-count comment-counter-"+(task.gid)+"' id='comment-counter-"+(task.gid)+"'>"+(task.stats.comments)+"</span>) </div> <div id='js-task-comments'></div> </div>";
		
		$("#js-task-display .main-body").html(canvas);
		
		if (mobile()) {
			$("#js-task-display .side-body").appendTo("#js-task-mobile-fix");
		}
	}
	
	
	/**
	 * @desc Init main (header + general info + call to action)
	 */
	function initMain(task) {

		var project = Client.tempData.context;
		var tags_plain = task.tags.join(",");
		
		var labels = [];
		if (parseInt(task.urgent) === 1) {
			labels.push({name: "Kháº©n cáº¥p", style:"tag-error-more js-tag", url:"action/filter/urgent"});
		}
		
		if (parseInt(task.important) === 1) {
			labels.push({name: "Quan trá»ng", style:"tag-success-more js-tag", url:"action/filter/urgent"});
		}
		
		if (Compute.overdue(task)) {
			labels.push({name: "QuĂ¡ háº¡n", style:"tag-alt7-more x-error js-tag", url:"action/filter/overdue"});
		}
		
		if (Compute.doneLate(task)) {
			labels.push({name: "HoĂ n thĂ nh muá»™n", style:"tag-alt7-more x-error js-tag", url:"action/filter/donelate"});
		}
		
		if (task.tags && task.tags.length) {
			var tags = Project.taglist.parse(task.tags);
			for (var i = 0; i < tags.length; i++) {
				labels.push({name: tags[i].name, style:"tag-alt" + tags[i].color + " -colorful js-tag", url:"action/filter/" + tags[i].key, role: "tag", color: tags[i].color});
			}
		}
		
		var tags_html = AP.render(labels, function(e) {
			return "<div class='tag " + e.style + " url' data-url='" + e.url + "'>" + e.name + "</div>";
		});
		
		
		var add_tag = "<div class='tag js-task-detail -add url' data-src='task.display' data-xurl='action/" + task.id + "/tags' data-value='" + tags_plain + "'><span class='-ap icon-plus2'></span>&nbsp; ThĂªm nhĂ£n</div>";
		if (!parseInt(task.acl.desc)) {
			add_tag = "";
		}
		
		if (!tags_html || !tags_html.length) {
			if (!add_tag || !add_tag.length) {
				tags_html = "<span class='exp'>Chi tiáº¿t cĂ´ng viá»‡c</span>";
			}
		}
		
		var star = "<span class='ficon-star-o'></span>";
		if (UI.fav.isFav(task.id, Client.pageData.favs)) {
			star = "<span class='ficon-star text-yellow'></span>";
		}
		
		var urgent = "<div class='action -urgent"+(task.urgent)+" url' title='Toggle urgent flag' data-acl='"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/urgent' data-value='"+(task.urgent)+"'><span class='ficon-exclamation-circle'></span></div>";
		
		var important = "<div class='action url -important"+(task.important)+"' title='Toggle important flag' data-acl='"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/important' data-value='"+(task.important)+"'><span class='ficon-bookmark-o'></span></div>";
		if (parseInt(task.important)) {
			var important = "<div class='action url -important"+(task.important)+"' title='Toggle important flag' data-acl='"+(task.acl.desc)+"' data-xurl='action/"+(task.id)+"/important' data-value='"+(task.important)+"'><span class='ficon-bookmark'></span></div>";
		}
		
		if (!parseInt(task.acl.desc)) {
			urgent = "";
			important = "";
		}

		var tl = AP.array.findObj(project.cached_tasklists, task.tasklist_id);
		if (!tl) {
			tl = {id: 0, name: ""};
		}
		
		var edit_form = "<div class='edit-form'> <form method='post' action='api/task/fix'> <div class='row'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='name'/> <textarea class='-big' name='value'>"+(task.name)+"</textarea> </div> <div class='edit-ctas clear-fix'> <div class='save url' data-url='action/0/submitnow'>LÆ°u</div> <div class='cancel url' data-url='action/0/submitcancel'>Há»§y</div> <div class='note'>Nháº¥n Enter Ä‘á»ƒ lÆ°u nhanh &middot; <b class='url' data-url='action/0/submitcancel'>Há»§y</b></div> </div> </form> </div>";
		
		if (!parseInt(task.acl.name)) {
			edit_form = "";
		}
		
		var deadline = "Chá»n thá»i háº¡n";
		
		if (parseInt(task.deadline)) {
			deadline = AP.i18n.date(task.deadline);
			if (parseInt(project.deadline_has_time)) {
				deadline = AP.i18n.datetime(task.deadline);	
			}
		}
		
		deadline = "Thá»i háº¡n: <span class='url em inline' data-url='action/"+(task.id)+"/deadline' data-acl='"+(task.acl.time)+"'>"+(deadline)+"</div>";
		
		var startdate = "<em class='a normal js-set-startdate'>Chá»n ngĂ y báº¯t Ä‘áº§u</em>";
		if (parseInt(task.stime)) {
			startdate = "NgĂ y báº¯t Ä‘áº§u: <em>" + AP.i18n.datetime(task.stime) + "</em>";
		}

		deadline = "<div class='deadline'>" +
		"	<div class='url' data-url='action/" + task.id + "/startdate' data-src='' data-acl='" + task.acl.time + "'>" + startdate + "</div>" +
		"	<span class='inline'>&nbsp; <span class='-ap icon-arrow-right'></span> &nbsp;</span>" +
		"	<div class='deadline-display inline'>" + deadline + "</div>" +
		"</div>";
		
		var gen_prev = "";

		if (typeof task.data.gen_prev !== 'undefined') {
			var open_link = "data-url='"+(task.data.gen_prev.link)+"'";
			if (task.data.gen_prev.type == "projecttasks") {
				open_link = "onclick='TaskDisplay.openTaskNewTab("+(task.data.gen_prev.id)+")'";
			}
			gen_prev = "<div class='desc origin_link'> <span class='-ap icon-uniF143'></span>&nbsp; Linked to <span class='url' "+(open_link)+">"+(task.data.gen_prev.name)+"</span> </div>";
		}

		if (task.origin_export && task.origin_export.name && task.origin_export.type != "repeatedtasks") {
			gen_prev = "<div class='desc origin_link'> <span class='-ap icon-uniF143'></span>&nbsp; Linked to <span class='url' data-xurl='task/"+(task.origin_export.id)+"'>"+(task.origin_export.name)+"</span> </div>";
		}

		if (task.origin_export && typeof task.origin_export.abs_link != 'undefined' && task.origin_export.abs_link != '') {
			t_origin_lnk = task.origin_export.abs_link;
			gen_prev = "<div class='desc origin_link'> <span class='-ap icon-uniF143'></span>&nbsp; Linked to <span class='url' data-url='"+(task.origin_export.abs_link)+"'>"+(task.origin_export.name)+"</span> </div>";
		}
		
		var grand_state = Task.ui.grandState(task);
		var grand_state_html = '';
		if (grand_state == 'done') {
			grand_state_html = "<span class='ficon-check-circle text-success'></span>&nbsp; <b class='text-success'>HoĂ n thĂ nh</b> &middot;";
		} else if (grand_state == 'doing') {
			grand_state_html = "<span class='ficon-circle anim-showhide-inf' style='color:#5da4ed'></span>&nbsp; Äang lĂ m &middot;";
		} else {
			grand_state_html = "<span class='ficon-circle-o'></span>&nbsp; Cáº§n lĂ m &middot;";
		}

		var tl_name = parseInt(tl.id) ? tl.name : "ChÆ°a phĂ¢n loáº¡i";
		
		var html = "<div class='edit-box compact edit-task-name'> <div class='edit-display'><h1>"+(task.name)+"</h1></div> "+(edit_form)+" </div> <div class='desc'> "+(grand_state_html)+" Trong <span class='url url-detail' data-url='"+(project.path)+"'>"+(project.name)+"</span>&nbsp; &rsaquo; &nbsp; <span class='dd unselectable js-select-tl url' data-url='action/"+(task.id)+"/tasklist'>"+(tl_name)+"</span> </div> <div class='desc'><span class='-ap icon-uniF10B'></span>&nbsp; "+(deadline)+"</div> "+(gen_prev)+"";
		
		$("#js-task-display .task-main").html(html);
		var tags = "<div class='tags clear-fix'> "+(tags_html)+""+(add_tag)+"</div>";
		var options = (parseInt(task.acl.managed) ? ("<div class='action -more' onclick='Task.itemOptions(" + task.id + ");'><span class='-ap icon-dots-three-horizontal'></span></div>") : "");
		
		$("#js-task-display .task-header").html(
			""+(tags)+" <div class='actions'> <div class='action -close' title='Close task preview' onclick='TaskDisplay.close();'><span class='-ap icon-close'></span></div> <div class='action -star url' title='Toggle favourite task' data-xurl='action/"+(task.id)+"/star'>"+(star)+"</div> <div class='action -calendar url' title='Add to calendar' data-url='action/"+(task.id)+"/addtocalendar'><span class='ficon-calendar-plus-o'></span></div> "+(important)+" "+(urgent)+" "+(options)+" </div>");
		
		if (!parseInt(task.acl.name)) {
			$("#js-task-display .js-select-tl").removeClass("url");
		}

		if (task.metatype != "task") {
			$("#js-task-display .js-select-tl").removeClass("url dd");
			$("#js-task-display .js-select-tl").addClass("tasklist");
		}
		
		$("#js-project-task .edit-task-name .edit-display").click(function() {
			if (parseInt(task.acl.name)) {
				$(this).closest(".edit-box").addClass("editing");
			}
		});
		
		$("#js-project-task .edit-form textarea").autoExpand();
	};
	
	
	/**
	 * @desc Init task description, binding necessary events
	 */
	function initDesc(task) {

		var drive_button = '';
		if (!mobile() && Client.viewer.metatype != 'guest') {
			drive_button = "<div class='action js-upload-drive'>ThĂªm tĂ i liá»‡u tá»« Base Drive</div>";
		}

		var file_headers = "<div class='title'>TĂ i liá»‡u Ä‘Ă­nh kĂ¨m</div> <div class='actions'> <div class='action js-upload'>ThĂªm tĂ i liá»‡u</div> "+(drive_button)+" </div>";

		var task_files_html = '';
		if (!task.files || !task.files.length) {
			task_files_html = "<div class='text-a' style='padding-top:5px; padding-bottom:5px;'>KhĂ´ng cĂ³ tĂ i liá»‡u Ä‘Ă­nh kĂ¨m</div>";
		} else {
			var thumbnail_files = AP.array.filter(task.files, function(e) {
				return parseInt(e.image) == 1;
			});
			
			var thumbnail_files_html = AP.render(thumbnail_files, function(e) {
				return getThumbnailFile(e, task, "desc");
			});
			
			if (Base.config.file_preview) {
				thumbnail_files_html = "<div class='file-previews clear-fix'>"+(thumbnail_files_html)+"</div>";
			}

			thumbnail_files_html = "<div class='-box-file file-thumbnail'>" + thumbnail_files_html + "</div>";

			var list_files = AP.array.filter(task.files, function(e) {
				return parseInt(e.image) == 0;
			});

			var list_files_html = AP.render(list_files, function(e) {
				return getListFile(e, task, "desc");
			});

			list_files_html = "<div class='-box-file file-list'>" + list_files_html + "</div>";

			task_files_html = list_files_html + thumbnail_files_html;
		}

		$("#js-task-display .task-desc .js-task-files").html(file_headers + "<div class='files'>" + task_files_html + "</div>");

		$("#js-task-display .task-desc .js-task-files .js-file-remove").click(function() {
			var fid = $(this).data("id");
			Task.file.removeAttachment(fid);
		});

		Base.file.previewMultiples("#js-task-display .files", ".name");

		var content = "<div class='no-content'>ChÆ°a cĂ³ mĂ´ táº£ cho cĂ´ng viá»‡c nĂ y</div>";
		if (task.content && task.content.length) {
			content = Task.ui.getLocalLink(task.content);
		}

		var context = Client.pageData.context;
		if (typeof context == "undefined") {
			context = Client.tempData.context;
		}

		var project_form = context.form;
		var task_form = task.form;

		var array_group_forms = [];
		for (var i = 0; i < project_form.length; i++) {
			array_group_forms[project_form[i].id] = project_form[i];
		}

		project_form = Task.helper.matchingForm(project_form, task_form);
	
		var custom_fields = "";
		if (project_form && project_form.length) {
			custom_fields = "<div class='edit-custom'>" + AP.render(project_form, function(e) {
				var editable = "";
				if (parseInt(task.acl.desc)) {
					editable = "<div class='edit-icon url' data-url='action/"+(task.id)+"/fedit' data-fid='"+(e.id)+"'> <span class='ficon-pencil-square'></span> <span class='ap-f12'>Chá»‰nh sá»­a</span> </div>";
				}

				var custom_title = e.name;
				if (e.type == "input-table") {
					custom_title = "<span class='label url' data-url='action/"+(task.id)+"/popuptable' data-fid='"+(e.id)+"'> "+(e.name)+" &middot; <span class='ap icon-popup'></span> </span>";
				}

				return "<div class='cr'> <div class='lb ap-xdot' title='"+(e.name)+"'>"+(custom_title)+"</div> <div class='db'>"+(Task.ui.displayField(e, array_group_forms))+"</div> "+(editable)+" </div>";
			}) + "</div>";
		}
		
		var desc = "<div class='edit-display'> <div class='desc text-editor acl-"+(task.acl.desc)+"'> <div class='icon-desc -right'></div> "+(content)+" </div> </div> <div class='edit-form edit-content'> <form method='post' action='api/task/fix'> <input type='hidden' name='id' value='"+(task.id)+"'/> <input type='hidden' name='key' value='content'/> <div class='row'><textarea placeholder='MiĂªu táº£ cĂ´ng viá»‡c' name='value'></textarea></div> <div class='row clear-fix'> <div class='button -cta url' data-xurl='action/0/submitinline' data-key='content'>LÆ°u</div> <div class='cancel url' data-xurl='action/0/submitcancel'><span class='-ap icon-close'></span></div> </div> </form> </div>" +
		custom_fields + "";
		
		$("#js-task-desc .js-task-content").html(desc);
		$("#js-task-desc .js-task-content .desc").linkify();
		$("#js-task-desc .js-task-content .edit-custom").linkify();

		AP.uploadable("#js-task-desc .js-upload-drive", {
			action: "api/task/upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true,
			drive: true
		}, function(code) {
			if (code.good()) {
				initDesc(code.task);
				TaskDisplay.side.update(code.task);
			}
		});

		AP.uploadable("#js-task-desc .js-upload", {
			action: "api/task/upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true
		}, function(code) {
			if (code.good()) {
				initDesc(code.task);
				TaskDisplay.side.update(code.task);
			}
		});
		
		$("#js-task-desc .edit-box").removeClass('editing');
		$("#js-task-desc .js-edit").off('click');
		$("#js-task-desc .js-edit").click(function () {

			if (!$("#js-task-desc .ql-editor").length) {
				UI.editor("#js-task-desc textarea[name=value]", {
					minHeight: 100,
					value: Textarea.simple(task.content)
				});
			}

			if (parseInt(task.acl.desc)) {
				$("#js-task-desc .edit-box").addClass("editing");
			}
		});

		$("#js-project-task .edit-box textarea").enter(function() {
			Form.submitFrom(this, function(code) {
				if (!code.good()) {
					return AP.alertError(code.message);
				}

				UI.flash("ÄĂ£ lÆ°u thay Ä‘á»•i ...");
				Project.on.taskUpdated(code.task, code.comment);
			});
		});
	};
	
	
	/**
	 * @desc Scroll to an item when there is such item on the right
	 */
	function scrollToTask(task_id) {

		if ($("#tasklists").length && $("#task-" + task_id).length) {

			var pscroll = $("#tasklists").scrollTop();
			var ptop = $("#tasklists").offset().top;
			var ph = $("#tasklists").height();
			
			var etop = $("#task-" + task_id).offset().top;
			
			var rel_top = etop - ptop;
			var rel_bottom = rel_top + $("#task-" + task_id).height();
			
			if (rel_top < 0) {
				$("#tasklists").scrollTop(etop);
			} else if (rel_bottom > ph) {
				$("#tasklists").scrollTop(etop - ptop - 50);
			}
		}
	};
	
	
	/**
	 * @desc Init the main task cta
	 */
	function initCTA(task) {

		var assign = "<div class='avatar avatar-32 -circled'><div class='user-add'></div></div>" +
			"<div class='name' style='padding-top:8px;'>Giao cho</div>";
		
		var user = People.get(task.username);
		
		if (task.username && user) {
			assign = "<div class='avatar avatar-32 -circled'><div class='image'><img src='" + AP.xthumb(user.gavatar) + "'/></div></div>" +
			"<div class='name'>" + user.name + "</div>" +
			"<div class='info'>" + user.title + "</div>";
		}
		
		var label = "<div class='lb'>Äang lĂ m</div>";
		var exp = "Click Ä‘á»ƒ Ä‘Ă¡nh dáº¥u hoĂ n thĂ nh";

		if (parseInt(task.review)) {
			exp = "Äang chá» xĂ¡c nháº­n hoĂ n thĂ nh";
			label = "<div class='lb'>Äang chá» review</div>";
			
			if ((parseInt(task.acl.review) && task.metatype == "task") || (parseInt(task.acl.review_subtask) && task.metatype == "subtask")) {
				exp = "Click Ä‘á»ƒ xĂ¡c nháº­n hoĂ n thĂ nh";
			} else {
				
			}
		}

		var review_action = "";
		if (task.status == 0 && task.review == 0) {
			review_action = "";
		} else {
			review_action = "data-xurl='action/" + task.id + "/review'";
			if (task.user_id == Client.viewer.id) {
				review_action += " data-assignee='1'";
			}
		}

		if (!parseInt(task.status)) {
			label = "<div class='lb'>Äang lĂ m</div>";
		}
		
		var grand_status = "";
		if (parseInt(task.status)) {
			grand_status = "-done";
			label = "<div class='lb'>HoĂ n thĂ nh</div>";
			exp = '';
		} else if (parseInt(task.review)) {
			grand_status = "-review";
			label = "<div class='lb'>Chá» review</div>";
		}
		
		var duration = '';
		if (Client.tempData.context.task_duration) {

			var duration_text = "ChÆ°a xĂ¡c láº­p";
			if (parseInt(task.duration)) {

				duration_text = AP.i18n.duration(task.duration);

				if (Client.tempData.context.deadline_has_time) {
					duration_text = Task.helper.displayDurationHours(task.duration);
				}
			}

			duration = "<div class='task-duration acl-"+(task.acl.time)+" url' data-url='action/"+(task.id)+"/duration'> <div class='label'>Tgian Ä‘á»‹nh má»©c</div> <div class='value'>"+(duration_text)+"</div> </div>";
		}
		
		exp = (exp && exp.length) ? "<div class='exp'><div class='t'>"+(exp)+"</div></div>" : '';

		var tracking_task_check = '';
		if (!parseInt(task.status)) {
			tracking_task_check = "data-feature='wework:wework_task_check:task'";
		}

		var cta = "<div class='cta "+(grand_status)+" url clickable-"+(task.acl.status)+"'> "+(exp)+" <div class='box url' data-url='action/"+(task.id)+"/check' "+(tracking_task_check)+" data-status='"+(task.status)+"' data-acl='"+(task.acl.status)+"'></div> <div class='label url "+(review_action.length ? 'with-review' : '')+"' data-detail='1' "+(review_action)+" data-value='"+(task.status)+"'>"+(label)+"</div> </div> "+(duration)+" <div class='assign js-task-detail url' data-metatype='"+(task.metatype)+"' data-url='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"' data-src='task.display'>"+(assign)+"</div>";

		$("#js-task-display .task-cta").html(cta);
	};
	
	
	/**
	 * @desc Init task result/deliverable
	 */
	function initResult(task) {

		var hidden = '';
		var cta = "<div class='cta-block'> <span class='a normal std js-result-clickable'>Cáº­p nháº­t káº¿t quáº£ cĂ´ng viá»‡c</span> hoáº·c <span class='a normal std relative xo js-result-upload'>Táº£i lĂªn tĂ i liá»‡u</span> &middot; <span class='a normal std relative xo js-drive-result-upload'>Táº£i lĂªn tá»« Base Drive</span> </div>";
		
		if (!parseInt(task.acl.result)) {
			cta = "";
		}
		
		var content = Task.ui.getLocalLink(task.result.content);
		if (!content.length && !task.result.files.length) {
			hidden = 'hidden';
			
			if (parseInt(task.acl.result)) {
				content = "";
			} else {
				content = "<div class='li -del -content'>ChÆ°a cĂ³ cáº­p nháº­t káº¿t quáº£ cĂ´ng viá»‡c</div>";
			}
			
			if (!parseInt(task.acl.result)) {
				$("#js-taskresult").hide();
				return;
			}
		}

		var enable_percent_completion = parseInt(Client.tempData.context.percent_completion);
		var edit_completion = '';

		if (enable_percent_completion) {
			edit_completion = "<div class='completion'> <div class='label'>HoĂ n thĂ nh</div> <input type='text' name='complete' placeholder='Enter %' value='"+(parseInt(task.complete))+"%'/> <div class='bar'><div class='b' style='width:"+(task.complete)+"%'></div></div> </div>";
		}

		var visual_bar_top = " <div class='completion-slider' title='Slide to set task completion'> <div class='completion'>"+(parseInt(task.complete))+"%</div> </div>";
		
		if (!parseInt(task.acl.result)) {
			visual_bar_top = "<div class='completion-slider' title='Slide to set task completion'> <div class='cur' style='width:"+(task.complete)+"%'></div> <div class='completion'>"+(parseInt(task.complete))+"%</div> </div>";
			
			edit_completion = '';
		}
		
		if (!enable_percent_completion) {
			visual_bar_top = '';
		}
		
		if (parseInt(task.status) == 1) {
			visual_bar_top = "<div class='completion-slider'> <div class='cur' style='width:100%'></div> <div class='completion'>"+(task.complete)+"%</div> </div>";
		}

		var html = "<div class='top'> Káº¿t quáº£ cĂ´ng viá»‡c "+(visual_bar_top)+" </div> <div class='postform "+(hidden)+"'> <div class='result'> <div class='textarea -wc-"+(enable_percent_completion)+" "+(enable_percent_completion?'':'disable_percent')+"'> <form id='form-edit-taskresult' method='POST' action='api/task/result.content'> <div class='edit-content'> "+(edit_completion)+" <textarea name='content' rows='5' data-id='"+(task.id)+"' placeholder='Cáº­p nháº­t káº¿t quáº£ cĂ´ng viá»‡c'>"+(Task.ui.getLocalLink(Textarea.simple(task.result.content)))+"</textarea> </div> <div class='actions'> <div class='add-file js-add-file'>+ ThĂªm tĂ i liá»‡u</div> </div> <div class='edit-files'></div> <div class='hidden'> <input name='id' type='text' value='"+(task.id)+"' hidden> </div> </form> </div> <div class='display'> <div class='content'>"+(content)+"</div> </div> <div class='submit'> <div class='button js-result-save -cta'>LÆ°u</div> <div class='button js-result-cancel -cancel'>Há»§y</div> </div> </div> <div class='files'> <div class='-box-file file-list'></div> <div class='-box-file file-thumbnail'></div> </div> </div> "+(cta)+" </div>";
		
		$("#js-taskresult").html(html).removeClass("editing");
		$("#js-taskresult").show();

		var thumbnail_files = AP.array.filter(task.result.files, function(e) {
			return parseInt(e.image) == 1;
		});
		
		var thumbnail_files_html = AP.render(thumbnail_files, function(e) {
			return getThumbnailFile(e, task, "result");
		});

		if (Base.config.file_preview) {
			thumbnail_files_html = "<div class='file-previews clear-fix'>"+(thumbnail_files_html)+"</div>";
		}

		$("#js-taskresult .files .file-thumbnail").html(thumbnail_files_html);

		var list_files = AP.array.filter(task.result.files, function(e) {
			return parseInt(e.image) == 0;
		});

		var list_files_html = AP.render(list_files, function(e) {
			return getListFile(e, task, "result");
		});

		$("#js-taskresult .files .file-list").html(list_files_html);
		
		Base.file.previewMultiples("#js-taskresult .files",".name");

		if (!parseInt(task.acl.result)) {
			return;
		}
		
		// BINDING EVENTS
		$("#js-taskresult .js-file-remove").click(function() {
			var fid = $(this).data("id");
			Task.file.removeResult(fid);
		});
		
		AP.uploadable("#js-taskresult .js-result-upload", {
			action: "api/task/result.upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true
		}, function(code) {
			if (code.good()) {
				initResult(code.task);
				TaskDisplay.side.update(code.task);
			}
		});
		
		AP.uploadable("#js-taskresult .js-drive-result-upload", {
			action: "api/task/result.upload",
			name: "file",
			data: {
				id: task.id
			},
			multi: true,
			drive: true
		}, function(code) {
			if (code.good()) {
				initResult(code.task);
				TaskDisplay.side.update(code.task);
			}
		});

		// Add file
		var canvas_result = '#js-taskresult .result';
		AP.pickable(canvas_result + ' .actions .js-add-file', {
			name: "result_file[]",
			callback: function(name, input) {
				var fid = AP.uuid();
				var html = "<div class='file' id='"+(fid)+"' title='"+(name)+"'> <div class='title'><div class='ap-xdot'>"+(name)+"</div></div> <div class='remove'><span class='-ap icon-close'></span></div> <div class='hidden'></div> </div>";
				$(canvas_result + " .edit-files").append(html);
				$(input).appendTo("#" + fid + " .hidden");

				$(canvas_result + " .edit-files .file .remove").on("click", function() {
					$(this).closest(".file").remove();
					recountResultFiles(canvas_result);
				});

				recountResultFiles(canvas_result);
			}
		});

		$("#js-taskresult .js-result-clickable").click(function() {
			$("#js-taskresult").addClass("editing");
			$("#js-taskresult textarea").focus();
		});
		
		$("#js-taskresult .js-result-cancel").click(function() {
			$("#js-taskresult").removeClass("editing");
		});

		$("#js-taskresult .js-result-save").click(function() {
			Form.submit('#form-edit-taskresult', function(code) {

				if (!code.good()) {
					AP.alertError(code.message);
				}

				initResult(code.task);
				TaskDisplay.side.update(code.task);
			});
		});

		$("#js-taskresult .content").linkify();
		
		// Slider
		if (!parseInt(task.status)) {
			$("#js-taskresult .completion-slider").slider({
				value: parseInt(task.complete),
				range: "min",
				slide: function(event, ui) {
					$("#js-taskresult input[name=complete]").val(ui.value + "%");
					$("#js-taskresult .bar .b").css({width: ui.value + "%"});
					$("#js-taskresult .top .completion").html(ui.value + "%");
				},
				stop: function(event, ui) {
					$("#js-taskresult").addClass("editing");
					$("#js-taskresult textarea").focus();
					
					$("#js-taskresult input[name=complete]").val(ui.value + "%");
					$("#js-taskresult .bar .b").css({width: ui.value + "%"});
					$("#js-taskresult .top .completion").html(ui.value + "%");
				}
			});
		}
	};
	
	
	function getThumbnailFile(e, task, context) {

		var icon = UI.file.ficon(e.name);
		var color = UI.file.color(e.name);
		var icolor = UI.file.iconColor(icon);
		
		var url = (e.trello == 1) ? e.fid : Base.file.download(e.name, e.fid);
		if (e.metatype == "googledrive") {
			url = e.url;
		}
		if (context == "desc") {
			var remove = (parseInt(task.acl.desc) ? "<span class='action autohide' onclick=\"Task.file.removeAttachment('" + e.id + "');\"><em>XĂ³a</em></span>" : "");
		} else if (context == "result") {
			var remove = (parseInt(task.acl.result) ? "<span class='action autohide' onclick=\"Task.file.removeResult('" + e.id + "');\"><em>XĂ³a</em></span>" : "");
		}
		
		if (Base.config.file_preview == 1) {
			var preview = "<div class='preview name' data-file='"+(e.url)+"' title='"+(e.name)+"'> <div class='fname pointer'><div class='txt'>"+(e.name)+"</div></div> <div class='icon-bg' style='background-color:"+(icolor)+"'> <div class='icon'><span class='-ap icon-"+(icon)+"'></span></div> <div class='rname'>"+(e.name)+"</div> </div> </div>";
			
			if (parseInt(e.image) && e.url && $.inArray(AP.fileExt(e.url), ['jpg', 'jpeg', 'png', 'bmp', 'gif']) >= 0) {
				preview = "<div class='preview name' data-file='"+(e.url)+"' title='"+(e.name)+"'> <div class='fname pointer'><div class='txt'>"+(e.name)+"</div></div> <div class='preview-img'><img src='"+(AP.zthumb(e.url))+"'/></div> </div>";
			}
			
			return "<div class='file-preview'> <div class='inner'> "+(preview)+" <div class='actions'> "+(remove)+" <a class='action txt normal' target='_blank' title='Download' href='"+(url)+"'><em>Download</em></a> </div> </div> </div>"
		}
		
		return "<div class='file'> <div class='icon'><span class='-ap icon-"+(icon)+" text-alt"+(color)+"'></span></div> <div class='name pointer' data-file='"+(e.url)+"'>"+(e.name)+"</div> <div class='actions'> "+(remove)+" <a class='action txt normal' target='_blank' title='Download' href='"+(url)+"'><em>Download</em></a> </div> </div>";
	};


	function getListFile(e, task, context) {

		var download_href = Base.file.download(e.name, e.fid, e.download_url);
		if (typeof e.metatype != 'undefined' && (e.metatype == 'google' || e.metatype == 'googledrive')) {
			download_href = e.download_url;
		}

		var remove = "";
		if (context == "desc") {
			remove = parseInt(task.acl.desc) ? "<span class='action js-file-remove' title='XĂ³a file' data-task='"+(task.id)+"' data-id='"+(e.id)+"'><span class='-ap icon-uniF11F'></span></span>" : "";
		} else if (context == "result") {
			remove = parseInt(task.acl.result) ? "<span class='action js-file-remove' title='XĂ³a file' data-task='"+(task.id)+"' data-id='"+(e.id)+"'><span class='-ap icon-uniF11F'></span></span>" : "";
		}

		var actions = "<span class='actions'> "+(remove)+" <a class='action' title='Download file' target='_blank' href='"+(download_href)+"'><span class='-ap icon-download3'></span></a> </span>";

		return "<div class='li -file pointer'><span class='icon'><span class='-ap icon-uniF10A'></span></span> <span class='name' data-file='"+(e.url)+"'>"+(e.name)+"</span> "+(actions)+" </div>";
	}
	

	/**
	 * @desc Init a list of checklists
	 */
	function initChecklists(task) {
		if (!parseInt(task.acl.desc)) {
			$("#js-task-display .task-desc .js-upload").hide();
			$("#js-task-display .task-desc .js-upload-drive").hide();
		}

		if (!parseInt(task.acl.checklist)) {
			$("#js-task-display .task-desc .js-checklist").hide();
		}
		
		if (!task.checklists.length) {
			$("#js-checklists").hide();
		}

		Checklist.init("#js-checklists", task);
	};
	
	
	function initSubtasks(task) {
		var html = "<div id='js-subtasks-area-"+(task.id)+"'></div>";
		$("#js-subtasks-" + task.id).html(html);
		
		Base.task.embed(task, {
			canvas:"#js-subtasks-area-" + task.id,
			header: 0,
			project_id: task.project_id,
			tasklist_id: false
		});
	};


	this.openTaskNewTab = function(id) {

		window.open(Client.url + "/tasks?task=" + id, '_blank');
	};

	function recountResultFiles(selector) {
		
		var total_files = $(selector + " .edit-files").find('.file').length;
		
		if (total_files >= 10) {
			$(selector + " .actions .js-add-file").hide();
		} else {
			$(selector + " .actions .js-add-file").show();
		}
	}
	
};


var Checklist = new function __CheckList(){
	this.url="api/checklist";
	
	this.init=function(canvas, object){
		var header="";
		if (object.checklists.length > 0){
			header="<div class='checklist-top'>Checklists</div>";
		}
		$("#js-checklists").empty().html("<div class='w-checklists'>"+header+"</div>");
		$("#js-checklists .edit-form input[name=checklist_name]").enter(function(){
			Checklist.submitForm(this);
		});

		if (object.checklists.length > 0) {
			for (var i=0; i<object.checklists.length; i++){
				addChecklist(object.checklists[i], object, canvas);
			}
		}

		// Init sortable
		if (parseInt(object.acl.checklist)){
			$("#js-checklists .w-checklists").sortable({
				helper:'clone',
				handle: ".handler",
				axis: "y",
				stop: function(event, ui){
					var id=$(ui.item).data("id");
					var index=$(ui.item).index();
					Checklist.moveChecklist(id, index, Client.tempData.task);
				}	
			});
			
			// Sortable
			for (var i=0; i<object.checklists.length; i++){
				$("#checklist-"+object.checklists[i].id+" .items").sortable({
					axis: 'y',
					handle: ".move",
					stop: function(event, ui){
						var todo_id=$(ui.item).data("todo");
						var index=$(ui.item).index();
						var checklist_id=$(ui.item).closest(".js-checklist").data("id");
						Checklist.moveChecklistItem(todo_id, index, checklist_id, Client.tempData.task);
					}
				});
			}
			
			$("#js-checklists .w-checklists").disableSelection();
		}
		
		var len=$("#js-checklists .js-checklist").length+1;
		$("#js-checklists").prepend("<div class='edit-form'><form method='post' action='"+this.url+"/list.create'>" +
			"<input type='hidden' name='id' value='"+object.id+"'/>"+
			"<div class='row'>" +
			"	<input type='text' placeholder='Táº¡o checklist' name='checklist_name' value='Checklist #"+len+"'/>" +
			"</div>" +
			"<div class='row clear-fix'>" +
			"	<div class='button -cta' onclick='Checklist.submitForm(this);'>Táº¡o checklist</div>" +
			"	<div class='cancel' onclick='Checklist.showForm(this, false);'><span class='-ap icon-close'></span></div>" +
			"</div>" +
		"</form></div>");
		
		$("#js-checklists .edit-form input[name=checklist_name]").enter(function(){
			Checklist.submitForm(this);
		});
	};

	this.edit=function(ref){
		var checklist=$(ref).closest(".js-checklist").data("id");
		var name=$(ref).closest(".js-checklist").data("name");
		var id=Client.tempData.task.id;
		var hiddens={id:id, checklist: checklist};

		var form=Form.create('tree-node-fx',{action: 'api/checklist/list.edit'})
			.row(
				Form.label({label: "TĂªn checklist"}),
				Form.input({name: 'name', "placeholder":"TĂªn checklist"}).value(name).autoSubmit()
			)
			.hiddens(hiddens)
			.buttons([
				{label: "Cáº­p nháº­t tĂªn checklist", action: function(){
					Form.submit("tree-node-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						Form.hide("tree-node-fx");
						UI.flash("Cáº­p nháº­t thĂ nh cĂ´ng ...");
						Task.inline.insertComment(code.comment, code.task);
						$("#checklist-"+code.checklist.id+" .top").html(code.checklist.name);
						$("#checklist-"+code.checklist.id).data('name', code.checklist.name);
					});
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function(){
					Form.hide("tree-node-fx");
				}, style:'cancel -passive-2 -rounded'}
			]).settings();

		Form.pop({id:'tree-node-fx-dx', width: 400, label: 'Cáº­p nháº­t tĂªn checklist', layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	
	this.remove=function(ref){
		var checklist=$(ref).closest(".js-checklist").data("id");
		var id=Client.tempData.task.id;
		
		AP.confirm("Báº¡n cĂ³ muá»‘n xĂ³a checklist nĂ y vĂ  cĂ¡c todo tÆ°Æ¡ng á»©ng?", function() {
			AP.post(Checklist.url+"/list.remove", {id: id, checklist: checklist}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Task.update(code.task, code.comment);
			});
		});	
	};
	
	
	this.moveChecklist=function(checklist_id, index, task){
		UI.ajaxShow();
		AP.post(Checklist.url+"/list.move",{checklist: checklist_id, id: task.id, index: index}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.tempData.task=code.task;
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	this.moveChecklistItem=function(item_id, index, checklist_id, task){
		UI.ajaxShow();
		AP.post(Checklist.url+"/move",{checklist: checklist_id, id: task.id, index: index, todo: item_id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.tempData.task=code.task;
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	this.move=function(id, prev){
	};
	
	
	
	this.closeInput = function(ref) {
		$(ref).closest(".input").removeClass("focus");
	};
	
	this.submit=function(ref, object){
		var $box=$(ref).closest(".input");
		var name=$box.find("input[name=checklist]").val();
		var status=$box.find("input[name=status]").val();
		
		if (name && name.length){
			UI.ajaxShow();
			
			AP.post(this.url+"/add", {name: name, status: status, id: object.id, token: object.token, checklist: $(ref).closest(".js-checklist").data("id")}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				$box.find("input[name=checklist]").val("").focus();
				
				var $canvas=$box.closest(".js-checklist").find(".items");
				$canvas.prepend(getItemHTML(code.item, code.task));
			});
		}
	};
	
	
	
	/**
	 * @desc Toggle check/uncheck item
	 */
	this.toggle=function(ref){
		var $box=$(ref).closest(".item");
		var todo=$box.data("todo");
		var id=$box.data("id");
		var checklist=$box.closest(".js-checklist").data("id");
		
		UI.ajaxShow();
		AP.post(this.url+"/toggle", {id: id, checklist: checklist, todo: todo}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (parseInt(code.item.status)){
				$box.addClass("-checked");
			}else{
				$box.removeClass("-checked");
			}

			Task.inline.insertComment(code.comment, code.task);
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	
	/**
	 * @desc Edit a single item in a checklist
	 */
	this.editItem = function(ref){
		var $box = $(ref).closest(".item");
		var id = $box.data("todo");
		
		var data = {todo: id, checklist: $box.closest(".js-checklist").data("id"), "id": $box.data("id")};
		
		// if (Client.pageData.project.status != 0) {
		//	 return;
		// }
		
		var form = Form.create('fly-proj-editchk-fx',{'action': Checklist.url+"/edit"})
		.row(
			Form.label({label: "Cáº§n lĂ m"}),
			Form.input({name: 'name', placeholder: "Cáº§n lĂ m"}).value($box.data("name")).autoSubmit()
		).addClass("-big")
		.buttons([
			 {label: "LÆ°u thay Ä‘á»•i", action: function(){
				 Form.submit("#fly-proj-editchk-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
					 
					 Form.hide("fly-proj-editchk-fx");
					 
					 UI.flash("ÄĂ£ sá»­a checklist");
					 Task.inline.insertComment(code.comment, code.task);
					 $(".js-item-"+id+"").replaceWith(getItemHTML(code.item, code.task));
					 
				 })
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("fly-proj-editchk-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).hiddens(data);
		
		Form.pop({width: 420, label: 'Chá»‰nh sá»­a', layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	
	/**
	 * @desc Remove a checklist item
	 */
	this.removeItem = function(ref){
		var $box = $(ref).closest(".item");
		var todo = $box.data("todo");
		var id = $box.data("id");
		var checklist = $box.closest(".js-checklist").data("id");
		
		AP.confirm("Báº¡n cĂ³ muá»‘n xĂ³a item nĂ y?", function() {
			AP.post(Checklist.url+"/remove", {id: id, todo: todo, checklist: checklist}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				var $canvas = $(ref).closest(".item");
				$canvas.slideUp(300, function(){
					$(this).remove();
				});

				Task.inline.insertComment(code.comment, code.task);
			});
		});
	};
	
	
	this.assignItem=function(task_id, item_id, user, ref){
		var checklist=$(ref).closest(".js-checklist").data("id");
		
		UI.ajaxShow();
		AP.post(Checklist.url+"/assign", {id: task_id, todo: item_id, username: user.username, checklist: checklist}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.tempData.task=code.task;
			Task.inline.insertComment(code.comment, code.task);
			TaskDisplay.taskUpdated(code.task, "checklists");
		});
	};
	
	
	this.submitForm=function(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			Checklist.init("#js-checklists", code.task);
			UI.flash("ÄĂ£ thĂªm checklist");
			Task.inline.insertComment(code.comment, code.task);
			TaskDisplay.taskUpdated(code.task, "checklists");
			$("#js-checklists .checklist:eq(0)").find("input[name=checklist]").focus();
		});
	};
	
	
	this.showForm=function(ref, flag){
		$("#js-checklists").show();
		
		if (flag){
			$("#js-checklists .edit-form").addClass("block");
			$("#js-checklists .edit-form input[name=checklist_name]").focus();
		}
		
		$(ref).closest(".edit-form").removeClass("block");
	};
	
	
	
	this.info=function(checklists){
		var total=0;
		var done=0;
		for (var i=0; i<checklists.length; i++){
			for (var j=0; j<checklists[i].items.length; j++){
				total++;
				if (parseInt(checklists[i].items[j].status)){
					done++;
				}
			}
		}
		
		if (total>0){
			return "<span class='istat' title='Checklist info'><span class='-ap icon-ion-android-checkbox-outline'></span> <em>"+(done)+"/"+(total)+"</em></span>";
		} else {
			return '';
		}
	};
	
	
	function addChecklist(checklist, object, canvas){
		$(canvas).find(".w-checklists").append(getHTML(checklist, object));
		
		var $box=$("#checklist-"+checklist.id);
		
		$box.find("input[name=checklist]").enter(function(){
			Checklist.submit(this, object);
		}).on("focus", function(){
			$(this).closest(".input").addClass("focus");
		});
		
		$box.find(".state-icon").click(function(){
			var $input=$(this).closest(".input").find("input[name=status]");
			var val=$input.val();
			if (val==1){
				$input.val(0);
			}else{
				$input.val(1);
			}
			
			checkState($(this).closest(".input"));
		});
		
		$box.find(".submit").click(function(){
			Checklist.submit(this, object);
		});
		
		checkState($box.find(".input"));
		
		$box.find(".items").html(AP.render(checklist.items, function(e){
			return getItemHTML(e, object);
		}));
	};
	
	
	
	
	

	function getHTML(checklist, object){
		var form="<div class='input'>" +
		"	<input type='hidden' name='status' value='0'/>" +
		"	<div class='cta-icon'><span class='-ap icon-plus2'></span></div>" +
		"	<input type='text' name='checklist' placeholder='Táº¡o cĂ´ng viá»‡c, nháº¥n enter Ä‘á»ƒ gá»­i'/>" +
		"	<div class='submit'><div>ThĂªm</div></div>" +
		"	<div class='cancel' title='Huá»·' onclick='Checklist.closeInput(this);'><span class='-ap icon-close'></span></div>" +
		"	<div class='state-icon -infow'>" +
		"		<div class='-infobox -up -w100 unselectable'><div class='-box'>Nháº¥p Ä‘á»ƒ chá»n hoáº·c bá» chá»n</div></div>" +
		"		<span class='icon'></span>" +
		"	</div>" +
		"</div>";
		
		if (!parseInt(object.acl.checklist)){
			form="";
		}
		
		var actions="<div class='action' onclick='Checklist.edit(this);'>Chá»‰nh sá»­a</div>" +
		"<div class='action' onclick='Checklist.remove(this);'>XĂ³a</div>";
		
		if (!parseInt(object.acl.checklist)){
			actions="";
		}
		
		return "<div class='checklist js-checklist' data-name='"+checklist.name+"' id='checklist-"+checklist.id+"' data-id='"+checklist.id+"'>" +
			"<div class='actions'>" + actions + "</div>" +
			"<div class='top'><span class='-ap icon-list2 handler'></span><span class='url' data-url=':collapse:parent:parent'>"+checklist.name+"</span></div>" +
			form +
			"<div class='items relative'></div>" +
		"</div>";
	}
	
	
	
	
	function checkState($box){
		var $input=$box.find("input[name=status]");
		var val=$input.val();
		if (val==1 || val=="1"){
			$box.find(".state-icon").addClass("selected");
		}else{
			$box.find(".state-icon").removeClass("selected");
		}
	};


	function getItemHTML(e, object) {

		var todo_since = typeof e.since != 'undefined' ? e.since : object.since;
		
		var ec = [];
		if (parseInt(e.status)) {
			ec.push("-checked");
		} else {
			ec.push("-unchecked");
		}

		var assign = "<div class='assign url' data-url='action/" + object.id + "/checklist' data-action='assign' data-id='" + e.id + "'>" +
			"<div class='avatar avatar-24'><div class='user-add user6'></div></div>" +
			"</div>";

		if (e.assign) {
			var user = People.get(e.assign);
			if (user) {
				assign = "<div title='" + user.name + " (@" + e.assign + ")" + "' class='assign url' data-url='action/" + object.id + "/checklist' data-action='assign' data-id='" + e.id + "'>" +
					"<div class='avatar avatar-24 -circled'><div class='image'><img src='" + AP.xthumb(user.gavatar) + "'/></div></div>" +
					"</div>";
			}
		}

		return "<div class='item " + ec.join(" ") + " js-item-" + e.id + "' data-todo='" + e.id + "' data-id='" + object.id + "' data-name='" + e.name + "'>" +
			(parseInt(object.acl.checklist) ? "<div class='move'></div>" : "") +
			"<div class='date'>" + AP.time.time("%H:%i %d/%m", todo_since) + "</div>" +
			"<div class='-ap opt text-9 text-remove-hover' title='XĂ³a' data-url='action/" + object.id + "/checklist' data-action='remove' onclick='Checklist.removeItem(this);'><span class='-ap icon-trash'></span></div>" +
			"<div class='-ap opt text-9 text-edit-hover' title='Chá»‰nh sá»­a' data-url='action/" + object.id + "/checklist' data-action='edit' onclick='Checklist.editItem(this);'><span class='-ap icon-mode_edit'></span></div>" +
			assign +
			"<div class='name'>" + e.name + "</div>" +
			"<div class='icon' onclick='Checklist.toggle(this)'></div>" +
			"</div>";
	};
};


var CheckList = Checklist;


var TaskCanvas=new function __TaskCanvas(){
	this.init=function(){
		if (mobile()){
			$(document.body).addClass("xo").animate({scrollTop: 0}, 200);
			return;
		}
		
		var html="<div id='project-task-canvas'> <div id='project-task-scrollable' class='scroll-y forced-scroll'> <div id='task-canvas-wrapper'> <div id='js-project-task'></div> </div> </div> </div>";
		
		if ($("#project-master").length){
			if (!$("#project-task-canvas").length){
				$("#project-master").before(html);
			}else{
				$("#js-project-task").empty();
			}
			
			if (!$("#tasklists").length){
				$("#project-task-canvas").addClass("without-tasklists")	
			}
		}else if ($("#base-canvas").length){
			if (!$("#project-task-canvas").length){
				$("#base-canvas").before(html);
			}else{
				$("#js-project-task").empty().removeClass();
			}
			
			$("#project-task-canvas").addClass("without-tasklists")
		}
		
	
		$("#project-task-canvas").show();
		
		$("#project-master").addClass("showing-task").removeClass("scroll-y");
		$("#base-canvas").addClass("showing-task").removeClass("scroll-y");
		
		$("#tasklists").addClass("scroll-y");
		$("#board-table .main-table tr.ts").removeClass('is-active');
	};
	
	
	
	/**
	 * @desc Event on closing the task preview
	 */
	this.close=function(){
		AP.destroyDialog("#js-task-dialog");
		
		$("#project-task-canvas").hide();
		$("#project-master").removeClass("showing-task");
		
		if (!$("#board-table-wrapper").length || !$("#base-calendar").length){
			$("#project-master").addClass("scroll-y");
		}
		
		$("#base-canvas").removeClass("showing-task");
		$("#tasklists").removeClass("scroll-y");
		
		$(".js-task").removeClass("active")
		$("#board-table .main-table tr.ts").removeClass('is-active');
		
		
		AP.closeDialog("#js-task-dialog");
		
		if (mobile()){
			$(document.body).removeClass("xo");
		}
	};
};


TaskDisplay.side = new function __TaskDisplaySide() {

	this.init = function() {
		Client.tempData.task.assigner = People.get(Client.tempData.task.creator_username);
		
		initSideCanvas(Client.tempData.task);
		initFollowers(Client.tempData.task);
		
		Comment.showLogs("#js-task-logs", Client.tempData.logs);
		showDetailLog(Client.tempData.task);

		$("#js-project-task .section").on("click", ".title", function() {
			$(this).closest(".section").toggleClass("collapsed");
		});
	}; 
	
	
	/**
	 * @desc Side re-render on task update
	 */
	this.update=function(task){
		task.assigner=People.get(task.creator_username);
		
		initSideCanvas(task);
		initFollowers(task);
		
		$("#js-project-task .section").on("click", ".title", function(){
			$(this).closest(".section").toggleClass("collapsed");
		});
	};
	
	
	/**
	 * @desc Display followers
	 */
	function initFollowers(task){
		var followers=AP.render(task.followers, function(e){
			var u=People.get(e.username);
			if (u && !parseInt(u.error)) {
				return "<div class='user'> <div class='avatar avatar-32 -circled url' data-username='"+(e.username)+"'> <div class='image'><img src='"+(AP.xthumb(e.gavatar))+"'/></div> </div> <div class='uname'>"+(u.name)+"</div> <div class='uinfo'>"+(u.title)+"&nbsp;</div> </div>";
			} else {
				return '';
			}
		});
		
		var button="<div class='add url' data-url='action/"+(task.id)+"/addfollower'> <span class='icon'></span><div class='txt'>Follower</div> </div>";
		
		if (parseInt(task.acl.managed) || (task.username == Client.viewer.username)){
			button="<div class='add url -follow' data-url='action/"+(task.id)+"/extfollower' data-value=''> <span class='icon'></span><div class='txt' title='ThĂªm ngÆ°á»i theo dĂµi tá»« há»‡ thá»‘ng, báº¥m thĂªm má»™t láº§n ná»¯a Ä‘á»ƒ xĂ³a ngÆ°á»i theo dĂµi khá»i cĂ´ng viá»‡c'>ThĂªm tá»« ngoĂ i</div> </div> <div class='add url -follow' data-url='action/"+(task.id)+"/addfollower' data-value=''> <span class='icon'></span><div class='txt' title='ThĂªm ngÆ°á»i theo dĂµi tá»« dá»± Ă¡n nĂ y, báº¥m thĂªm má»™t láº§n ná»¯a Ä‘á»ƒ xĂ³a ngÆ°á»i theo dĂµi khá»i cĂ´ng viá»‡c'>NgÆ°á»i theo dĂµi</div> </div>";
		}else{
			if (!Me.isFollower(task)) {
				button = "<div class='add url -follow' data-url='action/" + task.id + "/follow'>" +
					"<span class='icon'></span><div class='txt'>Theo dĂµi</div>" +
					"</div>";
			} else {
				button = "<div class='add url -unfollow' data-url='action/" + task.id + "/unfollow'>" +
					"<span class='icon'></span><div class='txt'>Bá» theo dĂµi</div>" +
					"</div>";
			}
		}
		
		var html=followers + "<div class='buttons clear-fix'>"+(button)+"</div>";
		
		$("#js-task-display .js-followers").html(html);
	};
	
	
	/**
	 * @desc Init side canvas
	 */
	function initSideCanvas(task){
		var start_cta="<div class='section -fit'> <div class='start'> <div class='icon anim-showhide-inf'><span class='-ap icon-play_circle_filled'></span></div> <div class='label'>CĂ´ng viá»‡c chÆ°a báº¯t Ä‘áº§u</div> <div class='info'>CĂ´ng viá»‡c nĂ y Ä‘Æ°á»£c giao cho báº¡n</div> <div class='ctas clear-fix'> <div class='cta url' data-url='action/"+(task.id)+"/startnow' data-acl='"+(task.acl.status)+"'><span class='-ap icon-play_arrow'></span> Báº¯t Ä‘áº§u ngay</div> <div class='cta-less url' data-url='action/"+(task.id)+"/starttime' data-acl='"+(task.acl.status)+"'>Chá»n tgian</div> </div> </div> </div>";
		
		if (parseInt(task.user_id)!=parseInt(Client.viewer.id)){
			start_cta='';
		}else if (parseInt(task.start_time)){
			start_cta="<div class='section -fit'> <div class='start'> <div class='icon'><span class='-ap icon-play_circle_filled'></span></div> <div class='label'>CĂ´ng viá»‡c Ä‘Ă£ báº¯t Ä‘áº§u "+(AP.time.ago(task.start_time))+"</div> <div class='info'>CĂ´ng viá»‡c nĂ y Ä‘Æ°á»£c giao cho báº¡n</div> </div> </div>";
		}

		var linking_milestone='';
		
		if (parseInt(task.acl.edit) || parseInt(task.acl.managed)){
			linking_milestone="<div class='section -fit -orange'> <div class='p-msg -orange'> <div class='msg'>ChÆ°a liĂªn káº¿t vá»›i má»¥c tiĂªu</div> <em class='cta url' data-url='action/"+(task.id)+"/milestone' data-acl='"+(task.acl.status)+"'>Lá»±a chá»n má»¥c tiĂªu <span class='-ap icon-chevron-down2'></span></em> </div> </div>";
			
			if (parseInt(task.milestone_id)){
				var m=Milestone.fromContext(task.milestone_id);
				if (m){
					linking_milestone="<div class='section -fit'> <div class='start'> <div class='icon'><span class='-ap icon-equalizer'></span></div> <div class='label url' data-url='milestone/"+(m.id)+"'>"+(m.name)+"</div> <div class='info url' data-url='action/"+(task.id)+"/milestone'>Click Ä‘á»ƒ chá»n láº¡i má»¥c tiĂªu <span class='-ap icon-chevron-down'></span></div> </div> </div>";	
				}
			}
		}
		
		var overdue_cta="<div class='section -fit'> <div class='overdue'> <div class='icon anim-showhide-inf'><span class='-ap icon-error'></span></div> <div class='label'>CĂ´ng viá»‡c Ä‘Ă£ quĂ¡ háº¡n</div> <div class='side'>"+(AP.i18n.date(task.deadline))+"</div> </div> </div>";
		
		if (!parseInt(task.deadline) || !Compute.overdue(task)){
			overdue_cta='';
		}
		
		if (Compute.lateComplete(task)){
			overdue_cta="<div class='section -fit'> <div class='overdue -late'> <div class='icon'><span class='-ap icon-error'></span></div> <div class='label'>HoĂ n thĂ nh muá»™n</div> </div> </div>";
		}
		
		if (!parseInt(task.user_id) && parseInt(task.acl.assign)){
			start_cta="<div class='section -fit'> <div class='p-msg'> <span class='msg'>CĂ´ng viá»‡c chÆ°a Ä‘Æ°á»£c giao cho ai <em class='url' data-url='action/"+(task.id)+"/assign' data-acl='"+(task.acl.assign)+"'>Giao ngay?</em></span> </div> </div>";
		}
		
		var info_start_time="<div class='row'> <div class='icon'><span class='ficon-chevron-circle-right'></span></div> <div class='label'>Báº¯t Ä‘áº§u: <em>"+(AP.i18n.datetime(task.start_time))+"</em></div> </div>";
		
		if (!parseInt(task.start_time)){
			info_start_time='';
		}
		
		var info_complete_time="<div class='row'> <div class='icon'><span class='ficon-check-square'></span></div> <div class='label'>HT lĂºc: <em>"+(AP.i18n.datetime(task.complete_time))+"</em></div> </div>";
		
		if (!parseInt(task.complete_time) || !parseInt(task.status)){
			info_complete_time='';
		}
		
		var info_duration="<div class='row'> <div class='icon'><span class='ficon-fa'></span></div> <div class='label'>TG cho phĂ©p: <em>"+(AP.i18n.duration(task.duration))+"</em></div> </div>";
		
		if (!parseInt(task.duration)){
			info_duration='';
		}
		
		var info_complete='';
		var project=Project.inspect();
		
		if (project && parseInt(project.percent_completion) && !parseInt(task.status)){
			info_complete="<div class='row'> <div class='icon'><span class='ficon-check-circle-o'></span></div> <div class='label'>Pháº§n trÄƒm HT: <em>"+(AP.data.numberFormat(task.complete))+"</em>%</span></div> </div>";
		}
		
		var info_deadline="<div class='row'> <div class='icon'><span class='ficon-clock-o'></span></div> <div class='label'>Thá»i háº¡n: <em>"+(AP.i18n.datetime(task.deadline))+"</em></span></div> </div>";
		
		if (!parseInt(task.deadline)){
			info_deadline='';
		}
		
		var infobox="<div class='section'> <div class='exec-rows'> <div class='row'> <div class='icon'><span class='ficon-user-circle-o'></span></div> <div class='label'>TG táº¡o: <em>"+(AP.i18n.datetime(task.since))+"</em></div> </div> <div class='row'> <div class='icon'><span class='ficon-clock-o'></span></div> <div class='label'>TG cáº­p nháº­t: <em>"+(AP.i18n.datetime(task.last_update))+"</em></div> </div> "+(info_start_time)+" "+(info_complete_time)+" "+(info_deadline)+" "+(info_duration)+" "+(info_complete)+" </div> </div>";
		
		var html = ""+(overdue_cta)+" "+(start_cta)+" "+(linking_milestone)+" <div class='section'> <div class='title'>NgÆ°á»i giao viá»‡c</div> <div class='assigner body'> <div class='user'> <div class='image'><img src='"+(AP.xthumb(task.assigner.gavatar))+"'/></div> <div class='name'>"+(task.assigner.name)+"</div> <div class='info'>"+(task.assigner.title)+"&nbsp;</div> </div> </div> </div> "+(infobox)+" <div class='section' id='js-task-followers'> <div class='title'>NgÆ°á»i theo dĂµi</div> <div class='body followers clear-fix js-followers'></div> </div> <div class='section collapsed'> <div class='title'>Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng <div class='side'> <div class='count'></div> </div> </div> <div class='body'> <div id='js-task-logs'></div> </div> </div>"
		;
		
		$("#js-project-task .side-body").html(html);
	};


	function showDetailLog(task) {
		$("#js-task-logs .comment-logs .comment-log .c-display .detail").on("click", function(){
			var log_id = $(this).closest(".comment-log").data('id');
			var log = AP.array.findObj(Client.tempData.logs, log_id);

			var log_name = " ";
			var value_old = " ";
			var value_new = " ";
			var project_form = [];
			
			if (log.attachment && typeof log.attachment != 'undefined') {
				var log_attachment = log.attachment;
			} else {
				return;
			}

			var user = People.get(log.user_id);

			var project = Project.fromContext(task.project_id);

			for (var i = 1; i < project.form.length; i++) {
				project_form[project.form[i].id] = project.form[i];
			}

			var form = Form.create('fly-detail-log-fx',{'action': "api/job/log.detail"})
			.rowHTML("<div class='log-info'><em>"+ user.name + "</em> " + log.content + " " + AP.time.time("%d/%m/%Y %H:%i", log.since) + "</div>");

			if (log_attachment[0].has_change) {
				for (var i = 1; i < log_attachment.length; i++) {
					log_name = getLogName(log_attachment[i]);
					value_old = getLogValue(log_attachment[i].value_old, log_attachment[i], project_form);
					value_new = getLogValue(log_attachment[i].value_new, log_attachment[i], project_form);
					
		            form
		            .rowHTML("<div class='row-subtitle'>" + log_name + "</div>")
		            .row(
		                Form.label({label: 'GiĂ¡ trá»‹ cÅ©', sublabel: ''}),
		                Form.input({name: 'old', type: 'fake'}).value(value_old)
		            ).row(
		                Form.label({label: 'GiĂ¡ trá»‹ má»›i', sublabel: ''}),
		                Form.input({name: 'new', type: 'fake'}).value(value_new)
		            );
		        }
	        } else {
	        	form
	        	.rowHTML("<div class='row-subtitle error'>KhĂ´ng cĂ³ thay Ä‘á»•i</div>");
	        }

			form
			.render(function(){
				$("#fly-detail-log-fx .input .input-fake").addClass("noafter").removeClass("ap-xdot").css('overflow','hidden');
				$("#fly-detail-log-fx .-isfake .label").css('text-transform','uppercase');
			});
		
			Form.pop({width: 720, label: 'Chi tiáº¿t lá»‹ch sá»­ chá»‰nh sá»­a', layout:'flat'}).setForm(form).show();
		});
	};


	function getLogName(log_attachment) {
		var log_name = "";

		if (log_attachment.type == "custom_field") {
			log_name = "TrÆ°á»ng tĂ¹y chá»‰nh " + log_attachment.name;
		}

		if (log_attachment.type == "name") {
			log_name = "TĂªn cĂ´ng viá»‡c ";
		}

		if (log_attachment.type == "content") {
			log_name = "MĂ´ táº£ ";
		}

		if (log_attachment.type == "tags") {
			log_name = "Danh sĂ¡ch nhĂ£n ";
		}

		if (log_attachment.type == "start_time") {
			log_name = "Thá»i gian báº¯t Ä‘áº§u ";
		}

		if (log_attachment.type == "duration") {
			log_name = "Khoáº£ng thá»i gian thá»±c hiá»‡n ";
		}

		if (log_attachment.type == "deadline") {
			log_name = "Thá»i háº¡n ";
		}

		if (log_attachment.type == "milestone") {
			log_name = "Má»¥c tiĂªu ";
		}

		if (log_attachment.type == "assign") {
			log_name = "Giao cho ";
		}

		if (log_attachment.type == "tasklist") {
			log_name = "NhĂ³m cĂ´ng  viá»‡c ";
		}

		if (log_attachment.type == "urgent") {
			log_name = "Kháº©n cáº¥p ";
		}

		if (log_attachment.type == "result:content") {
			log_name = "Káº¿t quáº£ cĂ´ng viá»‡c ";
		}


		if (log_attachment.type == "result:percent") {
			log_name = "Pháº§n trÄƒm hoĂ n thĂ nh";
		}

		return log_name;
	};


	function getLogValue(value, log_attachment, project_form) {
		var log_value = "";

		if (log_attachment.type == "custom_field") {
			if (typeof project_form[log_attachment.key] != 'undefined') {

				log_value = value;

				if (project_form[log_attachment.key].type == "date") {
					log_value = value ? AP.time.time("%d/%m/%Y", value) : "";
				}

				if (project_form[log_attachment.key].type == "datetime") {
					log_value = value ? AP.time.time("%d/%m/%Y %H:%i", value) : "";
				}
			} else {
				log_value = value;
			}
		} else if (log_attachment.type == "result:percent") {
			log_value = value + '%';
		} else if (log_attachment.type == "content") {
			log_value = "<div class='text-editor'>"+(value)+"</div>"
		} else {
			log_value = value;
		}

		return log_value;
	};
	
};


Task.calendar=new function __TaskCalendar(){
	this.googleLink = "";
	this.iCalLink = "";
	this.generateGoogleLink = function(title, desc, startStr, endStr) {
		var dates='';
		
		if (!startStr && endStr){
			dates='date='+endStr;
		}else if (!endStr && startStr){
			dates='date='+startStr;
		}else if (startStr && !endStr){
			dates='dates=';
		}else{
			if (startStr && endStr){
				dates='dates='+startStr+"/"+endStr;	
			}
		}
		
		this.googleLink = encodeURI([
			'https://www.google.com/calendar/render',
			'?action=TEMPLATE',
			'&text=' + (title || ''),
			'&'+dates,
			'&details=' + (desc || ''),
			'&sprop=&sprop=name:'
		].join(''));
	};

	this.generateiCalLink = function(title, desc, url, startStr, endStr) {
		this.iCalLink = encodeURI(
			'data:text/calendar;charset=utf8,' + [
				'BEGIN:VCALENDAR',
				'VERSION:2.0',
				'BEGIN:VEVENT',
				'URL:' + url,
				'DTSTART:' + (startStr || ''),
				'DTEND:' + (endStr || ''),
				'SUMMARY:' + (title || ''),
				'DESCRIPTION:' + (desc || ''),
				'LOCATION:',
				'END:VEVENT',
				'END:VCALENDAR'].join('\n')
		);
	};

	this.createLink = function(type) {
		if (type == 'google') {
			AP.toURL(this.googleLink);
		} else {
			window.open(this.iCalLink);
		}
	};
	
	
	this.add = function(id) {
		var task=Task.fromContext(id);
		if (!task){
			return;
		}
		
		var name=task.name;
		var content=task.content;
		var start=parseInt(task.start_time);
		var end=parseInt(task.deadline);
		
		var startTime = new Date(start * 1000);
		var endTime = new Date(end * 1000);

		var startStr = startTime.toISOString().replace(/-|:|\.\d+/g, '');
		var endStr = endTime.toISOString().replace(/-|:|\.\d+/g, '');
		if (!start || !parseInt(start)){
			startStr='';
		}
		
		if (!end || !parseInt(end)){
			endStr='';
		}
		
		this.generateGoogleLink(name, content, startStr, endStr);
		this.generateiCalLink(name, content, startStr, endStr);

		var html="" +
			"<div class='list list-actions -border'>" +
			"<div class='li item unselectable' onclick=\"Task.calendar.createLink('google');\">" +
			"   <div class='-icon -big' style='top: 10px;'><span class='-ap icon-google2'></span></div> ThĂªm vĂ o lá»‹ch google" +
			"</div>" +
			"<div class='li item unselectable' onclick=\"Task.calendar.createLink();\">" +
			"   <div class='-icon -big' style='top: 10px;'><span class='-ap icon-apple'></span></div> ThĂªm vĂ o iCalendar" +
			"</div>" +
			"</div>";

		AP.customDialog(html, "custom-extcal").width(280).style("-full").show();
	};

};
var Calendar = new function __Calendar(){
	this.endpoint="api/calendar";	
	this.c=null;
	
	this.init=function(canvas, endpoint, render){
		var project = Client.pageData.project;
		var c=new BaseCalendar(canvas, endpoint, render, project);
		if (Query.getInt("ts")){
			c.cur=Query.getInt("ts");
		}

		if (Query.get("q")){
			c.q=Query.get("q");
		}
		
		c.init();
		$(canvas).addClass("__jscalendar").data("calendar", c);
		
		this.c=c;
		return c;
	};
	
	this.get=function(ref){
		return $(ref).closest(".__jscalendar").data("calendar");
	};

	this.displayItem = function(canvas, item){
		if (this.c){
			this.c._displayItem(canvas, item);	
		}
	};

	this.taskCreated=function(task){
		if (!$("#js-calendar").length){
			return;
		}
		
		this.displayItem("#js-calendar", task);
		AP.closeDialog("#js-project-item");
	};

	this.taskUpdated=function(task){
		if (!$("#js-calendar").length){
			return;
		}
		
		$("#js-task-id-"+task.id).remove();
		this.displayItem("#js-calendar", task);
	};

	this.taskDeleted=function(task_id){
		if (!$("#js-calendar").length){
			return;
		}
		
		$("#js-task-id-"+task_id).remove();
		AP.closeDialog("#js-project-item");
	};

	this.add = function(deadline) {
		var project = Client.pageData.project;
		Task.dialog.add(project, null, deadline);
	};

	this.hoverCell = function () {
		$("#js-calendar").on("mouseover",'.js-task-calendar-task-name', function () {
			if ($("#show_task_hover").is(':hidden')) {
				var status = $(this).data("status");
				$("#show_task_hover").removeClass($(this).data("error"));
				$("#show_task_hover").removeClass($(this).data("out_of_date"));
				$("#show_task_hover").removeClass($(this).data("success"));
				$("#show_task_hover").removeClass($(this).data("pending"));

				$("#show_task_hover").addClass(status);

				switch (status) {
					case "error":
						$("#js-calendar .status_name").removeClass("anim-showhide-inf");
						$("#js-calendar .status_name").removeClass("icon-flash");
						$("#js-calendar .status_name").removeClass("icon-check2");
						$("#js-calendar .status_name").removeClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("icon-close");
						break;
					case "out_of_date":
						$("#js-calendar .status_name").addClass("anim-showhide-inf");
						$("#js-calendar .status_name").removeClass("icon-flash");
						$("#js-calendar .status_name").removeClass("icon-check2");
						$("#js-calendar .status_name").removeClass("icon-close");
						$("#js-calendar .status_name").addClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("icon-flash");
						break;
					case "success":
						$("#js-calendar .status_name").removeClass("anim-showhide-inf");
						$("#js-calendar .status_name").removeClass("icon-flash");
						$("#js-calendar .status_name").removeClass("icon-close");
						$("#js-calendar .status_name").removeClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("icon-check2");
						break;
					case "pending":
						$("#js-calendar .status_name").removeClass("icon-close");
						$("#js-calendar .status_name").removeClass("icon-check2");
						$("#js-calendar .status_name").removeClass("icon-out_of_date");
						$("#js-calendar .status_name").addClass("anim-showhide-inf");
						$("#js-calendar .status_name").addClass("icon-flash");
						break;
				}
				var wrap = $("#js-calendar .body").offset();
				var offset = $(this).offset();
				$("#show_task_hover").css("top", offset.top - wrap.top + 35);
				if(offset.left < 250) {
					var screen_width = screen.width;
					$("#show_task_hover").css("right", screen_width  - 650);//offset.left
				} else {
					$("#show_task_hover").css("left", offset.left - wrap.left - 260);
				}

				var id = $(this).data("id");
				var info = [];
				info.name = $(this).data("name");
				info.username = $(this).data("username");
				info.creator_username = $(this).data("creator_username");
				info.deadline = $(this).data("deadline");
				info.since = $(this).data("since");
				setInfoTask(info);
				$("#show_task_hover").show();

			}
		}).on('mouseleave', '.js-task-calendar-task-name', function () {
			$("#show_task_hover").hide();
		});
	};
	
	
	function setInfoTask(info) {
		var creator = __getUserByUsername(info.creator_username);
		if (!creator) {
			var creator = [];
			creator.name = info.creator_username;
			creator.username = info.creator_username;
		}

		var assigner = __getUserByUsername(info.username);
		if (!assigner) {
			var assigner = [];
			assigner.name = info.username;
			assigner.username = info.username;
		}
		var deadline = AP.time.time("%H:%i %d/%m/%Y", info.deadline);
		var create_at = AP.time.time("%H:%i %d/%m/%Y", info.since);
		$("#show_task_hover .t_title").html(info.name);
		$("#show_task_hover .creator .t_name").html(creator.name);
		$("#show_task_hover .creator .t_username").html("(" + creator.username + ")");
		$("#show_task_hover .assigner .t_name").html(assigner.name);
		$("#show_task_hover .assigner .t_username").html("(" + assigner.username + ")");
		$("#show_task_hover .deadline .t_deadline").html(deadline);
		$("#show_task_hover .create_at .t_create_at").html(create_at);
	};
};





function BaseCalendar(canvas, endpoint, render, project){
	this.endpoint=endpoint;
	this.render=render;
	this.cur=AP.time.now();
	this.q="";
	this.canvas=canvas;
	
	this.init=function(){
		var canvas=this.canvas;
		build(this.canvas, this, project);
		
		this.getItems({}, function(items){
			displayItems(canvas, items);
		});
	}
		
	this.next=function(){
		var current_date = new Date((this.cur)*1000);
		var first_day = new Date(current_date.getFullYear(), current_date.getMonth()+1, 1);
		this.cur = first_day.getTime()/1000;
		this.init();
		
		AP.setURLParams({ts: this.cur});
	};
	
	
	this.prev=function(){
		var current_date = new Date((this.cur)*1000);
		var first_day = new Date(current_date.getFullYear(), current_date.getMonth()-1, 1);
		this.cur = first_day.getTime()/1000;
		this.init();
		
		AP.setURLParams({ts: this.cur});
	};
	
	
	this.today=function(){
		this.cur=AP.time.now();
		this.init();
		
		AP.setURLParams({ts: null});
	};
	
	this.getItems=function(options, callback){
		options=$.extend({}, {ts: this.cur, q: this.q}, options);
		UI.ajaxShow();
		AP.post(this.endpoint, options, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			items=code.items.slice(0);
			items.sort(function(e, f){
				return parseInt(e.deadline) - parseInt(f.deadline);
			});
			
			for (var i=0; i<items.length; i++){
				$.log(AP.i18n.date(items[i].deadline));
			}
			
			if (callback){
				callback(items);
			}
		});
	};
	
	
	
	this.getItem=function(id, callback){
		UI.ajaxShow();
		AP.post(this.endpoint, options, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.item);
		})
	};
	
	
	this._displayItem=function(canvas, item){
		return displayItem(canvas, item);
	}
	
	
	function displayItems(canvas, items){
		for (var i=0; i<items.length; i++){
			displayItem(canvas, items[i]);
		}
	};
	
	function displayItem(canvas, item){
		var didx=AP.time.time("%d%m%Y", item.deadline);
		var $box=$(canvas).find(".day-"+didx);

		if (!$box.length){
			return;
		}	

		if (item.username) {
			var user=People.get(item.username);
			var img = "<img src='" + AP.xthumb(user.gavatar) + "'>";
		} else {
			var img = "<div class='user-add'></div>";
		}

		var pass = (item.deadline < AP.time.beginOfDay(AP.time.now())) ? 'overdue' : '';
		var done = (item.status == 1) ? 'done' : 'active';
		var me="";
		if (item.username==Client.viewer.username){
			me=" -me";
		}
		var html="<div class='item js-task-calendar "+(me)+" "+(pass)+"  "+(done)+" url' id='js-task-id-"+(item.id)+"' data-url='task/"+(item.id)+"' data-feature='wework:wework_task_show:task' data-keywords='"+(item.keywords)+"'> <div class='mask full-mask'></div> <div class='user-image'><div class='image imagew' id='user-image-id-"+(item.id)+"'>"+(img)+"</div></div> <div class='text js-task-calendar-task-name' data-since='"+(item.since)+"' data-deadline='"+(item.deadline)+"' data-username='"+(item.username)+"' data-creator_username='"+(item.creator_username)+"' data-name='"+(item.name)+"' data-id='"+(item.id)+"' id='calendar-task-name-"+(item.id)+"'>"+(item.name)+"</div> </div>";

		$box.find(".items").append(html);
	};
	
	
	function build(canvas, calendar, project){
		header(canvas, calendar);
		body(canvas, calendar, project);
	};
	
	
	function header(canvas, calendar){
		$(canvas).find(".days").append("<div class='day'>Thá»© hai</div> <div class='day'>Thá»© ba</div> <div class='day'>Thá»© tÆ°</div> <div class='day'>Thá»© nÄƒm</div> <div class='day'>Thá»© sĂ¡u</div> <div class='day'>Thá»© báº£y</div> <div class='day'>Chá»§ nháº­t</div>");
		
		$(canvas).find(".js-cur").html(AP.time.time("%m/%Y", calendar.cur));
		$(canvas).find(".js-today").html(AP.time.time("%h:%i %d/%m/%Y", AP.time.now()));
	};
	
	
	function body(canvas, calendar,project){
		var $c=$(canvas).find(".month");
		$c.empty();
		
		var date=new Date(calendar.cur * 1000);
		
		var first=new Date(date.getFullYear(), date.getMonth(), 1);
		var last=new Date(date.getFullYear(), date.getMonth()+1, 0);
		var now=AP.time.now();
		
		var dow=first.getDay();
		var start=unixTS(first);
		var end=unixTS(last);
		
		if (dow==1){
		}else{
			start=start-(dow-1)*(24*3600);
		}
		
		
		var total_days=Math.floor((end-start)/(24*3600));
		var total_weeks=Math.ceil(total_days/7);
		var h=(100.0/total_weeks);

		for (var i=0; i<total_weeks; i++){
			var w=i;
			var html="";
			for (var j=0; j<7; j++){
				var ec="";
				var ts=start+(i*7+j)*(24*3600);

				if (AP.time.time("%d/%m/%Y", ts)==AP.time.time("%d/%m/%Y", now)){
					ec="-today";
				}else if (AP.time.time("%m/%Y", ts)!=AP.time.time("%m/%Y", unixTS(first))){
					ec="-xm";
				}
				
				html+="<div class='day day-"+(AP.time.time('%d%m%Y', ts))+" "+(ec)+"'> <div class='label'><div class='date'>"+(AP.time.time('%d', ts))+"</div></div> <div class='dmask' onclick='Calendar.add("+(ts)+");'></div> <div class='items'> <div class='dmask' onclick='Calendar.add("+(ts)+");'></div> </div> </div>"; 
				
				//<div style='margin-top: 52px;margin-left: 127px;font-size: 11px'>3 more</div>
			}
			
			$c.append("<div class='week' style='height: "+h+"%'>"+html+"</div>");
		};
		
		$c.find(".items").css("right", -$.sbWidth()).css("overflow-y","scroll");
	};
	
	
	function unixTS(date){
		return Math.floor(date.getTime()/1000);
	};
};
var myCalendar = new function __MyCalendar(){
	this.endpoint="api/calendar/me";
	this.c=null;
	
	this.init=function(canvas, endpoint, render){
		var c=new BaseCalendar(canvas, endpoint, render);
		if (Query.getInt("ts")){
			c.cur=Query.getInt("ts");
		}

		if (Query.get("q")){
			c.q=Query.get("q");
		}
		
		c.init();
		$(canvas).addClass("__jscalendar").data("calendar", c);
		
		this.c=c;
		return c;	
	};
	
	this.get=function(ref){
		return $(ref).closest(".__jscalendar").data("calendar");
	};

	this.taskUpdated=function(task){
		$("#js-calendar #calendar-task-name-"+task.id).html(task.name);
	};

	this.add = function(deadline) {
		Project.pick(function(project){
			Task.dialog.add(project, null, deadline, Client.viewer);
		}, "Select a team/project");
	};
};var System = function __System() {

	this.init = function () {


	};
};


System.permission = new function __SystemPermission () {

	this.display = function () {

		$("#js-project_create").data("value", Client.wework_global.project_create_val);
		$("#js-team_create").data("value", Client.wework_global.team_create_val);
		$("#js-company-edit select[name='task_import_delegate']").data("value", Client.pageData.config.task_import_delegate);


		var project_create_teams = "";
        project_create_teams = AP.render(Client.pageData.config.project_create_teams, function (e) {
            return getTeamString(e);
        });
		$("#js-company-edit textarea[name='project_create_teams']").val(project_create_teams);

		if (Client.wework_global.project_create_val == 'special_teams') {
			$('.js-project-create-teams').show();
		} else {
			$('.js-project-create-teams').hide();
		}

		$("#js-project_create").on('change', function () {

			var val = $(this).val();
			if (val == 'special_teams') {
				$('.js-project-create-teams').show();
			} else {
				$('.js-project-create-teams').hide();
			}
		});


		var team_create_teams = "";
        team_create_teams = AP.render(Client.pageData.config.team_create_teams, function (e) {
            return getTeamString(e);
        });
		$("#js-company-edit textarea[name='team_create_teams']").val(team_create_teams);

		if (Client.wework_global.team_create_val == 'special_teams') {
			$('.js-team-create-teams').show();
		} else {
			$('.js-team-create-teams').hide();
		}

		$("#js-team_create").on('change', function () {

			var val = $(this).val();
			if (val == 'special_teams') {
				$('.js-team-create-teams').show();
			} else {
				$('.js-team-create-teams').hide();
			}
		});


		Form.render("#js-company-edit");

		$("#js-company-edit .js-submit").on("click", function () {
			Form.submitFrom(this, function (code) {
				if (!code.good()) {
					return AP.alertError(code.message);
				}

				UI.flash("Updated successfully ...");
				AP.requireReset();
			});
		});
	};


	function getTeamString(e) {

		var team = UserGroup.get(e);
		if (team) {
			return "" + (team.name) + " (@" + (team.path) + "), ";
		}

		return "";
	};
};
var Setting=new function __Setting(){
	this.init=function(){
	
	};
	
	
	/**
	 * @desc Quick fix a property
	 */
	this.fix=function(key, value, callback){
		var data={key: key, value: value};
		
		UI.ajaxShow();
		AP.xpost("api/settings/fix", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			if (callback){
				callback();
			}
		});
	};
};



Setting.edit = new function __SettingEdit() {

	this.init = function() {
		initMainForm();
		initPeriod();
		initColorForm();
		initOptions();
		initTeamPrefs();
		Setting.tags.init("#js-edit-tags");
	};	
	
	
	this.initEmailPrefs = function() {

		var project_type = (Client.pageData.context.metatype == 'team') ? 'team' : 'dá»± Ă¡n';
		UI.setting("CĂ¡c thao tĂ¡c liĂªn quan Ä‘áº¿n cĂ´ng viá»‡c")
		.add({
			title: "Email khi giao viá»‡c (gá»­i Ä‘áº¿n ngÆ°á»i Ä‘Æ°á»£c giao)",
			options: {"yes": "Yes", "no": "No"},
			value: Client.pageData.options.task_assign,
			name: "task_assign",
			url: Client.pageData.context.path+"/api/settings/pref"
		})
		.add({
			 title: "Email khi cĂ´ng viá»‡c Ä‘Æ°á»£c chá»‰nh sá»­a (tĂªn - thá»i háº¡n)",
			 options: {"yes": "Yes", "no": "No"},
			 value: Client.pageData.options.task_edit,
			 name: "task_edit",
			 url: Client.pageData.context.path+"/api/settings/pref"
		})
		//
		// .add({
		//	  title: "Email khi cĂ´ng viá»‡c quĂ¡ háº¡n",
		//	  options: {"yes": "Yes", "no": "No"},
		//	  value: Client.pageData.options.task_overdue,
		//	  name: "task_overdue",
		//	  url: Client.pageData.context.path+"/api/settings/pref"
		// })
		.add({
			title: "Email khi tráº¡ng thĂ¡i cĂ´ng viá»‡c Ä‘Æ°á»£c cáº­p nháº­t (Ä‘ang lĂ m - hoĂ n thĂ nh)",
			options: {"yes": "Yes", "no": "No"},
			value: Client.pageData.options.task_status_update,
			name: "task_status_update",
			url: Client.pageData.context.path+"/api/settings/pref"
		})
		.add({
			 title: "Email khi xĂ³a cĂ´ng viá»‡c",
			 options: {"yes": "Yes", "no": "No"},
			 value: Client.pageData.options.task_delete,
			 name: "task_delete",
			 url: Client.pageData.context.path+"/api/settings/pref"
		})

		.callback(function(name, value){
			Client.pageData.options[name]=value;
		})
		.showYesNo("#js-proj-settings");

		UI.setting(project_type)
			.add({
				title: "Email khi " +project_type+ " Ä‘Æ°á»£c chá»‰nh sá»­a",
				options: {"yes": "Yes", "no": "No"},
				value: Client.pageData.options.project_edit,
				name: "project_edit",
				url: Client.pageData.context.path+"/api/settings/pref"
			})
			.add({
				title: "Email khi xĂ³a " + project_type,
				options: {"yes": "Yes", "no": "No"},
				value: Client.pageData.options.project_delete,
				name: "project_delete",
				url: Client.pageData.context.path+"/api/settings/pref"
			})
			.add({
				title: "Email khi cĂ³ tĂ i liá»‡u má»›i",
				options: {"yes": "Yes", "no": "No"},
				value: Client.pageData.options.file_upload,
				name: "file_upload",
				url: Client.pageData.context.path+"/api/settings/pref"
			})
			// .add({
			//	 title: "Email hĂ ng ngĂ y vĂ o buá»•i sĂ¡ng Ä‘á»ƒ tá»•ng há»£p cĂ´ng viá»‡c",
			//	 options: {"yes": "Yes", "no": "No"},
			//	 value: Client.pageData.options.reminder_daily,
			//	 name: "reminder_daily",
			//	 url: Client.pageData.context.path+"/api/settings/pref"
			// })
			.callback(function(name, value){
				Client.pageData.options[name]=value;
			})
			.showYesNo("#js-proj-settings-new");

	};
	
	
	
	this.initBGEdit=function(){
		var html="<div class='selections'> <div class='select' data-value='dark'><span class='square -bg-gray'></span> Tá»‘i</div> <div class='select' data-value='light'><span class='square -bg-white'></span> SĂ¡ng</div> <div class='select' data-value='color'><span class='square -bg-main'></span> MĂ u máº·c Ä‘á»‹nh</div> <div class='select' data-value='image'><span class='square -bg-image'></span> TĂ¹y chá»‰nh áº£nh</div> </div> <div class='bg-upload hidden'> <div class='image'></div> <div class='mask'></div> <div class='footer'> <div class='upload' id='js-upload-button'>Táº£i lĂªn</div> <div class='cancel'>XĂ³a hĂ¬nh ná»n hiá»‡n táº¡i</div> <div class='sliders clear-fix'> <div class='opacity-slider'> Mask darkness <div class='slider js-darkness'></div> </div> <div class='opacity-slider'> Blurriness <div class='slider js-blurry'></div> </div> </div> </div> </div>";
		
		
		$("#js-bg-manager").html(html);
		$("#js-bg-manager .cancel").click(function(){
			removeBackground();
		});
		
		$("#js-bg-manager .selections .select").on("click", function(){
			var val=$(this).data("value");
			setBackgroundType(val);
		});
		
		
		var current_type=Client.pageData.project.bg.type;
		if (!current_type){
			current_type="dark";
		}
		
		if (current_type=='image'){
			$("#js-bg-manager .bg-upload").show();
		}
		
		$("#js-bg-manager .selections .select").each(function(){
			if ($(this).data("value")==current_type){
				$(this).addClass("active");
			}
		});
		
		
		
		var url = Client.pageData.project.bg.url;
		$("#js-bg-manager .bg-upload .image").html("<img src='"+(url)+"'/>");
		AP.uploadable("#js-bg-manager .upload",{
			action: Client.pageData.context.path+"/api/settings/bg.upload",
			name: "file",
			image: 1
		}, function(code){
			UI.flash("Save successfully ...");
			AP.refresh();
		});
		
		
		// Blrry slider
		
		var current_blurry=0;
		if (Client.pageData.project.bg.blurry){
			current_blurry=parseInt(Client.pageData.project.bg.blurry);
		}
		
		var br=(parseInt(current_blurry)*13/60);
		$("#js-bg-manager .image img").css({
			"-webkit-filter": "blur("+br+"px)",
			"filter": "blur("+br+"px)"
		});
		
		$("#js-bg-manager .slider.js-blurry").slider({
			value: current_blurry,
			min: 1,
			range: "min",
			stop: function(event, ui){
				fixBg("blurry", {value: ui.value});
				
				var br=(parseInt(ui.value)*13/60);
				$("#js-bg-manager .image img").css({
					"-webkit-filter": "blur("+br+"px)",
					"filter": "blur("+br+"px)"
				});
			}
		});
		
		
		// Darkness slider
		
		var current_mask=50;
		if (Client.pageData.project.bg.mask){
			current_mask=parseInt(Client.pageData.project.bg.mask);
		}
		
		$("#js-bg-manager .mask").css({
			opacity: parseInt(current_mask)/100
		});
		
		$("#js-bg-manager .slider.js-darkness").slider({
			value: current_mask,
			min: 1,
			range: "min",
			stop: function(event, ui){
				fixBg("mask", {value: ui.value});
				$("#js-bg-manager .mask").css({
					opacity: parseInt(ui.value)/100
				});
			}
		});
	};
	
	

	/**
	 * @desc Remove background image
	 * @return void
	 */
	function removeBackground(){
		AP.confirm("Báº¡n cĂ³ muá»‘n xĂ³a áº£nh background ?", function(){
			fixBg("bg.remove");
			
			var data={fix:'bg.remove', id: Client.pageData.project.id};
			UI.ajaxShow();
			AP.post("api/settings/bg.fix", data, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				UI.flash("ÄĂ£ xĂ³a áº£nh background thĂ nh cĂ´ng !");
				AP.xRefresh();
			});
		});
	};
		
	
	
	
	
	/**
	 * @desc Set background type
	 * @return void
	 */
	function setBackgroundType(type){
		fixBg("type", {value: type});
	};
	
	
	
	function fixBg(key, data){
		if (!data){
			data={};
		}
		
		data.id=Client.pageData.project.id;
		data.fix=key;
		
		UI.ajaxShow();
		AP.post("api/settings/bg.fix", data, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Update successfully ...");
			Client.pageData.project.bg=code.bg;
			Setting.edit.initBGEdit();
		});
	};
	
	
	function initMainForm() {

		$("#js-edit-form").find("input, select, textarea, .trumbowyg-box").click(function() {
			$("#js-edit-form").addClass("editing");
		});
		
		$("#js-edit-form").find(".on-edit .button.-cta").click(function() {
			Form.submitFrom(this, function(code) {
				if (!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Update successfully");
				AP.refresh();
			});
		});
		
		// Edit department
		$("#js-edit-dept-form").find(".on-edit .button.-cta").click(function() {
			Form.submitFrom(this, function(code) {
				if (!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Update successfully");
				AP.refresh();
			});
		});
		
		$("#js-edit-dept-form").preventAutoSubmit();
		
		$("#js-edit-form").find(".on-edit .button.-cancel").click(function() {
			$("#js-edit-form").removeClass("editing");
		});
		
		$("#js-edit-form select[name=review]").on("change", function() {
			var v = $(this).val();
			if (parseInt(v)) {
				$("#js-edit-form .js-review").show();				
			} else {
				$("#js-edit-form .js-review").hide();
				$("#js-edit-form .js-review-subtask").hide();
			}
		}).change();

		$("#js-edit-form select[name=review_subtask]").on("change", function() {
			var v = $(this).val();
			if (parseInt(v)) {
				$("#js-edit-form .js-review-subtask").show();				
			} else {
				$("#js-edit-form .js-review-subtask").hide();
			}
		}).change();

		UI.editorValue("#js-edit-form textarea", Client.pageData.context.content);
	};
	
	
	function initColorForm() {
		$("#js-edit-colors").html(AP.render(range(0,10), function(e){
			return "<div class='color -bg-alt"+e+"' data-color='"+e+"'></div>";
		}));
		
		$("#js-edit-colors .color").click(function(){
			var $this=$(this);
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			
			Setting.fix("color", $(this).data("color"));
		});
		
		
		$("#js-edit-colors .color").each(function(){
			var color=$(this).data("color");
			if (parseInt(color)==parseInt(Client.pageData.context.color)){
				$(this).addClass("active");
			}
		})
	};
	
	
	function initPeriod() {

		var context = Client.pageData.context;
		var html = "<span class='a'>Äáº·t thá»i gian báº¯t Ä‘áº§u vĂ  káº¿t thĂºc dá»± Ă¡n</em>";

		var stime = AP.i18n.date(context.stime);
		if (!parseInt(context.stime)) {
			stime = "<span>NgĂ y báº¯t Ä‘áº§u</span>";
		}

		var etime = AP.i18n.date(context.etime);
		if (!parseInt(context.etime)) {
			etime = "<span>NgĂ y káº¿t thĂºc</span>";
		}

		if (parseInt(context.stime) || parseInt(context.etime)) {
			html = "<span class='pointer'><span class='-ap icon-uniF1072 ap-f16'></span> &nbsp; <em>"+(stime)+"</em> - <em>"+(etime)+"</em></span>";
		}

		$("#js-project-period").html(html).click(function() {
			Project.manage.fixTime();
		});
	};
	
	
	function initOptions(){
		var opts={"list": "Dáº¡ng danh sĂ¡ch (máº·c Ä‘á»‹nh)", "table": "Báº£ng vá»›i sÆ¡ Ä‘á»“ Gantt","board": "Báº£ng Kanban", "calendar": "Lá»‹ch biá»ƒu"};
		
		if (Client.pageData.context.metatype=="team"){
			opts={"list": "Dáº¡ng stream (máº·c Ä‘á»‹nh)", "period": "Dáº¡ng period (tuáº§n hoáº·c thĂ¡ng)","board": "Báº£ng Kanban", "calendar": "Lá»‹ch biá»ƒu"};
		}
		if (Client.pageData.context.metatype=="private"){
			opts={"list": "Dáº¡ng stream (máº·c Ä‘á»‹nh)", "period": "Dáº¡ng period (tuáº§n hoáº·c thĂ¡ng)","board": "Báº£ng Kanban", "calendar": "Lá»‹ch biá»ƒu"};
		}
		
		UI.setting("System settings")
		.add({
			title: "Cháº¿ Ä‘á»™ xem máº·c Ä‘á»‹nh",
			options: opts,
			value: Client.pageData.options.view,
			name: "view",
			url: Client.pageData.context.path+"/api/settings/pref"
		})
		.show("#js-proj-settings");
	  
	};
	
	
	
	function initTeamPrefs(){
		if (!$("#js-team-prefs").length){
			return;
		}
		
		$("#js-team-prefs select[name=team_stack]").val(Client.pageData.options.team_stack).on("change", function(){
			Setting.fix("team_stack", $(this).val());
		});
	};
	

};


Setting.tags=new function __SettingTags(){
	this.init=function(canvas){
		var context=Client.pageData.context;
		buildList();
		
		$(canvas).find("form").attr("action", context.path+"/api/settings/tags/edit");
		Form.inlineColorTagger($(canvas).find(".tag-add .square"),function(color){
			$(this).closest("form").find("input[name=color]").val(color);
			$(this).closest("form").find("input[name=name]").focus();
			$(this).closest(".square").find("em").removeClass().addClass("-bg-alt"+color);
		},{
			width: 200,
			left: 0
		}); 
		
		$(canvas).find(".tag-add .square em").click(function(){
			$(this).parent().find(".ap-inline-colors").toggle();
		});
		
		
		$(canvas).find(".ip input").click(function(){
			$(this).closest(".tag-add").addClass("active");
		}).enter(function(){
			updateTag(this);
		});
		
		$(canvas).find(".submit").click(function(){
			updateTag(this);
		})
	};
	
	
	this.remove=function(tag){
		AP.confirm("Remove this tag from the list?", function(){
			var context=Client.pageData.context;
			AP.xpost("api/settings/tags/remove",{name: tag}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				Client.pageData.context.tags=code.tags;
				buildList();
				setForm("", "auto");
			});
		});
	};
	
	
	function updateTag(ref){
		Form.submitFrom(ref, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Client.pageData.context.tags=code.tags;
			buildList();
			setForm("", "auto");
		});
	};
	
	
	function buildList(){
		$("#js-edit-tags").find(".list").html(AP.render(Client.pageData.context.tags, function(e){
			return "<div class='tag -bg-alt"+e.color+"-less text-alt"+e.color+"' data-key='"+e.key+"' data-name='"+e.name+"' data-color='"+e.color+"'>" +
				"<div class='square -bg-alt"+e.color+"'></div> " +
				"<span class='js-name name pointer'>"+e.name+"</span>" +
				"<div class='remove' title='Remove this tag'><span class='-ap icon-close'></span></div>"+
			"</div>";
		}));
		
		$("#js-edit-tags").find(".list .remove").click(function(){
			var key=$(this).closest(".tag").data("key");
			Setting.tags.remove(key);
		});
		
		$("#js-edit-tags").find(".list .js-name").click(function(){
			var key=$(this).closest(".tag").data("key");
			var name=$(this).closest(".tag").data("name");
			var color=$(this).closest(".tag").data("color");
			setForm(name, color);
		});
	};
	
	
	function setForm(name, color){
		if (color && AP.data.isInt(color)){
			$("#js-edit-tags .tag-add input[name=color]").val(color);
			Form.inlineColorTagger("#js-edit-tags .tag-add .square", "set", color);
			$("#js-edit-tags .tag-add .square em").removeClass().addClass("-bg-alt"+color);
		}
		
		$("#js-edit-tags .tag-add input[name=name]").val(name).click();
		setTimeout(function(){
			$("#js-edit-tags .tag-add input[name=name]").focus();
		}, 200);
		
	};
	
};


Rewrite.on(":changelogs/{id}/{action}", function (qs) {
	
	if (qs.action == 'show') {
		return Setting.changelogs.showLogDetail(qs.id);
	}
});


Rewrite.on(":settings/-/{action}", function (qs) {

	if (qs.action == 'show') {
		return Setting.changelogs.showLogDetail(qs.id);
	}

	if (qs.action == "update.time") {
		return Tool.updater.timeInfo();
	}
});




Setting.changelogs = new function __SettingsChangelogs() {
	this.list = function() {
		$canvas = $('#setting-changelogs .changelogs-list');

		for (var i = 0; i < Client.pageData.changelogs.length; i++) {
			var act = Client.pageData.changelogs[i];

			var date_class = ".js-date-" + AP.time.time("%d%m%Y", act.since);
			var $box = $canvas.find(date_class);

			if (!$box.length) {
				$canvas.append("<div class='dgroup js-date-"+(AP.time.time('%d%m%Y', act.since))+"'> <div class='dgroup-title'>"+(AP.time.time('%V, %d/%m/%Y', act.since))+"</div> <div class='dgroup-items'></div> </div>");
			}

			$canvas.find(date_class + " .dgroup-items").append(getHTML(act));
		}
	};


	this.showLogDetail = function(id) {
		var log = AP.array.findObj(Client.pageData.changelogs, id);
		var form = Form.create('fly-detail-log-fx',{'action': "api/job/log.detail"})
			.rowHTML("<div class='log-info'>" + log.content + " " + AP.time.time("%d/%m/%Y %H:%i", log.since) + "</div>");

			var log_changes = log.changes;
			if (log_changes && log_changes.length > 1 && log_changes[0].has_change) {
				for (var i = 1; i < log_changes.length; i++) {
					var log_name = getLogName(log_changes[i]);
					var log_value_old = getLogValue(log_changes[i], log_changes[i].value_old);
					var log_value_new = getLogValue(log_changes[i], log_changes[i].value_new);
		            form
		            .rowHTML("<div class='row-subtitle'>" + log_name + "</div>")
		            .row(
		                Form.label({label: 'GiĂ¡ trá»‹ cÅ©', sublabel: ''}),
		                Form.input({name: 'old', type: 'fake'}).value(log_value_old)
		            ).row(
		                Form.label({label: 'GiĂ¡ trá»‹ má»›i', sublabel: ''}),
		                Form.input({name: 'new', type: 'fake'}).value(log_value_new)
		            );
		        }
	        } else {
	        	form
	        	.rowHTML("<div class='row-subtitle error'>KhĂ´ng cĂ³ thay Ä‘á»•i</div>");
	        }

			form
			.render(function(){
				$("#fly-detail-log-fx .input .input-fake").addClass("noafter").removeClass("ap-xdot").css('overflow','hidden');
				$("#fly-detail-log-fx .-isfake .label").css('text-transform','uppercase');
			});
		
			Form.pop({width: 720, label: 'Chi tiáº¿t lá»‹ch sá»­ chá»‰nh sá»­a', layout:'flat'}).setForm(form).show();
	};


	/**
	 * @desc get changelog action HTML 
	 */
	function getHTML(act) {
		var icon = "<div class='icon -normal'><span class='-ap icon-check'></span></div>";

		var url = getChangelogURL(act.action);
		var group_name = "<div class='name'>"+(act.name)+"</div>";
		if (url != "") {
			group_name = "<div class='name url' data-url='"+(url)+"'>"+(act.name)+"</div>";
		}

		if (act.action == "project:create" || act.action == "repeated_task:create" || act.action == "custom_field:add" || act.action == "tasklist:create") {
			icon = "<div class='icon -good'><span class='-ap icon-plus'></span></div>";

		} else if (act.action == "project:edit" || act.action == "repeated_task:edit" || act.action == "project:edit.role.permission" || act.action == "metatype:edit" || act.action == "status:update" || act.action == "project:edit.background") {
			icon = "<div class='icon -normal'><span class='-ap icon-mode_edit'></span></div>";

		} else if (act.action == "project:edit.role") {
			icon = "<div class='icon -small'><span class='-ap icon-check2'></span></div>";

		} else if (act.action == "repeated_task:remove" || act.action == "custom_field:remove") {
			icon = "<div class='icon -ignore'><span class='-ap icon-delete'></span></div>";

		}

		var detail = '';
		if (act.changes && act.changes.length > 0) {
			detail = "&middot; <span class='detail url' data-url=':changelogs/"+(act.id)+"/show'>Chi tiáº¿t</span>";
		}
		
		return "<div class='li' id='js-kr-"+(act.id)+"' data-id='"+(act.id)+"'> <div class='time'> <span class='d'>"+(AP.time.time('%M %d', act.since))+"</span> <span class='h'>"+(AP.time.time('%H:%i', act.since))+"</span> </div> "+(icon)+" "+(group_name)+" <div class='info'>"+(act.content)+" "+(detail)+"</div> </div>";
	};


	function getChangelogURL(action_type) {
		var path = Client.pageData.project.path;
		var url = ""
		if (action_type == "project:edit.role.permission") {
			url = path + '/settings/acl';
		}

		if (action_type == "status:update" || action_type == "project:edit") {
			url = path + '/settings';
		}

		if (action_type == 'project:edit.background') {
			url = path + '/settings/other';
		}

		if (action_type == "project:edit.member" || action_type == "project:remove.member") {
			url = path + '/settings/members';
		}

		if (action_type == "custom_field:add" || action_type == "custom_field:edit" || action_type == "custom_field:remove") {
			url = path + '/settings/fields';
		}

		if (action_type == "repeated_task:create" || action_type == "repeated_task:edit" || action_type == "repeated_task:remove") {
			url = path + '/settings/repeated';
		}

		return url;
	};


	function getLogName(log_attachment) {
		
		var metatype = Client.pageData.metatype == 'team' ? "PhĂ²ng ban" : "Dá»± Ă¡n"

		var log_name = "";
		if (log_attachment.type == "project_stime") {
			log_name =  "Project start date";
		}

		if (log_attachment.type == "project_etime") {
			log_name = "Project end date";
		}

		if (log_attachment.type == "department") {
			log_name = metatype + " Department";
		}

		if (log_attachment.type == "department") {
			log_name = metatype + " Department";
		}

		if (log_attachment.type == "project_dates") {
			log_name = metatype + " dates";
		}

		if (log_attachment.type == "stage") {
			log_name = metatype + " Giai Ä‘oáº¡n";
		}

		if (log_attachment.type == "display_color") {
			log_name = "MĂ u sáº¯c hiá»ƒn thá»‹ ";
		}

		if (log_attachment.type == "tags") {
			log_name = "Danh sĂ¡ch nhĂ£n ";
		}

		if (log_attachment.type == "project_name") {
			log_name = metatype + " TĂªn";
		}

		if (log_attachment.type == "project_type_external") {
			log_name = metatype + " type";
		}

		if (log_attachment.type == "project_type_percent_completion") {
			log_name = "Percent completion of tasks in " + metatype;
		}

		if (log_attachment.type == "project_type_task_duration") {
			log_name = metatype + " task duration";
		}

		if (log_attachment.type == "project_type_block_result_update_after_done") {
			log_name = metatype + " block update task result when task is done";
		}

		if (log_attachment.type == "project_task_can_remove") {
			log_name = metatype + " task remove type";
		}

		if (log_attachment.type == "project_status") {
			log_name = metatype + " Tráº¡ng thĂ¡i";
		}

		if (log_attachment.type == "project_status_stage") {
			log_name = metatype + " status stage";
		}

		if (log_attachment.type == "project_review") {
			log_name = metatype + " review";
		}

		if (log_attachment.type == "project_reviewers") {
			log_name = metatype + " ngÆ°á»i Ä‘Ă¡nh giĂ¡";
		}

		if (log_attachment.type == "project_metatype") {
			log_name = metatype + " metatype";
		}

		if (log_attachment.type == "project_review_by_assigner") {
			log_name = metatype + " review by assigner";
		}

		if (log_attachment.type == "project_review_subtask") {
			log_name = metatype + " review subtask";
		}

		if (log_attachment.type == "project_custom_fields") {
			log_name = metatype + " TrÆ°á»ng dá»¯ liá»‡u tĂ¹y chá»‰nh";
		}

		if (log_attachment.type == "custom_field_name") {
			log_name = "Custom field name ";
		}

		if (log_attachment.type == "custom_field_content") {
			log_name = "Custom field content ";
		}

		if (log_attachment.type == "custom_field_metatype") {
			log_name = "Custom field metatype ";
		}

		if (log_attachment.type == "custom_field_required") {
			log_name = "Custom field required ";
		}

		if (log_attachment.type == "custom_field_options") {
			log_name = "Custom field options ";
		}


		if (log_attachment.type == "background_type") {
			log_name = "Background type";
		}

		if (log_attachment.type == "background_blurry") {
			log_name = "Background blurry";
		}

		if (log_attachment.type == "background_mask") {
			log_name = "Background mask";
		}

		if (log_attachment.type == 'tasklist_name') {
			log_name = "Tasklist name";
		}

		if (log_attachment.type == "tasklist_content") {
			log_name = "Tasklist description";
		}

		var tokens = log_attachment.type.split(':');

		// Repeated task
		if (tokens.length > 1 && tokens[0] == 'repeated_task') {
			var task_name = tokens[1];
			log_name = ""+(log_attachment.name)+" - Task "+(task_name)+"";
		}

		if (tokens.length > 1 && tokens[0] == "advanced_settings") {
			if (tokens[1] == 'remove_project') {
				log_name = 'Project owners can remove ' + metatype;
			}
		}

		if (tokens.length > 1 && tokens[0] == "pref") {

			if (tokens[1] == "project_delete") {
				log_name = "Send email when delete " + metatype;
			}

			if (tokens[1] == "project_edit") {
				log_name = "Send email when " + metatype + " is updated";
			}

			if (tokens[1] == "task_assign") {
				log_name = "Send email to assignee when task is assigned";
			}

			if (tokens[1] == "task_edit") {
				log_name = "Send email to all followers when task is editted (name/deadline)";
			}

			if (tokens[1] == "task_status_update") {
				log_name = "Send email to all followers when task is done/undone";
			}

			if (tokens[1] == "task_delete") {
				log_name = "Send email to all followers when task is deleted";
			}

			if (tokens[1] == "file_upload") {
				log_name = "Send email when there's a new file added";
			}

			if (tokens[1] == "view") {
				log_name = "Cháº¿ Ä‘á»™ xem máº·c Ä‘á»‹nh";
			}

			if (tokens[1] == 'block_task_edit') {
				log_name = "KhĂ´ng cho phĂ©p ngÆ°á»i Ä‘Æ°á»£c giao viá»‡c chá»‰nh sá»­a cĂ´ng viá»‡c?";
			}

			if (tokens[1] == 'block_task_time') {
				log_name = "KhĂ´ng cho phĂ©p ngÆ°á»i Ä‘Æ°á»£c giao viá»‡c chá»‰nh sá»­a deadline?";
			}

			if (tokens[1] == 'block_task_remove') {
				log_name = "KhĂ´ng cho phĂ©p ngÆ°á»i Ä‘Æ°á»£c giao viá»‡c xĂ³a cĂ´ng viá»‡c hoáº·c chuyá»ƒn giao cho ngÆ°á»i khĂ¡c?";
			}

		}

		// Get log name from permision , role and key
		if (tokens.length == 4 && tokens[0] == 'role') {
			if (ARR.contain(['acl', 'task_acl'], tokens[3])) {
				var key = Client.pageData[tokens[3]].rows.find(function (e) {
					return e.key == tokens[1];
				});
				var role =  Client.pageData[tokens[3]].headers.find(function (e) {
					return e.key == tokens[2];
				});
				log_name = ""+(key.label)+" ("+(role.name)+")";
			}
		}

		return log_name;
	};


	function getLogValue(log_attachment, log_value) {
		if (log_attachment.type == "custom_field_content") {
			if (log_attachment.metatype == 'input-table') {
				log_value = log_value.replaceAll('--br--', '<br/>');
			}
		}

		if (log_attachment.type == "department") {
			var dept = Dept.fromContext(log_value);
			if (dept) {
				log_value = dept.name;
			} else {
				log_value = "ChÆ°a xĂ¡c Ä‘á»‹nh";
			}
		}

		if (log_attachment.type == "project_type_external") {
			var types =  ["Dá»± Ă¡n ná»™i bá»™ cĂ´ng ty", "Dá»± Ă¡n lĂ m viá»‡c vá»›i khĂ¡ch hĂ ng"];
			log_value = types[log_value];
		}

		if (log_attachment.type == "project_type_percent_completion") {
			var types = [
				{ id: 0, label: "KhĂ´ng cho phĂ©p hoĂ n thĂ nh pháº§n trÄƒm cĂ´ng viá»‡c"},
				{ id: 1, label: "Cho phĂ©p hoĂ n thĂ nh pháº§n trÄƒm cĂ´ng viá»‡c"}
			];
			var result = AP.array.findObj(types, parseInt(log_value));
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_type_task_duration") {
			var types = [
				{ id: 0, label: "KhĂ´ng cho phĂ©p thá»i lÆ°á»£ng cĂ´ng viá»‡c dá»± kiáº¿n"},
				{ id: 1, label: "Cho phĂ©p thá»i lÆ°á»£ng cĂ´ng viá»‡c dá»± kiáº¿n"}
			];
			var result = AP.array.findObj(types, parseInt(log_value));
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_type_block_result_update_after_done") {
			var types = [
				{ id: 0, label: "Cho phĂ©p cáº­p nháº­t káº¿t quáº£ cĂ´ng viá»‡c khi cĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh"},
				{ id: 1, label: "KhĂ´ng cho phĂ©p cáº­p nháº­t káº¿t quáº£ cĂ´ng viá»‡c khi cĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh"}
			];
			var result = AP.array.findObj(types, parseInt(log_value));
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_type_deadline") {
			var types = [
				{ id: 0, label: "Thá»i háº¡n cĂ´ng viá»‡c (cuá»‘i ngĂ y)"},
				{ id: 1, label: "Thá»i háº¡n cĂ´ng viá»‡c vá»›i ngĂ y giá» cá»¥ thá»ƒ"}
			];
			var result = AP.array.findObj(types, parseInt(log_value));
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_task_can_remove") {
			var types = ["CĂ´ng viá»‡c cĂ³ thá»ƒ xĂ³a theo phĂ¢n quyá»n", "CĂ´ng viá»‡c khĂ´ng thá»ƒ xĂ³a (ngoáº¡i trá»« quáº£n lĂ½ dá»± Ă¡n)", ""];
			log_value = types[log_value];
		}

		if (log_attachment.type == "project_status") {
			var types = [
				{ id: 0, label: "Äang thá»±c hiá»‡n"},
				{ id: -1, label: "ÄĂ£ Ä‘Ă³ng"}
			];

			var result = AP.array.findObj(types, parseInt(log_value));
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_status_stage") {
			var types = [
				{ id: 'ontrack', label: "ÄĂºng tiáº¿n Ä‘á»™" },
				{ id: 'offtrack', label: "Cháº­m tiáº¿n Ä‘á»™" },
				{ id: 'atrisk', label: "CĂ³ rá»§i ro cao" },
				{ id: 'failed', label: "Tháº¥t báº¡i" },
				{ id: 'success', label: "ThĂ nh cĂ´ng"},
				{ id: 'canceled', label: "Canceled"}
			];
			var result = AP.array.findObj(types, log_value);
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_review") {
			var types = ["VĂ´ hiá»‡u hĂ³a", "KĂ­ch hoáº¡t"];
			log_value = types[log_value];
		}

		if (log_attachment.type == "project_review_by_assigner") {
			var types = [
				{ id: 0, label: "NgÆ°á»i giao viá»‡c khĂ´ng pháº£i ngÆ°á»i Ä‘Ă¡nh giĂ¡"},
				{ id: 1, label: "NgÆ°á»i giao viá»‡c lĂ  ngÆ°á»i Ä‘Ă¡nh giĂ¡"}
			];

			var result = AP.array.findObj(types, parseInt(log_value));
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_review_subtask") {
			var types = [
				{ id: 0, label: "Disable"},
				{ id: 1, label: "YĂªu cáº§u Ä‘Ă¡nh giĂ¡, cho phĂ©p ngÆ°á»i giao viá»‡c vĂ  quáº£n lĂ½ dá»± Ă¡n/phĂ²ng ban Ä‘Ă¡nh giĂ¡ cĂ´ng viá»‡c con"}
			];

			var result = AP.array.findObj(types, parseInt(log_value));
			log_value = result ? result.label : "";
		}

		if (log_attachment.type == "project_metatype") {
			log_value = log_value == "team" ? "PhĂ²ng ban" : "Dá»± Ă¡n";
		}

		if (log_attachment.type == "background_type") {
			if (log_value == "image") {
				log_value = "TĂ¹y chá»‰nh áº£nh";
			} else if (log_value == "color") {
				log_value = "MĂ u máº·c Ä‘á»‹nh";
			} else if (log_value == "light") {
				log_value = "SĂ¡ng";
			} else if (log_value == "dark") {
				log_value = "Tá»‘i";
			}
		}


		var tokens = log_attachment.type.split(':');
		if (tokens.length > 1 && tokens[0] == "repeated_task") {
			if (log_attachment.name == "Subtasks") {
				var tasks = log_value.split('/');
				log_value = AP.render(tasks, function (e) {
					if (e == "") {
						return "";
					}

					var values = e.split(',');
					var html = ""
					// name
					if (values[0]) {
						html += "<b>CĂ´ng viá»‡c:</b> "+(values[0])+"";
					}

					// assigned user
					if (values[1] && values[1] != "") {
						html += " - <b>Giao cho:</b> "+(values[1].split('@').join(', '))+"";
					} else {
						html += " - <b>Giao cho:</b> KhĂ´ng cĂ³ ai";
					}

					// deadline
					if (values[2] && values[2] != "") {
						html += " - <b>Thá»i háº¡n:</b> "+(values[2])+"";
					}

					// description
					if (values[3] && values[3] != "") {
						html += " - <b>MĂ´ táº£:</b> "+(values[3])+"";
					}

					if (values[4] && values[4] != "") {
						html += " - <b>NgÆ°á»i theo dĂµi:</b> "+(values[4].split('@').join(', '))+"";
					}

					html = "<div>"+(html)+"</div>"
					return html;
				});
			}

			if (log_attachment.name == 'Checklists') {
				var items = log_value.split('/');
				log_value = AP.render(items, function (e) {
					if (e == "") {
						return "";
					}

					var values = e.split(',');
					var html = ""
					// name
					if (values[0]) {
						html += "CĂ´ng viá»‡c: "+(values[0])+" ";
					}

					// assigned user
					if (values[1] && values[1] != "") {
						html += "- Giao cho: "+(values[1].split('@').join(', '))+" ";
					} else {
						html += "- No assigned";
					}
					html = "<div>"+(html)+"</div>"
					return html;
				});
			}

			if (log_attachment.name == 'Status') {
				log_value = parseInt(log_value) ? "KĂ­ch hoáº¡t" : "VĂ´ hiá»‡u hĂ³a";
			}

			if (log_attachment.name == 'Followers' && log_value != "") {
				var followers = log_value.split(', ');
				followers = AP.array.select(followers, function(username) {
					var user = People.get(username);

					if (user.error) {
						return username;
					}

					return user.name;
				});
				log_value = followers.join(', ');
			}

			if (log_attachment.name == 'Assign To' && log_value != "") {
				var assigner = People.get(log_value);
				if (!assigner.error) {
					log_value = assigner.name;
				}
			}
		}

		// Get log value from permision , role and key
		if (tokens.length == 4 && tokens[0] == 'role') {
			log_value = parseInt(log_value) == 1 ? "Allowed" : "Not allowed";
		}

		// Get log value from view type of project
		if (tokens.length > 1 && tokens[0] == "pref") {
			var context = "";
			if (typeof Client.pageData.context != "undefined") {
				context = Client.pageData.context;
			}
			
			if (tokens[1] == "view") {
				if (log_value == "table") {
					log_value = "Báº£ng vá»›i sÆ¡ Ä‘á»“ Gantt";
				} else if (log_value == "board") {
					log_value = "Báº£ng Kanban";
				} else if (log_value == "calendar") {
					log_value = "Lá»‹ch biá»ƒu";
				} else if (log_value == "period") {
					log_value = "Dáº¡ng period";
				} else {
					if (context && context.metatype == "team") {
						log_value = "Dáº¡ng stream (máº·c Ä‘á»‹nh)";
					} else {
						log_value = "Dáº¡ng danh sĂ¡ch (máº·c Ä‘á»‹nh)";
					}
				}
			}

		}

		return log_value;
	};


	this.actionOptions = function(){
		var metatype = Client.pageData.metatype == 'team' ? "PhĂ²ng ban" : "Dá»± Ă¡n"
		var options = "<option value='project_create'>Táº¡o "+(metatype)+"</option> <option value='project_duplicate'>NhĂ¢n báº£n "+(metatype)+"</option> <option value='project_edit'>Chá»‰nh sá»­a thĂ´ng tin chung cá»§a "+(metatype)+"</option> <option value='metatype_edit'>Chá»‰nh sá»­a loáº¡i cá»§a "+(metatype)+"</option> <option value='status_update'>Cáº­p nháº­t tráº¡ng thĂ¡i cá»§a "+(metatype)+"</option> <option value='project_edit_background'>Chá»‰nh sá»­a hĂ¬nh ná»n cá»§a "+(metatype)+"</option> <option value='advanced_settings_edit'>Chá»‰nh sá»­a cĂ i Ä‘áº·t nĂ¢ng cao cá»§a "+(metatype)+"</option> <option value='ref_edit'>Chá»‰nh sá»­a cĂ i Ä‘áº·t tham chiáº¿u cá»§a "+(metatype)+"</option> <option value='project_edit_role_permission'>Chá»‰nh sá»­a quyá»n theo vai trĂ²</option> <option value='project_edit_member'>Chá»‰nh sá»­a thĂ nh viĂªn trong "+(metatype)+"</option> <option value='project_remove_member'>XĂ³a thĂ nh viĂªn trong "+(metatype)+"</option> <option value='repeated_task_create'>Táº¡o CV láº·p láº¡i</option> <option value='repeated_task_edit'>Chá»‰nh sá»­a CV láº·p láº¡i</option> <option value='repeated_task_remove'>XĂ³a CV láº·p láº¡i</option> <option value='repeated_task_force_run'>Force run CV láº·p láº¡i</option> <option value='custom_field_add'>ThĂªm trÆ°á»ng tĂ¹y chá»‰nh</option> <option value='custom_field_edit'>Chá»‰nh sá»­a trÆ°á»ng tĂ¹y chá»‰nh</option> <option value='custom_field_remove'>XĂ³a trÆ°á»ng tĂ¹y chá»‰nh</option> <option value='tasklit_create'>Táº¡o nhĂ³m cĂ´ng viá»‡c</option> <option value='tasklist_edit'>Chá»‰nh sá»­a nhĂ³m cĂ´ng viá»‡c</option> <option value='tasklist_close'>ÄĂ³ng nhĂ³m cĂ´ng viá»‡c</option> <option value='tasklist_remove'>XĂ³a nhĂ³m cĂ´ng viá»‡c</option> <option value='tasklist_reopen'>Má»Ÿ láº¡i nhĂ³m cĂ´ng viá»‡c</option> <option value='tasklist_review'>Cáº­p nháº­t ngÆ°á»i Ä‘Ă¡nh giĂ¡ cho nhĂ³m CV</option>";
		return options;
	};

};

var Tool=new function __Tool(){
	
};



Tool.importer = new function __ToolImporter() {

	this.dialog = function() {

		var columns = [
			{label: "TĂªn cĂ´ng viá»‡c", name: "name", width: 0.6},
			{label: "NgÆ°á»i giao", name: "creator_username"},
			{label: "NgÆ°á»i thá»±c hiá»‡n", name: "assign"},
			{label: "NgÆ°á»i theo dĂµi", name: "followers"},
			{label: "Kháº©n cáº¥p", name: "urgent"},
			{label: "Quan trá»ng", name: "important"},
			{label: "Danh sĂ¡ch nhĂ£n", name: "tags"},
			{label: "NgĂ y báº¯t Ä‘áº§u", name: "start_time"},
			{label: "Thá»i háº¡n", name: "deadline"},
			{label: "HoĂ n thĂ nh thá»±c táº¿", name: "completed_time"},
			{label: "MĂ´ táº£ cĂ´ng viá»‡c", name: "content"},
			{label: "Tráº¡ng thĂ¡i", name: "status"},
			{label: "Káº¿t quáº£ cĂ´ng viá»‡c", name: "result"},
			{label: "Má»¥c tiĂªu", name: "milestone"},
		];

		var project = Client.pageData.project;
		var project_form = project.form;
		if (project_form.length) {
			for (var i = 0; i < project_form.length; i++) {
				columns.push({label: project_form[i].name, name: 'custom_' + project_form[i].id});
			}
		}

		var data = {id: project.id};

		var rows = [];
		if (Client.config.task_import_delegate == 'none') {
			var warning_text = "Báº¡n khĂ´ng cĂ³ quyá»n nháº­p cĂ´ng viá»‡c tá»« file excel dÆ°á»›i danh nghÄ©a cá»§a ngÆ°á»i khĂ¡c, vĂ¬ váº­y báº¡n sáº½ lĂ  ngÆ°á»i giao viá»‡c cá»§a cá»§a nhá»¯ng cĂ´ng viá»‡c Ä‘Ă³"
			rows.push({
				type: 'html', html: "  " +Render.render('flag_message', {icon: "ap exclamation" , color: "warning" , _class: "sample-note" }, ""+(warning_text)+"")+ ''
			})
		}
		var warning_text = ''

		Base.importer.dialog({
			action: "api/settings/import/excel",
			rows: rows,
			columns: columns,
			data:[],
			hiddens : data,
			title: "Nháº­p cĂ´ng viá»‡c"
		});

		if (project.metatype == "project") {
			$("#dialog-excel-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_import_excel:project");
		} else if (project.metatype == "team") {
			$("#dialog-excel-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_import_excel:project");
		} else if (project.metatype == "private") {
			$("#dialog-excel-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_private_import_excel:project");
		}
	};
	
	
	
	this.bindTemplates = function(canvas) {

		$(canvas).html(AP.render(Client.pageData.templates, function(e) {
			return "<div class='item'>" +
				"<div class='icon'><span class='-ap icon-file-empty'></span></div>" +
				"<div class='name'>"+e.name+"</div>" +
				"<div class='info'>"+e.file+"</div>" +
				"<div class='side'>" +
				"	<div class='b preview url' data-blank='1' data-url='"+Client.static_url+"/samples/"+e.file+"'>Xem trÆ°á»›c</div>" +
				"	<div class='b submit' data-file='"+e.file+"'>Nháº­p</div>" +
				"</div>" +
			"</div>";
		}));
		
		$(canvas).find(".submit").click(function() {
			var file=$(this).data("file");
			AP.confirm("XĂ¡c nháº­n import cĂ´ng viá»‡c tá»« file nĂ y?", function() {
				AP.xpost("api/settings/import/local",{file: file},function(code) {
					if (!code.good()) {
						return AP.alertError(code.message);
					}
					
					AP.alertSuccess("Import successfully!", function() {
						AP.redirect(Client.pageData.context.path+"/home");
					});
					
				})
			});
		});
	};
	
};


Tool.updater = new function __ToolUpdater() {

	this.dialog = function() {

		var columns = [];

		var project = Client.pageData.project;
		var project_form = project.form;
		if (project_form.length) {
			for (var i = 0; i < project_form.length; i++) {
				columns.push({label: project_form[i].name, name: 'custom_' + project_form[i].id});
			}
		}

		columns.push({label: "MĂ£ cĂ´ng viá»‡c (ID)", name: "task_id"});

		var data = {id: project.id};

		Base.importer.dialog({
			action: "api/settings/import/update",
			rows: [],
			columns: columns,
			data:[],
			hiddens : data,
			title: "Cáº­p nháº­t cĂ´ng viá»‡c"
		});

		if (project.metatype == "project") {
			$("#dialog-excel-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_update_excel:project");
		} else if (project.metatype == "team") {
			$("#dialog-excel-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_update_excel:project");
		} else if (project.metatype == "private") {
			$("#dialog-excel-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_private_update_excel:project");
		}
	};



	this.timeInfo = function() {

		var project = Client.pageData.project;
		var columns = [
			{label: "NgĂ y báº¯t Ä‘áº§u", name: "start_time", id: "start_time"},
			{label: "Thá»i háº¡n", name: "deadline", id: "deadline"},
		];

		return Tool.updater.form({
			action: "api/settings/import/update.time", 
			columns: columns,
			rows: [], 
			options: columns,
			hiddens: {
				id: project.id
			},
			preview: 1,
			title: "Cáº­p nháº­t cĂ´ng viá»‡c"
		})
	};


	this.form = function (opts) {

		this.options = opts.options;
		opts = $.extend({hiddens: {}, rows:[]}, opts);

		var rows = [
			{type: 'file', name: 'file', label: 'Chá»n file'},
			{type: "placeholder", id: "internal-excel"}
		];
		rows = rows.concat(opts.rows);

		var render = function() {

			form = this;

			init(opts);
			onSelect(opts.columns);

			$("#internal-excel .excel-cols").sortable({
				items: ".ui-col",
				handle: ".sicon",
				helper: "clone",
				axis: "y",
				stop: function(event, ui) {
					onSort();
				}
			});


			if (opts.preview) {

				form.find("file").on("change", function() {

					if ($("#internal-excel .excel-table").length) {
						$("#internal-excel .excel-live-preview").empty();
						form.find("preview").val(1);
						form.selector(".button.ok").html("Tiáº¿p tá»¥c");
					}
				});
			}


			$("#internal-excel").closest(".row").addClass("-active");

			$("#internal-excel .js-download").click(function(){
				downloadTemplatedFile(opts.columns);
			});
		};

		var btn_label = "Nháº­p";
		if (opts.preview) {
			btn_label = "Tiáº¿p tá»¥c";
			opts.hiddens.preview=1;
		}

		var buttons = Form.button({
			label: btn_label,
			style: "ok",
			action: function () {

				var cols = $("#internal-excel input[name=__excel_orders]").val();
				cols = AP.word.split(",", cols);
				if (cols.length > 130) {
					return AP.alertError("Maximum 130 columns!");
				}

				if (cols.length == 0) {
					return AP.alertError("None selected columns!");
				}

				Form.v2.submit(function (code) {

					if (!code.good()) {
						return AP.alertError(code.message);
					}

					if (code.message == "FILE_PREVIEW") {
						previewRows(code.rows);
						return;
					}

					if (opts.callback) {
						opts.callback(code);
					} else {
						Form.v2.hide();
						UI.flash(code.message);
					}
				})
			}
		}).button(":cancel");

		Form.v2({
			title: opts.title,
			action: opts.action,
			rows: rows,
			data: opts.hiddens,
			buttons: buttons,
			render: render,
			width: 600
		});

		Form.v2.balance();
	};


	/**
	 * @desc Preview the role
	 */
	function previewRows(rows) {

		UI.flash("Please preview before uploading");
		
		var cols = {};
		$("#internal-excel .excel-cols .ui-col").each(function() {
			cols[$(this).data("name")] = {
				label: $(this).find(".col-label").text(),
				width: $(this).data("width")
			}
		});
		
		$("#internal-excel .excel-live-preview").html(getRows(cols, rows));
		var ch = $("#internal-excel .excel-live-preview .excel-table").height() + 10;
		
		if (ch > 200) {
			ch = 200;
		}
		
		if (ch < 100) {
			ch = 100;
		}
		
		$("#internal-excel .excel-table-canvas").css({height: ch});
		
		$("#internal-excel").closest("form").find("input[name=preview]").val(0);
		$("#internal-excel").closest("form").find(".button.ok").html("Nháº­p");
		
		AP.dialog("dialog-excel-dx").balance();
	};


	function getRows(cols, rows) {

		var grouping = $("#internal-excel").data("grouping");
		
		var header = '';
		var tw = 48;
		
		for (var key in cols) {
			var c = cols[key];
			var w = parseFloat(c.width)*200;
			
			header += "<div class='th' style='width: "+(w)+"px'>"+(c.label)+"</div>";
			tw += w;
		};
		
		var real_index = 0;
		var html = AP.render(rows, function(r, index) {
			
			var temp = '';
			if (grouping) {
				if (!r.name) {
					return '';
				}
				
				if (AP.word.suffix(r.name, ":")) {
					return "<div class='tr-group'><div class='tdg'>"+(r.name)+"</div></div>";
				}
			}
			
			real_index++;
			
			for (var k in cols) {
				var w = cols[k].width * 200;
				
				if (r[k]) {
					temp += "<div class='td' style='width: "+(w)+"px'>"+(r[k])+"</div>";
				} else {
					temp += "<div class='td' style='width: "+(w)+"px'></div>";
				}
			}
			
			return "<div class='tr'><div class='td index' style='width:48px'>"+(real_index)+"</div>"+(temp)+"</div>";
		});
		
		
		return "<div class='excel-table-title'>Xem trÆ°á»›c dá»¯ liá»‡u</div> <div class='excel-table-canvas'> <div class='excel-canvas scroll-x scroll-y forced-scroll'> <div class='excel-table' style='width: "+(tw)+"px'> <div class='thead'> <div class='th index' style='width:48px'>#</div> "+(header)+" </div> <div class='tbody'> <div class='td index' style='width:48px'></div> "+(html)+" </div> </div> </div> </div>";
	};


	function downloadTemplatedFile(option_cols) {

		var ids = $("#internal-excel input[name=__excel_orders]").val();
		ids = AP.word.split(",", ids);

		var selected_cols = ARR.select(ids, function (id) {

			if (id == 'task_id') {
				return {label: "MĂ£ cĂ´ng viá»‡c (ID)", name: "task_id", id: "task_id"};
			}
			
			return ARR.findObj(option_cols, id);
		});

		var full_cols = getFullCols(selected_cols);
		var headers = ARR.select(full_cols, function(c) {
			return ""+(c.label)+"";
		});

		var rows = [];

		Base.io.exp({
			headers: headers,
			rows: rows,
			title: "update.templated.file"
		});
	};


	function getFullCols(cols) {

		var full_cols = [].concat(cols);

		if (!ARR.findObj(full_cols, "task_id")) {
			full_cols.push({label: "MĂ£ cĂ´ng viá»‡c (ID)", name: "task_id", id: "task_id"});
		}

		return full_cols;
	};


	/**
	 * @desc Get columns HTML and support drag/drop
	 */
	 function init(opts) {

		$("#internal-excel").html("<div class='select-cols'></div> <div class='hidden'><input type='hidden' name='__excel_orders' value=''/></div> <div class='col-note'>Vui lĂ²ng chá»n má»™t file Excel vá»›i thá»© tá»± cĂ¡c cá»™t theo Ä‘Ăºng vá»›i danh sĂ¡ch dÆ°á»›i Ä‘Ă¢y. <em class='js-download url'>Download</em>?</div> <div class='excel-inline-wrapper scroll-y'> <div class='excel-cols'></div> </div> <div class='excel-live-preview'></div>");

		renderOptions(opts);
	};


	/**
	 * @desc Get columns HTML and support drag/drop
	 */
	function renderOptions(opts) {

		var items = AP.render(opts.options, function(e) {
			return "<div class='is-item' data-id='"+(e.id)+"' data-label='"+(e.label)+"'>"+(e.label)+"</div>";
		});

		var html="<div class='selecter'> <div class='is-display url' data-url=':active:parent'><div class='ap-xdot'>Chá»n trÆ°á»ng thĂ´ng tin Ä‘á»ƒ nháº­p dá»¯ liá»‡u</div></div> <div class='is-box'> <div class='is-search'><input type='text' class='js-filter-opts' placeholder='Lá»c nhanh'/></div> <div class='mask-actions'> <div class='action all'>Táº¥t cáº£</div> <div class='action clear'>Bá» chá»n táº¥t cáº£</div> </div> <div class='is-scroll scroll-y url'> <div class='is-items'>"+(items)+"</div> </div> <div class='is-close'>HoĂ n thĂ nh</div> </div> </div>";

		$(".select-cols").html(html);

		$(".select-cols").find(".is-item").each(function() {
			if (ARR.findObj(opts.columns, $(this).data("id"))) {
				$(this).addClass("active");
			}
		});

		$(".select-cols").find(".js-filter-opts").quickFilter(".is-item", function($e, q) {
			return AP.word.fulltextMatch($e.text(), q);
		});

		$(".select-cols").find(".is-item").click(function() {
			$(this).toggleClass("active");

			var ids = $("#internal-excel input[name=__excel_orders]").val();
			ids = AP.word.split(",", ids);

			var col = {id: $(this).data("id"), label: $(this).data("label")};
			if ($(this).hasClass("active")) {
				ids.push(col.id);
			} else {
				ids = ARR.remove(ids, col.id);
			}

			var cols = ARR.select(ids, function (id) {
				return ARR.findObj(opts.options, id);
			});

			onSelect(cols);
		});

		$(".select-cols").find(".is-close").click(function() {
			$(".select-cols").find(".selecter").removeClass("active");
		});

		$(".select-cols").find(".action.all").click(function() {
			$(".select-cols").find(".is-item").addClass("active");
			onSelect(opts.options);
		});

		$(".select-cols").find(".action.clear").click(function() {
			$(".select-cols").find(".is-item").removeClass("active");
			onSelect([]);
		});
	};


	function onSelect(cols) {

		var cols = getFullCols(cols);
		var ids = ARR.extract(cols, "id");
		$("#internal-excel input[name=__excel_orders]").val(ids.join(","));
		renderColumns(cols);
	};


	function onSort() {

		var names = [];
		$("#internal-excel .ui-col").each(function(index) {
			$(this).find(".sicon").html(AP.data.zeroPrefix(index+1));
			names.push($(this).data("key"));
		});

		$("#internal-excel input[name=__excel_orders]").val(names.join(","));
	};


	/**
	 * @desc Get columns HTML and support drag/drop
	 */
	function renderColumns(cols) {

		var html = AP.render(cols, function(c, index) {

			var info = "";
			if (c.info) {
				info = "<div class='col-info'>"+(c.info)+"</div>";
			}


			var w = 1;
			if (c.width) {
				w = parseFloat(c.width);
			}

			return "<div class='ui-col' data-key='"+(c.id)+"' data-name='"+(c.id)+"' data-width='"+(w)+"'> <div class='sicon'>"+(AP.data.zeroPrefix(index+1))+".</div> <div class='col-label'>"+(c.label)+"</div> "+(info)+" <div class='col-key'>"+(c.id)+"</div> </div>";
		});

		$(".excel-cols").html(html);
	};
};


Tool.export = new function __ToolExporter() {

	this.multipleProjects = function() {
		var projects = Client.pageData.projects;

		if (!projects || !projects.length) {
			return AP.alertError("KhĂ´ng tĂ¬m tháº¥y báº¥t kĂ¬ dá»± Ă¡n/phĂ²ng ban nĂ o trong há»‡ thá»‘ng");
		}
		
		var rows = [
            {type: "html", html: "<div class='hint'>Há»— trá»£ xuáº¥t tá»‘i Ä‘a 100 dá»± Ă¡n/phĂ²ng ban, 3000 CĂ´ng viá»‡c vĂ  5000 CĂ´ng viá»‡c con</div>"},
			[
                {label: "Tá»« ngĂ y", name: "start_time", type: "text", role: "date", placeholder:"Máº·c Ä‘á»‹nh lĂ  30 ngĂ y trÆ°á»›c", value: AP.time.beginOfDay(AP.time.now()-30*24*3600)},
			    {label: "Äáº¿n ngĂ y", name: "end_time", type: "text", role: "date", placeholder:"Máº·c Ä‘á»‹nh lĂ  hĂ´m nay", value: AP.time.now()},
            ],
            [
                {label: "Xuáº¥t CV con?", name: "subtasks", type: "select", options: [{label: "CĂ³", value: 1}, {label: "KhĂ´ng", value: 0}], value: 1},
                {label: "Xuáº¥t CV vá»›i trÆ°á»ng tĂ¹y chá»‰nh?", name: "cfs", type: "select", options: [{label: "CĂ³", value: 1}, {label: "KhĂ´ng", value: 0}], value: 1},
            ],
            {type: "html", html: "<div class='label'>Xuáº¥t CV cá»§a cĂ¡c dá»± Ă¡n/phĂ²ng ban: *</div> <div class='more'> <div class='search-note'>Chá»n dá»± Ă¡n/phĂ²ng ban muá»‘n xuáº¥t CV</div> <div id='js-check-projects' class='check-all' data-check='all'>Bá» chá»n táº¥t cáº£</div> </div>"},
            {type: "html", html: "  " +Render.render('search', {placeholder: "TĂ¬m dá»± Ă¡n/phĂ²ng ban" , id: "js-search-project" }, '')+ ''},
			{name: "project_ids", type: "checkboxes", options: getExportOptions(projects)},
		];

		Form.v2({
			id: "export-tasks-of-projects",
			rows: rows,
			buttons: Form.button({
				label: "Xuáº¥t", style: "ok", action: function(){
                    var ps = $("#export-tasks-of-projects").serializeArray();

                    var project_ids = ps.filter(e => e.name == "project_ids[]");

                    if (!project_ids.length) {
                        return AP.alertError("HĂ£y chá»n dá»± Ă¡n/phĂ²ng ban báº¡n muá»‘n xuáº¥t CV");
                    }

                    if (!project_ids.length > 100) {
                        return AP.alertError("Há»— trá»£ xuáº¥t tá»‘i Ä‘a 100 dá»± Ă¡n/phĂ²ng ban");
                    }
 
                    project_ids = AP.render(project_ids, function(e){
                        return e.value+",";
                    });

                    ps = AP.array.filter(ps, function(e){
                        return e.name != "__code" && e.name != "project_ids[]";
                    });

                    ps.push({name: "project_ids", value: project_ids});
                    ps = $.param(assoc(ps));

                    var url = Client.url + "/wework/export/multiple.projects?" + ps;

                    window.open(url);

                    return;
				}
			}).button(":cancel"),
			title: "Xuáº¥t CV cá»§a nhiá»u dá»± Ă¡n/phĂ²ng ban",
			width: 480,
            render: function(){
                filterProjects();
                checkAll();
            }
		});

	};

    function getExportOptions(projects) {
        var options = [];

        var lists = ARR.filter(projects, function(e){
            return e.metatype != "private";
        });

        ARR.sort(lists, function(e, f){
            return parseInt(e.id) - parseInt(f.id);
        }) 

        AP.render(lists, function(e) {
            if (e.metatype != "private") {
                options.push({label: e.name, value: e.id});
            }
        });

        return options;
    }

    function filterProjects() {
        $("#js-search-project").on("input change", function() {
			var fulltext_search = $("#js-search-project").val();

            $('.list.checkboxes .li.block').each(function() {
				var name = $(this).text();
				if (!name || !name.length){
					return true;
				}

				name = name.toLowerCase();
				has_show = AP.word.fulltextMatch(name, fulltext_search);

				if (has_show){
					$(this).show();
					$(this).addClass("matched");
				} else {
					$(this).hide();
					$(this).removeClass("matched");
				}
            });

		});
    }

    function checkAll() {
        $("input[name='project_ids[]']").each(function(){
            $(this).prop("checked", true);
        });

        $("#js-check-projects.check-all").click(function(){
            if ($(this).data("check") == "none") {
                $(this).html("Bá» chá»n táº¥t cáº£");
                $(this).data("check", "all");

                $("input[name='project_ids[]']").each(function(){
                    $(this).prop("checked", true);
                });
            } else {
                $(this).html("Chá»n táº¥t cáº£");
                $(this).data("check", "none");

                $("input[name='project_ids[]']").each(function(){
                    $(this).prop("checked", false);
                });
            }
        });
    }
}
FormBuilder = new function __FormBuilder(){
	this.options={};
	
	this.obj=null;
	var lock=false;
	
	this.init=function(){
		this.options={
			url: Client.pageData.context.path+"/api/settings/form/fields",
			custom: Client.pageData.context.path+"/api/settings/form/custom"
		};
		
		showFields();
		this.obj=Client.pageData.context;
		
		$("#custom-form .item.real").each(function(){
			$(this).find(".switch").on("click mouseup",function(){
				if (lock){
					return
				}
				
				lock=true;
				var enabled=getEnabled(this);
				
				if (enabled){
					$(this).removeClass("-on").addClass("-off");
					$(this).parent().find(".st").html("Disabled");
					setEnabled(this, 0);
				}else{
					$(this).removeClass("-off").addClass("-on");
					$(this).parent().find(".st").html("<em class='text-success'>Enabled</em>");
					setEnabled(this, 1);
				}
			});
			
			$(this).find(".checkbox").click(function(){
				var enabled=getRequired(this);
				if (enabled){
					$(this).parent().find(".ip-required").val(0);
					setRequired(this, 0);
				}else{
					$(this).parent().find(".ip-required").val(1);
					setRequired(this, 1);
				}
			});
		});
		
		
		$("#custom-form .item").addClass("first");

		AP.dnd("#setting", "api/settings/form/custom/dnd", {
			id: this.obj.id,
			multi: 0
		}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("UPDATE_SUCCESSFULLY");
			AP.refresh();
		},{
			accept: "xls, xlsx"
		});
	};
	
	
	this.remove=function(ref){
		AP.confirm("Báº¡n cĂ³ muá»‘n xĂ³a custom field nĂ y ?", function(){
			var name=$(ref).closest(".item").data("id");
			UI.ajaxShow();
            var project_id = Client.pageData.project.id;
			AP.post(FormBuilder.options.custom+"/remove", {
				obj: FormBuilder.obj.id,
				name: name,
                project_id: project_id
			}, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Content removed ...");
				$(ref).closest(".item").slideUp(300, function(){
					$(this).remove();
				});
			});
		});
	};
	
	
	this.move=function(ref, dir){
		var name=$(ref).closest(".item").data("id");
		UI.ajaxShow();
		AP.post(FormBuilder.options.custom+"/move", {
			obj: FormBuilder.obj.id,
			name: name,
			dir: dir
		}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Content updated ...");
			$(ref).closest(".item").move(dir, true);
		});
	};
	
	
	this.edit=function(ref){
		var id=$(ref).closest(".item").data("id");
		var item=AP.array.find(Client.pageData.form.customs, function(e){
			return e.id==id;
		});
		if (!item){
			return;
		}
	
		
		FormBuilder.custom.edit(item);
	};


	this.editKey=function(ref){
		var id=$(ref).closest(".item").data("id");
		var item=AP.array.find(Client.pageData.form.customs, function(e){
			return e.id==id;
		});
		if (!item){
			return;
		}
		
		FormBuilder.custom.editKey(item);
	};


	this.addBelow = function(ref) {

		var id = $(ref).closest(".item").data("id");
		var item = AP.array.find(Client.pageData.form.customs, function(e) {
			return e.id == id;
		});

		if (!item) {
			return;
		}

		FormBuilder.custom.addBelow(item);
	};

	
	function showFields(){
		$("#js-fields").html(AP.render(Client.pageData.form.rows, function(e){
			if (e.id=="cv" || e.id=="phone" || e.id=="title"){
				return "";
			}
			return getRowHTML(e);
		}));
		
		
		$("#js-base-fields").html(AP.render(Client.pageData.form.rows, function(e){
			if (e.id=="cv" || e.id=="phone" || e.id=="title"){
				return getRowHTML(e);
			}
			
			return "";
		}));
		
		
		$("#js-custom-forms").html(AP.render(Client.pageData.form.customs, function(e){
			return getRowHTML(e, true);
		}));
		
		
		$("#custom-form .item.real").each(function(){
			var required=parseInt($(this).data("required"));
			var enabled=parseInt($(this).data("enabled"));
			
			if (enabled){
				$(this).find(".ip-enabled").val(1);
				$(this).find(".switch").removeClass("-off").addClass("-on");
				$(this).find(".st").html("<em class='text-success'>Show on home</em>");
			}
			
			if (required){
				$(this).find(".ip-required").val(1);
				$(this).find(".checkbox").addClass("checked");
			}
		});
	};
	
	
	
	function getEnabled(ref){
		var val=$(ref).closest(".item").find(".ip-enabled").val();
		if (val && parseInt(val)){
			return 1;
		}
		
		return 0;
	};
	
	function setEnabled(ref, val){
		$(ref).closest(".item").find(".ip-enabled").val(val);
		var name=$(ref).closest(".item").data("id");
		
		UI.ajaxShow();
		AP.post(FormBuilder.options.url+"/set", {
			obj: Client.pageData.context.id,
			name: name,
			type: "enabled",
			value: val
		}, function(code){
			lock=false;
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Content saved ...");
		});
	};
	
	
	function getRequired(ref){
		var val=parseInt($(ref).closest(".item").find(".ip-required").val());
		if (val){
			return 1;
		}
		
		return 0;
	};
	
	
	function setRequired(ref, val){
		if (val==1){
			$(ref).addClass("checked");
		}else{
			$(ref).removeClass("checked");
		}
		
		
		var name=$(ref).closest(".item").data("id");
		
		UI.ajaxShow();
		AP.post(FormBuilder.options.url+"/set", {
			obj: Client.pageData.context.id,
			name: name,
			type: "required",
			value: val
		}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Content saved ...");
		});
	};
	
	
	
	
	function getRowHTML(e, custom){
		var actions="";
		if (custom){
			actions="<div class='actions'>" +
				"<span class='-ap icon-add_circle_outline' title='Add input below' onclick='FormBuilder.addBelow(this);'></span> &nbsp; " +
				"<span class='-ap icon-uniF116' title='Edit input' onclick='FormBuilder.edit(this);'></span> &nbsp; " +
				"<span class='-ap icon-uniF12A' title='Edit input key' onclick='FormBuilder.editKey(this);'></span> &nbsp; " +
				"<span class='-ap icon-close' onclick=\"FormBuilder.remove(this);\"></span> &nbsp; " +
				"<span class='-ap icon-chevron-thin-up' onclick=\"FormBuilder.move(this, 'up');\"></span> &nbsp; " +
				"<span class='-ap icon-chevron-thin-down' onclick=\"FormBuilder.move(this, 'down');\"></span>" +
			"</div>";
		}
		
		return "<div class='item real' data-id='"+e.id+"' data-enabled='"+e.enabled+"' data-required='"+e.required+"'>"+
			"<input type='hidden' class='ip-enabled' name='"+e.id+"-enabled' value='0'/>" +
			"<input type='hidden' class='ip-required' name='"+e.id+"-required' value='0'/>" +
			"<div class='checkbox'>"+
				"<div class='checkbox-icon'></div>"+
				"<div class='label'>Required?</div>"+
			"</div>"+
			"<div class='label'>"+e.name+"</div>"+
			"<div class='type'>"+FormBuilder.type.display(e.type)+"</div>"+
			actions + 
			"<div class='switch -off'></div>"+
			"<div class='st'>Do not show</div>"+
		"</div>";
	};
};



FormBuilder.custom = new function __FormBuilderCustom() {

	this.add = function(ref, callback) {

		var data = {id: Client.pageData.context.id, token: Client.pageData.context.token};
		var last_option_id = getLastOptionID();
        
		var form = Form.create('custom-question-fx',{'action': Client.pageData.context.path + "/api/settings/form/custom/add"})
		.row(
		    Form.label({label: "Loáº¡i dá»¯ liá»‡u Ä‘áº§u vĂ o *"}),
		    Form.input({name: 'metatype', type:'select', options: questionTypes()})
		).addClass("-big required")
		.row(
		    Form.label({label: "TĂªn trÆ°á»ng dá»¯ liá»‡u *"}),
		    Form.input({name: 'name', type:"text", placeholder:"TĂªn trÆ°á»ng dá»¯ liá»‡u *"})
		).addClass("-big required")
		.row(
		    Form.label({label: "Giáº£i thĂ­ch hoáº·c hÆ°á»›ng dáº«n thĂªm vá» cĂ¢u há»i"}),
		    Form.input({name: 'content', type:'textarea', placeholder:"Giáº£i thĂ­ch thĂªm (khĂ´ng báº¯t buá»™c)"}).css({'min-height': 80, resize: 'vertical', overflow: 'auto'})
		)
		.rowHidden(
		    Form.label({label: "CĂ¡c lá»±a chá»n, cĂ¡ch nhau bá»Ÿi dáº¥u pháº©y hoáº·c cháº¥m pháº©y *"}),
		    Form.input({name: 'options', type:'textarea'}).css({'min-height': 60, resize: 'vertical', overflow: 'auto'})
		)
		.rowHidden(
		    Form.label({label: "{{js.field.required|Báº¯t buá»™c tráº£ lá»i?}}"}),
		    Form.input({name: 'required', type:'select', options: requiredOptions()})
		)
		.row(
			Form.label({label: "Thá»© tá»± Ä‘á»©ng sau?"}),
			Form.input({name: 'after', type:'select', options: afterOptions()}).value(last_option_id)
		)
		.buttons([
            {label: "ThĂªm trÆ°á»ng má»›i", action: function() {
                Form.submit("#custom-question-fx", function(code) {
                    if (!code.good()) {
                    	return AP.alertError(code.message);
                    }

                    Form.hide("custom-question-fx");
                    UI.flash("Custom field created ...");

                    if (callback) {
                    	callback(code.row);
                    } else {
                    	AP.xRefresh();
                    }
                })
            }, style: 'ok -success -rounded bold'},
            {label: "Há»§y bá»", action: function() {
                Form.hide("custom-question-fx");
            }, style:'cancel -passive-2 -rounded'}
        ])
        .hiddens(data)
		.render(function(form) {
			form.find("metatype").on("change", function() {
				var val = $(this).val();
				if (val == "select" || val == "select-m") {
					form.findRow("options").show();
				} else {
					form.findRow("options").hide();
				}
			});

			if (Client.pageData.context.metatype == "project") {
				$("#custom-question-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_custom_field_created:project");
			} else if (Client.pageData.context.metatype == "team") {
				$("#custom-question-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_custom_field_created:project");
			} else if (Client.pageData.context.metatype == "private") {
				$("#custom-question-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_private_custom_field_created:project");
			}
		});
		    
		Form.pop({width: 480, label: 'ThĂªm trÆ°á»ng dá»¯ liá»‡u', layout: "flat", closable: false}).setForm(form).show().focus('name');
	};
	
	
	this.edit = function(obj, callback) {

		var project_id = Client.pageData.project.id
		var data = {id: obj.id, project_id: project_id};
        var options = "";
        if (obj.options && AP.data.isArray(obj.options)) {
        	options = obj.options.join(", ");
        }

		var before_array = getBeforeArray();

        var placeholder = '';
		if (obj.placeholder) {
			placeholder = obj.placeholder.replace(/\-\-br\-\-/g, "<br>");
		}
        
		var form = Form.create('custom-question-fx',{'action': "api/settings/form/custom/edit"})
		.row(
		    Form.label({label: "Loáº¡i dá»¯ liá»‡u Ä‘áº§u vĂ o *"}),
		    Form.input({name: 'metatype', type:'select', options: questionTypes()}).value(obj.type)
		)
		.row(
		    Form.label({label: "TĂªn trÆ°á»ng dá»¯ liá»‡u *"}),
		    Form.input({name: 'name', type:"text", placeholder:"TĂªn trÆ°á»ng dá»¯ liá»‡u"}).value(obj.name)
		).addClass("-big required")
		.row(
		    Form.label({label: "MĂ´ táº£ trÆ°á»ng dá»¯ liá»‡u"}),
		    Form.input({name: 'content', type:'textarea'}).css({'min-height': 120, resize: 'vertical', overflow: 'auto'}).value(placeholder)
		)
		.rowHidden(
			Form.label({label: "CĂ¡c lá»±a chá»n, cĂ¡ch nhau bá»Ÿi dáº¥u pháº©y hoáº·c cháº¥m pháº©y *"}),
			Form.input({name: 'options', type:'textarea'}).css({'min-height': 60, resize: 'vertical', overflow: 'auto'}).value(obj.options)
		)
		.rowHidden(
			Form.label({label: "{{js.field.required|Báº¯t buá»™c tráº£ lá»i?}}"}),
			Form.input({name: 'required', type:'select', options: requiredOptions()})
		)
		.row(
			Form.label({label: "Thá»© tá»± Ä‘á»©ng sau?"}),
			Form.input({name: 'after', type:'select', options: afterOptions()}).value(before_array[obj.id])
		)
		.buttons([
            {label: "Chá»‰nh sá»­a trÆ°á»ng dá»¯ liá»‡u", action: function() {
                Form.submit("#custom-question-fx", function(code) {
                    if (!code.good()) {
                        return AP.alertError(code.message);
                    }
                     
                    Form.hide("custom-question-fx");     
                    UI.flash("TrÆ°á»ng dá»¯ liá»‡u Ä‘Ă£ Ä‘Æ°á»£c cáº­p nháº­t ...");
                     
                    if (callback) {
                    	callback(code.row);
                    } else {
                    	AP.xRefresh();
                    }
                })
            }, style: 'ok -success -rounded bold'},
            {label: "Há»§y bá»", action: function() {
                Form.hide("custom-question-fx");
            }, style:'cancel -passive-2 -rounded'}
        ])
        .hiddens(data)
		.render(function(form) {
			form.find("metatype").on("change", function() {
				var val = $(this).val();
				if (val == "select" || val == "select-m") {
					form.findRow("options").show();
				} else {
					form.findRow("options").hide();
				}
			}).change();
		});
		    
		Form.pop({width: 600, label: 'Chá»‰nh sá»­a trÆ°á»ng dá»¯ liá»‡u', layout: "flat", closable: false}).setForm(form).show().focus('name');
	};


	this.editKey = function(obj, callback) {
		var data = {id: Client.pageData.project.id, token: Client.pageData.project.token, item: obj.id};
		var options = "";
		if (obj.options && AP.data.isArray(obj.options)) {
			options = obj.options.join(", ");
		}

		var form = Form.create('custom-question-fx',{'action': FormBuilder.options.custom + "/edit.key"})
		.row(
			Form.label({label: "TĂªn trÆ°á»ng dá»¯ liá»‡u *"}),
			Form.input({name: 'name', type:"fake", placeholder:"TĂªn trÆ°á»ng dá»¯ liá»‡u"}).value(obj.name)
		)
		.row(
			Form.label({label: "MĂ£ trÆ°á»ng dá»¯ liá»‡u *"}),
			Form.input({name: 'row_key', type:'text', placeholder:"MĂ£ trÆ°á»ng dá»¯ liá»‡u"}).value(obj.id)
		)
		.buttons([
			{label: "HoĂ n thĂ nh", action: function() {
				Form.submit("#custom-question-fx", function(code) {
					if (!code.good()) {
						return AP.alertError(code.message);
					}
					 
					Form.hide("custom-question-fx");	 
					UI.flash("Form edited ...");
					 
					if (callback) {
						callback(code.row);
					} else {
						AP.xRefresh();
					}
				})
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y bá»", action: function() {
				Form.hide("custom-question-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form) {
		});
			
		Form.pop({width: 400, label: 'Chá»‰nh sá»­a mĂ£ input', layout: "flat", closable: false}).setForm(form).show().focus('row_key');
	};
	

	this.addBelow = function(ref, callback) {

		var data = {id: Client.pageData.context.id, token: Client.pageData.context.token};

		var form = Form.create('custom-question-fx',{'action': FormBuilder.options.custom + "/add"})
		.row(
			Form.label({label: "Loáº¡i dá»¯ liá»‡u Ä‘áº§u vĂ o *"}),
			Form.input({name: 'metatype', type:'select', options: questionTypes()})
		).addClass("-big required")
		.row(
			Form.label({label: "TĂªn trÆ°á»ng dá»¯ liá»‡u *"}),
			Form.input({name: 'name', type:"text", placeholder:"TĂªn trÆ°á»ng dá»¯ liá»‡u *"})
		).addClass("-big required")
		.row(
			Form.label({label: "Giáº£i thĂ­ch hoáº·c hÆ°á»›ng dáº«n thĂªm vá» cĂ¢u há»i"}),
			Form.input({name: 'content', type:'textarea', placeholder:"Giáº£i thĂ­ch thĂªm (khĂ´ng báº¯t buá»™c)"}).css({'min-height': 80, resize: 'vertical', overflow: 'auto'})
		)
		.rowHidden(
			Form.label({label: "Báº¯t buá»™c tráº£ lá»i?"}),
			Form.input({name: 'required', type:'select', options: requiredOptions()})
		)
		.rowHidden(
			Form.label({label: "CĂ¡c lá»±a chá»n, cĂ¡ch nhau bá»Ÿi dáº¥u pháº£y hoáº·c cháº¥m pháº£y *"}),
			Form.input({name: 'options', type:'textarea'}).css({'min-height': 60, resize: 'vertical', overflow: 'auto'})
		)
		.row(
			Form.label({label: "Thá»© tá»± Ä‘á»©ng sau?"}),
			Form.input({name: 'after', type:'select', options: afterOptions()}).value(ref.id)
		)
		.buttons([
			{label: "ThĂªm trÆ°á»ng má»›i", action: function() {
				Form.submit("#custom-question-fx", function(code) {
					if (!code.good()) {
						return AP.alertError(code.message);
					}
					 
					Form.hide("custom-question-fx");	 
					UI.flash("Custom field created ...");
					 
					if (callback) {
						callback(code.row);
					} else {
						AP.refresh();
					}
				})
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y bá»", action: function() {
				Form.hide("custom-question-fx");
			}, style:'cancel -passive-2 -rounded'}
		])
		.hiddens(data)
		.render(function(form) {
			form.find("metatype").on("change", function() {
				var val = $(this).val();
				if (val == "select" || val == "select-m") {
					form.findRow("options").show();
				} else {
					form.findRow("options").hide();
				}
			});

			if (Client.pageData.context.metatype == "project") {
				$("#custom-question-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_project_custom_field_created:project");
			} else if (Client.pageData.context.metatype == "team") {
				$("#custom-question-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_team_custom_field_created:project");
			} else if (Client.pageData.context.metatype == "private") {
				$("#custom-question-fx .form-buttons .ok").addClass("url").attr("data-feature","wework:wework_private_custom_field_created:project");
			}
		});

		Form.pop({width: 480, label: 'ThĂªm trÆ°á»ng dá»¯ liá»‡u', layout: "flat", closable: false}).setForm(form).show().focus('name');
	};


	function questionTypes() {
		return [
			{value: "int", "label":"Sá»‘ nguyĂªn"},
			{value: "text", "label":"VÄƒn báº£n ngáº¯n"}, 
			{value: "textarea", "label":"VÄƒn báº£n Ä‘oáº¡n"}, 
			{value: "date", "label":"NgĂ y"}, 
			{value: "datetime", "label":"NgĂ y giá»"},
			{value: "checkbox", "label":"Checkbox"},
			{value: "float", "label":"Sá»‘ tháº­p phĂ¢n"},
			{value: "file", "label":"Táº­p tin"},
			{value: "select", "label":"Danh sĂ¡ch tĂ¹y chá»n (má»™t lá»±a chá»n)"},
			{value: "select-m", "label":"Danh sĂ¡ch tĂ¹y chá»n (nhiá»u lá»±a chá»n)"},
			{value: "input-table", "label":"Báº£ng"},
	   ]; 
	};
	
	
	function requiredOptions() {
		return [{value: "0", label: "No / KhĂ´ng báº¯t buá»™c"}, {value: 1, label: "Yes / Báº¯t buá»™c á»©ng viĂªn tráº£ lá»i"}];
	};
	
	function getLastOptionID() {

		var form = Client.pageData.context.form;
		var last_option_id = 0;
		if (form.length) {
			last_option_id = form[form.length-1].id;
		} 
		return last_option_id;
	};


	function getBeforeArray() {

		var before_order_array = [];
		var form = Client.pageData.context.form;

		var before = 0;
		for(var i = 0; i < form.length; i++) {
 			before_order_array[form[i].id] = before;
 			before = form[i].id;
		}

		return before_order_array;
	};


	function afterOptions() {

		var default_select = {value: 0, label: "--- First ---"};
		var form = Client.pageData.context.form;
		var order = [];

		for (var i = 0; i < form.length; i++) {
 			order.push({value: form[i].id, label: form[i].name});;
		}

		order.unshift(default_select);
		return order;
	};
};


FormBuilder.type=new function __FormBuilderType(){
	this.display=function(type){
		return "<div class='ftype -bg-alt"+UI.str2int(type)+"-less'>"+type+"</div>";
	};
	
	
	this.icon=function(type){
		
	};
	
};
var ACL=new function __ACL(){

	this.display=function(){
	};

	
	this.config=function(opts){
		
		var canvas=opts.canvas;
		var roles=opts.roles;
		var headers=opts.headers;
		var rows=opts.rows;
		var key=opts.key;
		
		
		var html="<tr class='acl-header'>" +
			"<th>PhĂ¢n quyá»n</th>" +
			AP.render(headers, function(e){
				return "<th style='width:110px'>"+e.name+"</th>";	
			}) +
		"</tr>";

		for (var i=0; i<rows.length; i++){
			var row=rows[i];
			
			html+=getHTML(row, key);
		}


		$(canvas).find("table").html(html);
		
		$(canvas).find(".js-acl-atom").click(function(){
			var $this=$(this);
			if ($this.hasClass("locked")){
				return;
			}
			
			ACL.setRole($(this).data("role"), $(this).data("priv"), $(this).data("key"), function(code){
				if (parseInt(code.status)){
					$this.addClass("-on");
				}else{
					$this.removeClass("-on");
				}
			});
		});
	};


	this.setting=function(){
		UI.setting("Giá»›i háº¡n Ä‘áº·c biá»‡t Ä‘á»‘i vá»›i ngÆ°á»i Ä‘Æ°á»£c giao viá»‡c")
	    .add({
	        title: "KhĂ´ng cho phĂ©p ngÆ°á»i Ä‘Æ°á»£c giao viá»‡c chá»‰nh sá»­a cĂ´ng viá»‡c?",
	        options: {"yes": "Yes", "no": "No"},
	        value: Client.pageData.options.block_task_edit,
	        name: "block_task_edit",
	        url: Client.pageData.context.path+"/api/settings/pref"
	    })
	    .add({
	        title: "KhĂ´ng cho phĂ©p ngÆ°á»i Ä‘Æ°á»£c giao viá»‡c chá»‰nh sá»­a deadline?",
	        options: {"yes": "Yes", "no": "No"},
	        value: Client.pageData.options.block_task_time,
	        name: "block_task_time",
	        url: Client.pageData.context.path+"/api/settings/pref"
	    })
	    .add({
	        title: "KhĂ´ng cho phĂ©p ngÆ°á»i Ä‘Æ°á»£c giao viá»‡c xĂ³a cĂ´ng viá»‡c hoáº·c chuyá»ƒn giao cho ngÆ°á»i khĂ¡c?",
	        options: {"yes": "Yes", "no": "No"},
	        value: Client.pageData.options.block_task_remove,
	        name: "block_task_remove",
	        url: Client.pageData.context.path+"/api/settings/pref"
	    })
	    .callback(function(name, value){
	     	Client.pageData.options[name]=value;
	    })
	    .showYesNo("#js-proj-settings-2");
	};
	
	
	/**
	 * @desc Check if $role has permission to do $fn
	 */
	this.on=function(role, fn){
		
	};
	
	
	this.setRole=function(role, priv, key, callback){
		var data={role: role, priv: priv, key: key};
		
		UI.ajaxShow();
		AP.xpost("api/acl/switch", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			
			UI.flash("Update successfully ...");
			if (callback){
				callback(code);
			}
		});
	};
	
	
	function getHTML(row, key){
		return "<tr class='field' data-name='"+row.key+"'>" +
			"	<td class='role'>" +
			"		<div class='role-name'>"+row.label+"</div>" +
			"		<div class='role-info'>"+row.sublabel+"</div>" +
			"	</td>" +
			getPrivs(row, key)+
			"</tr>";
	};
	
	
	function getPrivs(row, key){
		return AP.render(row.privs, function(e){
			if (parseInt(e.value)){
				return "<td><div class='status -on js-acl-atom' data-key='"+key+"' data-role='"+e.key+"' data-priv='"+row.key+"'></div></td>";
			}
			
			return "<td><div class='status -off js-acl-atom' data-key='"+key+"' data-role='"+e.key+"' data-priv='"+row.key+"'></div></td>";
		});
	};
	
	
};var Wework=new function __Wework(){
};



Wework.projects = new function __WeWorkProjects() {

	this.filter = "active";
	this.stagefilter = "all";
	this.deptfilter = "all";
	this.default_view = "table";

	this.filters = {
		"all": "Táº¥t cáº£",
		"active": "Äang thá»±c hiá»‡n",
		"running": "Äang cháº¡y",
		"closed": "ÄĂ£ Ä‘Ă³ng",
	};

	this.stagefilters = {
		"all": "Táº¥t cáº£",
		"ontrack": "ÄĂºng tiáº¿n Ä‘á»™",
		"offtrack": "Cháº­m tiáº¿n Ä‘á»™",
		"atrisk": "CĂ³ rá»§i ro cao",
	};


	this.getDeptFilter = function (value) {

		if (value == 'all') {
			return {name: 'Táº¥t cáº£ departments', id: 'all'}
		}

		if (value == 0) {
			return {name: 'ChÆ°a phĂ¢n loáº¡i', id: '0'};
		}

		var dept = Dept.fromContext(value);

		if (!dept) {
			return {name: 'Unknown', id: -1	};
		}

		return dept;
	};


	this.getDeptsFilterHTML = function () {

		var depts = AP.array.usort(Client.depts, function(e, f){
            if (e.alias < f.alias) {
             	return -1; 
         	}
		    if (e.alias > f.alias) {
		     	return 1; 
	    	}
		    return 0;
        });


		var html = AP.render(depts, function(dept) {

			return "  " +Render.render('cmenu_item', {data_label:dept.name, data_filter:dept.id}, ""+(dept.name)+"")+ '';
		});

		return html;
	};


	this.initTabs = function () {

		this.filter = "active";
		if (mobile()) {
			this.filter = "all";
		}

		this.stagefilter = "all";
		this.deptfilter = "all";

		$("#collection .header .side .icon").click(function () {
			var view = $(this).data("view");
			AP.log.setValue("projects_view", view);
			Wework.projects.display();

			$(this).siblings().removeClass("active");
			$(this).addClass("active");
		}).each(function () {
			var view = $(this).data("view");
			var cview = AP.log.getValue("projects_view");

			if (!cview) {
				cview = Wework.projects.default_view;
			}

			if (view == cview) {
				$(this).addClass("active");
			} else {
				$(this).removeClass("active");
			}
		});

		$("#js-plist-dept-filter .-cmenu .-item").click(function () {
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
			$("#js-plist-dept-filter").removeClass("active");

			Wework.projects.deptfilter = $(this).data("filter");
			Wework.projects.refilter();
		});

		$("#js-plist-filter .-cmenu .-item").click(function () {
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
			$("#js-plist-filter").removeClass("active");

			Wework.projects.filter = $(this).data("filter");
			Wework.projects.refilter();
		});

		if (mobile()) {
			$("#js-plist-filter .li").click(function () {
				$(this).addClass("active");
				$(this).siblings().removeClass("active");
				$("#js-plist-filter").removeClass("active");
	
				Wework.projects.filter = $(this).data("filter");
				Wework.projects.refilter();
			});
		}

		$("#js-plist-stage-filter .-cmenu .-item").click(function () {
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
			$("#js-plist-stage-filter").removeClass("active");

			Wework.projects.stagefilter = $(this).data("filter");
			Wework.projects.refilter();
		});

		$("#js-side-psearch").on('change input', function() {
			Wework.projects.refilter();
		});

		Wework.projects.refilter();
	};


	this.display = function (type) {

		$("#collection .projects").empty();
		$("#collection .table").empty();

		var projects = Client.pageData.projects;

		var view = AP.log.getValue("projects_view");
		if (mobile()) {
			view = "card";
		} else if (!view) {
			view = this.default_view;
		}

		if (Client.pageData.dept) {
			view = "table";
		}

		var s_1 = performance.now();
		if (view == "card") {
			for (var i = 0; i < projects.length; i++) {
				var html = getHTML(projects[i]);
				$(html).appendTo("#collection .projects");
			}

			$("#collection .projects").show();
		} else {
			$("#collection .projects").hide();
			var groups = projects;

			var html = "";
			for (var i = 0; i < groups.length; i++) {
				if (groups[i].type && groups[i].type == "category") {
					html += "<tr><td colspan='8' class='category'> <div class='name'><span class='-ap icon-triangle-right'></span>&nbsp; <span class='name'>" + groups[i].name + "</span></div></td></tr>";
				} else {
					html += getListHTML(groups[i], view);
				}
			}

			$("#collection .table").html("<table>" + getHeader(type, view) + html + "</table>");
		}

		var s_2 = performance.now();
		console.log('Render projects render html ' + ((s_2 - s_1) / 1000).toFixed(6) + ' seconds');
		this.refilter();

		$("#collection .js-complete-sektor").each(function () {
			$(this).angular({
				bg: "#e5e5e5",
				arc: false
			});
		});

		var s_3 = performance.now();
		console.log('Render projects sektor html ' + ((s_3 - s_2) / 1000).toFixed(6) + ' seconds');
		// Fixing orders
		// $("#collection tbody").sortable2({
		// 	items: ".js-project",
		// 	helper: 'clone',
		// 	axis: 'y',
		// 	handle: ".rx",
		// 	forcePlaceholderSize: true,
		// 	start: function (event, ui) {
		// 		$(ui.helper).addClass("tr-dragging");
		// 	},
		// 	over: function (event, ui) {
		// 		// Setting order	
		// 	},
		// 	stop: function (event, ui) {
		// 		var project_id = $(ui.item).data("id");
		// 		var index = $(ui.item).index();
		// 		setPosition(project_id, index);
		// 	}
		// });

		var s_4 = performance.now();
		console.log('Render projects sortable html ' + ((s_4 - s_3) / 1000).toFixed(6) + ' seconds');
	};


	this.refilter = function () {

		var status_filter = Wework.projects.filter;
		if (!status_filter) {
			status_filter = 'active';
		}

		var stage_filter = Wework.projects.stagefilter;
		if (!stage_filter) {
			stage_filter = 'all';
		}

		var dept_filter = Wework.projects.deptfilter;
		if (typeof dept_filter == 'undefined') {
			dept_filter = 'all';
		}

		var name_filter = $('#js-side-psearch').length ? $('#js-side-psearch').val() : "";

		$("#collection .js-project").each(function () {
			var project = Project.fromContext($(this).data('id'));
			if (!project) {
				return;
			}

			var name_cond = AP.word.fulltextMatch(project.name.toLowerCase(), name_filter.toLowerCase());

			var status_cond = false;
			if (project.status == 0 && status_filter == 'active') {
				status_cond = true;
			}

			if (project.status == 0 && status_filter == 'running') {
				status_cond = true;
			}

			if (project.status == -1 && status_filter == 'closed') {
				status_cond = true;
			}

			if (status_filter == "all") {
				status_cond = true;
			}

			var dept_cond = false;
			if (dept_filter == 'all' || dept_filter == project.dept_id) {
				dept_cond = true;
			}

			var stage_cond = false;
			if (stage_filter == "all" || project.stage.indexOf(stage_filter) !== -1) {
				stage_cond = true;
			}

			if (name_cond && status_cond && stage_cond && dept_cond) {
				$(this).show();
			} else {
				$(this).hide();
			}
		});

		if (status_filter == "all") {
			$('#plist-filter-name').html("Tráº¡ng thĂ¡i: Táº¥t cáº£");
		} else {
			$('#plist-filter-name').attr('title', Wework.projects.filters[status_filter]);
			$('#plist-filter-name').html("Tráº¡ng thĂ¡i: "+(Wework.projects.filters[status_filter])+"");
		}

		if (stage_filter == "all") {
			$('#plist-stage-filter-name').html("Giai Ä‘oáº¡n: Táº¥t cáº£");
		} else {
			$('#plist-stage-filter-name').html("Giai Ä‘oáº¡n: "+(Wework.projects.stagefilters[stage_filter])+"");
		}

		if (dept_filter == "all") {
			$('#plist-dept-filter-name').attr('title', 'Táº¥t cáº£ departments');
			$('#plist-dept-filter-name').html("Department: Táº¥t cáº£");
		} else {
			$('#plist-dept-filter-name').attr('title', Wework.projects.getDeptFilter(dept_filter).name)
			$('#plist-dept-filter-name').html("Department: "+(Wework.projects.getDeptFilter(dept_filter).name)+"");
		}
	};


	this.quickFilter = function () {
		var delay_timer = 0;
		$("#js-side-psearch").on("input", function () {
			var $this = $(this);
			clearTimeout(delay_timer);

			delay_timer = setTimeout(function () {
				var q = $this.val();
				executeFilter(q);
			}, 300);
		});
	};


	function executeFilter(q) {
		if (!q) {
			q = "";
		}

		q = $.trim(q).toLowerCase();
		q = purifyStrict(q);
		$.log(q);

		$("#list-project .ui-sortable .js-project").each(function() {
			if (!q) {
				if ($(this).hasClass("search_hidden")) {
					$(this).removeClass('search_hidden');
				}

			} else {
				if (matched(this, q)) {
					$(this).removeClass("search_hidden");
				} else {
					$(this).addClass("search_hidden");
				}
			}
		});
	};


	function matched(elem, q) {
		var keywords = purifyStrict($(elem).text());
		return keywords.indexOf(q) != -1;
	};


	function getEnablePriority() {

		var enable_priority = 1;
		if (typeof Client.pageData.disable_priority != "undefined") {
			if (parseInt(Client.pageData.disable_priority)) {
				enable_priority = 0;
			}
		}

		return enable_priority;
	};


	function getHeader(type) {

		var name = 'Dá»± Ă¡n &amp; phĂ²ng ban';

		var header_priority = getEnablePriority() ? "<th style='width:30px'>&nbsp;</th>" : '';

		return "<thead><tr class='theader'> <th style='width:30px; min-width:30px;'>&nbsp;</th> <th><div class='lead' style='margin-left:-20px'>"+(name)+"</div></th> <th style='width:130px'>Department</th> <th style='width:120px'>ThĂ nh viĂªn</th> <th style='width:145px'>Thá»‘ng kĂª</th> <th style='width:80px'>Tráº¡ng thĂ¡i</th> <th style='width:120px'>&nbsp;</th> "+(header_priority)+" <th style='width:80px; min-width:80px'>&nbsp;</th> </tr></thead>";
	};


	function getListHTML(system) {

		var content = "ChÆ°a cĂ³ miĂªu táº£";
		if (system.content && system.content.length) {
			content = system.content;
		}

		var enable_priority = getEnablePriority();

		if (enable_priority) {
			var priority = "off";
			var priority_title = "No priority";
			var is_priority = AP.array.contain(Client.pageData.stack.priority, system.id);
			var is_stack = AP.array.contain(Client.pageData.stack.stack, system.id);
			if (is_priority) {
				priority = "on";
				priority_title = "Æ¯u tiĂªn";
			}
		}

		var stats = system.stats;
		system.complete = stats.complete;

		var d = Math.floor((parseInt(system.etime) - AP.time.now()) / (24 * 3600));
		var days_left = "<span class='count'>CĂ²n <b>" + d + "</b> ngĂ y</span>";
		if (d < 0) {
			days_left = "<span class='count'>ÄĂ£ qua deadline</span>";
		}

		var percent = 0;
		if (parseInt(stats.total)) {
			percent = (parseInt(stats.complete) * 100.0 / stats.total).toFixed(1);
		}

		var color = UI.color.percent(percent);

		if (system.metatype == 'project' && parseInt(system.stime) && parseInt(system.etime)) {
			system.percent = percent;
			color = UI.color.progress(system);
		}

		var cat = " ";
		if (system.category) {
			cat = system.category;
		}

		var cat_html = "";

		content = safe(system.content);
		if (!content || !content.length) {
			content = "ChÆ°a cĂ³ miĂªu táº£";
		}

		var edit_button = "<div class='-item url' data-url='"+(system.path)+"'>Xem chi tiáº¿t</div> <div class='-item url' data-url='"+(system.path)+"' data-blank='1'>Má»Ÿ trong tab má»›i</div>";

		if (enable_priority) {
			if (is_priority) {
				edit_button += "<div class='-item-sep'></div> <div class='-item url' data-url='paction/"+(system.id)+"/removepriority'>Bá» chá»n Æ°u tiĂªn</div>";
			} else if (is_stack) {
				edit_button += "<div class='-item-sep'></div> <div class='-item url' data-url='paction/"+(system.id)+"/addpriority'>ThĂªm Æ°u tiĂªn</div>";
			}
		}

		if (parseInt(system.acl.managed) || Me.isSystemOwner()) {
			edit_button += "<div class='-item-sep'></div> <div class='-item url' data-url='paction/"+(system.id)+"/edit'>Chá»‰nh sá»­a nhanh</div> <div class='-item url' data-url='paction/"+(system.id)+"/status'>Cáº­p nháº­t tráº¡ng thĂ¡i</div> <div class='-item url' data-url='paction/"+(system.id)+"/metatype'>Chuyá»ƒn loáº¡i "+(system.metatype)+"</div> <div class='-item url' data-url='"+(system.path)+"/settings'>Quáº£n lĂ½</div>";
		}

		var dept = Dept.fromContext(system.dept_id);
		if (dept) {
			dept_html = "<div class='dept'><span class='a normal std url' data-url='dept/"+(dept.id)+"' title='"+(dept.name)+"'>"+(dept.name)+"</span></div>";
		} else {
			dept_html = "<div class='dept -none text-8'>ChÆ°a cĂ³ department</div>";
		}

		var old_cat = '';
		if (system.category) {
			old_cat = "Old category: <em class='text-3'>"+(system.category)+"</em> &middot; ";
		}

		var reorder = "<div class='rx' title='Move team and project up or down'></div>";
		if (typeof Client.pageData.no_sortable != "undefined") {
			if (parseInt(Client.pageData.no_sortable) == 1) {
				reorder = '';
			}
		}

		var priority_html = '';
		if (enable_priority) {
			priority_html = "<td><div class='priority -"+(priority)+"' title='"+(priority_title)+"'></div></td>";
		}

		return "<tr class='li item-"+(system.id)+" js-project' data-id='"+(system.id)+"' data-stage='"+(system.stage)+"' data-status='"+(system.status)+"' title='"+(content)+"'> <td> "+(reorder)+" </td> <td> <div class='icon' title='HoĂ n thĂ nh: "+(percent)+"%'> <div id='js-status-"+(system.id)+"' class='js-complete-sektor' style='width:20px; height:20px' data-color='"+(Color.get(system.color))+"' data-bg='rgba(0,0,0,0.13)' data-arc='1' data-percent='"+(percent)+"'></div> </div> <div class='title url' title='"+(system.name)+"' data-url='"+(system.path)+"'>"+(system.name)+"</div> <div class='info relative' style='height:13px;'> <div class='absolute ap-xdot' style='width:100%'>"+(old_cat)+""+(content)+" &middot; Cáº­p nháº­t "+(AP.time.ago(system.last_update))+"</div> </div> </td> <td> <div class='relative'><div class='absolute ap-xdot' style='width:100%'>"+(dept_html)+"</div></div> </td> <td><div class='users clear-fix'>"+(getTeams(system, 24))+"</div></td> <td> <div class='bar'> <div class='stats'> <span class='left ap-xdot' title='HoĂ n thĂ nh'><b>"+(stats.complete)+"</b>/<b>"+(stats.total)+"</b> HoĂ n thĂ nh</span> <span class='right ap-xdot' title='QuĂ¡ háº¡n'><b>"+(stats.overdue)+"</b> QuĂ¡ háº¡n</span> </div> <div class='complete' style='width:"+(percent)+"%; background-color:"+(color)+"'></div> </div> </td> <td><div class='status -"+(system.status)+"'>"+(getStatus(system.status))+"</div></td> <td><div class='status -"+(system.stage)+"'>"+(getStage(system.stage))+"</div></td> "+(priority_html)+" <td> <div class='edit-dd -cmenuw'>Option <span class='-ap icon-triangle-down'></span> <div class='-cmenu -no-icon -padding w200'>"+(edit_button)+"</div> </div> </td> </tr>";
	};


	function getHTML(system) {
		var content = "";

		if (system.content && system.content.length) {
			content = " &middot; " + safe(system.content);
		}

		var stats = system.stats;
		system.complete = stats.complete;
		var color = UI.color.progress(system);

		var d = Math.floor((parseInt(system.etime) - AP.time.now()) / (24 * 3600));
		var days_left = "<span class='count'>CĂ²n <b>" + d + "</b> ngĂ y</span>";
		if (d < 0) {
			days_left = "<span class='count'>ÄĂ£ qua deadline</span>";
		}

		var percent = 0;
		if (parseInt(stats.total)) {
			percent = (parseInt(stats.complete) * 100.0 / stats.total).toFixed(1);
		}

		var color = UI.color.percent(percent);

		if (parseInt(system.stime) && parseInt(system.etime)) {
			color = UI.color.progress(percent, system.stime, system.etime);
		}

		if (mobile) {
			return "<div class='item item-"+(system.id)+" js-project' data-stage='"+(system.stage)+"' data-status='"+(system.status)+"' data-id='"+(system.id)+"'> <div class='w'> <div class='istats'>"+(stats.complete)+"/"+(stats.total)+"</div> <div class='title url ap-xdot' title='"+(system.name)+"' data-url='"+(system.path)+"'>"+(system.name)+"</div> <div class='info'>Táº¡o ngĂ y "+(AP.i18n.date(system.since))+" &middot; Cáº­p nháº­t "+(AP.time.ago(system.last_update))+""+(content)+"</div> <div class='users clear-fix'>"+(getTeams(system))+"</div> <div class='bar'> <div class='stats'> <b>"+(stats.complete)+"</b>/<b>"+(stats.total)+"</b> HoĂ n thĂ nh <span class='right'><b>"+(stats.overdue)+"</b> QuĂ¡ háº¡n</span> </div> <div class='complete' style='width:"+(percent)+"%; background-color:"+(color)+"'></div> </div> </div> </div>";

		} else {
			return "<div class='item item-"+(system.id)+" js-project' data-stage='"+(system.stage)+"' data-status='"+(system.status)+"'> <div class='w'> <div class='title url ap-xdot' title='"+(system.name)+"' data-url='"+(system.path)+"'>"+(system.name)+"</div> <div class='info ap-xdot'>"+(safe(content))+"</div> <div class='users clear-fix'>"+(getTeams(system))+"</div> <div class='bar'> <div class='stats'> <b>"+(stats.complete)+"</b>/<b>"+(stats.total)+"</b> HoĂ n thĂ nh <span class='right'><b>"+(stats.overdue)+"</b> QuĂ¡ háº¡n</span> </div> <div class='complete' style='width:"+(percent)+"%; background-color:"+(color)+"'></div> </div> <div class='footer'>Táº¡o ngĂ y "+(AP.i18n.date(system.since))+" &middot; Cáº­p nháº­t "+(AP.time.ago(system.last_update))+"</div> </div> </div>";
		}
	};


	function getTeams(system, size) {
		if (!size) {
			size = 32;
		}
		var total = system.followers.length;
		var html = "";
		var counter = 0;

		for (i = 0; i < system.followers.length; i++) {
			var u = People.get(system.followers[i].username);
			if (!u || !parseInt(u.uid)) {
				continue;
			}

			counter++;
			if (counter < 5) {
				html += "<div class='avatar avatar-" + size + " -circled url' data-username='" + system.followers[i].username + "'>" +
					"<div class='image'><img src='" + AP.xthumb(u.gavatar) + "'/></div>" +
					"</div>";
			}
		}

		if (counter < 5) {
			return html;
		}

		return html + "<div class='avatar avatar-" + size + " -circled -infow'>" +
			"<span class='-infobox -up -w200'><span class='-box block normal'>" + (total - 4) + " ngÆ°á»i khĂ¡c</span></span>" +
			"<div class='more'><span>" + (total - 4) + "</span></div>" +
			"</div>";

	};


	function getStatus(status) {
		if (parseInt(status) == 0) {
			return "<div class='stage -bg-success'>Äang thá»±c hiá»‡n</div>";
		} else {
			return "<div class='stage -bg-error'>ÄĂ£ Ä‘Ă³ng</div>";
		}
	};


	function getStage(stage) {
		return "<div class='stage -edge' style='background-color:"+(Color.rgba(Project.status.color(stage), 0.1))+"; color:"+(Color.adjust(Project.status.color(stage), 10, 20))+"'>"+(Project.status.getShortLabel(stage))+"</div>";
	};
};


Wework.people=new function __WeWorkPeople(){
	this.filter="all";
	this.type="project";	

	this.initTabs=function(){
		$("#collection .header .side .icon").click(function(){
			var view=$(this).data("view");
			AP.log.setAppCookie("people_view", view);
			Wework.projects.display();
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
		}).each(function(){
			var view=$(this).data("view");
			var cview=AP.log.getAppCookie("people_view");
			if (!cview){
				cview="list";
			}

			if (view==cview){
				$(this).addClass("active");
			}else{
				$(this).removeClass("active");
			}
		});
	};


	this.init = function(type){
		$("#js-side-member-search").quickFilter("#collection .js-person", function($elem, q){
			q=purify(q);
			var kw=$elem.data("member");
			if (kw) {
				return kw.toLowerCase().indexOf(q)!=-1;
			}
		});
		
		this.initTabs();
		
		if (!type){
			type=this.type;
		}
		
		if (!type){
			type="project";
		}
		
		this.type=type;
		this.render();
	};
	
	
	this.menu=function(){
		return;
		
		var people=Client.people.slice(0);
		people.sort(function(e, f){
			return porder(f)-porder(e);
		});
		
		$("#js-cmembers").html(AP.render(people, function(e){
			if (parseInt(e.id) == parseInt(Client.viewer.id)){
				return "";
			}
			if (porder(e)>=8){
				return getMenuItem(e);
			}
			
			return "";
		}));
		
		
		$("#js-other-members").html(AP.render(people, function(e){
			if (porder(e)<8 && porder(e)>=3){
				return getMenuItem(e);
			}
			
			return "";
		}));
		
		
		$("#js-guests").html(AP.render(people, function(e){
			if (porder(e)<=1){
				return getMenuItem(e);
			}
			
			return "";
		}));
		
		$("#myside .item").setActiveURL();
		
		$("#js-ufilters").quickFilter("#myside .item", function($elem, q){
			var kw=$elem.data("keywords");
			q=purify(q);
			return kw.toLowerCase().indexOf(q)!=-1;
		});
	}; 
	
	
	this.initTabs=function(){
		this.filter="all";
		
		$("#header .itabs .tab").click(function(){
			var view=$(this).data("view");
			AP.log.setAppCookie("people_view", view);
			Wework.people.render();
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
		}).each(function(){
			var view=$(this).data("view");
			var cview=AP.log.getAppCookie("people_view");
			if (!cview){
				cview="card";
			}
			
			if (view==cview){
				$(this).addClass("active");
			}else{
				$(this).removeClass("active");
			}
		});
		
		$("#collection .header .filter .li").click(function(){
			var filter=$(this).data("filter");
			$(this).addClass("active");
			$(this).siblings().removeClass("active");
			
			Wework.people.filter=filter;
			Wework.people.refilter();
		});
		
	};
	

	
	this.render=function(){
		$("#collection .projects").empty();
		$("#collection .table").empty();
		
		var people=Client.people;
		people.sort(function(e, f){
			return porder(f)-porder(e);
		});
		
		var view=AP.log.getAppCookie("people_view");
		
		if (view=="card"){
			var has_guest=false;
			for (var i = 0; i< people.length; i++){
				if (people[i].metatype=="guest" && !has_guest){
					has_guest=true;
					$("<div class='gsep' id='js-guests'>TĂ i khoáº£n khĂ¡ch</div>").appendTo("#collection .projects");
				}
				
				var html = getCardHTML(people[i]);
				$(html).appendTo("#collection .projects");
			}
		}else{
			var html="";
			var has_guest=false;
			for (var i = 0; i< people.length; i++){
				if (people[i].metatype=="guest" && !has_guest){
					has_guest=true;
					html+="<tr><td colspan='5' class='gsep' id='js-guests'>TĂ i khoáº£n khĂ¡ch</td></tr>";
				}
				html += getListHTML(people[i]);
			}
			
			$("#collection .table").html("<table>"+getHeader() + html+"</table>");
		}
		
		this.refilter();
	};
	
	
	this.refilter=function(){
		$("#collection .js-person").each(function(){
			var stage=$(this).data("stage");
			if (stage==Wework.projects.filter || Wework.projects.filter =="active"){
				$(this).show();
			}else{
				$(this).hide();
			}
		});
	};
	
	
	function getHeader(){
		return "<tr class='theader'>" +
			"<th style='width:5px'>&nbsp;</th>" +
			"<th><div class='lead' style='margin-left:-20px'>Há» vĂ  tĂªn</div></th>" +
			"<th style='width:20%'>LiĂªn há»‡</th>" +
			"<th style='width:20%'>NgÆ°á»i quáº£n lĂ½</th>" +
			"<th style='width:150px'>&nbsp;</th>" +
		"</tr>";
	};
	
	
	function getListHTML(user){
		var content="ChÆ°a cĂ³ miĂªu táº£";
		
		if (user.content && user.content.length){
			content=user.content;
		}
		
		var stats={};
		user.complete=stats.complete;
		
		var d=Math.floor((parseInt(user.etime) - AP.time.now())/(24*3600));
		var days_left="<span class='count'>CĂ²n <b>"+d+"</b> ngĂ y</span>";
		if (d<0){
			days_left="<span class='count'>ÄĂ£ qua deadline</span>";
		}
		
		var percent=0;
		if (parseInt(stats.total)){
			percent=(parseInt(stats.complete)*100.0/stats.total).toFixed(1);
		}
		
		var color=UI.color.percent(percent);
		
		
		if (user.metatype=='project' && parseInt(user.stime) && parseInt(user.etime)){
			user.percent=percent;
			color=UI.color.progress(user);
		}
		
		var stage=user.stage;
		if (!stage){
			stage="Running";
		}
		
		var color="alt0";
		if (Online.isOnline(user.username)){
			color="success";
		}
		
		var manager="";
		if (!user.manager || !user.manager.length){
			manager="";
		}else{
			var us=People.getList(user.manager);
			manager=AP.render(us, function(e){
				return "<div class='avatar avatar-32 -circled url' data-username='"+e.username+"'><div class='image'><img src='"+AP.xthumb(e.gavatar)+"'/></div></div>";
			});
		}
		
		return "<tr class='li item-"+user.id+" js-person' data-keyword='"+user.keywords+"'>" +
			"<td></td>" +
			"<td>" +
			"	<div class='user'>" +
			"		<div class='avatar avatar-32 -circled "+(Online.isOnline(user.username)?" -online":"")+"'><div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div>" +
			"		<div class='title url ap-xdot' title='"+user.name+"' data-url='user/"+user.username+"'>"+user.name+"</div>" +
			"		<div class='info ap-xdot'>"+user.title+"</div>" +
			"	</div>" +
			"</td>" +
			"<td>" +
			"	<div class='relative'><div class='absolute ap-xdot' style='width:100%'>"+safe(user.email)+"</div></div>" +
			"</td>" +
			"<td>" +
			"	<div class='users clear-fix'>"+manager+"</div>" +
			"</td>" +
			"<td>" +
			"	<div class='buttons -two clear-fix -std'>" +
			"		<div class='button url' data-url='user/"+user.username+"'>&#9655; Chi tiáº¿t</div>" +
			"		<div class='button' onclick=\"Base.message.peer('"+user.username+"')\">Nháº¯n tin</div>" +
			"	</div>" +
			"</td>" +
		"</tr>";
	};
	
	
	
	
	function getCardHTML(user){
		var stats={};
		user.complete=stats.complete;
		var color=UI.color.progress(user);
		
		var d=Math.floor((parseInt(user.etime) - AP.time.now())/(24*3600));
		var days_left="<span class='count'>CĂ²n <b>"+d+"</b> ngĂ y</span>";
		if (d<0){
			days_left="<span class='count'>ÄĂ£ qua deadline</span>";
		}
		
		var percent=0;
		if (parseInt(stats.total)){
			percent=(parseInt(stats.complete)*100.0/stats.total).toFixed(1);
		}
		
		var color=UI.color.percent(percent);
		
		if (parseInt(user.stime) && parseInt(user.etime)){
			color=UI.color.progress(percent, user.stime, user.etime);
		}
		
		return "<div class='item item-"+user.id+" js-person'><div class='w'>" +
			"<div class='title url ap-xdot' title='"+user.name+"' data-url='user/"+user.username+"'>"+user.name+"</div>" +
			"<div class='avatar avatar-40 -circled'><div class='image'><img src='"+AP.xthumb(user.gavatar)+"'/></div></div>" +
			"<div class='info ap-xdot'>"+user.title+"</div>" +
			"<div class='info ap-xdot'>"+user.email+"</div>" +
			"<div class='footer'>Tham gia tá»« "+AP.i18n.date(user.since)+" &middot; <span class='url' data-username='"+user.username+"' data-intent='chat'>Nháº¯n tin</span></div>" +
		"</div></div>";
	};
	
	
	function getTeams(system, size){
		if (!size){
			size=32;
		}
		return AP.render(system.followers, function(e){
			var u=People.get(e.username);
				return "<div class='avatar avatar-"+size+" -circled url' data-username='"+u.username+"'>" +
					"<div class='image'><img src='"+AP.xthumb(u.gavatar)+"'/></div>"+
				"</div>";
		});
	};
	
	
	function porder(e){
		if (e.username==Client.viewer.username){
			return 10;
		}
		
		if (Me.isManagerOf(e)){
			return 9;
		}
		
		if (Me.isManagedBy(e)){
			return 8;
		}
		
		if (Me.shareManager(e)){
			return 7;
		}
		
		if (e.metatype=="guest"){
			return 1;
		}
		
		return 3;
	};
	
	
	
	function getMenuItem(e){
		return "<div class='item url' data-url='user/"+e.username+"' data-keywords='"+e.keywords+"'>" +
			"<div class='name'>"+e.name+"</div>" +
			"<div class='avatar'><img src='"+AP.xthumb(e.gavatar)+"'></div>" +
		"</div>";
	};
	
};


Wework.user = new function __WeWorkUser(){
	
	this.delegate = function(){
		var user = Client.viewer;
		
		var form = Form.create('edit-profile-fx',{'action':'api/wework/user/delegate'})
		.row(
			Form.label({label: "á»¦y quyá»n cho",sublabel: ""}),
			Form.input({name: 'delegatees', "placeholder":"GĂµ @ Ä‘á»ƒ tag", role:"tag"}).value(UI.objectsToUsernames(Client.pageData.delegatees))
		)
		.buttons([
			{label: "LÆ°u", action: function(){
				Form.submit("edit-profile-fx", function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
				
					Form.hide("edit-profile-fx");
					AP.alertSuccess(code.message, function(){
						AP.refresh();
					});
				});
			}, style: 'ok -success -rounded bold'},
			{label: "Há»§y", action: function(){
				Form.hide("edit-profile-fx");
			}, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id:'edit-fx-dx', width: 450, label: 'á»¦y quyá»n giao viá»‡c'}).setForm(form).show();
	};
	
};


Wework.video=new function __WeworkVideo(){
	this.display=function(){
		var html="";
		for (var i=0; i<Client.pageData.videos.length; i++){
			html+=getTab(Client.pageData.videos[i], i);
		}
		
		$("#video-side .tabs").html(html);
		
		$("#video-side .tabs .tab").click(function(){
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			renderVideo($(this).data("url"), true);
		});
		
		
		// Init the first video
		$("#video-side .tabs .tab").setActive(0);
		renderVideo($("#video-side .tabs .tab:eq(0)").data("url"));
		
		AP.html.resize(function(){
			if (!$("#js-yt-iframe").length){
				return;
			}
			
			var w=$("#js-video").width();
			var h=Math.floor(w*600/1060);
			$("#js-yt-iframe").attr("width", w).attr("height", h);
		});
		
	};
	
	
	
	function getTab(video, index){
		return "<div class='tab' data-index='"+index+"' data-url='"+video.url+"'>" +
			"<div class='icon'><span class='-ap icon-play2'></span></div>" +
			"<div class='link'>"+video.name+"</div>" +
			"<div class='info'>"+video.length+"s</div>" +
		"</div>";
	};
	
	
	function renderVideo(url, autoplay){
		var real_url=url;
		if (autoplay){
			real_url=url+"?autoplay=1";
		}
		
		var w=$("#js-video").width();
		var h=Math.floor(w*600/1060);
		var html='<iframe id="js-yt-iframe" width="'+w+'" height="'+h+'" src="'+real_url+'" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>';
		$("#js-video").html(html);
	};
	
};


Wework.system = new function __WeworkSystem() {

	this.init = function() {
		initRange();
		initUsers();
		initTable();
	}


	this.export = function() {

		AP.confirm("Xuáº¥t bĂ¡o cĂ¡o excel cá»§a há»‡ thá»‘ng?", function () {

			var headers = [
				"ThĂ nh viĂªn",
				"Email",
				"Sá»‘ dá»± Ă¡n", 
				"Sá»‘ phĂ²ng ban", 
				"CĂ´ng viá»‡c Ä‘Æ°á»£c giao", 
				"CĂ´ng viá»‡c Ä‘Ă£ táº¡o", 
				"CĂ´ng viá»‡c con Ä‘Æ°á»£c giao", 
				"CĂ´ng viá»‡c con Ä‘Ă£ táº¡o", 
				"HoĂ n thĂ nh", 
				"Äang lĂ m", 
				"Äang Ä‘Ă¡nh giĂ¡", 
				"HoĂ n thĂ nh muá»™n", 
				"QuĂ¡ háº¡n"
			];

			var rows = [];

			var users = checkSub(Client.people);
			users = getDataInit(users);
			users = getDataUserProject(users, Client.pageData.projects);
			users = getDataUserTask(users, Client.pageData.tasks);

			for (i = 0; i < users.length; i++) {

				var computed_data = users[i].computed_data;

				var user_data = [
					users[i].name,
					users[i].email,
					computed_data.total_projects,
					computed_data.total_teams,
					computed_data.total_tasks,
					computed_data.total_created_tasks,
					computed_data.total_subtasks,
					computed_data.total_created_subtasks,
					computed_data.total_done,
					computed_data.total_active,
					computed_data.total_review,
					computed_data.total_done_late,
					computed_data.total_overdue
				];

				rows.push(user_data);
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: "System reports"
			});
		});
	}


	function initRange() {
		$("#js-header-startdate").dateRangePicker({

			getValue: function() {
				return this.innerHTML;
			},
			setValue: function(s, from, to, from_ts, to_ts, click) {

			},
			onSelect: function(from, to) {
				AP.setURLParams({
					start: encodeURIComponent(AP.time.time("%d-%m-%Y", from)),
					end: encodeURIComponent(AP.time.time("%d-%m-%Y",to)),
				}, true);

				$(this).data('dateRangePicker').close();
			}
		}).find(".js-range").html("<em>"+AP.i18n.date(Client.pageData.params.start)+"</em> â€º <em>"+AP.i18n.date(Client.pageData.params.end)+"</em>");

		$("#js-header-startdate").data("dateRangePicker").setStart(Client.pageData.params.start_str).setEnd(Client.pageData.params.end_str);
	};


	function initUsers() {

		var users = checkSub(Client.people);
		$("#total_users").html(users.length);

		users = getDataInit(users);
		users = getDataUserProject(users, Client.pageData.projects);
		users = getDataUserTask(users, Client.pageData.tasks);
		// users = filterDataUserInactive(users);

		$("#js-assigners-task").html(AP.render(users, function(e) {
			return getHTML(e);
		}));
	};


	function initTable() {
		BaseTable.init("#js-report-table", {
			height: function() {
				return $(window).height() - 205;
			},
			width: "auto",
			sorter: true
		});
	};


	function getHTML(user) {

		var pc = 0, pl = 0, po = 0;
		var total_all_tasks = user.computed_data.total_tasks + user.computed_data.total_subtasks;
		if (parseInt(total_all_tasks)) {
			pc = (user.computed_data.total_done * 100.0 / total_all_tasks).toFixed(2);
			pl = (user.computed_data.total_done_late * 100.0 / total_all_tasks).toFixed(2);
			po = (user.computed_data.total_overdue * 100.0 / total_all_tasks).toFixed(2);
		}

		return "<tr class='js-user'> <td class='-fl'> <div class='user url' data-url='user/"+(user.username)+"'> <div class='avatar avatar-32 -circled'><div class='image'><img src='"+(AP.xthumb(user.gavatar))+"'/></div></div> <div class='name'>"+(user.name)+"</div> <div class='info'>"+(user.title)+"&nbsp;</div> </div> </td> <td><b class='bc'>"+(user.computed_data.total_projects)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_teams)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_tasks)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_created_tasks)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_subtasks)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_created_subtasks)+"</b></td> <td><b class='bc text-success'>"+(user.computed_data.total_done)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_active)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_review)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_done_late)+"</b></td> <td><b class='bc'>"+(user.computed_data.total_overdue)+"</b></td> <td class='-fr'> <div class='bar'> <div class='b -bg-success' style='width:"+(pc)+"%'></div> <div class='b -bg-alt6' style='width:"+(pl)+"%'></div> <div class='b -bg-error' style='width:"+(po)+"%'></div> </div> </td> </tr>";
	};


	function getDataInit(users) {

		for (i = 0; i < users.length; i++) {
			users[i].computed_data = {
				total_projects: 0, 
				total_teams: 0,
				total_tasks: 0,
				total_created_tasks: 0,
				total_subtasks: 0,
				total_created_subtasks: 0,
				total_done: 0,
				total_active: 0,
				total_review: 0,
				total_done_late: 0,
				total_overdue: 0
			};
		}

		return users;
	};


	function getDataUserProject(users, projects) {

		var total_projects = 0;
		var total_teams = 0;
		var total_running_projects = 0;
		var total_closed_projects = 0;

		var array_user_projects = [];
		var array_project_ids = [];

		for (i = 0; i < projects.length; i++) {

			if (projects[i].metatype == "team") {
				total_teams++;
			}

			if (projects[i].metatype == "project") {

				total_projects++;

				if (parseInt(projects[i].status) == -1) {
					total_closed_projects++;
				} else {
					total_running_projects++;
				}
			}

			array_project_ids[projects[i].id] = projects[i];

			var followers = projects[i].followers;
			for (j = 0; j < followers.length; j++) {
				if (typeof array_user_projects[followers[j]] == "undefined") {
					array_user_projects[followers[j]] = [];
				}
				array_user_projects[followers[j]].push(projects[i].id);
			}
		}

		$("#total_projects").html(total_projects);
		$("#total_teams").html(total_teams);
		$("#total_running_projects").html(total_running_projects);
		$("#total_closed_projects").html(total_closed_projects);

		for (i = 0; i < users.length; i++) {

			if (typeof array_user_projects[users[i].username] != "undefined") {

				if (array_user_projects[users[i].username].length) {

					var array_user_project_ids = array_user_projects[users[i].username];

					for (j = 0; j < array_user_project_ids.length; j++) {
						if (typeof array_project_ids[array_user_project_ids[j]] != "undefined") {

							var project = array_project_ids[array_user_project_ids[j]];

							if (typeof users[i].computed_data != "undefined") {
								if (project.metatype == "project") {
									users[i].computed_data.total_projects++;
								} else if (project.metatype == "team") {
									users[i].computed_data.total_teams++;
								}
							}
						}
					}
				}
			}
		}

		return users;
	};


	function getDataUserTask(users, tasks) {

		var now = AP.time.now();

		var total_tasks = 0;
		var total_created_tasks = 0;
		var total_subtasks = 0;
		var total_created_subtasks = 0;

		var array_assigner_tasks = [];
		var array_assignee_tasks = [];

		for (i = 0; i < tasks.length; i++) {

			if (tasks[i].username) {
				if (typeof array_assignee_tasks[tasks[i].username] == "undefined") {
					array_assignee_tasks[tasks[i].username] = [];
				}

				array_assignee_tasks[tasks[i].username].push(tasks[i]);
			}

			if (tasks[i].creator_username) {
				if (typeof array_assigner_tasks[tasks[i].creator_username] == "undefined") {
					array_assigner_tasks[tasks[i].creator_username] = [];
				}

				array_assigner_tasks[tasks[i].creator_username].push(tasks[i]);
			}
		}

		for (i = 0; i < users.length; i++) {

			if (typeof array_assignee_tasks[users[i].username] != "undefined") {

				var array_user_assignee_tasks = array_assignee_tasks[users[i].username];

				for (j = 0; j < array_user_assignee_tasks.length; j++) {

					var task = array_user_assignee_tasks[j];

					if (task.metatype == "task") {
						total_tasks++;
						users[i].computed_data.total_tasks++;
					}

					if (task.metatype == "subtask") {
						total_subtasks++;
						users[i].computed_data.total_subtasks++;
					}

					if (task.status == 1) {
						users[i].computed_data.total_done++;
					}

					if (task.status == 0 && task.review == 0) {
						users[i].computed_data.total_active++;
					}

					if (task.status == 0 && task.review == 1) {
						users[i].computed_data.total_review++;
					}

					if (parseInt(task.deadline)) {
						if (task.status == 0 && now > parseInt(task.deadline)) {
							users[i].computed_data.total_overdue++;
						}
					}

					if (Compute.doneLate(task)) {
						users[i].computed_data.total_done_late++;
					}
				}
			}

			if (typeof array_assigner_tasks[users[i].username] != "undefined") {

				var array_user_assigner_tasks = array_assigner_tasks[users[i].username];

				for (j = 0; j < array_user_assigner_tasks.length; j++) {

					var task = array_user_assigner_tasks[j];

					if (task.metatype == "task") {
						total_created_tasks++;
						users[i].computed_data.total_created_tasks++;
					}

					if (task.metatype == "subtask") {
						total_created_subtasks++;
						users[i].computed_data.total_created_subtasks++;
					}
				}
			}
		}
		
		$("#total_tasks").html(total_tasks);
		$("#total_created_tasks").html(total_created_tasks);
		$("#total_subtasks").html(total_subtasks);
		$("#total_created_subtasks").html(total_created_subtasks);

		return users;
	};


	function checkSub(users) {

		var system_subs = Client.pageData.system_subs;
		var sub_users = [];

		var wework_sub = AP.array.find(system_subs, function(e) {
			return e.app == "wework";
		});

		if (wework_sub) {
			if (typeof wework_sub.limit != "undefined") {
				if (parseInt(wework_sub.limit)) {
					if (typeof wework_sub.users != "undefined") {
						sub_users = wework_sub.users;
					}
				}
			}
		}

		if (typeof sub_users != "undefined") {
			if (sub_users.length) {
				users = AP.array.filter(users, function(e) {
					if (AP.array.contain(sub_users, e.username)) {
						return true;
					}
					return false;
				});
			}
		}

		return users;
	};
};



(function($){$.extend({tablesorter:new
function(){var parsers=[],widgets=[];this.defaults={cssHeader:"header",cssAsc:"headerSortUp",cssDesc:"headerSortDown",cssChildRow:"expand-child",sortInitialOrder:"asc",sortMultiSortKey:"shiftKey",sortForce:null,sortAppend:null,sortLocaleCompare:true,textExtraction:"simple",parsers:{},widgets:[],widgetZebra:{css:["even","odd"]},headers:{},widthFixed:false,cancelSelection:true,sortList:[],headerList:[],dateFormat:"us",decimal:'/\.|\,/g',onRenderHeader:null,selectorHeaders:'thead th',debug:false};function benchmark(s,d){log(s+","+(new Date().getTime()-d.getTime())+"ms");}this.benchmark=benchmark;function log(s){if(typeof console!="undefined"&&typeof console.debug!="undefined"){console.log(s);}else{alert(s);}}function buildParserCache(table,$headers){if(table.config.debug){var parsersDebug="";}if(table.tBodies.length==0)return;var rows=table.tBodies[0].rows;if(rows[0]){var list=[],cells=rows[0].cells,l=cells.length;for(var i=0;i<l;i++){var p=false;if($.metadata&&($($headers[i]).metadata()&&$($headers[i]).metadata().sorter)){p=getParserById($($headers[i]).metadata().sorter);}else if((table.config.headers[i]&&table.config.headers[i].sorter)){p=getParserById(table.config.headers[i].sorter);}if(!p){p=detectParserForColumn(table,rows,-1,i);}if(table.config.debug){parsersDebug+="column:"+i+" parser:"+p.id+"\n";}list.push(p);}}if(table.config.debug){log(parsersDebug);}return list;};function detectParserForColumn(table,rows,rowIndex,cellIndex){var l=parsers.length,node=false,nodeValue=false,keepLooking=true;while(nodeValue==''&&keepLooking){rowIndex++;if(rows[rowIndex]){node=getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex);nodeValue=trimAndGetNodeText(table.config,node);if(table.config.debug){log('Checking if value was empty on row:'+rowIndex);}}else{keepLooking=false;}}for(var i=1;i<l;i++){if(parsers[i].is(nodeValue,table,node)){return parsers[i];}}return parsers[0];}function getNodeFromRowAndCellIndex(rows,rowIndex,cellIndex){return rows[rowIndex].cells[cellIndex];}function trimAndGetNodeText(config,node){return $.trim(getElementText(config,node));}function getParserById(name){var l=parsers.length;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==name.toLowerCase()){return parsers[i];}}return false;}function buildCache(table){if(table.config.debug){var cacheTime=new Date();}var totalRows=(table.tBodies[0]&&table.tBodies[0].rows.length)||0,totalCells=(table.tBodies[0].rows[0]&&table.tBodies[0].rows[0].cells.length)||0,parsers=table.config.parsers,cache={row:[],normalized:[]};for(var i=0;i<totalRows;++i){var c=$(table.tBodies[0].rows[i]),cols=[];if(c.hasClass(table.config.cssChildRow)){cache.row[cache.row.length-1]=cache.row[cache.row.length-1].add(c);continue;}cache.row.push(c);for(var j=0;j<totalCells;++j){cols.push(parsers[j].format(getElementText(table.config,c[0].cells[j]),table,c[0].cells[j]));}cols.push(cache.normalized.length);cache.normalized.push(cols);cols=null;};if(table.config.debug){benchmark("Building cache for "+totalRows+" rows:",cacheTime);}return cache;};function getElementText(config,node){var text="";if(!node)return"";if(!config.supportsTextContent)config.supportsTextContent=node.textContent||false;if(config.textExtraction=="simple"){if(config.supportsTextContent){text=node.textContent;}else{if(node.childNodes[0]&&node.childNodes[0].hasChildNodes()){text=node.childNodes[0].innerHTML;}else{text=node.innerHTML;}}}else{if(typeof(config.textExtraction)=="function"){text=config.textExtraction(node);}else{text=$(node).text();}}return text;}function appendToTable(table,cache){if(table.config.debug){var appendTime=new Date()}var c=cache,r=c.row,n=c.normalized,totalRows=n.length,checkCell=(n[0].length-1),tableBody=$(table.tBodies[0]),rows=[];for(var i=0;i<totalRows;i++){var pos=n[i][checkCell];rows.push(r[pos]);if(!table.config.appender){var l=r[pos].length;for(var j=0;j<l;j++){tableBody[0].appendChild(r[pos][j]);}}}if(table.config.appender){table.config.appender(table,rows);}rows=null;if(table.config.debug){benchmark("Rebuilt table:",appendTime);}applyWidget(table);setTimeout(function(){$(table).trigger("sortEnd");},0);};function buildHeaders(table){if(table.config.debug){var time=new Date();}var meta=($.metadata)?true:false;var header_index=computeTableHeaderCellIndexes(table);$tableHeaders=$(table.config.selectorHeaders,table).each(function(index){this.column=header_index[this.parentNode.rowIndex+"-"+this.cellIndex];this.order=formatSortingOrder(table.config.sortInitialOrder);this.count=this.order;if(checkHeaderMetadata(this)||checkHeaderOptions(table,index))this.sortDisabled=true;if(checkHeaderOptionsSortingLocked(table,index))this.order=this.lockedOrder=checkHeaderOptionsSortingLocked(table,index);if(!this.sortDisabled){var $th=$(this).addClass(table.config.cssHeader);if(table.config.onRenderHeader)table.config.onRenderHeader.apply($th);}table.config.headerList[index]=this;});if(table.config.debug){benchmark("Built headers:",time);log($tableHeaders);}return $tableHeaders;};function computeTableHeaderCellIndexes(t){var matrix=[];var lookup={};var thead=t.getElementsByTagName('THEAD')[0];var trs=thead.getElementsByTagName('TR');for(var i=0;i<trs.length;i++){var cells=trs[i].cells;for(var j=0;j<cells.length;j++){var c=cells[j];var rowIndex=c.parentNode.rowIndex;var cellId=rowIndex+"-"+c.cellIndex;var rowSpan=c.rowSpan||1;var colSpan=c.colSpan||1
var firstAvailCol;if(typeof(matrix[rowIndex])=="undefined"){matrix[rowIndex]=[];}for(var k=0;k<matrix[rowIndex].length+1;k++){if(typeof(matrix[rowIndex][k])=="undefined"){firstAvailCol=k;break;}}lookup[cellId]=firstAvailCol;for(var k=rowIndex;k<rowIndex+rowSpan;k++){if(typeof(matrix[k])=="undefined"){matrix[k]=[];}var matrixrow=matrix[k];for(var l=firstAvailCol;l<firstAvailCol+colSpan;l++){matrixrow[l]="x";}}}}return lookup;}function checkCellColSpan(table,rows,row){var arr=[],r=table.tHead.rows,c=r[row].cells;for(var i=0;i<c.length;i++){var cell=c[i];if(cell.colSpan>1){arr=arr.concat(checkCellColSpan(table,headerArr,row++));}else{if(table.tHead.length==1||(cell.rowSpan>1||!r[row+1])){arr.push(cell);}}}return arr;};function checkHeaderMetadata(cell){if(($.metadata)&&($(cell).metadata().sorter===false)){return true;};return false;}function checkHeaderOptions(table,i){if((table.config.headers[i])&&(table.config.headers[i].sorter===false)){return true;};return false;}function checkHeaderOptionsSortingLocked(table,i){if((table.config.headers[i])&&(table.config.headers[i].lockedOrder))return table.config.headers[i].lockedOrder;return false;}function applyWidget(table){var c=table.config.widgets;var l=c.length;for(var i=0;i<l;i++){getWidgetById(c[i]).format(table);}}function getWidgetById(name){var l=widgets.length;for(var i=0;i<l;i++){if(widgets[i].id.toLowerCase()==name.toLowerCase()){return widgets[i];}}};function formatSortingOrder(v){if(typeof(v)!="Number"){return(v.toLowerCase()=="desc")?1:0;}else{return(v==1)?1:0;}}function isValueInArray(v,a){var l=a.length;for(var i=0;i<l;i++){if(a[i][0]==v){return true;}}return false;}function setHeadersCss(table,$headers,list,css){$headers.removeClass(css[0]).removeClass(css[1]);var h=[];$headers.each(function(offset){if(!this.sortDisabled){h[this.column]=$(this);}});var l=list.length;for(var i=0;i<l;i++){h[list[i][0]].addClass(css[list[i][1]]);}}function fixColumnWidth(table,$headers){var c=table.config;if(c.widthFixed){var colgroup=$('<colgroup>');$("tr:first td",table.tBodies[0]).each(function(){colgroup.append($('<col>').css('width',$(this).width()));});$(table).prepend(colgroup);};}function updateHeaderSortCount(table,sortList){var c=table.config,l=sortList.length;for(var i=0;i<l;i++){var s=sortList[i],o=c.headerList[s[0]];o.count=s[1];o.count++;}}function multisort(table,sortList,cache){if(table.config.debug){var sortTime=new Date();}var dynamicExp="var sortWrapper = function(a,b) {",l=sortList.length;for(var i=0;i<l;i++){var c=sortList[i][0];var order=sortList[i][1];var s=(table.config.parsers[c].type=="text")?((order==0)?makeSortFunction("text","asc",c):makeSortFunction("text","desc",c)):((order==0)?makeSortFunction("numeric","asc",c):makeSortFunction("numeric","desc",c));var e="e"+i;dynamicExp+="var "+e+" = "+s;dynamicExp+="if("+e+") { return "+e+"; } ";dynamicExp+="else { ";}var orgOrderCol=cache.normalized[0].length-1;dynamicExp+="return a["+orgOrderCol+"]-b["+orgOrderCol+"];";for(var i=0;i<l;i++){dynamicExp+="}; ";}dynamicExp+="return 0; ";dynamicExp+="}; ";if(table.config.debug){benchmark("Evaling expression:"+dynamicExp,new Date());}eval(dynamicExp);cache.normalized.sort(sortWrapper);if(table.config.debug){benchmark("Sorting on "+sortList.toString()+" and dir "+order+" time:",sortTime);}return cache;};function makeSortFunction(type,direction,index){var a="a["+index+"]",b="b["+index+"]";if(type=='text'&&direction=='asc'){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+a+" < "+b+") ? -1 : 1 )));";}else if(type=='text'&&direction=='desc'){return"("+a+" == "+b+" ? 0 : ("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : ("+b+" < "+a+") ? -1 : 1 )));";}else if(type=='numeric'&&direction=='asc'){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+a+" - "+b+"));";}else if(type=='numeric'&&direction=='desc'){return"("+a+" === null && "+b+" === null) ? 0 :("+a+" === null ? Number.POSITIVE_INFINITY : ("+b+" === null ? Number.NEGATIVE_INFINITY : "+b+" - "+a+"));";}};function makeSortText(i){return"((a["+i+"] < b["+i+"]) ? -1 : ((a["+i+"] > b["+i+"]) ? 1 : 0));";};function makeSortTextDesc(i){return"((b["+i+"] < a["+i+"]) ? -1 : ((b["+i+"] > a["+i+"]) ? 1 : 0));";};function makeSortNumeric(i){return"a["+i+"]-b["+i+"];";};function makeSortNumericDesc(i){return"b["+i+"]-a["+i+"];";};function sortText(a,b){if(table.config.sortLocaleCompare)return a.localeCompare(b);return((a<b)?-1:((a>b)?1:0));};function sortTextDesc(a,b){if(table.config.sortLocaleCompare)return b.localeCompare(a);return((b<a)?-1:((b>a)?1:0));};function sortNumeric(a,b){return a-b;};function sortNumericDesc(a,b){return b-a;};function getCachedSortType(parsers,i){return parsers[i].type;};this.construct=function(settings){return this.each(function(){if(!this.tHead||!this.tBodies)return;var $this,$document,$headers,cache,config,shiftDown=0,sortOrder;this.config={};config=$.extend(this.config,$.tablesorter.defaults,settings);$this=$(this);$.data(this,"tablesorter",config);$headers=buildHeaders(this);this.config.parsers=buildParserCache(this,$headers);cache=buildCache(this);var sortCSS=[config.cssDesc,config.cssAsc];fixColumnWidth(this);$headers.click(function(e){var totalRows=($this[0].tBodies[0]&&$this[0].tBodies[0].rows.length)||0;if(!this.sortDisabled&&totalRows>0){$this.trigger("sortStart");var $cell=$(this);var i=this.column;this.order=this.count++%2;if(this.lockedOrder)this.order=this.lockedOrder;if(!e[config.sortMultiSortKey]){config.sortList=[];if(config.sortForce!=null){var a=config.sortForce;for(var j=0;j<a.length;j++){if(a[j][0]!=i){config.sortList.push(a[j]);}}}config.sortList.push([i,this.order]);}else{if(isValueInArray(i,config.sortList)){for(var j=0;j<config.sortList.length;j++){var s=config.sortList[j],o=config.headerList[s[0]];if(s[0]==i){o.count=s[1];o.count++;s[1]=o.count%2;}}}else{config.sortList.push([i,this.order]);}};setTimeout(function(){setHeadersCss($this[0],$headers,config.sortList,sortCSS);appendToTable($this[0],multisort($this[0],config.sortList,cache));},1);return false;}}).mousedown(function(){if(config.cancelSelection){this.onselectstart=function(){return false};return false;}});$this.bind("update",function(){var me=this;setTimeout(function(){me.config.parsers=buildParserCache(me,$headers);cache=buildCache(me);},1);}).bind("updateCell",function(e,cell){var config=this.config;var pos=[(cell.parentNode.rowIndex-1),cell.cellIndex];cache.normalized[pos[0]][pos[1]]=config.parsers[pos[1]].format(getElementText(config,cell),cell);}).bind("sorton",function(e,list){$(this).trigger("sortStart");config.sortList=list;var sortList=config.sortList;updateHeaderSortCount(this,sortList);setHeadersCss(this,$headers,sortList,sortCSS);appendToTable(this,multisort(this,sortList,cache));}).bind("appendCache",function(){appendToTable(this,cache);}).bind("applyWidgetId",function(e,id){getWidgetById(id).format(this);}).bind("applyWidgets",function(){applyWidget(this);});if($.metadata&&($(this).metadata()&&$(this).metadata().sortlist)){config.sortList=$(this).metadata().sortlist;}if(config.sortList.length>0){$this.trigger("sorton",[config.sortList]);}applyWidget(this);});};this.addParser=function(parser){var l=parsers.length,a=true;for(var i=0;i<l;i++){if(parsers[i].id.toLowerCase()==parser.id.toLowerCase()){a=false;}}if(a){parsers.push(parser);};};this.addWidget=function(widget){widgets.push(widget);};this.formatFloat=function(s){var i=parseFloat(s);return(isNaN(i))?0:i;};this.formatInt=function(s){var i=parseInt(s);return(isNaN(i))?0:i;};this.isDigit=function(s,config){return/^[-+]?\d*$/.test($.trim(s.replace(/[,.']/g,'')));};this.clearTableBody=function(table){if($.browser.msie){function empty(){while(this.firstChild)this.removeChild(this.firstChild);}empty.apply(table.tBodies[0]);}else{table.tBodies[0].innerHTML="";}};}});$.fn.extend({tablesorter:$.tablesorter.construct});var ts=$.tablesorter;ts.addParser({id:"text",is:function(s){return true;},format:function(s){return $.trim(s.toLocaleLowerCase());},type:"text"});ts.addParser({id:"digit",is:function(s,table){var c=table.config;return $.tablesorter.isDigit(s,c);},format:function(s){return $.tablesorter.formatFloat(s);},type:"numeric"});ts.addParser({id:"currency",is:function(s){return/^[Â£$â‚¬?.]/.test(s);},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/[Â£$â‚¬]/g),""));},type:"numeric"});ts.addParser({id:"ipAddress",is:function(s){return/^\d{2,3}[\.]\d{2,3}[\.]\d{2,3}[\.]\d{2,3}$/.test(s);},format:function(s){var a=s.split("."),r="",l=a.length;for(var i=0;i<l;i++){var item=a[i];if(item.length==2){r+="0"+item;}else{r+=item;}}return $.tablesorter.formatFloat(r);},type:"numeric"});ts.addParser({id:"url",is:function(s){return/^(https?|ftp|file):\/\/$/.test(s);},format:function(s){return jQuery.trim(s.replace(new RegExp(/(https?|ftp|file):\/\//),''));},type:"text"});ts.addParser({id:"isoDate",is:function(s){return/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(s);},format:function(s){return $.tablesorter.formatFloat((s!="")?new Date(s.replace(new RegExp(/-/g),"/")).getTime():"0");},type:"numeric"});ts.addParser({id:"percent",is:function(s){return/\%$/.test($.trim(s));},format:function(s){return $.tablesorter.formatFloat(s.replace(new RegExp(/%/g),""));},type:"numeric"});ts.addParser({id:"usLongDate",is:function(s){return s.match(new RegExp(/^[A-Za-z]{3,10}\.? [0-9]{1,2}, ([0-9]{4}|'?[0-9]{2}) (([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(AM|PM)))$/));},format:function(s){return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"shortDate",is:function(s){return/\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/.test(s);},format:function(s,table){var c=table.config;s=s.replace(/\-/g,"/");if(c.dateFormat=="us"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$1/$2");}else if(c.dateFormat=="uk"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/,"$3/$2/$1");}else if(c.dateFormat=="dd/mm/yy"||c.dateFormat=="dd-mm-yy"){s=s.replace(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})/,"$1/$2/$3");}return $.tablesorter.formatFloat(new Date(s).getTime());},type:"numeric"});ts.addParser({id:"time",is:function(s){return/^(([0-2]?[0-9]:[0-5][0-9])|([0-1]?[0-9]:[0-5][0-9]\s(am|pm)))$/.test(s);},format:function(s){return $.tablesorter.formatFloat(new Date("2000/01/01 "+s).getTime());},type:"numeric"});ts.addParser({id:"metadata",is:function(s){return false;},format:function(s,table,cell){var c=table.config,p=(!c.parserMetadataName)?'sortValue':c.parserMetadataName;return $(cell).metadata()[p];},type:"numeric"});ts.addWidget({id:"zebra",format:function(table){if(table.config.debug){var time=new Date();}var $tr,row=-1,odd;$("tr:visible",table.tBodies[0]).each(function(i){$tr=$(this);if(!$tr.hasClass(table.config.cssChildRow))row++;odd=(row%2==0);$tr.removeClass(table.config.widgetZebra.css[odd?0:1]).addClass(table.config.widgetZebra.css[odd?1:0])});if(table.config.debug){$.tablesorter.benchmark("Applying Zebra widget",time);}}});})(jQuery);
var Dashboard = new function __DashBoard() {
	
};




Dashboard.filter = new function __DashboardFilter(){

	this.init = function() {

		$("#js-db-filters .filter.js-department .-cmenu").append(AP.render(Client.depts, function(e){
			return "<div class='-item url' data-urlparam='dept' data-value='"+(e.id)+"'>"+(e.name)+"</div>";
		}));
		
		var range='Táº¥t cáº£';
		if (Client.pageData.range){
			range=AP.i18n.range(Client.pageData.range.start, Client.pageData.range.end);
		}

		$("#js-db-filters .js-duration em").html(range);
		
		
		$("#js-db-filters .js-duration").click(function(){
			UI.rangePicker(function(start, end){
				AP.setURLParams({start: start, end: end}, true);
			});
		});
		
		$("#js-db-filters .js-by .-item").setActiveData("value", Query.get("by"));
		$("#js-db-filters .js-department .-item").setActiveData("value", Query.get("dept"));
		$("#js-db-filters .js-assignees .-item").setActiveData("value", Query.get("assignees"));
		$("#js-db-filters .js-subtaskopt .-item").setActiveData("value", Query.get("subtaskopt"));
		$("#js-db-filters .js-status .-item").setActiveData("value", Query.get("status"));
		
		
		$("#js-db-filters .-item.active").each(function(){
			var v=$(this).text();
			$(this).closest(".filter").find("em").html(v);
			$(this).closest(".filter").find("em").attr('title', v);
		});
	};
};


Dashboard.grid = new function __DBGrid() {

	this.init = function() {
		$("#db-canvas .db-grid").each(function(){
			var col=$(this).data("col");
			
			$(this).find(".box").each(function(){
				var c=$(this).data("col");
				
				if (AP.data.isString(c)){
					var parts=c.split(",", 2);
					if (parts.length==2 && parseFloat(parts[0]) && parseFloat(parts[1])){
						var cx=parseFloat(parts[0]);
						var rx=parseFloat(parts[1]);
						var h=100*rx/cx;
						
						var w=100.0*cx/col;
						$(this).css("width", w+"%").addClass("std").wrapInner("<div class='inner'></div>").append("<div class='s' style='padding-bottom:"+(h)+"%'></div>");
					}
					
				}else if (c && parseInt(c)){
					var w=100.0*c/col;
					$(this).css("width", w+"%").addClass("std").wrapInner("<div class='inner'></div>").append("<div class='s'></div>");
				}
				
				var $h=$(this).find(".header");
				if (!$h.find(".side").length){
					$h.append("<div class='side'></div>");
				}
			})
		});
	};
};


Dashboard.builder=new function __DashboardBuilder(){
	
	this.build = function() {

		initTaskStatusReport();
		initTaskLateReport();
		initTopPerformers();
		initMemberReport();
		initAssignersReport();
		
		initDailyReport();
		initWeeklyReport();
		
		initProjectReport();
		initDeptReport();
		initMilestoneReport();
		initTagCloud();
		initGridStats();
		
		initWorkloadReport();
		
		$("#db-canvas .js-count").each(function() {
			var k = $(this).data("key");
			if (Dashboard.model.stats[k]) {
				$(this).html(AP.data.numberFormat(Dashboard.model.stats[k]));
			}else{
				$(this).html(0);
			}

			var $detail = $(this).closest('.js-detail');
			if ($detail.length && $detail.attr('title')) {
				$detail.attr('title', (Dashboard.model.stats[k] ? ""+(AP.data.numberFormat(Dashboard.model.stats[k]))+"" : '0') + ' ' + $detail.attr('title'));
			}
		});

		this.bindEvents();
	};



	this.bindEvents = function () {

		// Binding overview projects
		$("#db-canvas .js-projects-overview .js-detail").click(function () {

			var key = $(this).data('key');
			var projects_lists = [
				{label: 'Dá»± Ă¡n ná»™i bá»™', key: 'real_projects_internal', data: Dashboard.model.getStatObj("real_projects_internal")},
				{label: 'Dá»± Ă¡n bĂªn ngoĂ i', key: 'real_projects_external', data: Dashboard.model.getStatObj("real_projects_external")}
			];
			var total = projects_lists[0].data.length + projects_lists[1].data.length;
			

			Base.load({
				header: "Dá»± Ă¡n",
				id: 'report-detail-projects',
				width: 800,
				html: '',
				render: function () {
					var title = "Dá»± Ă¡n";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> Dá»± Ă¡n &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-projects").html("  " +Render.render('report_detail_total_projects', {lists:projects_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-projects").balance();
					})
				}
			});
		});


		// Binding overview teams
		$("#db-canvas .js-teams-overview .js-detail").click(function () {

			var key = $(this).data('key');

			var teams_lists = [
				{label: 'PhĂ²ng ban ná»™i bá»™', key: 'real_teams_internal', data: Dashboard.model.getStatObj("real_teams_internal")},
				{label: 'PhĂ²ng ban bĂªn ngoĂ i', key: 'real_teams_external', data: Dashboard.model.getStatObj("real_teams_external")}
			];

			var total = teams_lists[0].data.length + teams_lists[1].data.length;

			Base.load({
				header: "PhĂ²ng ban",
				id: 'report-detail-teams',
				width: 800,
				html: '',
				render: function () {
					var title = "PhĂ²ng ban";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> phĂ²ng ban &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-teams").html("  " +Render.render('report_detail_total_projects', {lists:teams_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-teams").balance();
					});
				}
			});
		});


		// Binding overview tasks
		$("#db-canvas .js-tasks-overview .js-detail").click(function () {

			var key = $(this).data('key');
			var tasks_lists = [
				{label: 'Äang thá»±c hiá»‡n', key: 'tasks_active', data: Dashboard.model.getStatObj("tasks_active")},
				{label: 'HoĂ n thĂ nh', key: 'tasks_done', data: Dashboard.model.getStatObj("tasks_done")}
			];
			var total = tasks_lists[0].data.length + tasks_lists[1].data.length;

			Base.load({
				header: "CĂ´ng viá»‡c",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					var title = "CĂ´ng viá»‡c";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {lists:tasks_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});


		// Binding overview tasks
		$("#db-canvas .js-tasks-reported .js-detail").click(function () {

			var key = $(this).data('key');
			var tasks_lists = [
				{label: 'CĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o', key: 'tasks_reported', data: Dashboard.model.getStatObj("tasks_reported")},
				{label: 'CĂ´ng viá»‡c chÆ°a bĂ¡o cĂ¡o', key: 'tasks_unreported', data: Dashboard.model.getStatObj("tasks_unreported")}
			];
			var total = tasks_lists[0].data.length + tasks_lists[1].data.length;

			Base.load({
				header: "CĂ´ng viá»‡c",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					var title = "CĂ´ng viá»‡c";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";
					
					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {lists:tasks_lists, title:title, subtitle:subtitle, key:key, duration:1}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		

		// Binding overview milestones
		$("#db-canvas .js-milestones-overview .js-detail").click(function () {

			var key = $(this).data('key');
			var milestones_lists = [
				{label: 'Äang thá»±c hiá»‡n', key: 'milestones_in_progress', data: Dashboard.model.getStatObj("milestones_in_progress")},
				{label: 'HoĂ n thĂ nh', key: 'milestones_completed', data: Dashboard.model.getStatObj("milestones_completed")}
			];
			var total = milestones_lists[0].data.length + milestones_lists[1].data.length;

			Base.load({
				header: "Má»¥c tiĂªu",
				id: 'report-detail-milestones',
				width: 800,
				html: '',
				render: function () {

					var title = "Má»¥c tiĂªu";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> Má»¥c tiĂªu &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-milestones").html("  " +Render.render('report_detail_total_milestones', {lists:milestones_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-milestones").balance();
					});
				}
			});
		});


		// Binding overview members
		$("#db-canvas .js-members-overview .js-detail").click(function () {

			var key = $(this).data('key');
			var members_lists = [
				{label: 'NhĂ¢n viĂªn', key: 'people_internal', data: Dashboard.model.getStatObj("people_internal")},
				{label: 'TĂ i khoáº£n khĂ¡ch', key: 'people_guest', data: Dashboard.model.getStatObj("people_guest")}
			];
			var total = members_lists[0].data.length + members_lists[1].data.length;

			Base.load({
				header: "ThĂ nh viĂªn",
				id: 'report-detail-members',
				width: 800,
				html: '',
				render: function () {

					var title = "ThĂ nh viĂªn";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> thĂ nh viĂªn &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-members").html("  " +Render.render('report_detail_total_members', {lists:members_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-members").balance();
					});

				}
			});
		});



		// Binding overview eshm
		$("#db-canvas .js-eshm .js-detail").click(function () {

			var key = $(this).data('key');
			var tasks_lists = [
				{label: 'Kháº©n cáº¥p & Quan trá»ng', key: 'esn_11', data: Dashboard.model.getStatObj("esn_11")},
				{label: 'Kháº©n cáº¥p', key: 'esn_10', data: Dashboard.model.getStatObj("esn_10")},
				{label: 'Quan trá»ng', key: 'esn_01', data: Dashboard.model.getStatObj("esn_01")},
				{label: 'KhĂ´ng kháº©n cáº¥p vĂ  khĂ´ng quan trá»ng', key: 'esn_00', data: Dashboard.model.getStatObj("esn_00")}
			];
			var total = tasks_lists[0].data.length + tasks_lists[1].data.length + tasks_lists[2].data.length + tasks_lists[3].data.length;

			Base.load({
				header: "Ma tráº­n Eisenhower",
				id: 'report-detail-tasks',
				width: 820,
				html: '',
				render: function () {

					var title = "Ma tráº­n Eisenhower";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {lists:tasks_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});


		$("#db-canvas .js-tasks-review .js-detail").on('click', function () {

			var key = $(this).data('key');
			var title = '';
			if (key == 'tasks_review') {
				title = 'Äang chá» Ä‘Ă¡nh giĂ¡';
			} else if (key == 'tasks_review_overdue') {
				title = 'Chá» Ä‘Ă¡nh giĂ¡ vĂ  quĂ¡ háº¡n';
			}

			var data = Dashboard.model.getStatObj(key);
			Base.load({
				header: title,
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					var subtitle = "Tá»•ng sá»‘: <em>"+(data.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {tasks:data, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});


		$("#db-canvas .js-tasks-review .js-project-detail").on('click', function () {

			var key = $(this).data('key');
			var title = 'PhĂ²ng ban vĂ  dá»± Ă¡n cho phĂ©p review cĂ´ng viá»‡c';
			

			var data = Dashboard.model.getStatObj(key);
			Base.load({
				header: title,
				id: 'report-detail-projects',
				width: 800,
				html: '',
				render: function () {

					var subtitle = "Tá»•ng sá»‘: <em>"+(data.length)+"</em> phĂ²ng ban/dá»± Ă¡n &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-projects").html("  " +Render.render('report_detail_projects', {projects:data, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-projects").balance();
					});
				}
			});
		});
	};

	


	/**
	 * @desc Init standard reports for todo, doing, done_late, done_ontime, using PIE chart
	 */
	function initTaskStatusReport() {

		var stats = { done_ontime: Dashboard.model.getStat("tasks_done_ontime"), done_late: Dashboard.model.getStat("tasks_done_late"), in_progress: Dashboard.model.getStat("tasks_in_progress"), overdue: Dashboard.model.getStat("tasks_overdue")};
		
		$('#js-task-status-report').css("height", $('#js-task-status-report').width() * 0.6);
		var html = "<div class='legends -inline'> <div class='legend -detail ap-xdot' data-key='done_ontime' title='"+(Dashboard.model.getStat('tasks_done_ontime'))+" HoĂ n thĂ nh Ä‘Ăºng háº¡n'> <div class='circle'style='background-color:"+(Color.get('success'))+"'></div> <span class='-detail-text'>"+(Dashboard.model.getStatDisplay('tasks_done_ontime'))+" HoĂ n thĂ nh Ä‘Ăºng háº¡n</span> </div> <div class='legend -detail ap-xdot' data-key='done_late' title='"+(Dashboard.model.getStat('tasks_done_late'))+" HoĂ n thĂ nh muá»™n'> <div class='circle' style='background-color:"+(Color.get('late'))+"'></div> <span class='-detail-text'>"+(Dashboard.model.getStatDisplay('tasks_done_late'))+" HoĂ n thĂ nh muá»™n</span> </div> <div class='legend -detail ap-xdot' data-key='in_progress' title='"+(Dashboard.model.getStat('tasks_in_progress'))+" Äang thá»±c hiá»‡n'> <div class='circle' style='background-color:"+(Color.get('doing'))+"'></div> <span class='-detail-text'>"+(Dashboard.model.getStatDisplay('tasks_in_progress'))+" Äang thá»±c hiá»‡n</span> </div> <div class='legend -detail ap-xdot' data-key='overdue' title='"+(Dashboard.model.getStatDisplay('tasks_overdue'))+" QuĂ¡ háº¡n'> <div class='circle' style='background-color:"+(Color.get('overdue'))+"'></div> <span class='-detail-text'>"+(Dashboard.model.getStatDisplay('tasks_overdue'))+" QuĂ¡ háº¡n</span> </div> </div> <div class='gcount'>"+(Dashboard.model.getStatDisplay('tasks'))+"<em>CĂ´ng viá»‡c</em></div>";
		
		$('#js-task-status-report').after(html);


		var lists = [
			{label: 'HoĂ n thĂ nh Ä‘Ăºng háº¡n', key: 'ontime', data: Dashboard.model.getStatObj("tasks_done_ontime")},
			{label: 'HoĂ n thĂ nh muá»™n', key: 'done_late', data: Dashboard.model.getStatObj("tasks_done_late")},
			{label: 'Äang thá»±c hiá»‡n', key: 'in_progress', data: Dashboard.model.getStatObj("tasks_in_progress")},
			{label: 'QuĂ¡ háº¡n', key: 'overdue', data: Dashboard.model.getStatObj("tasks_overdue")},
		];

		$('#js-task-status-report').parent().find('.legend').on('click', function () {

			var key = $(this).data('key');
			var total = stats.done_late + stats.done_ontime + stats.in_progress + stats.overdue;

			Base.load({
				header: "BĂ¡o cĂ¡o tráº¡ng thĂ¡i cĂ´ng viá»‡c",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					var title = "BĂ¡o cĂ¡o tráº¡ng thĂ¡i cĂ´ng viá»‡c";
					var subtitle = "Tá»•ng sá»‘ <em>"+(total)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {lists:lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});


		$('#js-task-status-report').highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true,
					innerSize: '80%'
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '9px'},
				enabled: false,
			},
			series: [{
				name: 'CĂ´ng viá»‡c',
				colorByPoint: true,
				data: [{
					name: "QuĂ¡ háº¡n ("+(stats.overdue)+")",
					y: stats.overdue,
					color: Color.get('overdue')
				},{
					name: "Äang thá»±c hiá»‡n ("+(stats.in_progress)+")",
					y: stats.in_progress,
					color: Color.get('doing')
				}, {
					name: "HoĂ n thĂ nh Ä‘Ăºng háº¡n ("+(stats.done_ontime)+")",
					y: stats.done_ontime,
					color: Color.get('success')
				}, {
					name: "HoĂ n thĂ nh muá»™n ("+(stats.done_late)+")",
					y: stats.done_late,
					color: Color.get('late')
				}]
			}]
		});
	};
	
	
	/**
	 * @desc Visualize how late tasks are handled
	 */
	function initTaskLateReport() {

		var overdue = Dashboard.model.getStat("tasks_overdue");
		var active = Dashboard.model.getStat("tasks_active");
		var overdue_percent = 0;
		if (active > 0){
			overdue_percent = (overdue*100.0/active).toFixed(1);
		}
		
		var done = Dashboard.model.getStat("tasks_done");
		var done_late = Dashboard.model.getStat("tasks_done_late");
		var late_percent = 0;
		if (done > 0) {
			late_percent = (done_late*100.0/done).toFixed(1);
		}
		
		
		$("#js-task-late-report").html("<div class='istats'> <div class='istat'> <div class='percent' data-bg='#e5e5e5' data-percent='"+(overdue_percent)+"' data-text='"+(overdue_percent)+"%'  data-color='"+(Color.get('error'))+"'></div> <div class='stat'> <div class='number js-detail -detail -detail-text' data-key='tasks_overdue'><em style='color:"+(Color.get('error'))+"'>"+(overdue)+"</em></div> <div class='sub ap-xdot' title='CĂ´ng viá»‡c quĂ¡ háº¡n'>CĂ´ng viá»‡c quĂ¡ háº¡n</div> <div class='sub ap-xdot' title='TrĂªn "+(active)+" cĂ´ng viá»‡c Ä‘ang thá»±c hiá»‡n'>TrĂªn <em>"+(active)+"</em> CĂ´ng viá»‡c Ä‘ang thá»±c hiá»‡n</div> </div> </div> <div class='istat'> <div class='percent' data-bg='#e5e5e5' data-percent='"+(late_percent)+"' data-text='"+(late_percent)+"%' data-color='"+(Color.get('late'))+"'></div> <div class='stat'> <div class='number js-detail -detail -detail-text' data-key='tasks_done_late'><em style='color:"+(Color.get('late'))+"'>"+(done_late)+"</em></div> <div class='sub ap-xdot' title='CĂ´ng viá»‡c hoĂ n thĂ nh muá»™n'>CĂ´ng viá»‡c hoĂ n thĂ nh muá»™n</div> <div class='sub ap-xdot' title='TrĂªn "+(done)+" cĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh'>TrĂªn <em>"+(done)+"</em> CĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh</div> </div> </div> <div class='istat'> <div class='plain'> <span class='icon ficon-exclamation-circle'></span> <b class='js-count js-detail-no-deadline -detail -detail-text' data-key='tasks_no_deadline'></b> cĂ´ng viá»‡c Ä‘Æ°á»£c táº¡o khĂ´ng cĂ³ thá»i háº¡n </div> </div> </div>");

		$("#js-task-late-report .js-detail").on('click', function () {

			var key = $(this).data('key');

			var title = '';
			if (key == 'tasks_done_late') {
				title = 'CĂ´ng viá»‡c hoĂ n thĂ nh muá»™n';
			} else if (key == 'tasks_overdue') {
				title = 'CĂ´ng viá»‡c quĂ¡ háº¡n';
			}


			Base.load({
				header: title,
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {
					var subtitle = "Tá»•ng sá»‘ <em>"+(Dashboard.model.getStat(key))+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {tasks:Dashboard.model.getStatObj(key), title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});


		$("#js-task-late-report .js-detail-no-deadline").on('click', function () {

			var data = Dashboard.model.getStatObj("tasks_no_deadline");
			Base.load({
				header: "CĂ´ng viá»‡c Ä‘Æ°á»£c táº¡o khĂ´ng cĂ³ thá»i háº¡n",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					var title = "CĂ´ng viá»‡c Ä‘Æ°á»£c táº¡o khĂ´ng cĂ³ thá»i háº¡n";
					var subtitle = "Tá»•ng sá»‘ <em>"+(data.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {tasks:data, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		
		$("#js-task-late-report .percent").each(function(){
			$(this).angular({
				arc: true
			});
		});
	};
	
	
	
	
	function initTopPerformers() {

		var people = Dashboard.model.getTop("people", 5, function(e){
			if (e.obj && e.obj.id && !e.obj.error){
				return e.stats.done;	
			}
			
			return 0;
		});
		
		var html = AP.render(people, function(p){
			var w = 0;
			if (p.stats.total > 0) {
				w = (p.stats.done*100/p.stats.total).toFixed(1);
			}
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url ap-xdot' style='max-width: 180px;' title='"+(p.obj.name)+"' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info js-detail -detail' data-user='"+(p.obj.username)+"'><em>"+(p.stats.done)+"</em>/"+(p.stats.total)+" cĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh</div> <div class='side'> <div class='bar'> <div class='c' style='width: "+(w)+"%'></div> <div class='txt'>"+(w)+"%</div> </div> </div> </div>";
		});
		
		$("#js-top-performers").html(html);
		$("#js-top-performers .item .js-detail").on('click', function () {

			var username = $(this).data('user');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.people, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.done.length)+"/"+(user_data.stats_obj.total.length)+"</em> CĂ´ng viá»‡c Ä‘Ă£ hoĂ n thĂ nh &middot; "+(getFilteredTime())+"";
			Base.load({
				header: "ThĂ nh viĂªn xuáº¥t sáº¯c",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {avatar:AP.xthumb(user.gavatar), tasks:user_data.stats_obj.done, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
	};
	
	
	
	function initMemberReport() {

		var html = AP.render(Dashboard.model.people, function(p) {
			var w = 0;
			if (p.stats.total > 0) {
				w = (p.stats.done*100 / p.stats.total).toFixed(1);
			}
			
			var name = p.obj.name;
			
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(name)+"</span></div> <div class='info js-detail -detail' data-user='"+(p.obj.username)+"' data-key='total'><em>"+(p.stats.total)+"</em> cĂ´ng viá»‡c Ä‘Æ°á»£c giao</div> <div class='side'> <div class='col' style='width:100px;'>"+(mbar(p.stats))+"</div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='done_ontime' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('success'))+"'>"+(p.stats.done_ontime)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='done_late' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('late'))+"'>"+(p.stats.done_late)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='overdue' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('overdue'))+"'>"+(p.stats.overdue)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='in_progress' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('doing'))+"'>"+(p.stats.in_progress)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='review' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('review'))+"'>"+(p.stats.review)+"</em></div> </div> </div>";
		});
		
		$("#js-members-report").html(html);
		$("#js-members-report .js-detail").on('click', function () {

			var username = $(this).data('user');
			var key = $(this).data('key');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.people, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.total.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

			var assignments_lists = [
				{label: 'HoĂ n thĂ nh Ä‘Ăºng háº¡n', key: 'done_ontime', data: user_data.stats_obj.done_ontime},
				{label: 'HoĂ n thĂ nh muá»™n', key: 'done_late', data: user_data.stats_obj.done_late},
				{label: 'QuĂ¡ háº¡n', key: 'overdue', data: user_data.stats_obj.overdue},
				{label: 'Äang thá»±c hiá»‡n', key: 'in_progress', data: user_data.stats_obj.in_progress},
				{label: 'Äang chá» Ä‘Ă¡nh giĂ¡', key: 'review', data: user_data.stats_obj.review},
			];

			Base.load({
				header: "CĂ´ng viá»‡c Ä‘Æ°á»£c giao theo thĂ nh viĂªn",
				id: 'report-detail-tasks',
				width: 1000,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {avatar:AP.xthumb(user.gavatar), lists:assignments_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		
		// SHOW MOST ACTIVE
		var top_actives = Dashboard.model.getTop("people", 10, function(e){
			if (e.obj && e.obj.id && !e.obj.error){
				return e.stats.active;	
			}
			
			return 0;
		});
		
		
		var html = AP.render(top_actives, function(p) {
			var w = 0;
			if (p.stats.total > 0) {
				w = (p.stats.done*100 / p.stats.total).toFixed(1);
			}
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info js-detail -detail' data-user='"+(p.obj.username)+"'><em>"+(p.stats.active)+"</em>/"+(p.stats.total)+" cĂ´ng viá»‡c Ä‘ang thá»±c hiá»‡n</div> </div>";
		});
		
		$("#js-members-top-pendings-report").html(html);
		$("#js-members-top-pendings-report .item .js-detail").on('click', function () {

			var username = $(this).data('user');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.people, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.active.length)+"/"+(user_data.stats_obj.total.length)+"</em> cĂ´ng viá»‡c Ä‘ang thá»±c hiá»‡n &middot; "+(getFilteredTime())+"";
			Base.load({
				header: "CĂ²n nhiá»u viá»‡c nháº¥t",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {avatar:AP.xthumb(user.gavatar), tasks:user_data.stats_obj.active, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		
		
		// SHOW MOST LATE js-members-top-lates-report
		var top_lates = Dashboard.model.getTop("people", 10, function(e){
			if (e.obj && e.obj.id && !e.obj.error){
				return e.stats.done_late + e.stats.overdue;	
			}
			
			return 0;
		});
		
		
		var html = AP.render(top_lates, function(p){
			var w = 0;
			if (p.stats.total > 0) {
				w = (p.stats.done_late*100/p.stats.total).toFixed(1);
			}
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url red' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info'> <span class='js-detail -detail -detail-text' data-key='overdue' data-user='"+(p.obj.username)+"'><em>"+(p.stats.overdue)+"</em> quĂ¡ háº¡n</span> &middot; <span class='js-detail -detail -detail-text' data-key='done_late' data-user='"+(p.obj.username)+"'><em>"+(p.stats.done_late)+"</em> hoĂ n thĂ nh muá»™n</span> </div> </div>";
		});
		
		$("#js-members-top-lates-report").html(html);
		$("#js-members-top-lates-report .item .js-detail").on('click', function () {

			var username = $(this).data('user');
			var key = $(this).data('key');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.people, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.done_late.length + user_data.stats_obj.overdue.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

			var assignments_lists = [
				{label: 'QuĂ¡ háº¡n', key: 'overdue', data: user_data.stats_obj.overdue},
				{label: 'HoĂ n thĂ nh muá»™n', key: 'done_late', data: user_data.stats_obj.done_late},
			];

			Base.load({
				header: "LĂ m muá»™n nhiá»u nháº¥t",
				id: 'report-detail-tasks',
				width: 1000,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {avatar:AP.xthumb(user.gavatar), lists:assignments_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
	};	
	
	
	function initAssignersReport() {

		var html = AP.render(Dashboard.model.assigners, function(p) {
			var w = 0;
			if (p.stats.total > 0) {
				w = (p.stats.done*100/p.stats.total).toFixed(1);
			}
			
			var name=p.obj.name;
			
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(name)+"</span></div> <div class='info js-detail -detail' data-user='"+(p.obj.username)+"'><em>"+(p.stats.total)+"</em> cĂ´ng viá»‡c Ä‘Ă£ táº¡o</div> <div class='side'> <div class='col' style='width:100px;'>"+(mbar(p.stats))+"</div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='done_ontime' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('success'))+"'>"+(p.stats.done_ontime)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='done_late' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('late'))+"'>"+(p.stats.done_late)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='overdue' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('overdue'))+"'>"+(p.stats.overdue)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='in_progress' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('doing'))+"'>"+(p.stats.in_progress)+"</em></div> <div class='col js-detail -detail' data-user='"+(p.obj.username)+"' data-key='review' style='width: 60px; padding:2px 0'><em style='color:"+(Color.get('review'))+"'>"+(p.stats.review)+"</em></div> </div> </div>";
		});
		
		$("#js-assigners-report").html(html);
		$("#js-assigners-report .js-detail").on('click', function () {

			var username = $(this).data('user');
			var key = $(this).data('key');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.assigners, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.total.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

			var assignments_lists = [
				{label: 'HoĂ n thĂ nh Ä‘Ăºng háº¡n', key: 'done_ontime', data: user_data.stats_obj.done_ontime},
				{label: 'HoĂ n thĂ nh muá»™n', key: 'done_late', data: user_data.stats_obj.done_late},
				{label: 'QuĂ¡ háº¡n', key: 'overdue', data: user_data.stats_obj.overdue},
				{label: 'Äang thá»±c hiá»‡n', key: 'in_progress', data: user_data.stats_obj.in_progress},
				{label: 'Äang chá» Ä‘Ă¡nh giĂ¡', key: 'review', data: user_data.stats_obj.review},
			];

			Base.load({
				header: "CĂ´ng viá»‡c Ä‘Ă£ táº¡o theo thĂ nh viĂªn",
				id: 'report-detail-tasks',
				width: 1000,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {avatar:AP.xthumb(user.gavatar), lists:assignments_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		

		// SHOW MOST ACTIVE
		var top_creations = Dashboard.model.getTop("assigners", 10, function(e) {
			if (e.obj && e.obj.id && !e.obj.error) {
				return e.stats.total;
			}

			return 0;
		});
		
		
		var html = AP.render(top_creations, function(p) {
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info js-detail -detail' data-user='"+(p.obj.username)+"'><em>"+(p.stats.total)+"</em> cĂ´ng viá»‡c</div> </div>";
		});
		
		$("#js-top-creation-report").html(html);
		$("#js-top-creation-report .item .js-detail").on('click', function () {

			var username = $(this).data('user');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.assigners, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.total.length)+"</em> cĂ´ng viá»‡c Ä‘Ă£ táº¡o &middot; "+(getFilteredTime())+"";
			Base.load({
				header: "Táº¡o nhiá»u cĂ´ng viá»‡c nháº¥t",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {avatar:AP.xthumb(user.gavatar), tasks:user_data.stats_obj.total, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		
		
		// SHOW MOST UNASSIGN js-members-top-lates-report
		var top_unassign = Dashboard.model.getTop("assigners", 10, function(e){
			if (e.obj && e.obj.id && !e.obj.error){
				return e.stats.unassign;
			}
			
			return 0;
		});

		var html = AP.render(top_unassign, function(p){
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name'><span class='url red' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info js-detail -detail' data-user='"+(p.obj.username)+"'><em>"+(p.stats.unassign)+"</em> chÆ°a giao</div> </div>";
		});
		
		$("#js-top-unassign-report").html(html);
		$("#js-top-unassign-report .item .js-detail").on('click', function () {

			var username = $(this).data('user');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.assigners, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.unassign.length)+"</em> nhiá»‡m vá»¥ chÆ°a Ä‘Æ°á»£c giao &middot; "+(getFilteredTime())+"";
			Base.load({
				header: "ChÆ°a giao nhiá»u nháº¥t",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {avatar:AP.xthumb(user.gavatar), tasks:user_data.stats_obj.unassign, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
	}

	
	function initDailyReport(){
		legends("#js-task-daily-report", [
			{label: "Táº¥t cáº£ cĂ´ng viá»‡c", color: "#48856c"},
			{label: "Tá»•ng thá»±c hiá»‡n", color: Color.get("doing")},
			{label: "Tá»•ng hoĂ n thĂ nh", color: Color.get("success")},
			{label: "Tá»•ng quĂ¡ háº¡n", color: Color.get("overdue")}
		]);
		
		$('#js-task-daily-report').highcharts({
			chart:{
				type: "column"
			},
			credits: {
				enabled: false
			},
			title:{
				style:{
					display : 'none'
				}
			},
			xAxis: {
				categories: Dashboard.model.timeLabels("daily")
			},
			yAxis: {	
				title: {
					text: 'Sá»‘ lÆ°á»£ng cĂ´ng viá»‡c'
				}
			},
			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'top',
				float: true
			},
			plotOptions: {
				series: {
					label: {
						connectorAllowed: false
					},
					stacking: 'normal',
					marker: {
						radius: 3
					}
				}
			},	

			series: [{
				name: 'Tá»•ng Ä‘Ă£ táº¡o',
				data: Dashboard.model.timeAggregated("daily", "total"),
				color: "#48856c",
				lineWidth: 1,
				showInLegend: false,
				type: "line"
			}, {
				name: 'Tá»•ng hoĂ n thĂ nh',
				data: Dashboard.model.timeAggregated("daily", "done"),
				color: Color.get("success"),
				showInLegend: false
			}, {
				name: 'Tá»•ng quĂ¡ háº¡n',
				data: Dashboard.model.timeAggregated("daily", "overdue"),
				color: Color.get("overdue"),
				showInLegend: false
			}],
		});
	};
	
	
	
	function initWeeklyReport(){
		var weekly=[{
				name: 'Táº¥t cáº£',
				data: Dashboard.model.timeSeries("weekly", "total"),
				color: '#48856c'
			}, {
				name: 'Äang thá»±c hiá»‡n',
				color: Color.get('doing'),
				data: Dashboard.model.timeSeries("weekly", "in_progress")
			}, {
				name: 'HoĂ n thĂ nh',
				color: Color.get('success'),
				data: Dashboard.model.timeSeries("weekly", "done")
			}, {
				name: 'QuĂ¡ háº¡n',
				color: Color.get('overdue'),
				data: Dashboard.model.timeSeries("weekly", "overdue")
			}
		];
			
			
		$('#js-task-weekly-report').highcharts({
			chart: {
				type: 'column'
			},
			title:{
				style:{
					display : 'none'
				}
			},
			xAxis: {
				categories: Dashboard.model.timeLabels("weekly", 6),
				tickInterval: Math.floor(Dashboard.model.weekly.length/6)
			},
			yAxis: {
				title: {
					text: 'Sá»‘ lÆ°á»£ng cĂ´ng viá»‡c'
				}
			},
			credits: {
				enabled: false
			},
			series: weekly
		});
	};
	
	
	
	
	function initProjectReport() {

		$("#js-report-projects").html(AP.render(Dashboard.model.projects, function(e) {
			if (!e.obj){
				return "";
			}
			
			var icon = "<img src='"+(Client.share_url)+"/fav_icons/"+(e.obj.icon)+".png'/>";
			
			if (!e.obj.icon) {
				icon = UI.textAvatar(e.obj.path);
			}

			var content = safe(e.obj.content);
			if (!content) {
				content = "ChÆ°a cĂ³ miĂªu táº£";
			}

			var range = AP.i18n.range(e.obj.stime, e.obj.etime) + " &middot; ";
			if (e.obj.metatype != "project") {
				range = "";
			}
			
			if (!e.obj.stime && !e.obj.etime) {
				range="";
			}

			var metatype = e.obj.metatype == 'project' ? 'Dá»± Ă¡n' : 'PhĂ²ng ban';
			
			return "<tr> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'>"+(icon)+"</div> <div class='name ap-xdot url' data-url='"+(e.obj.path)+"'><span class='url'>"+(e.obj.name)+"</span></div> <div class='info ap-xdot  js-detail -detail' data-project='"+(e.obj.id)+"' data-key='total'>"+(metatype)+" &middot; <em>"+(e.stats.total)+"</em> cĂ´ng viá»‡c</div> </div> </div> </td> <td> <div class='relative'> "+(mbar(e.stats, true))+" </div> </td> <td><span class='count js-detail -detail' data-project='"+(e.obj.id)+"' data-key='done_ontime' style='color:"+(Color.get('success'))+"'>"+(e.stats.done_ontime)+"</span></td> <td><span class='count js-detail -detail' data-project='"+(e.obj.id)+"' data-key='done_late' style='color:"+(Color.get('late'))+"'>"+(e.stats.done_late)+"</span></td> <td><span class='count js-detail -detail' data-project='"+(e.obj.id)+"' data-key='overdue' style='color:"+(Color.get('overdue'))+"'>"+(e.stats.overdue)+"</span></td> <td><span class='count js-detail -detail' data-project='"+(e.obj.id)+"' data-key='in_progress' style='color:"+(Color.get('doing'))+"'>"+(e.stats.in_progress)+"</span></td> <td><span class='count js-detail -detail' data-project='"+(e.obj.id)+"' data-key='review' style='color:"+(Color.get('review'))+"'>"+(e.stats.review)+"</span></td> </tr>";
		}));

		$("#js-report-projects .js-detail").on('click', function () {

			var project_id = $(this).data('project');
			var key = $(this).data('key');

			var project_data = ARR.findObj(Dashboard.model.projects, project_id);
			var project = Dashboard.model.get('projects', project_id);

			var title = project.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(project_data.stats_obj.total.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

			var projects_lists = [
				{label: 'HoĂ n thĂ nh Ä‘Ăºng háº¡n', key: 'done_ontime', data: project_data.stats_obj.done_ontime},
				{label: 'HoĂ n thĂ nh muá»™n', key: 'done_late', data: project_data.stats_obj.done_late},
				{label: 'QuĂ¡ háº¡n', key: 'overdue', data: project_data.stats_obj.overdue},
				{label: 'Äang thá»±c hiá»‡n', key: 'in_progress', data: project_data.stats_obj.in_progress},
				{label: 'Äang chá» Ä‘Ă¡nh giĂ¡', key: 'review', data: project_data.stats_obj.review},
			];

			Base.load({
				header: "CĂ´ng viá»‡c theo dá»± Ă¡n/phĂ²ng ban",
				id: 'report-detail-tasks',
				width: 1000,
				html: '',
				render: function () {

					showLoading(function () {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {lists:projects_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});


		$("#js-team-report").html("<div class='grid-stats'> <div class='stat' style='height:auto;'> <div class='v js-count js-detail -detail -detail-text' data-key='real_teams_active'></div> <div class='sub -upper'>PhĂ²ng ban hoáº¡t Ä‘á»™ng</div> <span class='sub js-detail -detail' data-key='real_teams_closed'><b class='js-count  text-8' data-key='real_teams_closed'></b> nhĂ³m Ä‘Ă£ Ä‘Ă³ng</span> </div> <div class='stat' style='height:auto;'> <div class='v js-count js-task-detail -detail -detail-text' data-key='tasks_team'></div> <div class='sub -upper'>CĂ´ng viá»‡c trong phĂ²ng ban</div> <span class='sub'><b class='js-count text-success js-task-detail -detail' data-key='tasks_team_done'></b> hoĂ n thĂ nh &middot; <b class='js-count text-error js-task-detail -detail' data-key='tasks_team_overdue'></b> quĂ¡ háº¡n</span> </div> </div>");


		$("#js-team-report .js-detail").on('click', function () {

			var key = $(this).data('key');
			var title = '';
			if (key == 'real_teams_active') {
				title = 'PhĂ²ng ban hoáº¡t Ä‘á»™ng';
			} else if (key == 'real_teams_closed') {
				title = 'PhĂ²ng ban Ä‘Ă£ Ä‘Ă³ng';
			}

			var data = Dashboard.model.getStatObj(key);
			Base.load({
				header: title,
				id: 'report-detail-projects',
				width: 800,
				html: '',
				render: function () {
					var subtitle = "Tá»•ng sá»‘: <em>"+(data.length)+"</em> phĂ²ng ban &middot; "+(getFilteredTime())+"";

					showLoading(function() {
						$("#report-detail-projects").html("  " +Render.render('report_detail_projects', {projects:data, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-projects").balance();
					});
				}
			});
		});

		$("#js-team-report .js-task-detail").on('click', function () {

			var key = $(this).data('key');
			var title = '';
			if (key == 'tasks_team') {
				title = 'CĂ´ng viá»‡c trong phĂ²ng ban';
			} else if (key == 'tasks_team_done') {
				title = 'CĂ´ng viá»‡c hoĂ n thĂ nh trong phĂ²ng ban';
			} else if (key == 'tasks_team_overdue') {
				title = 'CĂ´ng viá»‡c quĂ¡ háº¡n trong phĂ²ng ban';
			}

			var data = Dashboard.model.getStatObj(key);
			Base.load({
				header: title,
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {
					var subtitle = "Tá»•ng sá»‘: <em>"+(data.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {tasks:data, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});



		$("#js-task-late-report .percent").each(function(){
			$(this).angular({
				arc: true
			});
		});
		
		
		$("#js-project-status").html("<div class='split-view'> <div class='graph' id='js-project-state-graph'></div> <div class='main'> <div class='title js-detail -detail -detail-text' data-key='real_projects'><b class='js-count' data-key='real_projects'></b> Dá»± Ă¡n</div> <div class='legends'> <div class='legend js-detail -detail -detail-text' data-key='projects_ontrack'><div class='circle' style='background-color:"+(Color.get('ontrack'))+"'></div> "+(Dashboard.model.getStat('projects_ontrack'))+" ÄĂºng tiáº¿n Ä‘á»™</div> <div class='legend js-detail -detail -detail-text' data-key='projects_offtrack'><div class='circle' style='background-color:"+(Color.get('offtrack'))+"'></div> "+(Dashboard.model.getStat('projects_offtrack'))+" Cháº­m tiáº¿n Ä‘á»™</div> <div class='legend js-detail -detail -detail-text' data-key='projects_atrisk'><div class='circle' style='background-color:"+(Color.get('atrisk'))+"'></div> "+(Dashboard.model.getStat('projects_atrisk'))+" CĂ³ rá»§i ro cao</div> <div class='legend js-detail -detail -detail-text' data-key='projects_success'><div class='circle' style='background-color:"+(Color.get('success'))+"'></div> "+(Dashboard.model.getStat('projects_success'))+" Dá»± Ă¡n thĂ nh cĂ´ng</div> <div class='legend js-detail -detail -detail-text' data-key='projects_failed'><div class='circle' style='background-color:"+(Color.get('failed'))+"'></div> "+(Dashboard.model.getStat('projects_failed'))+" Dá»± Ă¡n tháº¥t báº¡i</div> <div class='legend js-detail -detail -detail-text' data-key='projects_canceled'><div class='circle' style='background-color:"+(Color.get('canceled'))+"'></div> "+(Dashboard.model.getStat('projects_canceled'))+" Dá»± Ă¡n bá»‹ há»§y</div> <div class='legend js-detail -detail -detail-text' data-key='projects_closed'><div class='circle' style='background-color:#eee'></div> "+(Dashboard.model.getStat('projects_closed'))+" ÄĂ£ Ä‘Ă³ng</div> </div> </div> </div>");


		$("#js-project-status .js-detail").on('click', function () {

			var key = $(this).data('key');
			var projects_lists = [
				{label: 'ÄĂºng tiáº¿n Ä‘á»™', key: 'projects_ontrack', data: Dashboard.model.getStatObj("projects_ontrack")},
				{label: 'Cháº­m tiáº¿n Ä‘á»™', key: 'projects_offtrack', data: Dashboard.model.getStatObj("projects_offtrack")},
				{label: 'CĂ³ rá»§i ro cao', key: 'projects_atrisk', data: Dashboard.model.getStatObj("projects_atrisk")},
				{label: 'Dá»± Ă¡n thĂ nh cĂ´ng', key: 'projects_success', data: Dashboard.model.getStatObj("projects_success")},
				{label: 'Dá»± Ă¡n tháº¥t báº¡i', key: 'projects_failed', data: Dashboard.model.getStatObj("projects_failed")},
				{label: 'Dá»± Ă¡n bá»‹ há»§y', key: 'projects_canceled', data: Dashboard.model.getStatObj("projects_canceled")},
				{label: 'ÄĂ£ Ä‘Ă³ng', key: 'projects_closed', data: Dashboard.model.getStatObj("projects_closed")},
			];


			Base.load({
				header: "BĂ¡o cĂ¡o tá»•ng há»£p dá»± Ă¡n",
				id: 'report-detail-projects',
				width: 1200,
				html: '',
				render: function () {
					var title = "BĂ¡o cĂ¡o tá»•ng há»£p dá»± Ă¡n";
					var subtitle = "Tá»•ng sá»‘ <em>"+(Dashboard.model.getStat('real_projects'))+"</em> Dá»± Ă¡n &middot; "+(getFilteredTime())+"";

					showLoading(function() {
						$("#report-detail-projects").html("  " +Render.render('report_detail_total_projects', {lists:projects_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-projects").balance();
					});
				}
			});
		});


		$('#js-project-state-graph').highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true,
					innerSize:"80%"
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '9px'},
				enabled: false,
			},
			series: [{
				name: 'Dá»± Ă¡n',
				colorByPoint: true,
				data: [{
					name: "ÄĂºng tiáº¿n Ä‘á»™",
					y: Dashboard.model.getStat("projects_ontrack"),
					color: Color.get('ontrack')
				},{
					name: "Cháº­m tiáº¿n Ä‘á»™",
					y: Dashboard.model.getStat("projects_offtrack"),
					color: Color.get('offtrack')
				}, {
					name: "CĂ³ rá»§i ro cao",
					y: Dashboard.model.getStat("projects_atrisk"),
					color: Color.get('atrisk')
				},{
					name: "Dá»± Ă¡n thĂ nh cĂ´ng",
					y: Dashboard.model.getStat("projects_success"),
					color: Color.get('success')
				},{
					name: "Dá»± Ă¡n tháº¥t báº¡i",
					y: Dashboard.model.getStat("projects_failed"),
					color: Color.get('failed')
				}, {
					name: "Dá»± Ă¡n bá»‹ há»§y",
					y: Dashboard.model.getStat("projects_canceled"),
					color: Color.get('canceled')
				}]
			}]
		});
	};
	
	
	
	function initDeptReport() {

		$("#js-dept-report").html(AP.render(Dashboard.model.depts, function(e) {

			var icon = UI.textAvatar(e.obj.path);
			
			var content = safe(e.obj.content);
			if (!content) {
				content = "ChÆ°a cĂ³ miĂªu táº£";
			}
			
			return "<tr> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'>"+(icon)+"</div> <div class='name ap-xdot url' data-url='"+(e.obj.path)+"'><span class='url'>"+(e.obj.name)+"</span></div> <div class='info ap-xdot js-detail -detail' data-dept='"+(e.obj.id)+"' data-key='total'><em>Department</em> &middot; "+(e.stats.total)+" cĂ´ng viá»‡c</div> </div> </div> </td> <td> <div class='relative'> "+(mbar(e.stats, true))+" </div> </td> <td><span class='count js-detail -detail' data-dept='"+(e.obj.id)+"' data-key='done_ontime' style='color:"+(Color.get('success'))+"'>"+(e.stats.done_ontime)+"</span></td> <td><span class='count js-detail -detail' data-dept='"+(e.obj.id)+"' data-key='done_late' style='color:"+(Color.get('late'))+"'>"+(e.stats.done_late)+"</span></td> <td><span class='count js-detail -detail' data-dept='"+(e.obj.id)+"' data-key='overdue' style='color:"+(Color.get('overdue'))+"'>"+(e.stats.overdue)+"</span></td> <td><span class='count js-detail -detail' data-dept='"+(e.obj.id)+"' data-key='in_progress' style='color:"+(Color.get('doing'))+"'>"+(e.stats.in_progress)+"</span></td> <td><span class='count js-detail -detail' data-dept='"+(e.obj.id)+"' data-key='review' style='color:"+(Color.get('review'))+"'>"+(e.stats.review)+"</span></td> </tr>";
		}));


		$("#js-dept-report .js-detail").on('click', function () {

			var dept_id = $(this).data('dept');
			var key = $(this).data('key');

			var dept_data = ARR.findObj(Dashboard.model.depts, dept_id);
			var dept = Dashboard.model.get('depts', dept_id);

			var title = dept.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(dept_data.stats_obj.total.length)+"</em> cĂ´ng viá»‡c &middot; "+(getFilteredTime())+"";

			var depts_lists = [
				{label: 'HoĂ n thĂ nh Ä‘Ăºng háº¡n', key: 'done_ontime', data: dept_data.stats_obj.done_ontime},
				{label: 'HoĂ n thĂ nh muá»™n', key: 'done_late', data: dept_data.stats_obj.done_late},
				{label: 'QuĂ¡ háº¡n', key: 'overdue', data: dept_data.stats_obj.overdue},
				{label: 'Äang thá»±c hiá»‡n', key: 'in_progress', data: dept_data.stats_obj.in_progress},
				{label: 'Äang chá» Ä‘Ă¡nh giĂ¡', key: 'review', data: dept_data.stats_obj.review},
			];

			Base.load({
				header: "CĂ´ng viá»‡c theo department",
				id: 'report-detail-tasks',
				width: 1000,
				html: '',
				render: function () {

					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_total_tasks', {lists:depts_lists, title:title, subtitle:subtitle, key:key}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		
		
		var series = [{
			name: 'Táº¥t cáº£',
			color: '#48856c',
			data: Dashboard.model.timeSeries("depts", "total")
		}, {
			name: 'Äang thá»±c hiá»‡n',
			color: Color.get('doing'),
			data: Dashboard.model.timeSeries("depts", "in_progress")
		}, {
			name: 'HoĂ n thĂ nh',
			color: Color.get('success'),
			data: Dashboard.model.timeSeries("depts", "done")
		}, {
			name: 'QuĂ¡ háº¡n',
			color: Color.get('overdue'),
			data: Dashboard.model.timeSeries("depts", "overdue")
		}, {
			name: 'Äang chá» Ä‘Ă¡nh giĂ¡',
			color: Color.get('review'),
			data: Dashboard.model.timeAggregated("depts", "review")
		}
	];
		
		$('#js-dept-task-allocation').highcharts({
			chart: {
				type: 'column'
			},
			title: {
				text: '',
				style:{
					display:"none"
				}
			},
			xAxis: {
				categories: Dashboard.model.labels("depts")
			},
			yAxis: {
				title: {
					text: 'Sá»‘ lÆ°á»£ng cĂ´ng viá»‡c'
				}
			},
			credits: {
				enabled: false
			},
			series: series
		});
	};
	
	
	/**
	 * @desc Init milestone reports
	 */
	function initMilestoneReport() {

		$("#js-milestones-report").html(AP.render(Dashboard.model.milestones, function(e){
			if (!e.obj || !parseInt(e.obj.id)){
				return "";
			}
			
			var icon=UI.textAvatar(e.obj.name);
			var content=safe(e.obj.content);
			if (!content){
				content="ChÆ°a cĂ³ miĂªu táº£";
			}
			
			var u=People.get(e.obj.user_id);
			var color="#999";
			var complete=e.obj.complete;
			
			if (parseInt(e.obj.time)>AP.time.now()){
				color=Color.get("doing");
				
				if (parseFloat(complete)>=80){
					color=Color.get("done");	
				}
			}else{
				if (parseFloat(complete)<=50){
					color=Color.get("error");	
				}else if (parseFloat(complete)>=80){
					color=Color.get("done");	
				}
			}
			
			return "<tr> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'> <div class='js-percent' style='width:32px; height:32px;' data-text='"+(parseFloat(complete).toFixed(0))+"%' data-percent='"+(complete)+"' data-color='"+(color)+"'></div> </div> <div class='name ap-xdot url' data-url='milestone/"+(e.obj.id)+"'><span class='url'>"+(e.obj.name)+"</span></div> <div class='info ap-xdot'>"+(content)+"</div> </div> </div> </td> <td> <div class='wrapper' style='height:40px;'> <div class='obj'> <div class='icon'><div class='avatar'><img src='"+(AP.thumb(u.gavatar))+"'/></div></div> <div class='name ap-xdot'><span class='url ap-f13' data-username='"+(u.username)+"'>"+(u.name)+"</span></div> <div class='info ap-xdot'>"+(u.title)+"</div> </div> </td> <td> <span class='icon-base-increase'></span> <span class='count' style='color:"+(Color.get('success'))+"'>+"+(e.stats.done)+"</span>/<span class='count normal'>"+(e.stats.total)+"</span> </td> <td><div class='date' style='padding-top:3px; font-weight:500; color:"+(color)+"'>"+(AP.i18n.date(e.obj.time))+"</div></td> </tr>";
		}));
		
		$("#js-milestones-report .js-percent").each(function(){
			$(this).angular({
				arc: true,
				bg: "#eee"
			});
		});


		var stats = {done_ontime: Dashboard.model.getStat("tasks_done_ontime"), done_late: Dashboard.model.getStat("tasks_done_late"), in_progress: Dashboard.model.getStat("tasks_in_progress"), overdue: Dashboard.model.getStat("tasks_overdue")};
		
		$('#js-milestone-depts').css("height", $('#js-milestone-depts').width()*1.5);
		var data=AP.array.select(Dashboard.model.depts, function(e){
			return {name: e.obj.name+" ("+e.stats.milestones+" má»¥c tiĂªu)", y: e.stats.milestones};
		});
		
		$('#js-milestone-depts').highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
				style: {
					display:'none'
				}
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true
				}
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '11px'},
				enabled: true,
			},
			series: [{
				name: 'Má»¥c tiĂªu',
				colorByPoint: true,
				data: data
			}]
		});
		
		
		
		var top_finishers = Dashboard.model.milestone_people.sort(function(e, f) {
			return f.avg_complete - e.avg_complete;
		});


		$("#js-top-milestone-finishers").html(AP.render(top_finishers, function(e, index) {
			if (index >= 5) {
				return "";
			}

			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(e.user.gavatar))+"'/></div></div> <div class='name'><span class='url' data-username='"+(e.user.username)+"'>"+(e.user.name)+"</span></div> <div class='info js-detail -detail' data-user='"+(e.user.id)+"'><em>"+(e.count)+"</em> má»¥c tiĂªu phá»¥ trĂ¡ch</div> <div class='info js-detail -detail' data-user='"+(e.user.id)+"'><em>"+(e.avg_complete.toFixed(1))+"</em>% hoĂ n thĂ nh</div> </div>";
		}));


		$("#js-top-milestone-finishers .js-detail").on('click', function () {

			var user_id = $(this).data('user');
			var user = People.get(user_id);

			var user_data = ARR.findObj(Dashboard.model.milestone_people, user_id);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.milestones.length)+"</em> má»¥c tiĂªu &middot; "+(getFilteredTime())+"";

			Base.load({
				header: "Top hoĂ n thĂ nh má»¥c tiĂªu",
				id: 'report-detail-milestones',
				width: 800,
				html: '',
				render: function () {

					showLoading(function() {
						$("#report-detail-milestones").html("  " +Render.render('report_detail_milestones', {avatar:AP.xthumb(user.gavatar), milestones:user_data.milestones, title:title, subtitle:subtitle, percent:1}, '')+ '');
						AP.dialog.get("#report-detail-milestones").balance();
					});
				}
			});
		});
	};


	function initTagCloud() {

		var data = AP.array.select(Dashboard.model.tags, function(e) {
			return {name: e.id, weight: e.tasks.length};
		});


		$("#js-task-tagcloud").highcharts({
			plotOptions:{
				wordcloud:{
					minFontSize: 5,
					style: {
						fontWeight:500
					}
				}
			},
			series: [{
				type: 'wordcloud',
				data: data,
				name: 'CĂ´ng viá»‡c',
				rotation: {
					from: -60,
					to: 60,
					orientations: 5
				},
			}],
			title: {
				text: '',
				style:{
					display: "none"
				}
			}
		});
	};
	
	
	
	function initGridStats() {
		var html="<div class='note'>Chá»‰ tĂ­nh cĂ¡c cĂ´ng viá»‡c bĂ¡o cĂ¡o trong khoáº£ng thá»i gian Ä‘Æ°á»£c lá»±a chá»n</div> <div class='stat'> <div class='v'>"+(Dashboard.avg.weeklyTasks())+"</div> <span class='sub'>Sá»‘ cĂ´ng viá»‡c trung bĂ¬nh</span> <span>trĂªn má»™t tuáº§n</span> </div> <div class='stat'> <div class='v'>"+(Dashboard.avg.weeklyPersonalTasks())+"</div> <span class='sub'>Sá»‘ cĂ´ng viá»‡c trung bĂ¬nh hĂ ng tuáº§n</span> <span>trĂªn má»™t ngÆ°á»i</span> </div> <div class='stat'> <div class='v'>"+(Dashboard.avg.projectTasks())+"</div> <span class='sub'>Sá»‘ cĂ´ng viá»‡c trung bĂ¬nh</span> <span>trĂªn má»™t dá»± Ă¡n</span> </div> <div class='stat'> <div class='v'>"+(Dashboard.model.getStatDisplay('comments'))+"</div> <span class='sub'>Tá»•ng sá»‘ lÆ°á»£ng </span> <span>bĂ¬nh luáº­n</span> </div>";
		
		$("#js-grid-stats").html(html);
	}
	
	
	
	function initWorkloadReport() {

		var people_workloads = ARR.usort(Dashboard.model.people, function (a, b) {
			return parseInt(b.stats.duration) - parseInt(a.stats.duration);
		});
		var html = AP.render(people_workloads, function(p) {
			if (!p.obj) {
				return "";
			}
			
			return "<div class='item'> <div class='icon'><div class='avatar'><img src='"+(AP.xthumb(p.obj.gavatar))+"'/></div></div> <div class='name -short' title='"+(p.obj.name)+"'><span class='url' data-username='"+(p.obj.username)+"'>"+(p.obj.name)+"</span></div> <div class='info js-detail -detail' data-user='"+(p.obj.username)+"'>"+(p.stats.reported_total)+" cĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o</div> <div class='side'> <div class='bigcount'>"+(AP.data.numberFormat(p.stats.duration/3600))+"<span>h</span></div> </div> </div>";
		});
		
		$("#js-report-workloads").html("<div class='list'>"+(html)+"</div>");
		$("#js-report-workloads .item .js-detail").on('click', function () {

			var username = $(this).data('user');
			var user = People.get(username);

			var user_data = ARR.findObj(Dashboard.model.people, username);
			var title = user.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(user_data.stats_obj.reported_total.length)+"</em> cĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o &middot; "+(getFilteredTime())+"";

			Base.load({
				header: "BĂ¡o cĂ¡o thá»i gian lĂ m viá»‡c",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {avatar:AP.xthumb(user.gavatar), tasks:user_data.stats_obj.reported_total, title:title, subtitle:subtitle, key:key, duration:1}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					})
				}
			});
		});


		var project_workloads = ARR.usort(Dashboard.model.projects, function (a, b) {
			return parseInt(b.stats.duration) - parseInt(a.stats.duration);
		});

		html = AP.render(project_workloads, function(p) {
			if (!p.obj) {
				return "";
			}
			
			return "<div class='item'> <div class='icon'>"+(getIcon(p))+"</div> <div class='name -short' title='"+(p.obj.name)+"'><span class='url' data-url='"+(p.obj.path)+"'>"+(p.obj.name)+"</span></div> <div class='info js-detail -detail' data-project='"+(p.obj.id)+"'>"+(p.stats.reported_total)+" cĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o</div> <div class='side'> <div class='bigcount'>"+(AP.data.numberFormat(p.stats.duration/3600))+"<span>h</span></div> </div> </div>";
		});
		
		$("#js-report-project-workloads").html("<div class='list'>"+(html)+"</div>");
		$("#js-report-project-workloads .item .js-detail").on('click', function () {

			var project_id = $(this).data('project');

			var project_data = ARR.findObj(Dashboard.model.projects, project_id);
			var project = Dashboard.model.get('projects', project_id);

			var title = project.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(project_data.stats_obj.reported_total.length)+"</em> cĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o &middot; "+(getFilteredTime())+"";

			Base.load({
				header: "CĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o theo dá»± Ă¡n/phĂ²ng ban",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {tasks:project_data.stats_obj.reported_total, title:title, subtitle:subtitle, duration:1}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});


		var milestone_workloads = ARR.usort(Dashboard.model.milestones, function (a, b) {
			return parseInt(b.stats.duration) - parseInt(a.stats.duration);
		});

		html = AP.render(milestone_workloads, function(p) {
			if (!p.obj){
				return "";
			}
			
			return "<div class='item'> <div class='icon'></div> <div class='name -short' title='"+(p.obj.name)+"'><span class='url' data-url='milestone/"+(p.obj.id)+"'>"+(p.obj.name)+"</span></div> <div class='info js-detail -detail' data-milestone='"+(p.obj.id)+"'>"+(p.stats.reported_total)+" cĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o</div> <div class='side'> <div class='bigcount'>"+(AP.data.numberFormat(p.stats.duration/3600))+"<span>h</span></div> </div> </div>";
		});
		
		$("#js-report-ms-workloads").html("<div class='list'>"+(html)+"</div>");
		$("#js-report-ms-workloads .item .js-detail").on('click', function () {

			var milestone_id = $(this).data('milestone');

			var milestone_data = ARR.findObj(Dashboard.model.milestones, milestone_id);
			var milestone = Dashboard.model.get('milestones', milestone_id);

			var title = milestone.name;
			var subtitle = "Tá»•ng sá»‘ <em>"+(milestone_data.stats_obj.reported_total.length)+"</em> cĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o &middot; "+(getFilteredTime())+"";

			Base.load({
				header: "CĂ´ng viá»‡c Ä‘Ă£ bĂ¡o cĂ¡o theo má»¥c tiĂªu",
				id: 'report-detail-tasks',
				width: 800,
				html: '',
				render: function () {

					showLoading(function() {
						$("#report-detail-tasks").html("  " +Render.render('report_detail_tasks', {tasks:milestone_data.stats_obj.reported_total, title:title, subtitle:subtitle, duration:1}, '')+ '');
						AP.dialog.get("#report-detail-tasks").balance();
					});
				}
			});
		});
		
		
		
		// INIT WORKLOAD BY DEPARTMENTS
		
		var data=AP.select(Dashboard.model.depts, function(e){
			return {name: e.obj.name+ ": "+(AP.data.numberFormat(e.stats.duration/3600))+"h", y: e.stats.duration}
		});
				
		$('#js-report-dept-workloads .graph').css("height", $('#js-report-dept-workloads').width() * 1.5).highcharts({
			credits: {
				enabled: false
			},
			chart: {
				plotBackgroundColor: null,
				plotBorderWidth: null,
				plotShadow: false,
				type: 'pie',
				backgroundColor:'rgba(255, 255, 255, 0.0)',
			},
			title: {
				text: '',
				style: {fontSize: '13px', fontWeight: 'normal'},
				align: 'center',
				verticalAlign: 'middle',
			},
			tooltip: {
				pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
			},
			plotOptions: {
				pie: {
					allowPointSelect: true,
					cursor: 'pointer',
					dataLabels: {
						enabled: false
					},
					showInLegend: true
				},
			},
			legend:{
				itemStyle:{fontWeight: 'normal', fontSize: '12px'},
			},
			series: [{
				name: 'Reported hours',
				colorByPoint: true,
				data: data
			}]
		});
		
		
	};

	
	
	function legends(id, labels){
		var labels_html=AP.render(labels, function(e){
			return "<div class='legend'><span class='dot' style='background-color:"+(e.color)+"'></span> "+(e.label)+"</div>";
		});
		
		$(id).closest(".box").find(".header .side").append("<div class='ilegends'>"+(labels_html)+"</div>");
	};
	
	
	
	function mbar(stats, soft){
		var percent_in_progress=0;
		var percent_overdue=0;
		var percent_done_ontime=0;
		var percent_done_late=0;
		
		if (stats.total>0){
			percent_overdue=stats.overdue*100/stats.total;
			percent_in_progress=stats.in_progress*100/stats.total;
			percent_done_ontime=stats.done_ontime*100/stats.total;
			percent_done_late=stats.done_late*100/stats.total;
		}

		var done_ontime = 'HoĂ n thĂ nh Ä‘Ăºng háº¡n';
		var done_late = 'HoĂ n thĂ nh muá»™n';
		var overdue = 'QuĂ¡ háº¡n';
		var in_progress = 'Äang thá»±c hiá»‡n';
		
		if (soft){
			return "<div class='mbar clear-fix -soft'> <div class='b -infow' style='width:"+(percent_done_ontime)+"%; background-color:#8fc79c;'>"+(explain(done_ontime+': '+stats.done_ontime,true))+"</div> <div class='b -infow' style='width:"+(percent_done_late)+"%; background-color:#dbd491;'>"+(explain(done_late+': '+stats.done_late,true))+"</div> <div class='b -infow' style='width:"+(percent_overdue)+"%; background-color:#d1837d;'>"+(explain(overdue+': '+stats.overdue,true))+"</div> <div class='b -infow' style='width:"+(percent_in_progress)+"%; background-color:#a8d3f0;'>"+(explain(in_progress+': '+stats.in_progress,true))+"</div> </div>";
		}
		
		return "<div class='mbar clear-fix'> <div class='b -infow' style='width:"+(percent_done_ontime)+"%; background-color:"+(Color.get('success'))+";'>"+(explain(done_ontime+': '+stats.done_ontime,true))+"</div> <div class='b -infow' style='width:"+(percent_done_late)+"%; background-color:"+(Color.get('late'))+";'>"+(explain(done_late+': '+stats.done_late,true))+"</div> <div class='b -infow' style='width:"+(percent_overdue)+"%; background-color:"+(Color.get('overdue'))+";'>"+(explain(overdue+': '+stats.overdue,true))+"</div> <div class='b -infow' style='width:"+(percent_in_progress)+"%; background-color:"+(Color.get('doing'))+";'>"+(explain(in_progress+': '+stats.in_progress,true))+"</div> </div>";
	};
	
	
	
	function getIcon(e){
		if (!e.obj){
			return UI.textAvatar(e.id);
		}
		
		var icon="<img src='"+(Client.share_url)+"/fav_icons/"+(e.obj.icon)+".png'/>";
		
		if (!e.obj.icon){
			icon=UI.textAvatar(e.obj.path);
		}
		
		return icon;
	};
	


	function getFilteredTime () {

		if (Client.pageData.range) {
			return "Thá»i gian lá»c: "+(AP.time.time('%d/%m/%Y', Client.pageData.range.start))+" - "+(AP.time.time('%d/%m/%Y', Client.pageData.range.end))+"";
		} else {
			return  "Thá»i gian lá»c: Táº¥t cáº£";
		}
		
	};


	// Temporary
	function showLoading(callback) {

		callback();
		Render.finish();
	}
};


Dashboard.model = new function __DashboardModel() {

	this._people = {};
	this._assigners = {};
	this._projects = {};
	this._milestones = {};
	this._dept = {};
	this._tasks = {};
	this._daily = {};
	this._weekly = {};
	this._tags = {};

	this._milestone_people = {};
	
	this.stats = {};
	this.stats_obj = {};
	
	
	/**
	 * @desc Init data model, require O(n) operation
	 */
	this.init = function() {

		this._people = {};
		this._assigners = {};
		this._projects = {};
		this._depts = {};
		this._milestones = {};
		this._dept = {};
		this._tasks = {};
		
		this._daily = {};
		this._weekly = {};
		this._tags = {};

		this._milestone_people = {};
		
		this.stats = {};
		this.stats_obj = {};
		
		this.initFinder("projects", Client.pageData.projects);
		this.initFinder("depts", Client.depts);
		this.initFinder("tasks", Client.pageData.tasks);
		this.initFinder("milestones", Client.pageData.milestones);
		
		for (var i = 0; i < Client.pageData.tasks.length; i++) {
			var task = Client.pageData.tasks[i];
			
			task.project = this.get("projects", task.project_id);
			if (task.project) {
				task.dept = this.get("depts", task.project.dept_id);
			}
			
			if (task.project && task.project.metatype=="project") {
				this.increase("tasks_project", 1);
				this.increaseObj("tasks_project", task.id);
			}else if (task.project && task.project.metatype=="team") {
				this.increase("tasks_team", 1);
				this.increaseObj("tasks_team", task.id);
				if (parseInt(task.status)) {
					this.increase("tasks_team_done", 1);
					this.increaseObj("tasks_team_done", task.id);
				}else if (Compute.overdue(task)) {
					this.increase("tasks_team_overdue", 1);
					this.increaseObj("tasks_team_overdue", task.id);
				}
			}
			
			this.put(task, "people", task.username);
			this.put(task, "projects", task.project_id);
			this.put(task, "milestones", task.milestone_id);
			this.put(task, "assigners", task.creator_username);
			
			this.put(task, "daily", AP.time.beginOfDay(task.since));
			this.put(task, "weekly", AP.time.beginOfWeek(task.since));
			
			
			if (task.dept) {
				this.put(task, "depts", task.dept.id);
			}
			
			this.increase("tasks", 1);
			this.increaseObj("tasks", 1);
			var state = Task.ui.grandState(task);
			
			if (parseInt(task.status)) {
				this.increase("tasks_done", 1);
				this.increaseObj("tasks_done", task.id);
			} else {
				this.increase("tasks_active", 1);
				this.increaseObj("tasks_active", task.id);
			}
			
			if (!parseInt(task.deadline)){
				this.increase("tasks_no_deadline", 1);
				this.increaseObj("tasks_no_deadline", task.id);
			}
			
			if (state == "todo"){
				this.increase("tasks_todo", 1);
				this.increaseObj("tasks_todo", task.id);
			}else if (state=="doing"){
				this.increase("tasks_doing", 1);
				this.increaseObj("tasks_doing", task.id);
			}else{
				if (Compute.doneLate(task)){
					this.increase("tasks_done_late", 1);
					this.increaseObj("tasks_done_late", task.id);
				}else{
					this.increase("tasks_done_ontime", 1);
					this.increaseObj("tasks_done_ontime", task.id);
				}
			}
			
			
			if (parseInt(task.urgent) && !parseInt(task.important)) {
				this.increase("esn_10", 1);
				this.increaseObj("esn_10", task.id);
			} else if (!parseInt(task.urgent) && parseInt(task.important)) {
				this.increase("esn_01", 1);
				this.increaseObj("esn_01", task.id);
			} else if (parseInt(task.urgent) && parseInt(task.important)) {
				this.increase("esn_11", 1);
				this.increaseObj("esn_11", task.id);
			} else {
				this.increase("esn_00", 1);
				this.increaseObj("esn_00", task.id);
			}
			
			if (parseInt(task.review)) {
				this.increase("tasks_review", 1);
				this.increaseObj("tasks_review", task.id);
				if (Compute.overdue(task)) {
					this.increase("tasks_review_overdue", 1);
					this.increaseObj("tasks_review_overdue", task.id);
				}
			}
			
			if (Compute.overdue(task)) {
				this.increase("tasks_overdue", 1);
				this.increaseObj("tasks_overdue", task.id);
			} else if (!parseInt(task.status)) {
				this.increase("tasks_in_progress", 1);
				this.increaseObj("tasks_in_progress", task.id);
			}
			
			this.increase("comments", task.stats.comments);
			
			for (var j=0; j < task.tags.length; j++) {
				this.put(task, "tags", task.tags[j]);
			}
			
			if (parseInt(task.duration)) {
				this.increase("tasks_reported");
				this.increaseObj("tasks_reported", task.id);
				this.increase("tasks_duration", parseInt(task.duration));
			} else {
				this.increaseObj("tasks_unreported", task.id);
			}
		}


		// Custom stats
		for (var k in this._milestones) {
			var m = this._milestones[k];
			var obj = Dashboard.model.get("milestones", m.key);
			if (obj){
				this.customIncrease("depts", obj.dept_id, "milestones");
				this.customIncrease("people", obj.user_id, "milestones");	
			}
		}
		
		
		// Flatten data
		this.flatten("assigners", function(id){
			return People.get(id);
		});

		this.flatten("people", function(id){
			return People.get(id);
		});
		
		this.flatten("projects", function(id){
			return Dashboard.model.get("projects",id);
		});
		
		this.flatten("milestones", function(id){
			return Dashboard.model.get("milestones",id);
		});


		this.milestone_people = [];
		for (var i = 0; i < Dashboard.model.milestones.length; i++){
			var m = Dashboard.model.milestones[i];
			if (!m.obj){
				continue;
			}
			
			if (!this._milestone_people["k"+m.obj.user_id]) {
				this._milestone_people["k"+m.obj.user_id] = {id: m.obj.user_id, count:1, total: parseFloat(m.obj.complete), milestones: [m.id]};
			} else {
				this._milestone_people["k"+m.obj.user_id].count ++;
				this._milestone_people["k"+m.obj.user_id].total += parseFloat(m.obj.complete);
				this._milestone_people["k"+m.obj.user_id].milestones.push(m.id);
			}
		}

		for (var key in this._milestone_people) {

			this._milestone_people[key].user = People.get(this._milestone_people[key].id);
			this._milestone_people[key].avg_complete = 0;
			if (this._milestone_people[key].count) {
				this._milestone_people[key].avg_complete = this._milestone_people[key].total/this._milestone_people[key].count;
			}
			this.milestone_people.push(this._milestone_people[key]);
		}


		this.flatten("depts", function(id){
			return Dashboard.model.get("depts",id);
		});

		this.flatten("tags", function(id){
			return {id: id, label: id};
		});
		
		
		this.flatten("daily", function(id){
			return {id: parseInt(id)};
		});
		
		this.fillup("daily");
		
		this.flatten("weekly", function(id){
			return {id: parseInt(id)};
		});
		
		this.fillup("weekly", 7);

		// COMPUTE COUNTERS

		var milestones_in_progress = ARR.select(ARR.filter(this.milestones, function (e) {
			return e.obj  && (parseInt(e.obj.time) > AP.time.now())
		}), function (e) {
			return e.id;
		});

		this.set("milestones_in_progress", milestones_in_progress.length);
		this.setObj("milestones_in_progress", milestones_in_progress);


		var milestones_completed = ARR.select(ARR.filter(this.milestones, function (e) {
			return e.obj  &&  (parseInt(e.obj.time) <= AP.time.now())
		}), function (e) {
			return e.id;
		});

		this.set("milestones_completed", milestones_completed.length);
		this.setObj("milestones_completed", milestones_completed);

		this.set("milestones", milestones_completed.length + milestones_in_progress.length);

		this.set("people", AP.array.count(this.people, function(e){
			return e.obj && !e.obj.error;
		}));

		
		for (var i=0; i<this.projects.length; i++){
			var p = this.projects[i].obj;
			if (!p || p.metatype!="project"){
				continue;
			}
			
			this.increase("real_projects");
			this.increaseObj("real_projects", p.id);
			if (!parseInt(p.external)){
				this.increase("real_projects_internal");
				this.increaseObj("real_projects_internal", p.id);
			}else{
				this.increase("real_projects_external");
				this.increaseObj("real_projects_external", p.id);
			}
			
			if (!parseInt(p.status)){
				if (p.stage=="offtrack"){
					this.increase("projects_offtrack");
					this.increaseObj("projects_offtrack", p.id);
				}else if (p.stage=="atrisk"){
					this.increase("projects_atrisk");
					this.increaseObj("projects_atrisk", p.id);
				}else{
					this.increase("projects_ontrack");
					this.increaseObj("projects_ontrack", p.id);
				}
			}else{
				if (p.stage=="failed"){
					this.increase("projects_failed");
					this.increaseObj("projects_failed", p.id);
				}else if (p.stage=="success"){
					this.increase("projects_success");
					this.increaseObj("projects_success", p.id);
				}else if (p.stage=="canceled"){
					this.increase("projects_canceled");
					this.increaseObj("projects_canceled", p.id);
				}else{
					this.increase("projects_closed");
					this.increaseObj("projects_closed", p.id);
				}
			}
		}
		
		
		this.set("real_teams", AP.array.count(this.projects, function(e){
			return e.obj && e.obj.metatype=="team";
		}));
		

		var real_teams_internal = AP.array.filter(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && !parseInt(e.obj.external);
		});
		var real_teams_internal_ids = ARR.select(real_teams_internal, function (e) {
			return e.id;
		});
		this.set("real_teams_internal", real_teams_internal_ids.length);
		this.setObj("real_teams_internal", real_teams_internal_ids);


		var real_teams_external = AP.array.filter(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && parseInt(e.obj.external);
		});
		var real_teams_external_ids = ARR.select(real_teams_external, function (e) {
			return e.id;
		});
		this.set("real_teams_external", real_teams_external_ids.length);
		this.setObj("real_teams_external", real_teams_external_ids);


		var real_teams_active = AP.array.filter(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && parseInt(e.obj.status)==0;
		});
		var real_teams_active_ids = ARR.select(real_teams_active, function (e) {
			return e.id;
		});
		this.set("real_teams_active", real_teams_active_ids.length);
		this.setObj("real_teams_active", real_teams_active_ids);


		var real_teams_closed = AP.array.filter(this.projects, function(e){
			return e.obj && e.obj.metatype=="team" && parseInt(e.obj.status)==-1;
		});
		var real_teams_closed_ids = ARR.select(real_teams_closed, function (e) {
			return e.id;
		});
		this.set("real_teams_closed", real_teams_closed_ids.length);
		this.setObj("real_teams_closed", real_teams_closed_ids);


		var people_internal = AP.array.filter(this.people, function(e){
			return e.obj && !e.obj.error && e.obj.metatype!="guest";
		});
		var people_internal_ids = ARR.select(people_internal, function (e) {
			return e.id;
		});
		this.set("people_internal", people_internal_ids.length);
		this.setObj("people_internal", people_internal_ids);


		var people_guest = AP.array.filter(this.people, function(e){
			return e.obj && !e.obj.error && e.obj.metatype=="guest";
		});
		var people_guest_ids = ARR.select(people_guest, function (e) {
			return e.id;
		});
		this.set("people_guest", people_guest_ids.length);
		this.setObj("people_guest", people_guest_ids);
		
		this.set("projects", this.projects.length);
		this.setObj("projects", ARR.select(this.projects, function (e) {
			return e.id;
		}));


		var projects_require_review = AP.array.filter(this.projects, function(e){
			return e.obj && parseInt(e.obj.review_enabled);
		});
		var projects_require_review_ids = ARR.select(projects_require_review, function (e) {
			return e.id;
		});
		this.set("projects_require_review", projects_require_review_ids.length);
		this.setObj("projects_require_review", projects_require_review_ids);
		
		// Resort for friendlier display
		this.people.sort(function(e,f){
			if (!parseInt(f.obj.id)){
				return -1;
			}
			
			if (!parseInt(e.obj.id)){
				return 1;
			}
			
			return f.tasks.length-e.tasks.length;
		});
		
		this.projects.sort(function(e,f){
			return f.tasks.length-e.tasks.length;
		});
		
		this.milestones.sort(function(e,f){
			if (e.obj && f.obj){
				return parseInt(f.obj.time)-parseInt(e.obj.time);	
			}
			
			return 0;
		});
		
		
		// Fix for local stats
		this.stats.tasks_duration = (this.getStat("tasks_duration")/3600).toFixed(1);
		this.stats.tasks_unreported = this.getStat("tasks") - this.getStat("tasks_reported");
		if (Client.pageData.context && this.daily.length) {
			this.stats.project_days = (this.daily[this.daily.length-1].id-this.daily[0].id)/(24*3600)+1;
			var holidays = 0;
			var starter = this.daily[0].id;
			while (true) {
				var test = new Date(starter*1000);
				if (test.getDay() == 6 || test.getDay() == 0) {
					holidays++;
				}
				
				starter += 24*3600;
				if (starter >= this.daily[this.daily.length-1].id || holidays >= 1000) {
					break;
				}
			}
			
			this.stats.project_holidays = holidays;
			this.stats.project_working_days = this.stats.project_days - holidays;
		}
	};
	
	
	/**
	 * @desc Getting stat about a key
	 */
	this.getStat = function(key){
		if (this.stats[key]){
			return this.stats[key];
		}
		
		return 0;
	};


	/**
	 * @desc Getting stat objs about a key
	 */
	this.getStatObj = function(key) {
		if (this.stats_obj[key]) {
			return this.stats_obj[key];
		}
		
		return [];
	};
	
	
	this.getStatDisplay=function(key){
		return AP.data.numberFormat(this.getStat(key));
	};
	
	
	this.getTop=function(set, limit, cmp){
		var chosen={};
		
		for (var i=0; i<limit; i++){
			var max=-10000;
			var found=-1;
			
			for (var j=0; j<this[set].length; j++){
				if (chosen["k"+j]){
					continue;
				}
				
				var temp=cmp(this[set][j]);
				if (!temp){
					continue;
				}
				
				if (temp>max){
					max=temp;
					found=j;
				}
			}
			
			if (found>-1){
				chosen["k"+found]=found+1;
			}
			
		}
		
		
		var r = [];
		for (var key in chosen) {
			r.push(this[set][chosen[key]-1]);
		}
		
		return r;
	};
	
	
	
	/**
	 * Push a task into key with value 
	 * Example : milestone A or project B
	 * @param {*} task 
	 * @param {*} key 
	 * @param {*} value 
	 */
	this.put=function(task, key, value){
		if (this["_"+key]["k"+value]){
			this["_"+key]["k"+value].tasks.push(task);
		}else{
			this["_"+key]["k"+value]={key: value, tasks: [task], stats: {milestones: 0}};
		}
	};



	this.getObj = function (key, value) {
		return this["_"+key]["k"+value];
	};
	
	
	/**
	 * Flatten from object with keys to array
	 * @param {*} key 
	 * @param {*} getter 
	 * @returns 
	 */
	this.flatten = function(key, getter) {
		var r = [];
		
		for (var index in this["_"+key]){
			var objkey = this["_"+key][index].key;
			
			// if (parseInt(objkey)) {
			if (objkey) {
				var objreal = getter(objkey);
				var obj={id: objkey, obj: objreal, stats_obj: getStatsObj(this["_"+key][index].tasks), stats: getStats(this["_"+key][index].tasks), tasks: this["_"+key][index].tasks};
				
				for (var rk in this["_"+key][index].stats){
					obj.stats[rk]=this["_"+key][index].stats[rk];
				}
				
				r.push(obj);
			}
		}
		
		this[key] = r;
		return r;
	};
	
	
	/**
	 * @desc Fill in the gap betweens missing date
	 */
	this.fillup = function(key, space) {
		if (!space) {
			space = 1;
		}
		
		this[key].sort(function(e,f) {
			return f.id - e.id;
		});
		
		if (!this[key].length) {
			return;
		}
		
		this[key] = this[key].reverse();
		return;
	};
	
	
	this.increaseObj = function (key, id) {

		if (!this.stats_obj[key]) {
			this.stats_obj[key] = [];
		}

		this.stats_obj[key].push(id);
	};

	
	this.increase = function(key, val) {
		if (!val){
			val=1;
		}
		
		if (this.stats[key]) {
			this.stats[key] += val;
		}else{
			this.stats[key] = val;
		}
	};
	
	
	this.set = function(key, val) {
		if (!val){
			val=0;
		}
		
		this.stats[key]=val;
	};


	this.setObj = function (key, val) {

		this.stats_obj[key] = val;
	};
	
	
	
	/**
	 * @desc Increase a stat $sat for a set $set
	 */
	this.customIncrease = function(set, id, stat) {

		if (this["_"+set]["k"+id]) {
			this["_"+set]["k"+id].stats[stat]++;;
		}
	};
	
	
	
	/**
	 * @desc Init cache for O(1) finders
	 */
	this.initFinder = function(key, arr) {

		this["__" + key] = {};
		for (var i=0; i<arr.length; i++){
			this["__"+key]["k"+arr[i].id]=arr[i];
		}
	};
	
	
	this.get=function(key, id){
		if (this["__"+key] && this["__"+key]["k"+id]){
			return this["__"+key]["k"+id];
		}
		
		return null;
	};
	
	
	/**
	 * @desc Build up a time series
	 */
	this.timeSeries=function(key, field){
		var r=[];
		for (var i=0; i<this[key].length; i++){
			var val=this[key][i].stats[field];
			r.push(val);
		}
		
		return r;
	};
	
	
	/**
	 * @desc Build up an aggregating series
	 */
	this.timeAggregated=function(key, field){
		var r=[];
		var cur=0;
		
		for (var i=0; i<this[key].length; i++){
			var val=this[key][i].stats[field];
			cur+=val;
			r.push(cur);
		}
		
		return r;
	};
	
	
	this.timeLabels=function(key, space){
		var r=[];
		for (var i=0; i<this[key].length; i++){
			if (space){
				r.push(AP.time.time("%d", this[key][i].id)+"-"+AP.time.time("%d/%m", this[key][i].id+space*24*3600));	
			}else{
				r.push(AP.time.time("%d/%m", this[key][i].id));
			}
		}
		
		return r;
	};
	
	
	/**
	 * @desc Simple label collectors
	 */
	this.labels = function(key) {
		var r=[];
		for (var i=0; i < this[key].length; i++) {
			if (!this[key][i].obj) {
				r.push("ChÆ°a xĂ¡c Ä‘á»‹nh");
			}else{
				r.push(this[key][i].obj.name);	
			}
		}
		
		return r;
	};


	function getStatsObj(tasks) {

		var stats = emptyStatsObj();
		stats.total = ARR.select(tasks, function (task) {
			return task.id;
		});
		
		for (var i = 0; i < tasks.length; i++) {
			var task = tasks[i];
			var is_done = (parseInt(task.status)==1);
			var state = Task.ui.grandState(task);

			if (!task.username) {
				stats.unassign.push(task.id);
			}
			
			if (is_done) {
				stats.done.push(task.id);
				if (Compute.doneLate(task)) {
					stats.done_late.push(task.id);
				} else {
					stats.done_ontime.push(task.id);
				}
			} else {
				stats.active.push(task.id);
				if (state == "todo") {
					stats.todo.push(task.id);
				} else {
					stats.doing.push(task.id);
				}
				
				if (parseInt(task.review)) {
					stats.review.push(task.id);
				}
				
				if (Compute.overdue(task)) {
					stats.overdue.push(task.id);
				} else { 
					stats.in_progress.push(task.id);
				}
			}
			
			if (parseFloat(task.duration) > 0.01 ) {
				stats.reported_total.push(task.id);
			}
		}
		
		return stats;
	};


	function getStats(tasks) {
		var stats = emptyStats();
		stats.total = tasks.length;
		
		for (var i = 0; i < tasks.length; i++) {
			var task = tasks[i];
			var is_done = (parseInt(task.status)==1);
			var state = Task.ui.grandState(task);

			if (!task.username) {
				stats.unassign ++;
			}
			
			if (is_done) {
				stats.done++;
				if (Compute.doneLate(task)) {
					stats.done_late++;
				} else {
					stats.done_ontime++;
				}
			} else {
				stats.active++;
				if (state=="todo") {
					stats.todo++;
				} else {
					stats.doing++;
				}
				
				if (parseInt(task.review)) {
					stats.review++;
				}
				
				if (Compute.overdue(task)) {
					stats.overdue++;
				} else {
					stats.in_progress++;
				}
			}
			
			stats.duration += parseFloat(task.duration);
			if (parseFloat(task.duration) > 0.01) {
				stats.reported_total++;
			}
		}
		
		return stats;
	};
	
	
	function emptyStats() {
		return {total: 0, reported_total:0, done: 0, done_late:0, done_ontime:0, in_progress:0, overdue:0, todo:0, doing:0, active: 0, review:0, duration: 0, unassign: 0};
	};


	function emptyStatsObj() {
		return {total: [], reported_total: [], done: [], done_late:[], done_ontime:[], in_progress:[], overdue:[], todo:[], doing:[], active: [], review: [], unassign: []};
	}
};


Dashboard.avg=new function __DashboardAVG(){
	this.weeklyTasks=function(){
		var total=0;
		for (var i=0; i<Dashboard.model.daily.length; i++){
			total+=Dashboard.model.daily[i].stats.total;
		}
		
		return (7*total/Dashboard.model.daily.length).toFixed(1);
	};
	
	
	this.weeklyPersonalTasks=function(){
		var people=AP.array.filter(Dashboard.model.people, function(e){
			return e.obj && e.obj.id;
		});
		
		if (!people.length){
			return 0;
		}
		
		
		return (this.weeklyTasks()/people.length).toFixed(1);
	};
	
	
	this.projectTasks=function(){
		if (!Dashboard.model.stats.real_projects){
			return 0;
		}
		
		return (Dashboard.model.stats.tasks_project/Dashboard.model.stats.real_projects).toFixed(1);
	};
	
	
	this.teamWeeklyTasks=function(){
		return 0;
	};
	
	this.weeklyWorkload=function(){
		return 0;
	};
	
	this.medianWeeklyWorkload=function(){
		return 0;
	};
	
	
	
	function median(set, key){
		return 0;
	};
	
};



Dashboard.export = new function __DashboardExport(){

	this.members = function(){
		AP.confirm("Xuáº¥t bĂ¡o cĂ¡o excel cĂ´ng viá»‡c Ä‘Æ°á»£c giao theo thĂ nh viĂªn?", function () {
			var headers = ["ThĂ nh viĂªn", "Email", "CĂ´ng viá»‡c Ä‘Æ°á»£c giao", "HoĂ n thĂ nh Ä‘Ăºng háº¡n", "HoĂ n thĂ nh muá»™n", "QuĂ¡ háº¡n", "Äang thá»±c hiá»‡n", "Äang chá» Ä‘Ă¡nh giĂ¡"];
			var rows = [];

			for (var i = 0; i < Dashboard.model.people.length; i++) {
				var p = Dashboard.model.people[i];

				var name = p.obj.name;
				var email = p.obj.email;

				rows.push([name, email, p.stats.total, p.stats.done_ontime, p.stats.done_late, p.stats.overdue, p.stats.in_progress, p.stats.review]);
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: "NgÆ°á»i thá»±c hiá»‡n"
			});
		});
	};


	this.assigners = function(){
		AP.confirm("Xuáº¥t bĂ¡o cĂ¡o excel cĂ´ng viá»‡c Ä‘Ă£ táº¡o theo thĂ nh viĂªn?", function () {
			var headers = ["ThĂ nh viĂªn", "Email", "ChÆ°a giao", "CĂ´ng viá»‡c Ä‘Ă£ táº¡o", "HoĂ n thĂ nh Ä‘Ăºng háº¡n", "HoĂ n thĂ nh muá»™n", "QuĂ¡ háº¡n", "Äang thá»±c hiá»‡n", "Äang chá» Ä‘Ă¡nh giĂ¡"];
			var rows = [];

			for (var i = 0; i < Dashboard.model.assigners.length; i++) {
				var p = Dashboard.model.assigners[i];

				var name = p.obj.name;
				var email = p.obj.email;

				rows.push([name, email, p.stats.unassign, p.stats.total, p.stats.done_ontime, p.stats.done_late, p.stats.overdue, p.stats.in_progress, p.stats.review]);
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: "NgÆ°á»i giao"
			});
		});
	};


	this.projects = function(){
		AP.confirm("Xuáº¥t bĂ¡o cĂ¡o excel theo dá»± Ă¡n & phĂ²ng ban?", function () {
			var headers = ["Dá»± Ă¡n &amp; phĂ²ng ban", "CĂ´ng viá»‡c", "HoĂ n thĂ nh", "QuĂ¡ háº¡n", "Äang thá»±c hiá»‡n", "Äang chá» Ä‘Ă¡nh giĂ¡"];
			var rows = [];

			for (var i = 0; i < Dashboard.model.projects.length; i++) {
				var e = Dashboard.model.projects[i];

				rows.push([e.obj.name, e.stats.total, e.stats.done, e.stats.overdue, e.stats.in_progress, e.stats.review]);
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: "Dá»± Ă¡n &amp; phĂ²ng ban"
			});
		});
	};


	this.depts = function() {

		AP.confirm("Export excel department report?", function () {
			var headers = ["Department", "CĂ´ng viá»‡c", "HoĂ n thĂ nh", "QuĂ¡ háº¡n", "Äang thá»±c hiá»‡n", "Äang chá» Ä‘Ă¡nh giĂ¡"];
			var rows = [];

			for (var i = 0; i < Dashboard.model.depts.length; i++) {
				var e = Dashboard.model.depts[i];

				rows.push([e.obj.name, e.stats.total, e.stats.done, e.stats.overdue, e.stats.in_progress, e.stats.review]);
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: "Department"
			});
		});
	};


	this.detailTasks = function (task_ids, label, duration, department, project) {


		var warning = "Xuáº¥t cĂ´ng viá»‡c ra excel";
		if (task_ids.length > 3000) {
			warning = "Há»— trá»£ export tá»‘i Ä‘a 3000 cĂ´ng viá»‡c";
		}

		AP.confirm(warning, function () {

			var headers = [
				"NgĂ y táº¡o",
				"TĂªn cĂ´ng viá»‡c",
				"NgÆ°á»i thá»±c hiá»‡n",
				"Username ngÆ°á»i thá»±c thi",
				"NgÆ°á»i táº¡o",
				"Username ngÆ°á»i táº¡o",
				"Thá»i háº¡n",
				"Tráº¡ng thĂ¡i",
				"Dá»± Ă¡n/phĂ²ng ban",
				"Department",
				"MĂ£ cĂ´ng viá»‡c (ID)",
				"Link"
			];

			if (duration) {
				var headers = [
					"NgĂ y táº¡o",
					"TĂªn cĂ´ng viá»‡c",
					"NgÆ°á»i thá»±c hiá»‡n",
					"Username ngÆ°á»i thá»±c thi",
					"NgÆ°á»i táº¡o",
					"Username ngÆ°á»i táº¡o",
					"Thá»i háº¡n",
					"Khoáº£ng thá»i gian thá»±c hiá»‡n",
					"Tráº¡ng thĂ¡i",
					"Dá»± Ă¡n/phĂ²ng ban",
					"Department",
					"MĂ£ cĂ´ng viá»‡c (ID)",
					"Link"
				];
			}

			var list_tasks = ARR.usort(task_ids, function (a, b) {

				var task_a = Dashboard.model.get('tasks', a);
				var task_b = Dashboard.model.get('tasks', b);
		
				if (task_b && task_a) {
		
					var cmp = 0;
		
					if (duration) {
						cmp = parseInt(task_b.duration) - parseInt(task_a.duration);
					} else {
						cmp = parseInt(task_b.deadline) - parseInt(task_a.deadline);
					}
		
					if (cmp) {
						return cmp;
					}
		
					return parseInt(task_b.since) - parseInt(task_a.since);
				}
		
				return 0;
			});

			var rows = [];

			var list_tasks = list_tasks.slice(0, 3000) ;



			for (var i = 0; i < list_tasks.length; i++) {

				var task = Dashboard.model.get('tasks', list_tasks[i]);
				if (task) {

					var user = People.get(task.user_id);
					var creator = People.get(task.creator_id);

					var project = Dashboard.model.get('projects', task.project_id);
					var dept = project ? Dashboard.model.get('depts', project.dept_id) : null;

					if (duration) {
						rows.push([
							AP.time.time('%d/%m/%Y %H:%i', task.since),
							task.name,
							user.uid ? user.name : '',
							user.uid ? user.username : '',
	
							creator.uid ? creator.name : '',
							creator.uid ? creator.username : '',
	
							task.deadline && parseInt(task.deadline) ? AP.time.time('%d/%m/%Y %H:%i', task.deadline) : '',
							task.duration && parseInt(task.duration) ?  AP.data.numberFormat(parseInt(task.duration)/3600): '',
	
							getStatusText(task),
	
							project ? project.name: "Unknown", 
							dept ? dept.name : "ChÆ°a phĂ¢n loáº¡i",
							
							task.id,
							getTaskLink(task)
						]);
					} else {
						rows.push([
							AP.time.time('%d/%m/%Y %H:%i', task.since),
							task.name,
							user.uid ? user.name : '',
							user.uid ? user.username : '',
	
							creator.uid ? creator.name : '',
							creator.uid ? creator.username : '',
	
							task.deadline && parseInt(task.deadline) ? AP.time.time('%d/%m/%Y %H:%i', task.deadline) : '',
	
							getStatusText(task),
	
							project ? project.name: "Unknown", 
							dept ? dept.name : "ChÆ°a phĂ¢n loáº¡i",
							
							task.id,
							getTaskLink(task)
						]);
					}


				}
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: label
			});
		});
	};


	this.detailMilestones = function (milestone_ids, label) {

		AP.confirm("Xuáº¥t má»¥c tiĂªu ra excel?", function () {

			var headers = [
				"NgĂ y táº¡o", 
				"TĂªn má»¥c tiĂªu",
				"Dá»± Ă¡n/phĂ²ng ban",
				"NgÆ°á»i chá»‹u trĂ¡ch nhiá»‡m",
				"Username cá»§a ngÆ°á»i chá»‹u trĂ¡ch nhiá»‡m",
				"Department",
				"NgĂ y hoĂ n thĂ nh má»¥c tiĂªu",
				"Milestone ID"
			];

			var list_milestones = ARR.usort(milestone_ids, function (a, b) {

				var milestone_a = Dashboard.model.get('milestones', a);
				var milestone_b = Dashboard.model.get('milestones', b);
	
				if (milestone_b && milestone_a) {
					return parseInt(milestone_b.time) - parseInt(milestone_a.time);
				}
	
				return 0;
			});

			var rows = [];

			for (var i = 0; i < list_milestones.length; i++) {

				var milestone = Dashboard.model.get('milestones', list_milestones[i]);
				var project = Dashboard.model.get('projects', milestone.project_id);
				var pic = People.get(milestone.user_id);

				var dept = project ? Dashboard.model.get('depts', milestone.dept_id) : '';

				if (milestone) {

					var milestone_date = parseInt(milestone.time) ? ""+(AP.time.time('%d/%m/%Y %H:%i', milestone.time))+"" : '';

					rows.push([
						AP.time.time('%d/%m/%Y %H:%i', project.since),
						milestone.name,
						project ? project.name : "Unknown",
						pic.uid ? pic.name : '',
						pic.uid ? pic.username : '',
						dept ? dept.name : 'ChÆ°a phĂ¢n loáº¡i',
						milestone_date,
						milestone.id,
					]);
				}
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: label
			});
		});
	};


	this.detailProjects = function (project_ids, label) {

		AP.confirm("Xuáº¥t dá»± Ă¡n/phĂ²ng ban ra excel?", function () {

			var headers = [
				"NgĂ y táº¡o", 
				"TĂªn dá»± Ă¡n/phĂ²ng ban",
				"NgÆ°á»i quáº£n lĂ½",
				"Department",
				"Project/Team ID",
				"Link"
			];
			var rows = [];

			var list_projects = ARR.usort(project_ids, function (a, b) {

				var project_a = Dashboard.model.get('projects', a);
				var project_b = Dashboard.model.get('projects', b);
		
				if (project_b && project_a) {
					return parseInt(project_b.since) - parseInt(project_a.since);
				}
		
				return 0;
			});

			for (var i = 0; i < list_projects.length; i++) {

				var project = Dashboard.model.get('projects', list_projects[i]);
				if (project) {

					var dept = Dashboard.model.get('depts', project.dept_id);

					rows.push([
						AP.time.time('%d/%m/%Y %H:%i', project.since),
						project.name,
						ARR.select(project.owners, function(e) {return e.username}).join(','),
						dept ? dept.name : 'ChÆ°a phĂ¢n loáº¡i',
						project.id,
						getProjectLink(project)
					]);
				}
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: label
			});
		});
	};


	this.detailTotalMembers = function (list_usernames, title) {

		AP.confirm("Xuáº¥t thĂ nh viĂªn ra excel?", function () {

			var headers = [
				"TĂªn",
				"Username",
				"Chá»©c vá»¥",
			];
			var rows = [];

			for (var i = 0; i < list_usernames.length; i++) {

				var user = People.get(list_usernames[i]);
				var user_title = user.title ? user.title : "ChÆ°a cĂ³ vá»‹ trĂ­";

				rows.push([
					user.name,
					user.username,
					user_title
				]);
			}

			Base.io.exp({
				headers: headers,
				rows: rows,
				title: title
			});
		});
	};



	function getTaskLink(task) {

		return ""+(Client.url)+"/home?task="+(task.id)+"";
	};


	function getProjectLink(project) {

		return ""+(Client.url)+"/"+(project.path)+"";
	};


	function getStatusText(task) {

		if (parseInt(task.status)) {
			if (Compute.doneLate(task)) {
				return "HoĂ n thĂ nh muá»™n";
			} else {
				return "HoĂ n thĂ nh Ä‘Ăºng háº¡n";
			}
		} else {
			if (Compute.overdue(task)) {
				return "QuĂ¡ háº¡n";
			} else {
				return "Äang thá»±c hiá»‡n";
			}
		}
	};
};


Dashboard.model.quickSort = function (items, left, right, cmp) {

    var index;
    if (items.length > 1) {
        index = Dashboard.model.partition(items, left, right, cmp); //index returned from partition
        if (left < index - 1) { //more elements on the left side of the pivot
            Dashboard.model.quickSort(items, left, index - 1, cmp);
        }
        if (index < right) { //more elements on the right side of the pivot
            Dashboard.model.quickSort(items, index, right, cmp);
        }
    }

    return items;
};


Dashboard.model.partition = function (items, left, right, cmp) {

	var pivot = items[Math.floor((right + left) / 2)]; //middle element
	var i = left; //left pointer
	var j = right; //right pointer
	while (i <= j) {

		while (cmp(items[i], pivot) < 0) {
			i++;
		}

		while (cmp(items[j], pivot) > 0) {
			j--;
		}

		if (i <= j) {
			var tmp = items[i];
			items[i] = items[j];
			items[j] = tmp;
			//swap two elements
			i++;
			j--;
		}
	}
	return i;
};

// TASKS
Render.on("report-detail-tasks", function () {

	var that = this;
	var duration = this.duration;
	var project = !Client.pageData.context;
	var department = !Client.pageData.department;

	var list_tasks = Dashboard.model.quickSort(this.tasks, 0, this.tasks.length - 1, function (a, b) {

		var task_a = Dashboard.model.get('tasks', a);
		var task_b = Dashboard.model.get('tasks', b);

		if (task_b && task_a) {

			var cmp = 0;

			if (duration) {
				cmp = parseInt(task_b.duration) - parseInt(task_a.duration);
			} else {
				cmp = parseInt(task_b.deadline) - parseInt(task_a.deadline);
			}

			if (cmp) {
				return cmp;
			}

			return parseInt(task_b.since) - parseInt(task_a.since);
		}

		return 0;
	});

	var ipp = 20;
	var renderItems = function (items, page) {

		if (!page) {
			page = 1;
		}

		var header = "  " +Render.render('report_detail_task_table_header', {duration:duration}, '')+ '';
		var list = AP.render(items, function (task_id, index) {

			var task = Dashboard.model.get('tasks', task_id);
			if (task) {
	
				var task_html = "  " +Render.render('report_detail_task', {project:project, department:department, duration:duration, order:(page - 1) * ipp + index+1, task:task}, '')+ '';
				return task_html;
			}
	
			return '';
		});

		if (!items.length) {
			list = "  " +Render.render('empty', {icon: "edge task" , sm:1}, "KhĂ´ng cĂ³ cĂ´ng viá»‡c nĂ o")+ '';
		} else {
			list = "  " +Render.render('table', {}, ""+(header)+" <tbody>"+(list)+"</tbody>")+ '';
		}

		return list;
	};


	var filterItems = function (items, page, q) {
		var filtered_items = ARR.filter(items, function (task_id) {

			if (!q) {
				return true;
			}

			var task = Dashboard.model.get('tasks', task_id);
			if (!task) {
				return false;
			}

			var user = People.get(task.user_id);
			var title = user.name + task.name;

			return AP.word.fulltextMatch(title, q);

		});

		if (page != 'all') {
			filtered_items = filtered_items.slice(Math.max(0, page - 1) * ipp, (Math.max(0, page - 1) + 1) * ipp);
		}
		
		return filtered_items;
	};


	var exportItems = function (items) {
		return Dashboard.export.detailTasks(items, that.title, that.duration);
	};


	var icon = this.icon ? this.icon : "edge task";
	var cover = "  " +Render.render('display_cover', {icon:icon, sm:1}, '' +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ '';

	if (this.avatar) {
		cover = "  " +Render.render('display_cover', {sm:1, avatar:1}, '' +Render.render('avatar', {src:this.avatar}, '')+ " " +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ '';
	}

	var html = "<div "+(this.show('id'))+"> " +Render.render('display_obj', {_class: "report-detail-tasks report-dialog" , dialog:1}, ""+(cover)+" " +Render.render('display_section', {}, '' +Render.render('report_detail_paginate', {items:list_tasks, renderItems:renderItems, filterItems:filterItems, exportItems:exportItems}, '')+ '')+ '')+ "</div>";

	return html;
}, function (params, obj) {

});


Render.on("report-detail-total-tasks", function () {

	var lists = this.lists;
	var duration = this.duration;
	var project = !Client.pageData.context;
	var department = !Client.pageData.department;

	var lists_html = AP.render(lists, function (list) {

		var ipp = 20;
		var renderItems = function (items, page) {
	
			if (!page) {
				page = 1;
			}
	
			var header = "  " +Render.render('report_detail_task_table_header', {duration:duration}, '')+ '';
			var list = AP.render(items, function (task_id, index) {
	
				var task = Dashboard.model.get('tasks', task_id);
				if (task) {
		
					var task_html = "  " +Render.render('report_detail_task', {project:project, department:department, duration:duration, order:(page - 1) * ipp + index+1, task:task}, '')+ '';
					return task_html;
				}
		
				return '';
			});
	
			if (!items.length) {
				list = "  " +Render.render('empty', {icon: "edge task" , sm:1}, "KhĂ´ng cĂ³ cĂ´ng viá»‡c nĂ o")+ '';
			} else {
				list = "  " +Render.render('table', {}, ""+(header)+" <tbody>"+(list)+"</tbody>")+ '';
			}
	
			return list;
		};
	
	
		var filterItems = function (items, page, q) {
			var filtered_items = ARR.filter(items, function (task_id) {
	
				if (!q) {
					return true;
				}
	
				var task = Dashboard.model.get('tasks', task_id);
				if (!task) {
					return false;
				}
	
				var user = People.get(task.user_id);
				var title = user.name + task.name;
	
				return AP.word.fulltextMatch(title, q);
	
			});
	
			if (page != 'all') {
				filtered_items = filtered_items.slice(Math.max(0, page - 1) * ipp, (Math.max(0, page - 1) + 1) * ipp);
			}
			
			return filtered_items;
		};
	
	
		var exportItems = function (items) {
			return Dashboard.export.detailTasks(items, list.label, duration);
		};

		var tab = "<span class=\"tab-header\"> <span class=\"tab-square -"+(list.key)+"\"></span> <span class=\"tab-title\">"+(list.label)+" ("+(list.data.length)+")</span> </span>";


		var list_tasks = Dashboard.model.quickSort(list.data, 0, list.data.length - 1,  function (a, b) {

			var task_a = Dashboard.model.get('tasks', a);
			var task_b = Dashboard.model.get('tasks', b);
	
			if (task_b && task_a) {
	
				var cmp = 0;
	
				if (duration) {
					cmp = parseInt(task_b.duration) - parseInt(task_a.duration);
				} else {
					cmp = parseInt(task_b.deadline) - parseInt(task_a.deadline);
				}
	
				if (cmp) {
					return cmp;
				}
	
				return parseInt(task_b.since) - parseInt(task_a.since);
			}
	
			return 0;
		});


		return "  " +Render.render('display_section', {data_key:list.key, data_tab:tab}, '' +Render.render('report_detail_paginate', {items:list_tasks, renderItems:renderItems, filterItems:filterItems, exportItems:exportItems}, '')+ '')+ ''
	});

	var icon = this.icon ? this.icon : "edge task";
	var cover = "  " +Render.render('display_cover', {icon:icon, sm:1}, '' +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ '';

	if (this.avatar) {
		cover = "  " +Render.render('display_cover', {sm:1, avatar:1}, '' +Render.render('avatar', {src:this.avatar}, '')+ " " +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ '';
	}

	var html = "<div "+(this.show('id'))+"> " +Render.render('display_obj', {_class: "report-detail-tasks report-dialog" , dialog:1}, ""+(cover)+" " +Render.render('display_sections', {}, ""+(lists_html)+"")+ '')+ "</div>";

	return html;
}, function (params, obj) {

	var $ref = $(this).find(".section[data-key="+(obj.key)+"]");
	var ref_index = $ref.index();
	var that = this;
	setTimeout(function () {
		$($(that).find('.tabs .tab')[ref_index]).click();
	}, 100)
});


Render.on("report-detail-task-table-header", function () {

	if (this.duration) {
		return "  " +Render.render('table_header', {sm:1, gray:1}, '' +Render.render('cell', {width: "60" }, "STT")+ " " +Render.render('cell', {lead:1}, "CĂ´ng viá»‡c")+ " " +Render.render('cell', {width: "210" }, "NgÆ°á»i thá»±c hiá»‡n")+ " " +Render.render('cell', {width: "120" }, "Khoáº£ng thá»i gian thá»±c hiá»‡n")+ '')+ '';
	}

	return "  " +Render.render('table_header', {sm:1, gray:1}, '' +Render.render('cell', {width: "60" }, "STT")+ " " +Render.render('cell', {lead:1}, "CĂ´ng viá»‡c")+ " " +Render.render('cell', {width: "210" }, "NgÆ°á»i thá»±c hiá»‡n")+ " " +Render.render('cell', {width: "120" }, "Thá»i háº¡n")+ '')+ '';
});


Render.on("report-detail-task", function () {

	var task = this.task;
	var user = People.get(task.username);
	var title = user.title ? user.title : 'ChÆ°a cĂ³ vá»‹ trĂ­';

	var project = Dashboard.model.get('projects', task.project_id);

	var metatype_text = project.metatype == 'team' ? "PhĂ²ng ban" : "Dá»± Ă¡n";
	var dept = project ? Dashboard.model.get('depts', project.dept_id) : '';

	var user_html = "  " +Render.render('report_unassign_block', {}, '')+ '';
	if (user.uid) {
		user_html = "  " +Render.render('block', {_class: "user" , avatar:1}, '' +Render.render('avatar', {user:user}, '')+ " " +Render.render('title', {_class: "ap-xdot" , thick:1, sm:1}, "<span title='"+(user.name)+"'>"+(user.name)+"</span>")+ " " +Render.render('info', {_class: "ap-xdot" }, ""+(title)+"")+ '')+ '';
	}

	var deadline = task.deadline && parseInt(task.deadline) ? "  " +Render.render('text_date', {ts:task.deadline}, '')+ '' : '-';

	var subtitles = [];
	if (this.project) {
		subtitles.push(""+(metatype_text)+": "+(project ? project.name : 'Unknown')+"");
	}

	if (this.department) {
		subtitles.push("Department: "+(dept ? dept.name : 'ChÆ°a phĂ¢n loáº¡i')+"");
	}

	var subtitle = subtitles.join(' &middot; ')

	html = "  " +Render.render('table_row', {}, '' +Render.render('cell', {thick:1}, ""+(AP.data.zeroPrefix(this.order))+"")+ " " +Render.render('cell', {lead:1}, '' +Render.render('block', {_class: "main" }, '' +Render.render('title', {_class: "ap-xdot" , sm:1}, "<a target='_blank' href='/home?task="+(task.id)+"' title='"+(task.name)+"'>"+(task.name)+"</a>")+ " " +Render.render('info', {_class: "ap-xdot" }, "<span title='"+(safe(subtitle))+"'>"+(subtitle)+"</span>")+ '')+ '')+ " " +Render.render('cell', {}, ""+(user_html)+"")+ " " +Render.render('cell', {}, ""+(deadline)+"")+ '')+ '';

	if (this.duration) {
		var duration = task.duration && parseInt(task.duration) ? ""+(AP.data.numberFormat(task.duration/3600))+" <span class='-unit'>h</span>" : '-';
		html = "  " +Render.render('table_row', {}, '' +Render.render('cell', {thick:1}, ""+(AP.data.zeroPrefix(this.order))+"")+ " " +Render.render('cell', {lead:1}, '' +Render.render('block', {_class: "main" }, '' +Render.render('title', {_class: "ap-xdot" , sm:1}, "<a target='_blank' href='/home?task="+(task.id)+"' title='"+(task.name)+"'>"+(task.name)+"</a>")+ " " +Render.render('info', {_class: "ap-xdot" }, "<span title='"+(safe(subtitle))+"'>"+(subtitle)+"</span>")+ '')+ '')+ " " +Render.render('cell', {}, ""+(user_html)+"")+ " " +Render.render('cell', {}, ""+(duration)+"")+ '')+ '';
	}

	return html;
});


// PROJECTS
Render.on('report-unassign-block', function() {

	var user = People.get(0);

	return "  " +Render.render('block', {_class: "-unassigned" , avatar:1}, '' +Render.render('avatar', {user:user}, '')+ " " +Render.render('title', {_class: "ap-xdot" , thick:1, sm:1}, "ChÆ°a giao")+ " " +Render.render('info', {_class: "ap-xdot" }, "ChÆ°a cĂ³ vá»‹ trĂ­")+ '')+ "";
});


Render.on("report-detail-total-projects", function () {

	var lists = this.lists;
	var lists_html = AP.render(lists, function (list) {

		var ipp = 20; // Item per page
		function renderItems(items, page) {

			if (!page) {
				page = 1;
			}

			var header = "  " +Render.render('report_detail_project_table_header', {}, '')+ '';

			var html = AP.render(items, function (project_id, index) {
				var project = Dashboard.model.get('projects', project_id);
				if (project) {
					var project_html = "  " +Render.render('report_detail_project', {order:(page - 1) * ipp + index+1, project:project}, '')+ '';
					return project_html;
				}
		
				return '';
			});

			if (!items.length) {
				html = "  " +Render.render('empty', {icon: "edge task" , sm:1}, "KhĂ´ng cĂ³ cĂ´ng viá»‡c nĂ o")+ '';
			} else {
				html = "  " +Render.render('table', {}, ""+(header)+" <tbody>"+(html)+"</tbody>")+ '';
			}

			return html;
		};


		function filterItems(items, page, q) {

			var filtered_items = ARR.filter(items, function (project_id) {
	
				if (!q) {
					return true;
				}
	
				var project = Dashboard.model.get('projects', project_id);
				if (!project) {
					return false;
				}
	
				var user = People.get(project.user_id);
				var title = user.name + project.name;
	
				return AP.word.fulltextMatch(title, q);
	
			});
	
			if (page != 'all') {
				filtered_items = filtered_items.slice(Math.max(0, page - 1) * ipp, (Math.max(0, page - 1) + 1) * ipp);
			}
			
			return filtered_items;
		};


		function exportItems(items) {
			return Dashboard.export.detailProjects(items, list.label);
		};

		var tab = "<span class=\"tab-header\"> <span class=\"tab-square -"+(list.key)+"\"></span> <span class=\"tab-title\">"+(list.label)+" ("+(list.data.length)+")</span> </span>";


		var list_projects = ARR.usort(list.data, function (a, b) {

			var project_a = Dashboard.model.get('projects', a);
			var project_b = Dashboard.model.get('projects', b);

			if (project_b && project_a) {
				return parseInt(project_b.since) - parseInt(project_a.since);
			}

			return 0;
		});

		return "  " +Render.render('display_section', {data_key:list.key, data_tab:tab}, '' +Render.render('report_detail_paginate', {items:list_projects, renderItems:renderItems, filterItems:filterItems, exportItems:exportItems}, '')+ '')+ ''
	});

	var icon = this.icon ? this.icon : "edge report_project";

	var html = "<div "+(this.show('id'))+"> " +Render.render('display_obj', {_class: "report-detail-tasks report-dialog" , dialog:1}, '' +Render.render('display_cover', {icon:icon}, '' +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ " " +Render.render('display_sections', {}, ""+(lists_html)+"")+ '')+ "</div>";

	return html;
}, function (params, obj) {

	var $ref = $(this).find(".section[data-key="+(obj.key)+"]");
	var ref_index = $ref.index();
	var that = this;
	setTimeout(function () {
		$($(that).find('.tabs .tab')[ref_index]).click();
	}, 100);
});


Render.on("report-detail-projects", function () {

	var that = this;

	var list_projects = ARR.usort(this.projects, function (a, b) {

		var project_a = Dashboard.model.get('projects', a);
		var project_b = Dashboard.model.get('projects', b);

		if (project_b && project_a) {
			return parseInt(project_b.since) - parseInt(project_a.since);
		}

		return 0;
	});

	var ipp = 20;

	var renderItems = function (items, page) {

		if (!page) {
			page = 1;
		}

		var header = "  " +Render.render('report_detail_project_table_header', {}, '')+ '';
		var list = AP.render(items, function (project_id, index) {

			var project = Dashboard.model.get('projects', project_id);
			if (project) {
				var project_html = "  " +Render.render('report_detail_project', {order:(page - 1) * ipp + index+1, project:project}, '')+ '';
				return project_html;
			}
	
			return '';
		});

		if (!items.length) {
			list = "  " +Render.render('empty', {icon: "edge task" , sm:1}, "KhĂ´ng cĂ³ dá»± Ă¡n/phĂ²ng ban nĂ o")+ '';
		} else {
			list = "  " +Render.render('table', {}, ""+(header)+" <tbody>"+(list)+"</tbody>")+ '';
		}

		return list;
	};


	var filterItems = function (items, page, q) {
		var filtered_items = ARR.filter(items, function (project_id) {

			if (!q) {
				return true;
			}

			var project = Dashboard.model.get('projects', project_id);
			if (!project) {
				return false;
			}

			var user = People.get(project.user_id);
			var title = user.name + project.name;

			return AP.word.fulltextMatch(title, q);

		});

		if (page != 'all') {
			filtered_items = filtered_items.slice(Math.max(0, page - 1) * ipp, (Math.max(0, page - 1) + 1) * ipp);
		}
		
		return filtered_items;
	};


	var exportItems = function (items) {
		return Dashboard.export.detailProjects(items, that.title);
	};


	var icon = this.icon ? this.icon : "edge report_project";

	var html = "<div "+(this.show('id'))+"> " +Render.render('display_obj', {_class: "report-detail-projects report-dialog" , dialog:1}, '' +Render.render('display_cover', {icon:icon, sm:1}, '' +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ " " +Render.render('display_section', {}, '' +Render.render('report_detail_paginate', {items:list_projects, renderItems:renderItems, filterItems:filterItems, exportItems:exportItems}, '')+ '')+ '')+ "</div>";

	return html;
}, function (params, obj) {

});


Render.on("report-detail-project-table-header", function () {

	return " " +Render.render('table_header', {sm:1, gray:1}, '' +Render.render('cell', {width: "60" }, "STT")+ " " +Render.render('cell', {lead:1}, "Dá»± Ă¡n/phĂ²ng ban")+ " " +Render.render('cell', {width: "210" }, "NgÆ°á»i quáº£n lĂ½")+ " " +Render.render('cell', {width: "120" }, "Táº¡o lĂºc")+ '')+ "";
});


Render.on("report-detail-project", function () {

	var project = this.project;

	var dept = Dashboard.model.get('depts', project.dept_id);
	if (Client.pageData.dept) {
		dept = Client.pageData.dept;
	}

	var owners = ARR.select(project.owners, function (e) {
		return e.username;
	});

	html = "  " +Render.render('table_row', {}, '' +Render.render('cell', {thick:1}, ""+(AP.data.zeroPrefix(this.order))+"")+ " " +Render.render('cell', {_class: "-long main" , lead:1}, '' +Render.render('title', {_class: "ap-xdot" , sm:1}, "<a href='/"+(project.path)+"' class='move-name ap-xdot' target='_blank' title='"+(project.name)+"'>"+(project.name)+"</a>")+ " " +Render.render('info', {_class: "ap-xdot move-path" }, "<span>Department: "+(dept ? dept.name: 'ChÆ°a phĂ¢n loáº¡i')+"</span>")+ '')+ " " +Render.render('cell', {}, '' +Render.render('avatars', {limit: "5" , users:owners, es: "No managers" , left:1}, '')+ '')+ " " +Render.render('cell', {}, '' +Render.render('text_date', {ts:project.since}, '')+ '')+ '')+ '';

	return html;
});


// MILESTONES
Render.on("report-detail-total-milestones", function () {

	var lists = this.lists;
	var lists_html = AP.render(lists, function (list) {

		var ipp = 20; // Item per page

		function renderItems(items, page) {

			if (!page) {
				page = 1;
			}

			var header = "  " +Render.render('report_detail_milestone_table_header', {}, '')+ '';

			var html = AP.render(items, function (milestone_id, index) {
				var milestone = Dashboard.model.get('milestones', milestone_id);
				if (milestone) {
					var milestone_html = "  " +Render.render('report_detail_milestone', {order:(page - 1) * ipp + index+1, milestone:milestone}, '')+ '';
					return milestone_html;
				}
		
				return '';
			});

			var html = "  " +Render.render('table', {}, ""+(header)+" <tbody>"+(html)+"</tbody>")+ '';

			if (!items.length) {
				html = "  " +Render.render('empty', {title: '' , icon: "edge task" , sm:1}, "KhĂ´ng cĂ³ má»¥c tiĂªu nĂ o")+ '';
			}

			return html;
		};


		function filterItems(items, page, q) {

			var filtered_items = ARR.filter(items, function (milestone_id) {
	
				if (!q) {
					return true;
				}
	
				var milestone = Dashboard.model.get('milestones', milestone_id);
				if (!milestone) {
					return false;
				}
	
				var user = People.get(milestone.user_id);
				var title = user.name + milestone.name;
	
				return AP.word.fulltextMatch(title, q);
	
			});
	
			if (page != 'all') {
				filtered_items = filtered_items.slice(Math.max(0, page - 1) * ipp, (Math.max(0, page - 1) + 1) * ipp);
			}
			
			return filtered_items;
		};


		function exportItems(items) {

			return Dashboard.export.detailMilestones(items, list.label);
		};


		var tab = "<span class=\"tab-header\"> <span class=\"tab-square -"+(list.key)+"\"></span> <span class=\"tab-title\">"+(list.label)+" ("+(list.data.length)+")</span> </span>";

		var list_milestones = ARR.usort(list.data, function (a, b) {

			var milestone_a = Dashboard.model.get('milestones', a);
			var milestone_b = Dashboard.model.get('milestones', b);

			if (milestone_b && milestone_a) {
				return parseInt(milestone_b.time) - parseInt(milestone_a.time);
			}

			return 0;
		});


		return "  " +Render.render('display_section', {data_key:list.key, data_tab:tab}, '' +Render.render('report_detail_paginate', {items:list_milestones, renderItems:renderItems, filterItems:filterItems, exportItems:exportItems}, '')+ '')+ ''
	});

	var icon = this.icon ? this.icon : "edge task";

	var html = "<div "+(this.show('id'))+"> " +Render.render('display_obj', {_class: "report-detail-tasks report-dialog" , dialog:1}, '' +Render.render('display_cover', {icon:icon}, '' +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ " " +Render.render('display_sections', {}, ""+(lists_html)+"")+ '')+ "</div>";

	return html;
}, function (params, obj) {

	var $ref = $(this).find(".section[data-key="+(obj.key)+"]");
	var ref_index = $ref.index();
	var that = this;
	setTimeout(function () {
		$($(that).find('.tabs .tab')[ref_index]).click();
	}, 100);
});


Render.on("report-detail-milestones", function () {

	var that = this;
	var ipp = 20;

	var list_milestones = ARR.usort(this.milestones, function (a, b) {

		var milestone_a = Dashboard.model.get('milestones', a);
		var milestone_b = Dashboard.model.get('milestones', b);

		if (milestone_b && milestone_a) {
			return parseInt(milestone_b.time) - parseInt(milestone_a.time);
		}

		return 0;
	});


	var renderItems = function (items, page) {

		if (!page) {
			page = 1;
		}

		var header = "  " +Render.render('report_detail_milestone_table_header', {}, '')+ '';

		var list = AP.render(items, function (milestone_id, index) {
			var milestone = Dashboard.model.get('milestones', milestone_id);
			if (milestone) {
				var milestone_html = "  " +Render.render('report_detail_milestone', {order:(page - 1) * ipp + index+1, milestone:milestone}, '')+ '';
				return milestone_html;
			}
	
			return '';
		});

		if (!items.length) {
			list = "  " +Render.render('empty', {icon: "edge task" , sm:1}, "KhĂ´ng cĂ³ má»¥c tiĂªu nĂ o")+ '';
		} else {
			list = "  " +Render.render('table', {}, ""+(header)+" <tbody>"+(list)+"</tbody>")+ '';
		}

		return list;
	};


	var filterItems = function (items, page, q) {
		var filtered_items = ARR.filter(items, function (milestone_id) {

			if (!q) {
				return true;
			}

			var milestone = Dashboard.model.get('milestones', milestone_id);
			if (!milestone) {
				return false;
			}

			var user = People.get(milestone.user_id);
			var title = user.name + milestone.name;

			return AP.word.fulltextMatch(title, q);

		});

		if (page != 'all') {
			filtered_items = filtered_items.slice(Math.max(0, page - 1) * ipp, (Math.max(0, page - 1) + 1) * ipp);
		}
		
		return filtered_items;
	};


	var exportItems = function (items) {
		return Dashboard.export.detailMilestones(items, that.title);
	};


	var icon = this.icon ? this.icon : "edge task";
	var cover = "  " +Render.render('display_cover', {icon:icon, sm:1}, '' +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ '';

	if (this.avatar) {
		cover = "  " +Render.render('display_cover', {sm:1, avatar:1}, '' +Render.render('avatar', {src:this.avatar}, '')+ " " +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle ? this.subtitle : '')+"")+ '')+ '';
	}

	var html = "<div "+(this.show('id'))+"> " +Render.render('display_obj', {_class: "report-detail-tasks report-dialog" , dialog:1}, ""+(cover)+" " +Render.render('display_section', {}, '' +Render.render('report_detail_paginate', {items:list_milestones, renderItems:renderItems, filterItems:filterItems, exportItems:exportItems}, '')+ '')+ '')+ "</div>";

	return html;
}, function (params, obj) {

});


Render.on("report-detail-milestone-table-header", function () {

	return "  " +Render.render('table_header', {sm:1, gray:1}, '' +Render.render('cell', {width: "60" }, "STT")+ " " +Render.render('cell', {lead:1}, "Má»¥c tiĂªu")+ " " +Render.render('cell', {width: "210" }, "NgÆ°á»i chá»‹u trĂ¡ch nhiá»‡m")+ " " +Render.render('cell', {width: "120" }, "NgĂ y hoĂ n thĂ nh má»¥c tiĂªu")+ '')+ '';
});


Render.on("report-detail-milestone", function () {

	var milestone = this.milestone;
	var user = People.get(milestone.user_id);
	var title = user.title ? user.title : 'ChÆ°a cĂ³ vá»‹ trĂ­';

	var project = Dashboard.model.get('projects', milestone.project_id);

	var metatype_text = project.metatype == 'team' ? "PhĂ²ng ban" : "Dá»± Ă¡n";
	var subtitle = ""+(metatype_text)+": "+(project ? project.name : 'Unknown')+"";

	var milestone_date = parseInt(milestone.time) ? "  " +Render.render('text_date', {ts:milestone.time}, '')+ '' : '-';

	var user_html = "  " +Render.render('block', {_class: "user" , avatar:1}, '' +Render.render('avatar', {user:user}, '')+ " " +Render.render('title', {_class: "ap-xdot" , thick:1, sm:1}, "<span title='"+(user.name)+"'>"+(user.name)+"</span>")+ " " +Render.render('info', {_class: "ap-xdot" }, ""+(title)+"")+ '')+ '';

	html = "  " +Render.render('table_row', {}, '' +Render.render('cell', {thick:1}, ""+(AP.data.zeroPrefix(this.order))+"")+ " " +Render.render('cell', {_class: "-long main" , lead:1}, '' +Render.render('title', {_class: "ap-xdot" , sm:1}, "<span class='move-name ap-xdot' title='"+(milestone.name)+"'>"+(milestone.name)+"</span>")+ " " +Render.render('info', {_class: "ap-xdot move-path" }, "<span title='"+(safe(subtitle))+"'>"+(subtitle)+"</span>")+ '')+ " " +Render.render('cell', {}, ""+(user_html)+"")+ " " +Render.render('cell', {}, ""+(milestone_date)+"")+ '')+ '';

	return html;
});


// MEMBERS
Render.on("report-detail-total-members", function () {

	var lists = this.lists;

	var lists_html = AP.render(lists, function (list) {

		var ipp = 20;

		var renderItems = function (items, page) {
	
			if (!page) {
				page = 1;
			}
	
			var list = AP.render(items, function (user_id, index) {
				return "  " +Render.render('report_detail_member', {user:user_id, order:(page - 1) * ipp + index+1}, '')+ '';
			});
	
			if (!items.length) {
				list = "  " +Render.render('empty', {title: '' , icon: "edge box_empty" , sm:1}, "No members to show")+ '';
			} else {
				list = "  " +Render.render('table', {}, '' +Render.render('table_header', {sm:1, gray:1}, '' +Render.render('cell', {width: "60" }, "STT")+ " " +Render.render('cell', {lead:1}, "ThĂ nh viĂªn")+ '')+ "<tbody>"+(list)+"</tbody>")+ '';
			}
	
			return list;
		};


		var filterItems = function (items, page, q) {

			var filtered_items = ARR.filter(items, function (username) {
	
				if (!q) {
					return true;
				}
	
				var member = People.get(username);
				if (!member) {
					return false;
				}
	
				var user = People.get(member.user_id);
				var title = user.name + member.name;
	
				return AP.word.fulltextMatch(title, q);
	
			});
	
			if (page != 'all') {
				filtered_items = filtered_items.slice(Math.max(0, page - 1) * ipp, (Math.max(0, page - 1) + 1) * ipp);
			}
			
			return filtered_items;
		};


		var exportItems = function (items) {
			return Dashboard.export.detailTotalMembers(items, list.label);
		};

		var tab = "<span class=\"tab-header\"> <span class=\"tab-square -"+(list.key)+"\"></span> <span class=\"tab-title\">"+(list.label)+" ("+(list.data.length)+")</span> </span>";


		return "  " +Render.render('display_section', {data_key:list.key, data_tab:tab}, '' +Render.render('report_detail_paginate', {items:list.data, renderItems:renderItems, filterItems:filterItems, exportItems:exportItems}, '')+ '')+ ''
	});

	var icon = this.icon ? this.icon : "report_people";

	var html = "<div "+(this.show('id'))+"> " +Render.render('display_obj', {_class: "report-detail-jobs report-dialog" , dialog:1}, '' +Render.render('display_cover', {icon:icon}, '' +Render.render('title', {}, ""+(this.title)+"")+ " " +Render.render('subtitle', {}, ""+(this.subtitle)+"")+ '')+ " " +Render.render('display_sections', {}, ""+(lists_html)+"")+ '')+ "</div>";

	return html;
}, function (params, obj) {

	var $ref = $(this).find(".section[data-key="+(obj.key)+"]");
	var ref_index = $ref.index();
	var that = this;
	setTimeout(function () {
		$($(that).find('.tabs .tab')[ref_index]).click();
	}, 100);
});



Render.on("report-detail-member", function () {

	var user_id = this.user;
	var user = People.get(user_id);
	var title = user.title ? user.title : 'ChÆ°a cĂ³ vá»‹ trĂ­';


	var user_html = "  " +Render.render('block', {_class: "user" , avatar:1}, '' +Render.render('avatar', {user:user}, '')+ " " +Render.render('title', {_class: "ap-xdot" , thick:1, sm:1}, "<span title='"+(user.name)+"'>"+(user.name)+"</span>")+ " " +Render.render('info', {_class: "ap-xdot" }, ""+(title)+"")+ '')+ '';

	html = "  " +Render.render('table_row', {}, '' +Render.render('cell', {thick:1}, ""+(AP.data.zeroPrefix(this.order))+"")+ " " +Render.render('cell', {lead:1}, ""+(user_html)+"")+ '')+ '';

	return html;
});



function showTableTitle(canvas) {

	$(canvas).find('thead .cell').each (function () {

		$(this).attr('title', safe($(this).text()));
	});
};


Render.on("report-detail-paginate", function () {

	var renderItems = this.renderItems;
	var filterItems = this.filterItems;
	var items = this.items;

	var filtered_items = filterItems(items, '');
	var list_html = renderItems(filtered_items);

	return "<div "+(this.show('id'))+"> <div class='detail-actions'> " +Render.render('search', {borderless:1, disable_autocomplete:1}, '')+ " " +Render.render('label', {_class: "url btn-export" , icon: "report_download" , icon_color: "main" , color: "main" }, "Xuáº¥t bĂ¡o cĂ¡o excel")+ "</div> <div class='js-list'> "+(list_html)+" </div> <div class='js-paginate'> " +Render.render('report_pagination', {page: "1" , items:items}, '')+ "</div> </div>"
}, function (params, obj) {

	var renderItems = obj.renderItems;
	var filterItems = obj.filterItems;
	var items = obj.items;
	var exportItems = obj.exportItems;
	var $that = $(this);
	var q = '';
	var page = 1;

	var delay_timer = null;
	$that.find('.detail-actions .base-search input').on('input', function () {

		var $this = $(this);
		clearTimeout(delay_timer);

		delay_timer = setTimeout(function() {
			page = 1; // Auto back to page 1 when search

			q = $this.val().toLowerCase();

			var filtered_items = filterItems(items, page, q);
			var all_items = filterItems(items, 'all', q);
			var list_html = renderItems(filtered_items, page);
			$that.find('.js-list').html(list_html);
			$that.find('.js-paginate').html("  " +Render.render('report_pagination', {page:page, items:all_items}, '')+ '');
			$that.find('thead .cell').each (function () {
				$(this).attr('title', safe($(this).text()));
			});

			Render.finish();
		}, 300);

	});


	$that.find('.detail-actions .btn-export').click(function () {

		var filtered_items = filterItems(items, 'all', q);
		exportItems(filtered_items);
	});


	$that.find('thead .cell').each (function () {

		$(this).attr('title', safe($(this).text()));
	});


	$that.find('.js-paginate').on('click', '.next', function () {

		page ++;
		var filtered_items = filterItems(items, page, q);
		var all_items = filterItems(items, 'all', q);
		var list_html = renderItems(filtered_items, page);
		$that.find('.js-list').html(list_html);
		$that.find('.js-paginate').html("  " +Render.render('report_pagination', {page:page, items:all_items}, '')+ '');
		$that.find('thead .cell').each (function () {
			$(this).attr('title', safe($(this).text()));
		});
	

		Render.finish();
	});

	$that.find('.js-paginate').on('click', '.prev', function () {

		if (page == 1) {
			return;
		}
		page --;
		var filtered_items = filterItems(items, page, q);
		var all_items = filterItems(items, 'all', q);
		var list_html = renderItems(filtered_items, page);
		$that.find('.js-list').html(list_html);
		$that.find('.js-paginate').html("  " +Render.render('report_pagination', {page:page, items:all_items}, '')+ '');
		$that.find('thead .cell').each (function () {
			$(this).attr('title', safe($(this).text()));
		});

		Render.finish();
	});

	$that.find('.js-paginate').on('click', '.pag', function () {

		var temp_page = parseInt($(this).html());

		if (!Number.isNaN(temp_page) && temp_page >= 1) {
			// Do nothing when click current page
			if (temp_page == page) {
				return;
			}

			page = temp_page;
		}

		var filtered_items = filterItems(items, page, q);
		var all_items = filterItems(items, 'all', q);
		var list_html = renderItems(filtered_items, page);
		$that.find('.js-list').html(list_html);
		$that.find('.js-paginate').html("  " +Render.render('report_pagination', {page:page, items:all_items}, '')+ '');
		$that.find('thead .cell').each (function () {
			$(this).attr('title', safe($(this).text()));
		});

		Render.finish();
	});
});



Render.on("report-pagination", function() {

	var page = this.page;

	this.num_items = this.items.length;


	if (!this.ipp){
		this.ipp=20;
	}
	
	if (!this.limit){
		this.limit=6;
	}
	
	this.num_items = parseInt(this.num_items);
	this.ipp = parseInt(this.ipp);
	
	var pages = Render.pagination.getPages(this, '', page);

	var html = AP.render(pages, function(e){
		if (e == "-truncation-"){
			return "<div class='pag-trunc'><span class='-ap icon-dots-two-horizontal'></span></div>";
		}else{
			return "<div class='pag url "+(parseInt(e)==page?'active':'')+"' data-url=''>"+(e)+"</div>";
		}
	});
	
	var prev = "<div class='pag-nav -prev url "+(page <= 1 ? '-disabled':'prev')+"'><span class='-ap icon-chevron-left22'></span></div>";
	var num_pages = Math.ceil(this.num_items/this.ipp);
	var next = "<div class='pag-nav -next url "+(page >= num_pages ? '-disabled':'next')+"'><span class='-ap icon-chevron-right22'></span></div>";
	
	
	html=""+(prev)+" "+(html)+" "+(next)+"";
	
	var from_item = (page-1)*this.ipp+1;
	var to_item = page*this.ipp;
	if (to_item>this.num_items){
		to_item=Math.max(this.num_items, 1);
	}

	// No result
	if (from_item == 1 && to_item == 1 && this.num_items == 0) {
		from_item = 0;
		to_item = 0;
	}
	
	return "<div class='base-pagination "+(this.get('class'))+"' "+(this.css())+"> <div class='bp-wrapper'> <div class='bp-panel'>"+(html)+"</div> <div class='bp-exp'>Hiá»ƒn thá»‹ káº¿t quáº£ <em>"+(from_item)+"</em> - <em>"+(to_item)+"</em> trĂªn <em>"+(this.num_items)+"</em></div> </div> </div>";
});

var Drive=new function __Drive(){
};




Drive.folder=new function __DriveFolder(){	
	this.pendingPaste={};

	this.create = function() {
		var folder_id = Client.pageData.folder ? Client.pageData.folder.id : 0;
		var data = {sysid: Client.pageData.project.id, folder_id: folder_id};

		var form = Form.create('fly-proj-addfolder-fx',{'action': "api/base/file/folder/create"})
			.row(
				Form.label({label: "TĂªn thÆ° má»¥c"}),
				Form.input({name: 'name', "placeholder":"TĂªn thÆ° má»¥c"}).autoSubmit()
			)
			.buttons([
				{label: "ThĂªm thÆ° má»¥c", action: function(){
					Form.submit("#fly-proj-addfolder-fx", function(code){
						if (!code.good()){
							return AP.alertError(code.message);
						}

						Form.hide("fly-proj-addfolder-fx");
						UI.flash("ÄĂ£ thĂªm thÆ° má»¥c...");
						AP.xRefresh();
					})
				}, style: 'ok -success -rounded bold'},
				{label: "Há»§y", action: function(){
					Form.hide("fly-proj-addfolder-fx");
				}, style:'cancel -passive-2 -rounded'}
			]).hiddens(data);

		Form.pop({width: 480, label: 'ThĂªm thÆ° má»¥c trong dá»± Ă¡n', layout: "flat"}).setForm(form).show().focus('name');
	};

	
	/**
	 * @desc Edit a folder
	 */
	this.edit=function(ref){
		var folder=getFolder(ref);
		if (!folder){
			return;
		}
		
		var hiddens={id: folder.id, token: folder.token};
	
		var form=Form.create('tree-node-fx',{action: 'api/base/file/folder/edit'})
		.row(
			Form.label({label: "TĂªn thÆ° má»¥c"}),
			Form.input({name: 'name', "placeholder":"TĂªn thÆ° má»¥c"}).value(folder.name).autoSubmit()
		)
		.hiddens(hiddens)
		.buttons([
			 {label: "Cáº­p nháº­t thÆ° má»¥c", action: function(){
				 Form.submit("tree-node-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }
				
					 Form.hide("tree-node-fx");
					 UI.flash("ÄĂ£ cáº­p nháº­t thÆ° má»¥c");
					 AP.xRefresh();
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("tree-node-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).settings();
		
		Form.pop({id:'tree-node-fx-dx', width: 400, label: 'Cáº­p nháº­t thÆ° má»¥c', layout: 'flat'}).setForm(form).show().focus('name');
	};
	
	this.moveFolder=function(ref){
		var folder=getFolder(ref);
		if (!folder){
			return;
		}
		
		this.pendingPaste={
			action: "move",
			type: "folder",
			item: folder
		};
		
		AP.alertSuccess("ÄĂ£ copy thÆ° má»¥c. Vui lĂ²ng chá»n má»™t thÆ° má»¥c khĂ¡c Ä‘á»ƒ paste");
	};
	
	
	/**
	 * @desc Copy a folder out to another project
	 */
	this.copyFolderOut=function(ref){
		var folder=getFolder(ref);
		if (!folder){
			return;
		}
		
		this.pendingPaste={
			action: "move",
			type: "folder",
			item: folder,
			to_external: 1
		};
		
		AP.alertSuccess("ÄĂ£ copy thÆ° má»¥c. Vui lĂ²ng chá»n má»™t thÆ° má»¥c trong project/team khĂ¡c Ä‘á»ƒ paste");
	};
	
	
	this.moveNow=function(ref){
		if (this.pendingPaste.to_external){
			return this.executeCopyOut(ref);
		}
		
		var folder=getFolder(ref);
		
		var data={id: this.pendingPaste.item.id, action: "move", to: folder.id};
		UI.ajaxShow();
		AP.post("api/base/file/folder/move", data, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("ÄĂ£ di chuyá»ƒn thÆ° má»¥c thĂ nh cĂ´ng !");
			AP.xRefresh();
		});
	};
	
	
	
	this.executeCopyOut=function(ref){
		AP.confirm("Please confirm to copy the folder <b>"+this.pendingPaste.item.name+"</b> to this (external) folder. A maximal of 50 files and 100 folders can be copied.", function(){
			var data={id: Drive.folder.pendingPaste.item.id, action: "move", to: 0, to_project_id: Client.pageData.project.id};
			
			var folder=getFolder(ref);
			if (folder){
				data.to=folder.id;
			}
			
			UI.ajaxShow();
			AP.post("api/base/file/folder/copy.out", data, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("ÄĂ£ copy thÆ° má»¥c thĂ nh cĂ´ng !");
				AP.xRefresh();
			});
		});
	};
	
	
	
	this.options=function(ref){
		AP.actionMenu(this.getOptions(ref));
	};
	
	 
	this.getOptions=function(ref){
		var actions=[];
		actions.push({label: "Sá»­a thÆ° má»¥c", icon:"uniF116", action: function(){
			Drive.folder.edit(ref);
		}});
		
		actions.push({label: "Di chuyá»ƒn thÆ° má»¥c nĂ y tá»›i  ...", icon:"uniF15F", action: function(){
			Drive.folder.moveFolder(ref);
		}});
		
		if (Project.isManager()){
			actions.push({label: "Copy folder ra bĂªn ngoĂ i  ...", icon:"uniF15F", action: function(){
				Drive.folder.copyFolderOut(ref);
			}});	
		}
		
		
		if (this.pendingPaste && this.pendingPaste.action){
			var e=this.pendingPaste;
			actions.push({label: "Paste thÆ° má»¥c ["+e.item.name+"]", icon:"uniF10E", action: function(){
				Drive.folder.moveNow(ref);
			}});
		}

		if (Drive.file.pendingPaste && Drive.file.pendingPaste.action){
			var e=Drive.file.pendingPaste;
			actions.push({label: "Paste file ["+e.item.name+"]", icon:"uniF10E", action: function(){
				Drive.file.moveNow(ref);
			}});
		}
		
		actions.push({label: "XĂ³a thÆ° má»¥c nĂ y", icon:"uniF11F", action: function(){
			Drive.folder.remove(ref);
		}});
		
		
		return actions;
	};
	
	
	function getFolder(ref){
		var folder={};
		if (ref){
			var $canvas=$(ref).closest('.item');
			var id=$canvas.data("id");
			var name=$canvas.data("name");
			var token=$canvas.data("token");
			folder={id: id, name: name, token: token, ns_id: Client.pageData.context.id};
		}else{
			folder=Client.pageData.folder;
		}
		
		return folder;
	};
	

	this.displayAsOptions=function(canvas){
		var html=UI.tree.options(Client.pageData.cats);
		$(canvas).html(html);
	};

	
	/**
	 * @desc Init navigation
	 */
	this.initNav=function(){
		var html=AP.render(Client.pageData.traces, function(e, index, total){
			var icon="&nbsp;<span class='-ap icon-chevron-small-right'></span>&nbsp;";
			if (index==total-1){
				icon='';
			}
			return "<span class='url' data-xurl='documents/folder/"+(e.id)+"'>"+(e.name)+"</span>"+(icon)+"";
		});
		
		html="<span class='url' data-xurl='documents'>Documents</span>&nbsp;<span class='-ap icon-chevron-small-right'></span>&nbsp;" + html;
		
		$("#js-drive-folder-navs").html(html);
	};
	
	
	
	/**
	 * @desc Remove folder, safely remove all nested too
	 */
	this.remove=function(ref){
		var folder=getFolder(ref);
		var hiddens={id: folder.id, token: folder.token};
		
		AP.confirmDelete("Delete this folder will also delete all internal files and sub-folders (if you are project owners). Are you sure?", function(){
			UI.ajaxShow();
			AP.post("api/base/file/folder/remove", hiddens, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Folder removed ...");
				AP.xRefresh();
			});
		});
	};
	
	
	
};








Drive.file=new function __DriveFile(){
	this.pendingPaste={};
	this.display=function(fid){
		AP.loadInlineURL(Client.pageData.context.path+"/file", {id: fid}, "#file-display-canvas", {
			start: function(){
			},
			end: function(){
				AP.setURLParams({"show": fid});
			}
		});
	};
	
	this.extDisplay=function(fid){
		AP.loadInlineURL(Client.pageData.context.path+"/filext", {id: fid}, "#file-display-canvas", {
			start: function(){
			},
			end: function(){
				AP.setURLParams({"show": fid});
			}
		});
	};
	
	
	this.onDisplay=function(){
		if ($("#file-display").length){
			return true;
		}
		
		return false;
	};
	
	this.close=function(){
		$("#file-display").fadeOut(300, function(){
			$(this).remove();
			if (Client.pageData.direct_file){
			}else{
				AP.setURLParams({"show": null});
			}
		});
	};
	
	this.clean=function(){
		$("#file-display").remove();
	};
	
	this.ext=function(){
		$("#file-display").toggleClass("ext");
	};
	
	
	this.next=function(){

	};



	/**
	 * @desc Edit a file
	 */
	this.edit=function(id, token, name){
		var hiddens={id: id, token: token};
	
		var form=Form.create('tree-node-fx',{action: 'api/base/file/edit'})
		.row(
			Form.label({label: "TĂªn tĂ i liá»‡u"}),
			Form.input({name: 'name', "placeholder":"TĂªn tĂ i liá»‡u"}).value(name).autoSubmit()
		)
		.hiddens(hiddens)
		.buttons([
			 {label: "Chá»‰nh sá»­a tĂªn tĂ i liá»‡u", action: function(){
				 Form.submit("tree-node-fx", function(code){
					 if (!code.good()){
						 return AP.alertError(code.message);
					 }

					 Form.hide("tree-node-fx");
					 AP.closeDialog(this);
					 UI.flash("File Ä‘Ă£ Ä‘Æ°á»£c chá»‰nh sá»­a");

					 AP.xRefresh();
				 });
			 }, style: 'ok -success -rounded bold'},
			 {label: "Há»§y", action: function(){
				 Form.hide("tree-node-fx");
			 }, style:'cancel -passive-2 -rounded'}
		]).settings();
		
		Form.pop({id:'tree-node-fx-dx', width: 400, label: 'Chá»‰nh sá»­a tĂªn tĂ i liá»‡u', layout: 'flat'}).setForm(form).show().focus('name');
	};

	function isImage(file){
		if (file.image && parseInt(file.image)){
			return true;
		}

		return false;
	};

	function isEmbeddable(file){
		var ext=UI.file.icon(file.name);

		if (file.metatype=="onedrive" && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
			return true;
		}

		// if (file.metatype=="dropbox" && file.preview && file.preview.length && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
		//	 return true;
		// }

		if (file.metatype=="dropbox" && (ext=="png" || ext=="jpg" || ext=="jpeg" || ext=="gif")){
			return true;
		}

		if (file.metatype == "google" || file.metatype == "googledrive"){
			return true;
		}

		if (file.metatype == "base" || file.metatype == "basedraw"){
			return true;
		}

		if (ext=="word" || ext=="excel" || ext=="pdf" || ext=="ppt" || ext=="txt"){
			return true;
		}

		return false;
	};

	

	this.showRev=function(file, rev){
		BC.main(Drive.file.getMain(rev));
		BC.title(Drive.file.getTitle(file, rev));
	};

	this.showRevs=function(){
		var file=this.file;
		if (!file){
			return;
		}

		var options=AP.select(file.revs, function(e, index){
			return {data: e, type: 'rev', label: "<b>Rev "+(index+1)+"</b>: "+e.name, sublabel: "Táº¡o lĂºc "+UI.simpleTime(e.since),"icon":"label_outline"};
		});

		options.push({type:'rev','label':"<b>PhiĂªn báº£n hiá»‡n táº¡i</b>: "+file.name, sublabel: "Táº¡o lĂºc "+UI.simpleTime(file.since), data: file});
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
			options.push({type:'action','label':'<b>Create/upload a new revison</b>', sublabel:'Click Ä‘á»ƒ báº¯t Ä‘áº§u táº¡o phiĂªn báº£n má»›i cho tá»‡p nĂ y', data: file});
		}


		AP.selectAction(options, function(opt){
			if (opt.type && opt.type=='action'){
				return Drive.file.newRev(opt.data.hid, opt.data.token, opt.data.gid);
			}
			Drive.file.showRev(Drive.file.file,opt.data);
		});
	};

	this.newRev=function(hid, token, gid){
		Drive.picker.pick(null, hid);
	};
	
	this.options=function(ref){
		AP.actionMenu(this.getOptions(ref));
	};

	this.PreviewOptions=function(){
		var file=Drive.file.file;
		var actions=[];

		var download=file.src;
		if (file.metatype=="" || file.metatype=="upload"){
			download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}

		actions.push({label: "Táº£i file", icon: "download", url: download});

		// if (file.user.id==Client.viewer.id){
		//	 actions.push({label: "ThĂªm phiĂªn báº£n má»›i", icon: "upload3", action: function(){
		//		 Drive.file.newRev(file.hid,file.token,file.gid);
		//	 }});
		// }

		actions.push({label: "Má»Ÿ rá»™ng mĂ n hĂ¬nh xem", icon: "open_in_new", action: function(){
			BC.extend();
		}});

		AP.actionMenu(actions);
	};

	this.getOptions=function(ref){
		var actions=[];
		// actions.push({label: "Chá»‰nh sá»­a tĂªn", icon:"uniF116", action: function(){
		// 	Drive.file.edit(ref);
		// }});
		
		actions.push({label: "Di chuyá»ƒn file tá»›i thÆ° má»¥c", icon:"uniF15F", action: function(){
			Drive.file.moveFile(ref);
		}});
		
		actions.push({label: "XĂ³a file", icon:"uniF11F", action: function(){
			Drive.file.remove(ref);
		}});
		
		
		return actions;
	};

	this.moveFile=function(ref){
		var file=getFile(ref);
		if (!file){
			return;
		}

		this.pendingPaste={
			action: "move",
			type: "file",
			item: file
		};

		AP.alertSuccess("ÄĂ£ copy tĂ i liá»‡u. Vui lĂ²ng chá»n má»™t thÆ° má»¥c khĂ¡c Ä‘á»ƒ paste");
	};

	function getFolder(ref){
		var folder={};
		if (ref){
			var $canvas=$(ref).closest('.item');
			var id=$canvas.data("id");
			var name=$canvas.data("name");
			var token=$canvas.data("token");
			folder={id: id, name: name, token: token};
		}else{
			folder=Client.pageData.folder;
		}

		return folder;
	};

	this.moveNow=function(ref){
		var folder=getFolder(ref);

		var data={id: this.pendingPaste.item.id, action: "move", to: folder.id};
		UI.ajaxShow();
		AP.post("api/base/file/move", data, function(code){
			UI.ajaxHide();

			if (!code.good()){
				return AP.alertError(code.message);
			}

			UI.flash("ÄĂ£ di chuyá»ƒn file thĂ nh cĂ´ng !");
			AP.xRefresh();
		});
	};

	this.remove=function(ref){
		var file=getFile(ref);
		var hiddens={id: file.id, token: file.token};
		
		AP.confirm("Báº¡n cĂ³ muá»‘n xĂ³a tĂ i liá»‡u: <b>"+file.name+"</b>? ", function(){
			UI.ajaxShow();
			AP.post("api/base/file/remove", hiddens, function(code){
				UI.ajaxHide();
				if (!code.good()){
					return AP.alertError(code.message);
				}
				UI.flash("TĂ i liá»‡u Ä‘Ă£ Ä‘Æ°á»£c xĂ³a ...");
				AP.xRefresh();
			});
		});
	};

	function getFile(ref){
		var file={};
		if (ref){
			var $canvas=$(ref).closest('.item');
			var id=$canvas.data("id");
			var name=$canvas.data("name");
			var token=$canvas.data("token");
			file={id: id, name: name, token: token};
		}
		
		return file;
	}

	this.preview=function(hid, token){
		AP.ajaxShow();
		AP.post("api/base/file/get",{file_id: hid, token: token}, function(code){
			AP.ajaxHide();
			if (!code.good()){
				AP.alertError(code.message);
				return;
			}

			Drive.file.displayImage(code.file);
		});
	};

	this.displayImage=function(file){	
		Drive.file.file=file;
		BC.title(Drive.file.getTitle(file));
		BC.side(Drive.file.getSide(file));
		BC.main(Drive.file.getMain(file));
		BC.show();

		Comment.auto("#side-comment-"+file.id, file);
		Comment.attachBottom("#bside", file);
		
		// $("#side-followers").html(BC.ui.followers(file));
		
		Follow.auto("#side-followers", {
			followers: file.followers,
			users: Client.people,
			endpoint: "api/base/file/follow",
			style: "compact",
			owners: [file.username],
			data: {obj_id: file.id, obj_token: file.token}
		});
	};

	
	this.getSide=function(file){
		return "<div id='side-followers' class='section'></div> <div id='side-comment-"+file.id+"'></div>";
	};
	

	this.getTitle=function(file, rev){
		var name=file.name;

		var meta=file.metatype;
		var since=file.since;
		if (rev){
			name=rev.name;
			download=rev.src;
			meta=rev.metatype;
			since=rev.since;
		}


		var icon=UI.file.icon(name);

		var download=file.src;
		if (meta=="" || meta=="upload"){
			// download=Client.url+'/files/download?id='+file.id+"&token="+file.token+"&key="+file.src;
		}

		if (meta=="base" && file.fid){
			download = Base.file.download(file.name, file.fid);
		}

		var rev_action='';
		if (parseInt(file.user_id)==parseInt(Client.viewer.id)){
		}


		var edit_action=" &middot; <span class='a action std' onclick=\"Drive.file.edit('"+file.id+"','"+file.token+"','"+file.name+"');\">Chá»‰nh sá»­a</span>";

		if (parseInt(file.user.id)!= parseInt(Client.viewer.id)){
			edit_action="";
		}

		var revs_action="";
		if (file.revs && file.revs.length){
			revs_action="<span class='action icon' title='Revisions' onclick='Drive.file.showRevs();'><span class='count'>"+file.revs.length+"</span><span class='-ap icon-layers2'></span></span>";
		}

		var other=" &middot; <span class='a action std advanced' onclick=\"Drive.file.PreviewOptions('"+file.hid+"','"+file.token+"','"+file.name+"');\">ThĂªm tĂ¹y chá»n</span>";



		return "" +
			"<div class='image'><img src='"+Client.share_url+"/32/file-"+icon+".png'></div>"+
			"<h1 class='ap-xdot' title='"+name+"'>"+name+"</h1>" +
			"<h3>Táº¡o bá»Ÿi <span class='a std url username'>@"+file.username+"</span> &middot; "+UI.simpleTime(since)+" &middot; Cáº­p nháº­t láº§n cuá»‘i "+UI.simpleTime(file.last_update)+" " +
			edit_action+
			rev_action+
			other+
			"</h3>" +
			"<div class='actions align-right'>" +
			revs_action+
			"   <span class='action icon' title='Extend preview' onclick='BC.extend();'><span class='-ap icon-open_in_new'></span></span>" +
			"   <a class='action icon' target='_blank' href='"+download+"' title='Download the file'><span class='-ap icon-get_app'></span></a>" +
			"</div>";
	};

	
	this.getMain=function(file){
		var regEx = /(?:\.([^.]+))?$/;
		var fileExtension = regEx.exec(file.name)[1];
		if (isImage(file) && !file.metatype=="googledrive" && !file.metatype=="dropbox" && !file.metatype=="onedrive"){
			return "<div class='embed-20'><div class='image'><img src='"+file.src+"'/></div></div>";
		} else if (isImage(file) && (file.metatype=="base" || file.metatype=="basedraw" || file.metatype=="upload")) {
			return "<div class='embed-20'><div class='image'><img src='"+file.src+"'/></div></div>";
		}else if (isEmbeddable(file) || (fileExtension == "txt")){
			if (file.metatype=="onedrive"){
				var url=file.src+"&em=2";


				// get cid
				var pos = url.indexOf('resid=');
				var suburl = url.substring(pos);
				var pivot = suburl.indexOf('!');
				var cid = suburl.substring(6, pivot);

				url = url.replace("redir?","embed?cid="+cid+"&");

				return "<div class='embed-20'>" +
					"<iframe src=\""+url+"\" style='width:100%; height:100%;' frameborder='0' scrolling='no'></iframe>"+
					"</div>";
			}else if (file.metatype=="dropbox"){
				var url=file.preview;
				if (!url){
					return "<div style='margin-top: 60px; font-size: 15px; text-align:center;'>" +
						"<div class='featured' style='margin-bottom: 15px;'>This file has been picked from Dropbox and can't be previewed.</div>" +
						"<a href='" + file.src + "' target='_blank'>Click here to download file</a>" +
						"</div>";
				}

				url=url.replace("bounding_box=75","bounding_box=800");
				return "<div class='embed-20'><div class='image'><img src='"+url+"'/></div></div>"
			}else if (file.metatype == "googledrive" || file.metatype == "google"){
				if ($.inArray(fileExtension, ['gdoc', 'gsheet', 'gdraw', 'gslides']) < 0) {
					return "<div class='embed-20'>" +
						"<iframe src=\""+file.src+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
						"</div>";
				} else {
					return "<div class='embed-20'>" +
						"<iframe src=\""+file.src.substr(0, file.src.lastIndexOf('?'))+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
						"</div>";
				}
			}

			// M$ Office file types
			if ($.inArray(fileExtension, ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx']) >= 0) {
				return "<div class='embed-20'>" +
					"<iframe src=\"https://view.officeapps.live.com/op/view.aspx?src="+file.url+"\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
			}

			if (Client.https) {
				return "<div class='embed-20'>" +
					"<iframe src=\"https://docs.google.com/gview?url="+file.url+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
					"</div>";
			}
			return "<div class='embed-20'>" +
				"<iframe src=\"http://docs.google.com/gview?url="+file.url+"&embedded=true\" style='width:100%; height:100%;' frameborder='0'></iframe>"+
				"</div>";
		}else{
			var download=file.url;
			return "<div class='center' style='padding:20px;'>KhĂ´ng cĂ³ báº£n xem trÆ°á»›c. HĂ£y <a href='"+download+"' target='_blank'>táº£i xuá»‘ng tá»‡p</a>.</div>";
		}
	};
	
};


Drive.engine=new function __DriveExt(){
	this.uploadFile = function (file, hid) {
		var sysid = Client.pageData.context.id;
		var folder_id = Client.pageData.folder ? Client.pageData.folder.id : 0;
		var src = (file.metatype != 'googledrive') ? file.weblink : file.preview;

		if (file.metatype == 'base') {
			src = file.src;
		}

		AP.post("api/base/file/upload.basedrive",{
			sysid: sysid,
			hid: hid,
			metatype: file.metatype,
			folder_id: folder_id,
			fid: file.fid,
			file_name: file.name,
			download_link: (file.download) ? (file.download) : file.embedUrl,
			preview:(file.preview) ? file.preview : file.embedUrl,
			file_size: (file.size) ? file.size : file.sizeByte,
			file_extension: (file.is_image == 1 && file.metatype == 'base') ? 'png' :file.ext,
			src : src
		},
		function(code){
			UI.ajaxHide();

			if (!code.good()){
				return AP.alertError(code.message);
			}
			AP.xRefresh();
		});
	};
};


var widgetsSortable = $.widget( "ui.sortable2", $.ui.mouse, {
	version: "1.12.1",
	widgetEventPrefix: "sort",
	ready: false,
	options: {
		appendTo: "parent",
		axis: false,
		connectWith: false,
		containment: false,
		cursor: "auto",
		cursorAt: false,
		dropOnEmpty: true,
		forcePlaceholderSize: false,
		forceHelperSize: false,
		grid: false,
		handle: false,
		helper: "original",
		items: "> *",
		opacity: false,
		placeholder: false,
		revert: false,
		scroll: true,
		scrollSensitivity: 20,
		scrollSpeed: 20,
		scope: "default",
		tolerance: "intersect",
		zIndex: 1000,
		precomputedContainerOffset: null,
		// Callbacks
		activate: null,
		beforeStop: null,
		change: null,
		deactivate: null,
		out: null,
		over: null,
		receive: null,
		remove: null,
		sort: null,
		start: null,
		stop: null,
		update: null
	},

	_isOverAxis: function( x, reference, size ) {
		return ( x >= reference ) && ( x < ( reference + size ) );
	},

	_isFloating: function( item ) {
		return ( /left|right/ ).test( item.css( "float" ) ) ||
			( /inline|table-cell/ ).test( item.css( "display" ) );
	},

	_create: function() {

		this.containerCache = {};
		this._addClass( "ui-sortable" );

		//Get the items
		this.refresh();

		////Let's determine the parent's offset
		if (this.options.precomputedContainerOffset) {
			this.offset = this.options.precomputedContainerOffset;
		} else {
			this.offset = this.element.offset();
		}

		//Initialize mouse events for interaction
		this._mouseInit();

		this._setHandleClassName();

		//We're ready to go
		this.ready = true;

	},

	_setOption: function( key, value ) {
		this._super( key, value );

		if ( key === "handle" ) {
			this._setHandleClassName();
		}
	},

	_setHandleClassName: function() {
		var that = this;
		this._removeClass( this.element.find( ".ui-sortable-handle" ), "ui-sortable-handle" );

		/**
		 * @caonguyen - Base.vn
		 * Change this._addClass() to .addClass() to boost performance issue in task list
		 */
		$.each( this.items, function() {
			(this.instance.options.handle 
				? this.item.find( this.instance.options.handle ) 
				: this.item
			   ).addClass('ui-sortable-handle');
		} );
	},

	_destroy: function() {
		this._mouseDestroy();

		for ( var i = this.items.length - 1; i >= 0; i-- ) {
			this.items[ i ].item.removeData( this.widgetName + "-item" );
		}

		return this;
	},

	_mouseCapture: function( event, overrideHandle ) {
		var currentItem = null,
			validHandle = false,
			that = this;

		if ( this.reverting ) {
			return false;
		}

		if ( this.options.disabled || this.options.type === "static" ) {
			return false;
		}

		//We have to refresh the items data once first
		this._refreshItems( event );

		//Find out if the clicked node (or one of its parents) is a actual item in this.items
		$( event.target ).parents().each( function() {
			if ( $.data( this, that.widgetName + "-item" ) === that ) {
				currentItem = $( this );
				return false;
			}
		} );
		if ( $.data( event.target, that.widgetName + "-item" ) === that ) {
			currentItem = $( event.target );
		}

		if ( !currentItem ) {
			return false;
		}
		if ( this.options.handle && !overrideHandle ) {
			$( this.options.handle, currentItem ).find( "*" ).addBack().each( function() {
				if ( this === event.target ) {
					validHandle = true;
				}
			} );
			if ( !validHandle ) {
				return false;
			}
		}

		this.currentItem = currentItem;
		this._removeCurrentsFromItems();
		return true;

	},

	_mouseStart: function( event, overrideHandle, noActivation ) {

		var i, body,
			o = this.options;

		this.currentContainer = this;

		//We only need to call refreshPositions, because the refreshItems call has been moved to
		// mouseCapture
		this.refreshPositions();

		//Create and append the visible helper
		this.helper = this._createHelper( event );

		//Cache the helper size
		this._cacheHelperProportions();

		/*
		 * - Position generation -
		 * This block generates everything position related - it's the core of draggables.
		 */

		//Cache the margins of the original element
		this._cacheMargins();

		//Get the next scrolling parent
		this.scrollParent = this.helper.scrollParent();

		//The element's absolute position on the page minus margins
		this.offset = this.currentItem.offset();
		this.offset = {
			top: this.offset.top - this.margins.top,
			left: this.offset.left - this.margins.left
		};

		$.extend( this.offset, {
			click: { //Where the click happened, relative to the element
				left: event.pageX - this.offset.left,
				top: event.pageY - this.offset.top
			},
			parent: this._getParentOffset(),

			// This is a relative to absolute position minus the actual position calculation -
			// only used for relative positioned helper
			relative: this._getRelativeOffset()
		} );

		// Only after we got the offset, we can change the helper's position to absolute
		// TODO: Still need to figure out a way to make relative sorting possible
		this.helper.css( "position", "absolute" );
		this.cssPosition = this.helper.css( "position" );

		//Generate the original position
		this.originalPosition = this._generatePosition( event );
		this.originalPageX = event.pageX;
		this.originalPageY = event.pageY;

		//Adjust the mouse offset relative to the helper if "cursorAt" is supplied
		( o.cursorAt && this._adjustOffsetFromHelper( o.cursorAt ) );

		//Cache the former DOM position
		this.domPosition = {
			prev: this.currentItem.prev()[ 0 ],
			parent: this.currentItem.parent()[ 0 ]
		};

		// If the helper is not the original, hide the original so it's not playing any role during
		// the drag, won't cause anything bad this way
		if ( this.helper[ 0 ] !== this.currentItem[ 0 ] ) {
			this.currentItem.hide();
		}

		//Create the placeholder
		this._createPlaceholder();

		//Set a containment if given in the options
		if ( o.containment ) {
			this._setContainment();
		}

		if ( o.cursor && o.cursor !== "auto" ) { // cursor option
			body = this.document.find( "body" );

			// Support: IE
			this.storedCursor = body.css( "cursor" );
			body.css( "cursor", o.cursor );

			this.storedStylesheet =
				$( "<style>*{ cursor: " + o.cursor + " !important; }</style>" ).appendTo( body );
		}

		if ( o.opacity ) { // opacity option
			if ( this.helper.css( "opacity" ) ) {
				this._storedOpacity = this.helper.css( "opacity" );
			}
			this.helper.css( "opacity", o.opacity );
		}

		if ( o.zIndex ) { // zIndex option
			if ( this.helper.css( "zIndex" ) ) {
				this._storedZIndex = this.helper.css( "zIndex" );
			}
			this.helper.css( "zIndex", o.zIndex );
		}

		//Prepare scrolling
		if ( this.scrollParent[ 0 ] !== this.document[ 0 ] &&
				this.scrollParent[ 0 ].tagName !== "HTML" ) {
			this.overflowOffset = this.scrollParent.offset();
		}

		//Call callbacks
		this._trigger( "start", event, this._uiHash() );

		//Recache the helper size
		if ( !this._preserveHelperProportions ) {
			this._cacheHelperProportions();
		}

		//Post "activate" events to possible containers
		if ( !noActivation ) {
			for ( i = this.containers.length - 1; i >= 0; i-- ) {
				this.containers[ i ]._trigger( "activate", event, this._uiHash( this ) );
			}
		}

		//Prepare possible droppables
		if ( $.ui.ddmanager ) {
			$.ui.ddmanager.current = this;
		}

		if ( $.ui.ddmanager && !o.dropBehaviour ) {
			$.ui.ddmanager.prepareOffsets( this, event );
		}

		this.dragging = true;

		this._addClass( this.helper, "ui-sortable-helper" );

		// Execute the drag once - this causes the helper not to be visiblebefore getting its
		// correct position
		this._mouseDrag( event );
		return true;

	},

	_mouseDrag: function( event ) {
		var i, item, itemElement, intersection,
			o = this.options,
			scrolled = false;

		//Compute the helpers position
		this.position = this._generatePosition( event );
		this.positionAbs = this._convertPositionTo( "absolute" );

		if ( !this.lastPositionAbs ) {
			this.lastPositionAbs = this.positionAbs;
		}

		//Do scrolling
		if ( this.options.scroll ) {
			if ( this.scrollParent[ 0 ] !== this.document[ 0 ] &&
					this.scrollParent[ 0 ].tagName !== "HTML" ) {

				if ( ( this.overflowOffset.top + this.scrollParent[ 0 ].offsetHeight ) -
						event.pageY < o.scrollSensitivity ) {
					this.scrollParent[ 0 ].scrollTop =
						scrolled = this.scrollParent[ 0 ].scrollTop + o.scrollSpeed;
				} else if ( event.pageY - this.overflowOffset.top < o.scrollSensitivity ) {
					this.scrollParent[ 0 ].scrollTop =
						scrolled = this.scrollParent[ 0 ].scrollTop - o.scrollSpeed;
				}

				if ( ( this.overflowOffset.left + this.scrollParent[ 0 ].offsetWidth ) -
						event.pageX < o.scrollSensitivity ) {
					this.scrollParent[ 0 ].scrollLeft = scrolled =
						this.scrollParent[ 0 ].scrollLeft + o.scrollSpeed;
				} else if ( event.pageX - this.overflowOffset.left < o.scrollSensitivity ) {
					this.scrollParent[ 0 ].scrollLeft = scrolled =
						this.scrollParent[ 0 ].scrollLeft - o.scrollSpeed;
				}

			} else {

				if ( event.pageY - this.document.scrollTop() < o.scrollSensitivity ) {
					scrolled = this.document.scrollTop( this.document.scrollTop() - o.scrollSpeed );
				} else if ( this.window.height() - ( event.pageY - this.document.scrollTop() ) <
						o.scrollSensitivity ) {
					scrolled = this.document.scrollTop( this.document.scrollTop() + o.scrollSpeed );
				}

				if ( event.pageX - this.document.scrollLeft() < o.scrollSensitivity ) {
					scrolled = this.document.scrollLeft(
						this.document.scrollLeft() - o.scrollSpeed
					);
				} else if ( this.window.width() - ( event.pageX - this.document.scrollLeft() ) <
						o.scrollSensitivity ) {
					scrolled = this.document.scrollLeft(
						this.document.scrollLeft() + o.scrollSpeed
					);
				}

			}

			if ( scrolled !== false && $.ui.ddmanager && !o.dropBehaviour ) {
				$.ui.ddmanager.prepareOffsets( this, event );
			}
		}

		//Regenerate the absolute position used for position checks
		this.positionAbs = this._convertPositionTo( "absolute" );

		//Set the helper position
		if ( !this.options.axis || this.options.axis !== "y" ) {
			this.helper[ 0 ].style.left = this.position.left + "px";
		}
		if ( !this.options.axis || this.options.axis !== "x" ) {
			this.helper[ 0 ].style.top = this.position.top + "px";
		}

		//Rearrange
		for ( i = this.items.length - 1; i >= 0; i-- ) {

			//Cache variables and intersection, continue if no intersection
			item = this.items[ i ];
			itemElement = item.item[ 0 ];
			intersection = this._intersectsWithPointer( item );
			if ( !intersection ) {
				continue;
			}

			// Only put the placeholder inside the current Container, skip all
			// items from other containers. This works because when moving
			// an item from one container to another the
			// currentContainer is switched before the placeholder is moved.
			//
			// Without this, moving items in "sub-sortables" can cause
			// the placeholder to jitter between the outer and inner container.
			if ( item.instance !== this.currentContainer ) {
				continue;
			}

			// Cannot intersect with itself
			// no useless actions that have been done before
			// no action if the item moved is the parent of the item checked
			if ( itemElement !== this.currentItem[ 0 ] &&
				this.placeholder[ intersection === 1 ? "next" : "prev" ]()[ 0 ] !== itemElement &&
				!$.contains( this.placeholder[ 0 ], itemElement ) &&
				( this.options.type === "semi-dynamic" ?
					!$.contains( this.element[ 0 ], itemElement ) :
					true
				)
			) {

				this.direction = intersection === 1 ? "down" : "up";

				if ( this.options.tolerance === "pointer" || this._intersectsWithSides( item ) ) {
					this._rearrange( event, item );
				} else {
					break;
				}

				this._trigger( "change", event, this._uiHash() );
				break;
			}
		}

		//Post events to containers
		this._contactContainers( event );

		//Interconnect with droppables
		if ( $.ui.ddmanager ) {
			$.ui.ddmanager.drag( this, event );
		}

		//Call callbacks
		this._trigger( "sort", event, this._uiHash() );

		this.lastPositionAbs = this.positionAbs;
		return false;

	},

	_mouseStop: function( event, noPropagation ) {

		if ( !event ) {
			return;
		}

		//If we are using droppables, inform the manager about the drop
		if ( $.ui.ddmanager && !this.options.dropBehaviour ) {
			$.ui.ddmanager.drop( this, event );
		}

		if ( this.options.revert ) {
			var that = this,
				cur = this.placeholder.offset(),
				axis = this.options.axis,
				animation = {};

			if ( !axis || axis === "x" ) {
				animation.left = cur.left - this.offset.parent.left - this.margins.left +
					( this.offsetParent[ 0 ] === this.document[ 0 ].body ?
						0 :
						this.offsetParent[ 0 ].scrollLeft
					);
			}
			if ( !axis || axis === "y" ) {
				animation.top = cur.top - this.offset.parent.top - this.margins.top +
					( this.offsetParent[ 0 ] === this.document[ 0 ].body ?
						0 :
						this.offsetParent[ 0 ].scrollTop
					);
			}
			this.reverting = true;
			$( this.helper ).animate(
				animation,
				parseInt( this.options.revert, 10 ) || 500,
				function() {
					that._clear( event );
				}
			);
		} else {
			this._clear( event, noPropagation );
		}

		return false;

	},

	cancel: function() {

		if ( this.dragging ) {

			this._mouseUp( new $.Event( "mouseup", { target: null } ) );

			if ( this.options.helper === "original" ) {
				this.currentItem.css( this._storedCSS );
				this._removeClass( this.currentItem, "ui-sortable-helper" );
			} else {
				this.currentItem.show();
			}

			//Post deactivating events to containers
			for ( var i = this.containers.length - 1; i >= 0; i-- ) {
				this.containers[ i ]._trigger( "deactivate", null, this._uiHash( this ) );
				if ( this.containers[ i ].containerCache.over ) {
					this.containers[ i ]._trigger( "out", null, this._uiHash( this ) );
					this.containers[ i ].containerCache.over = 0;
				}
			}

		}

		if ( this.placeholder ) {

			//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately,
			// it unbinds ALL events from the original node!
			if ( this.placeholder[ 0 ].parentNode ) {
				this.placeholder[ 0 ].parentNode.removeChild( this.placeholder[ 0 ] );
			}
			if ( this.options.helper !== "original" && this.helper &&
					this.helper[ 0 ].parentNode ) {
				this.helper.remove();
			}

			$.extend( this, {
				helper: null,
				dragging: false,
				reverting: false,
				_noFinalSort: null
			} );

			if ( this.domPosition.prev ) {
				$( this.domPosition.prev ).after( this.currentItem );
			} else {
				$( this.domPosition.parent ).prepend( this.currentItem );
			}
		}

		return this;

	},

	serialize: function( o ) {

		var items = this._getItemsAsjQuery( o && o.connected ),
			str = [];
		o = o || {};

		$( items ).each( function() {
			var res = ( $( o.item || this ).attr( o.attribute || "id" ) || "" )
				.match( o.expression || ( /(.+)[\-=_](.+)/ ) );
			if ( res ) {
				str.push(
					( o.key || res[ 1 ] + "[]" ) +
					"=" + ( o.key && o.expression ? res[ 1 ] : res[ 2 ] ) );
			}
		} );

		if ( !str.length && o.key ) {
			str.push( o.key + "=" );
		}

		return str.join( "&" );

	},

	toArray: function( o ) {

		var items = this._getItemsAsjQuery( o && o.connected ),
			ret = [];

		o = o || {};

		items.each( function() {
			ret.push( $( o.item || this ).attr( o.attribute || "id" ) || "" );
		} );
		return ret;

	},

	/* Be careful with the following core functions */
	_intersectsWith: function( item ) {

		var x1 = this.positionAbs.left,
			x2 = x1 + this.helperProportions.width,
			y1 = this.positionAbs.top,
			y2 = y1 + this.helperProportions.height,
			l = item.left,
			r = l + item.width,
			t = item.top,
			b = t + item.height,
			dyClick = this.offset.click.top,
			dxClick = this.offset.click.left,
			isOverElementHeight = ( this.options.axis === "x" ) || ( ( y1 + dyClick ) > t &&
				( y1 + dyClick ) < b ),
			isOverElementWidth = ( this.options.axis === "y" ) || ( ( x1 + dxClick ) > l &&
				( x1 + dxClick ) < r ),
			isOverElement = isOverElementHeight && isOverElementWidth;

		if ( this.options.tolerance === "pointer" ||
			this.options.forcePointerForContainers ||
			( this.options.tolerance !== "pointer" &&
				this.helperProportions[ this.floating ? "width" : "height" ] >
				item[ this.floating ? "width" : "height" ] )
		) {
			return isOverElement;
		} else {

			return ( l < x1 + ( this.helperProportions.width / 2 ) && // Right Half
				x2 - ( this.helperProportions.width / 2 ) < r && // Left Half
				t < y1 + ( this.helperProportions.height / 2 ) && // Bottom Half
				y2 - ( this.helperProportions.height / 2 ) < b ); // Top Half

		}
	},

	_intersectsWithPointer: function( item ) {
		var verticalDirection, horizontalDirection,
			isOverElementHeight = ( this.options.axis === "x" ) ||
				this._isOverAxis(
					this.positionAbs.top + this.offset.click.top, item.top, item.height ),
			isOverElementWidth = ( this.options.axis === "y" ) ||
				this._isOverAxis(
					this.positionAbs.left + this.offset.click.left, item.left, item.width ),
			isOverElement = isOverElementHeight && isOverElementWidth;

		if ( !isOverElement ) {
			return false;
		}

		verticalDirection = this._getDragVerticalDirection();
		horizontalDirection = this._getDragHorizontalDirection();

		return this.floating ?
			( ( horizontalDirection === "right" || verticalDirection === "down" ) ? 2 : 1 )
			: ( verticalDirection && ( verticalDirection === "down" ? 2 : 1 ) );

	},

	_intersectsWithSides: function( item ) {

		var isOverBottomHalf = this._isOverAxis( this.positionAbs.top +
				this.offset.click.top, item.top + ( item.height / 2 ), item.height ),
			isOverRightHalf = this._isOverAxis( this.positionAbs.left +
				this.offset.click.left, item.left + ( item.width / 2 ), item.width ),
			verticalDirection = this._getDragVerticalDirection(),
			horizontalDirection = this._getDragHorizontalDirection();

		if ( this.floating && horizontalDirection ) {
			return ( ( horizontalDirection === "right" && isOverRightHalf ) ||
				( horizontalDirection === "left" && !isOverRightHalf ) );
		} else {
			return verticalDirection && ( ( verticalDirection === "down" && isOverBottomHalf ) ||
				( verticalDirection === "up" && !isOverBottomHalf ) );
		}

	},

	_getDragVerticalDirection: function() {
		var delta = this.positionAbs.top - this.lastPositionAbs.top;
		return delta !== 0 && ( delta > 0 ? "down" : "up" );
	},

	_getDragHorizontalDirection: function() {
		var delta = this.positionAbs.left - this.lastPositionAbs.left;
		return delta !== 0 && ( delta > 0 ? "right" : "left" );
	},

	refresh: function( event ) {
		this._refreshItems( event );
		this._setHandleClassName();
		this.refreshPositions();
		return this;
	},

	_connectWith: function() {
		var options = this.options;
		return options.connectWith.constructor === String ?
			[ options.connectWith ] :
			options.connectWith;
	},

	_getItemsAsjQuery: function( connected ) {

		var i, j, cur, inst,
			items = [],
			queries = [],
			connectWith = this._connectWith();

		if ( connectWith && connected ) {
			for ( i = connectWith.length - 1; i >= 0; i-- ) {
				cur = $( connectWith[ i ], this.document[ 0 ] );
				for ( j = cur.length - 1; j >= 0; j-- ) {
					inst = $.data( cur[ j ], this.widgetFullName );
					if ( inst && inst !== this && !inst.options.disabled ) {
						queries.push( [ $.isFunction( inst.options.items ) ?
							inst.options.items.call( inst.element ) :
							$( inst.options.items, inst.element )
								.not( ".ui-sortable-helper" )
								.not( ".ui-sortable-placeholder" ), inst ] );
					}
				}
			}
		}

		queries.push( [ $.isFunction( this.options.items ) ?
			this.options.items
				.call( this.element, null, { options: this.options, item: this.currentItem } ) :
			$( this.options.items, this.element )
				.not( ".ui-sortable-helper" )
				.not( ".ui-sortable-placeholder" ), this ] );

		function addItems() {
			items.push( this );
		}
		for ( i = queries.length - 1; i >= 0; i-- ) {
			queries[ i ][ 0 ].each( addItems );
		}

		return $( items );

	},

	_removeCurrentsFromItems: function() {

		var list = this.currentItem.find( ":data(" + this.widgetName + "-item)" );

		this.items = $.grep( this.items, function( item ) {
			for ( var j = 0; j < list.length; j++ ) {
				if ( list[ j ] === item.item[ 0 ] ) {
					return false;
				}
			}
			return true;
		} );

	},

	_refreshItems: function( event ) {

		this.items = [];
		this.containers = [ this ];

		var i, j, cur, inst, targetData, _queries, item, queriesLength,
			items = this.items,
			queries = [ [ $.isFunction( this.options.items ) ?
				this.options.items.call( this.element[ 0 ], event, { item: this.currentItem } ) :
				$( this.options.items, this.element ), this ] ],
			connectWith = this._connectWith();

		//Shouldn't be run the first time through due to massive slow-down
		if ( connectWith && this.ready ) {
			for ( i = connectWith.length - 1; i >= 0; i-- ) {
				cur = $( connectWith[ i ], this.document[ 0 ] );
				for ( j = cur.length - 1; j >= 0; j-- ) {
					inst = $.data( cur[ j ], this.widgetFullName );
					if ( inst && inst !== this && !inst.options.disabled ) {
						queries.push( [ $.isFunction( inst.options.items ) ?
							inst.options.items
								.call( inst.element[ 0 ], event, { item: this.currentItem } ) :
							$( inst.options.items, inst.element ), inst ] );
						this.containers.push( inst );
					}
				}
			}
		}

		for ( i = queries.length - 1; i >= 0; i-- ) {
			targetData = queries[ i ][ 1 ];
			_queries = queries[ i ][ 0 ];

			for ( j = 0, queriesLength = _queries.length; j < queriesLength; j++ ) {
				item = $( _queries[ j ] );

				// Data for target checking (mouse manager)
				item.data( this.widgetName + "-item", targetData );

				items.push( {
					item: item,
					instance: targetData,
					width: 0, height: 0,
					left: 0, top: 0
				} );
			}
		}

	},

	refreshPositions: function( fast ) {

		// Determine whether items are being displayed horizontally
		this.floating = this.items.length ?
			this.options.axis === "x" || this._isFloating( this.items[ 0 ].item ) :
			false;
		//this.floating = false;

		//This has to be redone because due to the item being moved out/into the offsetParent,
		// the offsetParent's position will change
		if ( this.offsetParent && this.helper ) {
			this.offset.parent = this._getParentOffset();
		}

		var i, item, t, p;

		for ( i = this.items.length - 1; i >= 0; i-- ) {
			item = this.items[ i ];

			//We ignore calculating positions of all connected containers when we're not over them
			if ( item.instance !== this.currentContainer && this.currentContainer &&
					item.item[ 0 ] !== this.currentItem[ 0 ] ) {
				continue;
			}

			t = this.options.toleranceElement ?
				$( this.options.toleranceElement, item.item ) :
				item.item;

			if ( !fast ) {
				item.width = t.outerWidth();
				item.height = t.outerHeight();
			}

			/**
			 * @caonguyen - Optimize offset() function , call once
			 */
			if (i < this.items.length - 1) {
				item.left = this.items[i + 1].left;
				item.top = this.items[i + 1].top - item.height;
			} else {
				p = t.offset();
				item.left = p.left;
				item.top = p.top;
			}
		}

		if ( this.options.custom && this.options.custom.refreshContainers ) {
			this.options.custom.refreshContainers.call( this );
		} else {
			for ( i = this.containers.length - 1; i >= 0; i-- ) {
				p = this.containers[ i ].element.offset();
				this.containers[ i ].containerCache.left = p.left;
				this.containers[ i ].containerCache.top = p.top;
				this.containers[ i ].containerCache.width =
					this.containers[ i ].element.outerWidth();
				this.containers[ i ].containerCache.height =
					this.containers[ i ].element.outerHeight();
			}
		}

		return this;
	},

	_createPlaceholder: function( that ) {
		that = that || this;
		var className,
			o = that.options;

		if ( !o.placeholder || o.placeholder.constructor === String ) {
			className = o.placeholder;
			o.placeholder = {
				element: function() {

					var nodeName = that.currentItem[ 0 ].nodeName.toLowerCase(),
						element = $( "<" + nodeName + ">", that.document[ 0 ] );

						that._addClass( element, "ui-sortable-placeholder",
								className || that.currentItem[ 0 ].className )
							._removeClass( element, "ui-sortable-helper" );

					if ( nodeName === "tbody" ) {
						that._createTrPlaceholder(
							that.currentItem.find( "tr" ).eq( 0 ),
							$( "<tr>", that.document[ 0 ] ).appendTo( element )
						);
					} else if ( nodeName === "tr" ) {
						that._createTrPlaceholder( that.currentItem, element );
					} else if ( nodeName === "img" ) {
						element.attr( "src", that.currentItem.attr( "src" ) );
					}

					if ( !className ) {
						element.css( "visibility", "hidden" );
					}

					return element;
				},
				update: function( container, p ) {

					// 1. If a className is set as 'placeholder option, we don't force sizes -
					// the class is responsible for that
					// 2. The option 'forcePlaceholderSize can be enabled to force it even if a
					// class name is specified
					if ( className && !o.forcePlaceholderSize ) {
						return;
					}

					//If the element doesn't have a actual height by itself (without styles coming
					// from a stylesheet), it receives the inline height from the dragged item
					if ( !p.height() ) {
						p.height(
							that.currentItem.innerHeight() -
							parseInt( that.currentItem.css( "paddingTop" ) || 0, 10 ) -
							parseInt( that.currentItem.css( "paddingBottom" ) || 0, 10 ) );
					}
					if ( !p.width() ) {
						p.width(
							that.currentItem.innerWidth() -
							parseInt( that.currentItem.css( "paddingLeft" ) || 0, 10 ) -
							parseInt( that.currentItem.css( "paddingRight" ) || 0, 10 ) );
					}
				}
			};
		}

		//Create the placeholder
		that.placeholder = $( o.placeholder.element.call( that.element, that.currentItem ) );

		//Append it after the actual current item
		that.currentItem.after( that.placeholder );

		//Update the size of the placeholder (TODO: Logic to fuzzy, see line 316/317)
		o.placeholder.update( that, that.placeholder );

	},

	_createTrPlaceholder: function( sourceTr, targetTr ) {
		var that = this;

		sourceTr.children().each( function() {
			$( "<td>&#160;</td>", that.document[ 0 ] )
				.attr( "colspan", $( this ).attr( "colspan" ) || 1 )
				.appendTo( targetTr );
		} );
	},

	_contactContainers: function( event ) {
		var i, j, dist, itemWithLeastDistance, posProperty, sizeProperty, cur, nearBottom,
			floating, axis,
			innermostContainer = null,
			innermostIndex = null;

		// Get innermost container that intersects with item
		for ( i = this.containers.length - 1; i >= 0; i-- ) {

			// Never consider a container that's located within the item itself
			if ( $.contains( this.currentItem[ 0 ], this.containers[ i ].element[ 0 ] ) ) {
				continue;
			}

			if ( this._intersectsWith( this.containers[ i ].containerCache ) ) {

				// If we've already found a container and it's more "inner" than this, then continue
				if ( innermostContainer &&
						$.contains(
							this.containers[ i ].element[ 0 ],
							innermostContainer.element[ 0 ] ) ) {
					continue;
				}

				innermostContainer = this.containers[ i ];
				innermostIndex = i;

			} else {

				// container doesn't intersect. trigger "out" event if necessary
				if ( this.containers[ i ].containerCache.over ) {
					this.containers[ i ]._trigger( "out", event, this._uiHash( this ) );
					this.containers[ i ].containerCache.over = 0;
				}
			}

		}

		// If no intersecting containers found, return
		if ( !innermostContainer ) {
			return;
		}

		// Move the item into the container if it's not there already
		if ( this.containers.length === 1 ) {
			if ( !this.containers[ innermostIndex ].containerCache.over ) {
				this.containers[ innermostIndex ]._trigger( "over", event, this._uiHash( this ) );
				this.containers[ innermostIndex ].containerCache.over = 1;
			}
		} else {

			// When entering a new container, we will find the item with the least distance and
			// append our item near it
			dist = 10000;
			itemWithLeastDistance = null;
			floating = innermostContainer.floating || this._isFloating( this.currentItem );
			posProperty = floating ? "left" : "top";
			sizeProperty = floating ? "width" : "height";
			axis = floating ? "pageX" : "pageY";

			for ( j = this.items.length - 1; j >= 0; j-- ) {
				if ( !$.contains(
						this.containers[ innermostIndex ].element[ 0 ], this.items[ j ].item[ 0 ] )
				) {
					continue;
				}
				if ( this.items[ j ].item[ 0 ] === this.currentItem[ 0 ] ) {
					continue;
				}

				cur = this.items[ j ].item.offset()[ posProperty ];
				nearBottom = false;
				if ( event[ axis ] - cur > this.items[ j ][ sizeProperty ] / 2 ) {
					nearBottom = true;
				}

				if ( Math.abs( event[ axis ] - cur ) < dist ) {
					dist = Math.abs( event[ axis ] - cur );
					itemWithLeastDistance = this.items[ j ];
					this.direction = nearBottom ? "up" : "down";
				}
			}

			//Check if dropOnEmpty is enabled
			if ( !itemWithLeastDistance && !this.options.dropOnEmpty ) {
				return;
			}

			if ( this.currentContainer === this.containers[ innermostIndex ] ) {
				if ( !this.currentContainer.containerCache.over ) {
					this.containers[ innermostIndex ]._trigger( "over", event, this._uiHash() );
					this.currentContainer.containerCache.over = 1;
				}
				return;
			}

			itemWithLeastDistance ?
				this._rearrange( event, itemWithLeastDistance, null, true ) :
				this._rearrange( event, null, this.containers[ innermostIndex ].element, true );
			this._trigger( "change", event, this._uiHash() );
			this.containers[ innermostIndex ]._trigger( "change", event, this._uiHash( this ) );
			this.currentContainer = this.containers[ innermostIndex ];

			//Update the placeholder
			this.options.placeholder.update( this.currentContainer, this.placeholder );

			this.containers[ innermostIndex ]._trigger( "over", event, this._uiHash( this ) );
			this.containers[ innermostIndex ].containerCache.over = 1;
		}

	},

	_createHelper: function( event ) {

		var o = this.options,
			helper = $.isFunction( o.helper ) ?
				$( o.helper.apply( this.element[ 0 ], [ event, this.currentItem ] ) ) :
				( o.helper === "clone" ? this.currentItem.clone() : this.currentItem );

		//Add the helper to the DOM if that didn't happen already
		if ( !helper.parents( "body" ).length ) {
			$( o.appendTo !== "parent" ?
				o.appendTo :
				this.currentItem[ 0 ].parentNode )[ 0 ].appendChild( helper[ 0 ] );
		}

		if ( helper[ 0 ] === this.currentItem[ 0 ] ) {
			this._storedCSS = {
				width: this.currentItem[ 0 ].style.width,
				height: this.currentItem[ 0 ].style.height,
				position: this.currentItem.css( "position" ),
				top: this.currentItem.css( "top" ),
				left: this.currentItem.css( "left" )
			};
		}

		if ( !helper[ 0 ].style.width || o.forceHelperSize ) {
			helper.width( this.currentItem.width() );
		}
		if ( !helper[ 0 ].style.height || o.forceHelperSize ) {
			helper.height( this.currentItem.height() );
		}

		return helper;

	},

	_adjustOffsetFromHelper: function( obj ) {
		if ( typeof obj === "string" ) {
			obj = obj.split( " " );
		}
		if ( $.isArray( obj ) ) {
			obj = { left: +obj[ 0 ], top: +obj[ 1 ] || 0 };
		}
		if ( "left" in obj ) {
			this.offset.click.left = obj.left + this.margins.left;
		}
		if ( "right" in obj ) {
			this.offset.click.left = this.helperProportions.width - obj.right + this.margins.left;
		}
		if ( "top" in obj ) {
			this.offset.click.top = obj.top + this.margins.top;
		}
		if ( "bottom" in obj ) {
			this.offset.click.top = this.helperProportions.height - obj.bottom + this.margins.top;
		}
	},

	_getParentOffset: function() {

		//Get the offsetParent and cache its position
		this.offsetParent = this.helper.offsetParent();
		var po = this.offsetParent.offset();

		// This is a special case where we need to modify a offset calculated on start, since the
		// following happened:
		// 1. The position of the helper is absolute, so it's position is calculated based on the
		// next positioned parent
		// 2. The actual offset parent is a child of the scroll parent, and the scroll parent isn't
		// the document, which means that the scroll is included in the initial calculation of the
		// offset of the parent, and never recalculated upon drag
		if ( this.cssPosition === "absolute" && this.scrollParent[ 0 ] !== this.document[ 0 ] &&
				$.contains( this.scrollParent[ 0 ], this.offsetParent[ 0 ] ) ) {
			po.left += this.scrollParent.scrollLeft();
			po.top += this.scrollParent.scrollTop();
		}

		// This needs to be actually done for all browsers, since pageX/pageY includes this
		// information with an ugly IE fix
		if ( this.offsetParent[ 0 ] === this.document[ 0 ].body ||
				( this.offsetParent[ 0 ].tagName &&
				this.offsetParent[ 0 ].tagName.toLowerCase() === "html" && $.ui.ie ) ) {
			po = { top: 0, left: 0 };
		}

		return {
			top: po.top + ( parseInt( this.offsetParent.css( "borderTopWidth" ), 10 ) || 0 ),
			left: po.left + ( parseInt( this.offsetParent.css( "borderLeftWidth" ), 10 ) || 0 )
		};

	},

	_getRelativeOffset: function() {

		if ( this.cssPosition === "relative" ) {
			var p = this.currentItem.position();
			return {
				top: p.top - ( parseInt( this.helper.css( "top" ), 10 ) || 0 ) +
					this.scrollParent.scrollTop(),
				left: p.left - ( parseInt( this.helper.css( "left" ), 10 ) || 0 ) +
					this.scrollParent.scrollLeft()
			};
		} else {
			return { top: 0, left: 0 };
		}

	},

	_cacheMargins: function() {
		this.margins = {
			left: ( parseInt( this.currentItem.css( "marginLeft" ), 10 ) || 0 ),
			top: ( parseInt( this.currentItem.css( "marginTop" ), 10 ) || 0 )
		};
	},

	_cacheHelperProportions: function() {
		this.helperProportions = {
			width: this.helper.outerWidth(),
			height: this.helper.outerHeight()
		};
	},

	_setContainment: function() {

		var ce, co, over,
			o = this.options;
		if ( o.containment === "parent" ) {
			o.containment = this.helper[ 0 ].parentNode;
		}
		if ( o.containment === "document" || o.containment === "window" ) {
			this.containment = [
				0 - this.offset.relative.left - this.offset.parent.left,
				0 - this.offset.relative.top - this.offset.parent.top,
				o.containment === "document" ?
					this.document.width() :
					this.window.width() - this.helperProportions.width - this.margins.left,
				( o.containment === "document" ?
					( this.document.height() || document.body.parentNode.scrollHeight ) :
					this.window.height() || this.document[ 0 ].body.parentNode.scrollHeight
				) - this.helperProportions.height - this.margins.top
			];
		}

		if ( !( /^(document|window|parent)$/ ).test( o.containment ) ) {
			ce = $( o.containment )[ 0 ];
			co = $( o.containment ).offset();
			over = ( $( ce ).css( "overflow" ) !== "hidden" );

			this.containment = [
				co.left + ( parseInt( $( ce ).css( "borderLeftWidth" ), 10 ) || 0 ) +
					( parseInt( $( ce ).css( "paddingLeft" ), 10 ) || 0 ) - this.margins.left,
				co.top + ( parseInt( $( ce ).css( "borderTopWidth" ), 10 ) || 0 ) +
					( parseInt( $( ce ).css( "paddingTop" ), 10 ) || 0 ) - this.margins.top,
				co.left + ( over ? Math.max( ce.scrollWidth, ce.offsetWidth ) : ce.offsetWidth ) -
					( parseInt( $( ce ).css( "borderLeftWidth" ), 10 ) || 0 ) -
					( parseInt( $( ce ).css( "paddingRight" ), 10 ) || 0 ) -
					this.helperProportions.width - this.margins.left,
				co.top + ( over ? Math.max( ce.scrollHeight, ce.offsetHeight ) : ce.offsetHeight ) -
					( parseInt( $( ce ).css( "borderTopWidth" ), 10 ) || 0 ) -
					( parseInt( $( ce ).css( "paddingBottom" ), 10 ) || 0 ) -
					this.helperProportions.height - this.margins.top
			];
		}

	},

	_convertPositionTo: function( d, pos ) {

		if ( !pos ) {
			pos = this.position;
		}
		var mod = d === "absolute" ? 1 : -1,
			scroll = this.cssPosition === "absolute" &&
				!( this.scrollParent[ 0 ] !== this.document[ 0 ] &&
				$.contains( this.scrollParent[ 0 ], this.offsetParent[ 0 ] ) ) ?
					this.offsetParent :
					this.scrollParent,
			scrollIsRootNode = ( /(html|body)/i ).test( scroll[ 0 ].tagName );

		return {
			top: (

				// The absolute mouse position
				pos.top	+

				// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.relative.top * mod +

				// The offsetParent's offset without borders (offset + border)
				this.offset.parent.top * mod -
				( ( this.cssPosition === "fixed" ?
					-this.scrollParent.scrollTop() :
					( scrollIsRootNode ? 0 : scroll.scrollTop() ) ) * mod )
			),
			left: (

				// The absolute mouse position
				pos.left +

				// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.relative.left * mod +

				// The offsetParent's offset without borders (offset + border)
				this.offset.parent.left * mod	-
				( ( this.cssPosition === "fixed" ?
					-this.scrollParent.scrollLeft() : scrollIsRootNode ? 0 :
					scroll.scrollLeft() ) * mod )
			)
		};

	},

	_generatePosition: function( event ) {

		var top, left,
			o = this.options,
			pageX = event.pageX,
			pageY = event.pageY,
			scroll = this.cssPosition === "absolute" &&
				!( this.scrollParent[ 0 ] !== this.document[ 0 ] &&
				$.contains( this.scrollParent[ 0 ], this.offsetParent[ 0 ] ) ) ?
					this.offsetParent :
					this.scrollParent,
				scrollIsRootNode = ( /(html|body)/i ).test( scroll[ 0 ].tagName );

		// This is another very weird special case that only happens for relative elements:
		// 1. If the css position is relative
		// 2. and the scroll parent is the document or similar to the offset parent
		// we have to refresh the relative offset during the scroll so there are no jumps
		if ( this.cssPosition === "relative" && !( this.scrollParent[ 0 ] !== this.document[ 0 ] &&
				this.scrollParent[ 0 ] !== this.offsetParent[ 0 ] ) ) {
			this.offset.relative = this._getRelativeOffset();
		}

		/*
		 * - Position constraining -
		 * Constrain the position to a mix of grid, containment.
		 */

		if ( this.originalPosition ) { //If we are not dragging yet, we won't check for options

			if ( this.containment ) {
				if ( event.pageX - this.offset.click.left < this.containment[ 0 ] ) {
					pageX = this.containment[ 0 ] + this.offset.click.left;
				}
				if ( event.pageY - this.offset.click.top < this.containment[ 1 ] ) {
					pageY = this.containment[ 1 ] + this.offset.click.top;
				}
				if ( event.pageX - this.offset.click.left > this.containment[ 2 ] ) {
					pageX = this.containment[ 2 ] + this.offset.click.left;
				}
				if ( event.pageY - this.offset.click.top > this.containment[ 3 ] ) {
					pageY = this.containment[ 3 ] + this.offset.click.top;
				}
			}

			if ( o.grid ) {
				top = this.originalPageY + Math.round( ( pageY - this.originalPageY ) /
					o.grid[ 1 ] ) * o.grid[ 1 ];
				pageY = this.containment ?
					( ( top - this.offset.click.top >= this.containment[ 1 ] &&
						top - this.offset.click.top <= this.containment[ 3 ] ) ?
							top :
							( ( top - this.offset.click.top >= this.containment[ 1 ] ) ?
								top - o.grid[ 1 ] : top + o.grid[ 1 ] ) ) :
								top;

				left = this.originalPageX + Math.round( ( pageX - this.originalPageX ) /
					o.grid[ 0 ] ) * o.grid[ 0 ];
				pageX = this.containment ?
					( ( left - this.offset.click.left >= this.containment[ 0 ] &&
						left - this.offset.click.left <= this.containment[ 2 ] ) ?
							left :
							( ( left - this.offset.click.left >= this.containment[ 0 ] ) ?
								left - o.grid[ 0 ] : left + o.grid[ 0 ] ) ) :
								left;
			}

		}

		return {
			top: (

				// The absolute mouse position
				pageY -

				// Click offset (relative to the element)
				this.offset.click.top -

				// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.relative.top -

				// The offsetParent's offset without borders (offset + border)
				this.offset.parent.top +
				( ( this.cssPosition === "fixed" ?
					-this.scrollParent.scrollTop() :
					( scrollIsRootNode ? 0 : scroll.scrollTop() ) ) )
			),
			left: (

				// The absolute mouse position
				pageX -

				// Click offset (relative to the element)
				this.offset.click.left -

				// Only for relative positioned nodes: Relative offset from element to offset parent
				this.offset.relative.left -

				// The offsetParent's offset without borders (offset + border)
				this.offset.parent.left +
				( ( this.cssPosition === "fixed" ?
					-this.scrollParent.scrollLeft() :
					scrollIsRootNode ? 0 : scroll.scrollLeft() ) )
			)
		};

	},

	_rearrange: function( event, i, a, hardRefresh ) {

		a ? a[ 0 ].appendChild( this.placeholder[ 0 ] ) :
			i.item[ 0 ].parentNode.insertBefore( this.placeholder[ 0 ],
				( this.direction === "down" ? i.item[ 0 ] : i.item[ 0 ].nextSibling ) );

		//Various things done here to improve the performance:
		// 1. we create a setTimeout, that calls refreshPositions
		// 2. on the instance, we have a counter variable, that get's higher after every append
		// 3. on the local scope, we copy the counter variable, and check in the timeout,
		// if it's still the same
		// 4. this lets only the last addition to the timeout stack through
		this.counter = this.counter ? ++this.counter : 1;
		var counter = this.counter;

		this._delay( function() {
			if ( counter === this.counter ) {

				//Precompute after each DOM insertion, NOT on mousemove
				this.refreshPositions( !hardRefresh );
			}
		} );

	},

	_clear: function( event, noPropagation ) {

		this.reverting = false;

		// We delay all events that have to be triggered to after the point where the placeholder
		// has been removed and everything else normalized again
		var i,
			delayedTriggers = [];

		// We first have to update the dom position of the actual currentItem
		// Note: don't do it if the current item is already removed (by a user), or it gets
		// reappended (see #4088)
		if ( !this._noFinalSort && this.currentItem.parent().length ) {
			this.placeholder.before( this.currentItem );
		}
		this._noFinalSort = null;

		if ( this.helper[ 0 ] === this.currentItem[ 0 ] ) {
			for ( i in this._storedCSS ) {
				if ( this._storedCSS[ i ] === "auto" || this._storedCSS[ i ] === "static" ) {
					this._storedCSS[ i ] = "";
				}
			}
			this.currentItem.css( this._storedCSS );
			this._removeClass( this.currentItem, "ui-sortable-helper" );
		} else {
			this.currentItem.show();
		}

		if ( this.fromOutside && !noPropagation ) {
			delayedTriggers.push( function( event ) {
				this._trigger( "receive", event, this._uiHash( this.fromOutside ) );
			} );
		}
		if ( ( this.fromOutside ||
				this.domPosition.prev !==
				this.currentItem.prev().not( ".ui-sortable-helper" )[ 0 ] ||
				this.domPosition.parent !== this.currentItem.parent()[ 0 ] ) && !noPropagation ) {

			// Trigger update callback if the DOM position has changed
			delayedTriggers.push( function( event ) {
				this._trigger( "update", event, this._uiHash() );
			} );
		}

		// Check if the items Container has Changed and trigger appropriate
		// events.
		if ( this !== this.currentContainer ) {
			if ( !noPropagation ) {
				delayedTriggers.push( function( event ) {
					this._trigger( "remove", event, this._uiHash() );
				} );
				delayedTriggers.push( ( function( c ) {
					return function( event ) {
						c._trigger( "receive", event, this._uiHash( this ) );
					};
				} ).call( this, this.currentContainer ) );
				delayedTriggers.push( ( function( c ) {
					return function( event ) {
						c._trigger( "update", event, this._uiHash( this ) );
					};
				} ).call( this, this.currentContainer ) );
			}
		}

		//Post events to containers
		function delayEvent( type, instance, container ) {
			return function( event ) {
				container._trigger( type, event, instance._uiHash( instance ) );
			};
		}
		for ( i = this.containers.length - 1; i >= 0; i-- ) {
			if ( !noPropagation ) {
				delayedTriggers.push( delayEvent( "deactivate", this, this.containers[ i ] ) );
			}
			if ( this.containers[ i ].containerCache.over ) {
				delayedTriggers.push( delayEvent( "out", this, this.containers[ i ] ) );
				this.containers[ i ].containerCache.over = 0;
			}
		}

		//Do what was originally in plugins
		if ( this.storedCursor ) {
			this.document.find( "body" ).css( "cursor", this.storedCursor );
			this.storedStylesheet.remove();
		}
		if ( this._storedOpacity ) {
			this.helper.css( "opacity", this._storedOpacity );
		}
		if ( this._storedZIndex ) {
			this.helper.css( "zIndex", this._storedZIndex === "auto" ? "" : this._storedZIndex );
		}

		this.dragging = false;

		if ( !noPropagation ) {
			this._trigger( "beforeStop", event, this._uiHash() );
		}

		//$(this.placeholder[0]).remove(); would have been the jQuery way - unfortunately,
		// it unbinds ALL events from the original node!
		this.placeholder[ 0 ].parentNode.removeChild( this.placeholder[ 0 ] );

		if ( !this.cancelHelperRemoval ) {
			if ( this.helper[ 0 ] !== this.currentItem[ 0 ] ) {
				this.helper.remove();
			}
			this.helper = null;
		}

		if ( !noPropagation ) {
			for ( i = 0; i < delayedTriggers.length; i++ ) {

				// Trigger all delayed events
				delayedTriggers[ i ].call( this, event );
			}
			this._trigger( "stop", event, this._uiHash() );
		}

		this.fromOutside = false;
		return !this.cancelHelperRemoval;

	},

	_trigger: function() {
		if ( $.Widget.prototype._trigger.apply( this, arguments ) === false ) {
			this.cancel();
		}
	},

	_uiHash: function( _inst ) {
		var inst = _inst || this;
		return {
			helper: inst.helper,
			placeholder: inst.placeholder || $( [] ),
			position: inst.position,
			originalPosition: inst.originalPosition,
			offset: inst.positionAbs,
			item: inst.currentItem,
			sender: _inst ? _inst.element : null
		};
	}

} );

var Onboard = new function __Onboard() {
	
	this.saveAndContinue = function() {
		var app=Client.path.current;
		if (app=="onboard" || app=="onboard/company" || app=="onboard/"){
			this.saveCompany();
		}else if (app=="onboard/user"){
			AP.toURL("onboard/team");
		}else if (app=="onboard/team"){
			AP.redirect("onboard/final");
		}else{
			AP.toURL("home");
		}
	};
	
	
	this.skip = function() {
		
	};
	
	
	this.saveCompany=function(refresh) {
		save("#js-free-label", function(code){
			if (code.refresh){
				AP.redirect("onboard/company");
				return;
			}
			
			if (refresh){
				AP.refresh();
			}else{
				AP.toURL("onboard/user");	
			}
		});
	};

	
	function save(label, callback) {
		Form.submitFrom(label, function(code) {
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code);
		}, {})
	};
};



Onboard.member=new function __OnboardMember(){
	this.init=function(input){
		$(input).each(function(){
			$(this).enter(function(){
				var users=$(this).val();
				var role=$(this).data("role");
				if (!users || !users.length){
					return;
				}
				setRole(users, role);
			});
			
			$(this).closest(".qf").find(".add").click(function(){
				$(this).closest(".qf").find("input").triggerEnter();
			});
		});
    };

	this.filter = function() {
        $("#js-onboard-search input").on("input",function(){
            var q=$(this).val();
            if (!q){
                q="";
            }

            q=$.trim(q).toLowerCase();
            q=purify(q);

            $(".users .user").each(function(){
                if(!q) {
                    if ($(this).hasClass("search_hidden") && $(this).css('display', 'none')){
                        $(this).css('display', 'block');
                    }
                } else {
                    if (matched(this, q) && $(this).css('display') != 'none'){
                        $(this).removeClass("search_hidden");
                    } else 	{
                        $(this).addClass("search_hidden");
                        $(this).css('display', 'none');
                    }
                }
            });
        });
	}

	this.display=function(canvas){
		$("#js-people").html(AP.render(Client.people, function(e){
			return getPersonHTML(e);
		}));
		
		
		$("#onboard select.rs").each(function(){
			var username=$(this).data("username");
			$(this).val("member");
			
//			if (Role.manager(username)){
//				$(this).val("manager");
//			}else if (Role.manager(username)){
//				$(this).val("executive");
//			}else{
//				
//			}
		});
		
		$("#js-people select.rs").each(function(){
			var priv=parseInt($(this).data("priv"));
			if (priv==10){
				$(this).val("admin");
			}else if (priv==13){
				$(this).val("owner");
			}
			
			$(this).change(function(){
				var val=$(this).val();
				var username=$(this).data("username");
				
				AP.post(Base.domain("account")+'/ajax/api/network/role/set', {username: username, role: val}, function(code){
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					AP.alertSuccess("Updated successfully ...");
				});
				
			});
		});
		
	};
	
	
	
	this.create=function(role){
		if (!role){
			role="";
		}
		
		var form=Form.create('create-account-fx',{action: Base.domain("account")+'/ajax/api/company/account/create'})
		.row(
			Form.label({label: "Há» vĂ  tĂªn *",sublabel: "Há» vĂ  tĂªn"}),
			Form.input({name: 'name', "placeholder":"Há» vĂ  tĂªn"})
		)
		.row(
			Form.label({label: "Username *",sublabel: "<span class='red'>Username cá»§a tĂ i khoáº£n lĂ  duy nháº¥t vĂ  sáº½ khĂ´ng thá»ƒ thay Ä‘á»•i sau khi Ä‘Æ°á»£c táº¡o - vui lĂ²ng lá»±a chá»n username phĂ¹ há»£p.</span>"}),
			Form.input({name: 'username', "placeholder":"Chá»‰ gá»“m cĂ¡c kĂ½ tá»± thĂ´ng thÆ°á»ng, khĂ´ng cĂ³ dáº¥u hoáº·c tiáº¿ng viá»‡t"})
		)
		.row(
			Form.label({label: "Email tĂ i khoáº£n *",sublabel: "Má»™t máº­t kháº©u táº¡m thá»i sáº½ Ä‘Æ°á»£c gá»­i Ä‘áº¿n email nĂ y."}),
			Form.input({name: 'email', "placeholder":"Email tĂ i khoáº£n"})
		)
		.row(
			Form.label({label: "Chá»©c danh",sublabel: "Chá»©c danh, chá»©c vá»¥ hoáº·c vá»‹ trĂ­ trong cĂ´ng ty"}),
			Form.input({name: 'title', "placeholder":"Chá»©c danh"})
		)
		.row(
			Form.label({label: "PhĂ¢n quyá»n sá»­ dá»¥ng", sublabel: "PhĂ¢n quyá»n sá»­ dá»¥ng"}),
			Form.input({name: 'priv', "type":"select", options: privOptions()}).value(role)
		)
		.hiddens(
			{
				token:Client.system.token,
				app: Client.base.app
			}
		)
		.buttons([
		     {label: "Táº¡o tĂ i khoáº£n má»›i", action: function(){
		    	 Form.submit("#create-account-fx", function(code){
		    		 if (!code.good()){
		    			 return AP.alertError(code.message);
		    		 }
		    	
		    		 
		    		 Form.hide("create-account-fx");
		    		 AP.alertSuccess("TĂ i khoáº£n Ä‘Ă£ Ä‘Æ°á»£c táº¡o thĂ nh cĂ´ng.", function(){
		    			 AP.refresh();
		    		 });
		    		 //setRole(code.user.username, role, function(e){
		    		 //	 AP.refresh();
	    			 // });
		    	 });
		     }, style: 'ok -success -rounded -bold'},
		     {label: "Cancel", action: function(){
		    	 Form.hide("create-account-fx");
		     }, style:'cancel -passive-2 -rounded'}
		]).settings();
	
		Form.pop({id: 'create-team-fx-dx', width: 600, label: 'Táº¡o tĂ i khoáº£n má»›i'}).setForm(form).show();
	};
	
	
	
	function getPersonHTML(p){
		return "<div class='user' data-keywords='"+p.username+" "+p.name+"'>" +
				"<div class='avatar avatar-40'><div class='image'><img src='"+AP.xthumb(p.gavatar)+"'/></div></div>" +
				"<div class='main'>" +
				"	<div class='name url' data-username='"+p.username+"'>"+p.name+"</div>" +
				"	<div class='info'>"+p.title+"&nbsp;</div>" +
				"</div>" +
				"<div class='role'>"+getRole(p)+"</div>" +
			"</div>";
	};
	
	
	function getRole(p){
		return "<select class='rs' name='' data-username='"+p.username+"' data-priv='"+p.role+"'>" +
				"<option value='member'>ThĂ nh viĂªn thĂ´ng thÆ°á»ng</option>" +
				"<option value='admin'>Quáº£n trá»‹ há»‡ thá»‘ng</option>" +
				"<option value='owner'>Quáº£n trá»‹ há»‡ thá»‘ng cáº¥p cao</option>" +
			"</select>";
	};
	
	
	function privOptions(){
		return [{label: "ThĂ nh viĂªn thĂ´ng thÆ°á»ng", "value":""}, {label: "Quáº£n trá»‹ há»‡ thá»‘ng", "value":"admin"}, {label: "Quáº£n trá»‹ há»‡ thá»‘ng cáº¥p cao", "value":"owner"}];
	};
	
	
	function setRole(users, role, callback){
		if (!role || !role.length){
			return;
		}
		
		UI.ajaxShow();
		AP.post("api/onboard/member/assign", {"role": role, "users": users}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			if (callback){
				callback();
			}else{
				UI.flash("Update successfully ...");
				AP.refresh();	
			}
		});
	};

    function matched(elem, q){
        var keyword = String($(elem).data("keywords"));
        var word=keyword.toLowerCase();
        var parts=q.split(" ");
        for (var i=0; i<parts.length; i++){
            if ($.trim(parts[i])){
                if (word.indexOf(parts[i])==-1){
                    return false;
                }
            }
        }
        return true;
    };
};

var Message=new function __Message(){
	this.__mode="native";
	this.httpbase=(parseInt(Client.https)?"https":"http");
	this.api=(Client.base && (Client.base.app=="message" || Client.base.app=="msg"))?"":(this.httpbase+"://" + CONFIG.api + "."+Client.domain+"/ajax/");
	
	this.mode=function(){
		if (arguments.length==0){
			return this.__mode;
		}
		
		return (this.mode==arguments[0]);
	};
	
	
	/**
	 * @desc Add a new message
	 */
	this.addMessage=function(message, channel){
		this.html.addMessage(message, channel);
	};
	
	
	/**
	 * @desc Create an event listener
	 */
	this.on=function(event, fx, $this){
		this.event.bind(event, fx, $this);
		return this;
	};
	
	
	/**
	 * @desc Trigger an event 
	 */
	this.trigger=function(event, data){
		this.event.trigger(event, data);
		return this;
	};
	
	
	/**
	 * @desc Alias of trigger
	 */
	this.fire=function(event, data){
		this.event.trigger(event, data);
		return this;
	};
	
	
	/**
	 * @desc Forward a file to another channel
	 */
	this.forwardFile=function(ref){
		var $box=$(ref).closest(".message").find(".attachments .att").first();
		var file={id: $box.data("file_id"), name: $box.data("file_name")};
		forwardNow(file);
	};
	
	
	this.forwardFileOnSidebar=function(ref){
		var $box=$(ref).closest(".file");
		var file={id: $box.data("file_id"), name: $box.data("file_name")};
		forwardNow(file);
	};

	/**
	 * @desc Forward multiple files to another channel
	 */
	this.forwardMultipleFiles = function(ref) {
		var msg_id = $(ref).closest(".message").data("msgid");
		if (!Channel.manager.channels || !Channel.manager.channels.length) {
			return;
		}
		
		UI.picker(Channel.manager.channels, function(c) {
			UI.ajaxShow();
			AP.post(Base.domain("message") + "/ajax/api/message/file/forward.files", {msg_id: msg_id, channel_id: c.id}, function(code) {
				UI.ajaxHide();
				
				if (!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Forward successfully ...");
			});
		}, {
			title:"Select one channel to send the files"
		});
	};

	/**
	 * @desc Forward text message to another channel
	 */
	this.forwardText = function(ref) {
		var msg_id = $(ref).closest(".message").data("msgid");
		if (!Channel.manager.channels || !Channel.manager.channels.length) {
			return;
		}
		
		UI.picker(Channel.manager.channels, function(c) {
			UI.ajaxShow();
			AP.post(Base.domain("message") + "/ajax/api/message/message/forward.textmsg", {msg_id: msg_id, channel_id: c.id}, function(code) {
				UI.ajaxHide();
				
				if (!code.good()) {
					return AP.alertError(code.message);
				}
				
				UI.flash("Forward successfully ...");
			});
		}, {
			title:"Select one channel to send the files"
		});
	};
	
	
	function forwardNow(file){
		if (!file || !file.id){
			return;
		}
		
		if (!Channel.manager.channels || !Channel.manager.channels.length){
			return;
		}
		
		UI.picker(Channel.manager.channels, function(c){
			UI.ajaxShow();
			AP.post(Base.domain("message")+"/ajax/api/message/file/forward", {id: file.id, channel_id: c.id, name:file.name}, function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				UI.flash("Forward successfully ...");
			});
		}, {
			title:"Select one channel to send the file"
		});
	};
	
};


function managed(channel){
	if (!channel){
		channel = Channel.channel;
	}
	
	if (!channel){
		return false;
	}
	
	return Channel.managedBy(channel, Client.viewer);
};



Render.on("msg-body", function(){
	if (this.message.subtype == 'formatted'){
		return "<div class='body'> " +Render.render('text_cts', {height: "200" }, '' +Render.render('text_editor', {}, ""+(this.message.content)+"")+ '')+ "</div>";
	}
	
	if (this.message.subtype == 'base-task'){
		return "  " +Render.render('att_task', {encoded_task:this.message.content}, '')+ '';
	}
	
	if (this.message.subtype == 'base-request'){
		return "  " +Render.render('att_request', {encoded_request:this.message.content}, '')+ '';
	}
	
	if (this.message.subtype == 'code'){
		return "<div class='body'> " +Render.render('text_cts', {height: "500" }, '' +Render.render('text_markdown', {fallback: "base-message://messages/"+(this.message.channel_id)+"?show=message&id="+(this.message.id)+"" , content:Base64.safeDecode(this.message.content)}, '')+ '')+ "</div>";
	}
	
	return "<div class='body'>"+(Message.html.getTextContent(this.message))+"</div>";	
});



Render.on("msg-in-reply", function(){
	if (!this.message.reply_to || !this.message.reply_to.id){
		return '';
	}
	
	var reply_to = this.message.reply_to;
	
	if (this.block){
		return "<div class='reply-block'><span class='reply_area url' data-url=':message/"+(reply_to.id)+"/show'> <span class='-ap icon-reply'></span> replied <em>"+(reply_to.name)+"</em>: "+(reply_to.content)+" </span> </div>";
	}
	
	return "<span class='reply_area url' data-url=':message/"+(reply_to.id)+"/show'> &nbsp; <span class='-ap icon-reply'></span> replied <em>"+(reply_to.name)+"</em>: "+(reply_to.content)+" </span>";
})



Message.socket = new function __MessageSocket(){
	this.send=function(event, data, callback){
		Live.emit(event, data);
		if (callback){
			this.on(event, callback)
		}
	};
	
	
	this.emit=function(event, data, callback){
		this.send(event, data, callback);
	};
	
	
	this.emitMe=function(event, data){
		data.event=event;
		Live.emit("justme", data);
	};
	
	
	this.localEmit=function(event, data, callback){
		this.emit("local.emit."+event, data, callback);
	};
	
	
	this.on=function(event, callback){
		Live.me.on(event, callback); 
	};
};


Message.event=new function __MsgEvent(){
	this.events={};
	this.__fired={};
	
	this.clear=function(){
		this.events={};
		this.__fired={};
	};
	
	this.removeListener=function(ev){
		if (this.events[ev] && this.events[ev].length){
			this.events[ev]=[];
			delete this.events[ev];
		}
	};
	
	this.off= this.removeListener;
	
	this.trigger=function(ev, data){
		$.log("Event "+ev+" fired at "+AP.time.time("%H:%i:%s"));
		
		if (this.events[ev] && this.events[ev].length){
			for (var i=0; i<this.events[ev].length; i++){
				var fn=this.events[ev][i];
				if (!fn){
					break;
				}
				
				if (fn._caller){
					fn.apply(fn._caller, data);
				}else{
					if (AP.data.isArray(data)){
						fn.apply(undefined, data);
					}else{
						fn(data);	
					}
					
				}
			}
		}
		
		this.__fired[ev]=1;
		return this;
	};
	
	
	this.release=function(ev){
		if (this.events[ev] && this.events[ev].length){
			while (true){
				var fn=this.events[ev].shift();
				if (!fn){
					break;
				}
				
				if (fn._caller){
					fn.apply(fn._caller);
				}else{
					fn();
				}
			}
		}
		
		this.__fired[ev]=1;
		return this;
	};
	
	
	this.bind=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev].push(fx);
		
		return this;
	};
	
	
	this.bindAll=function(ev, fx, _caller){
		if (!this.events[ev]){
			this.events[ev]=[];
		}
		
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev]=[fx]; // Replace
		
		return this;
	};
	
	
	this.fired=function(ev){
		if (this.__fired[ev]){
			return true;
		}
		return false;
	};
};










Message.eventOnce=new function __MsgEvent(){
	this.events={};
	
	this.clear=function(){
		this.events={};
	};
	
	this.removeListener=function(ev){
		if (this.events[ev]){
			this.events[ev]=null;
			delete this.events[ev];
		}
	};
	
	this.trigger=function(ev, data){
		if (this.events[ev]){
			var fn=this.events[ev];
			if (!fn){
				return;
			}
			
			if (fn._caller){
				fn.apply(fn._caller, data);
			}else{
				if (AP.data.isArray(data)){
					fn.apply(undefined, data);
				}else{
					fn(data);	
				}
				
			}
			
			delete this.events[ev];
		}
		
		return this;
	};
	
	
	
	this.bind=function(ev, fx, _caller){
		if (_caller){
			fx._caller=_caller;
		}
		
		this.events[ev]=fx;
		
		return this;
	};
	
	
};


Message.bindEvents=function(){
	Message.socket.on("message.updated", function(msgdata){
		if (Client.nobox && parseInt(Client.nobox)){
			return;
		}
		
		var channel=msgdata.channel;
		var message=msgdata.message;
		var notis=msgdata.notis;
		var actives=msgdata.actives;
		var seens=msgdata.seens;
		
		// FORCE UPDATE
		if (message.__action && message.__action=="update"){
			if (message.__action_notis){
				Message.notify.reaction(message, channel, message.__action_notis);
			}
			
			return Message.html.onUpdate(message, channel);
		}
		
		if (message.__action && message.__action=="remove"){
			return Message.html.onRemove(message, channel);
		}
	});
	
	
	Message.socket.on("message.received", function(msgdata){
		if (Client.nobox && parseInt(Client.nobox)){
			return;
		}
		
		var channel=msgdata.channel;
		var message=msgdata.message;
		var notis=msgdata.notis;
		var actives=msgdata.actives;
		var seens=msgdata.seens;
		
		if (message && message.intent && message.intent=="call" && parseInt(message.user.id)!=parseInt(Client.viewer.id)){
			Message.notify.ringing(message);
		}
		
		if (message.__action && message.__action=="update"){
			return Message.html.onUpdate(message, channel);
		}
		
		if (message.__action && message.__action=="remove"){
			return Message.html.onRemove(message, channel);
		}
		
		if (Message.checkpoint.received(message)){
			Base.console("WOW -- RECEIVED MESSAGE & INGORED @L15 --"+message.id);
			return;
		}
		
		
		if (message.content=="buzz!"){
			DN.bip(6, message.id);
		}
		
		if (msgdata.notis_opt && msgdata.notis_opt=='on'){
			if (Client.busy && parseInt(Client.busy)){
				
			}else{
				Message.notify.now(message, channel, notis);	
			}		
		}
		
		if (!Channel.isDisplayed(channel.id)){
			if (Client.busy && parseInt(Client.busy)){
				Message.canvas.onMessage(message, channel);
				return;
			}	
			
			if (msgdata.notis_opt=="off"){
				Message.canvas.onMessage(message, channel);
				return; // SILENT
			}
			Channel.open(channel.id, {intent: "message", "just_open": 1}, function(){
				Message.html.forceScrollBottom(channel.id);
				setTimeout(function(){
					Message.html.forceScrollBottom(channel.id);
				},1000);
				
				setTimeout(function(){
					Message.html.forceScrollBottom(channel.id);
				},3000);
			});
		}else{
			Message.html.addMessage(message, channel);
		}
		
		
		// Message.panel.onMessage(message, channel);
		// Message.panel.onMessageReceive(message, channel);
		// Channel.fixUnread(channel);
		// Base.title.update();
		
		Message.canvas.onMessage(message, channel);
		
		seens=AP.array.filter(seens, function(e){
			return AP.array.contain(channel.followers, e, function(f, e){
				return parseInt(f)==parseInt(e);
			});
		});
		
		Message.seen.render(channel.id, seens, actives);
	});
	
	
	Message.socket.on("message.deleted", function(msgdata){
	});
	
	
	Message.socket.on("typings", function(data){
		Message.form.updateTypings(data.channel_id, data.users);
	});
	
	
	
	Message.socket.on("call.closed", function(data){
		DN.bipInf("ringing", false);
		AP.dialog("#alert").hide();
	});
	
	Message.socket.on("call.close", function(data){
		DN.bipInf("ringing", false);
		AP.dialog("#alert").hide();
	});
	
	
	Message.socket.on("channel.me.close", function(data){
		if ($("#channel-"+data.id).length){
			Message.render.destroy("#channel-"+data.id+" .js-channel-close");
		}
	});
};



AP.rewrite('r/file/([a-zA-Z0-9]+)/([a-zA-Z0-9]+)', 'messages/file?c=$1&file=$2', function(qs){
	Channel.open(qs.c, function(){
		BaseFile.open(qs.file);
	});
});


Message.notify= new function __MessageParser(){
	this.badge=function(){
		var total=Channel.countUniqueUnreads();
		
		if (total>0){
			if ($("#base-message-badge").length){
				$("#base-message-badge").html(total).show();
			}
		}else{
			if ($("#base-message-badge").length){
				$("#base-message-badge").html("").hide();
			}
		}
	};
	
	this.ringing=function(message){
		if (notified(message.id)){
			return;
		}
		
		logNotified(message.id);
		
		if (Client.busy && parseInt(Client.busy)){
			return;
		}	
		
		DN.bipInf("ringing", true);
		AP.alert(message.plaintext, [
			{label: "Cancel",  action: function(){
				Message.socket.emitMe("call.close", {id: 0});
			
				DN.bipInf("ringing", false);
				AP.dialog("#alert").hide();
		}, style: "er confirm-button"},
		{label: "Join call",  action: function(){
			Message.socket.emitMe("call.close", {id: 0});
			DN.bipInf("ringing", false);
			AP.dialog("#alert").hide();
			AP.toURL(message.intentdata.call);
		  }, style: "ss confirm-button"}
		],"<div class='ring-animation'><div class='-ap icon-phone-handset'></div></div>",{
			closable: false
		});
	};
	
	
	this.now=function(message, channel, notis){
		if (this.ignored(channel)){
			return;
		}
		
		if (Channel.isActive(channel.id) || Base.systemActive()){
			notis.__is_base_message=1;
			notify(message, channel, notis);
		}else{
			setTimeout(function(){
				notify(message, channel, notis);
			},300);
		}
	};
	
	
	
	this.ignored=function(channel){
		return false;
	};
	
	
	this.reaction=function(message, channel, reaction){
		if (parseInt(message.user.id)!=parseInt(Client.viewer.id) || reaction.username==Client.viewer.username){
			return;
		}
		
		if (notified(message.id+"-"+reaction.reaction)){
			return;
		}
		
		var u=People.get(reaction.username);
		var notis={};
		
		notis.body=u.name+" reacted :"+reaction.reaction+": on your message";
		notis.icon=AP.thumb(u.gavatar);
		notis.title="[Base Message] "+Channel.engine.getDisplayName(channel);
		notis.url="base-message://messages/"+message.channel_id+"?show=message&id="+message.id;
		
		DN.show(notis);
		DN.bip(3, message.id);
		logNotified(message.id);
	};
	
	
	
	function notify(message, channel, notis){
		if (notified(message.id)){
			Base.console("NEW MESSAGE NOTIFY SKIP --- "+message.id);
			return;
		}
		
		// Desktop notification or not?
		if (parseInt(channel.inspect.notis)){
			notis.body=notis.content;
			notis.icon=notis.image;
			if (!notis.url){
				notis.url=notis.link;
			}
			
			Base.console("NEW MESSAGE NOTIFY",notis);
			notis.title="[Base Message] "+Channel.engine.getDisplayName(channel);
			
			DN.show(notis);
			DN.bip(3, message.id);
			logNotified(message.id);
		}else{
			$$(function(){
				$.log("Ignore notification on direct message ...");
			});
		}
	};
	
	

	function notified(msgid){
		var lm=Clog.getCookie("__lm");
		if (!lm){
			lm=[];
		}else{
			lm=lm.split(" ");
		}
		
		if (AP.array.find(lm, msgid)){
			return true;
		}
		
		return false;
	};
	
	
	function logNotified(msgid){
		msgid=""+msgid+"";
		
		var lm=Clog.getCookie("__lm");
		if (!lm){
			lm=[];
		}else{
			lm=lm.split(" ");
		}
		
		lm.push(msgid);
		lm=AP.array.unique(lm, function(e1, e2){
			return e1==e2;
		});
		
		if (lm.length>=11){
			lm=lm.slice(lm.length-10);
		}
		
		Clog.setCookie("__lm", lm.join(" "));
	};
};


Message.checkpoint=new function __MessageCheckpoint(){
	this._received={};
	this._received_ids=[];
	this._received_len=90;
	this._received_max=100;
	
	
	/**
	 * @desc Fix multiple received. Allow once received only
	 * @use if (Message.received(msg)){}
	 */
	this.received=function(msg){
		if (this._received["msg@"+msg.id]){
			return true;
		}
		this._received["msg@"+msg.id]=1;
		this._received_ids.push(msg.id);
		
		if (this._received_ids.length>=this._received_max){
			var temp={};
			for (var i=this._received_ids.length-this._received_len; i<this._received_ids.length; i++){
				temp["msg@"+this._received_ids[i]]=this._received["msg@"+this._received_ids[i]];
			}
			
			this._received=temp;
			this._received_ids=this._received_ids.slice(this._received_ids.length-this._received_len);
		}
		
		return false;
	};
	
	
};


Message.sender=new function __MessageSender(){
	/**
	 * @desc Send a text message
	 */
	this.text=function(text, channel){
		Channel.setActive(channel.id);
		
		var state=AP.uuid();
		var data={
			state: state,
			content: text,
			channel_id: channel.id,
		};
		
		var pending_msg={
			state: state,
			content: text,
			channel_id: channel.id,
			id: state,
			since: AP.time.now(),
			user: Client.viewer,
			metatype: "message",
			type: "text",
			attachments: []
		};
		
		Message.form.onSending(pending_msg, channel);
		
		AP.post(Message.api+"api/message/message/save", data, function(code){
			if (!code.good()){
				Message.trigger("message.rejected", [data, data.state]);
				return AP.alertError(code.message);
			}
			
			Message.form.onSent(code.message, data.state);
		});
	};
	
	
	this.buzz=function(channel){
		this.text("buzz!", channel);
	};
	
	
	this.drive=function(channel){
		Base.drive.pick({
			multi: 1, 
			ext: 1,
			callback: function(files){
				if (!channel){
					return;
				}
				
				if (!files.length){
					return;
				}
				
				var state=AP.uuid();
				var data={
					state: state,
					content: "shared files",
					channel_id: channel.id,
					type: 'drivefile',
				};
				

				var bfs=fix_post_array(files, "bf");
				for (var key in bfs){
					data[key]=bfs[key];
				}
				
				var pending_msg={
					state: state,
					content: "shared files",
					channel_id: channel.id,
					id: state,
					since: AP.time.now(),
					user: Client.viewer,
					metatype: "message",
					type: "drivefile",
					attachments: files
				};
				
				Message.form.onSending(pending_msg, channel);
				
				AP.post(Message.api+"api/message/file/drive.upload", data, function(code){
					if (!code.good()){
						Message.trigger("message.rejected", [data, data.state]);
						return AP.alertError(code.message);
					}
					
					Message.form.onSent(code.message, data.state);
				});
			}
		});
	};
	
	
	this.sticker=function(channel, sticker_key, sticker_src){
		if (!channel){
			return;
		}
		
		var state=AP.uuid();
		var data={
			state: state,
			content: sticker_key,
			channel_id: channel.id,
			type: 'sticker',
		};
		
		
		var pending_msg={
			state: state,
			content: sticker_key,
			channel_id: channel.id,
			id: state,
			since: AP.time.now(),
			user: Client.viewer,
			metatype: "message",
			type: "sticker",
			sticker_src: sticker_key,
			attachments: []
		};
		
		Message.form.onSending(pending_msg, channel);
		
		AP.post(Message.api+"api/message/message/save", data, function(code){
			if (!code.good()){
				Message.trigger("message.rejected", [data, data.state]);
				return AP.alertError(code.message);
			}
			
			Message.form.onSent(code.message, data.state);
		});
	};
	
	
	this.event=function(event, data){
		return this.socket.send(event, data);
	};
	
	
	
	this.feedback = function(channel) {
		var hiddens = {id: channel.id};
		
		var form = Form.create('feedback-fx', {'action': Message.api + "api/message/channel/feedback"})
			.row(
				Form.noLabel(),
				Form.input({name: 'feedback', "type": "textarea", "placeholder": "The content of your feedback"}).css({height: 120})
			)
			.hiddens(hiddens)	
			.buttons([
				{label: "Submit", action: function() {
					Form.submit("feedback-fx", function(code) {
					if (!code.good()) {
						return AP.alertError(code.message);
					}
					
					Form.hide("feedback-fx");
					// UI.flash("Form submitted");
					return AP.alertSuccess(code.message);
					});
				}, style: 'ok -success -rounded bold'},
				{label: "Cancel", action: function() {
					Form.hide("feedback-fx");
				}, style: 'cancel passive-3 rounded'}
			]).settings({block: true});
		
		Form.pop({id:'feedback-fx-dx', width: 600, label: icon("entypo ticon-docs") + 'Send a feedback/report'}).setForm(form).show().focus('feedback');
	};
	
	
	this.topic = function(){
		return 0;
	};
	
	
	function fix_post_array(files, name){
		var data={};
		for (var i=0; i<files.length; i++){
			for (var key in files[i]){
				data[name+""+i+"_"+key]=files[i][key];
			}
		}
		
		$.log(data);
		return data;
	};
	

};


Message.seen=new function __MsgSeen(){
	this.init=function(){
		Message.socket.on("channel.user.active", function(data){
			var channel_id=parseInt(data.channel_id);
			var user_id=parseInt(data.user_id);
			
			var $box=$("#channel-"+channel_id+" .channel-seens");
			if (!$box.length){
				return;
			}
			
			var seens=$box.data("seens");
			if (!seens){
				seens=[];
			}
			
			insertSeens($box, seens, user_id);
		});
		
		Message.socket.on("channel.seens", function(data){
			Message.seen.render(data.channel_id, data.seens);
		});
	};
	
	
	this.get=function(channel, callback){
		Message.socket.emit("channel.seens", {channel_id: channel.id, channel_token: channel.token});
	};
	
	
	this.render=function(channel_id, seens, actives){
		var $box=$("#channel-"+channel_id+" .channel-seens");
		if (!$box.length){
			return;
		}
		
		$box.data("seens", seens);
		display($box);
	};
	
	
	function display($box){
		var seens=$box.data("seens");
		if (!seens){
			return;
		}
		
		var html=AP.render(seens, function(e, index){			
			var u=People.get(e);
			if (!u.uid || !parseInt(u.uid)){
				return "";
			}
			
			return "<div class='avatar' title='Seen by "+(u.name)+" (@"+(u.username)+")'><img src='"+(AP.xthumb(u.gavatar))+"'></div>";
		});
		
		$box.html("<div class='avatars'>"+html+"</div>");
	};
	
	
	function insertSeens($box, seens, user_id){
		seens.push(parseInt(user_id));
		seens=AP.array.unique(seens);
		$box.data("seens", seens);
		display($box);
	};
};


Message.extra = new function __MessageFormExtra(){
	
	/**
	 * @desc Write a new formatted msg
	 */
	this.formatted = function(channel){
		var rows = [
			{label: "Your message", placeholder: "Your message", name: "content", type:"textarea", role: "editor", focus: 1}
		];
		
		Form.v2({
			title: "Send a formatted message",
			action: Message.api+"api/message/message/v2",
			data: {channel_id: channel.id, subtype: "formatted", topic_id: Message.sender.topic()},
			rows: rows,
			width: 600,
			buttons: Form.button(":submit", function(){
			}).button(":cancel")
		});
	};
	
	
	/**
	 * @desc Upload a video
	 */
	this.video = function(channel){
		var rows = [
			{label: "Upload video", placeholder: "Pick your video", name: "content", type:"input-video", focus: 1}
		];
		
		Form.v2({
			title: "Upload a video",
			action: Message.api+"api/message/message/v2",
			data: {channel_id: channel.id, subtype: "video", topic_id: Message.sender.topic()},
			rows: rows,
			width: 600,
			buttons: Form.button(":submit", function(){
			}).button(":cancel")
		});
	};
	
	
	/**
	 * @desc Write a code message
	 */
	this.code = function(channel){
		var rows = [
			{label: "Your markdown", placeholder: "Your markdown", name: "content", type:"textarea", role: "markdown"}
		];
		
		Form.v2({
			title: "Create a code snippet",
			action: Message.api+"api/message/message/v2",
			data: {channel_id: channel.id, subtype: "code", topic_id: Message.sender.topic()},
			rows: rows,
			width: 600,
			buttons: Form.button(":submit", function(){
			}).button(":cancel")
		});
	};
	
	
	/**
	 * @desc Pickup and share a location
	 */
	this.location = function(channel){
		var rows = [
			{label: "Shared location", placeholder: "Location picker", name: "loc", type: "input-location"},
			{label: "Your message", placeholder: "Your message", name: "content", type:"textarea", focus: 1},
		];
		
		Form.v2({
			title: "Share a location",
			action: Message.api+"api/message/message/v2",
			data: {channel_id: channel.id, subtype: "location", topic_id: Message.sender.topic()},
			rows: rows,
			width: 600,
			buttons: Form.button(":submit", function(){
			}).button(":cancel")
		});
		
	};
	
	
	this.poll = function(channel){
		return Channel.poll.form.create(channel);
	};
	
	
	/**
	 * @desc Send custom base object
	 */
	this.sendObj = function(obj, type){
		var data = {
			channel_id: Channel.channel.id,
			topic_id: Channel.sender.topic(),
			subtype: type,
			content: Base64.encodeURI(JSON.stringify(obj))
		};
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/message/v2", data, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			UI.flash("Created successfully");
		});
	};
	
};



Message.call=new function __ChannelCall(){
	this.click=function(channel){
		window.open(Base.domain("message")+"/videocall/"+channel.id,"","width=800,height=600");
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/call/start",{id: channel.id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
		});
	};
	
	this.display=function(call_id){
		Message.socket.emitMe("call.close", {id: call_id});
	};
	
	
	this.show=function(call){
		Message.callrender.reset();
		Message.callrender.join(call, function(){
			Message.callrender.prepare();
		});
	};
	
	
	
	this.getCallInfo=function(call_id, callback){
		AP.post(Message.api+"api/message/call/info",{id: call_id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.call);
		});
	};
};






Message.callrender = new function __MessageCallRender(){
	this.loaded=false;
	this.room=null;
	this.previewMedia=null;
	
	
	this.reset=function(call){
		if (!$("#call-canvas").length){
			$("<div id='call-canvas'></div>").appendTo("#document");
		}
		
		$("#call-canvas").empty().show().html("<div class='canvas loading'><div class='in'>" +
			"<div class='loading'><span class='ficon-spin ficon-spinner'></span> &nbsp; Waiting for participants ...</div>" +
			"<div class='video-area' id='remote-media'></div>" +
			"<div class='preview' id='my-media'></div>" +
		"</div></div>" +
		"<div class='buttons'>" +
		"	<div class='bt button-audio' onclick='Message.callrender.stopAudio();'><div class='signal'></div><span class='-ap icon-mic3'></span></div>" +
		"	<div class='bt -er' onclick='Message.callrender.disconnect();'><div class='signal'></div><span class='-ap icon-phone-hang-up'></span></div>" +
		"	<div class='bt button-video' onclick='Message.callrender.stopVideo();'><div class='signal'></div><span class='-ap icon-videocam'></span></div>" +
		"</div>").show();
	};
	
	
	this.join=function(call, callback){
		getToken(call, function(data){
			var videoClient = new Twilio.Video.Client(data.token);
			videoClient.connect({to: call.room}).then(function(room) {
				Message.callrender.room=room;
				
				// Draw local video, if not already previewing
				if (!Message.callrender.previewMedia) {
					room.localParticipant.media.attach('#my-media');
				}
				  
				room.participants.forEach(function (participant) {
					$.log("Already in Room: '" + participant.identity + "'");
					participant.media.attach('#remote-media');
					$("#call-canvas .canvas").removeClass("loading");
				});

				// When a participant joins, draw their video on screen
				room.on('participantConnected', function (participant) {
					$.log("Joining: '" + participant.identity + "'");
					participant.media.attach('#remote-media');
					$("#call-canvas .canvas").removeClass("loading");
				});

				// When a participant disconnects, note in log
				room.on('participantDisconnected', function (participant) {
					$.log("Participant '" + participant.identity + "' left the room");
					participant.media.detach();
				});
				
				room.on('disconnected', function () {
					room.localParticipant.media.detach();
					room.participants.forEach(function (participant) {
						participant.media.detach();
					});
					Message.callrender.room=null;
					$("#call-canvas").empty().hide();
				  });

				
				
				callback();
			}, function (error) {
				$.log('Could not connect to Twilio: ' + error.message);
				AP.alertError("Could now start the call. Make sure that the camera and speaker are ON.", function(){
					Message.callrender.disconnect();
				})
			});
		});
	};
	
	
	this.prepare=function(){
		return;
		
		if (!this.previewMedia) {
			this.previewMedia = new Twilio.Video.LocalMedia();
			Twilio.Video.getUserMedia().then(
				function (mediaStream) {
					Message.callrender.previewMedia.addStream(mediaStream);
					Message.callrender.previewMedia.attach('#my-media');
				},
				function (error) {
					console.error('Unable to access local media', error);
					log('Unable to access Camera and Microphone');
				}
			);
		};
	};
	
	
	this.disconnect=function(){
		if (this.room){
			this.room.disconnect();
		}
		
		$("#call-canvas").fadeOut(300, function(){
			$(this).remove();
		});
	};
	
	
	this.stopVideo=function(){
		if (!this.room){
			return;
		}
		
		$("#call-canvas .buttons .button-video").toggleClass("disabled");
		
		var localMedia=this.room.localParticipant.media;
		localMedia.videoTracks.forEach(function (track) {
			if (track.isEnabled) {
				track.disable();
			} else {
				track.enable();
			}
		});
	};
	
	this.stopAudio=function(){
		if (!this.room){
			return;
		}
		
		$("#call-canvas .buttons .button-audio").toggleClass("disabled");
		
		var localMedia=this.room.localParticipant.media;
		localMedia.audioTracks.forEach(function (track) {
			if (track.isEnabled) {
				track.disable();
			} else {
				track.enable();
			}
		});
	};
	
	function getToken(call, callback){
		initJS(function(){
			UI.ajaxShow();
			AP.post(Message.api+"api/message/call/token", {id: call.id},function(code){
				UI.ajaxHide();
				
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				callback(code.token);
			});
		});
	};
	
	
	function initJS(callback){
		if (Message.callrender.loaded){
			callback();
			return;
		}
		
		$.apScript("https://media.twiliocdn.com/sdk/js/video/releases/1.0.0-beta2/twilio-video.js", function(){
			Message.callrender.loaded=true;
			callback();
		}, "twilio-lib");
	};
};



Message.html=new function __MessageHTML(){
	this.onUpdate=function(message, channel){
		
		var is_linked = $("#msg-"+message.id).hasClass("-linked");
		var is_leading = $("#msg-"+message.id).hasClass("-leading");
		var is_first = $("#msg-"+message.id).hasClass("-first");
		
		$("#msg-"+message.id).replaceWith(getMessageHTML(message, channel));
		if (is_linked){
			$("#msg-"+message.id).addClass("-linked");
		}
		
		if (is_leading){
			$("#msg-"+message.id).addClass("-leading");
		}
		
		if (is_first){
			$("#msg-"+message.id).addClass("-first");
		}
		
		if ($("#msg-"+message.id).hasClass("-linked")){
			var r=$("#msg-"+message.id+" .msg-reactions").width()+10;
			
			$("#msg-"+message.id+" .linked-time").css({right: 15+r});
		}
	};
	
	
	this.onRemove=function(message, channel){
		$("#msg-"+message.id+" .body").html("<span class='msg-body'>"+message.content+"</span>");
		$("#msg-"+message.id+" .attachments").remove();
	};
	
	
	
	this.addMessage=function(message, channel){
		addDaySeparation(message, channel);
		removePending(message, channel);
		
		var html=getMessageHTML(message, channel);
		var last=getLastMessage(channel);
		append(html, channel);
		
		if (linkable(message, last)){
			$("#msg-"+message.id).addClass("-linked");
			if (!last.elem.hasClass("-linked")){
				last.elem.addClass("-first");
			}
		}else{
			$("#msg-"+message.id).addClass("-leading");
		}
		
		$("#msg-"+message.id).addClass("__p");
		
		this.scrollDown(message.id, channel, 0);

	};
	
	
	/**
	 * @desc Prepend message
	 */
	this.prependMessage=function(message, channel){
		prependDaySeparation(message, channel);
		var html=getMessageHTML(message, channel);
		prepend(html, channel);
	};
	
	
	this.updateMessage=function(message, channel, state){
		var html=getMessageHTML(message, channel);
	};
	
	
	this.getHTML=function(message, channel, ns){
		return getMessageHTML(message, channel, ns);
	};
	
	
	/**
	 * @desc Linking a group of messages
	 */
	this.linkGroup=function(channel){
		var $box=$("#channel-"+channel.id+" .channel-messages");
		$box.children().each(function(){
			var $this=$(this);
			if ($this.hasClass("__p") || $this.hasClass("ds")){
				return;
			}
			
			$this.addClass("__p");
			
			var $prev=$this.prev();
			
			var _linkable=false;
			if ($prev && $prev.length && $prev.hasClass("message")){
				if ($prev.data("user")==$this.data("user") && AP.time.sameDay($prev.data("ts"), $this.data("ts"))){
					if ($this.data('metatype')==$prev.data('metatype') && !parseInt($this.data('attachments')) && $this.data('metatype')=="message"){
						_linkable=true;
					}
				}
			}
			
			if (_linkable){
				$this.addClass("-linked");
				if (!$prev.hasClass("-linked")){
					$prev.addClass("-first");
				}
			}else if ($this.hasClass("message")){
				$this.addClass("-leading");	
			}
		});
	};
	
	
	
	/**
	 * @desc Add a pending (fake) message
	 */
	this.addPendingMessage=function(message, channel){
		addDaySeparation(message, channel);
		if (message.content && message.content.length){
			message.content=safe(message.content);	
		}
		
		var html="<div class='message -saved' data-user='"+(message.user.id)+"' data-metatype='"+(message.metatype)+"' data-subtype='"+(message.subtype)+"' data-ts='"+(message.since)+"' id='msg-"+(message.id)+"'> <div class='wrapper'> <div class='image'>"+(getUser(message.user))+"</div> <div class='content'> <div class='header'> <em>"+(message.user.name)+"</em> <span class='time'>"+(getTime(message.since))+"</span> </div> <div class='body'>"+(getContent(message))+"</div> <div class='linked-time'>'"+(getTime(message.since))+"</div> </div> </div> </div>";
		
		var last=getLastMessage(channel);
		append(html, channel);
		
		if (linkable(message, last)){
			$("#msg-"+message.id).addClass("-linked");
			if (!last.elem.hasClass("-linked")){
				last.elem.addClass("-first");
			}
		}
		
		this.scrollDown(null, channel, 100);
	}
	
	
	
	
	
	this.scrollDown=function(msgid, channel, anim_time, callback, offset){
		var cid=Channel.id(channel);
		
		var $target=null;
		if (!msgid){
			$target=$("#channel-"+cid+" .channel-messages").children().last();
		}else{
			$target=$("#msg-"+msgid);
		}
		
		if (typeof anim_time=="undefined"){
			anim_time=500;
		}
		
		var $box=$target;
		if (!$box.length){
			return;
		}
		
		var h=$box.position().top;
		var $canvas=$box.closest('.scrollin');
		
		if (!offset){
			offset=10;
		}
		
		var st= h+$canvas.scrollTop()-offset;

		$canvas.animate({scrollTop: st}, anim_time, function(){
			if (callback){
				callback();
			}
		});
	};
	
	this.scrollBottom=function(channel_id, offset){
		this.scrollDown(0, channel_id, 100, null, -200);
		$("#channel-"+channel_id).removeClass("has_new_message");
	};
	
	
	this.forceScrollBottom=function(channel_id){
		var $c=$("#channel-"+channel_id+" .scrollin");
		if ($c && $c.length){
			$c.scrollTop($c[0].scrollHeight);	
		}
	};
	
	
	this.getTextContent = function(msg){
		return getContent(msg);
	};
	
	this.scrollTop=function(channel, anim_time, callback){
		this.scrollDown($("#channel-"+channel.id).find(".message").first(), channel, anim_time, callback);
	};
	
	
	function removePending(msg){
		if (!msg.state || !msg.state.length || parseInt(msg.user.id)!=parseInt(Client.viewer.id)){
			return; // No duplication
		}
		
		if ($("#msg-"+msg.state).length){
			$("#msg-"+msg.state).remove();
		}
	};
	
	
	function addDaySeparation(message, channel){
		var $last=getLastMessage(channel);
		if (!$last || !$last.ts){
			return;
		}
		
		var ts=$last.ts;
		
		if (AP.time.sameDay(message.since, ts)){
			return "";
		}
		
		append("<div class='ds'><div class='date'>"+AP.time.time("%D, %d/%m/%Y", message.since)+"</div></div>", message.channel_id);
	};
	
	
	function prependDaySeparation(message, channel){
		var $first=getFirstMessage(channel);
		if (!$first || !$first.ts){
			return;
		}
		
		var ts=$first.ts;
		
		if (AP.time.sameDay(message.since, ts)){
			return "";
		}
		
		prepend("<div class='ds'><div class='date'>"+AP.time.time("%D, %d/%m/%Y", message.since)+"</div></div>", message.channel_id);
	};
	
	
	
	function getLastMessage(channel){
		var $last=$("#channel-"+channel.id+" .message").last();
		if (!$last || !$last.data("metatype")){
			return {};
		}
		
		return {elem: $last, metatype: $last.data("metatype"), type: $last.data("type"), "ts": $last.data("ts"), "user": $last.data("user"), counter: 0}
	};
	
	
	
	function getFirstMessage(channel){
		var $first=$("#channel-"+channel.id+" .message").first();
		if (!$first || !$first.data("metatype")){
			return {};
		}
		
		
		return {elem: $first, metatype: $first.data("metatype"), type: $first.data("type"), "ts": $first.data("ts"), "user": $first.data("user"), counter: 0}
	};
	
	
	
	
	function linkable(msg, last){
		if (msg.subtype=="sticker" || msg.subtype == "code" || msg.subtype == "location"){
			return false;
		}
		
		if (!msg.attachments){
			return false; // Data error
		}
		
		if (!parseInt(last.user)){
			return false;
		}
		
		if (last.counter>=5){
			return false;
		}
		
		var ts=parseInt(last.ts);
		var mts=parseInt(msg.since);
		
		if (!AP.time.sameDay(ts, mts) || Math.abs(mts-ts)>=300){
			return false;
		}
		
		return msg.user.id==last.user && msg.metatype==last.metatype && !msg.attachments.length && msg.metatype=="message";
	};
	
	
	function getContent(message){
		if (message.content=="buzz!"){
			return "<span class='msg-buzz bold red upper'>BUZZ!</span>";
		}
		if (message.type=="sticker" && message.sticker_src && message.sticker_src.length){
			return "<div class='sticker'><img src='"+message.sticker_src+"'/></div>";
		}

		if (message.subtype=="sticker"){
			return "<div class='sticker'><img src='"+message.content+"'/></div>";
		}
		
		if (!message.content.length){
			return "";
		}
		
		if (message.subtype=="log"){
			return "<span class='log'>"+message.content+"</span>";
		}
		
		
		var mc=UI.emotion(UI.parse(message.content));
		if (mc.length){
			mc=mc.replace(/â‘/g,'&#92;').replace(/&#9290;/g, '&#92;');
		}
		return "<span class='msg-body'>"+mc+"</span>";
	};
	
	
	function getAttachments(message){
		if (!message.attachments.length) return "";
		
		if (message.subtype == "files" || (message.subtype == "log" && message.intent == "files")){
			return "  " +Render.render('att_files', {files:message.attachments, message:message}, '')+ '';
		}
		
		return AP.render(message.attachments, function(att){
			return getAttachment(message, att);
		})
	};
	
	function getAttachment(msg, att){
		return Message.attachment.get(msg, att);
	};
	
	
	function getUser(user){
		if (user.bot){
			image=user.image;
			
			if (!image){
				image=Client.share_url+"/bots/"+user.username+".png";
			}
			return "<div class='avatar'><img src='"+image+"'/></div>";	
		}
		return "<div class='avatar'><img src='"+AP.thumb(user.gavatar)+"'/></div>";
	};
	
	
	function getActions(message){
		var hl="";
		if (parseInt(message.pinned)){
			hl="hl";
		}
		
		var shl="";
//		if (Channel.star.starred(message.id)){
//			shl="hl";
//		}
		
		return "<span class='action "+shl+"'' onclick='Message.toggleStar(this);'>" +
				"<span class='actiontt'><span class='ttb'>Star message</span></span>" +
				"<span class='-ap icon-star_outline'></span>" +
			"</span>"+
		"<span class='action "+hl+"' onclick='Message.togglePin(this);'>" +
			"<span class='actiontt'><span class='ttb'>Pin message</span></span>" +
			"<span class='-ap icon-pin-outline'></span>" +
		"</span>";
	};
	
	function getTime(time){
		return AP.time.time("%H:%i", time);
	};
	
	
	
	function append(text, channel){
		$("#channel-"+channel.id+" .channel-messages").append(text);
	};
	
	
	function prepend(text, channel){
		$("#channel-"+channel.id+" .channel-messages").prepend(text);
	};
	
	
	
	
	
	function getMessageHTML(message, channel, ns){
		var msguser=message.user;
		var user=null;
		var extra="";
		if (parseInt(msguser.id) && msguser.username){
			user=People.get(msguser.username);
			if (!user){
				return "";
			}
		}else if(parseInt(msguser.id)===0 && msguser.username=="_bot"){
			user=msguser.user_export;
			user.bot=1;
			if (msguser.gavatar){
				user.image=msguser.gavatar;
			}
			
			extra="<span class='bottype'>BOT</span>";
			if (user.instant){
				extra="<span class='bottype'>IBOT</span>";	
			}
		}
		
		var na=0;
		if (message.attachments){
			na=message.attachments.length;
		}
		
		if (!ns){
			ns="msg";
		}
		
		var forward="";
		if (message.attachments && message.attachments.length && message.intent=="file"){
			forward=" &nbsp; <span class='action pointer' onclick='Message.forwardFile(this);' title='Forward this file ..'> <span class='-ap icon-forward'></span> </span>";
		}
		
		if (message.attachments && message.attachments.length && message.intent=="files") {
			forward = " &nbsp; <span class='action pointer' onclick='Message.forwardMultipleFiles(this);' title='Forward these files ..'> <span class='-ap icon-forward'></span> </span>";
		}

		if (message.subtype == "text") {
			forward = " &nbsp; <span class='action pointer' onclick='Message.forwardText(this);' title='Forward this message ...'> <span class='-ap icon-forward'></span> </span>";
		}

		var atts = ((message.attachments && message.attachments.length)?("<div class='attachments'>"+getAttachments(message)+"</div>"):"");
		
		var html="<div class='message -saved' title='"+(AP.time.time('%H:%i %d/%m',message.since))+" - "+(AP.time.ago(message.since))+"' data-msgid='"+(message.id)+"' data-user='"+(message.user.id)+"' data-metatype='"+(message.metatype)+"' data-type='"+(message.subtype)+"' data-ts='"+(message.since)+"' data-attachments='"+(na)+"' id='"+(ns)+"-"+(message.id)+"'> <div class='wrapper'> <div class='image'>"+(getUser(user))+"</div> <div class='content'> <div class='header ap-xdot'> <em class='url' data-username='"+(user.username)+"'>"+(user.name)+"</em> "+(extra)+" <span class='time ap-f12'>"+(getTime(message.since))+""+(forward)+"</span> <span class='actions'>"+(getActions(message))+"</span> </div> <div class='body-wrapper'> <div class='msg-reaction-button scale-small'>"+(Like.reaction.getReactionIcon(message))+"</div> " +Render.render('msg_body', {message:message}, '')+ " " +Render.render('msg_in_reply', {message:message, block:1}, '')+ "</div> <div class='linked'>"+(getActions(message))+"</div> <div class='linked-time'>"+(getTime(message.since))+"</div> "+(atts)+" "+(Like.reaction.getReactions(message))+" </div> </div> </div>";
		
		return html;
	}
};


Message.attachment = new function __MessageAttachments(){
	this.get=function(message, att, index){
		if (!att || !att.metatype){
			return "";
		}
		
		if (att.metatype=="block" && att.block_id){
			return Block.render(att);
		}
		
		
		if (att.metatype == "location"){
			return "  " +Render.render('att_location', {att:att, message:message}, '')+ '';
		}
		
		if (att.metatype == "base-video"){
			return "  " +Render.render('att_base_video', {att:att, message:message}, '')+ '';
		}
		
		if (att.metatype == "poll"){
			return "  " +Render.render('att_poll', {poll:att.poll, message:message}, '')+ '';
		}
		
		
		if (att.metatype=="base"){
			return "<div class='att -fileatt -filedrive -idx"+index+" -with-file-icon' data-metatype='"+att.metatype+"'>" +
				"<div class='att-box'>" +
					"<div class='att-file-icon'><img src='"+Client.share_url+"/32/file-text2.png'/></div>"+
					"<div class='att-title'><span class='a url' onclick=\"Base.file.preview('"+att.src+"');\">"+att.name+"</span></div>"+
					"<div class='att-footer'><span class='a url' onclick=\"Base.file.preview('"+att.src+"');\">Chi tiáº¿t</span> &middot; <a target='_blank' href='"+att.download+"'>Download</a></div>"+
				"</div>" +
				getCollapse(att)+
			"</div>";
		}
		
		if (att.metatype=="dropbox" || att.metatype=="onedrive" || att.metatype=="googledrive"){
			return "<div class='att -fileatt -filedrive -idx"+index+" -with-file-icon' data-metatype='"+att.metatype+"'>" +
				"<div class='att-box'>" +
					"<div class='att-file-icon'><img src='"+Client.share_url+"/32/file-"+att.metatype+".png'/></div>"+
					"<div class='att-title'><span class='a url' data-url='"+att.weblink+"' target='_blank'>"+att.name+"</span></div>"+
					"<div class='att-footer'><a href='"+att.weblink+"' target='_blank'>Chi tiáº¿t</a> &middot; <a target='_blank' href='"+att.download+"'>Download</a></div>"+
				"</div>" +
				getCollapse(att)+
			"</div>";
		}
		
		if (att.metatype=="link" || att.metatype=="video" || att.metatype=="file" || att.metatype=="topic" || 1==1){
			var extra='';
			if (att.metatype=="file" && att.cache){
				extra=" data-file_id='"+(att.cache.id)+"' data-file_name='"+(att.title)+"'";
			}
			
			return "<div class='att "+getClass(att)+"' data-metatype='"+att.metatype+"'"+extra+">" +
				getImage(att)+
				"<div class='att-box'>" +
					getLeft(att)+
					getHeader(att)+
					getDisplayFile(att)+
					getCover(att)+
					getTitle(att)+
					getText(att)+
					getFeatures(att)+
					getPlayVideo(att)+
					getFooter(att)+
				"</div>" +
				getCollapse(att)+
			"</div>";
		}
	};
	
	
	
	
	this.collapse=function(ref){
		var $att=$(ref).closest(".att");
		if ($att.hasClass("-collapsed")){
			$(".att-image", $att).slideDown(300);
			$(".att-text", $att).slideDown(300);
			$(".att-footer", $att).slideDown(300);
			$(".att-video", $att).slideDown(300);
			$(".att-display-file", $att).slideDown(300);
			$att.removeClass("-collapsed");
		}else{
			// $att.toggleClass("-collapsed");
			$(".att-image", $att).slideUp(300);
			$(".att-text", $att).slideUp(300);
			$(".att-footer", $att).slideUp(300);
			$(".att-video", $att).slideUp(300);
			$(".att-display-file", $att).slideUp(300);
			$att.addClass("-collapsed");
		}
	};
	
	
	function getClass(att){
		var cs=[];
		if (att.image && att.image.length && att.metatype!="video" && att.metatype!="file"){
			cs.push("-with-image");
		}else if (att.icon && att.icon.length){
			if (att.size && att.size=="small"){
				cs.push("-with-small-icon");
			}else{
				cs.push("-with-icon");	
			}
		}
		
		if (att.metatype=="file"){
			cs.push("-fileatt");
			
			if(typeof att !== 'undefined' && typeof att.image !== 'undefined') {
			    if (!att.image && !att.image.length){
	                cs.push("-with-file-icon");
	            }
			}
		}
		
		return cs.join(" ");
	};
	
	
	function getLeft(att){
		if (att.metatype=="file"){
			return "";
		}
		
		if (att.icon && att.icon.length){
			return "<div class='att-icon'><img src='"+Client.share_url+"/messages/"+att.icon+"'/></div>";
		}
		
		return "<div class='att-r'></div>";
	};
	
	function getImage(att){
		if (att.metatype=='video' || att.metatype=='file'){
			return "";
		}
		
		if (att.image && att.image.length){
			return "<div class='att-image'><div class='img'><img src='"+AP.thumb(att.image)+"'/></div></div>";
		}
		
		
		return "";
	};
	
	
	
	
	function getHeader(att){
		return "";
	};
	
	function getTitle(att){
		if (!att.title || !att.title.length){
			return "";
		}
		
		if (att.metatype=="file" && att.src){
			return "<div class='att-title'><span class='a url' data-url=':file' data-file='"+att.src+"'>"+att.title+"</span></div>";
		}
		
		if (!att.url){
			return "<div class='att-title'>"+att.title+"</div>";
		}
		
		return "<div class='att-title'>"+Base.a(att.url, att.title)+"</div>";
	};
	
	function getText(att){
		if (att.text && att.text.length){
			return "<div class='att-text'>"+att.text+"</div>";
		}
		
		return "";
	};
	
	
	function getFeatures(att){
		if (att.features && att.features.length){
			return "<div class='att-features'>"+AP.render(att.features, function(e){
				return getFeature(e);
			})+"</div>";
		}
		
		return "";
	};
	
	
	function getFeature(e){
		if (!e.label){
			return "";
		}
		
		if (parseInt(e.short)){
			return "<div class='feature -s'>" +
				"<div class='label ap-xdot'>"+e.label+"</div>" +
				"<div class='value ap-xdot' title='"+e.evalue+"'>"+e.value+"</div>" +
			"</div>";
		}
		
		return "<div class='feature -xs'>" +
			"<div class='label'>"+e.label+"</div>" +
			"<div class='value'>"+e.value+"</div>" +
		"</div>";
	};
	
	
	function getFooter(att){
		if (!att.footer || !att.footer.length){
			if (att.metatype=="file"){
				return "<div class='att-footer'>"+att.size+" KB &middot; <a href='"+att.download+"' target='_blank'>Download</a></div>";	
			}
			
			return "";
		}
		
		if (!att.footer_url || !att.footer_url.length){
			return "<div class='att-footer'>"+getFooterIcon(att)+""+att.footer+"</div>";
		}
		
		return "<div class='att-footer'>"+getFooterIcon(att)+"<a href='"+att.footer_url+"' target='_blank'>"+att.footer+"</a></div>";
		
	};
	
	
	function getFooterIcon(att){
		if (att.footer_icon && att.footer_icon.length){
			var parts=att.footer_icon.split(" ");
			if (parts.length==2){
				return "<span class='att-footer-icon'><span class='-ap icon-"+parts[0]+"'></span></span>";
			}else{
				return "<span class='att-footer-icon'><span class='-ap icon-"+parts[0]+"'></span></span>";
			}
		}

		return "";
	}
	
	function getPlayVideo(att){
		if (att.metatype!='video'){
			return "";
		}
		
		if (att.image && att.image.length){
			return "<div class='att-video'>" +
				"<div class='video-screen'><img src='"+att.image+"'/></div>" +
				"<div class='video-mask'></div>" +
				"<div class='play-button'>" +
				"	<div class='button-fix'></div>" +
				"	<div class='button' data-play-url='"+att.video_play_url+"'><span class='-ap icon-play_circle_filled'></span></div>" +
				"</div>" +
				"<div class='link-button'><a target='_blank' href='"+att.url+"'><span class='-ap icon-open_in_new'></span></a></div>" +
			"</div>";
		}
		
		return "";
	};
	
	
	/**
	 * @desc Special case, get displayed video
	 */
	function getDisplayFile(att){
		if (att.metatype!="file"){
			return "";
		}
		
		if (att.image && att.image.length){
			return "<div class='att-display-file'><span class='url' data-url=':file' data-file='"+att.src+"'><img src='"+att.image+"'/></span></div>";
		}else{
			var icon=UI.file.icon(UI.file.ext(att.name));
			return "<div class='att-file-icon'><img src='"+Client.share_url+"/32/file-"+icon+".png'/></div>";
		}
		
		
		return "";
	};
	
	
	function getCover(att){
		if (!att.cover || !att.cover.length){
			return "";
		}
		
		if (att.cover_url && att.cover_url.length){
			return "<div class='att-cover'><a href='"+att.cover_url+"'><img src='"+att.cover+"'/></a></div>";
		}else{
			return "<div class='att-cover'><span><img src='"+att.cover+"'/></span></div>";
		}
	};
	
	
	
	function getCollapse(att){
		if (!att.title || !att.title.length){
			return "";
		}
		return "<div class='att-collapse' onclick=\"Message.attachment.collapse(this);\"><span class='-ap icon-chevron-down2'></span></div>";
	};
};


Message.form = new function __MessageForm(){
	this.imTyping=false; // I'm currently not typing
	
	this.globalInit=function(){
		
	};
	
	
	/**
	 * @desc Only build after the Channel.channel is fully loaded
	 */
	this.build=function(channel){		
		this.untyping();
		this.imTyping=false;
		
		$("#channel-"+channel.id).data("channel", channel);
		
		this.initTyping(channel);
		$("#channel-"+channel.id+" .msg-input").on("input focus", function(){
			Message.form.updateState(this);
		}).on("blur", function(){
			Message.form.untyping(channel);
			Message.form.updateState(this);
		});
		
		Tag.user("#channel-"+channel.id+" .msg-input", People.collect(channel.followers));
		$("#channel-"+channel.id+" .msg-input").autoExpand();
		
		
		$("#channel-"+channel.id+" .msg-input").enter(function(){
			Message.form.send(this);
		}).screencopy(Message.api+"api/message/file/screenshot", function(code){
		},{
			channel_id: channel.id, channel_token: channel.token
		});
		
		AP.uploadable("#channel-"+channel.id+" .channel-upload-file",{
			action: Message.api+"api/message/file/upload",
			data: {channel_id: channel.id, dnd: 1, multi: 1},
			multi: 1
		}, function(code){
			$.log(code);
		});
		
		AP.uploadable("#channel-"+channel.id+" .channel-upload-image",{
			action: Message.api+"api/message/file/upload",
			data: {channel_id: channel.id, dnd: 1, multi: 1},
			multi: 1
		}, function(code){
			$.log(code);
		});

		$("#channel-"+channel.id+" .channel-buzz").click(function(){
			Message.sender.buzz(channel);
        });
        
        $("#channel-" + channel.id + " .channel-feedback").click(function(){
			Message.sender.feedback(channel);
		});
		
		$("#channel-"+channel.id+" .channel-like").click(function(){
			Message.sender.text("(Y)", channel);
		});
		
		$("#channel-"+channel.id+" .channel-upload-drive").click(function(){
			Message.sender.drive(channel);
		});
		
		this.initDnD(channel);
		// Sticker.init(channel);
		
		$("#channel-"+channel.id+" .channel-smiley-input").click(function(){
			Base.emoji.init({
				bottom: 67,
				left: $(this).offset().left-250,
			}, function(emoji){
				Base.emoji.insert("#channel-"+(channel.id)+" .textarea textarea.msg-input", emoji);
				Base.emoji.hide();
			});
			
			Base.emoji.giphy.hide();
			return;
		});
		
		$("#channel-"+channel.id+" .channel-sticker").click(function(){
			Base.emoji.giphy.init({
				bottom: 67,
				left: $(this).offset().left-250,
			}, function(emoji){
				Message.sender.sticker(channel, emoji.gif);
			});
			
			Base.emoji.hide();
			
			return;
		});
		
		
		$("#channel-"+channel.id+" .js-more-action .js-video").click(function(){
			Message.extra.video(channel);
			return;
		});
		
		$("#channel-"+channel.id+" .js-more-action .js-location").click(function(){
			Message.extra.location(channel);
			return;
		});
		
		$("#channel-"+channel.id+" .js-more-action .js-formatted").click(function(){
			Message.extra.formatted(channel);
			return;
		});
		
		$("#channel-"+channel.id+" .js-more-action .js-poll").click(function(){
			Message.extra.poll(channel);
			return;
		});
		
		$("#channel-"+channel.id+" .scrollin").on("scroll", function(e){
			if (e.originalEvent && e.originalEvent.isTrusted){
				$(this).data("last_scroll", AP.time.now());
			}
		});
		// .after("<div class='new_message_trigger' onclick='Message.form.forceScrollDown(this);'><span class='-ap icon-arrow_drop_down'></span> New message</div>");
	};
	
	
	this.initDnD=function(channel){
		AP.dnd("#channel-"+channel.id, Message.api+"api/message/file/upload",{
			"channel_id": channel.id,
			"channel_token": channel.token,
			"dnd": 1
		}, function(code){
			$.log(code);
		},{
			multi: true
		});
	};
	
	
	this.onSending=function(msgdata, channel){
		$("#channel-"+channel.id+" .msg-input").val("").trigger("keypress").focus().change().height(26);
		Message.html.addPendingMessage(msgdata, channel);
	};
	
	this.onSent=function(msg, state){
		this.untyping();
	};
	
	
	this.send=function(ref){
		var $canvas=$(ref).closest(".msg-channel");
		var channel=$canvas.data("channel");
		
		var content=$(ref).val();
		if (!content.length){
			return;
		}
		
		Message.sender.text(content, channel);
	};

	
	
	this.typing_last_time=AP.time.now();
	this.typing_last_event="none";
	this.typing_last_channel=0;
	this.typing_text=0;
	
	
	this.initTyping=function(channel){
		var id=Channel.id(channel);
		$("#channel-"+id+" .msg-input").on("keyup", function(e){
			Message.form.checkTyping(id);
		});
	};
	

	this.untyping=function(){
		if (this.imTyping){
			this.imTyping=false;
			Message.socket.send("imtyping", 0);
		}else{
			if (AP.time.now()-this.typing_last_time>3 || 1==1){
				this.typing_last_time=AP.time.now();
				this.typing_event="untyping";
				Message.socket.send("imtyping", 0);
			}
		}
		
		this.imTyping=false;
	};
	
	
	
	this.checkTyping=function(channel){		
		if (!Base.tabActive()){
			this.untyping();
			return;
		}
		
		var id=Channel.id(channel);
		
		var val=$("#channel-"+id+" .msg-input").val();
		if (val && val.length){
			this.typing_last_time=AP.time.now();
			this.typing_event="typing";
			
			if (!this.imTyping){
				this.imTyping=true;
				if (val != this.typing_text){
					typing_text=val;
					Message.socket.send("imtyping", id);
				}
				
				setTimeout(function(){
					if (Message.form.typing_event=="typing" && AP.time.now() - Message.typing_last_time >=5){
						Message.form.untyping();
					}
				}, 6000);
			}
		}else{
			this.untyping();
		}
	};
	
	

	this.updateTypings=function(channel_id, users){
		if (!$("#channel-typing-"+channel_id).length){
			return;
		}
		
		var typings=AP.array.filter(users, function(e){
			if (e.id==Client.viewer.id){
				return false;
			}
			return true;
		});
		
		if (!typings.length){
			$("#channel-typing-"+channel_id).slideUp(50);
			$("#channel-"+channel_id+" .channel-typing-fix").hide();
			return;
		};
		
		var text=AP.word.join(typings, ", ",function(e){
			var person=People.getID(e.id);
			return "<span class='av'><img src='"+AP.xthumb(person.gavatar)+"'/></span><em>"+person.first_name+"</em>";
		});
		
		// Get scroll position
		var offset_bottom=getOffsetBottom("#channel-typing-"+channel_id);
		var last_time=$("#channel-typing-"+channel_id).closest(".scrollin").data("last_scroll");
		
		if (offset_bottom>30 || (last_time && AP.time.now()-parseInt(last_time) > 30)){
			showNewMessageBelow(channel_id);
			$("#channel-typing-"+channel_id).show();
		}else{
			$("#channel-typing-"+channel_id).slideDown(100, function(){
				Message.html.forceScrollBottom(channel_id);
			});
		}
		
		if (typings.length>=2){
			$("#channel-typing-"+channel_id+" .typing .text").html(text+" are typing <span class='dots'><span></span></span>");
		}else{
			$("#channel-typing-"+channel_id+" .typing .text").html(text+" Ä‘ang viáº¿t <span class='dots'><span></span></span>");
		}
		
		$("#channel-"+channel_id+" .channel-typing-fix").show();
	};
	
	
	this.updateState=function(ref){
		var channel=getChannel(ref);
		if (!channel){
			return;
		}
		
		var val=$(ref).val();
		if (val && val.length){
			$("#msg-form-"+channel.id).addClass("active");
		}else{
			$("#msg-form-"+channel.id).removeClass("active");
		}
	};
	
	
	this.forceScrollDown=function(ref){
		var $box=$(ref).closest(".msg-channel");
		$box.removeClass("has_new_message");
		Message.html.forceScrollBottom($box.data("id"));
	};

	
	/**
	 * @desc Get offset relative to bottom
	 */
	function getOffsetBottom(eid){
		var $c=$(eid).closest(".scrollin");
		if (!$c.length){
			return;
		}
		
		var offset=$c[0].scrollHeight-$c[0].offsetHeight - $c[0].scrollTop;
		
		return offset;
	};
	
	
	
	function showNewMessageBelow(channel_id){
		// $("#channel-"+channel_id).addClass("has_new_message");
	};
};



Message.cache=new function __MessageCache(){
	this.data={};
	
	this.get=function(id){
		return null;
		
		if (AP.data.isObject(id)){
			return id;
		}
		var c=AP.array.findObj(Channel.manager.channels, id);
		if (c){
			return {channel: c, messages: [], page_token: 0};
		}
		
		return null;
	};
	
	
	this.getValue=function(obj, key){
		if (this.data["x"+obj.id+"_"+key]){
			return this.data["x"+obj.id+"_"+key];
		}
		
		return null;
	};
	
	this.setValue=function(obj, key, value){
		this.data["x"+obj.id+"_"+key]=value;
	};
	
	
	this.currentChannels=function(){
		var cs=Clog.getCookie("msgchannels");
		if (cs && cs.length){
			try{
				var r= JSON.parse(cs);
				if (r.length && !r[0].id){
					return [];
				}
				
				return r;	
			}catch(e){
				return [];
			}
		}
		
		return [];
	};
	
	
//	this.setCurrentChannels=function(ids){
//		Clog.setCookie("msgchannels", JSON.stringify(ids));
//	};
//	
	
	this.auto=function(){
		var r=[];
		
		$("#js-msg-boxes .msg-channel.is-channel").each(function(){
			var id=$(this).data("id");
			var c=0;
			if ($(this).hasClass("collapsed")){
				c=1;
			}
			
			r.push({id: id, c: c});
		});
		
		r=r.slice(0, 4);
		Clog.setCookie("msgchannels", JSON.stringify(r));
		
		if ($("#msg-panel").length && $("#msg-panel").hasClass("collapsed")){
			Clog.setCookie("msgpc", 1); 	
		}else{
			Clog.setCookie("msgpc", 0);
		}
	};
	
	
	this.removeCachedChannel=function(id){
		Clog.removeCookie("msgchannels");
	};
	
};



function getChannel(ref){
	return $(ref).closest(".msg-channel").data("channel");
};
	
var Channel = new function __Channel(){
	this.channel=null; // The currently active channel
	this.previous=null; // Cache only
	this.channels=[];
	this.current_id=null;
	
	if (typeof Client.base != 'undefined' && Client.base.channels){
		this.__channels=Client.base.channels; // The list of all initally loaded channels, can load more
		if (this.__channels){
			this.channels=this.__channels.slice();
		}	
	}
	
	this.id=function(channel){
		if (AP.data.isObject(channel)){
			return channel.id;
		}
		
		return channel;
	};
	
	
	/**
	 * @desc Check if the channel with ID is currently active
	 */
	this.isActive=function(id){
		// $.log([this.current.name, this.current.id, id]);
		return this.current_id==id;
	};
	
	
	this.setActive=function(channel_id){
		Message.socket.send("channel.active", channel_id);
		
		if (channel_id && parseInt(channel_id)){
			$("#js-msg-boxes .msg-channel").setActive("#channel-"+channel_id);
			Message.canvas.onChannelActive(channel_id);
		}else{
			$("#js-msg-boxes .msg-channel").removeClass("active");
		}
	};
	
	
	this.isDisplayed=function(id){
		return $("#channel-"+id).length>=1;
	};
	
	
	/**
	 * @desc Get channel with channel_id and callback 
	 */
	this.get=function(channel_id, callback, intent){
		if (!channel_id || !AP.data.isInt(channel_id)){
			return;
		}
		var obj = Message.cache.get(channel_id);
		if (obj){
			callback(obj.channel, obj.messages, obj.page_token);
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/channel/get", {id: channel_id}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				// Clog.removeLog("__channel");
				if (intent && intent=="cache"){
					Message.cache.removeCachedChannel(channel_id);	
				}else{
					AP.alertError("We have trouble loading messages ["+channel_id+"] ... Please refresh to continue...");	
				}
				
				Channel.close(channel_id);
				return;
			}
			
			callback(code.channel, code.messages, code.page_token, code.stars);
		});
	};
	
	
	
	
	/**
	 * @desc Load the channel
	 */
	this.open=function(channel_id, opts, callback){
		if (this.isDisplayed(channel_id)){
			fixIntention(channel_id, opts.intent);
			return;
		}
		
		if (this.channel && this.channel.id==channel_id){
			if (callback){
				callback();
			}
			return;
		}
		
		this.get(channel_id, function(channel, messages, page_token, stars){
			Channel.openDirect(channel, messages, page_token, stars, callback, opts);
		}, opts.intent);
	};


	this.openDirect=function(channel, messages, page_token, stars, callback, opts){
		display(channel, messages, page_token, stars, callback, opts);
		// Channel.setActive(channel.id);
		// Message.socket.send("channel.active", channel.id);
	};
	
	
	this.close=function(channel){
		var id=Channel.id(channel);
//		var cs=Message.cache.currentChannels();
//		cs=AP.array.filter(cs, function(e){
//			return parseInt(e)!=parseInt(id);
//		});
//		
//		Message.cache.setCurrentChannels(cs);
		
		if (id){
			Message.socket.emitMe("channel.me.close", {id: id});
		}
	};
	
	
	
	this.showMessages=function(channel, messages){
		for (var i=messages.length-1; i>=0; i--){
			Message.addMessage(messages[i], channel);
		};
	};
	

	this.loadPrevious=function(channel){
		var loading=Message.cache.getValue(channel, "loading");
		var page_token=Message.cache.getValue(channel, "page_token");
		if (loading=="0"){
			loading=0;
		}
		
		if (loading || !page_token){
			return;
		}
		
		Message.cache.setValue(channel, "loading", 1);
		UI.ajaxShow();
		
		var $box=$("#channel-"+channel.id+" .scrollin");
		var current_offset=$box[0].scrollHeight;
		
		AP.post(Message.api+"api/message/message/previous", {token: page_token, id: channel.id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				Message.cache.setValue(channel, "loading", 0);
				return AP.alertError("Cannot load previous message");
			}
			
			Message.cache.setValue(channel, "page_token", code.page_token);
			
			for (var i=0; i<code.messages.length; i++){
				Message.html.prependMessage(code.messages[i], channel);
			}
			
			Message.html.linkGroup(channel);
			
			if (code.messages.length){
				current_offset=$box[0].scrollHeight-current_offset;
				$box.scrollTop(current_offset);
				
				Message.cache.setValue(channel, "loading", 0);
			}else{
				Message.cache.setValue(channel, "loading", 0);
			}
			
		});
	};
	
	
	
	function display(channel, messages, page_token, stars, callback, opts){
		if ($("#channel-"+channel.id).length){
			if (opts.prepend){
				$("#channel-"+channel.id).removeClass("collapsed");
				Message.render.balance();
			}
			
			return;
		}
		
		Message.render.channel(channel, opts);
		
		if (!page_token){
			page_token=0;
		}
			
		Message.cache.setValue(channel, "page_token", page_token);
		Channel.showMessages(channel, messages);
		
		if (callback){
			callback();
		};
		
		
		fixIntention(channel.id, opts.intent);
		
	};
	
	
	
	function fixIntention(channel_id, intent){
		if (intent){
			if (intent=="panel"){
				if ($("#channel-"+channel_id).hasClass("collapsed")){
					$("#channel-"+channel_id).removeClass("collapsed");
					Message.canvas.balance();
				}
				
				setTimeout(function(){
					$.log("#channel-"+channel_id+" textarea.msg-input");
					$("#channel-"+channel_id+" textarea.msg-input").autofocus();
				}, 200);
				
				Channel.setActive(channel_id);
			}
		}
	};
	
	
	
};






Channel.manager=new function __ChannelManager(){
	this.channels=[];
	this.ready=0;
	
	this.load=function(callback, set){
		if (!set){
			set="";
		}

		AP.post(Message.api+"api/channel/channels", {'set': set}, function(code){
			if (!code.good()){
				return false;
			}
			
			Channel.manager.channels=code.channels.slice();
			Channel.manager.ready=1;
			Channel.manager.getUnreads(callback);
			return;
		});
	};
	
	
	
	/**
	 * @desc Getting unread counts and last messages of all channels to be cared
	 */
	this.getUnreads = function(callback){
		var ids=AP.select(this.channels, function(e){
			return e.id;
		});
		

		Message.socket.emit("channels.get",{ids: ids}, function(data){
			for (var i=0; i<data.length; i++){
				setUnreadCount(data[i].id, data[i].unread_count);
			}
			
			// Message.notify.badge();
			
			if (callback){
				callback(Channel.manager.channels);
			}
		});
	};
	
	
	this.getChannelUnread=function(channel_id){
		for (var i=0; i<this.channels.length; i++){
			if (this.channels[i].id==channel_id){
				return parseInt(this.channels[i].unread_count);
			}
		}
		
		return 0;
	};
	
	
	this.fixUnread=function(channel){
		for (var i=0; i<this.channels.length; i++){
			if (this.channels[i].id==channel.id){
				this.channels[i].unread_count=parseInt(channel.unread_count);
				break;
			}
		}
	};
	
	
	
	this.countUniqueUnreads=function(){
		var total=0;
		for (var i=0; i<this.channels.length; i++){
			if (parseInt(this.channels[i].unread_count)){
				total++;	
			}
		}	
		
		return total;
	};
	
	
	
	
	function setUnreadCount(channel_id, unread_count){
		for (var i=0; i<Channel.manager.channels.length; i++){
			if (Channel.manager.channels[i].id==channel_id){
				Channel.manager.channels[i].unread_count=parseInt(unread_count);
				return;
			}
		}
	};
};


Channel.fav=new function __ChannelFav(){
	this.favs=[];
	
	this.toggle=function(id){
	};
	
	this.reset=function(stars){
		if (stars){
			this.stars=stars;
		}else{
			this.stars=[];
		}
	}
	
	this.fav=function(id){
		return (this.stars.indexOf(id)!=-1);
	};
};


Channel.engine=new function __ChannelEngine(){
	this.isDeactivated=function(channel){
		if (channel.subtype =="peer"){
			for (var i=0; i<channel.followers.length; i++){
				var id=channel.followers[i];
				if (id!=Client.viewer.id){
					var u=People.get(id);
					if (!u || !u.id || u.username=="none"){
						return true;
					}
				}
			}
		}
		
		return false;
	};
	
	
	
	this.getImage=function(channel){
		if (channel.metatype=="channel" && channel.subtype=="user"){
			return getSelfImage(channel);
		}
		
		if (channel.metatype=="channel" || channel.metatype=="unit"){
			return getChannelImage(channel);
		}
		
		if (channel.metatype=="dm" && channel.subtype=="peer"){
			return getPeerImage(channel);
		}
		
		if (channel.metatype=="dm"){
			return getGroupImage(channel);
		}
		
		if (channel.metatype=="project"){
			return getProjectIcon(channel.subtype);
		}
		
		return "";
	};

	
	this.getDisplayName=function(channel){
		if (channel.metatype=="dm"){
			if (channel.subtype=="peer"){
				var ua = People.get(channel.followers[0]);
				var ub = People.get(channel.followers[1]);
				
				if (ua.id==Client.viewer.id){
					return ub.name;
				}else{
					return ua.name;
				}
			}
		}else if (channel.metatype=="channel" && channel.subtype=="user"){
			return "CĂ¡ nhĂ¢n";
		}
		
		return channel.name;
	};
	
	
	this.lastMessage=function(channel){
		var last=channel.latest;
		if (!last){
			return "Conversation just started";	
		}
		
		if (last && last.content){
			user=People.get(last.username);
			if (!user){
				return "Conversation just started";
			}
			
			var sign=" ";
			if (last.content && last.content.charAt(0)==":"){
				sign="";
			}
			
			return getLastDisplay(user, sign+last.content);
		}
		
		return "Conversation just started";
	};
	
		
	this.fromMessage=function(last){
		var user;
		if (last && last.content){
			if (last.username){
				user=People.get(last.username);
			}else{
				user=People.get(last.user.username);	
			}
			
			if (!user){
				return "Conversation just started";
			}
			
			var sign=": ";
			if (last.content && last.content.charAt(0)==":"){
				sign="";
			}
			
			return getLastDisplay(user, sign+last.content);
		};
		
		return "Conversation just started";
	};
		
		
		
	function getLastDisplay(user, msg){
		if (!parseInt(user.id) && user.username=="_bot"){
			return "<div class='msg'> <div class='ap-xdot'><em>BOT</em> "+(msg)+"</div> </div>";
		}
		
		if (!msg){
			msg="Conversation just started";
		}
		if (msg){
			return "<div class='tinyavt'><img src='"+AP.xthumb(user.gavatar)+"'></div>" +
				"<div class='msg'><div class='ap-xdot'><em>"+user.first_name+"</em>"+msg+"</div></div>";
		}
		
		return "";
	};
	
	
	
	function getSelfImage(c){
		return "<div class='image'><div class='single'><img src='"+AP.thumb(Client.viewer.gavatar)+"'></div></div>";
	};
	
	
	function getPeerImage(c){
		var user=People.get(c.followers[0]);
		if (user.username==Client.viewer.username){
			user=People.get(c.followers[1]);
		}
		
		return "<div class='image'><div class='single'><img src='"+AP.thumb(user.gavatar)+"'></div></div>";
	};
	
	
	function getGroupImage(c){
		var teams=c.followers;
		
		if (teams.length==3){
			var u0=People.get(teams[0]);
			var u1=People.get(teams[1]);
			var u2=People.get(teams[2]);
			
			return "<div class='avatars -three'>" +
					"<div class='avatar -first'><img src='"+AP.thumb(u0.gavatar)+"'/></div>" +
					"<div class='avatar -second -bb -bl'><img src='"+AP.thumb(u1.gavatar)+"'/></div>" +
					"<div class='avatar -third -bl'><img src='"+AP.thumb(u2.gavatar)+"'/></div>" +
				"</div>";
		}
		
		if (teams.length>=4){
			var u0=People.get(teams[0]);
			var u1=People.get(teams[1]);
			var u2=People.get(teams[2]);
			var u3=People.get(teams[3]);
			
			return "<div class='avatars -four'>" +
					"<div class='avatar -first -bb -br'><img src='"+AP.thumb(u0.gavatar)+"'/></div>" +
					"<div class='avatar -second -bb'><img src='"+AP.thumb(u1.gavatar)+"'/></div>" +
					"<div class='avatar -third -bl'><img src='"+AP.thumb(u2.gavatar)+"'/></div>" +
					"<div class='avatar -forth'><img src='"+AP.thumb(u3.gavatar)+"'/></div>" +
				"</div>";
		}
		
		
		
		return "";
	};
	
	
	
	function getProjectIcon(type){
		return "<div class='full-mask -bg-alt"+Client.viewer.color+"'></div> <div class='box-text'><span class='-ap icon-timeline normal'></span></div>";
	};
	
	
	function getChannelImage(c){
		var txt=c.name.substr(0,2);
		var parts=c.name.split(" ", 2);
		if (parts.length>=2){
			txt=parts[0].charAt(0)+parts[1].charAt(0);
		}
		return "<div class='full-mask -bg-alt"+c.color+"'></div> <div class='box-text'><span>"+txt+"</span></div>";
	};
	
	
	
};




Render.on("att-task", function(){
	var task = this.task;
	if (!task){
		try{
			task = JSON.parse(Base64.safeDecode(this.encoded_task));
		}catch(e){
			return '';
		}
	}
	
	task.metatype = 'task';
	
	var tasklist ='';
	var assign = '';
	var content = '';
	if (task.tasklist){
		tasklist= " &middot; NhĂ³m cĂ´ng  viá»‡c: "+(safe(task.tasklist))+"";
	}
	
	if (task.content){
		content= "  " +Render.render('att_footer', {}, '' +Render.render('text_icon', {icon: "ap uniF12F" }, ""+(safe(task.content))+"")+ '')+ '';
	}
	
	if (task.assign_to && AP.data.isInt(task.assign_to)){
		assign= " &middot; Giao cho: " +Render.render('user', {user_id:safe(task.assign_to), name_only:1, thick:1}, '')+ "  ";
	}
	
	return "<div class='body'><span class='msg-body'>created a task</span></div> " +Render.render('att_canvas', {att:task}, '' +Render.render('att_title', {url:safe(task.url)}, ""+(safe(task.name))+"")+ ""+(content)+" " +Render.render('att_footer', {lg:1}, '' +Render.render('text_icon', {icon: "ap uniF10E" }, "Project: <span class='url thick' data-url='"+(safe(task.project_link))+"'>"+(safe(task.project_name))+"</span> "+(tasklist)+" "+(assign)+"")+ '')+ " " +Render.render('att_footer', {}, '' +Render.render('text_icon', {icon: "ap turned_in_not2" }, "Base Wework &rsaquo; Task &middot; Táº¡o bá»Ÿi " +Render.render('user', {user_id:safe(task.creator_id), name_only:1, thick:1}, '')+ "  " +Render.render('text_ago', {ts:safe(task.since)}, '')+ '')+ '')+ '')+ '';
});






Render.on("att-request", function(){
	var request = this.request;
	if (!request){
		try{
			request = JSON.parse(Base64.safeDecode(this.encoded_request));
		}catch(e){
			return '';
		}
	}
	
	request.metatype = 'request';
	
	var assign = '';
	var content = '';
	
	if (request.content){
		content= "  " +Render.render('att_footer', {}, '' +Render.render('text_icon', {icon: "ap uniF12F" }, ""+(safe(request.content))+"")+ '')+ '';
	}
	
	return "<div class='body'><span class='msg-body'>created a request</span></div> " +Render.render('att_canvas', {att:request}, '' +Render.render('att_title', {url:safe(request.url)}, ""+(safe(request.name))+"")+ ""+(content)+" " +Render.render('att_footer', {lg:1}, '' +Render.render('text_icon', {icon: "ap uniF10E" }, "Group: <span class='url thick' data-url='"+(safe(request.group_link))+"'>"+(safe(request.group_name))+"</span> &middot; Base Request &rsaquo; Táº¡o bá»Ÿi " +Render.render('user', {user_id:safe(request.creator_id), name_only:1, thick:1}, '')+ "  " +Render.render('text_ago', {ts:safe(request.since)}, '')+ '')+ '')+ '')+ '';
});


Render.on(["msg-attachment", "msg-att"], function(){
	var att = this.attachment;
	if (!att){
		return;
	}
	
	if (att.metatype=="block" && att.block_id){
		return Block.render(att);
	}
	
	if (att.metatype == "location"){
		return "  " +Render.render('att_location', {att:att, message:this.message}, '')+ '';
	}
	
	if (att.metatype == "base-video"){
		return "  " +Render.render('att_base_video', {att:att, message:this.message}, '')+ '';
	}
	
	if (att.metatype == "poll"){
		return "  " +Render.render('att_poll', {poll:att.poll, message:this.message}, '')+ '';
	}
	
	if (att.image && att.image.length){
		if (att.metatype!="video" && att.metatype!="file"){
			this.addClass("-with-image");	
		}
	}else if (att.icon && att.icon.length){
		if (att.size && att.size=="small"){
			this.addClass("-with-small-icon");
		}else{
			this.addClass("-with-icon");	
		}
	}
		
	if (att.metatype=="file"){
		this.addClass("-fileatt");
		
		if (!att.image && !att.image.length){
			this.addClass("-with-file-icon");
		}
	}
	
	var extra="";
	
	if (att.metatype == "screenshot"){
		return "<div class='att -fileatt "+(this.get('class'))+"' data-metatype='"+(att.metatype)+"' data-file_id='"+(att.id)+"' data-file_name='"+(att.title)+"' "+(this.show('id'))+"> <div class='att-box'> <div class='att-display-file'> <span class='url' data-url='::base/file?file="+(Base64.encodeURI(att.src))+"'> <img src='"+(att.src)+"'/> </span> </div> " +Render.render('att_title', {url: "::base/file?file="+(Base64.encodeURI(att.src))+"" }, ""+(att.name)+"")+ "<div class='att-footer'> <span class='js-size'>"+(att.size)+"</span>kb &nbsp;&middot;&nbsp; <span class='url' data-url='::base/file?file="+(Base64.encodeURI(att.src))+"'>View</span> &nbsp;&middot;&nbsp; <a class='url' data-url='"+(att.download)+"'>Download</a> </div> </div> </div>";
	}
	
	
	if (att.metatype=="base"){
		var ficon = UI.file.icon(att.fid);
		
		return "<div class='att -fileatt -filedrive -idx"+(att.id)+" -with-file-icon' data-metatype='"+(att.metatype)+"'> <div class='att-box'> <div class='att-file-icon'><img src='"+(Client.share_url)+"/32/file-"+(ficon)+".png'/></div> <div class='att-title'><span class='a url' data-url='::base/file?file="+(Base64.encodeURI(att.src))+"'>"+(att.name)+"</span></div> <div class='att-footer'><span class='a url' data-url='::base/file?file="+(Base64.encodeURI(att.src))+"'>Xem chi tiáº¿t</span> &middot; <a target='_blank' href='"+(att.download)+"'>Download</a></div> </div> " +Render.render('att_collapse', {attachment:att}, '')+ "</div>";
	}
	
	
	if (att.metatype=="dropbox" || att.metatype=="onedrive" || att.metatype=="googledrive"){
		return "<div class='att -fileatt -filedrive -idx"+(att.id)+" -with-file-icon' data-metatype='"+(att.metatype)+"'> <div class='att-box'> <div class='att-file-icon'><img src='"+(Client.share_url)+"/32/file-"+(att.metatype)+".png'/></div> <div class='att-title'><span class='a url' data-url='"+(att.weblink)+"' target='_blank'>"+(att.name)+"</span></div> <div class='att-footer'><a href='"+(att.weblink)+"' target='_blank'>Xem chi tiáº¿t</a> &middot; <a target='_blank' href='"+(att.download)+"'>Download</a></div> </div> " +Render.render('att_collapse', {attachment:att}, '')+ "</div>";
	}
	
	
	if (att.metatype=="link" || att.metatype=="video" || att.metatype=="file" || att.metatype=="topic"){
		if (att.metatype=="file" && att.cache){
			extra="data-file_id='"+(att.cache.id)+"' data-file_name='"+(att.title)+"'";
		}
		
		return "<div class='att "+(this.get('class'))+"' data-metatype='"+(att.metatype)+"' "+(extra)+" "+(this.show('id'))+"> " +Render.render('att_image', {attachment:this.attachment}, '')+ "<div class='att-box'> " +Render.render('att_icon', {attachment:att}, '')+ " " +Render.render('att_display_file', {attachment:att}, '')+ " " +Render.render('att_cover', {attachment:att}, '')+ " " +Render.render('att_title', {attachment:att}, '')+ " " +Render.render('att_body', {attachment:att}, '')+ " " +Render.render('att_features', {attachment:att}, '')+ " " +Render.render('att_video', {attachment:att}, '')+ " " +Render.render('att_footer', {attachment:att}, '')+ "</div> " +Render.render('att_collapse', {attachment:this.attachment}, '')+ "</div>";
	}
	
});



Render.on("att-canvas", function(){
	return "<div class='att "+(this.get('class'))+" -att-"+(this.att.metatype)+"' data-metatype='"+(this.att.metatype)+"' "+(this.show('id'))+"> <div class='att-box'> <div class='att-r'></div> "+(this.content)+" </div> " +Render.render('att_collapse', {attachment:this.att}, '')+ "</div>";
});



Render.on("att-image", function(){
	var att = this.attachment;
	if (att.metatype=='video' || att.metatype=='file'){
		return "";
	}
	
	if (att.image && att.image.length){
		return "<div class='att-image'><div class='img'><img src='"+(AP.thumb(att.image))+"'/></div></div>";
	}
	
	return "";
});


Render.on("att-icon", function(){
	var att = this.attachment;
	
	if (att.metatype=="file"){
		return "";
	}
	
	if (att.icon && att.icon.length){
		return "<div class='att-icon'><img src='"+(Client.share_url)+"/messages/"+(att.icon)+"'/></div>";
	}
	
	return "<div class='att-r'></div>";
});




Render.on("att-display-file", function(){
	var att = this.attachment;
	
	if (att.metatype!="file"){
		return "";
	}
	
	if (att.image && att.image.length){
		return "<div class='att-display-file'><span class='url' data-url='"+(att.url)+"'><img src='"+(AP.zthumb(att.image))+"'/></span></div>";
	}else{
		var icon=UI.file.icon(att.fid);
		return "<div class='att-file-icon'><img src='"+(Client.share_url)+"/32/file-"+(icon)+".png'/></div>";
	}
				
	return "";

});


Render.on("att-cover", function(){
	var att = this.attachment;
	if (!att.cover || !att.cover.length){
		return "";
	}
	
	if (att.cover_url && att.cover_url.length){
		return "<div class='att-cover'><a href='"+(att.cover_url)+"'><img src='"+(att.cover)+"'/></a></div>";
	}else{
		return "<div class='att-cover'><span><img src='"+(att.cover)+"'/></span></div>";
	}
});


Render.on("att-title", function(){
	var att = this.attachment;
	
	if (!att){
		return "<div class='att-title'><span class='a url' data-url='"+(this.url||'')+"'>"+(this.content)+"</span></div>";	
	}
	
	if (!att.title || !att.title.length){
		return "";
	}
	
	if (!att.url){
		return "<div class='att-title'>"+(att.title)+"</div>";
	}
	
	return "<div class='att-title'>"+(Base.a(att.url, att.title))+"</div>";
});


Render.on("att-body", function(){
	var att = this.attachment;
	
	if (att.text && att.text.length){
		return "<div class='att-text'>"+(att.text)+"</div>";
	}
	
	return '';
});



Render.on("att-features", function(){
	var att = this.attachment;
	
	if (att.features && att.features.length){
		return "<div class='att-features'>"+AP.render(att.features, function(e){
			return "  " +Render.render('att_feature', {feature:e}, '')+ '';
		})+`</div>`;
	}
	
	return "";
});



Render.on("att-feature", function(){
	if (!e.label){
		return "";
	}
	
	if (parseInt(e.short)){
		return "<div class='feature -s'> <div class='label ap-xdot'>"+(e.label)+"</div> <div class='value ap-xdot' title='"+(e.value)+"'>"+(e.value)+"</div> </div>";
	}
	
	return "<div class='feature -xs'> <div class='label'>"+(e.label)+"</div> <div class='value'>"+(e.value)+"</div> </div>";
});




Render.on("att-collapse", function(){
	var att = this.attachment;
	if (!att.title || !att.title.length){
		return "";
	}
	
	return "<div class='att-collapse url' data-url='::att/collapse'><span class='-ap icon-chevron-down2'></span></div>";
});


Render.on("att-video", function(){
	var att = this.attachment;
	
	if (att.metatype!='video'){
		return "";
	}
	
	if (att.image && att.image.length){
		return "<div class='att-video'> <div class='att-embed'></div> <div class='video-screen'><img src='"+(att.image)+"'/></div> <div class='video-mask'></div> <div class='play-button'> <div class='button-fix'></div> <div class='button url' data-url='::att/play' data-embed-url='"+(att.video||'')+"' data-safe-url='"+(att.url)+"'><span class='-ap icon-play_circle_filled'></span></div> </div> <div class='link-button'><a target='_blank' href='"+(att.url)+"'><span class='-ap icon-open_in_new'></span></a></div> </div>";
	}
});



Render.on("att-footer", function(){
	var att = this.attachment;
	if (!att){
		return "<div class='att-footer'>"+(this.content)+"</div>";
	}
	
	if (!att.footer || !att.footer.length){
		if (att.metatype=="file"){
			return "<div class='att-footer'>"+att.size+" KB &middot; <a href='"+att.download+"' target='_blank'>Download</a></div>";	
		}
		
		return "";
	}
	
	var icon = '';
	if (att.footer_icon && att.footer_icon.length){
		var parts=att.footer_icon.split(" ");
		if (parts.length==2){
			icon= "<span class='att-footer-icon'><span class='-ap icon-"+parts[0]+"'></span></span>";
		}else{
			icon= "<span class='att-footer-icon'><span class='-ap icon-"+parts[0]+"'></span></span>";
		}
	}


	if (!att.footer_url || !att.footer_url.length){
		return "<div class='att-footer'>"+icon+""+safe(att.footer)+"</div>";
	}
	
	return "<div class='att-footer'>"+icon+"<a href='"+att.footer_url+"' target='_blank'>"+att.footer+"</a></div>";
	
});




Render.on("att-files", function(){
	var all_images = true;
	for (var i=0; i<this.files.length; i++){
		if (this.files[i].image && parseInt(this.files[i].image)){
		}else{
			all_images = false;
			break;
		}
	}
	
	if (all_images){
		return "  " +Render.render('att_images', {images:this.files, message:this.message}, '')+ '';
	}
	
	return AP.render(this.files, function(att, index){
		var ficon = UI.file.icon(att.fid);
		
		return "<div class='att -fileatt -filedrive -idx"+(att.id)+" -with-file-icon' data-metatype='"+(att.metatype)+"'> <div class='att-box'> <div class='att-file-icon'><img src='"+(Client.share_url)+"/32/file-"+(ficon)+".png'/></div> <div class='att-title'><span class='a url' data-url='::base/file?file="+(Base64.encodeURI(att.src))+"'>"+(att.name||att.title)+"</span></div> <div class='att-footer'>"+(att.size)+"KB &middot; <a target='_blank' href='"+(att.download)+"'>Download</a></div> </div> " +Render.render('att_collapse', {attachment:att}, '')+ "</div>";
	});
});



Render.on("att-images", function(){
	var html = AP.render(this.images, function(e){
		var hd = '';
		if (e.origin){
			hd= "<div class='-img-hd url' data-url='"+(e.origin)+"' title='HD Photo'>HD</div>";
		}
		
		return "<div class='ai-thumb'> <div class='-img url' data-url='::base/file?file="+(Base64.encodeURI(e.src))+"' title='"+(e.name)+"'><img src='"+(AP.thumb(e.src,1))+"'/></div> "+(hd)+" </div>";
	});
	
	return "<div class='att-images clear-fix'> "+(html)+" </div>";
});


Render.on("att-base-video", function(){
	return "  " +Render.render('att_canvas', {att:this.att}, '' +Render.render('att_title', {url:this.att.url}, ""+(this.att.name)+"")+ "<div class='att-video'> <div class='att-embed'></div> <div class='video-screen'><img src='"+(this.att.image)+"'/></div> <div class='video-mask'></div> <div class='play-button'> <div class='button-fix'></div> <div class='button url' data-url='::att/play' data-embed-url='"+(this.att.embed)+"?autoplay=1'><span class='-ap icon-play_circle_filled'></span></div> </div> <div class='link-button'><a target='_blank' href='"+(this.att.url)+"'><span class='-ap icon-open_in_new'></span></a></div> </div>")+ '';
});



var BaseFile=new function __BaseFile(){
	this.getPage=function(page_id, callback){
		if (!Channel.channel){
			return;
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/file/page", {channel_id: Channel.channel.id, page: page_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.files);
		});
	};
	
	
	this.open=function(file_id){
		this.get(file_id, function(file){
			BaseFile.display(file);
		});
	};
	
	
	this.get=function(file_id, callback){
		UI.ajaxShow();
		AP.post(Message.api+"api/message/file/get", {file_id: file_id}, function(code){
			UI.ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.file);
		});
	};
	
	

	this.url=function(file){
		return "r/file/"+file.channel_id+"/"+file.id;
	};
	
	
	this.furl=function(folder){
		if (AP.data.isString(folder)){
			return "r/folder/"+Channel.channel.id+"/"+folder;
		}
		
		return "r/folder/"+folder.channel_id+"/"+folder.id;
	};
	
	
	this.initUploadButton=function(btn_id, channel_id, folder_id){
		if (!folder_id){
			folder_id=0;
		}
		
		$(btn_id).data("action", Message.api+"api/message/file/upload");
		
		AP.uploadable(btn_id, {
	        preview: 0,
	        action: "upload_url",
	        name: "file",
	        data: {channel_id: channel_id, folder_id: folder_id}
	    }, function(code){
	        AP.xRefresh();
	    });
	};
	
	this.preview = function(id) {
	    BaseFile.get(id, function(file) {
	        if(file.metatype == "upload") {
	            file.src = file.url;
	        }
	        
	        FileX.quickPreview(file);
	    });
	};
	
	this.manageOptions = function(obj) {
        var actions = [];
        var uid = $(obj).parent().data("uid");
        
        if(uid == Client.viewer.id || Me.isOwner(Client.pageData.project) || Me.isSystemAdmin()) {
            actions.push({label: "<span class='text-error'>XoĂ¡ tá»‡p tin nĂ y</span>", sublabel: "", icon: "icon-cloud_off", action: function() {
                BaseFile.removeFile($(obj).parent().data("fid"));
            }});
            
            return Context.menu(obj, {top: 30, left: -250, menu: actions});
        }
    };
    
    this.removeFile = function(fid) {
        AP.confirm("Báº¡n cĂ³ cháº¯c muá»‘n xoĂ¡ tá»‡p tin nĂ y?", function() {
            UI.ajaxShow();
            AP.post(Message.api + "api/message/file/remove", {channel_id: Channel.channel.id, id: fid, hid: Client.pageData.project.hid}, function(code){
                UI.ajaxHide();
                if (!code.good()){
                    return AP.alertError(code.message);
                }
                
                UI.flash("ÄĂ£ xoĂ¡ tá»‡p tin...");
                
                AP.xRefresh();
            });
        });
    };
};


BaseFile.display=function(file){
	FileX.quickPreview(file.url);
};



var Sticker = new function __Sticker(){
	this.sets={};
	this.num_sets=0;
	
	this.init=function(channel){
		if ($("#msg-stickers-"+channel.id).hasClass("__sinit")){
			return;
		}
		
		$("#msg-stickers-"+channel.id).addClass("__sinit");
		$("#msg-form-"+channel.id+" .channel-smiley-input").click(function(){
			var c=getChannel(this);
			if ($("#msg-stickers-"+channel.id).is(":visible")){
				Sticker.hideSelections(c);	
			}else{
				Sticker.showSelections(c);
			}
		});
		
		$("#msg-form-"+channel.id+" .smiley-closable").click(function(){
			var c=getChannel(this);
			Sticker.hideSelections(c);
		});
		
		this.listStickerSets(channel);
		Sticker.set.display(channel, "popular");
		
		Layout.scrollable("#msg-stickers-"+channel.id+" .msg-selection-canvas");
	};
	
	
	this.showSelections=function(channel){
		$("#msg-stickers-"+channel.id).show();
		$("#msg-stickers-"+channel.id).parent().addClass("active");
	};
	
	this.hideSelections=function(channel){
		$("#msg-stickers-"+channel.id).hide();
		$("#msg-stickers-"+channel.id).parent().removeClass("active");
	};
	
	this.send=function(ref, sticker_key, sticker_src){
		var channel=getChannel(ref);
		this.hideSelections(channel);
		return Message.sender.sticker(channel, sticker_key, sticker_src);
	};
	
	
	this.load=function(key, configs){
		configs.key=key;
		configs.index=this.num_sets;
		
		this.sets[key]=configs;
		this.num_sets++;
	};
	
	
	this.getConfig=function(key){
		if (this.sets[key]){
			return this.sets[key];
		}
		
		return null;
	};
	
	
	this.listStickerSets=function(channel){
		var html="";
		var index=0;
		for (var key in this.sets){
			var e=this.sets[key];
			html+= "<div class='item ap-xdot' data-index='"+index+"' data-set='"+e.key+"' onclick=\"Sticker.set.choose(this, '"+e.key+"')\">"+e.name+"</div>";
			index++;
		}
		
		$("#msg-stickers-"+channel.id+" .sticker-set-slider").html(html);
	};
	
	this.countSets=function(){
		return this.num_sets;
	};
	
	function getChannel(ref){
		return $(ref).closest(".msg-channel").data("channel");
	};
};




Sticker.set=new function __StickerSet(){
	this.cur=0;
	
	this.display=function(channel, setkey){
		var config=Sticker.getConfig(setkey);
		var set=this.load(config);
		this.displaySelection(channel, set);
	};
	
	this.load=function(config){
		if (config===null){
			config="popular";
		}
		
		if (AP.data.isString(config)){
			config=Sticker.getConfig(config);
		}
		var set={};
		set.config=config;
		set.name=config.name;
		set.key=config.key;
		set.index=config.index;
		set.items=getItems(config);
		return set;
	};
	
	this.displaySelection=function(channel, set){
		var html= AP.render(set.items, function(e){
			return "<div class='item' onclick=\"Sticker.send(this, '"+e.key+"','"+e.src+"');\"><div class='img'><img src='"+e.src+"'/></div></div>";
		});
		
		$("#msg-stickers-"+channel.id+" .msg-sticker-selections").html(html);
		
		$("#msg-stickers-"+channel.id+" .sticker-set-slider .item").each(function(){
			if ($(this).data("set")==set.key){
				$(this).addClass("active");
			}else{
				$(this).removeClass("active");
			}
		})
	};
	
	
	
	this.choose=function(ref, setkey){
		var channel=getChannel(ref);
		var set=this.load(setkey);
		this.displaySelection(channel, set);
		refocus(channel, set);
	};
	
	
	this.move=function(ref, dir){
		var channel=null;
		if (ref.id && ref.token){
			channel=ref;
		}else{
			channel=getChannel(ref);
		}
		
		this.cur+=dir;
		if (this.cur >= Sticker.countSets()-4){
			this.cur=Sticker.countSets()-5;
		}
		if (this.cur<0){
			this.cur=0;
		}
		
		reposition(channel, this.cur);
	};
	
	function getChannel(ref){
		return $(ref).closest(".msg-channel").data("channel");
	};
	
	function refocus(channel, set){
		var cur=Sticker.set.cur;
		
		var index=set.index;
		if (index <= cur){
			if (index>0){
				Sticker.set.move(channel, -1);
			}else{
				reposition(channel, index);
			}
		}else{
			if (index >= cur+3 && index < Sticker.countSets()-2){
				Sticker.set.move(channel, 1);
			}
		}
	};
	
	
	function reposition(channel, index){
		if (index < Sticker.countSets()-4){
			Sticker.set.cur=index;
			var left=index * 80;
			$("#msg-stickers-"+channel.id+" .sticker-set-slider").animate({"left": -left}, 200, function(){});	
		}
	};
	
	
	function getItems(config){
		var items=[];
		
		for (var i=parseInt(config.start); i<=parseInt(config.end); i++){
			var src="png";
			if (config.file=="gif"){
				src="gif";
			}
			items.push({
				type: "image",
				key: config.key+"-"+i+"."+src,
				src: Client.share_url+"/stickers/"+config.key+"/"+i+"."+src
			});
		}
		
		return items;
	};
};


Sticker.load("special",{
	"name":"Special",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":68,
});


Sticker.load("popular",{
	"name":"Popular",
	"type":"popular",
	"file":"png",
	"start":1,
	"end":130,
});



Sticker.load("tuzki",{
	"name":"Tuzki",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":15,
});


Sticker.load("puppy",{
	"name":"Puppy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});



Sticker.load("kitty",{
	"name":"Kitty",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});



Sticker.load("cute",{
	"name":"Cute",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});





Sticker.load("cotton",{
	"name":"Candy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});





Sticker.load("nerd",{
	"name":"Nerdy",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":15,
});



Sticker.load("bunny",{
	"name":"Bunny",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":36,
});


Sticker.load("rabbit",{
	"name":"Rabbit",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":29,
});



Sticker.load("princess",{
	"name":"Princess",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":40,
});



Sticker.load("owl",{
	"name":"Owla",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":24,
});




Sticker.load("pancake",{
	"name":"Pancake",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":17,
});



Sticker.load("bigeye",{
	"name":"Big Eyes",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":16,
});


Sticker.load("alien",{
	"name":"Alien",
	"type":"simple",
	"file":"gif",
	"start":1,
	"end":43,
});






Sticker.load("fatcat",{
	"name":"Fatcat",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":36,
});



Sticker.load("snoppy",{
	"name":"Snoppy",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":28,
});


Sticker.load("jellyfish",{
	"name":"Jellyfish",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":40,
});


Sticker.load("ducky",{
	"name":"Ducky",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":32,
});



Sticker.load("meow",{
	"name":"Meow",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":26,
});


Sticker.load("potato",{
	"name":"Potato",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":50,
});


Sticker.load("troll",{
	"name":"Meme",
	"type":"simple",
	"file":"png",
	"start":1,
	"end":16,
});






Channel.poll = new function __ChannelPool(){
	
	this.fromContext = function(id){
		if (!Client.pageData.polls){
			return null;
		}
		
		return ARR.findObj(Client.pageData.polls, id);
	};
	
	
	/**
	 * @desc Cache a poll
	 */
	this.cache = function(poll){
		if (!Client.pageData.polls){
			Client.pageData.polls = [];
		}
		
		Client.pageData.polls = ARR.insertByID(Client.pageData.polls, poll);
	};
	
	
	/**
	 * @desc Get action managed
	 */
	this.am = function(poll){
		var is_managed = managed();
		
		var am = new ActionManager();
		if (safeEquals(poll.user_id, Client.viewer.id) || poll.managed || is_managed){
			am.add({
				label: "Edit poll info",
				url: ":poll/"+(poll.id)+"/edit"
			});
			
			am.add({
				label: "Edit poll options",
				url: ":poll/"+(poll.id)+"/edit.options"
			});
			
			am.add({
				label: "Add another option",
				url: ":poll/"+(poll.id)+"/add.option"
			});
		}else{
			if (poll.config.allow_added && parseInt(poll.config.allow_added)){
				am.add({
					label: "Add another option",
					url: ":poll/"+(poll.id)+"/add.option"
				});
			}
		}
		
		return am;
	};
	
};


Channel.poll.form = new function __ChannelPollForm(){
	
	/**
	 * @desc Create a new poll
	 */
	this.create = function(channel){
		if (!channel){
			channel = Channel.channel;
		}
		
		var rows = [
			{label: "Poll name", placeholder: "Poll name", name: "name", style: "-big"},
			{label: "Poll options", placeholder: "Option", name: "options", type:"input-lines"},
			{type: "sep", label: "Settings"},
			{placeholder: "Multiple answers per user (MA)", type: "checkbox", name: "multi"},
			{placeholder: "Enable voting deadline", type: "checkbox", name: "has_etime"},
			{label: "Voting deadline", type: "datetime", name: "etime"},
			{placeholder: "Enable started time", type: "checkbox", name: "has_stime"},
			{label: "Voting started time", type: "datetime", name: "stime"},
			{type: "open", label: "Advanced settings", open: 1},
			{placeholder: "Allow users to update their votings after voted", type: "checkbox", name: "allow_update"},
			{placeholder: "Allow users to add new options to the voting", type: "checkbox", name: "allow_added"},
			{placeholder: "Limited answers for multiple-answers voting", type: "checkbox", name: "has_limit"},
			{label: "Limited number of answers", type: "select", name: "limited_answers", options: range(1,10)},
			{type: "close"}
		];
		
		Form.v2({
			title: "Create a poll",
			action: Message.api+"api/message/poll/create",
			data: {channel_id: channel.id, topic_id: Message.sender.topic()},
			rows: rows,
			width: 600,
			render: function(){
				autoRender(this)
			},
			buttons: Form.button(":submit", function(){
			}).button(":cancel")
		});
	};
	
	
	/**
	 * @desc Edit a poll
	 */
	this.edit = function(poll){
		var rows = [
			{label: "Poll name", placeholder: "Poll name", name: "name", style: "-big", value: poll.name},
			{type: "sep", label: "Settings"},
			{placeholder: "Multiple answers per user (MA)", type: "checkbox", name: "multi", value: poll.config.multi||0},
			{placeholder: "Enable voting deadline", type: "checkbox", name: "has_etime", value: poll.config.has_etime||0},
			{label: "Voting deadline", type: "datetime", name: "etime", value: poll.config.etime||null},
			{placeholder: "Enable started time", type: "checkbox", name: "has_stime", value: poll.config.has_stime||0},
			{label: "Voting started time", type: "datetime", name: "stime", value: poll.config.stime||null},
			{type: "open", label: "Advanced settings", open: 1},
			{placeholder: "Allow users to update their votings after voted", type: "checkbox", name: "allow_update", value: poll.config.allow_update||0},
			{placeholder: "Allow users to add new options to the voting", type: "checkbox", name: "allow_added", value: poll.config.allow_added||0},
			{placeholder: "Limited answers for multiple-answers voting", type: "checkbox", name: "has_limit", value: poll.config.has_limit||0},
			{label: "Limited number of answers", type: "select", name: "limited_answers", options: range(1,10), value: poll.config.limited_answers||1},
			{type: "close"}
		];
		
		Form.v2({
			title: "Edit the edit",
			action: Message.api+"api/message/poll/edit",
			data: {channel_id: Channel.channel.id, id: poll.id},
			rows: rows,
			width: 600,
			render: function(){
				autoRender(this)
			},
			buttons: Form.button(":submit", function(){
			}).button(":cancel")
		});
	};
	
	
	/**
	 * @desc Add more options
	 */
	this.addOption = function(poll){
		var rows = [
			{label: "Poll name", style: "-big", type: "fake", value: poll.name},
			{label: "Additional options", placeholder: "Option", name: "options", type:"input-lines"},
		];
		
		Form.v2({
			title: "Add more options",
			action: Message.api+"api/message/poll/options",
			data: {channel_id: Channel.channel.id, id: poll.id},
			rows: rows,
			width: 600,
			render: function(){
				autoRender(this)
			},
			buttons: Form.button(":submit", function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.closeAllDialogs();
			}).button(":cancel")
		});
	};
	
	

	/**
	 * @desc Edit a single option
	 */
	this.editOption = function(poll, opt_id){
		var opt = ARR.findObj(poll.cached_options, opt_id);
		if (!opt){
			return false;
		}
		
		
		var rows = [
			{label: "Poll name", style: "-big", type: "fake", value: poll.name},
			{label: "Option", placeholder: "Option", name: "option", value: opt.name},
		];
		
		Form.v2({
			title: "Edit a single option",
			action: Message.api+"api/message/poll/option",
			data: {channel_id: Channel.channel.id, id: poll.id, opt_id: opt.id},
			rows: rows,
			width: 500,
			render: function(){
				autoRender(this)
			},
			buttons: Form.button(":submit", function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.closeAllDialogs();
			}).button(":cancel")
		});
	}
	
	
	/**
	 * @desc Edit a single option
	 */
	this.removeOption = function(poll, opt_id){
		var opt = ARR.findObj(poll.cached_options, opt_id);
		if (!opt){
			return false;
		}
		
		AP.confirm("Please confirm to remove this option - linked votes will be excluded.", function(){
			AP.post(Message.api+"api/message/poll/option.remove", {id: poll.id, channel_id: Channel.channel.id, opt_id: opt.id}, function(code){
				if (!code.good()){
					return AP.alertError(code.message);
				}
				
				AP.closeAllDialogs();
				// Done
			});
		});
		
	};
	
	
	
	/**
	 * @desc Edit the poll options
	 */
	this.editOptions = function(poll){
		var dx = "  " +Render.render('dialog', {width: "600" , title: "Edit poll options" }, "<div id='js-poll-options'></div>")+ '';
		
		var html = AP.render(poll.cached_options, function(opt){
			return "  " +Render.render('list_item', {icon: "form_checkbox" , data_id:opt.id, style: "padding-right:40px" }, '' +Render.render('title', {thick:1}, '' +Render.render('text_ie', {value:opt.name, action: "api/message/poll/option.edit?id="+(poll.id)+"&opt_id="+(opt.id)+"" }, '')+ '')+ " " +Render.render('info', {}, "Voted "+(opt.votes.length)+" times")+ " " +Render.render('side', {}, '' +Render.render('button_dd', {}, '' +Render.render('cmenu', {}, '' +Render.render('cmenu_item', {label: "Chá»‰nh sá»­a" , url: ":poll/"+(poll.id)+"/edit.option?opt="+(opt.id)+"" }, '')+ " " +Render.render('cmenu_item', {label: "XĂ³a" , url: ":poll/"+(poll.id)+"/remove.option?opt="+(opt.id)+"" }, '')+ '')+ '')+ '')+ '')+ '';
		});
		
		
		html = "  " +Render.render('list', {sortable: "api/message/poll/sortable/"+(poll.id)+"" , borderless:1}, '' +Render.render('list_body', {}, ""+(html)+"")+ " " +Render.render('list_footer', {}, '' +Render.render('side', {}, '' +Render.render('button', {icon: "ap plus2" , label: "Add another option" , url: ":poll/"+(poll.id)+"/add.option" , borderless:1}, '')+ '')+ "Hint: You can drag to order options")+ '')+ '';
		
		$("#js-poll-options").html(html);
		Render.finish();
		AP.dialog.get("#js-poll-options").balance();
		
	};
	
	
	
	/**
	 * @desc Vote of a poll
	 */
	this.voteNow = function(opts, ref){
		var answers = getAnswers(ref);
		if (!answers.length){
			return AP.alertError("Please vote first");
		}
		
		$(ref).closest(".base-poll").ajaxShow();
		
		AP.post(Message.api+"api/message/poll/vote", {
			id: opts.id,
			msgid: opts.msgid,
			answers: answers.join(",")
		}, function(code){
			$(ref).closest(".base-poll").ajaxHide();
			
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			$(ref).closest(".base-poll").find(".poll-main").removeClass("-show-voting");
			Base.pref().clear("revote");
		});
	};
	
	
	/**
	 * @desc Cache to support live update
	 */
	this.cacheVoted = function(id, ref){
		var answers = getAnswers(ref);
		Base.pref().set("poll", {
			id: id,
			voted: answers  
		});
	};
	
	
	function autoRender(f){
		f.find("has_stime").on("change", function(){
			if ($(this).is(":checked")){
				f.findRow("stime-date").show();
			}else{
				f.findRow("stime-date").hide();
			}
		}).trigger("change");
		
		f.find("has_etime").on("change", function(){
			if ($(this).is(":checked")){
				f.findRow("etime-date").show();
			}else{
				f.findRow("etime-date").hide();
			}
		}).trigger("change");
		
		f.find("has_limit").on("change", function(){
			if ($(this).is(":checked")){
				f.findRow("limited_answers").show();
			}else{
				f.findRow("limited_answers").hide();
			}
		}).trigger("change");
	};
	
	
	/**
	 * @desc Getting the answers
	 */
	function getAnswers(ref){
		var r = [];
		var $box = $(ref).closest(".base-poll");
		$box.find(".poll-opts.-voting .poll-opt.-voted").each(function(){
			r.push($(this).data("id"));
		});
		
		return r;
	};
	
};


Channel.poll.ui = new function __ChannelPollUI(){
	this.whovote = function(vote){
		var user = People.get(vote.user_id)
		
		return "  " +Render.render('list_item', {avatar:AP.thumb(user.gavatar)}, '' +Render.render('title', {}, ""+(user.name)+"")+ " " +Render.render('info', {}, "Voted " +Render.render('text_ago', {ts:vote.since}, '')+ '')+ '')+ '';
	};
};


Render.on("att-poll", function(){
	var __ri = {};
	var counter =0;
	for (var key in this.poll.cached_votes){
		counter++;
		var vote = this.poll.cached_votes[key];
		
		for (var j=0; j<vote.votes.length; j++){
			if (__ri[vote.votes[j]]){
				__ri[vote.votes[j]].push(vote);
			}else{
				__ri[vote.votes[j]] = [vote];
			}
		}
	}
	
	this.poll.num_votes = counter;
	var me = this.poll.cached_votes["u"+Client.viewer.id] || null;
	
	this.poll.me = me;
	
	for (var i=0; i<this.poll.cached_options.length; i++){
		this.poll.cached_options[i].votes = [];
		if (__ri[this.poll.cached_options[i].id]){
			this.poll.cached_options[i].votes = __ri[this.poll.cached_options[i].id];
		}
		
		if (me && ARR.contain(me.votes, this.poll.cached_options[i].id)){
			this.poll.cached_options[i].voted = 1;
		}else{
			this.poll.cached_options[i].voted = 0;
		}
	}
	
	
	Channel.poll.cache(this.poll);
	
	return "  " +Render.render('att_canvas', {att:this.poll, _class: "js-poll-"+(this.poll.id)+"" }, '' +Render.render('poll', {poll:this.poll, message:this.message}, '')+ '')+ '';
});




Render.on("poll", function(){
	var now = AP.time.now();
	var config = this.poll.config;
	var poll_inactive = false;
	
	var poll_dt_info = [];
	if (parseInt(config.has_stime)){
		if (parseInt(config.stime)>now){
			poll_dt_info.push("Poll is not started");
			poll_dt_info.push("Scheduled at " +Render.render('text_datetime', {}, ""+(config.etime)+"")+ '');
			poll_inactive = true;
		}else{
			if (parseInt(config.has_etime)){
				if (parseInt(config.etime) < now){
					poll_dt_info.push("Poll closed at " +Render.render('text_datetime', {}, ""+(config.etime)+"")+ '');
					poll_inactive = true;
				}else{
					poll_dt_info.push("Poll duration " +Render.render('text_datetime_range', {_from:config.stime, to:config.etime}, '')+ '');
					this.addClass("active-poll");
				}
			}else{
				poll_dt_info.push("Poll started at " +Render.render('text_datetime', {}, ""+(config.stime)+"")+ '');
				this.addClass("active-poll");
			}
		}
	}else{
		if (parseInt(config.has_etime)){
			if (parseInt(config.etime) < now){
				poll_dt_info.push("Poll closed at " +Render.render('text_datetime', {}, ""+(config.etime)+"")+ '');
				poll_inactive = true;
			}else{
				poll_dt_info.push("Poll deadline " +Render.render('text_datetime', {}, ""+(config.etime)+"")+ '');
				this.addClass("active-poll");
			}
		}
	}
	
	var time_info = poll_dt_info.join(' &middot; ');
	
	if (time_info){
		time_info+=" &middot; ";
	}
	
	if (this.dark || Client.darkmode){
		this.addClass("-dark");
	}
	
	var results = "  " +Render.render('poll_opts', {intent: "display-results" , poll:this.poll, message:this.message}, '')+ '';
	var votings = "  " +Render.render('poll_opts', {intent: "voting" , poll:this.poll, message:this.message}, '')+ '';
	var revote_cta = '';
	
	if (this.poll.me){
		if (config.allow_update && parseInt(config.allow_update)){
			votings = "  " +Render.render('poll_opts', {intent: "revoting" , poll:this.poll, message:this.message}, '')+ '';
			revote_cta = "&nbsp;&middot; <span class='url' data-url=':poll/"+(this.poll.id)+"/revote'>Revote</span>";
		}else{
			votings = '';
		}
	}else{
		if (poll_inactive){
		}else{
			results = '';
		}
	}
	
	if (poll_inactive){
		votings = '';
		revote_cta = '';
	}
	
	var main = '';
	if (!votings){
		main = results;
	}else if (!results){
		main = votings;
	}else{
		var sv = safeEquals(Base.pref().get("revote")||0, this.poll.id);
		
		main = "<div class='poll-main "+(sv?'-show-voting':'')+"'> "+(results)+" "+(votings)+" </div>";
	}
	
	// My action, with revote
	var me = "You have not voted";
	if (this.poll.me){
		me = "You voted " +Render.render('text_ago', {ts:this.poll.me.since}, '')+ "</base-text-icon>"+(revote_cta)+"";
	}
	
	var dd = '';
	
	return "<div class='base-poll js-poll-"+(this.id)+" "+(this.get('class'))+"'> <div class='poll-header'> " +Render.render('title', {url: ":message/"+(this.message.id)+"/show" }, ""+(this.poll.name)+"")+ " " +Render.render('info', {}, '' +Render.render('icon', {icon: "edge flag" , _class: "-icon-info" }, '')+ ""+(this.poll.num_votes)+" votes &middot;&nbsp; "+(me)+"")+ "</div> "+(main)+" <div class='poll-footer'> "+(time_info)+" Created " +Render.render('text_ago', {ts:this.poll.since}, '')+ " Theo " +Render.render('user', {user_id:this.poll.user_id, name_only:1}, '')+ " "+(dd)+" </div> </div>";
});


Render.on("poll-opts", function(){
	if (!Render.acl(this)){
		return null;
	}
	
	var that = this;
	
	var opts = AP.render(this.poll.cached_options, function(e){
		return "  " +Render.render('poll_opt', {config:that.poll.config, poll:that.poll, option:e, intent:that.intent}, '')+ '';
	});
	
	var voting = '';
	var answers_limit = "You can select up to "+(this.poll.config.limited_answers||0)+" answers.";
	if (!this.poll.config.has_limit || !parseInt(this.poll.config.has_limit)){
		answers_limit = '';
	}
	
	if (this.intent == "voting"){
		var revote_opt = '';
		if (!this.poll.config.allow_update || !parseInt(this.poll.config.allow_update)){
			revote_opt = "Revote is NOT allowed.";
		}
		
		voting = "<div class='poll-action-container'> <div class='poll-vote url' data-url=':poll/"+(this.poll.id)+"/submit?msgid="+(this.message.id)+"'>Submit my vote</div> <div class='poll-vote-hint'>"+(answers_limit)+" "+(revote_opt)+"</div> </div>";
		
		this.addClass("-voting");
	}else if (this.intent == "revoting"){
		voting = "<div class='poll-action-container'> <div class='poll-vote url' data-url=':poll/"+(this.poll.id)+"/submit?msgid="+(this.message.id)+"'>Revote</div> <div class='poll-vote-cancel url' data-url=':poll/"+(this.poll.id)+"/revote-cancel'>Há»§y</div> <div class='poll-vote-hint'>"+(answers_limit)+"</div> </div>";
		
		this.addClass("-voting");
	}else{
		this.addClass("-results");
	}
	
	return "<div class='poll-opts "+(this.get('class'))+"'> <div class='opts'>"+(opts)+"</div> "+(voting)+" </div>";
	
});



Render.on("poll-opt", function(){
	var ma = 0;
	if (this.config.multi && parseInt(this.config.multi)){
		this.addClass("-ma");
		ma=1;
	}else{
		this.addClass("-sa");
	}
	
	var label = 'vote';
	if (this.option.votes.length>=2){
		label = 'votes';
	}
	
	var p = 0;
	if (this.poll.num_votes > 0){
		p = this.option.votes.length*100.0/this.poll.num_votes;
	}
	
	var users = ARR.extract(this.option.votes, "user_id");
	var key = "u"+Client.viewer.id;
	
	var voted = this.option.voted;
	
	if (this.intent == "voting" || this.intent == "revoting"){
		
		var saved = Base.pref().get("poll");
		if (saved && safeEquals(saved.id, this.poll.id)){
			voted = 0;
			
			if (ARR.contain(saved.voted, this.option.id)){
				voted = 1;
			}else{
				voted = 0;
			}
		}
	}
	
	
	if (voted){
		this.addClass("-voted");
	}else{
		this.addClass("-nv");
	}
	
	var url = ":poll/"+(this.poll.id)+"/who-vote?opt="+(this.option.id)+"";
	
	if (this.intent == "voting" || this.intent == "revoting"){
		this.addClass("-votable");
		 url=":poll/"+(this.poll.id)+"/vote-me?ma="+(ma)+""
	}else{
		this.addClass("-vote-results");
	}
	
	
	return "<div class='poll-opt "+(this.get('class'))+"' data-id='"+(this.option.id)+"' title='"+(this.option.name)+"'> <div class='po-percentage'> <div class='pop-fill' style='width:"+(p)+"%'></div> </div> <div class='po-main url' data-url='"+(url)+"'> <div class='po-checkbox'></div> <div class='po-content'> "+(this.option.name)+" </div> <div class='po-count'> "+(this.option.votes.length)+" "+(label)+" " +Render.render('tooltip', {width: "100" }, ""+(p.toFixed(1))+"%")+ "</div> </div> <div class='po-voted'> " +Render.render('avatars', {users:users, limit: "5" , sm:1}, '')+ "</div> </div>";
});


Rewrite.on(":poll/{id}/{action}", function(qs){
	if (qs.action == "vote-me"){
		if (qs.ma && parseInt(qs.ma)){
			$(this).parent().toggleClass("-voted");	
		}else{
			$(this).parent().addClass("-voted");
			$(this).parent().siblings().removeClass("-voted");
		}
		
		Channel.poll.form.cacheVoted(qs.id, this);
	}
	
	if (qs.action == "revote"){
		Base.pref().set("revote", qs.id);
		
		var $canvas = $(this).closest(".base-poll");
		$canvas.ajaxFake(function(){
			return $canvas.find(".poll-main").addClass("-show-voting");	
		});
		
	}
	
	if (qs.action == "revote-cancel"){
		Base.pref().set("revote", 0);
		$(this).closest(".base-poll").ajaxFake();
		return $(this).closest(".base-poll").find(".poll-main").removeClass("-show-voting");
	}
	
	if (qs.action == "who-vote"){
		var poll = Channel.poll.fromContext(qs.id);
		if (!poll){
			return;
		}
		
		var opt = ARR.findObj(poll.cached_options, qs.opt);
		if (!opt){
			return;
		}
		
		return "  " +Render.render('users', {users:opt.votes, title: "People who vote for "+(opt.name)+"" , render:Channel.poll.ui.whovote, dialog:1}, '')+ '';
	}
	
	if (qs.action == "edit"){
		$(this).closest(".-cmenuw-active").removeClass("active");
		
		var poll = Channel.poll.fromContext(qs.id);
		if (!poll){
			return;
		}
		
		return Channel.poll.form.edit(poll);
	}
	
	
	if (qs.action == "edit.options"){
		$(this).closest(".-cmenuw-active").removeClass("active");
		
		var poll = Channel.poll.fromContext(qs.id);
		if (!poll){
			return;
		}
		
		return Channel.poll.form.editOptions(poll);
	}
	
	if (qs.action == "add.option"){
		$(this).closest(".-cmenuw-active").removeClass("active");
		
		var poll = Channel.poll.fromContext(qs.id);
		if (!poll){
			return;
		}
		
		return Channel.poll.form.addOption(poll);
	}
	
	
	if (qs.action == "edit.option"){
		var poll = Channel.poll.fromContext(qs.id);
		if (!poll){
			return;
		}
		
		return Channel.poll.form.editOption(poll, qs.opt);
	}
	
	
	if (qs.action == "remove.option"){
		var poll = Channel.poll.fromContext(qs.id);
		if (!poll){
			return;
		}
		
		return Channel.poll.form.removeOption(poll, qs.opt);
	}
	
	if (qs.action == "submit"){
		return Channel.poll.form.voteNow(qs, this);
	}
	
});



Render.on("att-location", function(){
	var zoom = 16;
	var mapkey = "AIzaSyB-x7WPdKyAbt9AerFwfNu3BAtu5H7G5cg";
	if (Client.env == 1) {
		mapkey = "AIzaSyDyHJT_a9lY24QcCcfG3ssyvSix8itB85c";
	}
	var gmap_url = "https://maps.google.com/maps?q=loc:"+(this.att.lat)+","+(this.att.lng)+"";
	var image_url = "https://maps.googleapis.com/maps/api/staticmap?center="+(this.att.lat)+","+(this.att.lng)+"&zoom="+(zoom)+"&size=600x300&maptype=roadmap&markers=color:blue%7C"+(this.att.lat)+","+(this.att.lng)+"&key="+(mapkey)+"";
	
	return "  " +Render.render('att_canvas', {att:this.att}, "<div class='att-location-static-map'> <a href='"+(gmap_url)+"' target='blank'><img src='"+(image_url)+"'/></a> </div> " +Render.render('att_title', {url:gmap_url}, ""+(this.att.name)+"")+ '')+ '';
});









AP.rewrite('r/messages/([0-9]+)$', 'messages?c=$1', function(qs){
	Channel.open(qs.c, {intent: "notification"}, function(){
		$.log("Please focusing on ... "+qs.c);
	});
});


AP.rewrite('messages/([0-9]+)/([0-9]+)', 'messages?c=$1&msg=$2', function(qs){
	Channel.open(qs.c, {intent: "panel"}, function(){
		$.log("On notification  ... "+qs.msg);
	});
});


AP.rewrite('call/([a-zA-Z0-9\-]+)', 'call?code=$1', function(qs){
	Message.call.display(qs.code);
	window.open(Base.domain("message")+"/videocall/"+qs.code,"","width=900,height=500");
});




AP.rewrite('r/files/([a-zA-Z0-9]+)', 'messages/files?c=$1', function(qs){
});


AP.rewrite('r/folder/([a-zA-Z0-9]+)/([a-zA-Z0-9]+)', 'messages/folder?c=$1&folder=$2', function(qs){
	$.log(qs);
	// TODO: display folder
});


AP.rewrite('r/file/([a-zA-Z0-9]+)/([a-zA-Z0-9]+)', 'messages/file?c=$1&file=$2', function(qs){
	BaseFile.open(qs.file);
//	Channel.open(qs.c, function(){
//		BaseFile.open(qs.file);
//	});
});




Rewrite.on(":message/{id}/{action}", function(qs){
	if (qs.action == "reply"){
		return MForm.reply.set($(this).closest(".js-message"), qs.id);
	}
	
	if (qs.action == "forward"){
		var $box=$(this).closest(".message").find(".att").first();
		var file={id: $box.data("file_id"), name: $box.data("file_name")};
		return Message.forwarder.file(file);
	}

	if (qs.action == "forward.msg") {
		return Message.forwarder.text(qs.id);
	}
	
	if (qs.action == "show"){
		return Message.display.display(qs.id);
	}
	
	if (qs.action == "display-close"){
		return Message.display.close();
	}
	
	if (qs.action == "remove"){
		return Message.form.remove(qs.id);
	}
	
	if (qs.action == "reply"){
		return MForm.reply.set($(this));
	}
	
	if (qs.action == "pin"){
		return Message.form.pin(qs.channel, qs.id);
	}
	
	if (qs.action == "bookmark"){
		return Message.form.toggleBookmark(qs.channel, qs.id);
	}
	
	
	if (qs.action == "prev"){
		return Message.full.prev(this, qs);
	}
	
	if (qs.action == "next"){
		return Message.full.next(this, qs);
	}
	
});



Rewrite.on("::att/{action}", function(qs){
	if (qs.action == "collapse"){
		var $att=$(this).closest(".att");
		if ($att.hasClass("-collapsed")){
			$(".att-image", $att).slideDown(300);
			$(".att-text", $att).slideDown(300);
			$(".att-footer", $att).slideDown(300);
			$(".att-video", $att).slideDown(300);
			$(".att-display-file", $att).slideDown(300);
			$att.removeClass("-collapsed");
		}else{
			// $att.toggleClass("-collapsed");
			$(".att-image", $att).slideUp(300);
			$(".att-text", $att).slideUp(300);
			$(".att-footer", $att).slideUp(300);
			$(".att-video", $att).slideUp(300);
			$(".att-display-file", $att).slideUp(300);
			$att.addClass("-collapsed");
		}
	}
	
	if (qs.action == "play"){
		var embed_url = $(this).data("embed-url");
		
		if (embed_url){
			$(this).closest(".att-video").find(".att-embed").show().html("<div class='real-video-player'><iframe frameborder='0' width='100%' height='100%' src='"+(embed_url)+"'/></div>");
		}else{
			AP.toURL($(this).data("safe-url"));
		}
	}
});








$("#channel-canvas").delegate(".msg-tag", 'click',function(){
	var val=$(this).text();
	Channel.search.search({
		type: "tag",
		q:  val
	});
});



Message.API=new function __MessageLinkingAPI(){
	this.__channels=null;
	
	/**
	 * @desc Linking a particular system/network
	 */
	this.dialog=function(system){
		var base=system.base;
		var selected=[];
		if (base && base.channels){
			selected=AP.select(base.channels, function(e){
				return e.id;
			});
		}
		

		
		this.getChannels(function(channels){
			var actions=[];
			for (var i=0; i<channels.length; i++){
				var c=channels[i];
				actions.push({
					label: c.name,
					value: c.id,
					id: c.id,
					channel: c
				});
			}
			
			AP.selectActions(actions, function(cs){
				var ids=AP.select(cs, function(e){
					return e.channel.id;
				});
				
				if (!ids.length){
					return;
				}
				
				Base.linking.link(system, ids);
			},{
				search: 1,
				selected: selected
			});
		});
		
	};
	
	
	
	this.link=function(system, ids){
		var links=ids;
		if (AP.data.isArray(ids)){
			links=ids.join(",");
		}
		
		UI.ajaxShow();
		AP.post("api/base/link", {sysid: system.id, systoken: system.token, links: links}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Link successfully", function(){
				AP.refresh();
			});
		})
	};
	
	
	
	this.getChannels=function(callback){
		if (this.__channels){
			return callback(this.__channels)
		}
		
		UI.ajaxShow();
		AP.post(Message.api+"api/message/channel/mine", {}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			Message.API.__channels=code.channels;
			callback(code.channels);
		})
	};
	
	
	this.show=function(){
		$("#msg-root").show();
	};
	
	this.hide=function(){
		$("#msg-root").hide();
	};
};


Base.linking=new function __BaseLinking(){
	this.api=(Client.base && Client.base.app=="base")?"":((parseInt(Client.https)?"https":"http")+"://" + CONFIG.api + "." + Client.domain + "/ajax/");
	
	/**
	 * @desc Linking a particular system/network
	 */
	this.dialog=function(system){
		var base=system.base;
		var selected=[];
		if (base && base.channels){
			selected=AP.select(base.channels, function(e){
				return e.id;
			});
		}
		

		
		this.getChannels(function(channels){
			var actions=[];
			for (var i=0; i<channels.length; i++){
				var c=channels[i];
				actions.push({
					label: c.name,
					value: c.id,
					id: c.id,
					channel: c
				});
			}
			
			AP.selectActions(actions, function(cs){
				var ids=AP.select(cs, function(e){
					return e.channel.id;
				});
				
				if (!ids.length){
					return;
				}
				
				Base.linking.link(system, ids);
			},{
				search: 1,
				selected: selected
			});
		});
		
	};
	
	
	
	this.link=function(system, ids){
		UI.ajaxShow();
		AP.post("api/base/link", {sysid: system.id, systoken: system.token, links: ids.join(",")}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			AP.alertSuccess("Link successfully", function(){
				AP.refresh();
			});
		})
	};
	
	
	
	this.getChannels=function(callback){
		AP.ajaxSetup({
			__sessionid:  Client.secureData.session,
			__otp:  Client.secureData.otp,
		});
		
		UI.ajaxShow();
		AP.post(this.api+"api/message/channel/mine", {}, function(code){
			UI.ajaxHide();
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			callback(code.channels);
		})
	}
};

Message.canvas=new function __MessageCanvas(){
	this.inited=false;
	this.root="#document";
	
	this.init=function(){
		if (Client.nobox && parseInt(Client.nobox)){
			return;
		}
		
		if (this.inited){
			return;
		}
		
		this.inited=true;
		
		Online.loaded(function(){
			build();
		});
	};
	
	this.setChannels=function(channels){
		var html=AP.render(Channel.manager.channels, function(e){
			return getChannelHTML(e);
		});
		
		$("#msg-panel .section-messages").html(html);
		
		
		html=AP.render(Channel.manager.channels, function(e){
			if (e.metatype!="channel"){
				return "";
			}
			return "<div class='item' onclick=\"Channel.open("+e.id+", {intent: 'panel'});\">" +
				"<div class='channel-image'>"+Channel.engine.getImage(e)+"</div>"+
				"<div class='name ap-xdot'>"+Channel.engine.getDisplayName(e)+"</div>" +
			"</div>";
		});
		
		$("#msg-panel .section-channels").html(html);
		countingTotalUnreads();
	};
	
	
	this.balance=function(){
		return Message.render.balance();
	};
	
	
	this.onMessage=function(message, channel){
		if ($("#msg-panel .item.is-channel.js-channel-"+channel.id).length){
			$("#msg-panel .item.is-channel.js-channel-"+channel.id).remove();
		}
		
		$("#msg-panel .section-messages").prepend(getChannelHTML(channel));
		countingTotalUnreads();
	};
	
	
	this.onChannelActive=function(channel_id){
		$("#msg-panel .item.is-channel.js-channel-"+channel_id).removeClass("-focus")
		
		if ($("#msg-panel .item.is-channel.js-channel-"+channel_id).length){
			$("#msg-panel .item.is-channel.js-channel-"+channel_id).removeClass("-unread");
			$("#msg-panel .item.is-channel.js-channel-"+channel_id).addClass("-focus");
			countingTotalUnreads();
		}
	};
	
	
	this.activateSearch=function(ref){
		if ($(ref).closest(".msg-channel").hasClass("collapsed")){
			$("#msg-panel").removeClass("collapsed");	
			$("#msg-root").removeClass("collapsed");
			Message.canvas.balance();
		}
		
		$("#msg-panel .channel-gsearch").show();
		$("#js-channel-gsearch").next().val("").autofocus();
	};
	
	
	
	function build(){
		var html="<div id='msg-root'>" +
			getPanel()+
			"<div id='js-msg-boxes' class='msg-boxes'></div>"+
		"</div>";
		
		$(Message.canvas.root).append(html);
		$("#msg-panel").find(".js-channel-minus").click(function(){
			$(this).closest(".msg-channel").toggleClass("collapsed");
			$("#msg-root").toggleClass("collapsed");
			Message.canvas.balance();
		});
		
		Layout.scrollable("#msg-panel .sections");
		
		$("#msg-panel .tabs .js-tab").click(function(){
			$(this).siblings().removeClass("active");
			$(this).addClass("active");
			var tab=$(this).data("tab");
			$("#msg-panel .sections .section").setActive(".section-"+tab);
		});
		
		
		buildPeople();
		
		var collapsed=Clog.getCookie("msgpc");
		if (collapsed && parseInt(collapsed)){
			collapsed=1;
		}else{
			collapsed=0;
		}
		
		if (collapsed){
			$("#msg-root").addClass("collapsed");
		}
		
		
		$("#msg-panel .channel-header .title").click(function(){
			if ($(this).closest(".msg-channel").hasClass("collapsed")){
				$("#msg-panel").removeClass("collapsed");	
				$("#msg-root").removeClass("collapsed");
				Message.canvas.balance();
			}
		});
		
		$("#msg-panel .channel-gsearch .close").click(function(){
			$("#msg-panel .channel-gsearch").hide();
		});
		
		
		$("#js-channel-gsearch").livesearch(Message.api+"/api/channel/search",{
			select: function(e){
				Channel.open(e.id,{intent: "panel"});
				$("#msg-panel .channel-gsearch").hide();
			}
		});
	};
	
	
	function getPanel(){
		var collapsed=Clog.getCookie("msgpc");
		if (collapsed && parseInt(collapsed)){
			collapsed=1;
		}else{
			collapsed=0;
		}
	
		var people="";
		var html="<div class='msg-channel "+(collapsed?" collapsed":" ")+"' id='msg-panel'>" +
			"<div class='channel-header'>" +
			"	<div class='channel-gsearch hidden'><div class='input'><input placeholder='Find chat groups' id='js-channel-gsearch' name='q'/></div> <div class='close'><span class='-ap icon-uniF108'></span></div></div>" +
			"	<div class='title ap-xdot'>" +
			"		<div class='channel-explain -on-collapsed'><div class='cr'></div><div class='cus'><div class='cx'>Má»Ÿ rá»™ng</div></div></div>" +
			"		<span class='count js-total-unread-count'></span>"+Client.system.name+"" +
				"</div>" +
			"	<div class='icons'>" +
			"		<div class='icon js-channel-minus'><div class='hexp'><div class='txt'>PhĂ³ng to / Thu nhá»</div></div><span class='ficon-minus'></span></div>" +
			"		<div class='icon js-channel-search' onclick='Message.canvas.activateSearch(this);'><div class='hexp'><div class='txt'>TĂ¬m nhĂ³m chat</div></div><span class='ficon-search'></span></div>" +
			"		<div class='icon js-channel-expand url' data-url='"+Base.domain("message")+"/home'><div class='hexp'><div class='txt'>Chuyá»ƒn Ä‘áº¿n trang Message</div></div><span class='-ap icon-open'></span></div>" +
			"	</div>" +
			"</div>" +
			"<div class='tabs'>" +
			"	<div class='tab js-tab js-tab-messages active' data-tab='messages'>Messages</div>" +
			"	<div class='tab js-tab js-tab-channels' data-tab='channels' style='display: none'># Channels</div>" +
			"	<div class='tab js-tab js-tab-people' data-tab='people'><span class='-ap icon-controller-record text-success'></span>&nbsp; Online<span class='count js-online-count'></span></div>" +
			"	<div class='tab js-tab-create' onclick='Message.create.channel();'>+ New</div>" +
			"</div>" +
			"<div class='sections scrollable' data-autoscroll='1'>" +
			"	<div class='section section-messages active'></div>" +
			"	<div class='section section-channels'></div>" +
			"	<div class='section section-people'></div>" +
			"</div>" +
		"</div>";
		
		return html;
	};
	
	
	
	function buildPeople(){
		$("#msg-panel .js-online-count").html("&nbsp; "+Online.people.length+"");
		
		var html=AP.render(Online.people, function(e){
			var user=People.get(e.username);
			if (!user){
				return "";
			}
			
			return "<div class='item js-person' data-kw='"+user.keywords+"' onclick=\"Base.message.peer('"+user.id+"');\">" +
				"<div class='channel-image'><div class='image'><div class='single'><img src='"+AP.thumb(user.gavatar)+"'/></div></div></div>"+
				"<div class='name ap-xdot'>"+user.name+"</div>" +
				"<div class='signal -online'></div>" +
			"</div>";
		});
		
		html+="<div class='sep'>Offline</div>" + AP.render(Client.people, function(e){
			if (!Online.isOnline(e.username)){
				var user=People.get(e.username);
				return "<div class='item js-person' data-kw='"+user.keywords+"' onclick=\"Base.message.peer('"+user.id+"');\">" +
					"<div class='channel-image'><div class='image'><div class='single'><img src='"+AP.thumb(user.gavatar)+"'/></div></div></div>"+
					"<div class='name ap-xdot'>"+user.name+"</div>" +
					"<div class='signal -offline'></div>" +
				"</div>";
			}
			
			return "";
		});
		

		$("#msg-panel .section-people").html("<div class='panel-search'><input type='text' placeholder='TĂ¬m nhanh thĂ nh viĂªn' name='search' id='js-panel-psearch'/></div>"+html);
		$("#js-panel-psearch").quickFilter("#msg-panel .js-person",function($e, q){
			var str=$e.data("kw");
			q=purify(q);
			return str.toLowerCase().indexOf(q)!=-1;
		})
	};
	
	
	
	function getChannelHTML(e){
		var unread_class=(parseInt(e.unread_count)?" -unread":"");
		var unread_count=parseInt(e.unread_count);
		if (unread_count>=10){
			unread_count=9;
		}
		
		if (Channel.engine.isDeactivated(e)){
			return "";
		}
		
		return "<div class='item is-channel js-channel-"+e.id+" "+unread_class+"' onclick=\"Channel.open("+e.id+",{'intent':'panel'});\">" +
			"<div class='channel-image'>"+Channel.engine.getImage(e)+"</div>"+
			"<div class='name ap-xdot'>"+Channel.engine.getDisplayName(e)+"</div>" +
			"<div class='channel-lm'>"+Channel.engine.lastMessage(e)+"</div>" +
			"<div class='unread-count'>"+unread_count+"</div>" +
		"</div>";
	};
	
	
	function countingTotalUnreads(){
		var len=$("#msg-panel .section-messages .item.-unread").length;
		if (len){
			$("#msg-panel .js-total-unread-count").html(len).show();
		}else{
			$("#msg-panel .js-total-unread-count").html(0).hide();
		}
	};
};


Message.render=new function __MessageRender(){
	/**
	 * @desc Render a message channel
	 */
	this.channel=function(channel, opts){		
		if (!opts){
			opts=$.extend({}, {prepend: false}, opts);
		}
		
		var ec=[];
		if (parseInt(opts.collapsed)){
			ec.push("collapsed");
		}
		
		channel._followers=AP.select(channel.followers, function(e){
			var u=People.get(e);
			if (!u.id || !parseInt(u.uid)){
				return null;
			}
			
			return u;
		});
		
		var has_online=false;
		var users=AP.render(channel._followers,function(e, index){
			if (index>=5){
				return "";
			}
			
			if (e.id==Client.viewer.id && channel.subtype=="peer"){
				return "";
			}
			
			if (Online.isOnline(e.username)){
				has_online=true;
				return "<div class='li -online'>"+e.name+"</div>";	
			}
			
			return "<div class='li'>"+e.name+"</div>";
			
		});
		
		if (channel._followers.length>5){
			users+="<div class='li -more url' data-url='"+Base.domain('message')+"/messages/"+channel.id+"'>Xem thĂªm</div>";
		}
		
		
		var channel_explain="<div class='channel-explain'><div class='cr'></div><div class='cus'>"+users+"</div></div>";
		var online="";
	
		if (has_online && channel.subtype=="peer"){
			online=" -online";
		}
		
		var html="<div class='msg-channel is-channel "+ec.join(" ")+"' id='channel-"+channel.id+"' data-id='"+channel.id+"'>" +
				"<div class='channel-header'>" +
				"	<div class='title"+online+"' title='"+Channel.engine.getDisplayName(channel)+"'>"+channel_explain+"<div class='ap-xdot'><span class='url' data-url='"+Base.domain("message")+"/messages/"+channel.id+"'>"+Channel.engine.getDisplayName(channel)+"</span></div></div>" +
				"	<div class='count'></div>" +
				"	<div class='icons'>" +
				"		<div class='icon js-channel-minus'><div class='hexp'><div class='txt'>Thu nhá» / phĂ³ng to</div></div><span class='ficon-minus'></span></div>" +
				"		<div class='icon js-channel-call hide-on-collapsed'><div class='hexp'><div class='txt'>Video call</div></div><span class='-ap icon-phone4'></span></div>"+
				"		<div class='icon js-channel-add-people hide-on-collapsed'><div class='hexp'><div class='txt'>ThĂªm thĂ nh viĂªn</div></div><span class='ficon-plus'></span></div>" +
				"		<div class='icon js-channel-close'><div class='hexp'><div class='txt'>ÄĂ³ng</div></div><span class='-ap icon-ion-android-close'></span></div>" +
				"	</div>" +
				"</div>" +
				"<div class='channel-useradd'>" +
				"	<div class='panel-search'><input type='text' name='useradd' placeholder='+ thĂ nh viĂªn Ä‘á»ƒ chat'/></div>" +
				"	<div class='submit'>ThĂªm</div>" +
				"</div>" +
				"<div class='channel-body scrollable'>" +
				"	<div class='channel-messages' id='channel-messages-"+channel.id+"'></div>" +
				"	<div class='channel-typing' id='channel-typing-"+channel.id+"'>" +
				"		<div class='seen hidden'></div>"+
				"		<div class='typing'>" +
				"			<div class='bubbles'>" +
				"				<div class='box'><div class='b b1'></div><div class='b b2'></div><div class='b b3'></div></div>" +
				"			</div>" +
				"			<div class='text'></div>" +
				"		</div>" +
				"	</div>" +
				"	<div class='channel-typing-fix hidden' style='height: 10px;'></div>" +
				"	<div class='channel-seens'></div>" +
				"</div>" +
				"<div class='channel-form' id='channel-form-"+channel.id+"'>"+getForm(channel)+"</div>" +
			"</div>";
		
		if (opts.prepend){
			$("#js-msg-boxes").prepend(html);
		}else{
			$("#js-msg-boxes").append(html);	
		}
		
		
		$("#channel-"+channel.id).find(".js-channel-minus").click(function(){
			$(this).closest(".msg-channel").toggleClass("collapsed");
			Message.render.balance();
		});
		
		$("#channel-"+channel.id).find(".js-channel-add-people").click(function(){
			$(this).closest(".msg-channel").find(".channel-useradd").toggleClass("active");
			
			if ($(this).closest(".msg-channel").find(".channel-useradd").hasClass("active")){
				$(this).closest(".msg-channel").find(".channel-useradd input").focus();
			}
		});
		
		
		$("#channel-"+channel.id).find(".js-channel-close").click(function(){
			var elem=this;
			var val=$(this).closest(".msg-channel").find("textarea.msg-input").val();
			
			if (val && val.length){
				AP.confirm("Please confirm to close the chatbox? You currently have unsent message.", function(){
					Channel.close($(elem).closest(".msg-channel").data("channel"));
					Message.render.destroy(elem);
				});
			}else{
				Channel.close($(elem).closest(".msg-channel").data("channel"));
				Message.render.destroy(elem);	
			}
		});
		
		$("#channel-"+channel.id).find(".js-channel-call").click(function(){
			var c=$(this).closest(".msg-channel").data("channel");
			AP.confirm("Start a video call within the channel?", function(){
				Message.call.click(c);
			});
		});
		
		$("#channel-"+channel.id+ " .channel-header .title").css({"marginRight": $("#channel-"+channel.id+ " .channel-header .icons").width()});
		
		Layout.scrollable("#js-msg-boxes .channel-body");
		Message.form.build(channel);
		this.balance();
		infiniteScrolling(channel);
		
		Tag.user("#channel-"+channel.id+" .channel-useradd input[name=useradd]", Client.people);
		Message.seen.get(channel, function(seens){
			
		});
		
		$("#channel-"+channel.id+" .channel-useradd .submit").click(function(){
			var val=$(this).parent().find("input").val();
			var channel=getChannel(this);
			
			if (!channel || !val.length){
				$("#channel-"+channel.id+" .channel-useradd").removeClass("active");
				return;
			}
			
			// $("#channel-"+channel.id+" .channel-useradd").removeClass("active");
			
			if (channel.subtype=="peer"){
				val=AP.render(channel._followers, function(e){
					if (e.username==Client.viewer.username){
						return "";
					}
					
					return "@"+e.username+" ";
				})+val;
				
				if (channel.subtype=="peer"){
					return Message.create.channel({
						"usernames_text": val
					});
				}	
			}else{
				var ref=this;
				UI.ajaxShow();
				AP.post(Message.api+"api/message/channel/manage/add.people", {users: val, id: channel.id}, function(code){
					UI.ajaxHide();
					
					if (!code.good()){
						return AP.alertError(code.message);
					}
					
					Message.render.destroy(ref);
					Channel.open(code.channel.id, {
						intent: 'click'
					}, function(){
						
					});
				});
				
			}
			
		});
		
		
		$("#channel-"+channel.id+" .channel-body").click(function(){
			var id=$(this).closest(".msg-channel").data("id");
			Channel.setActive(id);
		});
		
		$("#channel-"+channel.id+" .channel-form").click(function(){
			var id=$(this).closest(".msg-channel").data("id");
			Channel.setActive(id);
		});
	};
	
	
	/**
	 * @desc Balance positions of all channel box
	 */
	this.balance=function(){
		var cr=0;
		$("#js-msg-boxes .msg-channel").each(function(index){
			var w=$(this).width();
			if ($(this).hasClass("collapsed")){
				w=180;
			}else{
				w=270;
			}
			
			if ($(this).hasClass("hidden")){
				w=-15;
			}
			
			$(this).css("right", cr);
			cr+=w+15;
			
			$(this).find(".channel-header .title").css({"marginRight": $(this).find(".channel-header .icons").width()});
		});
		
		Message.cache.auto();
	};
	
	
	this.destroy=function(ref){
		var $box=$(ref).closest(".msg-channel");
		$box.remove();
		this.balance();
	};
	
	
	function getForm(channel){
		var mr=$.sbWidth();
		
		return "<div id='msg-form-"+channel.id+"' class='msg-form'>" +
			"<div class='wrapper'>" +
				"<div class='option'><span class='-ap icon-add'></span></div>"+
				"<div class='ctas-w' style='right:"+mr+"px'>"+getFormButtons(channel)+"</div>"+
				"<div class='send' onclick='Message.form.send(this)'>" +
				"	<div class='circle'><div class='c'><span class='-ap icon-navigation'></span></div></div>" +
				"	<div class='text'>Press enter to submit</div>" +
				"</div>" +
				"<div class='textarea'><div class='inputw'>" +
				"	<div class='input'>" +
				"		<textarea rows='1' class='msg-input' data-tagdir='bottom' data-full='1' name='content' placeholder='Type to send message'></textarea>" +
				"		<div class='help hidden'></div>" +
				"	</div>" +
				"</div></div>" +
			"</div>" +
		"</div>";
	};
	
	
	function getFormButtons(channel){
		return "<div class='ctas'> <div class='action like channel-like' data-action='like' title='Big likes'> " +Render.render('icon', {icon: "base_like" }, '')+ "</div> <div class='action smiley channel-smiley-input' title='Emojis'> " +Render.render('icon', {icon: "emoji_smile_16" }, '')+ "</div> <div class='action -is-gif channel-sticker' title='Gifs and Stickers'> " +Render.render('icon', {icon: "emoji_sticker" }, '')+ "</div> <div class='action image channel-upload-image' title='Upload images'> " +Render.render('icon', {icon: "base_image" }, '')+ "</div> <div class='action att channel-upload-file' title='Upload files'> " +Render.render('icon', {icon: "base_file" }, '')+ "</div> <div class='action channel-upload-drive' data-action='drive' title='Pick files from Base Drive'> <span class='-ap icon-uniF10D2'></span> </div> <div class='action buzz channel-buzz' title='Buzz!' data-action='buzz'> " +Render.render('icon', {icon: "emoji_buzz" }, '')+ "</div> <div class='action js-more-action -cmenuw-active url unselectable' title='More actions' data-url=':active'> " +Render.render('icon', {icon: "ap dots-two-horizontal" }, '')+ " " +Render.render('cmenu', {}, '' +Render.render('cmenu_item', {_class: "js-video" , acl: "appenabled:video" }, "Upload a video")+ " " +Render.render('cmenu_item', {_class: "js-poll" }, "Create a poll")+ " " +Render.render('cmenu_item', {_class: "js-location" }, "Share a location")+ " " +Render.render('cmenu_item', {_class: "js-formatted" }, "Write a formatted message")+ '')+ "</div> </div>";
	};
	
	
	function infiniteScrolling(channel){
		if ($("#channel-"+channel.id+" .channel-body").hasClass("__inf")){
			return;
		}
		
		$("#channel-"+channel.id+" .channel-body").addClass("__inf");
		$("#channel-"+channel.id+" .channel-body > .scrollin").scroll(function(){
			var t=$(this).scrollTop();
			if (t<=50){
				Channel.loadPrevious(channel);
			}
		});
	};
};


Message.create=new function __MessageCreate(){
	this.channel=function(options){
		if (!options){
			options={};
		}
		
		options=$.extend({}, {}, options);
		
		if (!$("#js-channel-create").length){
			var html=getHTML(options);
			$(html).prependTo("#js-msg-boxes");
			bindEvents(options);
			Message.canvas.balance();
		}else{
			$("#js-channel-create").prependTo("#js-msg-boxes").removeClass("hidden");
			reset();
			Message.canvas.balance();
		}
		
		autofocus(options);
		if (options.usernames_text){
			$("#js-channel-create input[name=to]").val(options.usernames_text);
			$("#js-channel-create textarea").focus();
		}
	};
	
	
	this.peer=function(code){
		Channel.openDirect(code.channel, code.messages, code.page_token, code.stars, function(){			
		}, {
			prepend: true
		});
	};
	
	
	function getHTML(options){
		return "<div class='msg-channel is-channel smart-create' id='js-channel-create'>" +
			"<div class='channel-header'>" +
			"	<div class='title'>New message</div>" +
			"	<div class='icons'><div class='icon js-create-close'><span class='-ap icon-ion-android-close'></span></div></div>" +
			"</div>" +
			"<div class='channel-create'>" +
			"	<div class='label'>To:</div>" +
			"	<div class='input'><input name='to' placeholder='Type @ to tag'/></div>" +
			"</div>" +
			"<div class='channel-body'></div>" +
			"<div class='channel-form'>" +
			"	<div class='msg-form'>" +
			"		<div class='textarea'>" +
			"			<div class='inputw'><textarea name='content' placeholder='Type to send message'></textarea></div>" +
			"		</div>" +
			"		<div class='smart-send'>Send</div>" +
			"	</div>" +
			"</div>"+
		"</div>";
	};
	
	
	function createNow(){
		var users=$("#js-channel-create input[name=to]").val();
		var content=$("#js-channel-create textarea[name=content]").val();
		
		AP.post(Message.api+"api/message/channel/create",{users: users, content: content}, function(code){
			if (!code.good()){
				return AP.alertError(code.message);
			}
			
			$("#js-channel-create").addClass("hidden");
			
			Channel.open(code.channel.id, {
				intent: "click",
				prepend: true
			});
			
//			Channel.openDirect(code.channel, code.messages, code.page_token, code.stars, function(){
//				
//			}, {
//				prepend: true
//			});
		});
	};
	
	
	function bindEvents(options){
		Tag.user("#js-channel-create input[name=to]", Client.people);
		
		$("#js-channel-create textarea[name=content]").enter(function(){
			createNow(this);
		});
		
		$("#js-channel-create .smart-send").click(function(){
			createNow(this);
		});
		
		$("#js-channel-create .js-create-close").click(function(){
			$("#js-channel-create").addClass("hidden");
			Message.canvas.balance();
		});
		
		$("#js-channel-create textarea[name=content]").height(24).autoExpand();
	};
	
	
	function autofocus(options){
		if (options.users){
			$("#js-channel-create input[name=to]").val(AP.word.join(options.users, " ", function(e){
				return "@"+e+"";
			})+" ");	
		}
		
		if (!options.users || !options.users.length){
			$("#js-channel-create input[name=to]").focus();	
		}else{
			$("#js-channel-create textarea[name=content]").focus();
		}
	};
	
	
	function reset(){
		$("#js-channel-create input[name=to]").val("");
		$("#js-channel-create textarea[name=content]").val("");
		$("#js-channel-create textarea[name=content]").height(26)
	};
};






Message.base=new function __MessageBase(){
	this.init=function(){
		if (!Client.viewer || !parseInt(Client.viewer.id)){
			return;
		}
		
		if (parseInt(Client.viewer.disabled_message)==2){
			$.log("MESSAGE_DISABLED_ON_THIS_ACCOUNT");
			return;
		}
		
		AP.sys.on("socket.ready", function(){
			$(document).ready(function(){
				if (!Client.mobile && parseInt(Client.viewer.id)){
					if (Client.base){
						Message.base.run();
						
						$(window).on("blur", function(){
							Channel.setActive(0);
							Message.form.untyping();
						}).on("focus", function(){
							
						}).on("unload", function(){
							Message.form.untyping();
						});
						
					}
				}
			});
		});
	};
	
	
	this.run=function(){
		if (!Client.mobile && parseInt(Client.viewer.id)){
			Message.canvas.init();
			Message.seen.init();
			
			Channel.manager.load(function(channels){
				Message.canvas.setChannels(channels);
			});
			
			Message.bindEvents();
			var cs=Message.cache.currentChannels();
			
			for (var i=0; i<Math.min(cs.length,5); i++){
				var c=cs[i];
				if (!c || !c.id){
					continue;
				}
				
				Channel.open(c.id, {collapsed: parseInt(c.c), intent: "cache"});
			};
		};
	};
};




Message.mode("base");
Message.base.init();
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.io=e():t.io=e()}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,e),o.loaded=!0,o.exports}var n={};return e.m=t,e.c=n,e.p="",e(0)}([function(t,e,n){"use strict";function r(t,e){"object"===("undefined"==typeof t?"undefined":o(t))&&(e=t,t=void 0),e=e||{};var n,r=i(t),s=r.source,p=r.id,h=r.path,f=u[p]&&h in u[p].nsps,l=e.forceNew||e["force new connection"]||!1===e.multiplex||f;return l?(c("ignoring socket cache for %s",s),n=a(s,e)):(u[p]||(c("new io instance for %s",s),u[p]=a(s,e)),n=u[p]),r.query&&!e.query&&(e.query=r.query),n.socket(r.path,e)}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=n(1),s=n(7),a=n(12),c=n(3)("socket.io-client");t.exports=e=r;var u=e.managers={};e.protocol=s.protocol,e.connect=r,e.Manager=n(12),e.Socket=n(37)},function(t,e,n){(function(e){"use strict";function r(t,n){var r=t;n=n||e.location,null==t&&(t=n.protocol+"//"+n.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?n.protocol+t:n.host+t),/^(https?|wss?):\/\//.test(t)||(i("protocol-less url %s",t),t="undefined"!=typeof n?n.protocol+"//"+t:"https://"+t),i("parse %s",t),r=o(t)),r.port||(/^(http|ws)$/.test(r.protocol)?r.port="80":/^(http|ws)s$/.test(r.protocol)&&(r.port="443")),r.path=r.path||"/";var s=r.host.indexOf(":")!==-1,a=s?"["+r.host+"]":r.host;return r.id=r.protocol+"://"+a+":"+r.port,r.href=r.protocol+"://"+a+(n&&n.port===r.port?"":":"+r.port),r}var o=n(2),i=n(3)("socket.io-client:url");t.exports=r}).call(e,function(){return this}())},function(t,e){var n=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,r=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];t.exports=function(t){var e=t,o=t.indexOf("["),i=t.indexOf("]");o!=-1&&i!=-1&&(t=t.substring(0,o)+t.substring(o,i).replace(/:/g,";")+t.substring(i,t.length));for(var s=n.exec(t||""),a={},c=14;c--;)a[r[c]]=s[c]||"";return o!=-1&&i!=-1&&(a.source=e,a.host=a.host.substring(1,a.host.length-1).replace(/;/g,":"),a.authority=a.authority.replace("[","").replace("]","").replace(/;/g,":"),a.ipv6uri=!0),a}},function(t,e,n){(function(r){function o(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))}function i(t){var n=this.useColors;if(t[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+t[0]+(n?"%c ":" ")+"+"+e.humanize(this.diff),n){var r="color: "+this.color;t.splice(1,0,r,"color: inherit");var o=0,i=0;t[0].replace(/%[a-zA-Z%]/g,function(t){"%%"!==t&&(o++,"%c"===t&&(i=o))}),t.splice(i,0,r)}}function s(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function a(t){try{null==t?e.storage.removeItem("debug"):e.storage.debug=t}catch(n){}}function c(){var t;try{t=e.storage.debug}catch(n){}return!t&&"undefined"!=typeof r&&"env"in r&&(t=r.env.DEBUG),t}function u(){try{return window.localStorage}catch(t){}}e=t.exports=n(5),e.log=s,e.formatArgs=i,e.save=a,e.load=c,e.useColors=o,e.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:u(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.formatters.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},e.enable(c())}).call(e,n(4))},function(t,e){function n(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function o(t){if(p===setTimeout)return setTimeout(t,0);if((p===n||!p)&&setTimeout)return p=setTimeout,setTimeout(t,0);try{return p(t,0)}catch(e){try{return p.call(null,t,0)}catch(e){return p.call(this,t,0)}}}function i(t){if(h===clearTimeout)return clearTimeout(t);if((h===r||!h)&&clearTimeout)return h=clearTimeout,clearTimeout(t);try{return h(t)}catch(e){try{return h.call(null,t)}catch(e){return h.call(this,t)}}}function s(){y&&l&&(y=!1,l.length?d=l.concat(d):m=-1,d.length&&a())}function a(){if(!y){var t=o(s);y=!0;for(var e=d.length;e;){for(l=d,d=[];++m<e;)l&&l[m].run();m=-1,e=d.length}l=null,y=!1,i(t)}}function c(t,e){this.fun=t,this.array=e}function u(){}var p,h,f=t.exports={};!function(){try{p="function"==typeof setTimeout?setTimeout:n}catch(t){p=n}try{h="function"==typeof clearTimeout?clearTimeout:r}catch(t){h=r}}();var l,d=[],y=!1,m=-1;f.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];d.push(new c(t,e)),1!==d.length||y||o(a)},c.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=u,f.addListener=u,f.once=u,f.off=u,f.removeListener=u,f.removeAllListeners=u,f.emit=u,f.prependListener=u,f.prependOnceListener=u,f.listeners=function(t){return[]},f.binding=function(t){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(t){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(t,e,n){function r(t){var n,r=0;for(n in t)r=(r<<5)-r+t.charCodeAt(n),r|=0;return e.colors[Math.abs(r)%e.colors.length]}function o(t){function n(){if(n.enabled){var t=n,r=+new Date,i=r-(o||r);t.diff=i,t.prev=o,t.curr=r,o=r;for(var s=new Array(arguments.length),a=0;a<s.length;a++)s[a]=arguments[a];s[0]=e.coerce(s[0]),"string"!=typeof s[0]&&s.unshift("%O");var c=0;s[0]=s[0].replace(/%([a-zA-Z%])/g,function(n,r){if("%%"===n)return n;c++;var o=e.formatters[r];if("function"==typeof o){var i=s[c];n=o.call(t,i),s.splice(c,1),c--}return n}),e.formatArgs.call(t,s);var u=n.log||e.log||console.log.bind(console);u.apply(t,s)}}var o;return n.namespace=t,n.enabled=e.enabled(t),n.useColors=e.useColors(),n.color=r(t),n.destroy=i,"function"==typeof e.init&&e.init(n),e.instances.push(n),n}function i(){var t=e.instances.indexOf(this);return t!==-1&&(e.instances.splice(t,1),!0)}function s(t){e.save(t),e.names=[],e.skips=[];var n,r=("string"==typeof t?t:"").split(/[\s,]+/),o=r.length;for(n=0;n<o;n++)r[n]&&(t=r[n].replace(/\*/g,".*?"),"-"===t[0]?e.skips.push(new RegExp("^"+t.substr(1)+"$")):e.names.push(new RegExp("^"+t+"$")));for(n=0;n<e.instances.length;n++){var i=e.instances[n];i.enabled=e.enabled(i.namespace)}}function a(){e.enable("")}function c(t){if("*"===t[t.length-1])return!0;var n,r;for(n=0,r=e.skips.length;n<r;n++)if(e.skips[n].test(t))return!1;for(n=0,r=e.names.length;n<r;n++)if(e.names[n].test(t))return!0;return!1}function u(t){return t instanceof Error?t.stack||t.message:t}e=t.exports=o.debug=o["default"]=o,e.coerce=u,e.disable=a,e.enable=s,e.enabled=c,e.humanize=n(6),e.instances=[],e.names=[],e.skips=[],e.formatters={}},function(t,e){function n(t){if(t=String(t),!(t.length>100)){var e=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(t);if(e){var n=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return n*p;case"days":case"day":case"d":return n*u;case"hours":case"hour":case"hrs":case"hr":case"h":return n*c;case"minutes":case"minute":case"mins":case"min":case"m":return n*a;case"seconds":case"second":case"secs":case"sec":case"s":return n*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return n;default:return}}}}function r(t){return t>=u?Math.round(t/u)+"d":t>=c?Math.round(t/c)+"h":t>=a?Math.round(t/a)+"m":t>=s?Math.round(t/s)+"s":t+"ms"}function o(t){return i(t,u,"day")||i(t,c,"hour")||i(t,a,"minute")||i(t,s,"second")||t+" ms"}function i(t,e,n){if(!(t<e))return t<1.5*e?Math.floor(t/e)+" "+n:Math.ceil(t/e)+" "+n+"s"}var s=1e3,a=60*s,c=60*a,u=24*c,p=365.25*u;t.exports=function(t,e){e=e||{};var i=typeof t;if("string"===i&&t.length>0)return n(t);if("number"===i&&isNaN(t)===!1)return e["long"]?o(t):r(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},function(t,e,n){function r(){}function o(t){var n=""+t.type;if(e.BINARY_EVENT!==t.type&&e.BINARY_ACK!==t.type||(n+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(n+=t.nsp+","),null!=t.id&&(n+=t.id),null!=t.data){var r=i(t.data);if(r===!1)return g;n+=r}return f("encoded %j as %s",t,n),n}function i(t){try{return JSON.stringify(t)}catch(e){return!1}}function s(t,e){function n(t){var n=d.deconstructPacket(t),r=o(n.packet),i=n.buffers;i.unshift(r),e(i)}d.removeBlobs(t,n)}function a(){this.reconstructor=null}function c(t){var n=0,r={type:Number(t.charAt(0))};if(null==e.types[r.type])return h("unknown packet type "+r.type);if(e.BINARY_EVENT===r.type||e.BINARY_ACK===r.type){for(var o="";"-"!==t.charAt(++n)&&(o+=t.charAt(n),n!=t.length););if(o!=Number(o)||"-"!==t.charAt(n))throw new Error("Illegal attachments");r.attachments=Number(o)}if("/"===t.charAt(n+1))for(r.nsp="";++n;){var i=t.charAt(n);if(","===i)break;if(r.nsp+=i,n===t.length)break}else r.nsp="/";var s=t.charAt(n+1);if(""!==s&&Number(s)==s){for(r.id="";++n;){var i=t.charAt(n);if(null==i||Number(i)!=i){--n;break}if(r.id+=t.charAt(n),n===t.length)break}r.id=Number(r.id)}if(t.charAt(++n)){var a=u(t.substr(n)),c=a!==!1&&(r.type===e.ERROR||y(a));if(!c)return h("invalid payload");r.data=a}return f("decoded %s as %j",t,r),r}function u(t){try{return JSON.parse(t)}catch(e){return!1}}function p(t){this.reconPack=t,this.buffers=[]}function h(t){return{type:e.ERROR,data:"parser error: "+t}}var f=n(3)("socket.io-parser"),l=n(8),d=n(9),y=n(10),m=n(11);e.protocol=4,e.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],e.CONNECT=0,e.DISCONNECT=1,e.EVENT=2,e.ACK=3,e.ERROR=4,e.BINARY_EVENT=5,e.BINARY_ACK=6,e.Encoder=r,e.Decoder=a;var g=e.ERROR+'"encode error"';r.prototype.encode=function(t,n){if(f("encoding packet %j",t),e.BINARY_EVENT===t.type||e.BINARY_ACK===t.type)s(t,n);else{var r=o(t);n([r])}},l(a.prototype),a.prototype.add=function(t){var n;if("string"==typeof t)n=c(t),e.BINARY_EVENT===n.type||e.BINARY_ACK===n.type?(this.reconstructor=new p(n),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",n)):this.emit("decoded",n);else{if(!m(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");n=this.reconstructor.takeBinaryData(t),n&&(this.reconstructor=null,this.emit("decoded",n))}},a.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},p.prototype.takeBinaryData=function(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){var e=d.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null},p.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}},function(t,e,n){function r(t){if(t)return o(t)}function o(t){for(var e in r.prototype)t[e]=r.prototype[e];return t}t.exports=r,r.prototype.on=r.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},r.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this},r.prototype.off=r.prototype.removeListener=r.prototype.removeAllListeners=r.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n=this._callbacks["$"+t];if(!n)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var r,o=0;o<n.length;o++)if(r=n[o],r===e||r.fn===e){n.splice(o,1);break}return this},r.prototype.emit=function(t){this._callbacks=this._callbacks||{};var e=[].slice.call(arguments,1),n=this._callbacks["$"+t];if(n){n=n.slice(0);for(var r=0,o=n.length;r<o;++r)n[r].apply(this,e)}return this},r.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},r.prototype.hasListeners=function(t){return!!this.listeners(t).length}},function(t,e,n){(function(t){function r(t,e){if(!t)return t;if(s(t)){var n={_placeholder:!0,num:e.length};return e.push(t),n}if(i(t)){for(var o=new Array(t.length),a=0;a<t.length;a++)o[a]=r(t[a],e);return o}if("object"==typeof t&&!(t instanceof Date)){var o={};for(var c in t)o[c]=r(t[c],e);return o}return t}function o(t,e){if(!t)return t;if(t&&t._placeholder)return e[t.num];if(i(t))for(var n=0;n<t.length;n++)t[n]=o(t[n],e);else if("object"==typeof t)for(var r in t)t[r]=o(t[r],e);return t}var i=n(10),s=n(11),a=Object.prototype.toString,c="function"==typeof t.Blob||"[object BlobConstructor]"===a.call(t.Blob),u="function"==typeof t.File||"[object FileConstructor]"===a.call(t.File);e.deconstructPacket=function(t){var e=[],n=t.data,o=t;return o.data=r(n,e),o.attachments=e.length,{packet:o,buffers:e}},e.reconstructPacket=function(t,e){return t.data=o(t.data,e),t.attachments=void 0,t},e.removeBlobs=function(t,e){function n(t,a,p){if(!t)return t;if(c&&t instanceof Blob||u&&t instanceof File){r++;var h=new FileReader;h.onload=function(){p?p[a]=this.result:o=this.result,--r||e(o)},h.readAsArrayBuffer(t)}else if(i(t))for(var f=0;f<t.length;f++)n(t[f],f,t);else if("object"==typeof t&&!s(t))for(var l in t)n(t[l],l,t)}var r=0,o=t;n(o),r||e(o)}}).call(e,function(){return this}())},function(t,e){var n={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==n.call(t)}},function(t,e){(function(e){function n(t){return r&&e.Buffer.isBuffer(t)||o&&(t instanceof e.ArrayBuffer||i(t))}t.exports=n;var r="function"==typeof e.Buffer&&"function"==typeof e.Buffer.isBuffer,o="function"==typeof e.ArrayBuffer,i=function(){return o&&"function"==typeof e.ArrayBuffer.isView?e.ArrayBuffer.isView:function(t){return t.buffer instanceof e.ArrayBuffer}}()}).call(e,function(){return this}())},function(t,e,n){"use strict";function r(t,e){if(!(this instanceof r))return new r(t,e);t&&"object"===("undefined"==typeof t?"undefined":o(t))&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.nsps={},this.subs=[],this.opts=e,this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor(e.randomizationFactor||.5),this.backoff=new l({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==e.timeout?2e4:e.timeout),this.readyState="closed",this.uri=t,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[];var n=e.parser||c;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this.autoConnect=e.autoConnect!==!1,this.autoConnect&&this.open()}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=n(13),s=n(37),a=n(8),c=n(7),u=n(39),p=n(40),h=n(3)("socket.io-client:manager"),f=n(36),l=n(41),d=Object.prototype.hasOwnProperty;t.exports=r,r.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var t in this.nsps)d.call(this.nsps,t)&&this.nsps[t].emit.apply(this.nsps[t],arguments)},r.prototype.updateSocketIds=function(){for(var t in this.nsps)d.call(this.nsps,t)&&(this.nsps[t].id=this.generateId(t))},r.prototype.generateId=function(t){return("/"===t?"":t+"#")+this.engine.id},a(r.prototype),r.prototype.reconnection=function(t){return arguments.length?(this._reconnection=!!t,this):this._reconnection},r.prototype.reconnectionAttempts=function(t){return arguments.length?(this._reconnectionAttempts=t,this):this._reconnectionAttempts},r.prototype.reconnectionDelay=function(t){return arguments.length?(this._reconnectionDelay=t,this.backoff&&this.backoff.setMin(t),this):this._reconnectionDelay},r.prototype.randomizationFactor=function(t){return arguments.length?(this._randomizationFactor=t,this.backoff&&this.backoff.setJitter(t),this):this._randomizationFactor},r.prototype.reconnectionDelayMax=function(t){return arguments.length?(this._reconnectionDelayMax=t,this.backoff&&this.backoff.setMax(t),this):this._reconnectionDelayMax},r.prototype.timeout=function(t){return arguments.length?(this._timeout=t,this):this._timeout},r.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},r.prototype.open=r.prototype.connect=function(t,e){if(h("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;h("opening %s",this.uri),this.engine=i(this.uri,this.opts);var n=this.engine,r=this;this.readyState="opening",this.skipReconnect=!1;var o=u(n,"open",function(){r.onopen(),t&&t()}),s=u(n,"error",function(e){if(h("connect_error"),r.cleanup(),r.readyState="closed",r.emitAll("connect_error",e),t){var n=new Error("Connection error");n.data=e,t(n)}else r.maybeReconnectOnOpen()});if(!1!==this._timeout){var a=this._timeout;h("connect attempt will timeout after %d",a);var c=setTimeout(function(){h("connect attempt timed out after %d",a),o.destroy(),n.close(),n.emit("error","timeout"),r.emitAll("connect_timeout",a)},a);this.subs.push({destroy:function(){clearTimeout(c)}})}return this.subs.push(o),this.subs.push(s),this},r.prototype.onopen=function(){h("open"),this.cleanup(),this.readyState="open",this.emit("open");var t=this.engine;this.subs.push(u(t,"data",p(this,"ondata"))),this.subs.push(u(t,"ping",p(this,"onping"))),this.subs.push(u(t,"pong",p(this,"onpong"))),this.subs.push(u(t,"error",p(this,"onerror"))),this.subs.push(u(t,"close",p(this,"onclose"))),this.subs.push(u(this.decoder,"decoded",p(this,"ondecoded")))},r.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},r.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},r.prototype.ondata=function(t){this.decoder.add(t)},r.prototype.ondecoded=function(t){this.emit("packet",t)},r.prototype.onerror=function(t){h("error",t),this.emitAll("error",t)},r.prototype.socket=function(t,e){function n(){~f(o.connecting,r)||o.connecting.push(r)}var r=this.nsps[t];if(!r){r=new s(this,t,e),this.nsps[t]=r;var o=this;r.on("connecting",n),r.on("connect",function(){r.id=o.generateId(t)}),this.autoConnect&&n()}return r},r.prototype.destroy=function(t){var e=f(this.connecting,t);~e&&this.connecting.splice(e,1),this.connecting.length||this.close()},r.prototype.packet=function(t){h("writing packet %j",t);var e=this;t.query&&0===t.type&&(t.nsp+="?"+t.query),e.encoding?e.packetBuffer.push(t):(e.encoding=!0,this.encoder.encode(t,function(n){for(var r=0;r<n.length;r++)e.engine.write(n[r],t.options);e.encoding=!1,e.processPacketQueue()}))},r.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var t=this.packetBuffer.shift();this.packet(t)}},r.prototype.cleanup=function(){h("cleanup");for(var t=this.subs.length,e=0;e<t;e++){var n=this.subs.shift();n.destroy()}this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},r.prototype.close=r.prototype.disconnect=function(){h("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},r.prototype.onclose=function(t){h("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",t),this._reconnection&&!this.skipReconnect&&this.reconnect()},r.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var t=this;if(this.backoff.attempts>=this._reconnectionAttempts)h("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var e=this.backoff.duration();h("will wait %dms before reconnect attempt",e),this.reconnecting=!0;var n=setTimeout(function(){t.skipReconnect||(h("attempting reconnect"),t.emitAll("reconnect_attempt",t.backoff.attempts),t.emitAll("reconnecting",t.backoff.attempts),t.skipReconnect||t.open(function(e){e?(h("reconnect attempt error"),t.reconnecting=!1,t.reconnect(),t.emitAll("reconnect_error",e.data)):(h("reconnect success"),t.onreconnect())}))},e);this.subs.push({destroy:function(){clearTimeout(n)}})}},r.prototype.onreconnect=function(){var t=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",t)}},function(t,e,n){t.exports=n(14),t.exports.parser=n(21)},function(t,e,n){(function(e){function r(t,n){if(!(this instanceof r))return new r(t,n);n=n||{},t&&"object"==typeof t&&(n=t,t=null),t?(t=p(t),n.hostname=t.host,n.secure="https"===t.protocol||"wss"===t.protocol,n.port=t.port,t.query&&(n.query=t.query)):n.host&&(n.hostname=p(n.host).host),this.secure=null!=n.secure?n.secure:e.location&&"https:"===location.protocol,n.hostname&&!n.port&&(n.port=this.secure?"443":"80"),this.agent=n.agent||!1,this.hostname=n.hostname||(e.location?location.hostname:"localhost"),this.port=n.port||(e.location&&location.port?location.port:this.secure?443:80),this.query=n.query||{},"string"==typeof this.query&&(this.query=h.decode(this.query)),this.upgrade=!1!==n.upgrade,this.path=(n.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!n.forceJSONP,this.jsonp=!1!==n.jsonp,this.forceBase64=!!n.forceBase64,this.enablesXDR=!!n.enablesXDR,this.timestampParam=n.timestampParam||"t",this.timestampRequests=n.timestampRequests,this.transports=n.transports||["polling","websocket"],this.transportOptions=n.transportOptions||{},this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=n.policyPort||843,this.rememberUpgrade=n.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=n.onlyBinaryUpgrades,this.perMessageDeflate=!1!==n.perMessageDeflate&&(n.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=n.pfx||null,this.key=n.key||null,this.passphrase=n.passphrase||null,this.cert=n.cert||null,this.ca=n.ca||null,this.ciphers=n.ciphers||null,this.rejectUnauthorized=void 0===n.rejectUnauthorized||n.rejectUnauthorized,this.forceNode=!!n.forceNode;var o="object"==typeof e&&e;o.global===o&&(n.extraHeaders&&Object.keys(n.extraHeaders).length>0&&(this.extraHeaders=n.extraHeaders),n.localAddress&&(this.localAddress=n.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}function o(t){var e={};for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}var i=n(15),s=n(8),a=n(3)("engine.io-client:socket"),c=n(36),u=n(21),p=n(2),h=n(30);t.exports=r,r.priorWebsocketSuccess=!1,s(r.prototype),r.protocol=u.protocol,r.Socket=r,r.Transport=n(20),r.transports=n(15),r.parser=n(21),r.prototype.createTransport=function(t){a('creating transport "%s"',t);var e=o(this.query);e.EIO=u.protocol,e.transport=t;var n=this.transportOptions[t]||{};this.id&&(e.sid=this.id);var r=new i[t]({query:e,socket:this,agent:n.agent||this.agent,hostname:n.hostname||this.hostname,port:n.port||this.port,secure:n.secure||this.secure,path:n.path||this.path,forceJSONP:n.forceJSONP||this.forceJSONP,jsonp:n.jsonp||this.jsonp,forceBase64:n.forceBase64||this.forceBase64,enablesXDR:n.enablesXDR||this.enablesXDR,timestampRequests:n.timestampRequests||this.timestampRequests,timestampParam:n.timestampParam||this.timestampParam,policyPort:n.policyPort||this.policyPort,pfx:n.pfx||this.pfx,key:n.key||this.key,passphrase:n.passphrase||this.passphrase,cert:n.cert||this.cert,ca:n.ca||this.ca,ciphers:n.ciphers||this.ciphers,rejectUnauthorized:n.rejectUnauthorized||this.rejectUnauthorized,perMessageDeflate:n.perMessageDeflate||this.perMessageDeflate,extraHeaders:n.extraHeaders||this.extraHeaders,forceNode:n.forceNode||this.forceNode,localAddress:n.localAddress||this.localAddress,requestTimeout:n.requestTimeout||this.requestTimeout,protocols:n.protocols||void 0});return r},r.prototype.open=function(){var t;if(this.rememberUpgrade&&r.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)t="websocket";else{if(0===this.transports.length){var e=this;return void setTimeout(function(){e.emit("error","No transports available")},0)}t=this.transports[0]}this.readyState="opening";try{t=this.createTransport(t)}catch(n){return this.transports.shift(),void this.open()}t.open(),this.setTransport(t)},r.prototype.setTransport=function(t){a("setting transport %s",t.name);var e=this;this.transport&&(a("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=t,t.on("drain",function(){e.onDrain()}).on("packet",function(t){e.onPacket(t)}).on("error",function(t){e.onError(t)}).on("close",function(){e.onClose("transport close")})},r.prototype.probe=function(t){function e(){if(f.onlyBinaryUpgrades){var e=!this.supportsBinary&&f.transport.supportsBinary;h=h||e}h||(a('probe transport "%s" opened',t),p.send([{type:"ping",data:"probe"}]),p.once("packet",function(e){if(!h)if("pong"===e.type&&"probe"===e.data){if(a('probe transport "%s" pong',t),f.upgrading=!0,f.emit("upgrading",p),!p)return;r.priorWebsocketSuccess="websocket"===p.name,a('pausing current transport "%s"',f.transport.name),f.transport.pause(function(){h||"closed"!==f.readyState&&(a("changing transport and sending upgrade packet"),u(),f.setTransport(p),p.send([{type:"upgrade"}]),f.emit("upgrade",p),p=null,f.upgrading=!1,f.flush())})}else{a('probe transport "%s" failed',t);var n=new Error("probe error");n.transport=p.name,f.emit("upgradeError",n)}}))}function n(){h||(h=!0,u(),p.close(),p=null)}function o(e){var r=new Error("probe error: "+e);r.transport=p.name,n(),a('probe transport "%s" failed because of error: %s',t,e),f.emit("upgradeError",r)}function i(){o("transport closed")}function s(){o("socket closed")}function c(t){p&&t.name!==p.name&&(a('"%s" works - aborting "%s"',t.name,p.name),n())}function u(){p.removeListener("open",e),p.removeListener("error",o),p.removeListener("close",i),f.removeListener("close",s),f.removeListener("upgrading",c)}a('probing transport "%s"',t);var p=this.createTransport(t,{probe:1}),h=!1,f=this;r.priorWebsocketSuccess=!1,p.once("open",e),p.once("error",o),p.once("close",i),this.once("close",s),this.once("upgrading",c),p.open()},r.prototype.onOpen=function(){if(a("socket open"),this.readyState="open",r.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){a("starting upgrade probes");for(var t=0,e=this.upgrades.length;t<e;t++)this.probe(this.upgrades[t])}},r.prototype.onPacket=function(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(a('socket receive: type "%s", data "%s"',t.type,t.data),this.emit("packet",t),this.emit("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var e=new Error("server error");e.code=t.data,this.onError(e);break;case"message":this.emit("data",t.data),this.emit("message",t.data)}else a('packet received with socket readyState "%s"',this.readyState)},r.prototype.onHandshake=function(t){this.emit("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this.upgrades=this.filterUpgrades(t.upgrades),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},r.prototype.onHeartbeat=function(t){clearTimeout(this.pingTimeoutTimer);var e=this;e.pingTimeoutTimer=setTimeout(function(){"closed"!==e.readyState&&e.onClose("ping timeout")},t||e.pingInterval+e.pingTimeout)},r.prototype.setPing=function(){var t=this;clearTimeout(t.pingIntervalTimer),t.pingIntervalTimer=setTimeout(function(){a("writing ping packet - expecting pong within %sms",t.pingTimeout),t.ping(),t.onHeartbeat(t.pingTimeout)},t.pingInterval)},r.prototype.ping=function(){var t=this;this.sendPacket("ping",function(){t.emit("ping")})},r.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},r.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(a("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},r.prototype.write=r.prototype.send=function(t,e,n){return this.sendPacket("message",t,e,n),this},r.prototype.sendPacket=function(t,e,n,r){if("function"==typeof e&&(r=e,e=void 0),"function"==typeof n&&(r=n,n=null),"closing"!==this.readyState&&"closed"!==this.readyState){n=n||{},n.compress=!1!==n.compress;var o={type:t,data:e,options:n};this.emit("packetCreate",o),this.writeBuffer.push(o),r&&this.once("flush",r),this.flush()}},r.prototype.close=function(){function t(){r.onClose("forced close"),a("socket closing - telling transport to close"),r.transport.close()}function e(){r.removeListener("upgrade",e),r.removeListener("upgradeError",e),t()}function n(){r.once("upgrade",e),r.once("upgradeError",e)}if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var r=this;this.writeBuffer.length?this.once("drain",function(){this.upgrading?n():t()}):this.upgrading?n():t()}return this},r.prototype.onError=function(t){a("socket error %j",t),r.priorWebsocketSuccess=!1,this.emit("error",t),this.onClose("transport error",t)},r.prototype.onClose=function(t,e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){a('socket close with reason: "%s"',t);var n=this;clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",t,e),n.writeBuffer=[],n.prevBufferLen=0}},r.prototype.filterUpgrades=function(t){for(var e=[],n=0,r=t.length;n<r;n++)~c(this.transports,t[n])&&e.push(t[n]);return e}}).call(e,function(){return this}())},function(t,e,n){(function(t){function r(e){var n,r=!1,a=!1,c=!1!==e.jsonp;if(t.location){var u="https:"===location.protocol,p=location.port;
p||(p=u?443:80),r=e.hostname!==location.hostname||p!==e.port,a=e.secure!==u}if(e.xdomain=r,e.xscheme=a,n=new o(e),"open"in n&&!e.forceJSONP)return new i(e);if(!c)throw new Error("JSONP disabled");return new s(e)}var o=n(16),i=n(18),s=n(33),a=n(34);e.polling=r,e.websocket=a}).call(e,function(){return this}())},function(t,e,n){(function(e){var r=n(17);t.exports=function(t){var n=t.xdomain,o=t.xscheme,i=t.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!n||r))return new XMLHttpRequest}catch(s){}try{if("undefined"!=typeof XDomainRequest&&!o&&i)return new XDomainRequest}catch(s){}if(!n)try{return new(e[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(s){}}}).call(e,function(){return this}())},function(t,e){try{t.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(n){t.exports=!1}},function(t,e,n){(function(e){function r(){}function o(t){if(c.call(this,t),this.requestTimeout=t.requestTimeout,this.extraHeaders=t.extraHeaders,e.location){var n="https:"===location.protocol,r=location.port;r||(r=n?443:80),this.xd=t.hostname!==e.location.hostname||r!==t.port,this.xs=t.secure!==n}}function i(t){this.method=t.method||"GET",this.uri=t.uri,this.xd=!!t.xd,this.xs=!!t.xs,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.agent=t.agent,this.isBinary=t.isBinary,this.supportsBinary=t.supportsBinary,this.enablesXDR=t.enablesXDR,this.requestTimeout=t.requestTimeout,this.pfx=t.pfx,this.key=t.key,this.passphrase=t.passphrase,this.cert=t.cert,this.ca=t.ca,this.ciphers=t.ciphers,this.rejectUnauthorized=t.rejectUnauthorized,this.extraHeaders=t.extraHeaders,this.create()}function s(){for(var t in i.requests)i.requests.hasOwnProperty(t)&&i.requests[t].abort()}var a=n(16),c=n(19),u=n(8),p=n(31),h=n(3)("engine.io-client:polling-xhr");t.exports=o,t.exports.Request=i,p(o,c),o.prototype.supportsBinary=!0,o.prototype.request=function(t){return t=t||{},t.uri=this.uri(),t.xd=this.xd,t.xs=this.xs,t.agent=this.agent||!1,t.supportsBinary=this.supportsBinary,t.enablesXDR=this.enablesXDR,t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,t.requestTimeout=this.requestTimeout,t.extraHeaders=this.extraHeaders,new i(t)},o.prototype.doWrite=function(t,e){var n="string"!=typeof t&&void 0!==t,r=this.request({method:"POST",data:t,isBinary:n}),o=this;r.on("success",e),r.on("error",function(t){o.onError("xhr post error",t)}),this.sendXhr=r},o.prototype.doPoll=function(){h("xhr poll");var t=this.request(),e=this;t.on("data",function(t){e.onData(t)}),t.on("error",function(t){e.onError("xhr poll error",t)}),this.pollXhr=t},u(i.prototype),i.prototype.create=function(){var t={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized;var n=this.xhr=new a(t),r=this;try{h("xhr open %s: %s",this.method,this.uri),n.open(this.method,this.uri,this.async);try{if(this.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(var o in this.extraHeaders)this.extraHeaders.hasOwnProperty(o)&&n.setRequestHeader(o,this.extraHeaders[o])}}catch(s){}if("POST"===this.method)try{this.isBinary?n.setRequestHeader("Content-type","application/octet-stream"):n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(s){}try{n.setRequestHeader("Accept","*/*")}catch(s){}"withCredentials"in n&&(n.withCredentials=!0),this.requestTimeout&&(n.timeout=this.requestTimeout),this.hasXDR()?(n.onload=function(){r.onLoad()},n.onerror=function(){r.onError(n.responseText)}):n.onreadystatechange=function(){if(2===n.readyState)try{var t=n.getResponseHeader("Content-Type");r.supportsBinary&&"application/octet-stream"===t&&(n.responseType="arraybuffer")}catch(e){}4===n.readyState&&(200===n.status||1223===n.status?r.onLoad():setTimeout(function(){r.onError(n.status)},0))},h("xhr data %s",this.data),n.send(this.data)}catch(s){return void setTimeout(function(){r.onError(s)},0)}e.document&&(this.index=i.requestsCount++,i.requests[this.index]=this)},i.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},i.prototype.onData=function(t){this.emit("data",t),this.onSuccess()},i.prototype.onError=function(t){this.emit("error",t),this.cleanup(!0)},i.prototype.cleanup=function(t){if("undefined"!=typeof this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=r:this.xhr.onreadystatechange=r,t)try{this.xhr.abort()}catch(n){}e.document&&delete i.requests[this.index],this.xhr=null}},i.prototype.onLoad=function(){var t;try{var e;try{e=this.xhr.getResponseHeader("Content-Type")}catch(n){}t="application/octet-stream"===e?this.xhr.response||this.xhr.responseText:this.xhr.responseText}catch(n){this.onError(n)}null!=t&&this.onData(t)},i.prototype.hasXDR=function(){return"undefined"!=typeof e.XDomainRequest&&!this.xs&&this.enablesXDR},i.prototype.abort=function(){this.cleanup()},i.requestsCount=0,i.requests={},e.document&&(e.attachEvent?e.attachEvent("onunload",s):e.addEventListener&&e.addEventListener("beforeunload",s,!1))}).call(e,function(){return this}())},function(t,e,n){function r(t){var e=t&&t.forceBase64;p&&!e||(this.supportsBinary=!1),o.call(this,t)}var o=n(20),i=n(30),s=n(21),a=n(31),c=n(32),u=n(3)("engine.io-client:polling");t.exports=r;var p=function(){var t=n(16),e=new t({xdomain:!1});return null!=e.responseType}();a(r,o),r.prototype.name="polling",r.prototype.doOpen=function(){this.poll()},r.prototype.pause=function(t){function e(){u("paused"),n.readyState="paused",t()}var n=this;if(this.readyState="pausing",this.polling||!this.writable){var r=0;this.polling&&(u("we are currently polling - waiting to pause"),r++,this.once("pollComplete",function(){u("pre-pause polling complete"),--r||e()})),this.writable||(u("we are currently writing - waiting to pause"),r++,this.once("drain",function(){u("pre-pause writing complete"),--r||e()}))}else e()},r.prototype.poll=function(){u("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},r.prototype.onData=function(t){var e=this;u("polling got data %s",t);var n=function(t,n,r){return"opening"===e.readyState&&e.onOpen(),"close"===t.type?(e.onClose(),!1):void e.onPacket(t)};s.decodePayload(t,this.socket.binaryType,n),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():u('ignoring poll - transport state "%s"',this.readyState))},r.prototype.doClose=function(){function t(){u("writing close packet"),e.write([{type:"close"}])}var e=this;"open"===this.readyState?(u("transport open - closing"),t()):(u("transport not open - deferring close"),this.once("open",t))},r.prototype.write=function(t){var e=this;this.writable=!1;var n=function(){e.writable=!0,e.emit("drain")};s.encodePayload(t,this.supportsBinary,function(t){e.doWrite(t,n)})},r.prototype.uri=function(){var t=this.query||{},e=this.secure?"https":"http",n="";!1!==this.timestampRequests&&(t[this.timestampParam]=c()),this.supportsBinary||t.sid||(t.b64=1),t=i.encode(t),this.port&&("https"===e&&443!==Number(this.port)||"http"===e&&80!==Number(this.port))&&(n=":"+this.port),t.length&&(t="?"+t);var r=this.hostname.indexOf(":")!==-1;return e+"://"+(r?"["+this.hostname+"]":this.hostname)+n+this.path+t}},function(t,e,n){function r(t){this.path=t.path,this.hostname=t.hostname,this.port=t.port,this.secure=t.secure,this.query=t.query,this.timestampParam=t.timestampParam,this.timestampRequests=t.timestampRequests,this.readyState="",this.agent=t.agent||!1,this.socket=t.socket,this.enablesXDR=t.enablesXDR,this.pfx=t.pfx,this.key=t.key,this.passphrase=t.passphrase,this.cert=t.cert,this.ca=t.ca,this.ciphers=t.ciphers,this.rejectUnauthorized=t.rejectUnauthorized,this.forceNode=t.forceNode,this.extraHeaders=t.extraHeaders,this.localAddress=t.localAddress}var o=n(21),i=n(8);t.exports=r,i(r.prototype),r.prototype.onError=function(t,e){var n=new Error(t);return n.type="TransportError",n.description=e,this.emit("error",n),this},r.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},r.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},r.prototype.send=function(t){if("open"!==this.readyState)throw new Error("Transport not open");this.write(t)},r.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},r.prototype.onData=function(t){var e=o.decodePacket(t,this.socket.binaryType);this.onPacket(e)},r.prototype.onPacket=function(t){this.emit("packet",t)},r.prototype.onClose=function(){this.readyState="closed",this.emit("close")}},function(t,e,n){(function(t){function r(t,n){var r="b"+e.packets[t.type]+t.data.data;return n(r)}function o(t,n,r){if(!n)return e.encodeBase64Packet(t,r);var o=t.data,i=new Uint8Array(o),s=new Uint8Array(1+o.byteLength);s[0]=v[t.type];for(var a=0;a<i.length;a++)s[a+1]=i[a];return r(s.buffer)}function i(t,n,r){if(!n)return e.encodeBase64Packet(t,r);var o=new FileReader;return o.onload=function(){t.data=o.result,e.encodePacket(t,n,!0,r)},o.readAsArrayBuffer(t.data)}function s(t,n,r){if(!n)return e.encodeBase64Packet(t,r);if(g)return i(t,n,r);var o=new Uint8Array(1);o[0]=v[t.type];var s=new k([o.buffer,t.data]);return r(s)}function a(t){try{t=d.decode(t,{strict:!1})}catch(e){return!1}return t}function c(t,e,n){for(var r=new Array(t.length),o=l(t.length,n),i=function(t,n,o){e(n,function(e,n){r[t]=n,o(e,r)})},s=0;s<t.length;s++)i(s,t[s],o)}var u,p=n(22),h=n(23),f=n(24),l=n(25),d=n(26);t&&t.ArrayBuffer&&(u=n(28));var y="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),m="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),g=y||m;e.protocol=3;var v=e.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},b=p(v),w={type:"error",data:"parser error"},k=n(29);e.encodePacket=function(e,n,i,a){"function"==typeof n&&(a=n,n=!1),"function"==typeof i&&(a=i,i=null);var c=void 0===e.data?void 0:e.data.buffer||e.data;if(t.ArrayBuffer&&c instanceof ArrayBuffer)return o(e,n,a);if(k&&c instanceof t.Blob)return s(e,n,a);if(c&&c.base64)return r(e,a);var u=v[e.type];return void 0!==e.data&&(u+=i?d.encode(String(e.data),{strict:!1}):String(e.data)),a(""+u)},e.encodeBase64Packet=function(n,r){var o="b"+e.packets[n.type];if(k&&n.data instanceof t.Blob){var i=new FileReader;return i.onload=function(){var t=i.result.split(",")[1];r(o+t)},i.readAsDataURL(n.data)}var s;try{s=String.fromCharCode.apply(null,new Uint8Array(n.data))}catch(a){for(var c=new Uint8Array(n.data),u=new Array(c.length),p=0;p<c.length;p++)u[p]=c[p];s=String.fromCharCode.apply(null,u)}return o+=t.btoa(s),r(o)},e.decodePacket=function(t,n,r){if(void 0===t)return w;if("string"==typeof t){if("b"===t.charAt(0))return e.decodeBase64Packet(t.substr(1),n);if(r&&(t=a(t),t===!1))return w;var o=t.charAt(0);return Number(o)==o&&b[o]?t.length>1?{type:b[o],data:t.substring(1)}:{type:b[o]}:w}var i=new Uint8Array(t),o=i[0],s=f(t,1);return k&&"blob"===n&&(s=new k([s])),{type:b[o],data:s}},e.decodeBase64Packet=function(t,e){var n=b[t.charAt(0)];if(!u)return{type:n,data:{base64:!0,data:t.substr(1)}};var r=u.decode(t.substr(1));return"blob"===e&&k&&(r=new k([r])),{type:n,data:r}},e.encodePayload=function(t,n,r){function o(t){return t.length+":"+t}function i(t,r){e.encodePacket(t,!!s&&n,!1,function(t){r(null,o(t))})}"function"==typeof n&&(r=n,n=null);var s=h(t);return n&&s?k&&!g?e.encodePayloadAsBlob(t,r):e.encodePayloadAsArrayBuffer(t,r):t.length?void c(t,i,function(t,e){return r(e.join(""))}):r("0:")},e.decodePayload=function(t,n,r){if("string"!=typeof t)return e.decodePayloadAsBinary(t,n,r);"function"==typeof n&&(r=n,n=null);var o;if(""===t)return r(w,0,1);for(var i,s,a="",c=0,u=t.length;c<u;c++){var p=t.charAt(c);if(":"===p){if(""===a||a!=(i=Number(a)))return r(w,0,1);if(s=t.substr(c+1,i),a!=s.length)return r(w,0,1);if(s.length){if(o=e.decodePacket(s,n,!1),w.type===o.type&&w.data===o.data)return r(w,0,1);var h=r(o,c+i,u);if(!1===h)return}c+=i,a=""}else a+=p}return""!==a?r(w,0,1):void 0},e.encodePayloadAsArrayBuffer=function(t,n){function r(t,n){e.encodePacket(t,!0,!0,function(t){return n(null,t)})}return t.length?void c(t,r,function(t,e){var r=e.reduce(function(t,e){var n;return n="string"==typeof e?e.length:e.byteLength,t+n.toString().length+n+2},0),o=new Uint8Array(r),i=0;return e.forEach(function(t){var e="string"==typeof t,n=t;if(e){for(var r=new Uint8Array(t.length),s=0;s<t.length;s++)r[s]=t.charCodeAt(s);n=r.buffer}e?o[i++]=0:o[i++]=1;for(var a=n.byteLength.toString(),s=0;s<a.length;s++)o[i++]=parseInt(a[s]);o[i++]=255;for(var r=new Uint8Array(n),s=0;s<r.length;s++)o[i++]=r[s]}),n(o.buffer)}):n(new ArrayBuffer(0))},e.encodePayloadAsBlob=function(t,n){function r(t,n){e.encodePacket(t,!0,!0,function(t){var e=new Uint8Array(1);if(e[0]=1,"string"==typeof t){for(var r=new Uint8Array(t.length),o=0;o<t.length;o++)r[o]=t.charCodeAt(o);t=r.buffer,e[0]=0}for(var i=t instanceof ArrayBuffer?t.byteLength:t.size,s=i.toString(),a=new Uint8Array(s.length+1),o=0;o<s.length;o++)a[o]=parseInt(s[o]);if(a[s.length]=255,k){var c=new k([e.buffer,a.buffer,t]);n(null,c)}})}c(t,r,function(t,e){return n(new k(e))})},e.decodePayloadAsBinary=function(t,n,r){"function"==typeof n&&(r=n,n=null);for(var o=t,i=[];o.byteLength>0;){for(var s=new Uint8Array(o),a=0===s[0],c="",u=1;255!==s[u];u++){if(c.length>310)return r(w,0,1);c+=s[u]}o=f(o,2+c.length),c=parseInt(c);var p=f(o,0,c);if(a)try{p=String.fromCharCode.apply(null,new Uint8Array(p))}catch(h){var l=new Uint8Array(p);p="";for(var u=0;u<l.length;u++)p+=String.fromCharCode(l[u])}i.push(p),o=f(o,c)}var d=i.length;i.forEach(function(t,o){r(e.decodePacket(t,n,!0),o,d)})}}).call(e,function(){return this}())},function(t,e){t.exports=Object.keys||function(t){var e=[],n=Object.prototype.hasOwnProperty;for(var r in t)n.call(t,r)&&e.push(r);return e}},function(t,e,n){(function(e){function r(t){if(!t||"object"!=typeof t)return!1;if(o(t)){for(var n=0,i=t.length;n<i;n++)if(r(t[n]))return!0;return!1}if("function"==typeof e.Buffer&&e.Buffer.isBuffer&&e.Buffer.isBuffer(t)||"function"==typeof e.ArrayBuffer&&t instanceof ArrayBuffer||s&&t instanceof Blob||a&&t instanceof File)return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return r(t.toJSON(),!0);for(var c in t)if(Object.prototype.hasOwnProperty.call(t,c)&&r(t[c]))return!0;return!1}var o=n(10),i=Object.prototype.toString,s="function"==typeof e.Blob||"[object BlobConstructor]"===i.call(e.Blob),a="function"==typeof e.File||"[object FileConstructor]"===i.call(e.File);t.exports=r}).call(e,function(){return this}())},function(t,e){t.exports=function(t,e,n){var r=t.byteLength;if(e=e||0,n=n||r,t.slice)return t.slice(e,n);if(e<0&&(e+=r),n<0&&(n+=r),n>r&&(n=r),e>=r||e>=n||0===r)return new ArrayBuffer(0);for(var o=new Uint8Array(t),i=new Uint8Array(n-e),s=e,a=0;s<n;s++,a++)i[a]=o[s];return i.buffer}},function(t,e){function n(t,e,n){function o(t,r){if(o.count<=0)throw new Error("after called too many times");--o.count,t?(i=!0,e(t),e=n):0!==o.count||i||e(null,r)}var i=!1;return n=n||r,o.count=t,0===t?e():o}function r(){}t.exports=n},function(t,e,n){var r;(function(t,o){!function(i){function s(t){for(var e,n,r=[],o=0,i=t.length;o<i;)e=t.charCodeAt(o++),e>=55296&&e<=56319&&o<i?(n=t.charCodeAt(o++),56320==(64512&n)?r.push(((1023&e)<<10)+(1023&n)+65536):(r.push(e),o--)):r.push(e);return r}function a(t){for(var e,n=t.length,r=-1,o="";++r<n;)e=t[r],e>65535&&(e-=65536,o+=w(e>>>10&1023|55296),e=56320|1023&e),o+=w(e);return o}function c(t,e){if(t>=55296&&t<=57343){if(e)throw Error("Lone surrogate U+"+t.toString(16).toUpperCase()+" is not a scalar value");return!1}return!0}function u(t,e){return w(t>>e&63|128)}function p(t,e){if(0==(4294967168&t))return w(t);var n="";return 0==(4294965248&t)?n=w(t>>6&31|192):0==(4294901760&t)?(c(t,e)||(t=65533),n=w(t>>12&15|224),n+=u(t,6)):0==(4292870144&t)&&(n=w(t>>18&7|240),n+=u(t,12),n+=u(t,6)),n+=w(63&t|128)}function h(t,e){e=e||{};for(var n,r=!1!==e.strict,o=s(t),i=o.length,a=-1,c="";++a<i;)n=o[a],c+=p(n,r);return c}function f(){if(b>=v)throw Error("Invalid byte index");var t=255&g[b];if(b++,128==(192&t))return 63&t;throw Error("Invalid continuation byte")}function l(t){var e,n,r,o,i;if(b>v)throw Error("Invalid byte index");if(b==v)return!1;if(e=255&g[b],b++,0==(128&e))return e;if(192==(224&e)){if(n=f(),i=(31&e)<<6|n,i>=128)return i;throw Error("Invalid continuation byte")}if(224==(240&e)){if(n=f(),r=f(),i=(15&e)<<12|n<<6|r,i>=2048)return c(i,t)?i:65533;throw Error("Invalid continuation byte")}if(240==(248&e)&&(n=f(),r=f(),o=f(),i=(7&e)<<18|n<<12|r<<6|o,i>=65536&&i<=1114111))return i;throw Error("Invalid UTF-8 detected")}function d(t,e){e=e||{};var n=!1!==e.strict;g=s(t),v=g.length,b=0;for(var r,o=[];(r=l(n))!==!1;)o.push(r);return a(o)}var y="object"==typeof e&&e,m=("object"==typeof t&&t&&t.exports==y&&t,"object"==typeof o&&o);m.global!==m&&m.window!==m||(i=m);var g,v,b,w=String.fromCharCode,k={version:"2.1.2",encode:h,decode:d};r=function(){return k}.call(e,n,e,t),!(void 0!==r&&(t.exports=r))}(this)}).call(e,n(27)(t),function(){return this}())},function(t,e){t.exports=function(t){return t.webpackPolyfill||(t.deprecate=function(){},t.paths=[],t.children=[],t.webpackPolyfill=1),t}},function(t,e){!function(){"use strict";for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=new Uint8Array(256),r=0;r<t.length;r++)n[t.charCodeAt(r)]=r;e.encode=function(e){var n,r=new Uint8Array(e),o=r.length,i="";for(n=0;n<o;n+=3)i+=t[r[n]>>2],i+=t[(3&r[n])<<4|r[n+1]>>4],i+=t[(15&r[n+1])<<2|r[n+2]>>6],i+=t[63&r[n+2]];return o%3===2?i=i.substring(0,i.length-1)+"=":o%3===1&&(i=i.substring(0,i.length-2)+"=="),i},e.decode=function(t){var e,r,o,i,s,a=.75*t.length,c=t.length,u=0;"="===t[t.length-1]&&(a--,"="===t[t.length-2]&&a--);var p=new ArrayBuffer(a),h=new Uint8Array(p);for(e=0;e<c;e+=4)r=n[t.charCodeAt(e)],o=n[t.charCodeAt(e+1)],i=n[t.charCodeAt(e+2)],s=n[t.charCodeAt(e+3)],h[u++]=r<<2|o>>4,h[u++]=(15&o)<<4|i>>2,h[u++]=(3&i)<<6|63&s;return p}}()},function(t,e){(function(e){function n(t){for(var e=0;e<t.length;e++){var n=t[e];if(n.buffer instanceof ArrayBuffer){var r=n.buffer;if(n.byteLength!==r.byteLength){var o=new Uint8Array(n.byteLength);o.set(new Uint8Array(r,n.byteOffset,n.byteLength)),r=o.buffer}t[e]=r}}}function r(t,e){e=e||{};var r=new i;n(t);for(var o=0;o<t.length;o++)r.append(t[o]);return e.type?r.getBlob(e.type):r.getBlob()}function o(t,e){return n(t),new Blob(t,e||{})}var i=e.BlobBuilder||e.WebKitBlobBuilder||e.MSBlobBuilder||e.MozBlobBuilder,s=function(){try{var t=new Blob(["hi"]);return 2===t.size}catch(e){return!1}}(),a=s&&function(){try{var t=new Blob([new Uint8Array([1,2])]);return 2===t.size}catch(e){return!1}}(),c=i&&i.prototype.append&&i.prototype.getBlob;t.exports=function(){return s?a?e.Blob:o:c?r:void 0}()}).call(e,function(){return this}())},function(t,e){e.encode=function(t){var e="";for(var n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e},e.decode=function(t){for(var e={},n=t.split("&"),r=0,o=n.length;r<o;r++){var i=n[r].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}},function(t,e){t.exports=function(t,e){var n=function(){};n.prototype=e.prototype,t.prototype=new n,t.prototype.constructor=t}},function(t,e){"use strict";function n(t){var e="";do e=s[t%a]+e,t=Math.floor(t/a);while(t>0);return e}function r(t){var e=0;for(p=0;p<t.length;p++)e=e*a+c[t.charAt(p)];return e}function o(){var t=n(+new Date);return t!==i?(u=0,i=t):t+"."+n(u++)}for(var i,s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),a=64,c={},u=0,p=0;p<a;p++)c[s[p]]=p;o.encode=n,o.decode=r,t.exports=o},function(t,e,n){(function(e){function r(){}function o(t){i.call(this,t),this.query=this.query||{},a||(e.___eio||(e.___eio=[]),a=e.___eio),this.index=a.length;var n=this;a.push(function(t){n.onData(t)}),this.query.j=this.index,e.document&&e.addEventListener&&e.addEventListener("beforeunload",function(){n.script&&(n.script.onerror=r)},!1)}var i=n(19),s=n(31);t.exports=o;var a,c=/\n/g,u=/\\n/g;s(o,i),o.prototype.supportsBinary=!1,o.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),i.prototype.doClose.call(this)},o.prototype.doPoll=function(){var t=this,e=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),e.async=!0,e.src=this.uri(),e.onerror=function(e){t.onError("jsonp poll error",e)};var n=document.getElementsByTagName("script")[0];n?n.parentNode.insertBefore(e,n):(document.head||document.body).appendChild(e),this.script=e;var r="undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent);r&&setTimeout(function(){var t=document.createElement("iframe");document.body.appendChild(t),document.body.removeChild(t)},100)},o.prototype.doWrite=function(t,e){function n(){r(),e()}function r(){if(o.iframe)try{o.form.removeChild(o.iframe)}catch(t){o.onError("jsonp polling iframe removal error",t)}try{var e='<iframe src="javascript:0" name="'+o.iframeId+'">';i=document.createElement(e)}catch(t){i=document.createElement("iframe"),i.name=o.iframeId,i.src="javascript:0"}i.id=o.iframeId,o.form.appendChild(i),o.iframe=i}var o=this;if(!this.form){var i,s=document.createElement("form"),a=document.createElement("textarea"),p=this.iframeId="eio_iframe_"+this.index;s.className="socketio",s.style.position="absolute",s.style.top="-1000px",s.style.left="-1000px",s.target=p,s.method="POST",s.setAttribute("accept-charset","utf-8"),a.name="d",s.appendChild(a),document.body.appendChild(s),this.form=s,this.area=a}this.form.action=this.uri(),r(),t=t.replace(u,"\\\n"),this.area.value=t.replace(c,"\\n");try{this.form.submit()}catch(h){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===o.iframe.readyState&&n()}:this.iframe.onload=n}}).call(e,function(){return this}())},function(t,e,n){(function(e){function r(t){var e=t&&t.forceBase64;e&&(this.supportsBinary=!1),this.perMessageDeflate=t.perMessageDeflate,this.usingBrowserWebSocket=h&&!t.forceNode,this.protocols=t.protocols,this.usingBrowserWebSocket||(l=o),i.call(this,t)}var o,i=n(20),s=n(21),a=n(30),c=n(31),u=n(32),p=n(3)("engine.io-client:websocket"),h=e.WebSocket||e.MozWebSocket;if("undefined"==typeof window)try{o=n(35)}catch(f){}var l=h;l||"undefined"!=typeof window||(l=o),t.exports=r,c(r,i),r.prototype.name="websocket",r.prototype.supportsBinary=!0,r.prototype.doOpen=function(){if(this.check()){var t=this.uri(),e=this.protocols,n={agent:this.agent,perMessageDeflate:this.perMessageDeflate};n.pfx=this.pfx,n.key=this.key,n.passphrase=this.passphrase,n.cert=this.cert,n.ca=this.ca,n.ciphers=this.ciphers,n.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(n.headers=this.extraHeaders),this.localAddress&&(n.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket?e?new l(t,e):new l(t):new l(t,e,n)}catch(r){return this.emit("error",r)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},r.prototype.addEventListeners=function(){var t=this;this.ws.onopen=function(){t.onOpen()},this.ws.onclose=function(){t.onClose()},this.ws.onmessage=function(e){t.onData(e.data)},this.ws.onerror=function(e){t.onError("websocket error",e)}},r.prototype.write=function(t){function n(){r.emit("flush"),setTimeout(function(){r.writable=!0,r.emit("drain")},0)}var r=this;this.writable=!1;for(var o=t.length,i=0,a=o;i<a;i++)!function(t){s.encodePacket(t,r.supportsBinary,function(i){if(!r.usingBrowserWebSocket){var s={};if(t.options&&(s.compress=t.options.compress),r.perMessageDeflate){var a="string"==typeof i?e.Buffer.byteLength(i):i.length;a<r.perMessageDeflate.threshold&&(s.compress=!1)}}try{r.usingBrowserWebSocket?r.ws.send(i):r.ws.send(i,s)}catch(c){p("websocket closed before onclose event")}--o||n()})}(t[i])},r.prototype.onClose=function(){i.prototype.onClose.call(this)},r.prototype.doClose=function(){"undefined"!=typeof this.ws&&this.ws.close()},r.prototype.uri=function(){var t=this.query||{},e=this.secure?"wss":"ws",n="";this.port&&("wss"===e&&443!==Number(this.port)||"ws"===e&&80!==Number(this.port))&&(n=":"+this.port),this.timestampRequests&&(t[this.timestampParam]=u()),this.supportsBinary||(t.b64=1),t=a.encode(t),t.length&&(t="?"+t);var r=this.hostname.indexOf(":")!==-1;return e+"://"+(r?"["+this.hostname+"]":this.hostname)+n+this.path+t},r.prototype.check=function(){return!(!l||"__initialize"in l&&this.name===r.prototype.name)}}).call(e,function(){return this}())},function(t,e){},function(t,e){var n=[].indexOf;t.exports=function(t,e){if(n)return t.indexOf(e);for(var r=0;r<t.length;++r)if(t[r]===e)return r;return-1}},function(t,e,n){"use strict";function r(t,e,n){this.io=t,this.nsp=e,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},n&&n.query&&(this.query=n.query),this.io.autoConnect&&this.open()}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=n(7),s=n(8),a=n(38),c=n(39),u=n(40),p=n(3)("socket.io-client:socket"),h=n(30),f=n(23);t.exports=e=r;var l={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},d=s.prototype.emit;s(r.prototype),r.prototype.subEvents=function(){if(!this.subs){var t=this.io;this.subs=[c(t,"open",u(this,"onopen")),c(t,"packet",u(this,"onpacket")),c(t,"close",u(this,"onclose"))]}},r.prototype.open=r.prototype.connect=function(){return this.connected?this:(this.subEvents(),this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting"),this)},r.prototype.send=function(){var t=a(arguments);return t.unshift("message"),this.emit.apply(this,t),this},r.prototype.emit=function(t){if(l.hasOwnProperty(t))return d.apply(this,arguments),this;var e=a(arguments),n={type:(void 0!==this.flags.binary?this.flags.binary:f(e))?i.BINARY_EVENT:i.EVENT,data:e};return n.options={},n.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof e[e.length-1]&&(p("emitting packet with ack id %d",this.ids),this.acks[this.ids]=e.pop(),n.id=this.ids++),this.connected?this.packet(n):this.sendBuffer.push(n),this.flags={},this},r.prototype.packet=function(t){t.nsp=this.nsp,this.io.packet(t)},r.prototype.onopen=function(){if(p("transport is open - connecting"),"/"!==this.nsp)if(this.query){var t="object"===o(this.query)?h.encode(this.query):this.query;p("sending connect packet with query %s",t),this.packet({type:i.CONNECT,query:t})}else this.packet({type:i.CONNECT})},r.prototype.onclose=function(t){p("close (%s)",t),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",t)},r.prototype.onpacket=function(t){var e=t.nsp===this.nsp,n=t.type===i.ERROR&&"/"===t.nsp;if(e||n)switch(t.type){case i.CONNECT:this.onconnect();break;case i.EVENT:this.onevent(t);break;case i.BINARY_EVENT:this.onevent(t);break;case i.ACK:this.onack(t);break;case i.BINARY_ACK:this.onack(t);break;case i.DISCONNECT:this.ondisconnect();break;case i.ERROR:this.emit("error",t.data)}},r.prototype.onevent=function(t){var e=t.data||[];p("emitting event %j",e),null!=t.id&&(p("attaching ack callback to event"),e.push(this.ack(t.id))),this.connected?d.apply(this,e):this.receiveBuffer.push(e)},r.prototype.ack=function(t){var e=this,n=!1;return function(){if(!n){n=!0;var r=a(arguments);p("sending ack %j",r),e.packet({type:f(r)?i.BINARY_ACK:i.ACK,id:t,data:r})}}},r.prototype.onack=function(t){var e=this.acks[t.id];"function"==typeof e?(p("calling ack %s with %j",t.id,t.data),e.apply(this,t.data),delete this.acks[t.id]):p("bad ack %s",t.id)},r.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},r.prototype.emitBuffered=function(){var t;for(t=0;t<this.receiveBuffer.length;t++)d.apply(this,this.receiveBuffer[t]);for(this.receiveBuffer=[],t=0;t<this.sendBuffer.length;t++)this.packet(this.sendBuffer[t]);this.sendBuffer=[]},r.prototype.ondisconnect=function(){p("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},r.prototype.destroy=function(){if(this.subs){for(var t=0;t<this.subs.length;t++)this.subs[t].destroy();this.subs=null}this.io.destroy(this)},r.prototype.close=r.prototype.disconnect=function(){return this.connected&&(p("performing disconnect (%s)",this.nsp),this.packet({type:i.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},r.prototype.compress=function(t){return this.flags.compress=t,this},r.prototype.binary=function(t){return this.flags.binary=t,this}},function(t,e){function n(t,e){var n=[];e=e||0;for(var r=e||0;r<t.length;r++)n[r-e]=t[r];return n}t.exports=n},function(t,e){"use strict";function n(t,e,n){return t.on(e,n),{destroy:function(){t.removeListener(e,n)}}}t.exports=n},function(t,e){var n=[].slice;t.exports=function(t,e){if("string"==typeof e&&(e=t[e]),"function"!=typeof e)throw new Error("bind() requires a function");var r=n.call(arguments,2);return function(){return e.apply(t,r.concat(n.call(arguments)))}}},function(t,e){function n(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}t.exports=n,n.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=0==(1&Math.floor(10*e))?t-n:t+n}return 0|Math.min(t,this.max)},n.prototype.reset=function(){this.attempts=0},n.prototype.setMin=function(t){this.ms=t},n.prototype.setMax=function(t){this.max=t},n.prototype.setJitter=function(t){this.jitter=t}}])});var Live=new function __Live(){
	this.__enabled=1;
	this.__authenticated=0;
	this.__bind={};

	this.mode="socket"; // {rest, socket}
	
	this.online=[];
	
	this.off=function(){
		this.__enabled=0;
		if (this.me){
			this.me.io.autoConnect=false;
			this.me.io._reconnection=false;
			// this.me.reconnect=false;
			// this.me.reconnect(false);
			this.me.disconnect();
		}
	};
	
	var error_count=0;
	this.onConnectionError=function(){
		if (this.__enabled==0){
			return;
		}
		
		if (mobile()){
			return;
		}
		
		if (Client.base && Client.base.app=="message"){
			var html="<div id='socket-disconnected'> <div class='txt'>Real-time connection to server is interrupted due to unstable internet connection. Messages and notifications may not be real-time. Please refresh to continue.</div> <div class='cta url' data-url=':refresh'>Refresh</div> </div>";
			
			if ($("#socket-disconnected").length){
				// $("#socket-disconnected").remove();
				return;
			}else{
				error_count++;
				if (error_count>=2){
					$(document.body).append(html);
					$("#document").css("top", 50);
				}
			}
		}else{
			var $title=$("#msg-panel .title");
			if ($title.length){
				$title.prepend("<span class='inline' title='Real-time connection is interrupted'><span class='-ap icon-info'></span></span>");
			}
		}
	};
	
	
	/**
	 * @desc Create a live connection and try to authenticated
	 */
	this.join=function(url){
		if (!Client.viewer || !Client.system || N.__off || !this.__enabled){
			return;
		}
		
		var query="ns="+Client.system.id+"&nstoken="+Client.system.token+"&id="+Client.viewer.id+"&username="+Client.viewer.username+
		"&token="+Client.secureData.token+"&session="+Client.secureData.session+"&type=session&fake="+"justatest";
		
		if (Client.base && Client.base.secureData){
			query="ns="+Client.system.id+"&nstoken="+Client.system.token+"&id="+Client.viewer.id+"&username="+Client.viewer.username+
			"&token="+Client.base.secureData.token+"&session="+Client.base.secureData.session+"&type=session&fake="+"justatest";	
		}
		
		var allow_reconnect=true;
		if (!this.__enabled){
			allow_reconnect=false;
		}
		
		var socket = io.connect(url, 
			{
				query:query, 
				reconnect: true, 
				reconnection: true,
				reconnectionAttempts: 200,
				reconnectionDelay: 5000,
				transports: ['websocket', 'flashsocket', 'htmlfile', 'xhr-polling', 'jsonp-polling', 'polling']
			}
		);
		 
		socket.data={};
		socket.data.url=url;
		socket.data.authenticated=false;
		
		authenticate(socket);
		
		socket.on('authenticated', function(data){
			console.log("Socket authenticated ...");
			socket.data.authenticated=true;
			
			if (!Live.__authenticated){
				Live.__authenticated=1;
				AP.sys.fire("socket.ready");
			}else{
				AP.sys.fire("socket.reconnection.ready");
			}
			
			N.ui.trigger(data);
			
		});	
		
		socket.on("authentication.error", function(msg){
			console.log("authentication.error");
			$.log(msg);
		});
		
		socket.on('connect_error', function(){
			console.log('connection_error');
			Live.onConnectionError();
		});
		
		socket.on('error', function(){
			console.log('connection_error');
			Live.onConnectionError();
		});
		
		socket.on("disconnect", function(){
			if (Live.__enabled || N.__off){
				return;
			}
			 
			$.log("Socket disconnected ...");
			 // reconnect(socket); 
		});
		 
		 
		socket.on("clog", function(message){
		});
		 
		socket.on("__log__", function(data){
			$.log(data);
		});		 
		
		return socket;
	};
	
	
	this.post=function(event, data, callback, once){
		if (this.auth()){
			this.emit(event, data);
			if (once){
				if (this.__bind[event]){
					// return;
				}
				
				this.me.off(event);
				
				this.__bind[event]=data;
				this.me.once(event, callback);
			}else{
				this.me.on(event, callback);
			}
		}
	};
	
	this.send=function(event, data, callback, once){
		return this.post(event, data, callback, once);
	};
	
	
	
	this.on=function(event, callback){
		if (!this.me){
			return;
		}
		this.me.on(event, callback);
	};
	
	
	this.auth=function(){ 
		return this.me && this.me.data.authenticated;
	};
	
	
	this.update=function(data){
		if (!data){
			data={};
		}
		if (Live.auth()){
			Live.emit("update",data);
		}
	};
	
	
	this.broadcast=function(users, data){
		if (Live.auth()){
			Live.emit("p2p",{
				 "users": users,
				 "data": data
			});
		}
	};
	
	
	this.emit=function(event, data){
		if (!Live.me){
			$.log("Unauthenticated socket");
			return;
		}
		
		$$(function(){
			$.log("socket-event ["+event+"], with data:");
			$.log(data);
		});
		
		Live.me.emit(event, data);
	};
	
	
	this.ready=function(cb){
		if (Live.__authenticated){
			cb();
		}else{
			AP.sys.on("socket.ready", cb);	
		}
	};
	
	
	
	function authenticate(socket){
		var networks=[];
		if (!Client.networks){
			return;
		}
		
		for (var i=0; i<Client.networks.length; i++){
			 var n=Client.networks[i];
			 var is_root=0;
			 if (parseInt(n.type)==13){
				 is_root=1;
			 }
			 networks.push({"id": n.id, "token": n.token, "path": n.path, "name": n.name, "root": is_root});
		}
	};
	
	
	function reconnect(socket){
		$.log("Reconnecting ...");
	};
};



Live.response=new function __LiveResponse(){
	this.comment=function(comment){
		var $box=$("#auto-comments-"+comment.origin_hid);
		if (!comment.origin_hid || !$box.length){
			return;
		}
		
		var $canvas=$box.closest(".__comment_canvas");
		if (!$canvas.length){
			return;
		}
		
		var obj=$canvas.data("object");
		var opts=$canvas.data("options");
		
		if (!obj){
			return;
		}
		
		
		obj.stats.comments=parseInt(obj.stats.comments)+1;
		Comment.ui.insert($canvas, obj, comment);
		
		$("#comment-"+comment.id).addClass("animated");
		setTimeout(function(){
			$("#comment-"+comment.id).removeClass("animated");
		},3000);
		
		$(opts.counter).html(obj.stats.comments);
		$(".comment-counter-"+obj.id).html(obj.stats.comments);
		$(".comment-counter-"+obj.gid).html(obj.stats.comments);
	};
};





var RTS = new function __RTS(){
	this.events={};
	this.pool={};
	
	
	this.init=function(ns, room){
		this.pool[ns] = room;
		
		Live.me.emit("base_rts", {rts: "init", ns: ns, room: room});
		Live.me.off(ns+"_rts").on(ns+"_rts", function(data){
			if (!data.event || !data.ns){
				return;
			}
			
			var fn=RTS.events[data.ns+"-"+data.event];
			fn(data.data);
		});
		
	};
	
	this.push=function(ns, event, data){
		if (!this.pool[ns]){
			return;
		}
		
		Live.me.emit("base_rts", {rts:"push", ns: ns, event: event, data: data});
	};
	
	this.on=function(ns, event, cb){
		this.events[ns+"-"+event]=cb;
	};
	
	
	this.leave=function(ns){
		if (this.pool[ns]){
			if (Live.me){
				Live.me.emit("base_rts", {rts: "leave", ns: ns, room: this.pool[ns]});	
			}
		}
		
		delete this.pool[ns];
	};
	
};
$(document).ready(function(){
	if (self != top){
		return;
	}
	
	if (Client.https) {
	    Live.me = Live.join(Client.socket_url);
	} else {
	    Live.me = Live.join(Client.socket_url);
	}

	Live.on("notification", function(data){
		var notis={title: data.title, body: data.body, icon: data.image, url:data.link, id: data.id, __state: data.__state};
		
		DN.show(notis);
		DN.bip(3, data.id);
		
		if (data.user && parseInt(data.user.num_notis)){
			Base.title.notis(data.user.num_notis);
			N.ui.update(data.user);
		}
		
		if (data.data){
			AP.sys.fire(data.type, [data.data, data]);
			AP.sys.fire(data.type+":"+data.action, [data.extra]);
			
			if (data.action=="comment" && data.extra && data.extra.type=="comment"){
				Live.response.comment(data.extra);
			}
		}
		
		if (data.extra && data.extra.event){
			var fn = N.events.get(data.extra.event);
			if (fn){
				fn(data.extra.data);
			}
		}
		
	});
	
	
	Live.on("counter", function(data){
		Base.title.notis(data.num_notis);
		N.ui.update(data);
	});

	
	Live.on("p2p", function(data){
		if (data.action){
			if (data.action=='chat.focus' || data.action=='chat.unfocus'){
				Chat.live.handleAction(data.action, data);
			}
		}
	});

	
	/**
	 * @desc Trigger i'm busy flag
	 */
	Live.on("imbusy", function(data){
		Client.busy = parseInt(data.status);
	});
	
	Live.on("nobox", function(data){
		if (Client.base && Client.base.app == "message"){
			return;
		}

		
		if (data.status && parseInt(data.status)){
			$("#msg-root").hide();
		}
		
		AP.confirm("You have just changed preference for message boxes - Please refresh the page to continue", function(){
			AP.refresh();
		});
	});

	AP.sys.on("socket.ready", function(){
		Live.send("system.getonline", {}, function(data){
			Online.setPeople(data);
			AP.fire("ONLINE.LOADED");
		});
		
		Live.on("user.online",function(data){
			Online.add(data.username);
		});
		
		Live.on("user.offline",function(data){
			Online.remove(data.username);
		});
		
		N.live.init();
		Reminder.init();
	});


});var Online=new function __Online(){
	this.people=[];
	this.__online={};
	this.__loaded=false;
	
	this.setPeople=function(people){
		this.people=filter(people);
		for (var i=0; i<this.people.length; i++){
			this.__online[this.people[i].username]=this.people[i];
		}
		
		this.__loaded=true;
		
		setTimeout(function(){
			Online.__loaded=true; 
		},30000);
	};
	
	this.add=function(username){
		if (this.online(username)){
			return;
		}
		
		this.people.push({'username': username, atime: AP.time.now()});
		
	};
	
	
	this.remove=function(username){
		var r=[];
		for (var i=0; i<this.people.length; i++){
			if (this.people[i].username==username){
				
			}else{
				r.push(this.people[i]);
			}
		}
		
		this.people=r;
	};
	
	
	
	this.online=function(username){
		if (!username || !username.length){
			return null;
		}
		
		for (var i=0; i<this.people.length; i++){
			if (this.people[i].username==username){
				return this.people[i];
			}
		}
		
		return null;
	};
	
	
	this.isOnline=function(username){
		var u=username;
		if (AP.data.isObject(username) && username.username){
			u=username.username;
		}
		
		if (this.__online[username]){
			return true;
		}
		
		return false;
	};
	
	
	
	this.loaded=function(callback){
		if (this.__loaded){
			callback();
		}
		
		AP.on("ONLINE.LOADED", function(){
			callback();
		});
	};
	
	
	this.updateStatus=function(selector){
		AP.on("ONLINE.LOADED", function(){
			$(selector).each(function(){
				var $this=$(this);
				var username=$this.data("username");
				
				if (!username){
					return;
				}
				if (username.charAt(0)=="@"){
					username=username.substr(1);
				}
				var $target=$this;
				if ($this.hasClass("avatar")){
				}else{
					$target=$this.find(".avatar");
				}
				
				if (Online.online(username)){
					$target.addClass("-online");
				}else{
					$target.removeClass("-online");
				}
			});
		});
	};
	
	
	
	this.reorder=function(users){
		if (!users || !users.length){
			return users;
		}
		
		for (var i=0; i<users.length; i++){
			var obj=this.online(users[i].username);
			
			if (obj){
				users[i].online=1;
				users[i].atime=obj.atime;
			}else{
				users[i].online=0;
				users[i].atime=0;
			}
		}
		
		users.sort(function(e1, e2){
			if (e2.online==1 && e1.online==1){
				return e2.atime-e1.atime;
			}
			return e2.online-e1.online;
		});
	};
	
	
	
	function filter(people){
		var r=[];
		for (var i=0; i<people.length; i++){
			var found=false;
			var person=people[i];
			for (var j=0; j<r.length; j++){
				if (r[j].username==person.username){
					found=true;
					
					if (parseInt(r[j].atime < parseInt(person.atime))){
						r[j].atime=person.atime;
					}
				}
			}
			
			if (!found){
				r.push(person);
			}
			
		}
		return r;
	};
	
};